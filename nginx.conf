# ============================================================================
# ZJump 堡垒机 Nginx 配置
# ============================================================================
# 功能：
# 1. HTTP/API 负载均衡
# 2. WebSocket 终端代理（支持会话保持）
# 3. SSH TCP 代理（四层负载均衡）
# 4. 静态文件服务
# ============================================================================

# ============================================================================
# 后端服务器组定义
# ============================================================================

# API Server - 主服务（HTTP API + WebSocket）
# 集成架构：前后端在同一容器内，使用 localhost 连接
upstream api_server {
    # 单实例配置（同一容器内，使用 localhost）
    server 127.0.0.1:8080 max_fails=3 fail_timeout=30s;
    
    # 保持连接池
    keepalive 64;
}

# ============================================================================
# HTTP Server - 七层代理
# ============================================================================

server {
    listen 80;
    server_name 0.0.0.0;
    
    # 生产环境推荐强制 HTTPS
    # return 301 https://$server_name$request_uri;
    
    # 客户端请求体大小限制（文件上传）
    client_max_body_size 1G;
    
    # 客户端超时设置
    client_body_timeout 60s;
    client_header_timeout 60s;

    # ===================================
    # API 服务路由（所有 /api/* 请求）
    # ===================================
    
    location /api/ {
        proxy_pass http://api_server;
        
        # HTTP 版本
        proxy_http_version 1.1;
        
        # 必需的 Header
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 保持连接（配合 upstream keepalive）
        proxy_set_header Connection "";
        
        # 超时设置（支持大SQL查询）
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;    # 5分钟（支持大SQL传输）
        proxy_read_timeout 300s;    # 5分钟（支持大SQL执行和结果返回）
        
        # 缓冲设置（优化性能）
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # ===================================
    # WebSocket 终端连接路由
    # ===================================
    # 注意：WebSocket 需要 ip_hash 会话保持！
    
    location /ws/ {
        proxy_pass http://api_server;
        
        # WebSocket 必需配置
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 基本 Header
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 长超时（保持终端连接）
        proxy_connect_timeout 10s;
        proxy_send_timeout 7d;      # 7天超时（终端可能长时间空闲）
        proxy_read_timeout 7d;
        
        # 禁用缓冲（实时传输）
        proxy_buffering off;
    }

    # ===================================
    # 健康检查端点
    # ===================================
    
    location /api/health {
        proxy_pass http://api_server;
        proxy_set_header Host $host;
        access_log off;  # 不记录健康检查日志
    }
    
    location /health {
        proxy_pass http://api_server;
        access_log off;
    }

    # ===================================
    # 前端静态文件
    # ===================================
    
    # 静态资源文件（优先匹配，避免被 React Router 处理）
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /usr/share/nginx/html;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # React Router 支持（单页应用）
    # 所有其他请求都回退到 index.html，让 React Router 处理路由
    location / {
        root /usr/share/nginx/html;
        index index.html;
        
        # 禁用目录列表
        autoindex off;
        
        try_files $uri $uri/index.html /index.html;
    }

    # 日志配置
    access_log /app/logs/zjump_access.log combined;
    error_log /app/logs/zjump_error.log warn;
}