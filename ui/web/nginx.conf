# ============================================================================
# KeyOps 前端 Nginx 配置
# ============================================================================
# 功能：
# 1. 提供前端静态文件服务
# 2. 代理 API 请求到后端服务
# 3. 代理 WebSocket 请求到后端服务
# ============================================================================

# ============================================================================
# 后端服务器组定义
# ============================================================================

# API Server - 后端服务（通过 Docker 网络连接）
upstream api_server {
    # 使用 Docker Compose 服务名连接
    server keyops-backend:8080 max_fails=3 fail_timeout=30s;
    
    # 保持连接池
    keepalive 64;
}

# ============================================================================
# HTTP Server - 七层代理
# ============================================================================

server {
    listen 80;
    server_name 0.0.0.0;
    
    # 客户端请求体大小限制（文件上传）
    client_max_body_size 1G;
    
    # 客户端超时设置
    client_body_timeout 60s;
    client_header_timeout 60s;

    # ===================================
    # API 服务路由（所有 /api/* 请求）
    # ===================================
    
    location /api/ {
        proxy_pass http://api_server;
        
        # HTTP 版本
        proxy_http_version 1.1;
        
        # 必需的 Header
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 保持连接（配合 upstream keepalive）
        proxy_set_header Connection "";
        
        # 超时设置（支持大SQL查询）
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;    # 5分钟（支持大SQL传输）
        proxy_read_timeout 300s;    # 5分钟（支持大SQL执行和结果返回）
        
        # 缓冲设置（优化性能）
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;
    }

    # ===================================
    # WebSocket 终端连接路由
    # ===================================
    
    location /ws/ {
        proxy_pass http://api_server;
        
        # WebSocket 必需配置
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 基本 Header
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 长超时（保持终端连接）
        proxy_connect_timeout 10s;
        proxy_send_timeout 7d;      # 7天超时（终端可能长时间空闲）
        proxy_read_timeout 7d;
        
        # 禁用缓冲（实时传输）
        proxy_buffering off;
    }

    # ===================================
    # 健康检查端点
    # ===================================
    
    location /api/health {
        proxy_pass http://api_server;
        proxy_set_header Host $host;
        access_log off;  # 不记录健康检查日志
    }
    
    location /health {
        proxy_pass http://api_server;
        access_log off;
    }

    # ===================================
    # 前端静态文件
    # ===================================
    
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
        root /usr/share/nginx/html;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
        # 如果文件不存在，返回 404（不交给 React Router 处理）
        try_files $uri =404;
    }
    
    # React Router 支持（单页应用）
    # 所有其他请求都回退到 index.html，让 React Router 处理路由
    # 注意：此 location 块必须放在最后，作为所有未匹配请求的 fallback
    location / {
        root /usr/share/nginx/html;
        index index.html;
        
        # 禁用目录列表
        autoindex off;
        
        # SPA 路由回退：先尝试请求的文件，如果不存在则直接回退到根目录的 index.html
        # 注意：不尝试 $uri/，避免访问目录路径（如 /assets/）时出现问题
        # 这确保了所有前端路由（如 /assets、/assets/、/dashboard 等）都能正确加载
        try_files $uri /index.html;
    }

    # 日志配置
    access_log /app/logs/zjump_access.log combined;
    error_log /app/logs/zjump_error.log warn;
}

# ============================================================================
# HTTPS Server - 启用 HTTPS 支持（可选）
# ============================================================================
# 如需启用 HTTPS，请取消下面的注释并配置 SSL 证书
# 同时需要在 docker-compose.yml 中：
# 1. 取消注释 SSL 证书目录挂载：- ./ssl:/etc/nginx/ssl:ro
# 2. 确保 HTTPS_PORT 端口已映射（默认 443）
# ============================================================================
#
# server {
#     listen 443 ssl http2;
#     server_name your-domain.com;
#     
#     # SSL 证书配置
#     ssl_certificate /etc/nginx/ssl/cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/key.pem;
#     
#     # SSL 安全配置
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#     ssl_session_cache shared:SSL:10m;
#     ssl_session_timeout 10m;
#     
#     # 客户端请求体大小限制（文件上传）
#     client_max_body_size 1G;
#     
#     # 客户端超时设置
#     client_body_timeout 60s;
#     client_header_timeout 60s;
#     
#     # API 服务路由（所有 /api/* 请求）
#     location /api/ {
#         proxy_pass http://api_server;
#         proxy_http_version 1.1;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_set_header Connection "";
#         proxy_connect_timeout 60s;
#         proxy_send_timeout 300s;
#         proxy_read_timeout 300s;
#         proxy_buffering on;
#         proxy_buffer_size 4k;
#         proxy_buffers 8 4k;
#     }
#     
#     # WebSocket 终端连接路由
#     location /ws/ {
#         proxy_pass http://api_server;
#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#         proxy_connect_timeout 10s;
#         proxy_send_timeout 7d;
#         proxy_read_timeout 7d;
#         proxy_buffering off;
#     }
#     
#     # 健康检查端点
#     location /api/health {
#         proxy_pass http://api_server;
#         proxy_set_header Host $host;
#         access_log off;
#     }
#     
#     location /health {
#         proxy_pass http://api_server;
#         access_log off;
#     }
#     
#     # 前端静态文件
#     location /assets/ {
#         root /usr/share/nginx/html;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         access_log off;
#         try_files $uri =404;
#     }
#     
#     location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|map)$ {
#         root /usr/share/nginx/html;
#         expires 1y;
#         add_header Cache-Control "public, immutable";
#         access_log off;
#     }
#     
#     location / {
#         root /usr/share/nginx/html;
#         index index.html;
#         autoindex off;
#         try_files $uri $uri/index.html /index.html;
#     }
#     
#     # 日志配置
#     access_log /app/logs/zjump_access.log combined;
#     error_log /app/logs/zjump_error.log warn;
# }
# 
# # HTTP 重定向到 HTTPS（可选）
# server {
#     listen 80;
#     server_name your-domain.com;
#     return 301 https://$server_name$request_uri;
# }
