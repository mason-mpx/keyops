import{u as le,r as i,b4 as W,j as t,B as I,T as R,a as L,A as ie,F as x,n as f,o as y,M as l,P as de,I as G,g as oe,h as ce,i as ue,k as he,l as pe,m as D,C as me,p as xe}from"./index-OJNN34VQ.js";import{o as C}from"./oncallApi-B-ES08v0.js";import{T as fe,a as ye,b as je,c as F,d,e as ge}from"./TableRow-Dz3vPXNr.js";import{C as J}from"./Chip-pSvhxX1X.js";import{A as _e}from"./Autocomplete-cIcVOBXR.js";function Te(){const{t:s}=le(),[O,Q]=i.useState([]),[X,Z]=i.useState([]),[V,B]=i.useState(!1),[ee,m]=i.useState(!1),[j,M]=i.useState(null),[u,q]=i.useState(""),[r,c]=i.useState({schedule_id:0,user_id:"",start_time:"",end_time:"",shift_type:"manual",repeat_rule:"",status:"active"}),[b,h]=i.useState(""),[$,g]=i.useState([]),[w,T]=i.useState(!1),[k,_]=i.useState(null),[E,te]=i.useState(new Map),N=i.useCallback(async e=>{if(e.length===0)return;const a=new Map(E),n=e.filter(o=>!a.has(o));if(n.length!==0)try{((await W.getUsersWithPagination({page:1,pageSize:1e3})).users||[]).forEach(p=>{n.includes(p.id)&&a.set(p.id,p)}),te(a)}catch(o){console.error("Failed to load users:",o)}},[E]),H=i.useCallback(async()=>{try{const a=(await C.getSchedules({page:1,pageSize:1e3})).data;if(a.code===0||a.code===200){const n=a.data||[];Z(n),n.length>0&&!u&&q(n[0].id)}}catch(e){console.error("Failed to load schedules:",e)}},[u]),S=i.useCallback(async e=>{B(!0);try{const n=(await C.getShiftsBySchedule(e)).data;if(n.code===0||n.code===200){const o=n.data||[];console.log("Loaded shifts from API:",o),Q(o);const v=o.filter(p=>!p.username);if(v.length>0){const p=Array.from(new Set(v.map(z=>z.user_id).filter(Boolean)));await N(p)}}}catch(a){console.error("Failed to load shifts:",a)}finally{B(!1)}},[N]);i.useEffect(()=>{H()},[H]),i.useEffect(()=>{u&&S(u)},[u,S]);const P=i.useCallback(async()=>{T(!0);try{const a=(await W.getUsersWithPagination({page:1,pageSize:10})).users||[];g(a)}catch(e){console.error("加载用户列表失败:",e),g([])}finally{T(!1)}},[]),K=i.useCallback(async e=>{if(!e||e.trim().length===0){await P();return}T(!0);try{const n=(await W.getUsersWithPagination({page:1,pageSize:10,keyword:e.trim()})).users||[];g(n),n.length===1&&(_(n[0]),c(o=>({...o,user_id:n[0].id})))}catch(a){console.error("搜索用户失败:",a),g([])}finally{T(!1)}},[P]);i.useEffect(()=>{const e=setTimeout(()=>{K(b)},300);return()=>clearTimeout(e)},[b,K]);const U=e=>e?new Date(e).toISOString():"",Y=e=>{if(!e)return"";const a=new Date(e),n=a.getFullYear(),o=String(a.getMonth()+1).padStart(2,"0"),v=String(a.getDate()).padStart(2,"0"),p=String(a.getHours()).padStart(2,"0"),z=String(a.getMinutes()).padStart(2,"0");return`${n}-${o}-${v}T${p}:${z}`},se=async()=>{if(!r.start_time||!r.end_time){alert(s("Please fill in start time and end time")||"请填写开始时间和结束时间");return}try{await C.createShift({...r,schedule_id:u,start_time:U(r.start_time),end_time:U(r.end_time)}),m(!1),A(),S(u)}catch(e){console.error("Failed to create shift:",e)}},ae=async()=>{if(j){if(!r.start_time||!r.end_time){alert(s("Please fill in start time and end time")||"请填写开始时间和结束时间");return}try{const e={schedule_id:r.schedule_id,user_id:r.user_id,start_time:U(r.start_time),end_time:U(r.end_time),shift_type:r.shift_type,repeat_rule:r.repeat_rule,status:r.status};await C.updateShift(j.id,e),m(!1),M(null),A(),S(u)}catch(e){console.error("Failed to update shift:",e)}}},re=async e=>{if(window.confirm(s("Are you sure you want to delete this shift?")))try{await C.deleteShift(e),S(u)}catch(a){console.error("Failed to delete shift:",a)}},ne=async e=>{if(M(e),c({schedule_id:e.schedule_id,user_id:e.user_id,start_time:Y(e.start_time),end_time:Y(e.end_time),shift_type:e.shift_type,repeat_rule:e.repeat_rule,status:e.status}),e.user_id)try{const n=(await W.getUsersWithPagination({page:1,pageSize:1e3})).users?.find(o=>o.id===e.user_id);n?(_(n),h(n.username||n.id)):h(e.user_id)}catch(a){console.error("加载用户信息失败:",a),h(e.user_id)}m(!0)},A=()=>{c({schedule_id:u,user_id:"",start_time:"",end_time:"",shift_type:"manual",repeat_rule:"",status:"active"}),_(null),h(""),g([])};return t.jsxs(I,{sx:{p:3},children:[t.jsxs(I,{sx:{display:"flex",justifyContent:"space-between",mb:3},children:[t.jsx(R,{variant:"h5",component:"h1",children:s("menu.monitorOnCallShift")||"值班班次管理"}),t.jsx(L,{variant:"contained",startIcon:t.jsx(ie,{}),onClick:()=>{M(null),A(),m(!0)},disabled:!u,children:s("Create Shift")})]}),t.jsx(I,{sx:{mb:2},children:t.jsxs(x,{sx:{minWidth:300},children:[t.jsx(f,{children:s("Select Schedule")}),t.jsx(y,{value:u,label:s("Select Schedule"),onChange:e=>q(e.target.value),children:X.map(e=>t.jsx(l,{value:e.id,children:e.schedule_name},e.id))})]})}),t.jsx(fe,{component:de,children:t.jsxs(ye,{children:[t.jsx(je,{children:t.jsxs(F,{children:[t.jsx(d,{children:s("User")}),t.jsx(d,{children:s("Start Time")}),t.jsx(d,{children:s("End Time")}),t.jsx(d,{children:s("Shift Type")}),t.jsx(d,{children:s("Repeat Rule")}),t.jsx(d,{children:s("common.status")}),t.jsx(d,{children:s("common.actions")})]})}),t.jsx(ge,{children:V?t.jsx(F,{children:t.jsx(d,{colSpan:7,align:"center",children:s("common.loading")})}):O.length===0?t.jsx(F,{children:t.jsx(d,{colSpan:7,align:"center",children:s("common.noData")})}):O.map(e=>{const a=e.username||E.get(e.user_id)?.username||e.user_id;return t.jsxs(F,{children:[t.jsx(d,{children:a}),t.jsx(d,{children:new Date(e.start_time).toLocaleString()}),t.jsx(d,{children:new Date(e.end_time).toLocaleString()}),t.jsx(d,{children:t.jsx(J,{label:e.shift_type==="manual"?s("Manual"):e.shift_type==="daily"?s("Daily"):e.shift_type==="weekly"?s("Weekly"):e.shift_type==="monthly"?s("Monthly"):e.shift_type,size:"small"})}),t.jsx(d,{children:e.repeat_rule||"-"}),t.jsx(d,{children:t.jsx(J,{label:e.status==="active"?s("Active"):e.status==="cancelled"?s("Cancelled"):e.status,color:e.status==="active"?"success":"default",size:"small"})}),t.jsxs(d,{children:[t.jsx(G,{size:"small",onClick:()=>ne(e),children:t.jsx(oe,{})}),t.jsx(G,{size:"small",onClick:()=>re(e.id),children:t.jsx(ce,{})})]})]},e.id)})})]})}),t.jsxs(ue,{open:ee,onClose:()=>m(!1),maxWidth:"sm",fullWidth:!0,children:[t.jsx(he,{children:s(j?"Edit Shift":"Create Shift")}),t.jsx(pe,{children:t.jsxs(I,{sx:{display:"flex",flexDirection:"column",gap:2,mt:1},children:[t.jsx(_e,{fullWidth:!0,options:$,getOptionLabel:e=>e?e.username||e.id:"",isOptionEqualToValue:(e,a)=>!e||!a?!1:e.id===a.id,value:k,onChange:(e,a)=>{_(a),c({...r,user_id:a?.id||""}),h(a?a.username||a.id:"")},inputValue:b,onInputChange:(e,a,n)=>{n==="input"?h(a):n==="clear"?(h(""),_(null),c({...r,user_id:""})):n==="reset"&&k&&h(k.username||k.id)},onOpen:()=>{!w&&$.length===0&&P()},loading:w,noOptionsText:w?s("common.loading")||"加载中...":b?s("No users found")||"未找到用户":s("Enter username to search")||"输入用户名搜索",filterOptions:e=>e,renderInput:e=>t.jsx(D,{...e,label:s("User"),required:!0,placeholder:s("Enter username to search")||"输入用户名搜索",InputProps:{...e.InputProps,endAdornment:t.jsxs(t.Fragment,{children:[w?t.jsx(me,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}})}),t.jsx(D,{fullWidth:!0,label:s("Start Time"),type:"datetime-local",value:r.start_time,onChange:e=>c({...r,start_time:e.target.value}),InputLabelProps:{shrink:!0},required:!0}),t.jsx(D,{fullWidth:!0,label:s("End Time"),type:"datetime-local",value:r.end_time,onChange:e=>c({...r,end_time:e.target.value}),InputLabelProps:{shrink:!0},required:!0}),t.jsxs(x,{fullWidth:!0,children:[t.jsx(f,{children:s("Shift Type")}),t.jsxs(y,{value:r.shift_type,label:s("Shift Type"),onChange:e=>{const a=e.target.value;c({...r,shift_type:a,repeat_rule:""})},children:[t.jsx(l,{value:"manual",children:s("Manual")}),t.jsx(l,{value:"daily",children:s("Daily")}),t.jsx(l,{value:"weekly",children:s("Weekly")}),t.jsx(l,{value:"monthly",children:s("Monthly")})]})]}),r.shift_type==="manual"?t.jsx(D,{fullWidth:!0,label:s("Repeat Rule"),value:r.repeat_rule||"",onChange:e=>c({...r,repeat_rule:e.target.value}),placeholder:s("Optional description")||"可选描述",helperText:s("Repeat rule description for manual shift")||"手动班次的重复规则说明（可选）"}):r.shift_type==="daily"?t.jsxs(x,{fullWidth:!0,children:[t.jsx(f,{children:s("Repeat Rule")}),t.jsxs(y,{value:r.repeat_rule||"",label:s("Repeat Rule"),onChange:e=>c({...r,repeat_rule:e.target.value}),children:[t.jsx(l,{value:"",children:s("Every day")||"每天"}),t.jsx(l,{value:"weekdays",children:s("Weekdays (Mon-Fri)")||"工作日（周一至周五）"}),t.jsx(l,{value:"weekends",children:s("Weekends (Sat-Sun)")||"周末（周六至周日）"})]}),t.jsx(R,{variant:"caption",color:"text.secondary",sx:{mt:.5,ml:1.75},children:s("Repeat rule description for daily shift")||"每日班次的重复规则：选择班次每天重复的模式"})]}):r.shift_type==="weekly"?t.jsxs(x,{fullWidth:!0,children:[t.jsx(f,{children:s("Repeat Rule")}),t.jsxs(y,{value:r.repeat_rule||"",label:s("Repeat Rule"),onChange:e=>c({...r,repeat_rule:e.target.value}),children:[t.jsx(l,{value:"monday",children:s("Monday")||"周一"}),t.jsx(l,{value:"tuesday",children:s("Tuesday")||"周二"}),t.jsx(l,{value:"wednesday",children:s("Wednesday")||"周三"}),t.jsx(l,{value:"thursday",children:s("Thursday")||"周四"}),t.jsx(l,{value:"friday",children:s("Friday")||"周五"}),t.jsx(l,{value:"saturday",children:s("Saturday")||"周六"}),t.jsx(l,{value:"sunday",children:s("Sunday")||"周日"}),t.jsx(l,{value:"mon-fri",children:s("Mon-Fri")||"周一至周五"}),t.jsx(l,{value:"weekends",children:s("Weekends")||"周末（周六、周日）"})]}),t.jsx(R,{variant:"caption",color:"text.secondary",sx:{mt:.5,ml:1.75},children:s("Repeat rule description for weekly shift")||"每周班次的重复规则：选择班次每周重复的星期"})]}):r.shift_type==="monthly"?t.jsxs(x,{fullWidth:!0,children:[t.jsx(f,{children:s("Repeat Rule")}),t.jsxs(y,{value:r.repeat_rule||"",label:s("Repeat Rule"),onChange:e=>c({...r,repeat_rule:e.target.value}),children:[t.jsx(l,{value:"1st",children:s("1st of month")||"每月1号"}),t.jsx(l,{value:"15th",children:s("15th of month")||"每月15号"}),t.jsx(l,{value:"last",children:s("Last day of month")||"每月最后一天"}),t.jsx(l,{value:"first-monday",children:s("First Monday")||"每月第一个周一"}),t.jsx(l,{value:"first-friday",children:s("First Friday")||"每月第一个周五"}),t.jsx(l,{value:"last-friday",children:s("Last Friday")||"每月最后一个周五"})]}),t.jsx(R,{variant:"caption",color:"text.secondary",sx:{mt:.5,ml:1.75},children:s("Repeat rule description for monthly shift")||"每月班次的重复规则：选择班次每月重复的日期或星期"})]}):null,t.jsxs(x,{fullWidth:!0,children:[t.jsx(f,{children:s("common.status")}),t.jsxs(y,{value:r.status,label:s("common.status"),onChange:e=>c({...r,status:e.target.value}),children:[t.jsx(l,{value:"active",children:s("Active")}),t.jsx(l,{value:"cancelled",children:s("Cancelled")})]})]})]})}),t.jsxs(xe,{children:[t.jsx(L,{onClick:()=>m(!1),children:s("common.cancel")}),t.jsx(L,{onClick:j?ae:se,variant:"contained",children:s(j?"Update":"common.create")})]})]})]})}export{Te as default};
