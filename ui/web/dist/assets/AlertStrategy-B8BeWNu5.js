import{u as Ie,r as c,b4 as ue,j as t,B as g,w as de,x as me,T as x,a as A,v as Fe,A as he,F as S,n as C,o as w,M as f,P as pe,d as T,I,g as Ne,h as ke,i as ze,k as De,l as Ve,a3 as Ee,a4 as U,m as j,C as We,_ as ge,cz as Me,bb as Pe,b as xe,cA as $e,p as Be,bf as H,a7 as V}from"./index-CJIrazW8.js";import{a as v}from"./alertApi-C2dSZ0jV.js";import{S as _}from"./Stack-C3ISDylI.js";import{T as Oe,a as Le,b as Ue,c as E,d as m,e as He}from"./TableRow-JrGpygSA.js";import{C as W}from"./Chip-Bh8gAKTq.js";import{S as R}from"./Switch-CqW6_ohp.js";import{P as Re}from"./Pagination-hEBGVW9o.js";import{A as Ke}from"./Autocomplete-BY37jb2a.js";import"./LastPage-CClrOV-o.js";function st(){const{t:o}=Ie(),[K,q]=c.useState([]),[Y,G]=c.useState(!1),[fe,J]=c.useState(!1),[M,P]=c.useState(null),[$,ye]=c.useState(1),[B]=c.useState(10),[Q,je]=c.useState(0),[F,be]=c.useState(""),[N,X]=c.useState(0),[Z,ve]=c.useState(!1),[O,_e]=c.useState({}),[,k]=c.useState(!1),[,ee]=c.useState(new Map),[te,se]=c.useState([]),[ae,le]=c.useState(!1),[r,u]=c.useState({strategy_name:"",department_id:void 0,template_id:void 0,status:"enabled",weight:0,continuous:!1,delay:0,filters:[],strategy_set:[],time_slot:{enable:!1}}),[re,z]=c.useState({}),ne=c.useCallback(async()=>{k(!0);try{const s=(await ue.getUsersWithPagination({page:1,pageSize:20})).users||[];ee(a=>{const n=new Map(a);return s.forEach(i=>{n.set(String(i.id),{id:String(i.id),username:i.username,fullName:i.fullName})}),n})}catch(e){console.error("加载用户列表失败:",e)}finally{k(!1)}},[]),Ae=c.useCallback(async e=>{if(!e||e.trim().length===0){await ne();return}k(!0);try{const a=(await ue.getUsersWithPagination({page:1,pageSize:20,keyword:e.trim()})).users||[];ee(n=>{const i=new Map(n);return a.forEach(l=>{i.set(String(l.id),{id:String(l.id),username:l.username,fullName:l.fullName})}),i})}catch(s){console.error("搜索用户失败:",s)}finally{k(!1)}},[ne]);c.useEffect(()=>{const e={};return Object.keys(O).forEach(s=>{const a=O[parseInt(s)];a!==void 0&&(e[s]=setTimeout(()=>{Ae(a)},300))}),()=>{Object.values(e).forEach(s=>clearTimeout(s))}},[O]);const b=c.useCallback(async()=>{try{G(!0);const e={page:$,page_size:B};F&&(e.status=F);const s=await v.getStrategies(e);(s.data.code===0||s.data.code===200)&&(q(s.data.data||[]),je(s.data.total||0))}catch(e){console.error("获取告警策略失败:",e),q([])}finally{G(!1)}},[$,B,F]);c.useEffect(()=>{b()},[b]);const ie=c.useCallback(async()=>{try{le(!0);const e=await v.getTemplates({page:1,page_size:1e3});if(e.data.code===0||e.data.code===200){const s=e.data.data||[];se(s.map(a=>({id:a.id,template_name:a.template_name,enable:a.enable})))}}catch(e){console.error("加载告警模板失败:",e),se([])}finally{le(!1)}},[]);c.useEffect(()=>{ie()},[ie]);const oe=e=>{if(e){P(e);let s=[],a=e.time_slot||{enable:!1};if(Array.isArray(e.strategy_set)&&e.strategy_set.length>0){const n=e.strategy_set[0],i={...n,members:Array.isArray(n.members)?n.members.map(l=>String(l)):[],teams:Array.isArray(n.teams)?n.teams.map(l=>String(l)):[],alert_channels:Array.isArray(n.alert_channels)?Array.isArray(n.alert_channels[0])?n.alert_channels.flat():n.alert_channels:[],alert_level:Array.isArray(n.alert_level)?n.alert_level.map(l=>typeof l=="string"?parseInt(l,10):l).filter(l=>!isNaN(l)):[]};i.filters&&Array.isArray(i.filters)&&(s=i.filters.map(l=>({tag:l.tag||"",operation:"IN",value:Array.isArray(l.values)?l.values:[]}))),i.time_slot&&(a=i.time_slot)}s.length===0&&Array.isArray(e.filters)&&(s=e.filters.map(n=>({tag:n.tag||"",operation:n.operation||"IN",value:Array.isArray(n.values)?n.values:Array.isArray(n.value)?n.value:[]}))),u({strategy_name:e.strategy_name,department_id:e.department_id,template_id:e.template_id,status:e.status,weight:e.weight,continuous:e.continuous,delay:e.delay,filters:s.map(n=>({tag:n.tag||"",operation:n.operation||"IN",value:Array.isArray(n.value)?n.value:[]})),strategy_set:Array.isArray(e.strategy_set)&&e.strategy_set.length>0?[e.strategy_set[0]]:[{members:[],teams:[],alert_channels:[],alert_level:[],alert_loop:{enable:!1,count:1,interval:0},progression:{enable:!1,duration:1,condition:0}}],time_slot:a})}else P(null),u({strategy_name:"",department_id:void 0,template_id:void 0,status:"enabled",weight:0,continuous:!1,delay:0,filters:[],strategy_set:[{members:[],teams:[],alert_channels:[],alert_level:[],alert_loop:{enable:!1,count:1,interval:0},progression:{enable:!1,duration:1,condition:0}}],time_slot:{enable:!1}});X(0),_e({}),J(!0)},L=()=>{J(!1),P(null)},Se=async()=>{if(!r.strategy_name){H("请填写策略名称");return}try{const e={strategy_name:r.strategy_name,status:r.status,weight:r.weight||0,continuous:r.continuous||!1,delay:r.delay||0};r.time_slot&&(e.time_slot=r.time_slot);let s=[];if(r.filters&&Array.isArray(r.filters)&&r.filters.length>0){const i=r.filters.filter(l=>{const d=l.tag&&String(l.tag).trim()!=="",h=l.value&&Array.isArray(l.value)&&l.value.length>0,p=h&&l.value&&l.value.some(D=>{const y=String(D);return y&&y.trim()!==""});return d&&(!h||!p)});if(i.length>0){const l=i.map(d=>`"${d.tag}"`).join("、");H(`标签匹配条件 ${l} 已填写标签名，但未输入标签值，请至少输入一个标签值`);return}s=r.filters.filter(l=>{const d=l.tag&&String(l.tag).trim()!=="",p=l.value&&Array.isArray(l.value)&&l.value.length>0&&l.value&&l.value.some(D=>{const y=String(D);return y&&y.trim()!==""});return d&&p}).map(l=>{const d=(l.value||[]).map(h=>String(h).trim()).filter(h=>h!=="");return{tag:String(l.tag).trim(),values:d}})}const a=r.strategy_set&&Array.isArray(r.strategy_set)&&r.strategy_set.length>0?r.strategy_set[0]:{members:[],teams:[],alert_channels:[],alert_level:[],alert_loop:{enable:!1,count:1,interval:0},progression:{enable:!1,duration:1,condition:0}},n={teams:Array.isArray(a.teams)?a.teams.map(i=>typeof i=="string"?parseInt(i,10)||0:i).filter(i=>!isNaN(i)):[],members:Array.isArray(a.members)?a.members.map(i=>typeof i=="string"?parseInt(i,10)||0:i).filter(i=>!isNaN(i)):[],alert_channels:Array.isArray(a.alert_channels)?Array.isArray(a.alert_channels[0])?a.alert_channels:[a.alert_channels]:[],alert_level:Array.isArray(a.alert_level)?a.alert_level.map(i=>String(i)):[],alert_loop:a.alert_loop||{enable:!1,count:1,interval:0},progression:a.progression||{enable:!1,duration:1,condition:0}};e.strategy_set=[n],e.filters=s.length>0?s.map(i=>({tag:i.tag,value:i.values,operation:"IN"})):[],r.template_id&&(e.template_id=r.template_id),M?(await v.updateStrategy(M.id,e),V("更新成功")):(await v.createStrategy(e),V("创建成功")),L(),b()}catch(e){console.error("保存失败:",e),H(e?.response?.data?.message||"保存失败")}},Ce=async e=>{if(confirm("确定要删除这条告警策略吗？"))try{await v.deleteStrategy(e),V("删除成功"),b()}catch(s){console.error("删除失败:",s)}},ce=async(e,s)=>{try{const a=s==="enabled"?"disabled":"enabled";await v.toggleStrategy(e,a),V(`${a==="enabled"?"启用":"禁用"}成功`),b()}catch(a){console.error("操作失败:",a)}},we=e=>{switch(e){case"enabled":return"success";case"disabled":return"default";case"deleted":return"error";default:return"default"}},Te=e=>{switch(e){case"enabled":return o("common.enabled");case"disabled":return o("common.disabled");case"deleted":return o("common.deleted")||"已删除";default:return e}};return t.jsxs(g,{sx:{p:3},children:[t.jsx(de,{children:t.jsxs(me,{children:[t.jsxs(g,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[t.jsx(x,{variant:"h5",gutterBottom:!0,children:o("menu.monitorAlertStrategy")||"告警策略管理"}),t.jsxs(_,{direction:"row",spacing:2,children:[t.jsx(A,{variant:"outlined",startIcon:t.jsx(Fe,{}),onClick:b,disabled:Y,children:o("common.refresh")}),t.jsx(A,{variant:"contained",startIcon:t.jsx(he,{}),onClick:()=>oe(),children:o("Create Strategy")})]})]}),t.jsx(g,{sx:{mb:2,display:"flex",gap:2},children:t.jsxs(S,{size:"small",sx:{minWidth:200},children:[t.jsx(C,{children:o("common.status")}),t.jsxs(w,{value:F,label:o("common.status"),onChange:e=>be(e.target.value),children:[t.jsx(f,{value:"",children:o("common.all")}),t.jsx(f,{value:"enabled",children:o("common.enabled")}),t.jsx(f,{value:"disabled",children:o("common.disabled")})]})]})}),t.jsx(Oe,{component:pe,children:t.jsxs(Le,{children:[t.jsx(Ue,{children:t.jsxs(E,{children:[t.jsx(m,{children:o("Strategy Name")}),t.jsx(m,{children:o("Alert Template")}),t.jsx(m,{children:o("Weight")}),t.jsx(m,{children:o("Delay Notification")}),t.jsx(m,{children:o("Continuous Match")}),t.jsx(m,{children:o("common.status")}),t.jsx(m,{align:"right",children:o("common.actions")})]})}),t.jsx(He,{children:Y?t.jsx(E,{children:t.jsx(m,{colSpan:7,align:"center",children:o("common.loading")})}):K.length===0?t.jsx(E,{children:t.jsx(m,{colSpan:7,align:"center",children:o("common.noData")})}):K.map(e=>{const s=e.template_id?te.find(a=>a.id===e.template_id):null;return t.jsxs(E,{children:[t.jsx(m,{children:e.strategy_name}),t.jsx(m,{children:s?t.jsx(T,{title:s.template_desc||"",children:t.jsx(W,{label:s.template_name,size:"small",color:"primary",variant:"outlined"})}):t.jsx(x,{variant:"body2",color:"text.secondary",children:o("None")||"-"})}),t.jsx(m,{children:e.weight}),t.jsxs(m,{children:[e.delay,"s"]}),t.jsx(m,{children:t.jsx(W,{label:e.continuous?o("Yes"):o("No"),color:e.continuous?"success":"default",size:"small"})}),t.jsx(m,{children:t.jsx(W,{label:Te(e.status),color:we(e.status),size:"small"})}),t.jsx(m,{align:"right",children:t.jsxs(_,{direction:"row",spacing:1,justifyContent:"flex-end",children:[t.jsx(T,{title:"编辑",children:t.jsx(I,{size:"small",onClick:()=>oe(e),children:t.jsx(Ne,{fontSize:"small"})})}),t.jsx(T,{title:e.status==="enabled"?"禁用":"启用",children:t.jsx(I,{size:"small",onClick:()=>ce(e.id,e.status),children:t.jsx(R,{checked:e.status==="enabled",size:"small",onChange:()=>ce(e.id,e.status)})})}),t.jsx(T,{title:"删除",children:t.jsx(I,{size:"small",color:"error",onClick:()=>Ce(e.id),children:t.jsx(ke,{fontSize:"small"})})})]})})]},e.id)})})]})}),Q>0&&t.jsx(g,{sx:{display:"flex",justifyContent:"center",mt:2},children:t.jsx(Re,{count:Math.ceil(Q/B),page:$,onChange:(e,s)=>ye(s),color:"primary"})})]})}),t.jsxs(ze,{open:fe,onClose:L,maxWidth:"md",fullWidth:!0,children:[t.jsx(De,{children:M?o("Edit Strategy")||"编辑告警策略":o("Create Strategy")||"新建告警策略"}),t.jsx(Ve,{children:t.jsxs(g,{sx:{mt:2},children:[t.jsx(g,{sx:{borderBottom:1,borderColor:"divider",mb:2},children:t.jsxs(Ee,{value:N,onChange:(e,s)=>X(s),children:[t.jsx(U,{label:"基本信息"}),t.jsx(U,{label:"标签匹配条件"}),t.jsx(U,{label:"时间段策略"})]})}),N===0&&t.jsxs(_,{spacing:3,children:[t.jsx(j,{label:`${o("Strategy Name")} *`,value:r.strategy_name,onChange:e=>u({...r,strategy_name:e.target.value}),fullWidth:!0,required:!0}),t.jsxs(S,{fullWidth:!0,children:[t.jsx(C,{children:o("Alert Template")}),t.jsxs(w,{value:r.template_id||"",label:o("Alert Template"),onChange:e=>u({...r,template_id:e.target.value?Number(e.target.value):void 0}),disabled:ae,children:[t.jsx(f,{value:"",children:t.jsx("em",{children:o("None")||"不选择"})}),te.filter(e=>e.enable).map(e=>t.jsxs(f,{value:e.id,children:[e.template_name,e.template_desc&&t.jsxs(x,{variant:"caption",color:"text.secondary",sx:{ml:1},children:["(",e.template_desc,")"]})]},e.id))]}),ae&&t.jsxs(g,{sx:{display:"flex",alignItems:"center",mt:1},children:[t.jsx(We,{size:16,sx:{mr:1}}),t.jsx(x,{variant:"caption",color:"text.secondary",children:o("Loading templates...")})]}),t.jsx(x,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:o("Select an alert template to configure notification channels (Feishu, DingTalk, etc.)")}),t.jsx(x,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:"提示：通知成员和告警组需要在模板中配置，策略只需选择模板即可。"})]}),t.jsx(j,{label:o("Weight"),type:"number",value:r.weight,onChange:e=>u({...r,weight:parseInt(e.target.value)||0}),fullWidth:!0,helperText:o("Higher weight means higher priority")||"权重越大优先级越高"}),t.jsx(j,{label:`${o("Delay Notification")} (${o("seconds")||"秒"})`,type:"number",value:r.delay,onChange:e=>{const s=e.target.value;if(s==="")u({...r,delay:0});else{const a=parseInt(s,10);!isNaN(a)&&a>=0&&u({...r,delay:a})}},onBlur:e=>{const s=e.target.value;(s===""||isNaN(parseInt(s,10)))&&u({...r,delay:0})},inputProps:{min:0,step:1},fullWidth:!0,helperText:o("Delay before sending notification")||"延迟多长时间后发送通知"}),t.jsxs(g,{children:[t.jsxs(g,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(ge,{control:t.jsx(R,{checked:r.continuous??!1,onChange:e=>u({...r,continuous:e.target.checked})}),label:o("Continuous Match")}),t.jsx(T,{title:"接续匹配说明",children:t.jsx(I,{size:"small",onClick:()=>ve(!Z),sx:{color:"primary.main"},children:t.jsx(Me,{fontSize:"small"})})})]}),t.jsx(Pe,{in:Z,timeout:"auto",unmountOnExit:!0,children:t.jsx(de,{sx:{mt:1,mb:2,bgcolor:"grey.50"},children:t.jsxs(me,{children:[t.jsx(x,{variant:"subtitle2",gutterBottom:!0,sx:{fontWeight:"bold",mb:1},children:"接续匹配说明"}),t.jsxs(x,{variant:"body2",paragraph:!0,children:[t.jsx("strong",{children:"开启接续匹配："}),"当告警事件持续匹配该策略时，系统会持续发送通知。例如，如果告警事件在第一次匹配后仍未解决，系统会在后续的匹配周期中继续发送通知，直到告警事件被处理或恢复。"]}),t.jsxs(x,{variant:"body2",paragraph:!0,children:[t.jsx("strong",{children:"关闭接续匹配："}),"告警事件只在第一次匹配策略时发送一次通知，后续即使继续匹配也不会再次发送通知。适用于只需要在告警首次触发时通知的场景。"]}),t.jsxs(x,{variant:"body2",color:"text.secondary",children:[t.jsx("strong",{children:"使用场景："}),"开启接续匹配适用于需要持续关注的重要告警，确保相关人员能够及时了解告警状态；关闭接续匹配适用于避免重复通知的场景，减少通知噪音。"]})]})})})]}),t.jsxs(S,{fullWidth:!0,children:[t.jsx(C,{children:o("common.status")}),t.jsxs(w,{value:r.status,label:o("common.status"),onChange:e=>u({...r,status:e.target.value}),children:[t.jsx(f,{value:"enabled",children:o("common.enabled")}),t.jsx(f,{value:"disabled",children:o("common.disabled")})]})]})]}),N===1&&t.jsxs(_,{spacing:2,children:[t.jsxs(g,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(x,{variant:"subtitle1",children:"标签匹配条件"}),t.jsx(A,{size:"small",startIcon:t.jsx(he,{}),onClick:()=>{const e=Array.isArray(r.filters)?r.filters:[],s={tag:"",operation:"IN",value:[]},a=[...e,s];u(n=>({...n,filters:a}))},children:"添加条件"})]}),t.jsx(xe,{severity:"info",sx:{mb:2},children:"根据告警事件的标签进行匹配。例如：匹配 environment=production 或 service=api 的告警。"}),Array.isArray(r.filters)&&r.filters.length>0?r.filters.map((e,s)=>t.jsx(pe,{sx:{p:2,bgcolor:"grey.50"},children:t.jsxs(_,{spacing:2,children:[t.jsxs(g,{sx:{display:"flex",gap:2,alignItems:"center"},children:[t.jsx(j,{label:"标签名",size:"small",value:e.tag||"",onChange:a=>{u(n=>{const l=[...Array.isArray(n.filters)?n.filters:[]];return l[s]={...l[s],tag:a.target.value},{...n,filters:l}})},placeholder:"例如: environment",sx:{flex:1}}),t.jsxs(S,{size:"small",sx:{minWidth:120},children:[t.jsx(C,{children:"操作符"}),t.jsxs(w,{value:e.operation||"IN",label:"操作符",onChange:a=>{u(n=>{const l=[...Array.isArray(n.filters)?n.filters:[]];return l[s]={...l[s],operation:a.target.value},{...n,filters:l}})},children:[t.jsx(f,{value:"IN",children:"IN"}),t.jsx(f,{value:"NOT IN",children:"NOT IN"}),t.jsx(f,{value:"=",children:"="}),t.jsx(f,{value:"!=",children:"!="})]})]}),t.jsx(I,{color:"error",size:"small",onClick:()=>{u(a=>{const i=[...Array.isArray(a.filters)?a.filters:[]];return i.splice(s,1),{...a,filters:i}})},children:t.jsx($e,{})})]}),t.jsx(Ke,{multiple:!0,freeSolo:!0,size:"small",options:[],value:Array.isArray(e.value)?e.value:[],inputValue:re[s]||"",onChange:(a,n)=>{const i=Array.isArray(n)?n:[];u(l=>{const h=[...Array.isArray(l.filters)?l.filters:[]];return h[s]={...h[s],value:i},{...l,filters:h}}),z(l=>({...l,[s]:""}))},onInputChange:(a,n,i)=>{if(z(l=>({...l,[s]:n})),i==="reset"&&n.trim()){const l=Array.isArray(e.value)?e.value:[],d=n.trim();if(d&&!l.includes(d)){const h=[...l,d];u(p=>{const y=[...Array.isArray(p.filters)?p.filters:[]];return y[s]={...y[s],value:h},{...p,filters:y}}),z(p=>({...p,[s]:""}))}}},onBlur:()=>{const a=re[s]||"";if(a.trim()){const n=Array.isArray(e.value)?e.value:[],i=a.trim();if(!n.includes(i)){const l=[...n,i];u(d=>{const p=[...Array.isArray(d.filters)?d.filters:[]];return p[s]={...p[s],value:l},{...d,filters:p}}),z(d=>({...d,[s]:""}))}}},selectOnFocus:!0,clearOnBlur:!1,handleHomeEndKeys:!0,renderInput:a=>t.jsx(j,{...a,label:"标签值",placeholder:"输入值后按回车",helperText:Array.isArray(e.value)&&e.value.length>0?`已输入 ${e.value.length} 个值: ${e.value.join(", ")}`:"输入值后按回车添加"}),renderTags:(a,n)=>a.map((i,l)=>c.createElement(W,{...n({index:l}),key:l,label:String(i),size:"small"}))},`autocomplete-${s}`)]})},`filter-${s}`)):t.jsx(x,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",py:4},children:'暂无匹配条件，点击"添加条件"按钮添加'})]}),N===2&&t.jsxs(_,{spacing:2,children:[t.jsx(ge,{control:t.jsx(R,{checked:r.time_slot?.enable||!1,onChange:e=>u({...r,time_slot:{...r.time_slot,enable:e.target.checked}})}),label:"启用时间段策略"}),r.time_slot?.enable&&t.jsxs(t.Fragment,{children:[t.jsxs(S,{fullWidth:!0,children:[t.jsx(C,{children:"星期"}),t.jsx(w,{multiple:!0,value:r.time_slot?.weeks||[],label:"星期",onChange:e=>u({...r,time_slot:{...r.time_slot,enable:r.time_slot?.enable||!1,weeks:e.target.value}}),renderValue:e=>{const s=["周日","周一","周二","周三","周四","周五","周六"];return e.map(a=>s[a]).join(", ")},children:[0,1,2,3,4,5,6].map(e=>t.jsx(f,{value:e,children:["周日","周一","周二","周三","周四","周五","周六"][e]},e))})]}),t.jsxs(g,{sx:{display:"flex",gap:2},children:[t.jsx(j,{label:"开始时间",type:"time",value:(()=>{const e=r.time_slot?.times?.[0]||"";return e&&e.length===8?e.substring(0,5):e})(),onChange:e=>{const s=r.time_slot?.times||[],a=e.target.value;s[0]=a?`${a}:00`:"",u({...r,time_slot:{...r.time_slot,enable:r.time_slot?.enable||!1,times:s}})},InputLabelProps:{shrink:!0},fullWidth:!0}),t.jsx(j,{label:"结束时间",type:"time",value:(()=>{const e=r.time_slot?.times?.[1]||"";return e&&e.length===8?e.substring(0,5):e})(),onChange:e=>{const s=r.time_slot?.times||[],a=e.target.value;s[1]=a?`${a}:00`:"",u({...r,time_slot:{...r.time_slot,enable:r.time_slot?.enable||!1,times:s}})},InputLabelProps:{shrink:!0},fullWidth:!0})]})]}),t.jsx(xe,{severity:"info",children:"配置策略在哪些时间段生效。例如：工作日 9:00-18:00。"})]})]})}),t.jsxs(Be,{children:[t.jsx(A,{onClick:L,children:"取消"}),t.jsx(A,{onClick:Se,variant:"contained",children:"保存"})]})]})]})}export{st as default};
