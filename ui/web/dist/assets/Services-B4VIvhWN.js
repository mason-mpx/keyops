import{u as he,ax as fe,r as u,c3 as ge,bf as b,br as W,b4 as xe,j as s,B as x,P as me,T as je,d as V,I as K,v as ye,a as B,A as Ce,m as v,s as Ae,t as Te,M as a,b as Ee,C as R,be as Oe,h as Se,i as be,k as Be,l as ze,_ as Ie,p as De,a7 as q}from"./index-wVs8DYHr.js";import{T as we,a as We,b as Re,c as Q,d as o,e as Le}from"./TableRow-17IyVPm2.js";import{C as Y}from"./Chip-DzNpApxT.js";import{T as Ne}from"./TablePagination-l3CyI5hc.js";import{A as E}from"./Autocomplete-B1PHB6qe.js";import{S as Pe}from"./Switch-DnfqMs2v.js";import"./LastPage-Bx6x4Acm.js";function Ve(){const{t}=he(),ne=fe(),[$,ie]=u.useState([]),[m,le]=u.useState([]),[J,X]=u.useState(!1),[L,z]=u.useState(!1),[j,ae]=u.useState({}),[Z,N]=u.useState(""),[P,I]=u.useState(0),[k,ce]=u.useState(10),[C,ee]=u.useState([]),[A,se]=u.useState(!1),[c,D]=u.useState({name:"",org:"",department:"",status:"",srvType:"",virtualTech:"",site:"",isCritical:void 0}),[i,h]=u.useState({org:"",lineOfBiz:"",name:"",isCritical:!1,srvType:"WEB",virtualTech:"",status:"Initializing",site:"",department:"",description:"",onlineAt:"",offlineAt:"",gitUrl:"",opsOwners:[],testOwners:[],devOwners:[]}),O=u.useCallback(e=>{let r=[];return e.forEach(n=>{r.push(n),n.children&&n.children.length>0&&(r=r.concat(O(n.children)))}),r},[]),re=u.useCallback(async()=>{try{const e=await ge.getOrganizationTree();le(Array.isArray(e)?e:[]);const r=O(Array.isArray(e)?e:[]),n=r.find(l=>l.unitCode==="backend-dept");n?console.log("✅ 找到 backend-dept:",n):(console.warn("❌ 未找到 backend-dept"),console.log("所有部门的 unitCode:",r.filter(l=>l.unitType==="Department").map(l=>({unitCode:l.unitCode,unitName:l.unitName}))))}catch(e){console.error("加载组织列表失败:",e),b("加载组织列表失败，请刷新页面重试")}},[O]),w=(e,r)=>O(e).filter(l=>l.unitType===r),U=(e,r)=>{if(!e)return"-";const l=O(r).find(d=>d.unitCode===e);return l?l.unitName:e},M=(e,r)=>{if(!e)return[];const n=(d,f)=>{for(const p of f){if(p.unitCode===d)return p;if(p.children){const g=n(d,p.children);if(g)return g}}return null},l=n(e,r);return!l||!l.children?[]:l.children.filter(d=>d.unitType==="LineOfBiz")},_=(e,r)=>{if(!e)return i.org?oe(i.org,r):w(r,"Department");const n=(f,p)=>{for(const g of p){if(g.unitCode===f)return g;if(g.children){const S=n(f,g.children);if(S)return S}}return null},l=n(e,r);if(!l)return[];const d=f=>{let p=[];return f.unitType==="Department"&&p.push(f),f.children&&f.children.forEach(g=>{p=p.concat(d(g))}),p};return d(l)},oe=(e,r)=>{if(!e)return w(r,"Department");const n=(f,p)=>{for(const g of p){if(g.unitCode===f)return g;if(g.children){const S=n(f,g.children);if(S)return S}}return null},l=n(e,r);if(!l)return[];const d=f=>{let p=[];return f.unitType==="Department"&&p.push(f),f.children&&f.children.forEach(g=>{p=p.concat(d(g))}),p};return d(l)},T=u.useCallback(async()=>{X(!0),N("");try{const e={};c.name&&(e.name=c.name),c.org&&(e.org=c.org),c.department&&(e.department=c.department),c.status&&(e.status=c.status),c.srvType&&(e.srvType=c.srvType),c.virtualTech&&(e.virtualTech=c.virtualTech),c.site&&(e.site=c.site),c.isCritical!==void 0&&(e.isCritical=c.isCritical);const r=await W.getApplications(e);ie(Array.isArray(r)?r:[])}catch(e){const r=e,n=r?.response?.data?.message||r?.message||t("services.loadFailed");N(n),b(n)}finally{X(!1)}},[c,t]),y=u.useCallback(async(e="")=>{try{se(!0);const r=await xe.getUsersWithRoles({page:1,pageSize:10,keyword:e||void 0});ee(r.users||[])}catch(r){console.error("加载用户列表失败:",r),ee([])}finally{se(!1)}},[]);u.useEffect(()=>{re()},[re]),u.useEffect(()=>{T()},[T]),u.useEffect(()=>{L&&y()},[L,y]);const ue=()=>{ae({}),h({org:"",lineOfBiz:"",name:"",isCritical:!1,srvType:"WEB",virtualTech:"",status:"Initializing",site:"",department:"",description:"",onlineAt:"",offlineAt:"",gitUrl:"",opsOwners:[],testOwners:[],devOwners:[]}),z(!0)},de=async e=>{if(window.confirm(t("services.deleteConfirm")))try{await W.deleteApplication(e),q(t("services.deleteSuccess")),T()}catch(r){const n=r,l=n?.response?.data?.message||n?.message||t("services.deleteFailed");b(l)}},pe=async()=>{if(!i.name.trim()){b(t("services.nameRequired"));return}try{const e=n=>{if(!(!n||n.trim()===""))try{const l=new Date(n);return isNaN(l.getTime())?void 0:l.toISOString()}catch{return}},r={org:i.org||void 0,lineOfBiz:i.lineOfBiz||void 0,name:i.name,isCritical:i.isCritical,srvType:i.srvType,virtualTech:i.virtualTech||void 0,status:i.status,site:i.site||void 0,department:i.department||void 0,description:i.description||void 0,onlineAt:e(i.onlineAt),offlineAt:e(i.offlineAt),gitUrl:i.gitUrl||void 0,opsOwners:i.opsOwners&&i.opsOwners.length>0?i.opsOwners:void 0,testOwners:i.testOwners&&i.testOwners.length>0?i.testOwners:void 0,devOwners:i.devOwners&&i.devOwners.length>0?i.devOwners:void 0};j.id?(await W.updateApplication(j.id,r),q(t("services.updateSuccess"))):(await W.createApplication(r),q(t("services.createSuccess"))),z(!1),T()}catch(e){const r=e,n=r?.response?.data?.message||r?.message||t("services.saveFailed");b(n)}},ve=e=>{switch(e){case"Running":return"success";case"Stopped":return"error";case"Initializing":return"warning";default:return"default"}},G=(e,r)=>{for(const n of r){if(n.unitCode===e)return n;if(n.children){const l=G(e,n.children);if(l)return l}}return null};let H=M(i.org,m);if(j.id&&j.lineOfBiz){const e=j.lineOfBiz;if(!H.some(n=>n.unitCode===e)){const n=G(e,m);n&&n.unitType==="LineOfBiz"&&(H=[n,...H])}}let F=_(i.lineOfBiz,m);if(j.id&&j.department){const e=j.department;if(!F.some(n=>n.unitCode===e)){const n=G(e,m);n&&n.unitType==="Department"&&(F=[n,...F])}}const te=$.slice(P*k,(P+1)*k);return s.jsx(x,{children:s.jsxs(me,{sx:{p:3},children:[s.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[s.jsx(je,{variant:"h5",children:t("services.title")}),s.jsxs(x,{children:[s.jsx(V,{title:t("services.refresh"),children:s.jsx(K,{onClick:T,disabled:J,children:s.jsx(ye,{})})}),s.jsx(B,{variant:"contained",startIcon:s.jsx(Ce,{}),onClick:ue,sx:{ml:1},children:t("services.createApplication")})]})]}),s.jsxs(x,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap"},children:[s.jsx(v,{size:"small",placeholder:t("services.searchPlaceholder"),value:c.name,onChange:e=>D({...c,name:e.target.value}),InputProps:{startAdornment:s.jsx(Ae,{position:"start",children:s.jsx(Te,{})})},sx:{minWidth:200}}),s.jsxs(v,{size:"small",select:!0,label:t("services.status"),value:c.status,onChange:e=>D({...c,status:e.target.value}),sx:{minWidth:120},children:[s.jsx(a,{value:"",children:t("services.all")}),s.jsx(a,{value:"Running",children:t("services.running")}),s.jsx(a,{value:"Stopped",children:t("services.stopped")}),s.jsx(a,{value:"Initializing",children:t("services.initializing")})]}),s.jsxs(v,{size:"small",select:!0,label:t("services.applicationType"),value:c.srvType,onChange:e=>D({...c,srvType:e.target.value}),sx:{minWidth:120},children:[s.jsx(a,{value:"",children:t("services.all")}),s.jsx(a,{value:"SERVER",children:t("services.srvType.SERVER")}),s.jsx(a,{value:"WEB",children:t("services.srvType.WEB")}),s.jsx(a,{value:"MIDDLEWARE",children:t("services.srvType.MIDDLEWARE")}),s.jsx(a,{value:"DATAWARE",children:t("services.srvType.DATAWARE")}),s.jsx(a,{value:"MOBILE",children:t("services.srvType.MOBILE")}),s.jsx(a,{value:"DATABASE",children:t("services.srvType.DATABASE")}),s.jsx(a,{value:"MICROSERVICE",children:t("services.srvType.MICROSERVICE")}),s.jsx(a,{value:"BATCH",children:t("services.srvType.BATCH")}),s.jsx(a,{value:"SCHEDULER",children:t("services.srvType.SCHEDULER")}),s.jsx(a,{value:"GATEWAY",children:t("services.srvType.GATEWAY")}),s.jsx(a,{value:"CACHE",children:t("services.srvType.CACHE")}),s.jsx(a,{value:"MESSAGE_QUEUE",children:t("services.srvType.MESSAGE_QUEUE")}),s.jsx(a,{value:"BACKEND",children:t("services.srvType.BACKEND")})]}),s.jsx(B,{variant:"outlined",onClick:()=>{I(0),T()},children:t("services.search")}),s.jsx(B,{variant:"outlined",onClick:()=>{D({name:"",org:"",department:"",status:"",srvType:"",virtualTech:"",site:"",isCritical:void 0}),I(0)},children:t("services.reset")})]}),Z&&s.jsx(Ee,{severity:"error",sx:{mb:2},onClose:()=>N(""),children:Z}),J?s.jsx(x,{sx:{display:"flex",justifyContent:"center",p:4},children:s.jsx(R,{})}):s.jsxs(s.Fragment,{children:[s.jsx(we,{children:s.jsxs(We,{children:[s.jsx(Re,{children:s.jsxs(Q,{children:[s.jsx(o,{children:t("services.applicationName")}),s.jsx(o,{children:t("services.org")}),s.jsx(o,{children:t("services.lineOfBiz")}),s.jsx(o,{children:t("services.department")}),s.jsx(o,{children:t("services.site")}),s.jsx(o,{children:t("services.applicationType")}),s.jsx(o,{children:t("services.virtualTech")}),s.jsx(o,{children:t("services.status")}),s.jsx(o,{children:t("services.isCritical")}),s.jsx(o,{children:t("services.onlineAt")}),s.jsx(o,{align:"center",children:t("services.actions")})]})}),s.jsx(Le,{children:te.length===0?s.jsx(Q,{children:s.jsx(o,{colSpan:11,align:"center",children:t("services.noData")})}):te.map(e=>s.jsxs(Q,{children:[s.jsx(o,{children:e.name}),s.jsx(o,{children:U(e.org,m)}),s.jsx(o,{children:U(e.lineOfBiz,m)}),s.jsx(o,{children:U(e.department,m)}),s.jsx(o,{children:e.site||"-"}),s.jsx(o,{children:t(`services.srvType.${e.srvType}`,e.srvType)}),s.jsx(o,{children:e.virtualTech||"-"}),s.jsx(o,{children:s.jsx(Y,{label:e.status,color:ve(e.status),size:"small"})}),s.jsx(o,{children:e.isCritical?s.jsx(Y,{label:t("services.yes"),color:"error",size:"small"}):s.jsx(Y,{label:t("services.no"),size:"small"})}),s.jsx(o,{children:e.onlineAt?new Date(e.onlineAt).toLocaleString("zh-CN"):"-"}),s.jsx(o,{align:"center",children:s.jsxs(x,{sx:{display:"flex",gap:.5,justifyContent:"center"},children:[s.jsx(V,{title:t("services.detail")||"详情",children:s.jsx(K,{size:"small",onClick:()=>ne(`/services/${e.id}`),color:"primary",children:s.jsx(Oe,{fontSize:"small"})})}),s.jsx(V,{title:t("common.delete"),children:s.jsx(K,{size:"small",color:"error",onClick:()=>de(e.id),children:s.jsx(Se,{fontSize:"small"})})})]})})]},e.id))})]})}),s.jsx(Ne,{component:"div",count:$.length,page:P,onPageChange:(e,r)=>I(r),rowsPerPage:k,onRowsPerPageChange:e=>{ce(parseInt(e.target.value,10)),I(0)},rowsPerPageOptions:[10,25,50,100]})]}),s.jsxs(be,{open:L,onClose:()=>z(!1),maxWidth:"md",fullWidth:!0,children:[s.jsx(Be,{children:t("services.createApplication")}),s.jsx(ze,{children:s.jsxs(x,{sx:{pt:2,display:"flex",flexDirection:"column",gap:2},children:[s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(v,{fullWidth:!0,label:t("services.applicationName"),value:i.name,onChange:e=>h({...i,name:e.target.value}),required:!0}),s.jsxs(v,{fullWidth:!0,label:t("services.status"),select:!0,value:i.status,onChange:e=>h({...i,status:e.target.value}),required:!0,children:[s.jsx(a,{value:"Initializing",children:t("services.initializing")}),s.jsx(a,{value:"Running",children:t("services.running")}),s.jsx(a,{value:"Stopped",children:t("services.stopped")})]})]}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(E,{fullWidth:!0,options:w(m,"BizGroup"),getOptionLabel:e=>e.unitName,value:w(m,"BizGroup").find(e=>e.unitCode===i.org)||null,onChange:(e,r)=>{h({...i,org:r?.unitCode||"",lineOfBiz:"",department:""})},renderInput:e=>s.jsx(v,{...e,label:t("services.org")||"事业部",required:!0})}),s.jsx(E,{fullWidth:!0,disabled:!i.org,options:M(i.org,m),getOptionLabel:e=>e.unitName,value:M(i.org,m).find(e=>e.unitCode===i.lineOfBiz)||null,onChange:(e,r)=>{h({...i,lineOfBiz:r?.unitCode||"",department:""})},renderInput:e=>s.jsx(v,{...e,label:t("services.lineOfBiz")||"业务线",placeholder:i.org?"请选择业务线":"请先选择事业部"})})]}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(E,{fullWidth:!0,disabled:!i.lineOfBiz,options:_(i.lineOfBiz,m),getOptionLabel:e=>e.unitName,value:_(i.lineOfBiz,m).find(e=>e.unitCode===i.department)||null,onChange:(e,r)=>{h({...i,department:r?.unitCode||""})},renderInput:e=>s.jsx(v,{...e,label:t("services.department")||"部门",placeholder:i.lineOfBiz?"请选择部门":"请先选择业务线"})}),s.jsx(v,{fullWidth:!0,label:t("services.site"),value:i.site,onChange:e=>h({...i,site:e.target.value})})]}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsxs(v,{fullWidth:!0,label:t("services.applicationType"),select:!0,value:i.srvType,onChange:e=>h({...i,srvType:e.target.value}),required:!0,children:[s.jsx(a,{value:"SERVER",children:t("services.srvType.SERVER")}),s.jsx(a,{value:"WEB",children:t("services.srvType.WEB")}),s.jsx(a,{value:"MIDDLEWARE",children:t("services.srvType.MIDDLEWARE")}),s.jsx(a,{value:"DATAWARE",children:t("services.srvType.DATAWARE")}),s.jsx(a,{value:"MOBILE",children:t("services.srvType.MOBILE")}),s.jsx(a,{value:"DATABASE",children:t("services.srvType.DATABASE")}),s.jsx(a,{value:"MICROSERVICE",children:t("services.srvType.MICROSERVICE")}),s.jsx(a,{value:"BATCH",children:t("services.srvType.BATCH")}),s.jsx(a,{value:"SCHEDULER",children:t("services.srvType.SCHEDULER")}),s.jsx(a,{value:"GATEWAY",children:t("services.srvType.GATEWAY")}),s.jsx(a,{value:"CACHE",children:t("services.srvType.CACHE")}),s.jsx(a,{value:"MESSAGE_QUEUE",children:t("services.srvType.MESSAGE_QUEUE")}),s.jsx(a,{value:"BACKEND",children:t("services.srvType.BACKEND")})]}),s.jsxs(v,{fullWidth:!0,label:t("services.virtualTech"),select:!0,value:i.virtualTech,onChange:e=>h({...i,virtualTech:e.target.value}),children:[s.jsx(a,{value:"",children:t("common.none")}),s.jsx(a,{value:"K8S",children:"K8S"}),s.jsx(a,{value:"EC2",children:"EC2"}),s.jsx(a,{value:"ECS",children:"ECS"}),s.jsx(a,{value:"GCE",children:"GCE"})]})]}),s.jsx(v,{fullWidth:!0,label:t("services.description"),value:i.description,onChange:e=>h({...i,description:e.target.value}),multiline:!0,rows:3}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(v,{fullWidth:!0,label:t("services.onlineAt"),type:"datetime-local",value:i.onlineAt,onChange:e=>h({...i,onlineAt:e.target.value}),InputLabelProps:{shrink:!0}}),s.jsx(v,{fullWidth:!0,label:t("services.offlineAt"),type:"datetime-local",value:i.offlineAt,onChange:e=>h({...i,offlineAt:e.target.value}),InputLabelProps:{shrink:!0}})]}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(v,{fullWidth:!0,label:t("services.gitUrl")||"Git地址",value:i.gitUrl,onChange:e=>h({...i,gitUrl:e.target.value})}),s.jsx(E,{fullWidth:!0,multiple:!0,options:C,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(i.opsOwners||[]).map(e=>C.find(n=>n.username===e||n.fullName===e)||e),onChange:(e,r)=>{const n=r.map(l=>typeof l=="string"?l:l.username||l.fullName||"");h({...i,opsOwners:n})},onInputChange:(e,r)=>{r?y(r):y()},loading:A,filterOptions:e=>e,renderInput:e=>s.jsx(v,{...e,label:t("services.opsOwners")||"运维负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[A?s.jsx(R,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,r)=>{const n=typeof r=="string"?null:r,l=n?n.fullName||n.username||"":typeof r=="string"?r:"",d=n?n.id:typeof r=="string"?r:String(r);return u.createElement("li",{...e,key:d},l)}})]}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(E,{fullWidth:!0,multiple:!0,options:C,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(i.testOwners||[]).map(e=>C.find(n=>n.username===e||n.fullName===e)||e),onChange:(e,r)=>{const n=r.map(l=>typeof l=="string"?l:l.username||l.fullName||"");h({...i,testOwners:n})},onInputChange:(e,r)=>{r?y(r):y()},loading:A,filterOptions:e=>e.slice(0,10),renderInput:e=>s.jsx(v,{...e,label:t("services.testOwners")||"测试负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[A?s.jsx(R,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,r)=>{const n=typeof r=="string"?null:r,l=n?n.username||n.fullName||"":typeof r=="string"?r:"",d=n?n.id:typeof r=="string"?r:String(r);return u.createElement("li",{...e,key:d},l)}}),s.jsx(E,{fullWidth:!0,multiple:!0,options:C,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(i.devOwners||[]).map(e=>C.find(n=>n.username===e||n.fullName===e)||e),onChange:(e,r)=>{const n=r.map(l=>typeof l=="string"?l:l.username||l.fullName||"");h({...i,devOwners:n})},onInputChange:(e,r)=>{r?y(r):y()},loading:A,filterOptions:e=>e.slice(0,10),renderInput:e=>s.jsx(v,{...e,label:t("services.devOwners")||"研发负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[A?s.jsx(R,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,r)=>{const n=typeof r=="string"?null:r,l=n?n.username||n.fullName||"":typeof r=="string"?r:"",d=n?n.id:typeof r=="string"?r:String(r);return u.createElement("li",{...e,key:d},l)}})]}),s.jsx(Ie,{control:s.jsx(Pe,{checked:i.isCritical,onChange:e=>h({...i,isCritical:e.target.checked})}),label:t("services.isCriticalApp")})]})}),s.jsxs(De,{children:[s.jsx(B,{onClick:()=>z(!1),children:t("services.cancel")}),s.jsx(B,{onClick:pe,variant:"contained",children:t("services.save")})]})]})]})})}export{Ve as default};
