import{ax as v,cL as T,r as p,bf as d,j as e,B as m,C as V,b as f,a as j,aA as S,T as F,P as C,cR as N,a7 as _}from"./index-CJIrazW8.js";import{a as E,t as A}from"./ticketApi-CCnZQOPl.js";import{j as D,F as R,k as $,b5 as B,b6 as G,b2 as z,aY as g,a_ as L,aT as O,b4 as U,aX as w,aU as H,u as h,aW as J,b3 as M,aV as X,b1 as Y}from"./index-Cgn-RpuY.js";import"./typeof-QjJsDpFa.js";class q extends p.Component{constructor(a){super(a),this.state={hasError:!1,error:null}}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,s){console.error("表单渲染错误:",a,s)}render(){return this.state.hasError?this.props.fallback||e.jsxs(f,{severity:"error",sx:{mt:2},children:["表单渲染出错: ",this.state.error?.message||"未知错误"]}):this.props.children}}const K=r=>{const s=h()?.componentProps?.size||r.size||200,i=`${typeof s=="number"?s:parseInt(String(s))||200}px`,{size:o,...t}=r;return e.jsx("div",{style:{width:i,maxWidth:i},children:e.jsx(w,{...t,style:{...t.style&&typeof t.style=="object"?t.style:{},width:"100%"}})})},Q=r=>{const s=h()?.componentProps?.size||r.size||200,i=`${typeof s=="number"?s:parseInt(String(s))||200}px`,{size:o,...t}=r;return e.jsx("div",{style:{width:i,maxWidth:i},children:e.jsx(w.TextArea,{...t,style:{...t.style&&typeof t.style=="object"?t.style:{},width:"100%"}})})},Z=r=>{const s=h()?.componentProps?.size||r.size||200,i=`${typeof s=="number"?s:parseInt(String(s))||200}px`,{size:o,...t}=r;return e.jsx("div",{style:{width:i,maxWidth:i},children:e.jsx(X,{...t,style:{...t.style&&typeof t.style=="object"?t.style:{},width:"100%"}})})},k=r=>{const s=h()?.componentProps?.size||r.size||200,i=`${typeof s=="number"?s:parseInt(String(s))||200}px`,{size:o,...t}=r;return e.jsx("div",{style:{width:i,maxWidth:i},children:e.jsx(J,{...t,style:{...t.style&&typeof t.style=="object"?t.style:{},width:"100%"}})})},ee=r=>{const s=h()?.componentProps?.size||r.size||200,i=`${typeof s=="number"?s:parseInt(String(s))||200}px`,{size:o,...t}=r;return e.jsx("div",{style:{width:i,maxWidth:i},children:e.jsx(Y,{...t,style:{...t.style&&typeof t.style=="object"?t.style:{},width:"100%"}})})},te=r=>{const s=h()?.componentProps?.size||r.size||200,i=`${typeof s=="number"?s:parseInt(String(s))||200}px`,{size:o,...t}=r;return e.jsx("div",{style:{width:i,maxWidth:i},children:e.jsx(z,{...t,style:{...t.style&&typeof t.style=="object"?t.style:{},width:"100%"}})})},se=r=>{const s=h()?.componentProps?.size||r.size||200,i=`${typeof s=="number"?s:parseInt(String(s))||200}px`,{size:o,...t}=r;return e.jsx("div",{style:{width:i,maxWidth:i},children:e.jsx(M,{...t,style:{...t.style&&typeof t.style=="object"?t.style:{},width:"100%"}})})},re=$({components:{FormItem:g,Input:K,TextArea:Q,Password:ee,Select:Z,DatePicker:te,TimePicker:se,DateRangePicker:z.RangePicker||z,NumberPicker:k,InputNumber:k,Switch:H,CheckboxGroup:G.Group,RadioGroup:B.Group,Slider:w,Rate:w,Upload:U,FormLayout:O,FormGrid:L,Field:g}});function le(){const r=v(),[a]=T(),s=a.get("templateId"),[c,i]=p.useState(!1),[o,t]=p.useState(!1),[n,I]=p.useState(null),b=p.useMemo(()=>D({initialValues:{}}),[]);p.useEffect(()=>{if(!s){d("缺少模板ID"),setTimeout(()=>r("/daily-workorders"),1e3);return}const l=Number(s);if(isNaN(l)||l<=0){d("无效的模板ID"),setTimeout(()=>r("/daily-workorders"),1e3);return}(async()=>{try{i(!0);const u=await E.get(l);u.data.code===0?I(u.data.data):(d("加载模板失败"),setTimeout(()=>r("/daily-workorders"),1500))}catch(u){console.error("加载模板失败:",u),d("加载模板失败"),setTimeout(()=>r("/daily-workorders"),1500)}finally{i(!1)}})()},[s,r]);const W=async()=>{if(!n){d("模板未加载");return}try{await b.validate()}catch{d("请填写完整的表单信息");return}try{t(!0);const l=b.values;let y="",u="";try{const P=localStorage.getItem("user");if(P){const x=JSON.parse(P);y=x.id||x.username||"",u=x.fullName||x.name||x.username||""}}catch{}(await A.create({template_id:n.id,type:"daily",title:n.name||"工单",form_data:l,status:"submitted",applicant_id:y,applicant_name:u})).data.code===0?(_("工单提交成功"),setTimeout(()=>r("/my-tickets"),500)):d("提交失败")}catch(l){const y=l;console.error("提交工单失败:",l),d(y?.response?.data?.message||"提交失败")}finally{t(!1)}};return c&&!n?e.jsx(m,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"},children:e.jsx(V,{})}):n?!n.schema||Object.keys(n.schema).length===0?e.jsxs(m,{sx:{p:3},children:[e.jsx(f,{severity:"warning",children:"该模板没有配置表单内容"}),e.jsx(j,{startIcon:e.jsx(S,{}),onClick:()=>r("/daily-workorders"),sx:{mt:2},children:"返回"})]}):e.jsxs(m,{sx:{p:3,maxWidth:1200,mx:"auto"},children:[e.jsxs(m,{sx:{mb:3,display:"flex",alignItems:"center",gap:2},children:[e.jsx(j,{startIcon:e.jsx(S,{}),onClick:()=>r("/daily-workorders"),children:"返回"}),e.jsx(F,{variant:"h5",fontWeight:600,children:n.name||"填写工单"})]}),n.description&&e.jsx(f,{severity:"info",sx:{mb:3},children:n.description}),e.jsx(C,{sx:{p:3},children:e.jsxs(R,{form:b,children:[e.jsx(q,{fallback:e.jsx(f,{severity:"error",sx:{mt:2},children:"表单渲染出错，请检查 schema 结构。如果问题持续，请联系管理员。"}),children:e.jsx(re,{schema:n.schema})}),e.jsxs(m,{sx:{mt:4,display:"flex",justifyContent:"flex-end",gap:2},children:[e.jsx(j,{variant:"outlined",onClick:()=>r("/daily-workorders"),disabled:o,children:"取消"}),e.jsx(j,{variant:"contained",startIcon:e.jsx(N,{}),onClick:W,disabled:c||o,children:o?"提交中...":"提交工单"})]})]})})]}):e.jsx(m,{sx:{p:3},children:e.jsx(f,{severity:"error",children:"模板不存在"})})}export{le as default};
