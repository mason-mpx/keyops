import{u as ze,r,cd as h,bf as g,j as e,B as b,w as Ee,x as Fe,T as p,a as y,A as Be,P as ae,m as c,s as Me,t as Ne,F as re,n as oe,o as ie,M as u,d as F,I as B,v as Ae,b as U,c as M,V as Le,g as He,C as le,h as Oe,D as w,i as ce,k as de,l as me,p as ue,a7 as I,_ as _e,ce as he,Z as pe}from"./index-OJNN34VQ.js";import{S as xe}from"./Stack-D4jLN6n0.js";import{S as Qe}from"./Skeleton-DzyhEav-.js";import{T as $e,a as Ue,b as Ve,c as fe,d as m,e as Ye}from"./TableRow-Dz3vPXNr.js";import{C as ge}from"./Chip-pSvhxX1X.js";import{T as Ze}from"./TablePagination-CuKuo8TO.js";import{S as Ge}from"./Switch-BGuUO65b.js";import"./LastPage-COOW1SXp.js";function T(t,N){const v=t;return v?.response?.data?.message||v?.message||(typeof t=="string"?t:N)}const be={mysql:{bg:"#f0f9ff",color:"#0369a1"},postgresql:{bg:"#f0fdf4",color:"#166534"},mongodb:{bg:"#fefce8",color:"#854d0e"},redis:{bg:"#fef2f2",color:"#991b1b"}},Je={mysql:e.jsx(pe,{sx:{fontSize:20}}),postgresql:e.jsx(pe,{sx:{fontSize:20}}),mongodb:e.jsx(he,{sx:{fontSize:20}}),redis:e.jsx(he,{sx:{fontSize:20}})};function os(){const{t}=ze(),[N,v]=r.useState(!0),[V,Y]=r.useState([]),[P,je]=r.useState(""),[R,Z]=r.useState(0),[D,ye]=r.useState(10),[Te,G]=r.useState(0),[W,ve]=r.useState(""),[Ce,k]=r.useState(!1),[A,q]=r.useState(!1),[J,Se]=r.useState(null),[K,X]=r.useState(null),[L,ee]=r.useState(!1),[H,C]=r.useState(!1),[O,S]=r.useState(!1),z=r.useRef(null),[n,i]=r.useState({name:"",dbType:"mysql",host:"",port:3306,username:"",password:"",databaseName:"",authDatabase:"",charset:"utf8mb4",connectionString:"",description:"",isEnabled:!0}),[o,x]=r.useState({}),se=r.useRef(R),te=r.useRef(D),_=r.useRef(P),Q=r.useRef(W),E=r.useRef(0);se.current=R,te.current=D,_.current=P,Q.current=W;const j=r.useCallback(async()=>{const s=E.current+=1;v(!0);try{const a={page:se.current+1,page_size:te.current};_.current&&(a.name=_.current),Q.current&&(a.db_type=Q.current);const l=await h.listInstances(a);if(s!==E.current)return;l&&l.list?(Y(l.list||[]),G(l.total||0)):l&&l.code===200&&(Y(l.data?.list||[]),G(l.data?.total||0))}catch(a){if(s!==E.current)return;console.error("[Instances] Error loading instances:",a),g(T(a,t("dms.instances.loadFailed")))}finally{s===E.current&&v(!1)}},[]);r.useEffect(()=>{j()},[j,R,D,P,W]);const we=()=>!(!n.name.trim()||!n.host.trim()||!n.port||n.port<1||n.port>65535||n.dbType!=="redis"&&n.dbType!=="mongodb"&&!n.password),$=()=>{const s={};return n.name.trim()||(s.name=t("dms.instances.nameRequired")),n.host.trim()||(s.host=t("dms.instances.hostRequired")),(!n.port||n.port<1||n.port>65535)&&(s.port=t("dms.instances.portInvalid")),n.dbType!=="redis"&&n.dbType!=="mongodb"&&!n.password&&(s.password=t("dms.instances.passwordRequired")),x(s),Object.keys(s).length===0},Ie=async()=>{if($()){ee(!0),C(!1),S(!1);try{await h.testConnectionWithBody(n),C(!0),S(!0),I(t("dms.instances.testSuccess"))}catch(s){C(!0),S(!1),g(t("dms.instances.testFailed")+": "+T(s,t("common.unknown")))}finally{ee(!1)}}},Pe=async()=>{if($()){if(!H||!O){g(t("dms.instances.testBeforeSave"));return}try{await h.createInstance(n),I(t("dms.instances.createSuccess")),k(!1),f(),j()}catch(s){g(T(s,t("dms.instances.createFailed")))}}},Re=s=>{Se(s),i({name:s.name,dbType:s.dbType,host:s.host,port:s.port,username:s.username,password:"",databaseName:s.databaseName||"",authDatabase:"",charset:"utf8mb4",connectionString:"",description:s.description||"",isEnabled:s.isEnabled}),x({}),q(!0)},De=async()=>{if(!(!J||!$()))try{await h.updateInstance(J.id,n),I(t("dms.instances.updateSuccess")),q(!1),f(),j()}catch(s){g(T(s,t("dms.instances.updateFailed")))}},We=async s=>{if(confirm(t("dms.instances.deleteConfirm")))try{await h.deleteInstance(s),I(t("dms.instances.deleteSuccess")),j()}catch(a){g(T(a,t("dms.instances.deleteFailed")))}},ke=async s=>{X(s);try{await h.testConnection(s),I(t("dms.instances.testSuccess"))}catch(a){g(t("dms.instances.testFailed")+": "+T(a,t("common.unknown")))}finally{X(null)}},f=async()=>{const s=z.current;if(s){try{await h.deleteInstance(s)}catch(a){console.warn("删除临时实例失败:",a)}z.current=null}i({name:"",dbType:"mysql",host:"",port:3306,username:"",password:"",databaseName:"",authDatabase:"",charset:"utf8mb4",connectionString:"",description:"",isEnabled:!0}),x({}),C(!1),S(!1)},qe=s=>({mysql:3306,postgresql:5432,mongodb:27017,redis:6379})[s]||3306,d=r.useCallback(()=>{C(s=>{if(s){const a=z.current;return S(!1),a&&(z.current=null,h.deleteInstance(a).catch(l=>{console.warn("删除临时实例失败:",l)})),!1}return s})},[]),ne=()=>e.jsxs(b,{display:"flex",flexDirection:"column",gap:2,pt:1,children:[e.jsx(c,{label:t("dms.instances.instanceName"),value:n.name,onChange:s=>{i({...n,name:s.target.value}),o.name&&x({...o,name:""}),d()},required:!0,fullWidth:!0,error:!!o.name,helperText:o.name}),e.jsxs(re,{fullWidth:!0,required:!0,children:[e.jsx(oe,{children:t("dms.instances.dbType")}),e.jsxs(ie,{value:n.dbType,label:t("dms.instances.dbType"),onChange:s=>{const a=s.target.value;i({...n,dbType:a,port:qe(a)}),d()},children:[e.jsx(u,{value:"mysql",children:"MySQL"}),e.jsx(u,{value:"postgresql",children:"PostgreSQL"}),e.jsx(u,{value:"mongodb",children:"MongoDB"}),e.jsx(u,{value:"redis",children:"Redis"})]})]}),e.jsx(c,{label:t("dms.instances.host"),value:n.host,onChange:s=>{i({...n,host:s.target.value}),o.host&&x({...o,host:""}),d()},required:!0,fullWidth:!0,error:!!o.host,helperText:o.host,placeholder:n.dbType==="redis"?t("dms.instances.redisHostPlaceholder"):t("dms.instances.hostPlaceholder")}),e.jsx(U,{severity:"info",sx:{mt:-1,mb:1,fontSize:"0.75rem"},children:t("dms.instances.dockerHostHint")}),e.jsx(c,{label:t("dms.instances.port"),type:"number",value:n.port,onChange:s=>{i({...n,port:parseInt(s.target.value)||3306}),o.port&&x({...o,port:""}),d()},required:!0,fullWidth:!0,error:!!o.port,helperText:o.port}),e.jsx(c,{label:t("dms.instances.username"),value:n.username,onChange:s=>{i({...n,username:s.target.value}),d()},fullWidth:!0,placeholder:n.dbType==="redis"?t("dms.instances.redisUsernamePlaceholder"):t("dms.instances.usernamePlaceholder")}),n.dbType==="redis"&&e.jsx(U,{severity:"info",sx:{mt:-1,mb:1,fontSize:"0.75rem"},children:t("dms.instances.redisVersionHint")}),e.jsx(c,{label:t("dms.instances.password"),type:"password",value:n.password,onChange:s=>{i({...n,password:s.target.value}),o.password&&x({...o,password:""}),d()},required:n.dbType!=="redis"&&n.dbType!=="mongodb",fullWidth:!0,error:!!o.password,helperText:o.password||(A?t("dms.instances.passwordPlaceholder"):(n.dbType==="redis"||n.dbType==="mongodb")&&!A?n.dbType==="redis"?t("dms.instances.redisPasswordHint"):t("dms.instances.mongodbPasswordHint")||"MongoDB 可以没有密码":"")}),(n.dbType==="mysql"||n.dbType==="postgresql")&&e.jsx(c,{label:t("dms.instances.databaseName"),value:n.databaseName,onChange:s=>{i({...n,databaseName:s.target.value}),d()},fullWidth:!0,placeholder:t("dms.instances.defaultDatabase")}),n.dbType==="mysql"&&e.jsx(c,{label:t("dms.instances.charset"),value:n.charset,onChange:s=>{i({...n,charset:s.target.value}),d()},fullWidth:!0,placeholder:"默认: utf8mb4"}),n.dbType==="mongodb"&&e.jsxs(e.Fragment,{children:[e.jsx(c,{label:t("dms.instances.authDatabase"),value:n.authDatabase,onChange:s=>{i({...n,authDatabase:s.target.value}),d()},fullWidth:!0,placeholder:"默认: admin"}),e.jsx(c,{label:t("dms.instances.connectionString"),value:n.connectionString,onChange:s=>{i({...n,connectionString:s.target.value}),d()},fullWidth:!0,placeholder:"可选，MongoDB连接字符串"})]}),e.jsx(c,{label:t("dms.instances.description"),multiline:!0,rows:3,value:n.description,onChange:s=>{i({...n,description:s.target.value})},fullWidth:!0,placeholder:t("dms.instances.descriptionPlaceholder")}),e.jsx(_e,{control:e.jsx(Ge,{checked:n.isEnabled,onChange:s=>{i({...n,isEnabled:s.target.checked})}}),label:t("dms.instances.isEnabled")})]});return e.jsxs(b,{sx:{p:3},children:[e.jsx(Ee,{elevation:2,sx:{borderRadius:2},children:e.jsxs(Fe,{children:[e.jsxs(b,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(b,{children:[e.jsx(p,{variant:"h5",fontWeight:600,gutterBottom:!0,children:t("dms.instances.title")}),e.jsx(p,{variant:"body2",color:"text.secondary",children:t("dms.instances.subtitle")})]}),e.jsx(y,{variant:"contained",startIcon:e.jsx(Be,{}),onClick:()=>{f(),k(!0)},sx:{borderRadius:2},children:t("dms.instances.addInstance")})]}),e.jsx(ae,{elevation:0,sx:{p:2,mb:3,bgcolor:"background.default",borderRadius:2},children:e.jsxs(xe,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(c,{placeholder:t("common.search")+"...",value:P,onChange:s=>je(s.target.value),InputProps:{startAdornment:e.jsx(Me,{position:"start",children:e.jsx(Ne,{color:"action"})})},sx:{flex:1,maxWidth:400},size:"small"}),e.jsxs(re,{sx:{minWidth:150},size:"small",children:[e.jsx(oe,{children:t("dms.instances.dbType")}),e.jsxs(ie,{value:W,label:t("dms.instances.dbType"),onChange:s=>ve(s.target.value),children:[e.jsx(u,{value:"",children:t("common.all")}),e.jsx(u,{value:"mysql",children:"MySQL"}),e.jsx(u,{value:"postgresql",children:"PostgreSQL"}),e.jsx(u,{value:"mongodb",children:"MongoDB"}),e.jsx(u,{value:"redis",children:"Redis"})]})]}),e.jsx(F,{title:t("common.refresh"),children:e.jsx(B,{onClick:j,size:"small",children:e.jsx(Ae,{})})})]})}),N?e.jsx(b,{children:[...Array(5)].map((s,a)=>e.jsx(Qe,{variant:"rectangular",height:60,sx:{mb:1,borderRadius:1}},a))}):V.length===0?e.jsx(U,{severity:"info",sx:{borderRadius:2},children:t("dms.instances.noInstances")}):e.jsxs($e,{component:ae,elevation:0,sx:{borderRadius:2},children:[e.jsxs(Ue,{children:[e.jsx(Ve,{children:e.jsxs(fe,{sx:{bgcolor:"background.default"},children:[e.jsx(m,{sx:{fontWeight:600},children:t("dms.instances.columns.name")}),e.jsx(m,{sx:{fontWeight:600},children:t("dms.instances.columns.type")}),e.jsx(m,{sx:{fontWeight:600},children:t("dms.instances.columns.connection")}),e.jsx(m,{sx:{fontWeight:600},children:t("dms.instances.columns.status")}),e.jsx(m,{sx:{fontWeight:600},align:"right",children:t("dms.instances.columns.actions")})]})}),e.jsx(Ye,{children:V.map(s=>e.jsxs(fe,{hover:!0,sx:{"&:hover":{bgcolor:"action.hover"},transition:"background-color 0.2s"},children:[e.jsxs(m,{children:[e.jsx(p,{variant:"body2",fontWeight:500,children:s.name}),s.description&&e.jsx(p,{variant:"caption",color:"text.secondary",display:"block",children:s.description})]}),e.jsx(m,{children:e.jsx(ge,{icon:Je[s.dbType]||void 0,label:s.dbType.toUpperCase(),size:"small",sx:{bgcolor:be[s.dbType]?.bg||"grey.100",color:be[s.dbType]?.color||"grey.700",fontWeight:500}})}),e.jsxs(m,{children:[e.jsxs(p,{variant:"body2",fontFamily:"monospace",children:[s.host,":",s.port]}),s.username&&e.jsxs(p,{variant:"caption",color:"text.secondary",display:"block",children:[t("dms.instances.username"),": ",s.username]}),s.databaseName&&e.jsxs(p,{variant:"caption",color:"text.secondary",display:"block",children:[t("dms.instances.databaseName"),": ",s.databaseName]})]}),e.jsx(m,{children:e.jsx(ge,{icon:s.isEnabled?e.jsx(M,{}):e.jsx(Le,{}),label:s.isEnabled?t("dms.instances.status.enabled"):t("dms.instances.status.disabled"),color:s.isEnabled?"success":"default",size:"small",variant:"outlined"})}),e.jsx(m,{align:"right",children:e.jsxs(xe,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(F,{title:t("common.edit"),children:e.jsx(B,{size:"small",onClick:()=>Re(s),color:"primary",children:e.jsx(He,{fontSize:"small"})})}),e.jsx(F,{title:t("dms.instances.testConnection"),children:e.jsx(B,{size:"small",onClick:()=>ke(s.id),disabled:K===s.id,color:"info",children:K===s.id?e.jsx(le,{size:16}):e.jsx(M,{fontSize:"small"})})}),e.jsx(F,{title:t("common.delete"),children:e.jsx(B,{size:"small",onClick:()=>We(s.id),color:"error",children:e.jsx(Oe,{fontSize:"small"})})})]})})]},s.id))})]}),e.jsx(w,{}),e.jsx(Ze,{component:"div",count:Te,page:R,onPageChange:(s,a)=>Z(a),rowsPerPage:D,onRowsPerPageChange:s=>{ye(parseInt(s.target.value,10)),Z(0)},rowsPerPageOptions:[10,25,50,100],labelRowsPerPage:t("common.rowsPerPage")+":",labelDisplayedRows:({from:s,to:a,count:l})=>`${s}-${a} ${t("common.of")} ${l}`,sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]})]})}),e.jsxs(ce,{open:Ce,onClose:()=>{k(!1),f()},maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[e.jsx(de,{sx:{pb:1,fontWeight:600},children:t("dms.instances.addInstance")}),e.jsx(w,{}),e.jsx(me,{sx:{pt:3},children:ne()}),e.jsx(w,{}),e.jsxs(ue,{sx:{p:2,justifyContent:"space-between"},children:[e.jsx(y,{onClick:Ie,disabled:L||!we(),variant:"outlined",startIcon:L?e.jsx(le,{size:16}):e.jsx(M,{}),sx:{borderRadius:1},children:t(L?"dms.instances.testing":"dms.instances.testConnection")}),H&&O&&e.jsxs(b,{sx:{display:"flex",alignItems:"center",gap:1,color:"success.main"},children:[e.jsx(M,{fontSize:"small"}),e.jsx(p,{variant:"body2",children:t("dms.instances.testSuccess")})]}),e.jsxs(b,{children:[e.jsx(y,{onClick:()=>{k(!1),f()},children:t("common.cancel")}),e.jsx(y,{onClick:Pe,variant:"contained",disabled:!H||!O,sx:{borderRadius:1,ml:1},children:t("common.confirm")})]})]})]}),e.jsxs(ce,{open:A,onClose:()=>{q(!1),f()},maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[e.jsx(de,{sx:{pb:1,fontWeight:600},children:t("dms.instances.editInstance")}),e.jsx(w,{}),e.jsx(me,{sx:{pt:3},children:ne()}),e.jsx(w,{}),e.jsxs(ue,{sx:{p:2},children:[e.jsx(y,{onClick:()=>{q(!1),f()},children:t("common.cancel")}),e.jsx(y,{onClick:De,variant:"contained",sx:{borderRadius:1},children:t("common.save")})]})]})]})}export{os as default};
