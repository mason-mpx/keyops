import{u as U,r as l,c3 as V,j as e,B as u,w as X,x as Y,T as c,a as p,v as Z,A as ee,F as T,n as w,o as D,M as o,P as te,d as $,I as F,g as ne,h as ae,i as se,k as ie,l as le,m as d,b as re,p as ce,bf as oe,a7 as N}from"./index-Cih9_E47.js";import{a as j}from"./alertApi-31gYUd4n.js";import{S as g}from"./Stack-BT7SRYf3.js";import{T as de,a as me,b as he,c as f,d as i,e as xe}from"./TableRow-Bl_73t-R.js";import{C as O}from"./Chip-D6-9bdkU.js";import{P as ue}from"./Pagination-B3Cgsyn8.js";import"./LastPage-BDzvmy5H.js";function ve(){const{t:n}=U(),[k,W]=l.useState([]),[y,A]=l.useState([]),[I,J]=l.useState(!1),[B,z]=l.useState(!1),[_,S]=l.useState(null),[v,R]=l.useState(1),[C]=l.useState(10),[E,L]=l.useState(0),[m,q]=l.useState(""),[s,r]=l.useState({department_id:void 0,silence_name:"",silence_desc:"",silence_type:"once",silence_time:{range_time:[],weeks:[],times:[]},filters:[]}),M=l.useCallback(async()=>{try{const t=await V.getOrganizations({unitType:"Department"});A(t||[])}catch(t){console.error("加载部门列表失败:",t)}},[]),h=l.useCallback(async()=>{try{J(!0);const t={page:v,page_size:C};m&&(t.department_id=m);const a=await j.getSilences(t);(a.data.code===0||a.data.code===200)&&(W(a.data.data||[]),L(a.data.total||0))}catch(t){console.error("获取告警静默失败:",t),W([])}finally{J(!1)}},[v,C,m]);l.useEffect(()=>{h(),M()},[h,M]);const P=t=>{t?(S(t),r({department_id:t.department_id,silence_name:t.silence_name,silence_desc:t.silence_desc||"",silence_type:t.silence_type,silence_time:t.silence_time||{range_time:[],weeks:[],times:[]},filters:t.filters||[]})):(S(null),r({department_id:m||void 0,silence_name:"",silence_desc:"",silence_type:"once",silence_time:{range_time:[],weeks:[],times:[]},filters:[]})),z(!0)},b=()=>{z(!1),S(null)},G=async()=>{if(!s.silence_name){oe("请填写必填字段");return}try{_?(await j.updateSilence(_.id,s),N("更新成功")):(await j.createSilence(s),N("创建成功")),b(),h()}catch(t){console.error("保存失败:",t)}},H=async t=>{if(confirm("确定要删除这条告警静默吗？"))try{await j.deleteSilence(t),N("删除成功"),h()}catch(a){console.error("删除失败:",a)}},K=t=>!t||t.length===0?e.jsx(c,{variant:"body2",color:"text.secondary",children:"无"}):e.jsx(g,{direction:"row",spacing:1,flexWrap:"wrap",children:t.map((a,x)=>e.jsx(O,{label:`${a.tag} ${a.operation} [${a.value.join(", ")}]`,size:"small",variant:"outlined"},x))}),Q=t=>{if(t.silence_type==="once"){const a=t.silence_time?.range_time||[];return a.length>=2?`${a[0]} ~ ${a[1]}`:"-"}else{const a=t.silence_time?.weeks||[],x=t.silence_time?.times||[];return`周期: ${a.join(",")} | 时间: ${x.join(", ")}`}};return e.jsxs(u,{sx:{p:3},children:[e.jsx(X,{children:e.jsxs(Y,{children:[e.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(c,{variant:"h5",gutterBottom:!0,children:n("menu.monitorSilenceRule")||"告警静默管理"}),e.jsxs(g,{direction:"row",spacing:2,children:[e.jsx(p,{variant:"outlined",startIcon:e.jsx(Z,{}),onClick:h,disabled:I,children:n("common.refresh")}),e.jsx(p,{variant:"contained",startIcon:e.jsx(ee,{}),onClick:()=>P(),children:n("Create Silence")})]})]}),e.jsx(u,{sx:{mb:2},children:e.jsxs(T,{size:"small",sx:{minWidth:200},children:[e.jsx(w,{children:n("Department")||"部门"}),e.jsxs(D,{value:m,label:n("Department")||"部门",onChange:t=>q(t.target.value),children:[e.jsx(o,{value:"",children:n("common.all")}),y.map(t=>e.jsx(o,{value:t.id,children:t.unitName},t.id))]})]})}),e.jsx(de,{component:te,children:e.jsxs(me,{children:[e.jsx(he,{children:e.jsxs(f,{children:[e.jsx(i,{children:n("Silence Name")}),e.jsx(i,{children:n("Department")||"部门"}),e.jsx(i,{children:n("Type")}),e.jsx(i,{children:n("Silence Time")}),e.jsx(i,{children:n("Match Conditions")}),e.jsx(i,{align:"right",children:n("common.actions")})]})}),e.jsx(xe,{children:I?e.jsx(f,{children:e.jsx(i,{colSpan:6,align:"center",children:n("common.loading")})}):k.length===0?e.jsx(f,{children:e.jsx(i,{colSpan:6,align:"center",children:n("common.noData")})}):k.map(t=>e.jsxs(f,{children:[e.jsxs(i,{children:[e.jsx(c,{variant:"body2",fontWeight:"medium",children:t.silence_name}),t.silence_desc&&e.jsx(c,{variant:"caption",color:"text.secondary",children:t.silence_desc})]}),e.jsx(i,{children:t.department_id?(()=>{const a=y.find(x=>x.id===t.department_id);return a?e.jsx(O,{label:a.unitName,size:"small"}):e.jsx(c,{variant:"body2",color:"text.secondary",children:t.department_id})})():e.jsx(c,{variant:"body2",color:"text.secondary",children:n("Global")||"全局"})}),e.jsx(i,{children:e.jsx(O,{label:t.silence_type==="once"?n("Once"):n("Period"),size:"small",color:t.silence_type==="once"?"primary":"secondary"})}),e.jsx(i,{children:e.jsx(c,{variant:"body2",sx:{maxWidth:300},children:Q(t)})}),e.jsx(i,{sx:{maxWidth:400},children:K(t.filters)}),e.jsx(i,{align:"right",children:e.jsxs(g,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx($,{title:"编辑",children:e.jsx(F,{size:"small",onClick:()=>P(t),children:e.jsx(ne,{fontSize:"small"})})}),e.jsx($,{title:"删除",children:e.jsx(F,{size:"small",color:"error",onClick:()=>H(t.id),children:e.jsx(ae,{fontSize:"small"})})})]})})]},t.id))})]})}),E>0&&e.jsx(u,{sx:{display:"flex",justifyContent:"center",mt:2},children:e.jsx(ue,{count:Math.ceil(E/C),page:v,onChange:(t,a)=>R(a),color:"primary"})})]})}),e.jsxs(se,{open:B,onClose:b,maxWidth:"md",fullWidth:!0,children:[e.jsx(ie,{children:_?n("Edit Silence")||"编辑告警静默":n("Create Silence")||"新建告警静默"}),e.jsx(le,{children:e.jsxs(g,{spacing:3,sx:{mt:1},children:[e.jsx(d,{label:`${n("Silence Name")} *`,value:s.silence_name,onChange:t=>r({...s,silence_name:t.target.value}),fullWidth:!0,required:!0}),e.jsxs(T,{fullWidth:!0,children:[e.jsx(w,{children:n("Department")||"部门"}),e.jsxs(D,{value:s.department_id||"",label:n("Department")||"部门",onChange:t=>r({...s,department_id:t.target.value===""?void 0:t.target.value}),children:[e.jsx(o,{value:"",children:n("Leave empty for global silence")||"留空表示全局静默"}),y.map(t=>e.jsx(o,{value:t.id,children:t.unitName},t.id))]})]}),e.jsx(d,{label:n("common.description"),value:s.silence_desc,onChange:t=>r({...s,silence_desc:t.target.value}),fullWidth:!0,multiline:!0,rows:2}),e.jsxs(T,{fullWidth:!0,children:[e.jsxs(w,{children:[n("Silence Type")," *"]}),e.jsxs(D,{value:s.silence_type,label:`${n("Silence Type")} *`,onChange:t=>r({...s,silence_type:t.target.value}),children:[e.jsx(o,{value:"once",children:n("Once")}),e.jsx(o,{value:"period",children:n("Period")})]})]}),s.silence_type==="once"?e.jsx(d,{label:n("Time Range (JSON array)"),value:JSON.stringify(s.silence_time?.range_time||[]),onChange:t=>{try{const a=JSON.parse(t.target.value);r({...s,silence_time:{...s.silence_time,range_time:a}})}catch{}},fullWidth:!0,multiline:!0,rows:2,helperText:n('Example: ["2024-01-01 00:00:00", "2024-01-02 00:00:00"]')||'例如: ["2024-01-01 00:00:00", "2024-01-02 00:00:00"]'}):e.jsxs(e.Fragment,{children:[e.jsx(d,{label:n("Weeks (JSON array, 0=Sunday)"),value:JSON.stringify(s.silence_time?.weeks||[]),onChange:t=>{try{const a=JSON.parse(t.target.value);r({...s,silence_time:{...s.silence_time,weeks:a}})}catch{}},fullWidth:!0,helperText:n("Example: [1, 2, 3, 4, 5] means Monday to Friday")||"例如: [1, 2, 3, 4, 5] 表示周一到周五"}),e.jsx(d,{label:n("Time Slots (JSON array)"),value:JSON.stringify(s.silence_time?.times||[]),onChange:t=>{try{const a=JSON.parse(t.target.value);r({...s,silence_time:{...s.silence_time,times:a}})}catch{}},fullWidth:!0,helperText:n('Example: ["09:00-18:00"] means 9 AM to 6 PM')||'例如: ["09:00-18:00"] 表示9点到18点'})]}),e.jsx(d,{label:n("Match Conditions (JSON array)"),value:JSON.stringify(s.filters||[]),onChange:t=>{try{const a=JSON.parse(t.target.value);r({...s,filters:a})}catch{}},fullWidth:!0,multiline:!0,rows:4,helperText:n('Example: [{"tag": "severity", "value": ["warning"], "operation": "IN"}]')||'例如: [{"tag": "severity", "value": ["warning"], "operation": "IN"}]'}),e.jsx(re,{severity:"info",children:n("Silence rules are used to suppress alerts that meet certain conditions within a specified time period to avoid alert storms. Match conditions use JSON format and support tag matching.")||"静默规则用于在指定时间段内屏蔽符合条件的告警，避免告警风暴。匹配条件使用 JSON 格式，支持标签匹配。"})]})}),e.jsxs(ce,{children:[e.jsx(p,{onClick:b,children:"取消"}),e.jsx(p,{onClick:G,variant:"contained",children:"保存"})]})]})]})}export{ve as default};
