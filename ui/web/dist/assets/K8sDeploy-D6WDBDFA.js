import{u as Z,r as d,bf as f,j as e,B as l,T as i,w as b,x as I,bi as G,D as z,m as u,F as M,n as R,o as H,M as m,_ as J,a as Y,f as $,I as N,v as O,C as Q,b as U,P as V,a7 as X}from"./index-CJIrazW8.js";import{d as g}from"./deploymentApi-Dsh02A80.js";import{k as ee}from"./k8sClusterApi-CNrfXk7P.js";import{G as n}from"./GridLegacy-ChU6VyLK.js";import{S as se}from"./Switch-CqW6_ohp.js";import{L as re}from"./LinearProgress-BlyF6pus.js";import{T as te,a as ne,b as ae,c as K,d as x,e as oe}from"./TableRow-JrGpygSA.js";import{f as ie}from"./index-CEYi4unC.js";import{C as le}from"./Chip-Bh8gAKTq.js";import"./typeof-QjJsDpFa.js";function ye(){const{t:L}=Z(),[k,C]=d.useState(!1),[j,A]=d.useState([]),[v,S]=d.useState([]),[D,w]=d.useState(!1),[y,W]=d.useState(0),[T,_]=d.useState(null),[r,o]=d.useState({project_name:"",project_id:"",env_id:"",env_name:"",cluster_id:"",cluster_name:"",namespace:"",deploy_type:"k8s",version:"",k8s_yaml:"",k8s_kind:"Deployment",verify_enabled:!0,verify_timeout:300,description:""}),[a,q]=d.useState({}),B=async()=>{try{const s=await ee.listClusters();A(s)}catch(s){const t=s&&typeof s=="object"&&"response"in s&&s.response&&typeof s.response=="object"&&"data"in s.response&&s.response.data&&typeof s.response.data=="object"&&"message"in s.response.data&&typeof s.response.data.message=="string"?s.response.data.message:"获取集群列表失败";f(t)}},h=d.useCallback(async()=>{if(!r.project_name||!r.env_id){S([]);return}try{w(!0);const s=await g.listDeployments({project_name:r.project_name,env_id:r.env_id,cluster_id:r.cluster_id,deploy_type:"k8s",page:1,page_size:10});S(s.items||[])}catch(s){const t=s&&typeof s=="object"&&"response"in s&&s.response&&typeof s.response=="object"&&"data"in s.response&&s.response.data&&typeof s.response.data=="object"&&"message"in s.response.data&&typeof s.response.data.message=="string"?s.response.data.message:"获取部署历史失败";f(t)}finally{w(!1)}},[r.project_name,r.env_id,r.cluster_id]);d.useEffect(()=>{B()},[]),d.useEffect(()=>{r.cluster_id&&r.project_name&&r.env_id&&h()},[r.cluster_id,r.project_name,r.env_id,h]);const E=()=>{const s={};return r.project_name||(s.project_name="请输入项目名称"),r.env_id||(s.env_id="请选择环境"),r.cluster_id||(s.cluster_id="请选择集群"),r.namespace||(s.namespace="请输入命名空间"),r.version?/^[a-zA-Z0-9.\-_]+$/.test(r.version)||(s.version="版本号必须匹配规则[a-zA-Z0-9.-_]+"):s.version="请输入版本号",r.k8s_yaml||(s.k8s_yaml="请输入 K8s YAML 配置"),r.k8s_kind||(s.k8s_kind="请选择 K8s 资源类型"),q(s),Object.keys(s).length===0},F=async()=>{if(!E())return;if(v.some(t=>t.status==="running"||t.status==="pending")){f("已有相同的发布正在执行中，请等待完成后再试");return}if(window.confirm("确认要执行 K8s 容器发布吗？"))try{C(!0),W(0),_(null);const t=j.find(p=>p.id===r.cluster_id),c=await g.createDeployment({project_name:r.project_name,project_id:r.project_id,env_id:r.env_id,env_name:r.env_name||"",cluster_id:r.cluster_id,cluster_name:t?.name||"",namespace:r.namespace,deploy_type:"k8s",version:r.version,k8s_yaml:r.k8s_yaml,k8s_kind:r.k8s_kind,verify_enabled:r.verify_enabled,verify_timeout:r.verify_timeout,description:r.description});X("部署任务已创建，正在后台执行");try{await g.executeK8sDeployment(c.id)}catch(p){console.error("执行部署失败:",p)}h(),o({project_name:"",project_id:"",env_id:"",env_name:"",cluster_id:"",cluster_name:"",namespace:"",deploy_type:"k8s",version:"",k8s_yaml:"",k8s_kind:"Deployment",verify_enabled:!0,verify_timeout:300,description:""}),_("success"),W(100)}catch(t){const c=t&&typeof t=="object"&&"response"in t&&t.response&&typeof t.response=="object"&&"data"in t.response&&t.response.data&&typeof t.response.data=="object"&&"message"in t.response.data&&typeof t.response.data.message=="string"?t.response.data.message:"创建部署任务失败";f(c),_("error")}finally{C(!1)}},P=s=>{const c={success:{label:"成功",color:"success"},failed:{label:"失败",color:"error"},running:{label:"运行中",color:"info"},pending:{label:"等待中",color:"warning"},cancelled:{label:"已取消",color:"default"}}[s]||{label:s,color:"default"};return e.jsx(le,{label:c.label,color:c.color,size:"small"})};return e.jsxs(l,{sx:{width:"100%",p:3},children:[e.jsx(l,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:e.jsxs(l,{children:[e.jsx(i,{variant:"h4",component:"h1",fontWeight:"700",children:L("menu.k8sDeploy")}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:"通过 Kubernetes 进行容器化应用发布"})]})}),e.jsxs(n,{container:!0,spacing:3,children:[e.jsx(n,{item:!0,xs:12,lg:7,children:e.jsx(b,{elevation:0,sx:{border:"1px solid #e2e8f0",borderRadius:2,transition:"all 0.3s ease","&:hover":{boxShadow:"0 4px 12px rgba(0,0,0,0.08)"}},children:e.jsxs(I,{sx:{p:3},children:[e.jsxs(l,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(l,{sx:{width:48,height:48,borderRadius:2,backgroundColor:"#e6fffa",display:"flex",alignItems:"center",justifyContent:"center",mr:2},children:e.jsx(G,{sx:{fontSize:28,color:"#319795"}})}),e.jsxs(l,{children:[e.jsx(i,{variant:"h6",fontWeight:"600",children:"发布配置"}),e.jsx(i,{variant:"body2",color:"text.secondary",children:"填写 K8s 部署所需的基本信息"})]})]}),e.jsx(z,{sx:{mb:3}}),e.jsx(l,{component:"form",children:e.jsxs(n,{container:!0,spacing:3,children:[e.jsx(n,{item:!0,xs:12,children:e.jsx(u,{fullWidth:!0,label:"项目名称",value:r.project_name,onChange:s=>o({...r,project_name:s.target.value}),error:!!a.project_name,helperText:a.project_name,required:!0,variant:"outlined"})}),e.jsx(n,{item:!0,xs:12,children:e.jsx(u,{fullWidth:!0,label:"项目ID（可选）",value:r.project_id,onChange:s=>o({...r,project_id:s.target.value}),variant:"outlined"})}),e.jsx(n,{item:!0,xs:12,sm:6,children:e.jsx(u,{fullWidth:!0,label:"环境ID",value:r.env_id,onChange:s=>o({...r,env_id:s.target.value}),error:!!a.env_id,helperText:a.env_id,required:!0,variant:"outlined"})}),e.jsx(n,{item:!0,xs:12,sm:6,children:e.jsx(u,{fullWidth:!0,label:"环境名称（可选）",value:r.env_name,onChange:s=>o({...r,env_name:s.target.value}),variant:"outlined"})}),e.jsx(n,{item:!0,xs:12,children:e.jsxs(M,{fullWidth:!0,required:!0,error:!!a.cluster_id,variant:"outlined",children:[e.jsx(R,{children:"集群"}),e.jsx(H,{value:r.cluster_id,onChange:s=>{const t=s.target.value,c=j.find(p=>p.id===t);o({...r,cluster_id:t,cluster_name:c?.name||"",namespace:c?.defaultNamespace||r.namespace})},label:"集群",children:j.map(s=>e.jsx(m,{value:s.id,children:s.name},s.id))}),a.cluster_id&&e.jsx(i,{variant:"caption",color:"error",sx:{mt:.5,ml:1.75},children:a.cluster_id})]})}),e.jsx(n,{item:!0,xs:12,children:e.jsx(u,{fullWidth:!0,label:"命名空间",value:r.namespace,onChange:s=>o({...r,namespace:s.target.value}),error:!!a.namespace,helperText:a.namespace,required:!0,variant:"outlined"})}),e.jsx(n,{item:!0,xs:12,sm:6,children:e.jsx(u,{fullWidth:!0,label:"版本号",value:r.version,onChange:s=>o({...r,version:s.target.value}),error:!!a.version,helperText:a.version||"格式: [a-zA-Z0-9.-_]+",required:!0,variant:"outlined"})}),e.jsx(n,{item:!0,xs:12,sm:6,children:e.jsxs(M,{fullWidth:!0,required:!0,error:!!a.k8s_kind,variant:"outlined",children:[e.jsx(R,{children:"K8s 资源类型"}),e.jsxs(H,{value:r.k8s_kind,onChange:s=>o({...r,k8s_kind:s.target.value}),label:"K8s 资源类型",children:[e.jsx(m,{value:"Deployment",children:"Deployment"}),e.jsx(m,{value:"StatefulSet",children:"StatefulSet"}),e.jsx(m,{value:"DaemonSet",children:"DaemonSet"}),e.jsx(m,{value:"CronJob",children:"CronJob"})]})]})}),e.jsx(n,{item:!0,xs:12,children:e.jsx(u,{fullWidth:!0,label:"K8s YAML 配置",value:r.k8s_yaml,onChange:s=>o({...r,k8s_yaml:s.target.value}),error:!!a.k8s_yaml,helperText:a.k8s_yaml,multiline:!0,rows:12,required:!0,variant:"outlined",sx:{"& .MuiInputBase-input":{fontFamily:"monospace",fontSize:"0.875rem",lineHeight:1.6}}})}),e.jsx(n,{item:!0,xs:12,children:e.jsx(b,{variant:"outlined",sx:{p:2,backgroundColor:"#f7fafc",border:"1px solid #e2e8f0"},children:e.jsx(J,{control:e.jsx(se,{checked:r.verify_enabled,onChange:s=>o({...r,verify_enabled:s.target.checked}),color:"primary"}),label:e.jsxs(l,{children:[e.jsx(i,{variant:"body2",fontWeight:500,children:"启用 kubedog 验证"}),e.jsx(i,{variant:"caption",color:"text.secondary",children:"部署完成后自动验证应用状态"})]})})})}),r.verify_enabled&&e.jsx(n,{item:!0,xs:12,children:e.jsx(u,{fullWidth:!0,type:"number",label:"验证超时时间（秒）",value:r.verify_timeout,onChange:s=>o({...r,verify_timeout:parseInt(s.target.value)||300}),helperText:"默认 300 秒，超过此时间将判定为失败",variant:"outlined"})}),e.jsx(n,{item:!0,xs:12,children:e.jsx(u,{fullWidth:!0,label:"描述（可选）",value:r.description,onChange:s=>o({...r,description:s.target.value}),multiline:!0,rows:3,variant:"outlined"})}),y>0&&e.jsx(n,{item:!0,xs:12,children:e.jsxs(l,{sx:{mt:1},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsx(i,{variant:"body2",color:"text.secondary",children:"发布进度"}),e.jsxs(i,{variant:"body2",fontWeight:600,color:"primary.main",children:[y,"%"]})]}),e.jsx(re,{variant:"determinate",value:y,color:T==="error"?"error":T==="success"?"success":"primary",sx:{height:8,borderRadius:4}})]})}),e.jsx(n,{item:!0,xs:12,children:e.jsx(Y,{variant:"contained",color:"primary",startIcon:e.jsx($,{}),onClick:F,disabled:k,fullWidth:!0,size:"large",sx:{py:1.5,fontSize:"1rem",fontWeight:600,borderRadius:2,textTransform:"none"},children:k?"发布中...":"开始发布"})})]})})]})})}),e.jsx(n,{item:!0,xs:12,lg:5,children:e.jsx(b,{elevation:0,sx:{border:"1px solid #e2e8f0",borderRadius:2,height:"100%",display:"flex",flexDirection:"column"},children:e.jsxs(I,{sx:{p:3,flex:1,display:"flex",flexDirection:"column"},children:[e.jsxs(l,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(i,{variant:"h6",fontWeight:"600",children:"发布历史"}),e.jsx(N,{size:"small",onClick:h,disabled:D,sx:{border:"1px solid #e2e8f0","&:hover":{backgroundColor:"#f7fafc"}},children:e.jsx(O,{fontSize:"small"})})]}),e.jsx(z,{sx:{mb:2}}),D?e.jsx(l,{sx:{display:"flex",justifyContent:"center",alignItems:"center",flex:1},children:e.jsx(Q,{size:32})}):v.length===0?e.jsx(U,{severity:"info",sx:{borderRadius:2},children:"暂无部署历史，完成首次发布后将显示在这里"}):e.jsx(te,{component:V,variant:"outlined",sx:{borderRadius:2,border:"1px solid #e2e8f0",maxHeight:"calc(100vh - 400px)",overflow:"auto"},children:e.jsxs(ne,{size:"small",stickyHeader:!0,children:[e.jsx(ae,{children:e.jsxs(K,{children:[e.jsx(x,{sx:{fontWeight:600,backgroundColor:"#f7fafc"},children:"状态"}),e.jsx(x,{sx:{fontWeight:600,backgroundColor:"#f7fafc"},children:"版本"}),e.jsx(x,{sx:{fontWeight:600,backgroundColor:"#f7fafc"},children:"时间"}),e.jsx(x,{sx:{fontWeight:600,backgroundColor:"#f7fafc"},children:"耗时"})]})}),e.jsx(oe,{children:v.map(s=>e.jsxs(K,{sx:{"&:hover":{backgroundColor:"#f7fafc"},"&:last-child td":{borderBottom:0}},children:[e.jsx(x,{children:P(s.status)}),e.jsx(x,{children:e.jsx(i,{variant:"body2",fontWeight:500,children:s.version||"-"})}),e.jsx(x,{children:e.jsx(i,{variant:"body2",color:"text.secondary",children:s.created_at?ie(new Date(s.created_at),"MM-dd HH:mm"):"-"})}),e.jsx(x,{children:e.jsx(i,{variant:"body2",color:"text.secondary",children:s.duration?`${s.duration}s`:"-"})})]},s.id))})]})})]})})})]})]})}export{ye as default};
