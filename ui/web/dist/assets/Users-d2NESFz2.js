import{u as fe,r as n,H as we,b4 as x,j as e,B as c,T as v,a as g,A as be,b as G,P as ye,m as p,s as Se,t as ve,d as D,I as C,v as De,g as Ce,dd as Ae,aa as Ie,h as We,i as z,k as L,l as N,F as Pe,n as ke,o as Te,M as j,Y as Q,y as Re,aD as Oe,p as H,a7 as w}from"./index-CJIrazW8.js";import{T as Me,a as Fe,b as Ue,c as I,d as l,e as Ee}from"./TableRow-JrGpygSA.js";import{C as b}from"./Chip-Bh8gAKTq.js";import{T as ze}from"./TablePagination-BC9Ek9KZ.js";import"./LastPage-CClrOV-o.js";function Je(){const{t:a}=fe(),[B,Z]=n.useState([]),[ee,se]=n.useState(0),[W,P]=n.useState(0),[k,ae]=n.useState(10),[T,te]=n.useState(""),[re,q]=n.useState(!1),[le,R]=n.useState(!1),[ne,J]=n.useState(!1),[oe,A]=n.useState(!1),[y,K]=n.useState("create"),[h,O]=n.useState({}),[ie,V]=n.useState(""),[M,F]=n.useState(""),[X,d]=n.useState(""),[S,Y]=n.useState([]),[r,u]=n.useState({username:"",password:"",email:"",fullName:"",role:"user",roleIds:[],authMethod:"password",expiresAt:"",autoDisableOnExpiry:!0}),f=JSON.parse(localStorage.getItem("user")||"{}");console.log("当前登录用户:",f),console.log("当前用户角色:",f.role),console.log("用户对象的所有属性:",Object.keys(f)),console.log("localStorage中的用户数据:",localStorage.getItem("user"));const _=n.useCallback(async()=>{try{const s=await we.get("/api/roles"),t=s.data?.data||s.data||[],o=Array.isArray(t)?t:[];Y(o.map(i=>({id:i.id,name:i.name}))),console.log("加载的角色列表:",o)}catch(s){console.error("加载角色列表失败:",s),Y([])}},[]),m=n.useCallback(async()=>{q(!0),d("");try{const s=await x.getUsersWithRoles({page:W+1,pageSize:k,keyword:T||void 0});Z(s.users||[]),se(s.total||0)}catch(s){const t=s;console.error("加载用户列表失败:",s),d(t.response?.data?.message||a("users.loadUsersFailed"))}finally{q(!1)}},[W,k,T,a]);n.useEffect(()=>{_(),m()},[_,m]);const $=()=>{P(0),m()},de=()=>{K("create"),u({username:"",password:"",email:"",fullName:"",role:"user",roleIds:[],authMethod:"password",expiresAt:"",autoDisableOnExpiry:!0}),R(!0)},ce=async s=>{K("edit"),O(s);const t=s.authMethod==="both"?"password":s.authMethod||"password",o=s.roles?.map(i=>i.id)||[];u({username:s.username,password:"",email:s.email||"",fullName:s.fullName||"",role:s.role,roleIds:o,authMethod:t,expiresAt:s.expiresAt?s.expiresAt.substring(0,16):"",autoDisableOnExpiry:s.autoDisableOnExpiry!==void 0?s.autoDisableOnExpiry:!0}),R(!0)},U=()=>{R(!1),O({}),u({username:"",password:"",email:"",fullName:"",role:"user",roleIds:[],authMethod:"password",expiresAt:"",autoDisableOnExpiry:!0}),d("")},ue=async()=>{try{if(y==="create"){const s={...r,expiresAt:r.expiresAt?new Date(r.expiresAt).toISOString():void 0},{roleIds:t,...o}=s,i=await x.createUser(o);r.roleIds.length>0&&i.id&&await x.assignRoles(i.id,r.roleIds),w(a("users.createSuccess"))}else{const s={fullName:r.fullName,email:r.email,expiresAt:r.expiresAt?new Date(r.expiresAt).toISOString():"",autoDisableOnExpiry:r.autoDisableOnExpiry};await x.updateUser(h.id,s),r.role!==h.role&&await x.updateUserRole(h.id,r.role);const t=h.roles?.map(i=>i.id)||[];JSON.stringify([...r.roleIds].sort())!==JSON.stringify([...t].sort())&&await x.assignRoles(h.id,r.roleIds),r.authMethod!==h.authMethod&&await x.updateUserAuthMethod(h.id,r.authMethod),w(a("users.updateSuccess"))}U(),m()}catch(s){const t=s;console.error("操作失败:",s),d(t.response?.data?.message||a("users.operationFailed"))}},xe=async s=>{if(s.id===f.id){d(a("users.cannotDeleteSelf"));return}if(window.confirm(a("users.deleteConfirm",{username:s.username})))try{await x.deleteUser(s.id),w(a("users.deleteSuccess")),m()}catch(t){const o=t;console.error("删除失败:",t),d(o.response?.data?.message||a("users.deleteFailed"))}},he=s=>{O(s),A(!0)},pe=async()=>{if(h.id)try{await x.resetUser2FA(h.id),w(a("users.reset2FASuccess")),A(!1),m()}catch(s){const t=s;console.error("重置2FA失败:",s),d(t.response?.data?.message||a("users.reset2FAFailed"))}},me=async s=>{if(s.id===f.id){d(a("users.cannotDisableSelf"));return}const t=s.status==="active"?"inactive":"active";try{await x.updateUserStatus(s.id,t),w(a(t==="active"?"users.enabledSuccess":"users.disabledSuccess")),m()}catch(o){const i=o;console.error("状态切换失败:",o),d(i.response?.data?.message||"状态切换失败")}},ge=s=>{V(s),F(""),J(!0)},E=()=>{J(!1),V(""),F("")},je=async()=>{if(M.length<6){d(a("users.passwordMinLength"));return}try{await x.resetPassword(ie,M),w(a("users.resetPasswordSuccess")),E()}catch(s){const t=s;console.error("重置密码失败:",s),d(t.response?.data?.message||a("users.resetPasswordFailed"))}};return e.jsxs(c,{children:[e.jsxs(c,{sx:{mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(v,{variant:"h4",sx:{fontWeight:600},children:a("users.title")}),e.jsx(g,{variant:"contained",startIcon:e.jsx(be,{}),onClick:de,sx:{borderRadius:2},children:a("users.createUser")})]}),X&&e.jsx(G,{severity:"error",sx:{mb:2},onClose:()=>d(""),children:X}),e.jsxs(ye,{sx:{p:3,borderRadius:2},children:[e.jsxs(c,{sx:{mb:3,display:"flex",gap:2},children:[e.jsx(p,{size:"small",placeholder:a("users.searchPlaceholder"),value:T,onChange:s=>te(s.target.value),onKeyPress:s=>s.key==="Enter"&&$(),sx:{flex:1},InputProps:{startAdornment:e.jsx(Se,{position:"start",children:e.jsx(ve,{})})}}),e.jsx(g,{variant:"outlined",onClick:$,children:a("common.search")}),e.jsx(D,{title:a("common.refresh"),children:e.jsx(C,{onClick:m,children:e.jsx(De,{})})})]}),e.jsx(Me,{sx:{maxHeight:"calc(100vh - 300px)",overflowX:"auto"},children:e.jsxs(Fe,{stickyHeader:!0,children:[e.jsx(Ue,{children:e.jsxs(I,{children:[e.jsx(l,{sx:{minWidth:150},children:a("users.username")}),e.jsx(l,{sx:{minWidth:150},children:a("users.name")}),e.jsx(l,{sx:{minWidth:200},children:a("users.email")}),e.jsx(l,{sx:{minWidth:250},children:a("users.roles","角色")}),e.jsx(l,{sx:{minWidth:120},children:a("common.status")}),e.jsx(l,{sx:{minWidth:200},children:a("users.expirationTime")}),e.jsx(l,{sx:{minWidth:200},children:a("users.lastLoginTime")}),e.jsx(l,{sx:{minWidth:150},children:a("users.lastLoginIP")}),e.jsx(l,{sx:{minWidth:200},children:a("common.createdAt")}),e.jsx(l,{align:"right",sx:{minWidth:150,position:"sticky",right:0,backgroundColor:"background.paper",zIndex:10,boxShadow:"-2px 0 4px rgba(0,0,0,0.1)"},children:a("common.actions")})]})}),e.jsx(Ee,{children:re?e.jsx(I,{children:e.jsx(l,{colSpan:11,align:"center",children:a("common.loading")})}):B.length===0?e.jsx(I,{children:e.jsx(l,{colSpan:11,align:"center",children:a("common.noData")})}):B.map(s=>e.jsxs(I,{hover:!0,children:[e.jsx(l,{sx:{minWidth:150},children:s.username}),e.jsx(l,{sx:{minWidth:150},children:s.fullName||"-"}),e.jsx(l,{sx:{minWidth:200},children:s.email||"-"}),e.jsx(l,{sx:{minWidth:250},children:e.jsx(c,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.roles&&s.roles.length>0?s.roles.map(t=>e.jsx(b,{label:t.name,size:"small",color:"secondary"},t.id)):e.jsx(v,{variant:"caption",color:"text.secondary",children:a("users.noRoles")})})}),e.jsx(l,{sx:{minWidth:120},children:e.jsx(b,{label:s.status==="active"?a("common.enabled"):a("common.disabled"),color:s.status==="active"?"success":"default",size:"small",onClick:()=>me(s),sx:{cursor:"pointer"}})}),e.jsx(l,{sx:{minWidth:200},children:s.expiresAt?e.jsxs(c,{children:[e.jsx(v,{variant:"body2",children:new Date(s.expiresAt).toLocaleString()}),new Date(s.expiresAt)<new Date&&e.jsx(b,{label:a("users.expired"),color:"error",size:"small",sx:{mt:.5}}),new Date(s.expiresAt)>new Date&&new Date(s.expiresAt).getTime()-new Date().getTime()<10080*60*1e3&&e.jsx(b,{label:a("users.expiringSoon"),color:"warning",size:"small",sx:{mt:.5}})]}):e.jsx(b,{label:a("users.neverExpires"),color:"default",size:"small"})}),e.jsx(l,{sx:{minWidth:200},children:s.lastLoginTime?new Date(s.lastLoginTime).toLocaleString():"-"}),e.jsx(l,{sx:{minWidth:150},children:s.lastLoginIp||"-"}),e.jsx(l,{sx:{minWidth:200},children:new Date(s.createdAt).toLocaleString()}),e.jsx(l,{align:"right",sx:{minWidth:150,position:"sticky",right:0,backgroundColor:"background.paper",zIndex:9,boxShadow:"-2px 0 4px rgba(0,0,0,0.1)"},children:e.jsxs(c,{sx:{display:"flex",flexDirection:"column",gap:.5,alignItems:"flex-end"},children:[e.jsxs(c,{sx:{display:"flex",gap:.5},children:[e.jsx(D,{title:a("common.edit"),children:e.jsx(C,{size:"small",onClick:()=>ce(s),children:e.jsx(Ce,{fontSize:"small"})})}),e.jsx(D,{title:a("users.resetPassword"),children:e.jsx(C,{size:"small",onClick:()=>ge(s.id),children:e.jsx(Ae,{fontSize:"small"})})})]}),e.jsxs(c,{sx:{display:"flex",gap:.5},children:[e.jsx(D,{title:a("users.reset2FA"),children:e.jsx(C,{size:"small",onClick:()=>he(s),color:"warning",children:e.jsx(Ie,{fontSize:"small"})})}),e.jsx(D,{title:a("common.delete"),children:e.jsx("span",{children:e.jsx(C,{size:"small",onClick:()=>xe(s),disabled:s.id===f.id,children:e.jsx(We,{fontSize:"small"})})})})]})]})})]},s.id))})]})}),e.jsx(ze,{component:"div",count:ee,page:W,onPageChange:(s,t)=>P(t),rowsPerPage:k,onRowsPerPageChange:s=>{ae(parseInt(s.target.value,10)),P(0)},labelRowsPerPage:`${a("common.rowsPerPage")}:`,labelDisplayedRows:({from:s,to:t,count:o})=>o!==-1?a("common.displayedRows",{from:s,to:t,count:o}):a("common.displayedRowsMore",{from:s,to:t})})]}),e.jsxs(z,{open:le,onClose:U,maxWidth:"sm",fullWidth:!0,children:[e.jsx(L,{children:a(y==="create"?"users.addUser":"users.editUser")}),e.jsx(N,{children:e.jsxs(c,{sx:{pt:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsx(p,{label:a("users.username"),value:r.username,onChange:s=>u({...r,username:s.target.value}),required:!0,fullWidth:!0,disabled:y==="edit"}),y==="create"&&e.jsx(p,{label:a("users.password"),type:"password",value:r.password,onChange:s=>u({...r,password:s.target.value}),required:!0,fullWidth:!0,helperText:a("users.passwordMinLength")}),e.jsx(p,{label:a("users.name"),value:r.fullName,onChange:s=>u({...r,fullName:s.target.value}),fullWidth:!0}),e.jsx(p,{label:a("users.email"),type:"email",value:r.email,onChange:s=>u({...r,email:s.target.value}),required:!0,fullWidth:!0}),e.jsxs(Pe,{fullWidth:!0,children:[e.jsx(ke,{children:a("users.roles","角色")}),e.jsx(Te,{multiple:!0,value:r.roleIds,onChange:s=>{const t=typeof s.target.value=="string"?s.target.value.split(","):s.target.value;console.log("选择角色变化:",t,"当前角色列表:",S),u({...r,roleIds:t})},input:e.jsx(Oe,{label:a("users.roles","角色")}),renderValue:s=>s.length===0?e.jsx(v,{variant:"body2",color:"text.secondary",children:a("users.noRolesSelected","未选择")}):e.jsx(c,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.map(t=>{const o=S.find(i=>i.id===t);return e.jsx(b,{label:o?.name||t,size:"small"},t)})}),children:S.length===0?e.jsx(j,{disabled:!0,children:e.jsx(Q,{primary:a("users.noRolesAvailable","暂无可用角色，请先在角色管理中创建角色")})}):S.map(s=>e.jsxs(j,{value:s.id,children:[e.jsx(Re,{checked:r.roleIds.indexOf(s.id)>-1}),e.jsx(Q,{primary:s.name})]},s.id))}),S.length===0&&e.jsx(v,{variant:"caption",color:"error",sx:{mt:.5},children:a("users.noRolesHint","提示：请先在「角色管理」页面创建角色")})]}),e.jsxs(p,{label:a("users.authMethod"),select:!0,value:r.authMethod,onChange:s=>u({...r,authMethod:s.target.value}),fullWidth:!0,helperText:a("users.authMethodHelper"),children:[e.jsx(j,{value:"password",children:a("users.authPassword")}),e.jsx(j,{value:"publickey",children:a("users.authPublickey")}),e.jsx(j,{value:"both",children:a("users.bothAuth")})]}),e.jsx(p,{label:a("users.expiresAt"),type:"datetime-local",value:r.expiresAt,onChange:s=>u({...r,expiresAt:s.target.value}),fullWidth:!0,InputLabelProps:{shrink:!0},helperText:a("users.expiresAtHelper")}),e.jsxs(p,{label:a("users.autoDisableOnExpiry"),select:!0,value:r.autoDisableOnExpiry?"true":"false",onChange:s=>u({...r,autoDisableOnExpiry:s.target.value==="true"}),fullWidth:!0,helperText:a("users.autoDisableOnExpiryHelper"),children:[e.jsx(j,{value:"true",children:a("users.yes")}),e.jsx(j,{value:"false",children:a("users.no")})]})]})}),e.jsxs(H,{children:[e.jsx(g,{onClick:U,children:a("common.cancel")}),e.jsx(g,{onClick:ue,variant:"contained",children:a(y==="create"?"common.create":"common.save")})]})]}),e.jsxs(z,{open:ne,onClose:E,maxWidth:"sm",fullWidth:!0,children:[e.jsx(L,{children:a("users.resetPassword")}),e.jsx(N,{children:e.jsx(c,{sx:{pt:2},children:e.jsx(p,{label:a("users.newPassword"),type:"password",value:M,onChange:s=>F(s.target.value),required:!0,fullWidth:!0,helperText:a("users.passwordMinLength")})})}),e.jsxs(H,{children:[e.jsx(g,{onClick:E,children:a("common.cancel")}),e.jsx(g,{onClick:je,variant:"contained",children:a("users.resetPassword")})]})]}),e.jsxs(z,{open:oe,onClose:()=>A(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(L,{children:"重置用户2FA"}),e.jsx(N,{children:e.jsx(c,{sx:{pt:2},children:e.jsxs(G,{severity:"warning",sx:{mb:2},children:["确定要重置用户 ",e.jsx("strong",{children:h.username})," 的2FA设置吗？",e.jsx("br",{}),"此操作将清除用户的2FA密钥和备用码，用户需要重新设置2FA。"]})})}),e.jsxs(H,{children:[e.jsx(g,{onClick:()=>A(!1),children:"取消"}),e.jsx(g,{onClick:pe,color:"error",variant:"contained",children:"确认重置"})]})]})]})}export{Je as default};
