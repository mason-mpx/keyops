import{u as le,r as o,j as a,B as j,w as ie,x as ce,T as k,a as b,v as de,cS as ue,A as he,F as $,n as G,o as J,M as P,m as v,P as me,d as w,I as z,g as xe,h as fe,i as ge,k as pe,l as je,_ as be,b as Se,p as Ce,bf as c,a7 as S,ab as ye,E as ve,c as we}from"./index-STo1oTDL.js";import{a as f}from"./alertApi-ZkZdrWaX.js";import{S as A}from"./Stack-BJqE2zD7.js";import{T as Re,a as _e,b as De,c as R,d as r,e as Ie}from"./TableRow-e9fRaRV7.js";import{C as Ee}from"./Chip-v5QMYL72.js";import{S as K}from"./Switch-Do7Epm1v.js";import{P as Te}from"./Pagination-CJp52pDe.js";import"./LastPage-Bb7RE8XJ.js";function Me(){const{t:s}=le(),[W,L]=o.useState([]),[h,B]=o.useState([]),[_,F]=o.useState(!1),[V,M]=o.useState(!1),[D,I]=o.useState(null),[C,X]=o.useState(1),[E]=o.useState(10),[N,Y]=o.useState(0),[d,O]=o.useState(""),[p,Z]=o.useState(""),[ee,g]=o.useState(!1),[Q,H]=o.useState(!1),[l,u]=o.useState({name:"",group_id:void 0,expr:"",duration:0,source_id:0,enabled:!0,labels:{},annotations:{}});o.useEffect(()=>{h.length>0&&!d&&O(h[0].id)},[h,d]);const T=async(e,t=!1)=>{try{let n=[];if(e===void 0){const x=(await f.getRuleSources({page:1,page_size:1e3})).data;(x.code===0||x.code===200)&&(n=x.data||[],B(n))}t&&n.length>0?u(i=>{const x=n.some(re=>re.id===i.source_id);return!i.source_id||i.source_id===0||!x?{...i,source_id:n[0].id}:i}):n.length===0&&u(i=>({...i,source_id:0}))}catch(n){console.error("获取数据源失败:",n),B([])}},m=o.useCallback(async()=>{try{F(!0);const e={page:C,page_size:E};d&&(e.source_id=d),p&&(e.name=p);const t=await f.getRules(e);(t.data.code===0||t.data.code===200)&&(L(t.data.data||[]),Y(t.data.total||0))}catch(e){console.error("获取告警规则失败:",e),L([])}finally{F(!1)}},[C,E,d,p]);o.useEffect(()=>{T(void 0),m()},[C,d,p,m]);const q=async e=>{e?(I(e),await T(void 0),u({name:e.name,group_id:e.group_id,expr:e.expr,duration:e.duration,source_id:e.source_id,enabled:e.enabled,labels:e.labels||{},annotations:e.annotations||{}})):(I(null),u({name:"",group_id:void 0,expr:"",duration:0,source_id:0,enabled:!0,labels:{},annotations:{}}),await T(void 0,!0)),M(!0)},y=()=>{M(!1),I(null),u({name:"",group_id:void 0,expr:"",duration:0,source_id:0,enabled:!0,labels:{},annotations:{}})},ae=async()=>{if(!l.name||!l.expr||!l.source_id){c(s("Please fill in required fields")||"请填写必填字段");return}try{if(D){const e=await f.updateRule(D.id,l);if(e.data.code===0||e.data.code===200)S(s("Update successful")||"更新成功"),y(),m(),g(!0);else{const t=e.data.message||s("Update failed")||"更新失败";c(t)}}else{const e=await f.createRule(l);if(e.data.code===0||e.data.code===200)S(s("Create successful")||"创建成功"),y(),m(),g(!0);else{const t=e.data.message||s("Create failed")||"创建失败";c(t)}}}catch(e){console.error("保存失败:",e),c(e?.response?.data?.message||e?.message||s("Operation failed")||"操作失败")}},se=async e=>{if(confirm(s("Are you sure you want to delete this alert rule?")||"确定要删除这条告警规则吗？"))try{const n=(await f.deleteRule(e)).data;if(n.code===0||n.code===200)S(s("Delete successful")||"删除成功"),m(),g(!0);else{const i=n.message||s("Delete failed")||"删除失败";c(i)}}catch(t){console.error("删除失败:",t),c(t?.response?.data?.message||t?.message||s("Delete failed")||"删除失败")}},U=async(e,t)=>{try{const i=(await f.toggleRule(e,!t)).data;if(i.code===0||i.code===200)S(t?s("Disable successful")||"禁用成功":s("Enable successful")||"启用成功"),m(),g(!0);else{const x=i.message||s("Operation failed")||"操作失败";c(x)}}catch(n){console.error("操作失败:",n),c(n?.response?.data?.message||n?.message||s("Operation failed")||"操作失败")}},te=async()=>{if(!d){c(s("Please select a data source first")||"请先选择数据源");return}try{H(!0);const e=await f.reloadDatasource(d);e.data.code===0||e.data.code===200?(S(s("Reload successful")||"重新加载成功"),g(!1)):c(e.data.message||s("Reload failed")||"重新加载失败")}catch(e){console.error("重新加载失败:",e),c(e?.response?.data?.message||e?.message||s("Reload failed")||"重新加载失败")}finally{H(!1)}},ne=e=>{switch(e){case"ok":return a.jsx(we,{color:"success",fontSize:"small"});case"error":return a.jsx(ve,{color:"error",fontSize:"small"});default:return a.jsx(ye,{color:"warning",fontSize:"small"})}},oe=e=>{switch(e){case"ok":return s("Normal")||"正常";case"error":return s("Error")||"错误";default:return s("Unknown")||"未知"}};return a.jsxs(j,{sx:{p:3},children:[a.jsx(ie,{children:a.jsxs(ce,{children:[a.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[a.jsx(k,{variant:"h5",gutterBottom:!0,children:s("menu.monitorAlertRule")||"告警规则管理"}),a.jsxs(A,{direction:"row",spacing:2,children:[a.jsx(b,{variant:"outlined",startIcon:a.jsx(de,{}),onClick:m,disabled:_,children:s("common.refresh")||"刷新"}),ee&&d&&a.jsx(b,{variant:"outlined",color:"warning",startIcon:a.jsx(ue,{}),onClick:te,disabled:Q||_,children:Q?s("Reloading...")||"重新加载中...":s("Reload Prometheus")||"重新加载 Prometheus"}),a.jsx(b,{variant:"contained",startIcon:a.jsx(he,{}),onClick:()=>q(),children:s("Create Rule")||"新建规则"})]})]}),a.jsxs(j,{sx:{mb:2,display:"flex",gap:2,flexWrap:"wrap"},children:[a.jsxs($,{size:"small",sx:{minWidth:200},children:[a.jsx(G,{children:s("DataSource")||"数据源"}),a.jsx(J,{value:d||"",label:s("DataSource")||"数据源",onChange:e=>{O(e.target.value?e.target.value:""),g(!1)},children:h.length===0?a.jsx(P,{value:"",disabled:!0,children:s("No data source available")||"暂无数据源"}):h.map(e=>a.jsx(P,{value:e.id,children:e.source_name},e.id))})]}),a.jsx(v,{size:"small",label:s("Rule Name")||"规则名称",value:p,onChange:e=>Z(e.target.value),sx:{minWidth:200}})]}),a.jsx(Re,{component:me,children:a.jsxs(_e,{children:[a.jsx(De,{children:a.jsxs(R,{children:[a.jsx(r,{children:s("common.name")||"名称"}),a.jsx(r,{children:s("PromQL Expression")||"PromQL表达式"}),a.jsx(r,{children:s("Duration (seconds)")||"持续时间"}),a.jsx(r,{children:s("DataSource")||"数据源"}),a.jsx(r,{children:s("Health Status")||"健康状态"}),a.jsx(r,{children:s("common.status")||"状态"}),a.jsx(r,{align:"right",children:s("common.actions")||"操作"})]})}),a.jsx(Ie,{children:_?a.jsx(R,{children:a.jsx(r,{colSpan:7,align:"center",children:s("common.loading")||"加载中..."})}):W.length===0?a.jsx(R,{children:a.jsx(r,{colSpan:7,align:"center",children:s("common.noData")||"暂无数据"})}):W.map(e=>a.jsxs(R,{children:[a.jsx(r,{children:e.name}),a.jsx(r,{children:a.jsx(w,{title:e.expr,children:a.jsx(k,{variant:"body2",sx:{maxWidth:300,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.expr})})}),a.jsxs(r,{children:[e.duration,"s"]}),a.jsx(r,{children:h.find(t=>t.id===e.source_id)?.source_name||"-"}),a.jsx(r,{children:a.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[ne(e.health),a.jsx(k,{variant:"body2",children:oe(e.health)})]})}),a.jsx(r,{children:a.jsx(Ee,{label:e.enabled?s("common.enabled")||"启用":s("common.disabled")||"禁用",color:e.enabled?"success":"default",size:"small"})}),a.jsx(r,{align:"right",children:a.jsxs(A,{direction:"row",spacing:1,justifyContent:"flex-end",children:[a.jsx(w,{title:s("common.edit")||"编辑",children:a.jsx(z,{size:"small",onClick:()=>q(e),children:a.jsx(xe,{fontSize:"small"})})}),a.jsx(w,{title:e.enabled?s("common.disabled")||"禁用":s("common.enabled")||"启用",children:a.jsx(z,{size:"small",onClick:()=>U(e.id,e.enabled),children:a.jsx(K,{checked:e.enabled,size:"small",onChange:()=>U(e.id,e.enabled)})})}),a.jsx(w,{title:s("common.delete")||"删除",children:a.jsx(z,{size:"small",color:"error",onClick:()=>se(e.id),children:a.jsx(fe,{fontSize:"small"})})})]})})]},e.id))})]})}),N>0&&a.jsx(j,{sx:{display:"flex",justifyContent:"center",mt:2},children:a.jsx(Te,{count:Math.ceil(N/E),page:C,onChange:(e,t)=>X(t),color:"primary"})})]})}),a.jsxs(ge,{open:V,onClose:y,maxWidth:"md",fullWidth:!0,children:[a.jsx(pe,{children:D?s("Edit Alert Rule")||"编辑告警规则":s("Create Alert Rule")||"新建告警规则"}),a.jsx(je,{children:a.jsxs(A,{spacing:3,sx:{mt:1},children:[a.jsx(v,{label:`${s("Rule Name")||"规则名称"} *`,value:l.name,onChange:e=>u({...l,name:e.target.value}),fullWidth:!0,required:!0}),a.jsxs($,{fullWidth:!0,required:!0,children:[a.jsxs(G,{children:[s("DataSource")||"数据源"," *"]}),a.jsx(J,{value:l.source_id||"",label:`${s("DataSource")||"数据源"} *`,onChange:e=>{const t=e.target.value;u({...l,source_id:t})},children:h.map(e=>a.jsxs(P,{value:e.id,children:[e.source_name," (",e.source_type,")"]},e.id))})]}),a.jsx(v,{label:`${s("PromQL Expression")||"PromQL表达式"} *`,value:l.expr,onChange:e=>u({...l,expr:e.target.value}),fullWidth:!0,required:!0,multiline:!0,rows:4,placeholder:s("PromQL Expression Example")||"例如: up == 0",helperText:s("Prometheus Query Expression")||"Prometheus查询表达式"}),a.jsx(v,{label:s("Duration (seconds)")||"持续时间（秒）",type:"number",value:l.duration,onChange:e=>u({...l,duration:parseInt(e.target.value)||0}),fullWidth:!0,helperText:s("Alert duration before trigger")||"告警持续多长时间后触发"}),a.jsx(be,{control:a.jsx(K,{checked:l.enabled??!0,onChange:e=>u({...l,enabled:e.target.checked})}),label:s("Enable Rule")||"启用规则"}),a.jsx(Se,{severity:"info",children:s("Labels and annotations can be added after creation through the edit function")||"标签和注解可以在创建后通过编辑功能添加"})]})}),a.jsxs(Ce,{children:[a.jsx(b,{onClick:y,children:s("common.cancel")}),a.jsx(b,{onClick:ae,variant:"contained",children:s("common.save")})]})]})]})}export{Me as default};
