import{u as He,r as n,b4 as M,cd as b,bf as ee,j as s,B as h,w as Pe,x as Se,T as u,a as T,d as A,I as C,v as Ke,A as Ge,m as N,C as se,s as Ve,t as Je,F as ie,n as te,o as ne,M as j,cf as Qe,b as Xe,P as we,ac as Ae,g as Ce,h as Ne,D as _,i as Ye,k as Ze,l as es,p as ss,a7 as $}from"./index-OJNN34VQ.js";import{S as k}from"./Stack-D4jLN6n0.js";import{A as re}from"./Autocomplete-cIcVOBXR.js";import{S as is}from"./Skeleton-DzyhEav-.js";import{T as ts,a as ns,b as rs,c as ke,d as l,e as as}from"./TableRow-Dz3vPXNr.js";import{C as ae}from"./Chip-pSvhxX1X.js";import{T as os}from"./TablePagination-CuKuo8TO.js";import"./LastPage-COOW1SXp.js";function gs(){const{t}=He(),[Ue,oe]=n.useState(!0),[q,We]=n.useState([]),[le,Fe]=n.useState([]),[ze,v]=n.useState(!1),[o,de]=n.useState(null),[r,x]=n.useState({userId:"",instanceId:0,databaseNames:[],permissionType:"read",expiresAt:"",description:""}),[De,P]=n.useState([]),[U,ce]=n.useState(!1),[d,y]=n.useState({}),[H,me]=n.useState("table"),[W,f]=n.useState(""),[ue,F]=n.useState([]),[z,D]=n.useState(!1),[R,B]=n.useState(null),[g,Re]=n.useState(new Map),[K,G]=n.useState(""),[S,pe]=n.useState(0),[E,V]=n.useState(""),[he,J]=n.useState([]),[L,xe]=n.useState(!1),[Be,Q]=n.useState(null),[X,I]=n.useState(0),[Y,Ee]=n.useState(20),[Le,Oe]=n.useState(0),ge=n.useCallback(async e=>{if(e.length===0)return;const i=new Map(g),a=e.filter(c=>!i.has(c));if(a.length!==0)try{((await M.getUsersWithPagination({page:1,pageSize:1e3})).users||[]).forEach(p=>{a.includes(p.id)&&i.set(p.id,p)}),Re(i)}catch(c){console.error("Failed to load users:",c)}},[g]),fe=n.useCallback(async e=>{if(!e||e.trim().length===0){J([]);return}xe(!0);try{const a=(await M.getUsersWithPagination({page:1,pageSize:20,keyword:e.trim()})).users||[];J(a)}catch(i){console.error("搜索用户失败:",i),J([])}finally{xe(!1)}},[]),w=n.useCallback(async()=>{oe(!0);try{const e=await b.listPermissions({user_id:K||void 0,instance_id:S>0?S:void 0,page:X+1,page_size:Y});let i=[],a=0;Array.isArray(e)?(i=e,a=e.length):e?.data&&(Array.isArray(e.data.data)?(i=e.data.data,a=e.data.total||i.length):Array.isArray(e.data)&&(i=e.data,a=i.length)),We(i),Oe(a);const c=[];i.forEach(p=>{p.userId&&c.push(p.userId),p.grantedBy&&c.push(p.grantedBy)});const m=Array.from(new Set(c));m.length>0&&await ge(m)}catch(e){ee(e.message||t("dms.permissions.loadFailed"))}finally{oe(!1)}},[t,ge,K,S,X,Y]),be=n.useCallback(async()=>{try{const e=await b.listInstances({page:1,page_size:1e3}),i=e?.list||e?.data?.list||[];Fe(i)}catch(e){console.error("Failed to load instances:",e)}},[]),je=n.useCallback(async e=>{if(!e){P([]);return}ce(!0);try{const i=await b.getDatabases(e),a=Array.isArray(i)?i:Array.isArray(i?.data)?i.data:[];P(a)}catch(i){console.error("Failed to load databases:",i),P([])}finally{ce(!1)}},[]);n.useEffect(()=>{be()},[be]),n.useEffect(()=>{w()},[w]);const Me=()=>{const e={};return r.userId.trim()||(e.userId=t("dms.permissions.userIdRequired")),r.instanceId||(e.instanceId=t("dms.permissions.instanceRequired")),y(e),Object.keys(e).length===0},_e=async()=>{if(Me())try{if(o)o.permissionType!==r.permissionType?(await b.updatePermissionResource({userId:o.userId,oldInstanceId:o.instanceId,oldDatabaseName:o.databaseName||"",oldTableName:"",oldPermissionType:o.permissionType,newInstanceId:o.instanceId,newDatabaseName:o.databaseName||"",newTableName:"",newPermissionType:r.permissionType,expiresAt:r.expiresAt||void 0,description:r.description||void 0}),$(t("dms.permissions.updateSuccess"))):(await b.updatePermission({userId:r.userId,instanceId:o.instanceId,databaseName:o.databaseName||void 0,tableName:void 0,permissionType:r.permissionType,expiresAt:r.expiresAt||void 0,description:r.description||void 0}),$(t("dms.permissions.updateSuccess")));else{const e=[];r.databaseNames.length>0?r.databaseNames.forEach(c=>{e.push({databaseName:c})}):e.push({});const a=(await b.batchGrantPermissions({userId:r.userId,instanceId:r.instanceId,permissionType:r.permissionType,expiresAt:r.expiresAt||void 0,description:r.description||void 0,permissions:e}))?.data?.count||e.length;$(t("dms.permissions.batchGrantSuccess",{count:a}))}v(!1),O(),w()}catch(e){ee(e.message||t(o?"dms.permissions.updateFailed":"dms.permissions.grantFailed"))}},ye=e=>{const i=g.get(e.userId);B(i||null),f(i?.username||i?.fullName||e.userId),x({userId:e.userId,instanceId:e.instanceId,databaseNames:e.databaseName?[e.databaseName]:[],permissionType:e.permissionType,expiresAt:e.expiresAt?new Date(e.expiresAt).toISOString().slice(0,16):"",description:e.description||""}),de(e),y({}),v(!0),e.instanceId&&je(e.instanceId)},Ie=async e=>{if(confirm(t("dms.permissions.revokeConfirm")))try{await b.revokePermission({userId:e.userId,instanceId:e.instanceId,databaseName:e.databaseName||"",tableName:e.tableName||"",permissionType:e.permissionType}),$(t("dms.permissions.revokeSuccess")),w()}catch(i){ee(i.message||t("dms.permissions.revokeFailed"))}},Z=n.useCallback(async()=>{D(!0);try{const i=(await M.getUsersWithPagination({page:1,pageSize:10})).users||[];F(i)}catch(e){console.error("Failed to load users:",e),F([])}finally{D(!1)}},[]),Te=n.useCallback(async e=>{if(!e||e.trim().length===0){await Z();return}D(!0);try{const a=(await M.getUsersWithPagination({page:1,pageSize:10,keyword:e.trim()})).users||[];F(a)}catch(i){console.error("搜索用户失败:",i),F([])}finally{D(!1)}},[Z]);n.useEffect(()=>{const e=setTimeout(()=>{Te(W)},300);return()=>clearTimeout(e)},[W,Te]);const O=()=>{x({userId:"",instanceId:0,databaseNames:[],permissionType:"read",expiresAt:"",description:""}),y({}),B(null),f(""),de(null),P([])},ve=e=>{let i=e.instanceName;return e.databaseName&&(i+=` > ${e.databaseName}`,e.tableName&&(i+=` > ${e.tableName}`)),i},$e=()=>{const e={};return q.forEach(i=>{e[i.userId]||(e[i.userId]=[]),e[i.userId].push(i)}),e},qe=()=>{const e=$e();return s.jsx(h,{children:Object.keys(e).map(i=>{const a=g.get(i),c=a?.username||a?.fullName||i;return s.jsx(Pe,{elevation:0,sx:{mb:2,borderRadius:2,border:"1px solid",borderColor:"divider"},children:s.jsxs(Se,{children:[s.jsxs(h,{display:"flex",alignItems:"center",mb:2,children:[s.jsx(Ae,{sx:{mr:1,color:"primary.main"}}),s.jsx(u,{variant:"h6",fontWeight:600,children:c})]}),s.jsx(_,{sx:{mb:2}}),s.jsx(k,{spacing:1,children:e[i].map((m,p)=>s.jsxs(we,{elevation:0,sx:{p:2,bgcolor:"background.default",borderRadius:1,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsxs(h,{children:[s.jsx(u,{variant:"body2",fontWeight:500,gutterBottom:!0,children:ve(m)}),s.jsxs(k,{direction:"row",spacing:1,alignItems:"center",children:[s.jsx(ae,{label:t(`dms.permissions.types.${m.permissionType}`),color:m.permissionType==="read"?"info":m.permissionType==="write"?"warning":"error",size:"small"}),m.expiresAt&&s.jsxs(u,{variant:"caption",color:"text.secondary",children:[t("dms.permissions.expiresAt"),": ",new Date(m.expiresAt).toLocaleString()]})]})]}),s.jsxs(k,{direction:"row",spacing:.5,children:[s.jsx(A,{title:t("dms.permissions.edit"),children:s.jsx(C,{size:"small",color:"primary",onClick:()=>ye(m),children:s.jsx(Ce,{fontSize:"small"})})}),s.jsx(A,{title:t("dms.permissions.revokeConfirm"),children:s.jsx(C,{size:"small",color:"error",onClick:()=>Ie(m),children:s.jsx(Ne,{fontSize:"small"})})})]})]},p))})]})},i)})})};return s.jsxs(h,{sx:{p:3},children:[s.jsx(Pe,{elevation:2,sx:{borderRadius:2},children:s.jsxs(Se,{children:[s.jsxs(h,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[s.jsxs(h,{children:[s.jsx(u,{variant:"h5",fontWeight:600,gutterBottom:!0,children:t("dms.permissions.title")}),s.jsx(u,{variant:"body2",color:"text.secondary",children:t("dms.permissions.subtitle")})]}),s.jsxs(k,{direction:"row",spacing:1,children:[s.jsx(T,{variant:H==="table"?"contained":"outlined",onClick:()=>me("table"),size:"small",children:t("dms.permissions.tableView")}),s.jsx(T,{variant:H==="tree"?"contained":"outlined",onClick:()=>me("tree"),size:"small",children:t("dms.permissions.groupView")}),s.jsx(A,{title:t("common.refresh"),children:s.jsx(C,{onClick:w,children:s.jsx(Ke,{})})}),s.jsx(T,{variant:"contained",startIcon:s.jsx(Ge,{}),onClick:()=>{O(),v(!0)},sx:{borderRadius:1},children:t("dms.permissions.grantPermission")})]})]}),s.jsxs(h,{sx:{mb:2,display:"flex",gap:2,flexWrap:"wrap",alignItems:"center"},children:[s.jsx(re,{sx:{minWidth:250},options:he,getOptionLabel:e=>e?e.username||e.id:"",isOptionEqualToValue:(e,i)=>!e||!i?!1:e.id===i.id,value:Be,onChange:(e,i)=>{Q(i),G(i?.id||""),I(0)},inputValue:E,onInputChange:(e,i,a)=>{a==="input"?(V(i),fe(i)):a==="clear"&&(V(""),Q(null),G(""),I(0))},onOpen:()=>{!L&&he.length===0&&E&&fe(E)},loading:L,noOptionsText:L?t("common.loading")||"加载中...":E?t("No users found")||"未找到用户":t("Enter username to search")||"输入用户名搜索",filterOptions:e=>e,renderInput:e=>s.jsx(N,{...e,label:t("dms.permissions.filterByUser"),placeholder:t("dms.permissions.filterUserPlaceholder"),InputProps:{...e.InputProps,startAdornment:s.jsxs(s.Fragment,{children:[s.jsx(Ve,{position:"start",children:s.jsx(Je,{fontSize:"small"})}),e.InputProps.startAdornment]}),endAdornment:s.jsxs(s.Fragment,{children:[L?s.jsx(se,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}})}),s.jsxs(ie,{sx:{minWidth:200},children:[s.jsx(te,{children:t("dms.permissions.filterByInstance")}),s.jsxs(ne,{value:S,label:t("dms.permissions.filterByInstance"),onChange:e=>{pe(Number(e.target.value)),I(0)},children:[s.jsx(j,{value:0,children:t("dms.permissions.allInstances")}),le.map(e=>s.jsx(j,{value:e.id,children:e.name},e.id))]})]}),(K||S>0)&&s.jsx(T,{startIcon:s.jsx(Qe,{}),onClick:()=>{G(""),pe(0),Q(null),V(""),I(0)},size:"small",children:t("dms.permissions.clearFilters")})]}),Ue?s.jsx(h,{children:[...Array(5)].map((e,i)=>s.jsx(is,{variant:"rectangular",height:60,sx:{mb:1,borderRadius:1}},i))}):q.length===0?s.jsx(Xe,{severity:"info",sx:{borderRadius:2},children:t("dms.permissions.noPermissions")}):H==="table"?s.jsxs(ts,{component:we,elevation:0,sx:{borderRadius:2},children:[s.jsxs(ns,{children:[s.jsx(rs,{children:s.jsxs(ke,{sx:{bgcolor:"background.default"},children:[s.jsx(l,{sx:{fontWeight:600},children:t("dms.permissions.columns.userId")}),s.jsx(l,{sx:{fontWeight:600},children:t("dms.permissions.columns.resourcePath")}),s.jsx(l,{sx:{fontWeight:600},children:t("dms.permissions.columns.permissionType")}),s.jsx(l,{sx:{fontWeight:600},children:t("dms.permissions.columns.grantedBy")}),s.jsx(l,{sx:{fontWeight:600},children:t("dms.permissions.columns.grantedAt")}),s.jsx(l,{sx:{fontWeight:600},children:t("dms.permissions.columns.expiresAt")}),s.jsx(l,{sx:{fontWeight:600},children:t("dms.permissions.columns.description")}),s.jsx(l,{sx:{fontWeight:600},align:"right",children:t("dms.permissions.columns.actions")})]})}),s.jsx(as,{children:q.map((e,i)=>s.jsxs(ke,{hover:!0,sx:{"&:hover":{bgcolor:"action.hover"},transition:"background-color 0.2s"},children:[s.jsx(l,{children:s.jsxs(h,{display:"flex",alignItems:"center",children:[s.jsx(Ae,{sx:{mr:1,fontSize:18,color:"primary.main"}}),s.jsx(u,{variant:"body2",fontWeight:500,children:g.get(e.userId)?.username||g.get(e.userId)?.fullName||e.userId})]})}),s.jsx(l,{children:s.jsx(u,{variant:"body2",children:ve(e)})}),s.jsx(l,{children:s.jsx(ae,{label:t(`dms.permissions.types.${e.permissionType}`),color:e.permissionType==="read"?"info":e.permissionType==="write"?"warning":"error",size:"small"})}),s.jsx(l,{children:s.jsx(u,{variant:"body2",children:e.grantedBy?g.get(e.grantedBy)?.username||g.get(e.grantedBy)?.fullName||e.grantedBy:"-"})}),s.jsx(l,{children:s.jsx(u,{variant:"body2",color:"text.secondary",children:e.grantedAt?new Date(e.grantedAt).toLocaleString():"-"})}),s.jsx(l,{children:s.jsx(u,{variant:"body2",color:"text.secondary",children:e.expiresAt?new Date(e.expiresAt).toLocaleString():s.jsx(ae,{label:t("dms.permissions.permanent"),size:"small",variant:"outlined"})})}),s.jsx(l,{children:s.jsx(u,{variant:"body2",color:"text.secondary",children:e.description||"-"})}),s.jsx(l,{align:"right",children:s.jsxs(k,{direction:"row",spacing:.5,justifyContent:"flex-end",children:[s.jsx(A,{title:t("dms.permissions.edit"),children:s.jsx(C,{size:"small",color:"primary",onClick:()=>ye(e),children:s.jsx(Ce,{fontSize:"small"})})}),s.jsx(A,{title:t("dms.permissions.revokeConfirm"),children:s.jsx(C,{size:"small",color:"error",onClick:()=>Ie(e),children:s.jsx(Ne,{fontSize:"small"})})})]})})]},i))})]}),s.jsx(_,{}),s.jsx(os,{component:"div",count:Le,page:X,onPageChange:(e,i)=>I(i),rowsPerPage:Y,onRowsPerPageChange:e=>{Ee(parseInt(e.target.value,10)),I(0)},rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:t("dms.permissions.rowsPerPage"),labelDisplayedRows:({from:e,to:i,count:a})=>`${e}-${i} ${t("dms.permissions.of")} ${a!==-1?a:`more than ${i}`}`,sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]}):qe()]})}),s.jsxs(Ye,{open:ze,onClose:()=>{v(!1),O()},maxWidth:"sm",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[s.jsx(Ze,{sx:{pb:1,fontWeight:600},children:t(o?"dms.permissions.editTitle":"dms.permissions.grantTitle")}),s.jsx(_,{}),s.jsx(es,{sx:{pt:3},children:s.jsxs(h,{display:"flex",flexDirection:"column",gap:2,children:[s.jsx(re,{fullWidth:!0,options:ue,getOptionLabel:e=>e?e.username||e.id:"",isOptionEqualToValue:(e,i)=>!e||!i?!1:e.id===i.id,value:R,disabled:!!o,onChange:(e,i)=>{B(i),x({...r,userId:i?.id||""}),d.userId&&y({...d,userId:""}),f(i?i.username||i.id:"")},inputValue:W,onInputChange:(e,i,a)=>{a==="input"?f(i):a==="clear"?(f(""),B(null),x({...r,userId:""})):a==="reset"&&R&&f(R.username||R.id)},onOpen:()=>{!z&&ue.length===0&&Z()},loading:z,noOptionsText:z?t("common.loading")||"加载中...":W?t("No users found")||"未找到用户":t("Enter username to search")||"输入用户名搜索",filterOptions:e=>e,renderInput:e=>s.jsx(N,{...e,label:t("dms.permissions.username"),required:!0,error:!!d.userId,helperText:d.userId||t("dms.permissions.usernamePlaceholder"),InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[z?s.jsx(se,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}})}),s.jsxs(ie,{fullWidth:!0,required:!0,error:!!d.instanceId,disabled:!!o,children:[s.jsx(te,{children:t("dms.permissions.instance")}),s.jsxs(ne,{value:r.instanceId,label:t("dms.permissions.instance"),disabled:!!o,onChange:async e=>{const i=Number(e.target.value);x({...r,instanceId:i,databaseNames:[]}),d.instanceId&&y({...d,instanceId:""}),i>0?await je(i):P([])},children:[s.jsx(j,{value:0,children:t("dms.permissions.selectInstance")}),le.map(e=>s.jsx(j,{value:e.id,children:e.name},e.id))]}),d.instanceId&&s.jsx(u,{variant:"caption",color:"error",sx:{mt:.5,ml:1.75},children:d.instanceId})]}),s.jsx(re,{multiple:!0,fullWidth:!0,options:De,value:r.databaseNames,disabled:!!o||!r.instanceId||U,onChange:(e,i)=>{x({...r,databaseNames:i}),d.databaseNames&&y({...d,databaseNames:""})},loading:U,noOptionsText:U?t("common.loading")||"加载中...":r.instanceId?t("dms.permissions.noDatabases")||"暂无数据库":t("dms.permissions.selectInstanceFirst")||"请先选择实例",renderInput:e=>s.jsx(N,{...e,label:t("dms.permissions.databaseNames"),placeholder:t("dms.permissions.databaseNamesPlaceholder"),error:!!d.databaseNames,helperText:d.databaseNames||t("dms.permissions.databaseNamesHint"),InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[U?s.jsx(se,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}})}),s.jsxs(ie,{fullWidth:!0,required:!0,children:[s.jsx(te,{children:t("dms.permissions.permissionType")}),s.jsxs(ne,{value:r.permissionType,label:t("dms.permissions.permissionType"),onChange:e=>x({...r,permissionType:e.target.value}),children:[s.jsx(j,{value:"read",children:t("dms.permissions.permissionTypes.read")}),s.jsx(j,{value:"write",children:t("dms.permissions.permissionTypes.write")}),s.jsx(j,{value:"admin",children:t("dms.permissions.permissionTypes.admin")})]})]}),s.jsx(N,{label:t("dms.permissions.expiresAt"),type:"datetime-local",value:r.expiresAt,onChange:e=>x({...r,expiresAt:e.target.value}),fullWidth:!0,InputLabelProps:{shrink:!0},helperText:t("dms.permissions.expiresAtHint")}),s.jsx(N,{label:t("dms.permissions.description"),multiline:!0,rows:3,value:r.description,onChange:e=>x({...r,description:e.target.value}),fullWidth:!0,placeholder:t("dms.permissions.descriptionPlaceholder")})]})}),s.jsx(_,{}),s.jsxs(ss,{sx:{p:2},children:[s.jsx(T,{onClick:()=>{v(!1),O()},children:t("common.cancel")}),s.jsx(T,{onClick:_e,variant:"contained",sx:{borderRadius:1},children:t("common.confirm")})]})]})]})}export{gs as default};
