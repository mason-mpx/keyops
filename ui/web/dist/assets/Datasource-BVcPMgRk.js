import{u as Y,r as l,j as e,B as w,w as J,x as Q,T as p,a as f,v as Z,A as ee,P as se,d as h,I as m,S as ae,g as te,h as ne,i as re,k as oe,l as le,m as A,F as E,n as F,o as q,M as i,s as ie,cS as ce,cU as de,be as ue,_ as he,p as pe,bf as d,a7 as g}from"./index-DNdAKB9f.js";import{a as x}from"./alertApi-DA6IzLde.js";import{S as D}from"./Stack-6rKlDBQM.js";import{T as me,a as xe,b as ye,c as _,d as r,e as je}from"./TableRow-2FuGKbnY.js";import{C as O}from"./Chip-B8lB6W_F.js";import{P as fe}from"./Pagination-LCTmwsmm.js";import{S as ge}from"./Switch-psoPU8CH.js";import"./LastPage-v7sA_Lnn.js";function Ae(){const{t:a}=Y(),[P,T]=l.useState([]),[S,z]=l.useState(!1),[R,K]=l.useState(new Set),[L,M]=l.useState(!1),[v,b]=l.useState(null),[I,U]=l.useState(1),[C]=l.useState(10),[W,H]=l.useState(0),[n,c]=l.useState({source_name:"",source_type:"prometheus",address:"",api_key:"",auto_sync:!0,sync_interval:10}),[y,k]=l.useState(!1),u=l.useCallback(async()=>{try{z(!0);const s={page:I,page_size:C},t=await x.getRuleSources(s);(t.data.code===0||t.data.code===200)&&(T(t.data.data||[]),H(t.data.total||0))}catch(s){console.error("获取数据源失败:",s),T([])}finally{z(!1)}},[I,C]);l.useEffect(()=>{u()},[u]);const B=s=>{s?(b(s),c({source_name:s.source_name,source_type:s.source_type,address:s.address,api_key:s.api_key||"",department_id:s.department_id,auto_sync:s.auto_sync,sync_interval:s.sync_interval||10})):(b(null),c({source_name:"",source_type:"prometheus",address:"",api_key:"",auto_sync:!0,sync_interval:10})),M(!0)},j=()=>{M(!1),b(null),k(!1),c({source_name:"",source_type:"prometheus",address:"",api_key:"",department_id:void 0,auto_sync:!0,sync_interval:10})},N=()=>{const s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";let t="";for(let o=0;o<32;o++)t+=s.charAt(Math.floor(Math.random()*s.length));c({...n,api_key:t}),k(!0)},$=async()=>{if(!n.source_name||!n.address){d(a("Please fill in required fields")||"请填写必填字段");return}if(!n.api_key||n.api_key.trim()===""){d(a("API Key is required")||"API密钥为必填项");return}try{const s={source_name:n.source_name,source_type:n.source_type,address:n.address,api_key:n.api_key?.trim()||"",department_id:void 0,auto_sync:n.auto_sync,sync_interval:n.sync_interval||10};if(v){const t=await x.updateRuleSource(v.id,s);t.data.code===0||t.data.code===200?(g(a("Update successful")||"更新成功"),j(),u()):d(a("Update failed")||"更新失败")}else{const t=await x.createRuleSource(s);t.data.code===0||t.data.code===200?(g(a("Create successful")||"创建成功"),j(),u()):d(a("Create failed")||"创建失败")}}catch(s){console.error("保存失败:",s);const t=(s&&typeof s=="object"&&"response"in s&&s.response&&typeof s.response=="object"&&"data"in s.response&&s.response.data&&typeof s.response.data=="object"&&"message"in s.response.data&&typeof s.response.data.message=="string"?s.response.data.message:null)||(s&&typeof s=="object"&&"message"in s&&typeof s.message=="string"?s.message:null)||a("Operation failed")||"操作失败";d(t)}},V=async s=>{if(confirm(a("Are you sure you want to delete this datasource?")||"确定要删除这个数据源吗？"))try{const o=(await x.deleteRuleSource(s)).data;o.code===0||o.code===200?(g(a("Delete successful")||"删除成功"),u()):d(a("Delete failed")||"删除失败")}catch(t){console.error("删除失败:",t),d(t?.response?.data?.message||t?.message||a("Delete failed")||"删除失败")}},G=async s=>{try{K(X=>new Set(X).add(s));const o=(await x.syncRulesFromDatasource(s)).data;o.code===0||o.code===200?g(o.message||a("Sync successful")):d(o.message||a("Sync failed"))}catch(t){console.error("同步失败:",t),d(t?.response?.data?.message||t?.message||a("Sync failed"))}finally{K(t=>{const o=new Set(t);return o.delete(s),o})}};return e.jsxs(w,{sx:{p:3},children:[e.jsx(J,{children:e.jsxs(Q,{children:[e.jsxs(w,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(p,{variant:"h5",gutterBottom:!0,children:a("menu.monitorDatasource")||"数据源管理"}),e.jsxs(D,{direction:"row",spacing:2,children:[e.jsx(f,{variant:"outlined",startIcon:e.jsx(Z,{}),onClick:u,disabled:S,children:a("common.refresh")}),e.jsx(f,{variant:"contained",startIcon:e.jsx(ee,{}),onClick:()=>B(),children:a("Create Datasource")||"新建数据源"})]})]}),e.jsx(me,{component:se,children:e.jsxs(xe,{children:[e.jsx(ye,{children:e.jsxs(_,{children:[e.jsx(r,{children:a("Datasource Name")||"数据源名称"}),e.jsx(r,{children:a("Type")||"类型"}),e.jsx(r,{children:a("Address")||"地址"}),e.jsx(r,{children:a("Auto Sync")||"自动同步"}),e.jsx(r,{children:a("Sync Interval")||"同步间隔"}),e.jsx(r,{align:"right",children:a("common.actions")})]})}),e.jsx(je,{children:S?e.jsx(_,{children:e.jsx(r,{colSpan:6,align:"center",children:a("common.loading")})}):P.length===0?e.jsx(_,{children:e.jsx(r,{colSpan:6,align:"center",children:a("common.noData")})}):P.map(s=>e.jsxs(_,{children:[e.jsx(r,{children:s.source_name}),e.jsx(r,{children:e.jsx(O,{label:s.source_type,size:"small"})}),e.jsx(r,{children:e.jsx(h,{title:s.address,children:e.jsx(p,{variant:"body2",sx:{maxWidth:300,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:s.address})})}),e.jsx(r,{children:e.jsx(O,{label:s.auto_sync?a("Yes"):a("No"),color:s.auto_sync?"success":"default",size:"small"})}),e.jsx(r,{children:s.auto_sync?e.jsxs(p,{variant:"body2",color:"text.secondary",children:[s.sync_interval||10," ",a("minutes")||"分钟"]}):e.jsx(p,{variant:"body2",color:"text.disabled",children:a("Manual")||"手动"})}),e.jsx(r,{align:"right",children:e.jsxs(D,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(h,{title:a("Sync Rules"),children:e.jsx(m,{size:"small",color:"primary",onClick:()=>G(s.id),disabled:S||R.has(s.id),children:e.jsx(ae,{fontSize:"small",sx:{animation:R.has(s.id)?"spin 1s linear infinite":"none","@keyframes spin":{"0%":{transform:"rotate(0deg)"},"100%":{transform:"rotate(360deg)"}}}})})}),e.jsx(h,{title:a("common.edit"),children:e.jsx(m,{size:"small",onClick:()=>B(s),children:e.jsx(te,{fontSize:"small"})})}),e.jsx(h,{title:a("common.delete"),children:e.jsx(m,{size:"small",color:"error",onClick:()=>V(s.id),children:e.jsx(ne,{fontSize:"small"})})})]})})]},s.id))})]})}),W>0&&e.jsx(w,{sx:{display:"flex",justifyContent:"center",mt:2},children:e.jsx(fe,{count:Math.ceil(W/C),page:I,onChange:(s,t)=>U(t),color:"primary"})})]})}),e.jsxs(re,{open:L,onClose:j,maxWidth:"md",fullWidth:!0,children:[e.jsx(oe,{children:v?a("Edit Datasource")||"编辑数据源":a("Create Datasource")||"新建数据源"}),e.jsx(le,{children:e.jsxs(D,{spacing:3,sx:{mt:1},children:[e.jsx(A,{label:`${a("Datasource Name")||"数据源名称"} *`,value:n.source_name,onChange:s=>c({...n,source_name:s.target.value}),fullWidth:!0,required:!0}),e.jsxs(E,{fullWidth:!0,required:!0,children:[e.jsxs(F,{children:[a("Type")||"类型"," *"]}),e.jsxs(q,{value:n.source_type,label:`${a("Type")||"类型"} *`,onChange:s=>c({...n,source_type:s.target.value}),children:[e.jsx(i,{value:"prometheus",children:"Prometheus"}),e.jsx(i,{value:"victoriametrics",children:"VictoriaMetrics"}),e.jsx(i,{value:"thanos",children:"Thanos"})]})]}),e.jsx(A,{label:`${a("Address")||"地址"} *`,value:n.address,onChange:s=>c({...n,address:s.target.value}),fullWidth:!0,required:!0,placeholder:"http://prometheus:9090",helperText:a("Full URL of the datasource")||"数据源的完整URL地址"}),e.jsx(A,{label:`${a("API Key")||"API密钥"} *`,value:n.api_key||"",onChange:s=>c({...n,api_key:s.target.value}),fullWidth:!0,required:!0,type:y?"text":"password",helperText:a("API Key Helper")||"用于webhook认证，必填。接口路径：POST /api/alerts/webhook/prometheus。支持在Header中使用：Authorization: Bearer <api_key> 或 X-API-Key: <api_key>",InputProps:{endAdornment:e.jsxs(ie,{position:"end",children:[e.jsx(h,{title:a("Generate Random API Key")||"随机生成API密钥",children:e.jsx(m,{edge:"end",onClick:N,size:"small",sx:{mr:.5},children:e.jsx(ce,{fontSize:"small"})})}),e.jsx(h,{title:y?a("Hide API Key")||"隐藏API密钥":a("Show API Key")||"显示API密钥",children:e.jsx(m,{edge:"end",onClick:()=>k(!y),size:"small",children:y?e.jsx(de,{fontSize:"small"}):e.jsx(ue,{fontSize:"small"})})})]})}}),e.jsx(he,{control:e.jsx(ge,{checked:n.auto_sync??!0,onChange:s=>c({...n,auto_sync:s.target.checked})}),label:a("Auto Sync")||"自动同步"}),n.auto_sync&&e.jsxs(E,{fullWidth:!0,children:[e.jsxs(F,{children:[a("Sync Interval")||"同步间隔"," *"]}),e.jsxs(q,{value:n.sync_interval||10,label:`${a("Sync Interval")||"同步间隔"} *`,onChange:s=>c({...n,sync_interval:Number(s.target.value)}),children:[e.jsxs(i,{value:5,children:["5 ",a("minutes")||"分钟"]}),e.jsxs(i,{value:10,children:["10 ",a("minutes")||"分钟"]}),e.jsxs(i,{value:30,children:["30 ",a("minutes")||"分钟"]}),e.jsxs(i,{value:60,children:["1 ",a("hour")||"小时"]}),e.jsxs(i,{value:120,children:["2 ",a("hours")||"小时"]}),e.jsxs(i,{value:180,children:["3 ",a("hours")||"小时"]}),e.jsxs(i,{value:360,children:["6 ",a("hours")||"小时"]}),e.jsxs(i,{value:720,children:["12 ",a("hours")||"小时"]}),e.jsxs(i,{value:1440,children:["24 ",a("hours")||"小时"]})]}),e.jsx(p,{variant:"caption",color:"text.secondary",sx:{mt:1},children:a("Sync interval description")||"说明：系统将按照设定的间隔自动从数据源同步告警规则。在分布式部署环境下，建议设置较长的同步间隔以避免重复同步。"})]})]})}),e.jsxs(pe,{children:[e.jsx(f,{onClick:j,children:a("common.cancel")}),e.jsx(f,{onClick:$,variant:"contained",children:a("common.save")})]})]})]})}export{Ae as default};
