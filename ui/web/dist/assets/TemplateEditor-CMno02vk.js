import{ax as N,bg as W,r as o,j as r,B as u,ay as O,az as P,I as V,aA as L,T as j,a as R,a5 as $,P as G,m as h,M as H}from"./index-CJIrazW8.js";import{f as J,a as p}from"./ticketApi-CCnZQOPl.js";import M,{normalizeFormGridConfig as S}from"./index-CmicYmgA.js";import{S as q}from"./Stack-C3ISDylI.js";import"./index-Cgn-RpuY.js";import"./typeof-QjJsDpFa.js";import"./sortable.esm-ByftlQFZ.js";function ee(){const g=N(),{id:c}=W(),[C,d]=o.useState(!1),[w,y]=o.useState(!1),[x,I]=o.useState([]),[i,m]=o.useState({name:"",category:"",description:""}),[f,v]=o.useState({}),s=o.useRef(!0);o.useEffect(()=>(k(),c&&T(Number(c)),()=>{s.current=!1}),[c]);const k=async()=>{try{s.current&&y(!0);const e=(await J.list({page:1,page_size:100})).data,l=[Array.isArray(e)?e:void 0,!Array.isArray(e)&&e?.data&&Array.isArray(e.data)?e.data:void 0,!Array.isArray(e)&&e?.data&&typeof e.data=="object"&&!Array.isArray(e.data)?e.data.data:void 0,!Array.isArray(e)&&e?.data&&typeof e.data=="object"&&!Array.isArray(e.data)?e.data.list:void 0,!Array.isArray(e)&&e?.data&&typeof e.data=="object"&&!Array.isArray(e.data)?e.data.items:void 0,Array.isArray(e)?void 0:e?.list,Array.isArray(e)?void 0:e?.items].find(n=>Array.isArray(n))||[];s.current&&I(l)}catch(a){console.error("加载分类列表失败:",a)}finally{s.current&&y(!1)}},[A,z]=o.useState(null),[b,B]=o.useState("1.0.0"),T=async a=>{try{s.current&&d(!0);const e=await p.get(a);if(e.data.code===0){const t=e.data.data;if(s.current){m({name:t.name,category:t.category||"",description:t.description||""});const l=t.schema&&typeof t.schema=="object"?t.schema:{},n=S(l);v(n),z(JSON.stringify(n)),B(t.version||"1.0.0")}}}catch(e){console.error("加载模板失败:",e)}finally{s.current&&d(!1)}},F=a=>{const e=a.split(".");if(e.length!==3)return"1.0.0";const t=parseInt(e[0])||1,l=parseInt(e[1])||0,n=parseInt(e[2])||0;return`${t}.${l}.${n+1}`},D=async()=>{if(!i.name.trim()){alert("请输入工单名称");return}try{s.current&&d(!0);const a=JSON.stringify(f||{}),e=A!==null&&a!==A;let t;c?t=e?F(b):b:t="1.0.0";const l=S(f||{}),n={...i,schema:l,status:"active",version:t};c?await p.update(Number(c),n):await p.create(n),g("/form-templates")}catch(a){console.error("保存模板失败:",a),alert("保存失败，请重试")}finally{s.current&&d(!1)}},E=o.useCallback(a=>{s.current&&v(a)},[]);return r.jsxs(u,{sx:{height:"100vh",width:"100vw",display:"flex",flexDirection:"column",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1300,bgcolor:"background.default",overflow:"hidden"},children:[r.jsx(O,{position:"static",color:"default",elevation:1,sx:{flexShrink:0,borderBottom:"1px solid",borderColor:"divider"},children:r.jsxs(P,{sx:{minHeight:"64px !important",px:{xs:2,sm:3}},children:[r.jsx(V,{edge:"start",onClick:()=>g("/form-templates"),sx:{mr:2},size:"large",children:r.jsx(L,{})}),r.jsx(j,{variant:"h6",sx:{flexGrow:1,fontWeight:600},children:c?"编辑工单模板":"新建工单模板"}),r.jsx(R,{startIcon:r.jsx($,{}),variant:"contained",onClick:D,disabled:C||!i.name.trim(),sx:{minWidth:100},children:"保存"})]})}),r.jsx(G,{sx:{p:2.5,borderBottom:"1px solid",borderColor:"divider",flexShrink:0,bgcolor:"background.paper"},children:r.jsxs(q,{direction:"row",spacing:2.5,alignItems:"flex-start",children:[r.jsx(h,{label:"模板名称",value:i.name,onChange:a=>m({...i,name:a.target.value}),required:!0,sx:{minWidth:240},size:"small"}),r.jsx(h,{label:"分类",value:i.category,onChange:a=>m({...i,category:a.target.value}),select:!0,sx:{minWidth:200},disabled:w&&x.length===0,size:"small",children:x.map(a=>r.jsx(H,{value:a.name,children:a.name},a.id))}),r.jsx(h,{label:"描述",value:i.description,onChange:a=>m({...i,description:a.target.value}),sx:{flex:1,maxWidth:600},size:"small",placeholder:"请输入模板描述（可选）"})]})}),r.jsx(u,{sx:{flex:1,overflow:"hidden",minHeight:0,position:"relative",bgcolor:"background.default"},children:(()=>{try{return r.jsx(M,{value:f,onChange:E,height:"100%"})}catch(a){return r.jsx(u,{sx:{p:3,color:"error.main",display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:r.jsxs(j,{variant:"body1",children:["表单设计器加载失败: ",a instanceof Error?a.message:String(a)]})})}})()})]})}export{ee as default};
