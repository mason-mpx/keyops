import{u as qe,r,cd as l,bf as b,j as e,B as j,w as ze,x as Fe,T as g,a as y,A as Be,P as ee,m as c,s as Me,t as Ne,F as se,n as te,o as ne,M as h,d as E,I as q,v as Le,b as ae,c as z,V as Ae,g as Oe,C as re,h as _e,D as R,i as oe,k as ie,l as le,p as ce,a7 as D,_ as He,ce as de,Z as me}from"./index-z51Q_M-r.js";import{S as ue}from"./Stack-07-bXrzl.js";import{S as Qe}from"./Skeleton-74PVangM.js";import{T as $e,a as Ue,b as Ve,c as he,d as m,e as Ye}from"./TableRow-CKQKXB8v.js";import{C as pe}from"./Chip-BoE43uAD.js";import{T as Ze}from"./TablePagination-DV0GrBI0.js";import{S as Ge}from"./Switch-CFen4WHb.js";import"./LastPage-BCKcUFpS.js";const ge={mysql:{bg:"#f0f9ff",color:"#0369a1"},postgresql:{bg:"#f0fdf4",color:"#166534"},mongodb:{bg:"#fefce8",color:"#854d0e"},redis:{bg:"#fef2f2",color:"#991b1b"}},Je={mysql:e.jsx(me,{sx:{fontSize:20}}),postgresql:e.jsx(me,{sx:{fontSize:20}}),mongodb:e.jsx(de,{sx:{fontSize:20}}),redis:e.jsx(de,{sx:{fontSize:20}})};function os(){const{t}=qe(),[xe,_]=r.useState(!0),[H,Q]=r.useState([]),[T,fe]=r.useState(""),[I,$]=r.useState(0),[v,be]=r.useState(10),[je,U]=r.useState(0),[C,ye]=r.useState(""),[Te,W]=r.useState(!1),[F,k]=r.useState(!1),[V,Ie]=r.useState(null),[Y,Z]=r.useState(null),[B,G]=r.useState(!1),[M,w]=r.useState(!1),[N,S]=r.useState(!1),u=r.useRef(null),[n,i]=r.useState({name:"",dbType:"mysql",host:"",port:3306,username:"",password:"",databaseName:"",authDatabase:"",charset:"utf8mb4",connectionString:"",description:"",isEnabled:!0}),[o,x]=r.useState({}),J=r.useRef(I),K=r.useRef(v),L=r.useRef(T),A=r.useRef(C);J.current=I,K.current=v,L.current=T,A.current=C;const P=r.useCallback(async()=>{console.log("[Instances] loadInstances called"),_(!0);try{const s={page:J.current+1,page_size:K.current};L.current&&(s.name=L.current),A.current&&(s.db_type=A.current),console.log("[Instances] Fetching with params:",s);const a=await l.listInstances(s);console.log("[Instances] Response received:",a),a&&a.list?(console.log("[Instances] Setting instances from response.list, count:",a.list.length),Q(a.list||[]),U(a.total||0)):a&&a.code===200&&(console.log("[Instances] Setting instances from response.data"),Q(a.data?.list||[]),U(a.data?.total||0))}catch(s){console.error("[Instances] Error loading instances:",s),b(s.message||t("dms.instances.loadFailed"))}finally{console.log("[Instances] Setting loading to false"),_(!1)}},[]);r.useEffect(()=>{console.log("[Instances] useEffect triggered for filters:",{page:I,rowsPerPage:v,searchTerm:T,dbTypeFilter:C}),P()},[I,v,T,C]);const ve=()=>!(!n.name.trim()||!n.host.trim()||!n.port||n.port<1||n.port>65535||n.dbType!=="redis"&&n.dbType!=="mongodb"&&!n.password),O=()=>{const s={};return n.name.trim()||(s.name=t("dms.instances.nameRequired")),n.host.trim()||(s.host=t("dms.instances.hostRequired")),(!n.port||n.port<1||n.port>65535)&&(s.port=t("dms.instances.portInvalid")),n.dbType!=="redis"&&n.dbType!=="mongodb"&&!n.password&&(s.password=t("dms.instances.passwordRequired")),x(s),Object.keys(s).length===0},Ce=async()=>{if(!O())return;const s=u.current;if(s){try{await l.deleteInstance(s)}catch(p){console.warn("删除之前的临时实例失败:",p)}u.current=null}G(!0),w(!1),S(!1);let a=null;try{if(a=(await l.createInstance(n))?.data?.id??null,!a)throw new Error("创建临时实例失败");await l.testConnection(a),u.current=a,w(!0),S(!0),D(t("dms.instances.testSuccess"))}catch(p){w(!0),S(!1);const ke=p.message||t("common.unknown");if(b(t("dms.instances.testFailed")+": "+ke),a)try{await l.deleteInstance(a)}catch(Ee){console.warn("删除临时实例失败:",Ee)}}finally{G(!1)}},we=async()=>{if(O()){if(!M||!N){b(t("dms.instances.testBeforeSave"));return}try{const s=u.current;s?(await l.updateInstance(s,n),u.current=null):await l.createInstance(n),D(t("dms.instances.createSuccess")),W(!1),f(),P()}catch(s){b(s.message||t("dms.instances.createFailed"))}}},Se=s=>{Ie(s),i({name:s.name,dbType:s.dbType,host:s.host,port:s.port,username:s.username,password:"",databaseName:s.databaseName||"",authDatabase:"",charset:"utf8mb4",connectionString:"",description:s.description||"",isEnabled:s.isEnabled}),x({}),k(!0)},Pe=async()=>{if(!(!V||!O()))try{await l.updateInstance(V.id,n),D(t("dms.instances.updateSuccess")),k(!1),f(),P()}catch(s){b(s.message||t("dms.instances.updateFailed"))}},Re=async s=>{if(confirm(t("dms.instances.deleteConfirm")))try{await l.deleteInstance(s),D(t("dms.instances.deleteSuccess")),P()}catch(a){b(a.message||t("dms.instances.deleteFailed"))}},De=async s=>{Z(s);try{await l.testConnection(s),D(t("dms.instances.testSuccess"))}catch(a){b(t("dms.instances.testFailed")+": "+(a.message||t("common.unknown")))}finally{Z(null)}},f=async()=>{const s=u.current;if(s){try{await l.deleteInstance(s)}catch(a){console.warn("删除临时实例失败:",a)}u.current=null}i({name:"",dbType:"mysql",host:"",port:3306,username:"",password:"",databaseName:"",authDatabase:"",charset:"utf8mb4",connectionString:"",description:"",isEnabled:!0}),x({}),w(!1),S(!1)},We=s=>({mysql:3306,postgresql:5432,mongodb:27017,redis:6379})[s]||3306,d=r.useCallback(()=>{w(s=>{if(s){const a=u.current;return S(!1),a&&(u.current=null,l.deleteInstance(a).catch(p=>{console.warn("删除临时实例失败:",p)})),!1}return s})},[]),X=()=>e.jsxs(j,{display:"flex",flexDirection:"column",gap:2,pt:1,children:[e.jsx(c,{label:t("dms.instances.instanceName"),value:n.name,onChange:s=>{i({...n,name:s.target.value}),o.name&&x({...o,name:""}),d()},required:!0,fullWidth:!0,error:!!o.name,helperText:o.name}),e.jsxs(se,{fullWidth:!0,required:!0,children:[e.jsx(te,{children:t("dms.instances.dbType")}),e.jsxs(ne,{value:n.dbType,label:t("dms.instances.dbType"),onChange:s=>{const a=s.target.value;i({...n,dbType:a,port:We(a)}),d()},children:[e.jsx(h,{value:"mysql",children:"MySQL"}),e.jsx(h,{value:"postgresql",children:"PostgreSQL"}),e.jsx(h,{value:"mongodb",children:"MongoDB"}),e.jsx(h,{value:"redis",children:"Redis"})]})]}),e.jsx(c,{label:t("dms.instances.host"),value:n.host,onChange:s=>{i({...n,host:s.target.value}),o.host&&x({...o,host:""}),d()},required:!0,fullWidth:!0,error:!!o.host,helperText:o.host,placeholder:t("dms.instances.hostPlaceholder")}),e.jsx(c,{label:t("dms.instances.port"),type:"number",value:n.port,onChange:s=>{i({...n,port:parseInt(s.target.value)||3306}),o.port&&x({...o,port:""}),d()},required:!0,fullWidth:!0,error:!!o.port,helperText:o.port}),e.jsx(c,{label:t("dms.instances.username"),value:n.username,onChange:s=>{i({...n,username:s.target.value}),d()},fullWidth:!0,placeholder:n.dbType==="redis"?t("dms.instances.redisUsernamePlaceholder"):t("dms.instances.usernamePlaceholder")}),n.dbType==="redis"&&e.jsx(ae,{severity:"info",sx:{mt:-1,mb:1,fontSize:"0.75rem"},children:t("dms.instances.redisVersionHint")}),e.jsx(c,{label:t("dms.instances.password"),type:"password",value:n.password,onChange:s=>{i({...n,password:s.target.value}),o.password&&x({...o,password:""}),d()},required:n.dbType!=="redis"&&n.dbType!=="mongodb",fullWidth:!0,error:!!o.password,helperText:o.password||(F?t("dms.instances.passwordPlaceholder"):(n.dbType==="redis"||n.dbType==="mongodb")&&!F?n.dbType==="redis"?t("dms.instances.redisPasswordHint"):t("dms.instances.mongodbPasswordHint")||"MongoDB 可以没有密码":"")}),(n.dbType==="mysql"||n.dbType==="postgresql")&&e.jsx(c,{label:t("dms.instances.databaseName"),value:n.databaseName,onChange:s=>{i({...n,databaseName:s.target.value}),d()},fullWidth:!0,placeholder:t("dms.instances.defaultDatabase")}),n.dbType==="mysql"&&e.jsx(c,{label:t("dms.instances.charset"),value:n.charset,onChange:s=>{i({...n,charset:s.target.value}),d()},fullWidth:!0,placeholder:"默认: utf8mb4"}),n.dbType==="mongodb"&&e.jsxs(e.Fragment,{children:[e.jsx(c,{label:t("dms.instances.authDatabase"),value:n.authDatabase,onChange:s=>{i({...n,authDatabase:s.target.value}),d()},fullWidth:!0,placeholder:"默认: admin"}),e.jsx(c,{label:t("dms.instances.connectionString"),value:n.connectionString,onChange:s=>{i({...n,connectionString:s.target.value}),d()},fullWidth:!0,placeholder:"可选，MongoDB连接字符串"})]}),e.jsx(c,{label:t("dms.instances.description"),multiline:!0,rows:3,value:n.description,onChange:s=>{i({...n,description:s.target.value})},fullWidth:!0,placeholder:t("dms.instances.descriptionPlaceholder")}),e.jsx(He,{control:e.jsx(Ge,{checked:n.isEnabled,onChange:s=>{i({...n,isEnabled:s.target.checked})}}),label:t("dms.instances.isEnabled")})]});return e.jsxs(j,{sx:{p:3},children:[e.jsx(ze,{elevation:2,sx:{borderRadius:2},children:e.jsxs(Fe,{children:[e.jsxs(j,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(j,{children:[e.jsx(g,{variant:"h5",fontWeight:600,gutterBottom:!0,children:t("dms.instances.title")}),e.jsx(g,{variant:"body2",color:"text.secondary",children:t("dms.instances.subtitle")})]}),e.jsx(y,{variant:"contained",startIcon:e.jsx(Be,{}),onClick:()=>{f(),W(!0)},sx:{borderRadius:2},children:t("dms.instances.addInstance")})]}),e.jsx(ee,{elevation:0,sx:{p:2,mb:3,bgcolor:"background.default",borderRadius:2},children:e.jsxs(ue,{direction:"row",spacing:2,alignItems:"center",children:[e.jsx(c,{placeholder:t("common.search")+"...",value:T,onChange:s=>fe(s.target.value),InputProps:{startAdornment:e.jsx(Me,{position:"start",children:e.jsx(Ne,{color:"action"})})},sx:{flex:1,maxWidth:400},size:"small"}),e.jsxs(se,{sx:{minWidth:150},size:"small",children:[e.jsx(te,{children:t("dms.instances.dbType")}),e.jsxs(ne,{value:C,label:t("dms.instances.dbType"),onChange:s=>ye(s.target.value),children:[e.jsx(h,{value:"",children:t("common.all")}),e.jsx(h,{value:"mysql",children:"MySQL"}),e.jsx(h,{value:"postgresql",children:"PostgreSQL"}),e.jsx(h,{value:"mongodb",children:"MongoDB"}),e.jsx(h,{value:"redis",children:"Redis"})]})]}),e.jsx(E,{title:t("common.refresh"),children:e.jsx(q,{onClick:P,size:"small",children:e.jsx(Le,{})})})]})}),xe?e.jsx(j,{children:[...Array(5)].map((s,a)=>e.jsx(Qe,{variant:"rectangular",height:60,sx:{mb:1,borderRadius:1}},a))}):H.length===0?e.jsx(ae,{severity:"info",sx:{borderRadius:2},children:t("dms.instances.noInstances")}):e.jsxs($e,{component:ee,elevation:0,sx:{borderRadius:2},children:[e.jsxs(Ue,{children:[e.jsx(Ve,{children:e.jsxs(he,{sx:{bgcolor:"background.default"},children:[e.jsx(m,{sx:{fontWeight:600},children:t("dms.instances.columns.name")}),e.jsx(m,{sx:{fontWeight:600},children:t("dms.instances.columns.type")}),e.jsx(m,{sx:{fontWeight:600},children:t("dms.instances.columns.connection")}),e.jsx(m,{sx:{fontWeight:600},children:t("dms.instances.columns.status")}),e.jsx(m,{sx:{fontWeight:600},align:"right",children:t("dms.instances.columns.actions")})]})}),e.jsx(Ye,{children:H.map(s=>e.jsxs(he,{hover:!0,sx:{"&:hover":{bgcolor:"action.hover"},transition:"background-color 0.2s"},children:[e.jsxs(m,{children:[e.jsx(g,{variant:"body2",fontWeight:500,children:s.name}),s.description&&e.jsx(g,{variant:"caption",color:"text.secondary",display:"block",children:s.description})]}),e.jsx(m,{children:e.jsx(pe,{icon:Je[s.dbType]||void 0,label:s.dbType.toUpperCase(),size:"small",sx:{bgcolor:ge[s.dbType]?.bg||"grey.100",color:ge[s.dbType]?.color||"grey.700",fontWeight:500}})}),e.jsxs(m,{children:[e.jsxs(g,{variant:"body2",fontFamily:"monospace",children:[s.host,":",s.port]}),s.username&&e.jsxs(g,{variant:"caption",color:"text.secondary",display:"block",children:[t("dms.instances.username"),": ",s.username]}),s.databaseName&&e.jsxs(g,{variant:"caption",color:"text.secondary",display:"block",children:[t("dms.instances.databaseName"),": ",s.databaseName]})]}),e.jsx(m,{children:e.jsx(pe,{icon:s.isEnabled?e.jsx(z,{}):e.jsx(Ae,{}),label:s.isEnabled?t("dms.instances.status.enabled"):t("dms.instances.status.disabled"),color:s.isEnabled?"success":"default",size:"small",variant:"outlined"})}),e.jsx(m,{align:"right",children:e.jsxs(ue,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(E,{title:t("common.edit"),children:e.jsx(q,{size:"small",onClick:()=>Se(s),color:"primary",children:e.jsx(Oe,{fontSize:"small"})})}),e.jsx(E,{title:t("dms.instances.testConnection"),children:e.jsx(q,{size:"small",onClick:()=>De(s.id),disabled:Y===s.id,color:"info",children:Y===s.id?e.jsx(re,{size:16}):e.jsx(z,{fontSize:"small"})})}),e.jsx(E,{title:t("common.delete"),children:e.jsx(q,{size:"small",onClick:()=>Re(s.id),color:"error",children:e.jsx(_e,{fontSize:"small"})})})]})})]},s.id))})]}),e.jsx(R,{}),e.jsx(Ze,{component:"div",count:je,page:I,onPageChange:(s,a)=>$(a),rowsPerPage:v,onRowsPerPageChange:s=>{be(parseInt(s.target.value,10)),$(0)},rowsPerPageOptions:[10,25,50,100],labelRowsPerPage:t("common.rowsPerPage")+":",labelDisplayedRows:({from:s,to:a,count:p})=>`${s}-${a} ${t("common.of")} ${p}`,sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]})]})}),e.jsxs(oe,{open:Te,onClose:()=>{W(!1),f()},maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[e.jsx(ie,{sx:{pb:1,fontWeight:600},children:t("dms.instances.addInstance")}),e.jsx(R,{}),e.jsx(le,{sx:{pt:3},children:X()}),e.jsx(R,{}),e.jsxs(ce,{sx:{p:2,justifyContent:"space-between"},children:[e.jsx(y,{onClick:Ce,disabled:B||!ve(),variant:"outlined",startIcon:B?e.jsx(re,{size:16}):e.jsx(z,{}),sx:{borderRadius:1},children:t(B?"dms.instances.testing":"dms.instances.testConnection")}),M&&N&&e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1,color:"success.main"},children:[e.jsx(z,{fontSize:"small"}),e.jsx(g,{variant:"body2",children:t("dms.instances.testSuccess")})]}),e.jsxs(j,{children:[e.jsx(y,{onClick:()=>{W(!1),f()},children:t("common.cancel")}),e.jsx(y,{onClick:we,variant:"contained",disabled:!M||!N,sx:{borderRadius:1,ml:1},children:t("common.confirm")})]})]})]}),e.jsxs(oe,{open:F,onClose:()=>{k(!1),f()},maxWidth:"md",fullWidth:!0,PaperProps:{sx:{borderRadius:2}},children:[e.jsx(ie,{sx:{pb:1,fontWeight:600},children:t("dms.instances.editInstance")}),e.jsx(R,{}),e.jsx(le,{sx:{pt:3},children:X()}),e.jsx(R,{}),e.jsxs(ce,{sx:{p:2},children:[e.jsx(y,{onClick:()=>{k(!1),f()},children:t("common.cancel")}),e.jsx(y,{onClick:Pe,variant:"contained",sx:{borderRadius:1},children:t("common.save")})]})]})]})}export{os as default};
