import{u as he,b1 as pe,r as d,aR as xe,j as u,B as A,C as we,b as be,a as Se,P as ue,d as Ee,I as me,aY as ve,aZ as Ce,ax as ke,b2 as Re,ay as Fe,az as Te,aA as _e,T as ae,aq as Ne,a3 as We,a4 as Oe,aB as Ie,z as je}from"./index-OJNN34VQ.js";import{x as Le,a as Pe}from"./xterm-BqYE0GQX.js";import{c as ze,a as De}from"./websocket-BkR8Bfzk.js";import{G as oe}from"./guacamole-common-DCnKliOq.js";import{H as He}from"./HostTree-B9BGzJPL.js";import"./Chip-pSvhxX1X.js";var fe={exports:{}},ye;function Be(){return ye||(ye=1,(function(V,Y){(function(R,m){V.exports=m()})(self,(()=>(()=>{var R={6:(W,D)=>{Object.defineProperty(D,"__esModule",{value:!0}),D.LinkComputer=D.WebLinkProvider=void 0,D.WebLinkProvider=class{constructor(U,f,S,h={}){this._terminal=U,this._regex=f,this._handler=S,this._options=h}provideLinks(U,f){const S=T.computeLink(U,this._regex,this._terminal,this._handler);f(this._addCallbacks(S))}_addCallbacks(U){return U.map((f=>(f.leave=this._options.leave,f.hover=(S,h)=>{if(this._options.hover){const{range:L}=f;this._options.hover(S,h,L)}},f)))}};class T{static computeLink(f,S,h,L){const p=new RegExp(S.source,(S.flags||"")+"g"),[y,C]=T._getWindowedLineStrings(f-1,h),F=y.join("");let v;const O=[];for(;v=p.exec(F);){const H=v[0];try{const Q=new URL(H),K=decodeURI(Q.toString());if(H!==K&&H+"/"!==K)continue}catch{continue}const[z,G]=T._mapStrIdx(h,C,0,v.index),[M,J]=T._mapStrIdx(h,z,G,H.length);if(z===-1||G===-1||M===-1||J===-1)continue;const $={start:{x:G+1,y:z+1},end:{x:J,y:M+1}};O.push({range:$,text:H,activate:L})}return O}static _getWindowedLineStrings(f,S){let h,L=f,p=f,y=0,C="";const F=[];if(h=S.buffer.active.getLine(f)){const v=h.translateToString(!0);if(h.isWrapped&&v[0]!==" "){for(y=0;(h=S.buffer.active.getLine(--L))&&y<2048&&(C=h.translateToString(!0),y+=C.length,F.push(C),h.isWrapped&&C.indexOf(" ")===-1););F.reverse()}for(F.push(v),y=0;(h=S.buffer.active.getLine(++p))&&h.isWrapped&&y<2048&&(C=h.translateToString(!0),y+=C.length,F.push(C),C.indexOf(" ")===-1););}return[F,L]}static _mapStrIdx(f,S,h,L){const p=f.buffer.active,y=p.getNullCell();let C=h;for(;L;){const F=p.getLine(S);if(!F)return[-1,-1];for(let v=C;v<F.length;++v){F.getCell(v,y);const O=y.getChars();if(y.getWidth()&&(L-=O.length||1,v===F.length-1&&O==="")){const H=p.getLine(S+1);H&&H.isWrapped&&(H.getCell(0,y),y.getWidth()===2&&(L+=1))}if(L<0)return[S,v]}S++,C=0}return[S,C]}}D.LinkComputer=T}},m={};function I(W){var D=m[W];if(D!==void 0)return D.exports;var T=m[W]={exports:{}};return R[W](T,T.exports,I),T.exports}var j={};return(()=>{var W=j;Object.defineProperty(W,"__esModule",{value:!0}),W.WebLinksAddon=void 0;const D=I(6),T=/https?:[/]{2}[^\s"'!*(){}|\\\^<>`]*[^\s"':,.!?{}|\\\^~\[\]`()<>]/;function U(f,S){const h=window.open();if(h){try{h.opener=null}catch{}h.location.href=S}else console.warn("Opening link blocked as opener could not be cleared")}W.WebLinksAddon=class{constructor(f=U,S={}){this._handler=f,this._options=S}activate(f){this._terminal=f;const S=this._options,h=S.urlRegex||T;this._linkProvider=this._terminal.registerLinkProvider(new D.WebLinkProvider(this._terminal,h,this._handler,S))}dispose(){var f;(f=this._linkProvider)===null||f===void 0||f.dispose()}}})(),j})()))})(fe)),fe.exports}var Ae=Be();function Me({hostId:V,host:Y,sessionId:R,systemUserId:m,onClose:I}){const{t:j}=he(),{getWebSocket:W,setWebSocket:D,updateLastActive:T}=pe(),U=d.useRef(null),f=d.useRef(null),S=d.useRef(null),h=d.useRef(null),[L,p]=d.useState(!0),[y,C]=d.useState(null),[F,v]=d.useState(Y||null),[O,H]=d.useState(!1),z=d.useRef(null),G=d.useRef(null),M=d.useRef(!1),J=d.useRef(!1),$=d.useRef(null),Q=d.useRef(null),K=d.useRef(null),P=d.useRef(null);d.useEffect(()=>{Y?v(Y):F||xe(async()=>{const{mockHosts:e}=await import("./mockData-C1akHryx.js");return{mockHosts:e}},[]).then(({mockHosts:e})=>{const n=e.find(r=>r.id===V);n&&v(n)})},[V,Y]);const ee=d.useRef(new WeakSet),q=d.useCallback((e,n)=>{ee.current.has(e)||(ee.current.add(e),P.current&&(clearTimeout(P.current),P.current=null),P.current=setTimeout(()=>{if(!J.current&&e.readyState===WebSocket.OPEN){const r="连接超时：35秒内未收到任何数据，请检查主机配置和认证信息";console.error("[Terminal] Connection timeout:",r),$.current=r,C(r),p(!1),n.writeln(`\r
\r
\x1B[31m❌ 连接超时\x1B[0m`),n.writeln(`\x1B[31m${r}\x1B[0m`),n.writeln("\x1B[36m提示: 可以关闭此标签页或尝试重新连接\x1B[0m"),e.close()}},35e3),e.onopen=()=>{M.current=!0,p(!1),$.current=null,C(null),n.writeln(`\r
✓ WebSocket 连接已建立，正在建立会话...`),n.refresh(0,n.rows-1),e.send(JSON.stringify({type:"init",cols:n.cols,rows:n.rows})),K.current=setInterval(()=>{e.readyState===WebSocket.OPEN&&e.send(JSON.stringify({type:"ping"}))},3e4)},e.onmessage=r=>{P.current&&(clearTimeout(P.current),P.current=null);try{const o=JSON.parse(r.data);o.type==="output"?(J.current=!0,n.write(o.data)):o.type==="error"?(console.error("[Terminal] Received error message:",o.message),n.writeln(`\r
${j("common.error")}: ${o.message}`),$.current=o.message,C(o.message)):o.type==="info"?n.writeln(o.message):o.type==="data"&&(J.current=!0,n.write(o.data))}catch{J.current=!0,n.write(r.data)}},e.onerror=r=>{console.error("[Terminal] WebSocket error:",r),P.current&&(clearTimeout(P.current),P.current=null);const o="WebSocket连接错误，请检查网络连接或联系管理员";console.error("[Terminal] WebSocket connection error:",o),$.current=o,C(o),p(!1),f.current&&(f.current.writeln(`\r
\r
\x1B[31m❌ WebSocket连接错误\x1B[0m`),f.current.writeln(`\x1B[31m${o}\x1B[0m`))},e.onclose=r=>{if(p(!1),P.current&&(clearTimeout(P.current),P.current=null),K.current&&(clearInterval(K.current),K.current=null),e.__userClosed===!0)n.writeln(`\r
\r
连接已关闭`),I&&setTimeout(I,500);else{if(console.error("[Terminal] Connection closed unexpectedly:",{code:r.code,reason:r.reason||"Unknown reason",wasClean:r.wasClean}),n.writeln(`\r
\r
\x1B[31m❌ 连接已断开\x1B[0m`),$.current)n.writeln(`\x1B[31m${$.current}\x1B[0m`);else{let l="连接失败",x="";r.code===1006?(l="连接异常关闭",x="可能原因：网络问题、服务器拒绝连接或认证失败"):r.code===1e3?l="连接正常关闭":r.code===1001?(l="连接已断开（端点不可达）",x="服务器可能已关闭或网络不可达"):r.code===1002?(l="协议错误",x="WebSocket协议错误，请检查服务器配置"):r.code===1003?l="不支持的数据类型":r.code===1008?(l="策略违规",x="服务器拒绝了连接请求"):r.code===1011?(l="服务器错误",x="服务器内部错误，请稍后重试"):(l=`连接关闭 (代码: ${r.code})`,r.reason&&(x=`原因: ${r.reason}`));const E=x?`${l}
${x}`:l;$.current=E,C(E),n.writeln(`\x1B[31m${l}\x1B[0m`),x&&n.writeln(`\x1B[33m${x}\x1B[0m`)}n.writeln(`\r
\x1B[36m提示: 可以关闭此标签页或尝试重新连接\x1B[0m`)}},n.onData(r=>{T(R),e.readyState===WebSocket.OPEN&&e.send(JSON.stringify({type:"input",data:r}))}))},[I,R,T,j]),le=d.useCallback(async(e,n)=>{try{const r=W(R);if(r&&r.readyState===WebSocket.OPEN){h.current=r,q(r,e),p(!1),M.current=!0,e.writeln("连接已恢复"),e.writeln("");return}const o=await ze(n.id,m),l=new WebSocket(o);h.current=l,D(R,l),q(l,e)}catch(r){console.error("[Terminal] Failed to create WebSocket connection:",r);const l=`连接失败: ${r.message||"未知错误"}`;console.error("[Terminal] Connection error details:",l),$.current=l,C(l),p(!1),f.current&&(f.current.writeln(`\r
\r
\x1B[31m❌ 连接失败\x1B[0m`),f.current.writeln(`\x1B[31m${l}\x1B[0m`),f.current.writeln("\x1B[33m请检查网络连接和服务器状态\x1B[0m"))}},[R,m,W,D,q]);d.useEffect(()=>{const e=F;if(!U.current||!e)return;const n=W(R),r=!n||n.readyState===WebSocket.CLOSED,o=f.current!==null&&U.current!==null;if(Q.current===R&&!r&&o)return;if(Q.current&&(Q.current!==R||r||!o)&&(f.current&&(f.current.dispose(),f.current=null),M.current=!1,J.current=!1,$.current=null),Q.current=R,!G.current&&z.current){const i=z.current,t=window.getComputedStyle(i).height;t&&t!=="auto"&&t!=="0px"&&(G.current=t)}const l=new Le.Terminal({cursorBlink:!0,fontSize:16,fontFamily:'Menlo, Monaco, "Courier New", monospace',theme:{background:"#1e1e1e",foreground:"#d4d4d4",cursor:"#ffffff",black:"#000000",red:"#cd3131",green:"#0dbc79",yellow:"#ffd700",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5",brightBlack:"#666666",brightRed:"#f14c4c",brightGreen:"#23d18b",brightYellow:"#ffff00",brightBlue:"#3b8eea",brightMagenta:"#d670d6",brightCyan:"#29b8db",brightWhite:"#ffffff"},rows:30,cols:120,allowProposedApi:!0}),x=new Pe.FitAddon,E=new Ae.WebLinksAddon;l.loadAddon(x),l.loadAddon(E),l.open(U.current),x.fit(),f.current=l,S.current=x;const B=e.protocol?De(e.protocol):"SSH";l.writeln(`正在连接到 ${e.name} (${e.ip}:${e.port})...`),l.writeln(`使用协议: ${B}`),l.writeln(""),l.refresh(0,l.rows-1),le(l,e);const b=()=>{x.fit(),h.current?.readyState===WebSocket.OPEN&&h.current.send(JSON.stringify({type:"resize",cols:l.cols,rows:l.rows}))};window.addEventListener("resize",b);const k=()=>{const i=document,s=!!(document.fullscreenElement||i.webkitFullscreenElement||i.mozFullScreenElement||i.msFullscreenElement);H(s),setTimeout(()=>{if(S.current&&f.current&&(S.current.fit(),h.current?.readyState===WebSocket.OPEN&&h.current.send(JSON.stringify({type:"resize",cols:f.current.cols,rows:f.current.rows}))),!s&&z.current){const t=z.current;t.style.width="",t.style.height="",t.style.minHeight="",t.style.maxHeight=""}},100)};return document.addEventListener("fullscreenchange",k),document.addEventListener("webkitfullscreenchange",k),document.addEventListener("mozfullscreenchange",k),document.addEventListener("MSFullscreenChange",k),()=>{window.removeEventListener("resize",b),document.removeEventListener("fullscreenchange",k),document.removeEventListener("webkitfullscreenchange",k),document.removeEventListener("mozfullscreenchange",k),document.removeEventListener("MSFullscreenChange",k),P.current&&(clearTimeout(P.current),P.current=null),K.current&&(clearInterval(K.current),K.current=null)}},[V,R]),d.useEffect(()=>{if(!O&&z.current){const e=z.current,n=setTimeout(()=>{e.style.removeProperty("width"),e.style.removeProperty("height"),e.style.removeProperty("min-height"),e.style.removeProperty("max-height"),e.style.removeProperty("top"),e.style.removeProperty("left"),e.style.removeProperty("right"),e.style.removeProperty("bottom"),G.current&&(e.style.height=G.current),S.current&&(S.current.fit(),setTimeout(()=>{S.current&&S.current.fit()},50))},150);return()=>clearTimeout(n)}},[O]),d.useEffect(()=>{if(z.current&&!G.current){const e=z.current,n=setTimeout(()=>{const o=window.getComputedStyle(e).height;o&&o!=="auto"&&o!=="0px"&&(G.current=o)},100);return()=>clearTimeout(n)}},[L,y]);const de=()=>{h.current&&(h.current.__userClosed=!0,h.current.readyState===WebSocket.OPEN&&h.current.close()),I&&I()},a=async()=>{const e=z.current;if(e)try{const n=e,r=document;if(O)document.exitFullscreen?await document.exitFullscreen():r.webkitExitFullscreen?await r.webkitExitFullscreen():r.mozCancelFullScreen?await r.mozCancelFullScreen():r.msExitFullscreen&&await r.msExitFullscreen();else{const l=window.getComputedStyle(e).height;l&&l!=="auto"&&l!=="0px"&&(G.current=l),e.requestFullscreen?await e.requestFullscreen():n.webkitRequestFullscreen?await n.webkitRequestFullscreen():n.mozRequestFullScreen?await n.mozRequestFullScreen():n.msRequestFullscreen&&await n.msRequestFullscreen()}}catch(n){console.error("Error toggling fullscreen:",n)}};return d.useEffect(()=>{if(!L){const e=setTimeout(()=>{S.current&&f.current&&(S.current.fit(),h.current?.readyState===WebSocket.OPEN&&h.current.send(JSON.stringify({type:"resize",cols:f.current.cols,rows:f.current.rows})))},50);return()=>clearTimeout(e)}},[L]),u.jsxs(A,{sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",minHeight:0},children:[L&&u.jsx(A,{display:"flex",justifyContent:"center",alignItems:"center",p:3,children:u.jsx(we,{})}),y&&u.jsx(be,{severity:"error",sx:{mb:2},action:I&&u.jsx(Se,{color:"inherit",size:"small",onClick:de,children:j("common.close")}),children:u.jsxs(A,{children:[u.jsx("strong",{children:j("terminal.connectionFailed")}),u.jsx(A,{mt:1,children:y}),u.jsx(A,{mt:1,sx:{fontSize:"0.875rem",opacity:.8},children:j("terminal.checkHostConfig")})]})}),u.jsxs(ue,{ref:z,elevation:3,sx:{p:2,backgroundColor:"#1e1e1e",display:L||y?"none":"flex",flexDirection:"column",position:"relative",flex:1,minHeight:0,overflow:"hidden",...O?{position:"fixed",top:0,left:0,right:0,bottom:0,width:"100vw",height:"100vh",zIndex:9999,borderRadius:0,p:0}:{}},children:[u.jsx(A,{sx:{position:"absolute",top:8,right:8,zIndex:100,display:"flex",gap:1},children:u.jsx(Ee,{title:O?j("common.exitFullscreen")||"退出全屏":j("common.fullscreen")||"全屏",children:u.jsx(me,{size:"small",onClick:a,color:"primary",children:O?u.jsx(ve,{}):u.jsx(Ce,{})})})}),u.jsx("div",{ref:U,style:{height:"100%",width:"100%"}})]})]})}function $e({hostId:V,host:Y}){const{t:R}=he(),m=d.useRef(null),I=d.useRef(null),j=d.useRef(null),W=d.useRef(null),[D,T]=d.useState(!0),[U,f]=d.useState(R("terminal.connecting")),[S,h]=d.useState(null),[L,p]=d.useState(Y||null),[y,C]=d.useState(!1),[F,v]=d.useState(!1),O=d.useRef(!1),H=d.useRef(!1),z=d.useRef(null),G=d.useRef(null),M=d.useRef(null),J=d.useRef(!1),$=d.useRef(null),Q=d.useCallback(()=>{z.current=null,G.current=null},[]),K=(a,e)=>{let n,r;const o=I.current;if(a&&a.width>0&&a.height>0)n=a.width,r=a.height;else if(o){const s=o.getBoundingClientRect();n=s.width,r=s.height}else n=window.innerWidth,r=window.innerHeight;const l=4096,x=1940,E=960,B=1024,b=720;let k,i;if(e){const s=n/r,t=2560,c=1440;let g=Math.floor(n),w=Math.floor(r);(g<t||w<c)&&(s>t/c?(g=t,w=Math.floor(t/s)):(w=c,g=Math.floor(c*s))),k=Math.min(g,l),i=Math.min(w,l),k=Math.max(B,k),i=Math.max(b,i)}else n<x||r<E?(k=x,i=E):(k=Math.max(B,Math.floor(Math.min(n,l))),i=Math.max(b,Math.floor(Math.min(r,l))));return{width:k,height:i,actualWidth:n,actualHeight:r}},P=()=>{const a=M.current?.getElement?.();if(!a)return;const e=document,n=!!(document.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement);a.style.position="absolute",a.style.left="0",a.style.top="0",a.style.transformOrigin="top left",a.style.backgroundColor="#000",a.style.outline="none",a.style.border="none",a.style.margin="0",a.style.padding="0",a.style.zIndex="1",a.style.visibility="visible",a.style.opacity="1",a.style.display="block",a.style.overflow="hidden",n&&(a.style.width="100%",a.style.height="100%",a.style.transform=""),a.querySelectorAll("canvas").forEach(o=>{o.style.display="block",o.style.visibility="visible",o.style.opacity="1"})},ee=d.useCallback((a,e)=>{const n=M.current;if(!n?.getWidth||!n?.getHeight||!n?.scale)return;const r=n.getWidth(),o=n.getHeight();if(r<=0||o<=0)return;const l=document,x=!!(document.fullscreenElement||l.webkitFullscreenElement||l.mozFullScreenElement||l.msFullscreenElement);P();let E=r,B=o;if(z.current){const s=z.current.w,t=z.current.h;if(x)(r<s*.5||o<t*.5)&&(E=s,B=t);else{if(r<s*.3||o<t*.3)return;E=r,B=o}}const b=Math.max(a/E,e/B);let k=1;(E!==r||B!==o)&&(k=Math.max(E/r,B/o)),n.scale(b);const i=n.getElement?.();if(i){if(k!==1){const s=i.style.transform||"";if(s.includes("scale")){const t=s.match(/scale\(([^)]+)\)/);if(t){const c=parseFloat(t[1]);i.style.transform=`scale(${c*k})`}else i.style.transform=`${s} scale(${k})`}else i.style.transform=`scale(${k})`;i.style.transformOrigin="top left"}else i.style.transform="";i.style.left="0",i.style.top="0",i.style.right="auto",i.style.bottom="auto",i.style.marginLeft="0",i.style.marginTop="0",i.style.textAlign="left",i.style.visibility="visible",i.style.opacity="1",i.style.display="block"}},[]),q=d.useCallback((a,e)=>{if(!j.current||J.current)return;const n=document,r=e??!!(document.fullscreenElement||n.webkitFullscreenElement||n.mozFullScreenElement||n.msFullscreenElement);let o=a;if(r?o={width:window.innerWidth,height:window.innerHeight,x:0,y:0,top:0,left:0,right:window.innerWidth,bottom:window.innerHeight,toJSON:()=>({})}:(!a||a.width<=0||a.height<=0)&&(o=I.current?.getBoundingClientRect()||null),!o||o.width<=0||o.height<=0)return;const{width:l,height:x}=K(o,r),E=z.current;if(!E||E.w!==l||E.h!==x)try{j.current.sendSize(l,x),z.current={w:l,h:x}}catch{}ee(o.width,o.height)},[ee]),le=d.useCallback(()=>{const e=I.current?.getBoundingClientRect();e&&q(e,!!document.fullscreenElement)},[q]);d.useEffect(()=>{Y?p(Y):L||xe(async()=>{const{mockHosts:a}=await import("./mockData-C1akHryx.js");return{mockHosts:a}},[]).then(({mockHosts:a})=>{const e=a.find(n=>n.id===V);e&&p(e)})},[V,Y,L]),d.useCallback(a=>{try{if(!oe){h("Guacamole library not available"),T(!1);return}class e{static CLOSED=0;static OPEN=1;static CONNECTING=2;ws;clientRef;state=e.CLOSED;uuid=null;receiveTimeout=0;unstableThreshold=0;_onstatechange=null;_oninstruction=null;_onerror=null;_onuuid=null;parser=new oe.Parser;syncCount=0;recentSent=[];recentReceived=[];lastInputStreamId=null;constructor(s,t){this.ws=s,this.clientRef=t,this.state=s.readyState===WebSocket.OPEN?e.OPEN:e.CONNECTING,this.ws.onopen=()=>this.onOpen(),this.ws.onmessage=c=>this.onMessage(c),this.ws.onerror=c=>this.onError(c),this.ws.onclose=c=>this.onClose(c),this.parser.oninstruction=(c,g)=>{const w=`${c}:${g.map(_=>String(_)).join("|")}`;if(this.recentReceived.push(w),this.recentReceived.length>20&&this.recentReceived.shift(),c==="disconnect"){const _=g.map(N=>String(N));this.handleInstruction(c,_),this._oninstruction&&this._oninstruction(c,g)}else{this._oninstruction&&this._oninstruction(c,g);const _=g.map(N=>String(N));this.handleInstruction(c,_)}}}onOpen(){this.state=e.OPEN,this._onstatechange&&this._onstatechange(this.state),requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(this.clientRef.current&&this.clientRef.current.connect&&this.clientRef.current.state!==2)try{this.clientRef.current.connect()}catch{}})})}validateMessageFormat(s){if(!s||s.length===0||!s.endsWith(";"))return!1;const t=s.slice(0,-1);if(t.length===0)return!1;const c=t.split(";");for(const g of c){if(g.length===0)continue;const w=g.split(",");for(const _ of w){const N=_.trim();if(N.length===0)continue;const Z=N.indexOf(".");if(Z<=0)return!1;const te=N.substring(0,Z);if(te.length===0||!/^\d+$/.test(te))return!1;const re=parseInt(te,10);if(isNaN(re)||re<0||re>1e6||N.substring(Z+1).length!==re)return!1}}return!0}onMessage(s){try{const t=s.data;if(typeof t=="string"){if(t.startsWith("{")&&t.endsWith("}"))try{JSON.parse(t);return}catch{}if(t.includes("Error")||t.includes("error")){let c=t,g="";if(t.includes(",")){const w=t.split(",");if(w.length>=2){const _=w[0].trim(),N=w.slice(1).join(",").trim(),Z=_.match(/\d+/);if(Z)g=Z[0],c=N;else{c=N;const te=N.match(/\d+/);te&&(g=te[0])}}}else if(t.includes("(")&&t.includes(")")){const w=t.match(/\((\d+)\)/);w&&w.length>=2&&(g=w[1],c=t.replace(/\s*\(\d+\)\s*$/,"").trim())}g==="776"&&(c="服务器连接超时：请检查网络连接并尝试重新连接。"),this._onerror&&this._onerror({code:g&&parseInt(g,10)||500,message:c});return}try{if(!this.validateMessageFormat(t))return;this.parser.receive(t)}catch{this._onerror&&this._onerror({code:0,message:"协议解析错误，消息格式可能不正确。这可能是由于网络问题或服务器错误。"})}}}catch{}}onError(s){this.state=e.CLOSED,this._onstatechange&&this._onstatechange(this.state)}onClose(s){this.state=e.CLOSED,this._onstatechange&&this._onstatechange(this.state)}handleInstruction(s,t){if(s==="ready")this.state=e.OPEN,this._onstatechange&&this._onstatechange(this.state),this.clientRef.current&&this.clientRef.current.connect&&this.clientRef.current.state!==2&&this.clientRef.current.connect(),setTimeout(()=>{try{const c=M.current,g=c?.getElement?.();g&&(g.style.visibility="visible",g.style.opacity="1",g.style.display="block"),m.current&&(m.current.style.display="block",m.current.style.visibility="visible",m.current.style.opacity="1"),c&&P(),le()}catch{}},80);else if(s==="disconnect"){if(this.clientRef.current){const c=this.clientRef.current.state;c==null}this.state=e.CLOSED,this._onstatechange&&this._onstatechange(this.state),this._onerror&&this._onerror({code:0,message:"服务器发送了断开连接指令。这可能是由于临时错误或服务器问题。请尝试重新连接。"})}else if(s==="error"){let c="",g="";t.length>=1&&(c=t[0]),t.length>=2&&(g=t[1]),g==="776"?c="服务器连接超时：请检查网络连接并尝试重新连接。":!c&&g?c=`连接错误 (${g})`:c||(c="连接错误"),this._onerror&&this._onerror({code:g&&parseInt(g,10)||500,message:c})}else(s==="blob"||s==="end")&&t.length>0&&(this.lastInputStreamId=String(t[0])),!s.startsWith("img")&&!s.startsWith("rect")&&!s.startsWith("path")&&s==="sync"&&this.syncCount++}sendMessage(...s){try{if(this.ws.readyState!==WebSocket.OPEN)return;let t="";if(s.length>1)t=s.map(g=>{const w=String(g);return`${w.length}.${w}`}).join(",")+";";else{if(t=s.length===1?String(s[0]).trim():"",!t.includes(".")&&!t.includes(",")&&t==="ack"){const g=this.lastInputStreamId||"0",w="OK",_="0",N=Z=>`${Z.length}.${Z}`;t=`${N("ack")},${N(g)},${N(w)},${N(_)};`}else if(!t.includes(".")&&!t.includes(",")){const g=t;t=`${g.length}.${g};`}else t.endsWith(";")||(t=t+";");if((t.endsWith("sync;")||t.endsWith(".sync;"))&&!t.includes(",")){const g=Date.now().toString(),w=g.length;t=`${t.substring(0,t.length-1)},${w}.${g};`}}!t.startsWith("key,")&&!t.startsWith("mouse,")&&(t.startsWith("sync,")||t.startsWith("4.sync")?this.syncCount++:t.includes("disconnect")||t.includes("ack")),this.recentSent.push(t.substring(0,120)),this.recentSent.length>20&&this.recentSent.shift(),this.ws.send(t)}catch{}}disconnect(){(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING)&&this.ws.close(),this.state=e.CLOSED,this._onstatechange&&this._onstatechange(this.state)}connect(){this.ws.readyState===WebSocket.OPEN?(this.state=e.OPEN,this._onstatechange&&this._onstatechange(this.state)):(this.state=e.CONNECTING,this._onstatechange&&this._onstatechange(this.state))}isConnected(){return this.state===e.OPEN&&this.ws.readyState===WebSocket.OPEN}set onstatechange(s){this._onstatechange=s}set oninstruction(s){this._oninstruction=s}set onuuid(s){this._onuuid=s,s&&this.uuid&&s(this.uuid)}set onerror(s){this._onerror=s}}const n={current:null},r=new e(a,n),o=new oe.Client(r);j.current=o,n.current=o;const l=o.getDisplay();M.current=l;const x=l.getElement();if(Q(),P(),x.style.cursor="default",l.onresize=()=>{const i=M.current;if(!i)return;const s=i.getWidth(),t=i.getHeight();if(s<=0||t<=0)return;const c=i.getElement?.();c&&(!c.parentElement&&m.current&&m.current.appendChild(c),c.style.visibility="visible",c.style.opacity="1",c.style.display="block",c.querySelectorAll("canvas").forEach(N=>{N.style.display="block",N.style.visibility="visible",N.style.opacity="1"})),m.current&&(m.current.style.display="block",m.current.style.visibility="visible",m.current.style.opacity="1");const w=I.current?.getBoundingClientRect();w&&w.width>0&&w.height>0&&q(w,!!document.fullscreenElement)},m.current){const i=m.current.querySelector('[class*="guac"]');i&&i!==x&&i.remove(),m.current.contains(x)||(m.current.innerHTML="",m.current.appendChild(x)),m.current.style.display="block",m.current.style.visibility="visible",m.current.style.opacity="1"}P(),x&&(x.style.visibility="visible",x.style.opacity="1",x.style.display="block",!x.parentElement&&m.current&&m.current.appendChild(x)),W.current&&(W.current.disconnect(),W.current=null),setTimeout(()=>{const i=I.current,s=M.current;if(!i||!s)return;const t=s.getElement?.();t&&!t.parentElement&&m.current&&(m.current.appendChild(t),P());const c=i.getBoundingClientRect();if(c.width>0&&c.height>0&&s.getWidth&&s.getHeight){const w=s.getWidth(),_=s.getHeight();w>0&&_>0&&q(c,!!document.fullscreenElement)}const g=i.getBoundingClientRect();g.width>0&&g.height>0&&q(g,!!document.fullscreenElement)},300);const E=new oe.Keyboard(x);E.onkeydown=i=>{o.sendKeyEvent(1,i)},E.onkeyup=i=>{o.sendKeyEvent(0,i)};const B=new oe.Mouse(x);B.onmousedown=i=>{o.sendMouseState(i)},B.onmouseup=i=>{o.sendMouseState(i)},B.onmousemove=i=>{o.sendMouseState(i)};let b=null,k=null;o.onstatechange=i=>{k=i;const s=0,t=2,c=1,g=3,w=4;if(i==null||i<0||i>4)if(b&&(clearTimeout(b),b=null),j.current){const _=j.current.state;_!=null?(i=_,k=i):(i=w,k=i)}else i=w,k=i;if(i===t){h(null),O.current=!0,v(!0),H.current=!0;const _=()=>{const ce=I.current,X=M.current,se=X?.getElement?.();m.current&&(m.current.style.display="block",m.current.style.visibility="visible",m.current.style.opacity="1"),se&&(P(),se.querySelectorAll("canvas").forEach(ie=>{ie.style.display="block",ie.style.visibility="visible",ie.style.opacity="1"}));const ne=ce?.getBoundingClientRect();if(ne&&ne.width>0&&ne.height>0&&X?.getWidth&&X?.getHeight){const ge=X.getWidth(),ie=X.getHeight();ge>0&&ie>0&&q(ne,y)}se&&!se.parentElement&&m.current&&m.current.appendChild(se)};_(),setTimeout(_,200),setTimeout(_,500),setTimeout(_,1e3);let N=null;const Z=Date.now(),te=1e4,re=()=>{if(Date.now()-Z>te){N!==null&&cancelAnimationFrame(N);return}const X=M.current?.getElement?.();X&&(X.style.visibility="visible",X.style.opacity="1",X.style.display="block",X.querySelectorAll("canvas").forEach(ne=>{ne.style.display="block",ne.style.visibility="visible",ne.style.opacity="1"})),N=requestAnimationFrame(re)};N=requestAnimationFrame(re),b&&clearTimeout(b),f(R("terminal.establishingConnection")),b=setTimeout(()=>{if(!j.current){h(R("terminal.clientLost")),T(!1),O.current=!1,b=null;return}if(k==null){H.current||h(R("terminal.clientStateError")),T(!1),O.current=!1,b=null;return}if(k===4||k===3){H.current||h(R("rdp.disconnected")||"Disconnected"),T(!1),O.current=!1,b=null;return}if(k!==2){f("连接中..."),b=null;return}f(R("terminal.connectionSuccess")),h(null),v(!0),setTimeout(()=>{T(!1)},500),b=null},1e3)}else i===w?(O.current=!1,v(!1),H.current||h(R("terminal.connectionFailed")),T(!1),b&&(clearTimeout(b),b=null)):i===s?f(R("terminal.connecting")):i===c?f(R("terminal.waitingConnection")):i===g&&v(!1)},o.onerror=i=>{let s="Unknown error",t="",c="";if(i){const w=i;if("code"in w&&w.code!==void 0)switch(t=w.code.toString(),c=w.message||w.reason||"",w.code){case 519:s="服务器拒绝连接：安全类型不匹配。请检查服务器是否支持当前安全模式，或联系管理员。";break;case 512:s="连接被服务器拒绝：用户名或密码错误。";break;case 513:s="连接被服务器拒绝：权限不足。";break;case 514:s="连接超时：无法连接到服务器。";break;default:s=`错误 ${t}${c?": "+c:""}`}else{const _=i;_.message?s=_.message:s=_.toString()}}const g=R("rdp.clientError")||"Client error: "+s;h(g),T(!1)},a.readyState===WebSocket.OPEN&&(r.state=e.OPEN,r._onstatechange&&r._onstatechange(r.state),requestAnimationFrame(()=>{requestAnimationFrame(()=>{try{o.state!==2&&o.connect()}catch{}})}))}catch(e){h((R("rdp.setupFailed")||"Setup failed")+": "+e.message),T(!1)}},[h,T,v,f,R,m,j,q,Q,y,le]);const de=async()=>{const a=I.current;if(a)try{const e=a,n=document;y?document.exitFullscreen?await document.exitFullscreen():n.webkitExitFullscreen?await n.webkitExitFullscreen():n.mozCancelFullScreen?await n.mozCancelFullScreen():n.msExitFullscreen&&await n.msExitFullscreen():a.requestFullscreen?await a.requestFullscreen():e.webkitRequestFullscreen?await e.webkitRequestFullscreen():e.mozRequestFullScreen?await e.mozRequestFullScreen():e.msRequestFullscreen&&await e.msRequestFullscreen()}catch{}};return d.useEffect(()=>{const a=()=>{const n=document,r=!!(document.fullscreenElement||n.webkitFullscreenElement||n.mozFullScreenElement||n.msFullscreenElement);C(r),J.current=!0;const o=()=>{if(j.current)if(r){const l={width:window.innerWidth,height:window.innerHeight,x:0,y:0,top:0,left:0,right:window.innerWidth,bottom:window.innerHeight,toJSON:()=>({})};$.current&&clearTimeout($.current),q(l,r),setTimeout(()=>{J.current=!1},500)}else{const l=G.current;if(l&&j.current){try{j.current.sendSize(l.w,l.h),z.current={w:l.w,h:l.h}}catch{}const x=I.current;if(x){const E=x.getBoundingClientRect();E&&E.width>0&&E.height>0&&setTimeout(()=>{const B=M.current;if(B?.getWidth?.()&&B?.getHeight?.()){ee(E.width,E.height);const b=B?.getElement?.();b&&(b.style.left="0",b.style.top="0",b.style.right="auto",b.style.bottom="auto",b.style.marginLeft="0",b.style.marginTop="0",b.style.transformOrigin="top left",b.style.transform="")}},500)}}else{const x=I.current;if(!x)return;const E=x.getBoundingClientRect();if(E&&E.width>0&&E.height>0){q(E,r);const b=M.current?.getElement?.();b&&(b.style.left="0",b.style.top="0",b.style.right="auto",b.style.bottom="auto",b.style.marginLeft="0",b.style.marginTop="0",b.style.transformOrigin="top left")}}}};setTimeout(()=>{o(),setTimeout(()=>{requestAnimationFrame(o)},100)},100)};document.addEventListener("fullscreenchange",a),document.addEventListener("webkitfullscreenchange",a),document.addEventListener("mozfullscreenchange",a),document.addEventListener("MSFullscreenChange",a);const e=n=>{n.key==="Escape"&&y&&setTimeout(()=>{a()},100)};return window.addEventListener("keydown",e),()=>{document.removeEventListener("fullscreenchange",a),document.removeEventListener("webkitfullscreenchange",a),document.removeEventListener("mozfullscreenchange",a),document.removeEventListener("MSFullscreenChange",a),window.removeEventListener("keydown",e)}},[y,q,ee]),d.useEffect(()=>{const a=I.current;if(!a)return;let e=null;const n=new ResizeObserver(o=>{if(J.current)return;const l=o[0];if(!l||!l.target)return;const x=l.target.getBoundingClientRect();e&&cancelAnimationFrame(e),e=requestAnimationFrame(()=>{const E=document,B=!!(document.fullscreenElement||E.webkitFullscreenElement||E.mozFullScreenElement||E.msFullscreenElement);$.current&&clearTimeout($.current),$.current=window.setTimeout(()=>{q(x,B)},100)})});n.observe(a);const r=a.getBoundingClientRect();return q(r,!!document.fullscreenElement),()=>{e&&cancelAnimationFrame(e),n.disconnect(),W.current&&(W.current.disconnect(),W.current=null)}},[ee,q]),u.jsxs(A,{sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",position:"relative",overflow:"hidden"},children:[D&&u.jsxs(A,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.7)",zIndex:1e3,gap:2},children:[u.jsx(we,{size:60,sx:{color:"primary.main"}}),u.jsx(A,{sx:{color:"white",fontSize:"16px",fontWeight:500,textAlign:"center"},children:U})]}),!F&&S&&u.jsx(be,{severity:"error",sx:{mb:2},children:S}),u.jsxs(ue,{ref:I,sx:{width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%",display:"flex",flexDirection:"column",position:"relative",overflow:"hidden",flex:1,minHeight:0,"&:fullscreen, &:-webkit-full-screen, &:-moz-full-screen, &:-ms-fullscreen":{width:"100vw !important",height:"100vh !important",maxWidth:"100vw !important",maxHeight:"100vh !important",margin:0,padding:0}},children:[u.jsx(A,{sx:{position:"absolute",top:8,right:8,zIndex:100,display:"flex",gap:1},children:u.jsx(Ee,{title:y?R("common.exitFullscreen")||"Exit Fullscreen":R("common.fullscreen")||"Fullscreen",children:u.jsx(me,{size:"small",onClick:de,color:"primary",children:y?u.jsx(ve,{}):u.jsx(Ce,{})})})}),u.jsx(A,{ref:m,sx:{flex:1,width:"100%",height:"100%",minHeight:0,backgroundColor:"#000",overflow:"hidden",position:"relative",...y&&{width:"100vw",height:"100vh",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:9999},...y&&{"& > div":{width:"100% !important",height:"100% !important",transform:"none !important","& > div":{width:"100% !important",height:"100% !important",transform:"none !important"}}}}})]})]})}function Ke(){const{t:V}=he(),Y=ke(),R=Re(),{sessions:m,removeSession:I,addSession:j}=pe(),[W,D]=d.useState(0),[T,U]=d.useState(""),[f,S]=d.useState("/");d.useEffect(()=>{const p=sessionStorage.getItem("terminal_previous_path")||"/";S(p)},[]),d.useEffect(()=>{(async()=>{try{const C=await(await fetch("/api/system-users",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}})).json(),F=C.data||C||[];F.length>0&&!T&&U(F[0].id)}catch(y){console.error("加载系统用户失败:",y)}})()},[T]),d.useEffect(()=>{W>=m.length&&m.length>0&&D(m.length-1)},[m.length,W]);const h=(p,y)=>{const F=m.find(v=>v.id===p)?.wsConnection;F&&F.readyState===WebSocket.OPEN&&(console.log(`[TerminalPage] User manually closing WebSocket for session ${p}`),F.__userClosed=!0,F.close()),I(p),W===y&&y>0&&D(y-1)},L=async p=>{try{const y=m.find(v=>v.host.id===p.id);if(y){const v=m.findIndex(O=>O.id===y.id);D(v);return}const C=await je.getHost(p.id);let F=T;if(!F)try{const O=await(await fetch(`/api/system-users/available?hostId=${p.id}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}})).json(),H=Array.isArray(O.data)?O.data:O.data?.data||[];if(H.length===0){alert("没有可用的系统用户，请联系管理员配置权限");return}else H.length,F=H[0].id}catch(v){console.error("获取系统用户失败:",v)}j(C,F||void 0),setTimeout(()=>{const v=m.length;D(v)},100)}catch(y){console.error("连接主机失败:",y),alert("连接主机失败: "+y.message)}};return u.jsxs(A,{sx:{height:"100vh",width:"100vw",display:"flex",flexDirection:"column",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1300,bgcolor:"background.default",overflow:"hidden"},children:[u.jsx(Fe,{position:"static",color:"default",elevation:1,sx:{flexShrink:0},children:u.jsxs(Te,{children:[u.jsx(me,{edge:"start",onClick:()=>Y(f),sx:{mr:2},children:u.jsx(_e,{})}),u.jsx(ae,{variant:"h6",sx:{flexGrow:1},children:V("terminal.title")}),m.length>0&&u.jsx(ae,{variant:"body2",color:"text.secondary",sx:{mr:2},children:V("terminal.activeSessions",{count:m.length})}),u.jsx(Se,{variant:"outlined",startIcon:u.jsx(Ne,{}),onClick:()=>{sessionStorage.setItem("file_management_previous_path",R.pathname),window.open("/file-management","_blank")},sx:{textTransform:"none",mr:1},children:"文件管理"})]})}),u.jsxs(A,{sx:{flex:1,minHeight:0,width:"100%",display:"flex",gap:2,p:2,overflow:"hidden"},children:[u.jsx(A,{sx:{width:"300px",flexShrink:0,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:u.jsx(He,{onHostClick:L})}),u.jsx(A,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:m.length===0?u.jsxs(ue,{sx:{p:4,textAlign:"center",flex:1,display:"flex",flexDirection:"column",justifyContent:"center"},children:[u.jsx(ae,{variant:"h6",gutterBottom:!0,color:"text.secondary",children:V("terminal.noOpenSessions")}),u.jsx(ae,{variant:"body2",color:"text.secondary",children:"从左侧主机树选择主机进行连接"})]}):u.jsxs(u.Fragment,{children:[u.jsx(ue,{sx:{mb:2,flexShrink:0},children:u.jsx(We,{value:W,onChange:(p,y)=>D(y),variant:"scrollable",scrollButtons:"auto",children:m.map((p,y)=>u.jsx(Oe,{label:u.jsxs(A,{display:"flex",alignItems:"center",gap:1,children:[u.jsx("span",{children:p.host.name.toLowerCase()}),u.jsxs("span",{style:{fontSize:"0.8em",opacity:.7},children:["(",p.host.ip,")"]}),u.jsx(A,{component:"span",onClick:C=>{C.stopPropagation(),h(p.id,y)},sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:20,height:20,borderRadius:"50%",cursor:"pointer",ml:.5,"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.08)"}},children:u.jsx(Ie,{sx:{fontSize:16}})})]}),sx:{textTransform:"none"}},p.id))})}),u.jsx(A,{sx:{flex:1,minHeight:0,width:"100%",display:"flex",flexDirection:"column",overflow:"hidden"},children:m.map((p,y)=>u.jsx(A,{sx:{display:W===y?"flex":"none",flex:1,width:"100%",minHeight:0,flexDirection:"column",overflow:"hidden"},children:p.host.deviceType==="windows"?u.jsx($e,{hostId:p.host.id,host:p.host,sessionId:p.id,systemUserId:p.systemUserId,onClose:()=>h(p.id,y)}):u.jsx(Me,{hostId:p.host.id,host:p.host,sessionId:p.id,systemUserId:p.systemUserId,onClose:()=>h(p.id,y)})},p.id))})]})})]})]})}export{Ke as default};
