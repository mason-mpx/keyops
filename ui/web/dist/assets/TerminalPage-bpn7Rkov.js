import{u as he,b1 as xe,r as h,aR as we,j as u,B as M,C as be,b as Se,a as ve,P as de,d as Ee,I as me,aY as Ce,aZ as ke,ax as Re,b2 as Fe,ay as Te,az as _e,aA as Ne,T as ue,aq as We,a3 as Ie,a4 as Oe,aB as je,z as Le}from"./index-Cih9_E47.js";import{x as ze,a as Pe}from"./xterm-BqYE0GQX.js";import{a as ye,g as Be,c as De}from"./websocket-Bdab7s0d.js";import{G as le}from"./guacamole-common-DCnKliOq.js";import{H as He}from"./HostTree-Brur6XFP.js";import"./Chip-D6-9bdkU.js";var fe={exports:{}},pe;function Me(){return pe||(pe=1,(function(q,V){(function(T,d){q.exports=d()})(self,(()=>(()=>{var T={6:(O,P)=>{Object.defineProperty(P,"__esModule",{value:!0}),P.LinkComputer=P.WebLinkProvider=void 0,P.WebLinkProvider=class{constructor(A,w,v,m={}){this._terminal=A,this._regex=w,this._handler=v,this._options=m}provideLinks(A,w){const v=_.computeLink(A,this._regex,this._terminal,this._handler);w(this._addCallbacks(v))}_addCallbacks(A){return A.map((w=>(w.leave=this._options.leave,w.hover=(v,m)=>{if(this._options.hover){const{range:B}=w;this._options.hover(v,m,B)}},w)))}};class _{static computeLink(w,v,m,B){const b=new RegExp(v.source,(v.flags||"")+"g"),[x,R]=_._getWindowedLineStrings(w-1,m),E=x.join("");let k;const W=[];for(;k=b.exec(E);){const D=k[0];try{const K=new URL(D),U=decodeURI(K.toString());if(D!==U&&D+"/"!==U)continue}catch{continue}const[G,ee]=_._mapStrIdx(m,R,0,k.index),[j,$]=_._mapStrIdx(m,G,ee,D.length);if(G===-1||ee===-1||j===-1||$===-1)continue;const Z={start:{x:ee+1,y:G+1},end:{x:$,y:j+1}};W.push({range:Z,text:D,activate:B})}return W}static _getWindowedLineStrings(w,v){let m,B=w,b=w,x=0,R="";const E=[];if(m=v.buffer.active.getLine(w)){const k=m.translateToString(!0);if(m.isWrapped&&k[0]!==" "){for(x=0;(m=v.buffer.active.getLine(--B))&&x<2048&&(R=m.translateToString(!0),x+=R.length,E.push(R),m.isWrapped&&R.indexOf(" ")===-1););E.reverse()}for(E.push(k),x=0;(m=v.buffer.active.getLine(++b))&&m.isWrapped&&x<2048&&(R=m.translateToString(!0),x+=R.length,E.push(R),R.indexOf(" ")===-1););}return[E,B]}static _mapStrIdx(w,v,m,B){const b=w.buffer.active,x=b.getNullCell();let R=m;for(;B;){const E=b.getLine(v);if(!E)return[-1,-1];for(let k=R;k<E.length;++k){E.getCell(k,x);const W=x.getChars();if(x.getWidth()&&(B-=W.length||1,k===E.length-1&&W==="")){const D=b.getLine(v+1);D&&D.isWrapped&&(D.getCell(0,x),x.getWidth()===2&&(B+=1))}if(B<0)return[v,k]}v++,R=0}return[v,R]}}P.LinkComputer=_}},d={};function L(O){var P=d[O];if(P!==void 0)return P.exports;var _=d[O]={exports:{}};return T[O](_,_.exports,L),_.exports}var H={};return(()=>{var O=H;Object.defineProperty(O,"__esModule",{value:!0}),O.WebLinksAddon=void 0;const P=L(6),_=/https?:[/]{2}[^\s"'!*(){}|\\\^<>`]*[^\s"':,.!?{}|\\\^~\[\]`()<>]/;function A(w,v){const m=window.open();if(m){try{m.opener=null}catch{}m.location.href=v}else console.warn("Opening link blocked as opener could not be cleared")}O.WebLinksAddon=class{constructor(w=A,v={}){this._handler=w,this._options=v}activate(w){this._terminal=w;const v=this._options,m=v.urlRegex||_;this._linkProvider=this._terminal.registerLinkProvider(new P.WebLinkProvider(this._terminal,m,this._handler,v))}dispose(){var w;(w=this._linkProvider)===null||w===void 0||w.dispose()}}})(),H})()))})(fe)),fe.exports}var Ae=Me();function $e({hostId:q,host:V,sessionId:T,systemUserId:d,onClose:L}){const{t:H}=he(),{getWebSocket:O,setWebSocket:P,updateLastActive:_}=xe(),A=h.useRef(null),w=h.useRef(null),v=h.useRef(null),m=h.useRef(null),[B,b]=h.useState(!0),[x,R]=h.useState(null),[E,k]=h.useState(V||null),[W,D]=h.useState(!1),[G,ee]=h.useState(!1),j=h.useRef(null),$=h.useRef(null),Z=h.useRef(!1),K=h.useRef(!1),U=h.useRef(null),Q=h.useRef(!1),J=h.useRef(null),F=h.useRef(null);h.useEffect(()=>{V?k(V):E||we(async()=>{const{mockHosts:e}=await import("./mockData-C1akHryx.js");return{mockHosts:e}},[]).then(({mockHosts:e})=>{const t=e.find(o=>o.id===q);t&&k(t)})},[q,V]);const ie=h.useCallback((e,t,o)=>{F.current&&(clearTimeout(F.current),F.current=null),F.current=setTimeout(()=>{if(!K.current&&e.readyState===WebSocket.OPEN){const i="连接超时：35秒内未收到任何数据，请检查主机配置和认证信息";console.error("[Terminal] Connection timeout:",i),U.current=i,R(i),b(!1),t.writeln(`\r
\r
\x1B[31m❌ 连接超时\x1B[0m`),t.writeln(`\x1B[31m${i}\x1B[0m`),t.writeln("\x1B[36m提示: 可以关闭此标签页或尝试重新连接\x1B[0m"),e.close()}},35e3),e.onopen=()=>{Z.current=!0,b(!1),U.current=null,R(null),console.log("[Terminal] WebSocket opened, connecting to host:",o.name,o.ip,o.port),t.writeln(`正在使用 ${ye(o.protocol)} 协议连接...`),t.writeln(`目标主机: ${o.name} (${o.ip}:${o.port})`),t.writeln(""),e.send(JSON.stringify({type:"init",cols:t.cols,rows:t.rows})),J.current=setInterval(()=>{e.readyState===WebSocket.OPEN&&(e.send(JSON.stringify({type:"ping"})),console.log("[Terminal] Sent keep-alive ping"))},3e4)},e.onmessage=i=>{F.current&&(clearTimeout(F.current),F.current=null);try{const s=JSON.parse(i.data);if(console.log("[Terminal] Received message:",s.type,s),s.type==="output")K.current=!0,t.write(s.data);else if(s.type==="error"){K.current=!1;const f=s.message||"连接失败，请检查主机配置和认证信息";console.error("[Terminal] Connection error:",f),t.writeln(`\r
\r
\x1B[31m❌ 连接失败\x1B[0m`),t.writeln(`\x1B[31m错误信息: ${f}\x1B[0m`),t.writeln("\x1B[33m提示: 请检查以下配置：\x1B[0m"),t.writeln("  1. 主机IP和端口是否正确"),t.writeln("  2. 系统用户的用户名和密码/密钥是否正确"),t.writeln("  3. SSH服务器是否允许密码认证（如果使用密码）"),t.writeln("  4. 密钥是否已添加到服务器的authorized_keys（如果使用密钥）"),t.writeln(""),U.current=f,R(f),b(!1)}else s.type==="info"?(console.log("[Terminal] Info message:",s.message),t.writeln(s.message)):s.type==="data"?(K.current=!0,t.write(s.data)):console.warn("[Terminal] Unknown message type:",s.type,s)}catch{console.log("[Terminal] Non-JSON message, treating as raw data"),K.current=!0,t.write(i.data)}},e.onerror=i=>{console.error("[Terminal] WebSocket error:",i),F.current&&(clearTimeout(F.current),F.current=null);const s="WebSocket连接错误，请检查网络连接或联系管理员";console.error("[Terminal] WebSocket connection error:",s),U.current=s,R(s),b(!1),w.current&&(w.current.writeln(`\r
\r
\x1B[31m❌ WebSocket连接错误\x1B[0m`),w.current.writeln(`\x1B[31m${s}\x1B[0m`))},e.onclose=i=>{if(console.log("[Terminal] WebSocket closed:",{code:i.code,reason:i.reason,wasClean:i.wasClean,hasError:!!U.current}),b(!1),F.current&&(clearTimeout(F.current),F.current=null),J.current&&(clearInterval(J.current),J.current=null),e.__userClosed===!0)console.log("[Terminal] User closed connection"),t.writeln(`\r
\r
连接已关闭`),L&&setTimeout(L,500);else{if(console.error("[Terminal] Connection closed unexpectedly:",{code:i.code,reason:i.reason||"Unknown reason",wasClean:i.wasClean}),t.writeln(`\r
\r
\x1B[31m❌ 连接已断开\x1B[0m`),U.current)t.writeln(`\x1B[31m${U.current}\x1B[0m`);else{let f="连接失败",C="";i.code===1006?(f="连接异常关闭",C="可能原因：网络问题、服务器拒绝连接或认证失败"):i.code===1e3?f="连接正常关闭":i.code===1001?(f="连接已断开（端点不可达）",C="服务器可能已关闭或网络不可达"):i.code===1002?(f="协议错误",C="WebSocket协议错误，请检查服务器配置"):i.code===1003?f="不支持的数据类型":i.code===1008?(f="策略违规",C="服务器拒绝了连接请求"):i.code===1011?(f="服务器错误",C="服务器内部错误，请稍后重试"):(f=`连接关闭 (代码: ${i.code})`,i.reason&&(C=`原因: ${i.reason}`));const y=C?`${f}
${C}`:f;U.current=y,R(y),t.writeln(`\x1B[31m${f}\x1B[0m`),C&&t.writeln(`\x1B[33m${C}\x1B[0m`)}t.writeln(`\r
\x1B[36m提示: 可以关闭此标签页或尝试重新连接\x1B[0m`)}},t.onData(i=>{_(T),e.readyState===WebSocket.OPEN&&e.send(JSON.stringify({type:"input",data:i}))})},[L,T,_]),ce=h.useCallback(async(e,t)=>{try{const o=O(T);if(o&&o.readyState===WebSocket.OPEN){console.log("[Terminal] Reusing existing WebSocket connection from Context"),m.current=o,ie(o,e,t),b(!1),Z.current=!0,console.log("[Terminal] Connection restored from Context"),e.writeln("连接已恢复"),e.writeln("");return}console.log(`正在创建会话: ${Be(t.deviceType)} (${ye(t.protocol)})`);const i=await De(t.id,d);console.log(`WebSocket URL: ${i}${d?` (SystemUser: ${d})`:""}`);const s=new WebSocket(i);m.current=s,P(T,s),ie(s,e,t)}catch(o){console.error("[Terminal] Failed to create WebSocket connection:",o);const s=`连接失败: ${o.message||"未知错误"}`;console.error("[Terminal] Connection error details:",s),U.current=s,R(s),b(!1),w.current&&(w.current.writeln(`\r
\r
\x1B[31m❌ 连接失败\x1B[0m`),w.current.writeln(`\x1B[31m${s}\x1B[0m`),w.current.writeln("\x1B[33m请检查网络连接和服务器状态\x1B[0m"))}},[T,d,O,P,ie]);h.useEffect(()=>{if(console.log("[Terminal useEffect] hostId:",q,"hostInfo:",E,"initialized:",Q.current,"sessionId:",T),!A.current||!E){console.log("[Terminal] Skipping initialization:",{noRef:!A.current,noHostInfo:!E});return}if(Q.current){console.log("[Terminal] Already initialized for session:",T,"- skipping");return}if(Q.current=!0,console.log("[Terminal] Initializing terminal and connecting for session:",T),!$.current&&j.current){const f=j.current,y=window.getComputedStyle(f).height;y&&y!=="auto"&&y!=="0px"&&($.current=y)}const e=new ze.Terminal({cursorBlink:!0,fontSize:14,fontFamily:'Menlo, Monaco, "Courier New", monospace',theme:{background:"#1e1e1e",foreground:"#d4d4d4",cursor:"#ffffff",black:"#000000",red:"#cd3131",green:"#0dbc79",yellow:"#e5e510",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5",brightBlack:"#666666",brightRed:"#f14c4c",brightGreen:"#23d18b",brightYellow:"#f5f543",brightBlue:"#3b8eea",brightMagenta:"#d670d6",brightCyan:"#29b8db",brightWhite:"#e5e5e5"},rows:30,cols:120}),t=new Pe.FitAddon,o=new Ae.WebLinksAddon;e.loadAddon(t),e.loadAddon(o),e.open(A.current),t.fit(),w.current=e,v.current=t,ce(e,E);const i=()=>{t.fit(),m.current?.readyState===WebSocket.OPEN&&m.current.send(JSON.stringify({type:"resize",cols:e.cols,rows:e.rows}))};window.addEventListener("resize",i);const s=()=>{const f=document,C=!!(document.fullscreenElement||f.webkitFullscreenElement||f.mozFullScreenElement||f.msFullscreenElement);D(C),setTimeout(()=>{if(v.current&&w.current&&(v.current.fit(),m.current?.readyState===WebSocket.OPEN&&m.current.send(JSON.stringify({type:"resize",cols:w.current.cols,rows:w.current.rows}))),!C&&j.current){const y=j.current;y.style.width="",y.style.height="",y.style.minHeight="",y.style.maxHeight=""}},100)};return document.addEventListener("fullscreenchange",s),document.addEventListener("webkitfullscreenchange",s),document.addEventListener("mozfullscreenchange",s),document.addEventListener("MSFullscreenChange",s),()=>{console.log("[Terminal] Cleanup: Component unmounting for hostId:",q),window.removeEventListener("resize",i),document.removeEventListener("fullscreenchange",s),document.removeEventListener("webkitfullscreenchange",s),document.removeEventListener("mozfullscreenchange",s),document.removeEventListener("MSFullscreenChange",s),F.current&&(clearTimeout(F.current),F.current=null),J.current&&(clearInterval(J.current),J.current=null),m.current&&console.log("[Terminal] Cleanup: Keeping WebSocket alive in Context"),w.current&&(console.log("[Terminal] Cleanup: Disposing terminal UI"),w.current.dispose(),w.current=null)}},[q,T,E,ce]),h.useEffect(()=>{if(!W&&j.current){const e=j.current,t=setTimeout(()=>{e.style.removeProperty("width"),e.style.removeProperty("height"),e.style.removeProperty("min-height"),e.style.removeProperty("max-height"),e.style.removeProperty("top"),e.style.removeProperty("left"),e.style.removeProperty("right"),e.style.removeProperty("bottom"),$.current&&(e.style.height=$.current),v.current&&(v.current.fit(),setTimeout(()=>{v.current&&v.current.fit()},50))},150);return()=>clearTimeout(t)}},[W]),h.useEffect(()=>{if(j.current&&!$.current){const e=j.current,t=setTimeout(()=>{const i=window.getComputedStyle(e).height;i&&i!=="auto"&&i!=="0px"&&($.current=i)},100);return()=>clearTimeout(t)}},[B,x]);const a=()=>{m.current&&(m.current.__userClosed=!0,m.current.readyState===WebSocket.OPEN&&m.current.close()),L&&L()},g=async()=>{const e=j.current;if(e)try{const t=e,o=document;if(W)document.exitFullscreen?await document.exitFullscreen():o.webkitExitFullscreen?await o.webkitExitFullscreen():o.mozCancelFullScreen?await o.mozCancelFullScreen():o.msExitFullscreen&&await o.msExitFullscreen();else{const s=window.getComputedStyle(e).height;s&&s!=="auto"&&s!=="0px"&&($.current=s),e.requestFullscreen?await e.requestFullscreen():t.webkitRequestFullscreen?await t.webkitRequestFullscreen():t.mozRequestFullScreen?await t.mozRequestFullScreen():t.msRequestFullscreen&&await t.msRequestFullscreen()}}catch(t){console.error("Error toggling fullscreen:",t)}};return u.jsxs(M,{children:[B&&u.jsx(M,{display:"flex",justifyContent:"center",alignItems:"center",p:3,children:u.jsx(be,{})}),x&&u.jsx(Se,{severity:"error",sx:{mb:2},action:L&&u.jsx(ve,{color:"inherit",size:"small",onClick:a,children:H("common.close")}),children:u.jsxs(M,{children:[u.jsx("strong",{children:H("terminal.connectionFailed")}),u.jsx(M,{mt:1,children:x}),u.jsx(M,{mt:1,sx:{fontSize:"0.875rem",opacity:.8},children:H("terminal.checkHostConfig")})]})}),u.jsxs(de,{ref:j,elevation:3,sx:{backgroundColor:"#1e1e1e",display:B||x?"none":"flex",flexDirection:"column",position:W?"fixed":"relative",flex:1,minHeight:0,...W?{top:0,left:0,right:0,bottom:0,width:"100vw",height:"100vh",zIndex:9999,borderRadius:0,p:0}:{p:2,width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%",minHeight:0,top:"auto",left:"auto",right:"auto",bottom:"auto"}},onMouseEnter:()=>ee(!0),onMouseLeave:()=>!W&&ee(!1),children:[u.jsx("div",{ref:A,style:{height:"100%",width:"100%",flex:1,minHeight:0}}),(G||W)&&u.jsx(Ee,{title:W?"退出全屏":"全屏",children:u.jsx(me,{onClick:g,sx:{position:"absolute",bottom:16,right:16,backgroundColor:"rgba(0, 0, 0, 0.5)",color:"#fff","&:hover":{backgroundColor:"rgba(0, 0, 0, 0.7)"},zIndex:1e4},children:W?u.jsx(Ce,{}):u.jsx(ke,{})})})]})]})}function qe({hostId:q,host:V}){const{t:T}=he(),d=h.useRef(null),L=h.useRef(null),H=h.useRef(null),O=h.useRef(null),[P,_]=h.useState(!0),[A,w]=h.useState(T("terminal.connecting")),[v,m]=h.useState(null),[B,b]=h.useState(V||null),[x,R]=h.useState(!1),[E,k]=h.useState(!1),W=h.useRef(!1),D=h.useRef(!1),G=h.useRef(null),ee=h.useRef(null),j=h.useRef(null),$=h.useRef(!1),Z=h.useRef(null),K=()=>{G.current=null,ee.current=null},U=(a,g)=>{let e,t;const o=L.current;if(a&&a.width>0&&a.height>0)e=a.width,t=a.height;else if(o){const r=o.getBoundingClientRect();e=r.width,t=r.height}else e=window.innerWidth,t=window.innerHeight;const i=4096,s=1940,f=960,C=1024,y=720;let z,l;if(g){const r=e/t,n=2560,c=1440;let p=Math.floor(e),S=Math.floor(t);(p<n||S<c)&&(r>n/c?(p=n,S=Math.floor(n/r)):(S=c,p=Math.floor(c*r))),z=Math.min(p,i),l=Math.min(S,i),z=Math.max(C,z),l=Math.max(y,l)}else e<s||t<f?(z=s,l=f):(z=Math.max(C,Math.floor(Math.min(e,i))),l=Math.max(y,Math.floor(Math.min(t,i))));return{width:z,height:l,actualWidth:e,actualHeight:t}},Q=()=>{const a=j.current?.getElement?.();if(!a)return;const g=document,e=!!(document.fullscreenElement||g.webkitFullscreenElement||g.mozFullScreenElement||g.msFullscreenElement);a.style.position="absolute",a.style.left="0",a.style.top="0",a.style.transformOrigin="top left",a.style.backgroundColor="#000",a.style.outline="none",a.style.border="none",a.style.margin="0",a.style.padding="0",a.style.zIndex="1",a.style.visibility="visible",a.style.opacity="1",a.style.display="block",a.style.overflow="hidden",e&&(a.style.width="100%",a.style.height="100%",a.style.transform=""),a.querySelectorAll("canvas").forEach(o=>{o.style.display="block",o.style.visibility="visible",o.style.opacity="1"})},J=h.useCallback((a,g)=>{const e=j.current;if(!e?.getWidth||!e?.getHeight||!e?.scale)return;const t=e.getWidth(),o=e.getHeight();if(t<=0||o<=0)return;const i=document,s=!!(document.fullscreenElement||i.webkitFullscreenElement||i.mozFullScreenElement||i.msFullscreenElement);Q();let f=t,C=o;if(G.current){const r=G.current.w,n=G.current.h;if(s)(t<r*.5||o<n*.5)&&(f=r,C=n);else{if(t<r*.3||o<n*.3)return;f=t,C=o}}const y=Math.max(a/f,g/C);let z=1;(f!==t||C!==o)&&(z=Math.max(f/t,C/o)),e.scale(y);const l=e.getElement?.();if(l){if(z!==1){const r=l.style.transform||"";if(r.includes("scale")){const n=r.match(/scale\(([^)]+)\)/);if(n){const c=parseFloat(n[1]);l.style.transform=`scale(${c*z})`}else l.style.transform=`${r} scale(${z})`}else l.style.transform=`scale(${z})`;l.style.transformOrigin="top left"}else l.style.transform="";l.style.left="0",l.style.top="0",l.style.right="auto",l.style.bottom="auto",l.style.marginLeft="0",l.style.marginTop="0",l.style.textAlign="left",l.style.visibility="visible",l.style.opacity="1",l.style.display="block"}},[]),F=h.useCallback((a,g)=>{if(!H.current||$.current)return;const e=document,t=g??!!(document.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement);let o=a;if(t?o={width:window.innerWidth,height:window.innerHeight,x:0,y:0,top:0,left:0,right:window.innerWidth,bottom:window.innerHeight,toJSON:()=>({})}:(!a||a.width<=0||a.height<=0)&&(o=L.current?.getBoundingClientRect()||null),!o||o.width<=0||o.height<=0)return;const{width:i,height:s}=U(o,t),f=G.current;if(!f||f.w!==i||f.h!==s)try{H.current.sendSize(i,s),G.current={w:i,h:s}}catch{}J(o.width,o.height)},[J]),ie=h.useCallback(()=>{const g=L.current?.getBoundingClientRect();g&&F(g,!!document.fullscreenElement)},[F]);h.useEffect(()=>{V?b(V):B||we(async()=>{const{mockHosts:a}=await import("./mockData-C1akHryx.js");return{mockHosts:a}},[]).then(({mockHosts:a})=>{const g=a.find(e=>e.id===q);g&&b(g)})},[q,V,B]),h.useCallback(a=>{try{if(!le){m("Guacamole library not available"),_(!1);return}class g{static CLOSED=0;static OPEN=1;static CONNECTING=2;ws;clientRef;state=g.CLOSED;uuid=null;receiveTimeout=0;unstableThreshold=0;_onstatechange=null;_oninstruction=null;_onerror=null;_onuuid=null;parser=new le.Parser;syncCount=0;recentSent=[];recentReceived=[];lastInputStreamId=null;constructor(r,n){this.ws=r,this.clientRef=n,this.state=r.readyState===WebSocket.OPEN?g.OPEN:g.CONNECTING,this.ws.onopen=()=>this.onOpen(),this.ws.onmessage=c=>this.onMessage(c),this.ws.onerror=c=>this.onError(c),this.ws.onclose=c=>this.onClose(c),this.parser.oninstruction=(c,p)=>{const S=`${c}:${p.map(N=>String(N)).join("|")}`;if(this.recentReceived.push(S),this.recentReceived.length>20&&this.recentReceived.shift(),c==="disconnect"){const N=p.map(I=>String(I));this.handleInstruction(c,N),this._oninstruction&&this._oninstruction(c,p)}else{this._oninstruction&&this._oninstruction(c,p);const N=p.map(I=>String(I));this.handleInstruction(c,N)}}}onOpen(){this.state=g.OPEN,this._onstatechange&&this._onstatechange(this.state),requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(this.clientRef.current&&this.clientRef.current.connect&&this.clientRef.current.state!==2)try{this.clientRef.current.connect()}catch{}})})}validateMessageFormat(r){if(!r||r.length===0||!r.endsWith(";"))return!1;const n=r.slice(0,-1);if(n.length===0)return!1;const c=n.split(";");for(const p of c){if(p.length===0)continue;const S=p.split(",");for(const N of S){const I=N.trim();if(I.length===0)continue;const X=I.indexOf(".");if(X<=0)return!1;const te=I.substring(0,X);if(te.length===0||!/^\d+$/.test(te))return!1;const re=parseInt(te,10);if(isNaN(re)||re<0||re>1e6||I.substring(X+1).length!==re)return!1}}return!0}onMessage(r){try{const n=r.data;if(typeof n=="string"){if(n.startsWith("{")&&n.endsWith("}"))try{JSON.parse(n);return}catch{}if(n.includes("Error")||n.includes("error")){let c=n,p="";if(n.includes(",")){const S=n.split(",");if(S.length>=2){const N=S[0].trim(),I=S.slice(1).join(",").trim(),X=N.match(/\d+/);if(X)p=X[0],c=I;else{c=I;const te=I.match(/\d+/);te&&(p=te[0])}}}else if(n.includes("(")&&n.includes(")")){const S=n.match(/\((\d+)\)/);S&&S.length>=2&&(p=S[1],c=n.replace(/\s*\(\d+\)\s*$/,"").trim())}p==="776"&&(c="服务器连接超时：请检查网络连接并尝试重新连接。"),this._onerror&&this._onerror({code:p&&parseInt(p,10)||500,message:c});return}try{if(!this.validateMessageFormat(n))return;this.parser.receive(n)}catch{this._onerror&&this._onerror({code:0,message:"协议解析错误，消息格式可能不正确。这可能是由于网络问题或服务器错误。"})}}}catch{}}onError(r){this.state=g.CLOSED,this._onstatechange&&this._onstatechange(this.state)}onClose(r){this.state=g.CLOSED,this._onstatechange&&this._onstatechange(this.state)}handleInstruction(r,n){if(r==="ready")this.state=g.OPEN,this._onstatechange&&this._onstatechange(this.state),this.clientRef.current&&this.clientRef.current.connect&&this.clientRef.current.state!==2&&this.clientRef.current.connect(),setTimeout(()=>{try{const c=j.current,p=c?.getElement?.();p&&(p.style.visibility="visible",p.style.opacity="1",p.style.display="block"),d.current&&(d.current.style.display="block",d.current.style.visibility="visible",d.current.style.opacity="1"),c&&Q(),ie()}catch{}},80);else if(r==="disconnect"){if(this.clientRef.current){const c=this.clientRef.current.state;c==null}this.state=g.CLOSED,this._onstatechange&&this._onstatechange(this.state),this._onerror&&this._onerror({code:0,message:"服务器发送了断开连接指令。这可能是由于临时错误或服务器问题。请尝试重新连接。"})}else if(r==="error"){let c="",p="";n.length>=1&&(c=n[0]),n.length>=2&&(p=n[1]),p==="776"?c="服务器连接超时：请检查网络连接并尝试重新连接。":!c&&p?c=`连接错误 (${p})`:c||(c="连接错误"),this._onerror&&this._onerror({code:p&&parseInt(p,10)||500,message:c})}else(r==="blob"||r==="end")&&n.length>0&&(this.lastInputStreamId=String(n[0])),!r.startsWith("img")&&!r.startsWith("rect")&&!r.startsWith("path")&&r==="sync"&&this.syncCount++}sendMessage(...r){try{if(this.ws.readyState!==WebSocket.OPEN)return;let n="";if(r.length>1)n=r.map(p=>{const S=String(p);return`${S.length}.${S}`}).join(",")+";";else{if(n=r.length===1?String(r[0]).trim():"",!n.includes(".")&&!n.includes(",")&&n==="ack"){const p=this.lastInputStreamId||"0",S="OK",N="0",I=X=>`${X.length}.${X}`;n=`${I("ack")},${I(p)},${I(S)},${I(N)};`}else if(!n.includes(".")&&!n.includes(",")){const p=n;n=`${p.length}.${p};`}else n.endsWith(";")||(n=n+";");if((n.endsWith("sync;")||n.endsWith(".sync;"))&&!n.includes(",")){const p=Date.now().toString(),S=p.length;n=`${n.substring(0,n.length-1)},${S}.${p};`}}!n.startsWith("key,")&&!n.startsWith("mouse,")&&(n.startsWith("sync,")||n.startsWith("4.sync")?this.syncCount++:n.includes("disconnect")||n.includes("ack")),this.recentSent.push(n.substring(0,120)),this.recentSent.length>20&&this.recentSent.shift(),this.ws.send(n)}catch{}}disconnect(){(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING)&&this.ws.close(),this.state=g.CLOSED,this._onstatechange&&this._onstatechange(this.state)}connect(){this.ws.readyState===WebSocket.OPEN?(this.state=g.OPEN,this._onstatechange&&this._onstatechange(this.state)):(this.state=g.CONNECTING,this._onstatechange&&this._onstatechange(this.state))}isConnected(){return this.state===g.OPEN&&this.ws.readyState===WebSocket.OPEN}set onstatechange(r){this._onstatechange=r}set oninstruction(r){this._oninstruction=r}set onuuid(r){this._onuuid=r,r&&this.uuid&&r(this.uuid)}set onerror(r){this._onerror=r}}const e={current:null},t=new g(a,e),o=new le.Client(t);H.current=o,e.current=o;const i=o.getDisplay();j.current=i;const s=i.getElement();if(K(),Q(),s.style.cursor="default",i.onresize=()=>{const l=j.current;if(!l)return;const r=l.getWidth(),n=l.getHeight();if(r<=0||n<=0)return;const c=l.getElement?.();c&&(!c.parentElement&&d.current&&d.current.appendChild(c),c.style.visibility="visible",c.style.opacity="1",c.style.display="block",c.querySelectorAll("canvas").forEach(I=>{I.style.display="block",I.style.visibility="visible",I.style.opacity="1"})),d.current&&(d.current.style.display="block",d.current.style.visibility="visible",d.current.style.opacity="1");const S=L.current?.getBoundingClientRect();S&&S.width>0&&S.height>0&&F(S,!!document.fullscreenElement)},d.current){const l=d.current.querySelector('[class*="guac"]');l&&l!==s&&l.remove(),d.current.contains(s)||(d.current.innerHTML="",d.current.appendChild(s)),d.current.style.display="block",d.current.style.visibility="visible",d.current.style.opacity="1"}Q(),s&&(s.style.visibility="visible",s.style.opacity="1",s.style.display="block",!s.parentElement&&d.current&&d.current.appendChild(s)),O.current&&(O.current.disconnect(),O.current=null),setTimeout(()=>{const l=L.current,r=j.current;if(!l||!r)return;const n=r.getElement?.();n&&!n.parentElement&&d.current&&(d.current.appendChild(n),Q());const c=l.getBoundingClientRect();if(c.width>0&&c.height>0&&r.getWidth&&r.getHeight){const S=r.getWidth(),N=r.getHeight();S>0&&N>0&&F(c,!!document.fullscreenElement)}const p=l.getBoundingClientRect();p.width>0&&p.height>0&&F(p,!!document.fullscreenElement)},300);const f=new le.Keyboard(s);f.onkeydown=l=>{o.sendKeyEvent(1,l)},f.onkeyup=l=>{o.sendKeyEvent(0,l)};const C=new le.Mouse(s);C.onmousedown=l=>{o.sendMouseState(l)},C.onmouseup=l=>{o.sendMouseState(l)},C.onmousemove=l=>{o.sendMouseState(l)};let y=null,z=null;o.onstatechange=l=>{z=l;const r=0,n=2,c=1,p=3,S=4;if(l==null||l<0||l>4)if(y&&(clearTimeout(y),y=null),H.current){const N=H.current.state;N!=null?(l=N,z=l):(l=S,z=l)}else l=S,z=l;if(l===n){m(null),W.current=!0,k(!0),D.current=!0;const N=()=>{const ae=L.current,Y=j.current,se=Y?.getElement?.();d.current&&(d.current.style.display="block",d.current.style.visibility="visible",d.current.style.opacity="1"),se&&(Q(),se.querySelectorAll("canvas").forEach(oe=>{oe.style.display="block",oe.style.visibility="visible",oe.style.opacity="1"}));const ne=ae?.getBoundingClientRect();if(ne&&ne.width>0&&ne.height>0&&Y?.getWidth&&Y?.getHeight){const ge=Y.getWidth(),oe=Y.getHeight();ge>0&&oe>0&&F(ne,x)}se&&!se.parentElement&&d.current&&d.current.appendChild(se)};N(),setTimeout(N,200),setTimeout(N,500),setTimeout(N,1e3);let I=null;const X=Date.now(),te=1e4,re=()=>{if(Date.now()-X>te){I!==null&&cancelAnimationFrame(I);return}const Y=j.current?.getElement?.();Y&&(Y.style.visibility="visible",Y.style.opacity="1",Y.style.display="block",Y.querySelectorAll("canvas").forEach(ne=>{ne.style.display="block",ne.style.visibility="visible",ne.style.opacity="1"})),I=requestAnimationFrame(re)};I=requestAnimationFrame(re),y&&clearTimeout(y),w(T("terminal.establishingConnection")),y=setTimeout(()=>{if(!H.current){m(T("terminal.clientLost")),_(!1),W.current=!1,y=null;return}if(z==null){D.current||m(T("terminal.clientStateError")),_(!1),W.current=!1,y=null;return}if(z===4||z===3){D.current||m(T("rdp.disconnected")||"Disconnected"),_(!1),W.current=!1,y=null;return}if(z!==2){w("连接中..."),y=null;return}w(T("terminal.connectionSuccess")),m(null),k(!0),setTimeout(()=>{_(!1)},500),y=null},1e3)}else l===S?(W.current=!1,k(!1),D.current||m(T("terminal.connectionFailed")),_(!1),y&&(clearTimeout(y),y=null)):l===r?w(T("terminal.connecting")):l===c?w(T("terminal.waitingConnection")):l===p&&k(!1)},o.onerror=l=>{let r="Unknown error",n="",c="";if(l){const S=l;if("code"in S&&S.code!==void 0)switch(n=S.code.toString(),c=S.message||S.reason||"",S.code){case 519:r="服务器拒绝连接：安全类型不匹配。请检查服务器是否支持当前安全模式，或联系管理员。";break;case 512:r="连接被服务器拒绝：用户名或密码错误。";break;case 513:r="连接被服务器拒绝：权限不足。";break;case 514:r="连接超时：无法连接到服务器。";break;default:r=`错误 ${n}${c?": "+c:""}`}else{const N=l;N.message?r=N.message:r=N.toString()}}const p=T("rdp.clientError")||"Client error: "+r;m(p),_(!1)},a.readyState===WebSocket.OPEN&&(t.state=g.OPEN,t._onstatechange&&t._onstatechange(t.state),requestAnimationFrame(()=>{requestAnimationFrame(()=>{try{o.state!==2&&o.connect()}catch{}})}))}catch(g){m((T("rdp.setupFailed")||"Setup failed")+": "+g.message),_(!1)}},[m,_,k,w,T,d,H,F,K,x,ie]);const ce=async()=>{const a=L.current;if(a)try{const g=a,e=document;x?document.exitFullscreen?await document.exitFullscreen():e.webkitExitFullscreen?await e.webkitExitFullscreen():e.mozCancelFullScreen?await e.mozCancelFullScreen():e.msExitFullscreen&&await e.msExitFullscreen():a.requestFullscreen?await a.requestFullscreen():g.webkitRequestFullscreen?await g.webkitRequestFullscreen():g.mozRequestFullScreen?await g.mozRequestFullScreen():g.msRequestFullscreen&&await g.msRequestFullscreen()}catch{}};return h.useEffect(()=>{const a=()=>{const e=document,t=!!(document.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement);R(t),$.current=!0;const o=()=>{if(H.current)if(t){const i={width:window.innerWidth,height:window.innerHeight,x:0,y:0,top:0,left:0,right:window.innerWidth,bottom:window.innerHeight,toJSON:()=>({})};Z.current&&clearTimeout(Z.current),F(i,t),setTimeout(()=>{$.current=!1},500)}else{const i=ee.current;if(i&&H.current){try{H.current.sendSize(i.w,i.h),G.current={w:i.w,h:i.h}}catch{}const s=L.current;if(s){const f=s.getBoundingClientRect();f&&f.width>0&&f.height>0&&setTimeout(()=>{const C=j.current;if(C?.getWidth?.()&&C?.getHeight?.()){J(f.width,f.height);const y=C?.getElement?.();y&&(y.style.left="0",y.style.top="0",y.style.right="auto",y.style.bottom="auto",y.style.marginLeft="0",y.style.marginTop="0",y.style.transformOrigin="top left",y.style.transform="")}},500)}}else{const s=L.current;if(!s)return;const f=s.getBoundingClientRect();if(f&&f.width>0&&f.height>0){F(f,t);const y=j.current?.getElement?.();y&&(y.style.left="0",y.style.top="0",y.style.right="auto",y.style.bottom="auto",y.style.marginLeft="0",y.style.marginTop="0",y.style.transformOrigin="top left")}}}};setTimeout(()=>{o(),setTimeout(()=>{requestAnimationFrame(o)},100)},100)};document.addEventListener("fullscreenchange",a),document.addEventListener("webkitfullscreenchange",a),document.addEventListener("mozfullscreenchange",a),document.addEventListener("MSFullscreenChange",a);const g=e=>{e.key==="Escape"&&x&&setTimeout(()=>{a()},100)};return window.addEventListener("keydown",g),()=>{document.removeEventListener("fullscreenchange",a),document.removeEventListener("webkitfullscreenchange",a),document.removeEventListener("mozfullscreenchange",a),document.removeEventListener("MSFullscreenChange",a),window.removeEventListener("keydown",g)}},[x,F,J]),h.useEffect(()=>{const a=L.current;if(!a)return;let g=null;const e=new ResizeObserver(o=>{if($.current)return;const i=o[0];if(!i||!i.target)return;const s=i.target.getBoundingClientRect();g&&cancelAnimationFrame(g),g=requestAnimationFrame(()=>{const f=document,C=!!(document.fullscreenElement||f.webkitFullscreenElement||f.mozFullScreenElement||f.msFullscreenElement);Z.current&&clearTimeout(Z.current),Z.current=window.setTimeout(()=>{F(s,C)},100)})});e.observe(a);const t=a.getBoundingClientRect();return F(t,!!document.fullscreenElement),()=>{g&&cancelAnimationFrame(g),e.disconnect(),O.current&&(O.current.disconnect(),O.current=null)}},[J,F]),u.jsxs(M,{sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",position:"relative",overflow:"hidden"},children:[P&&u.jsxs(M,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.7)",zIndex:1e3,gap:2},children:[u.jsx(be,{size:60,sx:{color:"primary.main"}}),u.jsx(M,{sx:{color:"white",fontSize:"16px",fontWeight:500,textAlign:"center"},children:A})]}),!E&&v&&u.jsx(Se,{severity:"error",sx:{mb:2},children:v}),u.jsxs(de,{ref:L,sx:{width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%",display:"flex",flexDirection:"column",position:"relative",overflow:"hidden",flex:1,minHeight:0,"&:fullscreen, &:-webkit-full-screen, &:-moz-full-screen, &:-ms-fullscreen":{width:"100vw !important",height:"100vh !important",maxWidth:"100vw !important",maxHeight:"100vh !important",margin:0,padding:0}},children:[u.jsx(M,{sx:{position:"absolute",top:8,right:8,zIndex:100,display:"flex",gap:1},children:u.jsx(Ee,{title:x?T("common.exitFullscreen")||"Exit Fullscreen":T("common.fullscreen")||"Fullscreen",children:u.jsx(me,{size:"small",onClick:ce,color:"primary",children:x?u.jsx(Ce,{}):u.jsx(ke,{})})})}),u.jsx(M,{ref:d,sx:{flex:1,width:"100%",height:"100%",minHeight:0,backgroundColor:"#000",overflow:"hidden",position:"relative",...x&&{width:"100vw",height:"100vh",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:9999},...x&&{"& > div":{width:"100% !important",height:"100% !important",transform:"none !important","& > div":{width:"100% !important",height:"100% !important",transform:"none !important"}}}}})]})]})}function Xe(){const{t:q}=he(),V=Re(),T=Fe(),{sessions:d,removeSession:L,addSession:H}=xe(),[O,P]=h.useState(0),[_,A]=h.useState(""),[w,v]=h.useState("/");h.useEffect(()=>{const b=sessionStorage.getItem("terminal_previous_path")||"/";v(b)},[]),h.useEffect(()=>{(async()=>{try{const R=await(await fetch("/api/system-users",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}})).json(),E=R.data||R||[];E.length>0&&!_&&A(E[0].id)}catch(x){console.error("加载系统用户失败:",x)}})()},[_]),h.useEffect(()=>{O>=d.length&&d.length>0&&P(d.length-1)},[d.length,O]);const m=(b,x)=>{const E=d.find(k=>k.id===b)?.wsConnection;E&&E.readyState===WebSocket.OPEN&&(console.log(`[TerminalPage] User manually closing WebSocket for session ${b}`),E.__userClosed=!0,E.close()),L(b),O===x&&x>0&&P(x-1)},B=async b=>{try{const x=d.find(k=>k.host.id===b.id);if(x){const k=d.findIndex(W=>W.id===x.id);P(k);return}const R=await Le.getHost(b.id);let E=_;if(!E)try{const W=await(await fetch(`/api/system-users/available?hostId=${b.id}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}})).json(),D=Array.isArray(W.data)?W.data:W.data?.data||[];if(D.length===0){alert("没有可用的系统用户，请联系管理员配置权限");return}else D.length,E=D[0].id}catch(k){console.error("获取系统用户失败:",k)}H(R,E||void 0),setTimeout(()=>{const k=d.length;P(k)},100)}catch(x){console.error("连接主机失败:",x),alert("连接主机失败: "+x.message)}};return u.jsxs(M,{sx:{height:"100vh",width:"100vw",display:"flex",flexDirection:"column",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1300,bgcolor:"background.default",overflow:"hidden"},children:[u.jsx(Te,{position:"static",color:"default",elevation:1,sx:{flexShrink:0},children:u.jsxs(_e,{children:[u.jsx(me,{edge:"start",onClick:()=>V(w),sx:{mr:2},children:u.jsx(Ne,{})}),u.jsx(ue,{variant:"h6",sx:{flexGrow:1},children:q("terminal.title")}),d.length>0&&u.jsx(ue,{variant:"body2",color:"text.secondary",sx:{mr:2},children:q("terminal.activeSessions",{count:d.length})}),u.jsx(ve,{variant:"outlined",startIcon:u.jsx(We,{}),onClick:()=>{sessionStorage.setItem("file_management_previous_path",T.pathname),window.open("/file-management","_blank")},sx:{textTransform:"none",mr:1},children:"文件管理"})]})}),u.jsxs(M,{sx:{flex:1,minHeight:0,width:"100%",display:"flex",gap:2,p:2,overflow:"hidden"},children:[u.jsx(M,{sx:{width:"300px",flexShrink:0,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:u.jsx(He,{onHostClick:B})}),u.jsx(M,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:d.length===0?u.jsxs(de,{sx:{p:4,textAlign:"center",flex:1,display:"flex",flexDirection:"column",justifyContent:"center"},children:[u.jsx(ue,{variant:"h6",gutterBottom:!0,color:"text.secondary",children:q("terminal.noOpenSessions")}),u.jsx(ue,{variant:"body2",color:"text.secondary",children:"从左侧主机树选择主机进行连接"})]}):u.jsxs(u.Fragment,{children:[u.jsx(de,{sx:{mb:2,flexShrink:0},children:u.jsx(Ie,{value:O,onChange:(b,x)=>P(x),variant:"scrollable",scrollButtons:"auto",children:d.map((b,x)=>u.jsx(Oe,{label:u.jsxs(M,{display:"flex",alignItems:"center",gap:1,children:[u.jsx("span",{children:b.host.name}),u.jsxs("span",{style:{fontSize:"0.8em",opacity:.7},children:["(",b.host.ip,")"]}),u.jsx(M,{component:"span",onClick:R=>{R.stopPropagation(),m(b.id,x)},sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:20,height:20,borderRadius:"50%",cursor:"pointer",ml:.5,"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.08)"}},children:u.jsx(je,{sx:{fontSize:16}})})]})},b.id))})}),u.jsx(M,{sx:{flex:1,minHeight:0,width:"100%",display:"flex",flexDirection:"column",overflow:"hidden"},children:d.map((b,x)=>u.jsx(M,{sx:{display:O===x?"flex":"none",flex:1,width:"100%",minHeight:0,flexDirection:"column",overflow:"hidden"},children:b.host.deviceType==="windows"?u.jsx(qe,{hostId:b.host.id,host:b.host,sessionId:b.id,systemUserId:b.systemUserId,onClose:()=>m(b.id,x)}):u.jsx($e,{hostId:b.host.id,host:b.host,sessionId:b.id,systemUserId:b.systemUserId,onClose:()=>m(b.id,x)})},b.id))})]})})]})]})}export{Xe as default};
