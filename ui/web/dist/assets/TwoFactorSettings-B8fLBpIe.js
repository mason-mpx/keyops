import{u as te,r as n,H as u,j as e,B as r,C as G,T as c,w as H,x as M,aa as O,b as h,a as w,i as P,k as z,l as V,v as ae,m as B,p as $,d as Q,I as q,cU as ne,be as oe,cm as re,_ as le}from"./index-DNdAKB9f.js";import{C as ie}from"./Chip-B8lB6W_F.js";import{S as ce}from"./Switch-psoPU8CH.js";function de(){const[g,t]=n.useState({enabled:!1,issuer:"KeyOps"}),[A,k]=n.useState(!1),[x,v]=n.useState(!1),[y,l]=n.useState(""),[m,f]=n.useState("");n.useEffect(()=>{D()},[]);const D=async()=>{try{k(!0);const a=await u.get("/api/admin/two-factor/config");t(a.data.data)}catch(a){console.error("加载全局2FA配置失败:",a),l("加载配置失败")}finally{k(!1)}},F=async a=>{try{v(!0),l(""),f("");const p=await u.put("/api/admin/two-factor/config",{enabled:a,issuer:g.issuer});t(p.data.data),f(a?"全局2FA已启用":"全局2FA已禁用")}catch(p){console.error("更新全局2FA配置失败:",p),l(p.response?.data?.message||"更新配置失败")}finally{v(!1)}},b=a=>{t(p=>({...p,issuer:a.target.value}))},T=async()=>{try{v(!0),l(""),f("");const a=await u.put("/api/admin/two-factor/config",{enabled:g.enabled,issuer:g.issuer});t(a.data.data),f("发行者名称已更新")}catch(a){console.error("更新发行者名称失败:",a),l(a.response?.data?.message||"更新失败")}finally{v(!1)}};return A?e.jsx(r,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100px",children:e.jsx(G,{})}):e.jsxs(r,{children:[y&&e.jsx(h,{severity:"error",sx:{mb:2},children:y}),m&&e.jsx(h,{severity:"success",sx:{mb:2},children:m}),e.jsx(r,{sx:{mb:3},children:e.jsx(le,{control:e.jsx(ce,{checked:g.enabled,onChange:a=>F(a.target.checked),disabled:x,color:"primary"}),label:e.jsxs(r,{children:[e.jsx(c,{variant:"body1",children:"启用全局2FA"}),e.jsx(c,{variant:"body2",color:"textSecondary",children:g.enabled?"所有用户必须启用2FA才能登录":"用户可以自由选择是否启用2FA"})]})})}),e.jsxs(r,{sx:{mb:3},children:[e.jsx(B,{label:"发行者名称",value:g.issuer,onChange:b,fullWidth:!0,variant:"outlined",helperText:"在2FA应用中显示的名称",disabled:x}),e.jsx(w,{variant:"outlined",onClick:T,disabled:x,sx:{mt:1},children:x?"保存中...":"保存发行者名称"})]}),g.enabled&&e.jsx(h,{severity:"warning",sx:{mt:2},children:e.jsxs(c,{variant:"body2",children:[e.jsx("strong",{children:"注意："}),"启用全局2FA后，所有用户都必须设置2FA才能登录。 禁用全局2FA将自动清除所有用户的2FA设置。"]})})]})}function ge({showGlobalConfig:g=!1}={}){const{t}=te(),[A,k]=n.useState(null),[x,v]=n.useState(null),[y,l]=n.useState(!1),[m,f]=n.useState(!1),[D,F]=n.useState(!1),[b,T]=n.useState(null),[a,p]=n.useState(""),[C,J]=n.useState([]),[I,K]=n.useState(!1),[S,W]=n.useState(null),[E,N]=n.useState(0),[_,X]=n.useState({enabled:!1});n.useEffect(()=>{R()},[]),n.useEffect(()=>{if(m&&S){const s=setInterval(()=>{L()},3e4);return()=>clearInterval(s)}},[m,S]),n.useEffect(()=>{if(m&&S){const s=()=>{const j=Date.now()-S,o=Math.max(0,3e4-j);N(Math.ceil(o/1e3))};s();const i=setInterval(s,1e3);return()=>clearInterval(i)}},[m,S]);const R=async()=>{try{l(!0);const[s,i,d]=await Promise.all([u.get("/api/auth/me"),u.get("/api/two-factor/status"),u.get("/api/two-factor/global-status").catch(()=>({data:{data:{enabled:!1}}}))]);console.log("用户角色:",s.data?.data?.role),k(s.data.data),v(i.data.data),X(d.data.data)}catch(s){console.error("加载2FA数据失败:",s)}finally{l(!1)}},Y=async()=>{try{l(!0);const s=await u.post("/api/two-factor/setup");console.log("2FA设置响应:",s.data),console.log("二维码数据:",s.data.data),T(s.data.data),f(!0),W(Date.now())}catch(s){console.error("设置2FA失败:",s);const i=s.response?.data?.message||s.message;s.response?.status===403?alert("权限不足：只有管理员可以启用2FA"):alert(`设置2FA失败: ${i}`)}finally{l(!1)}},L=async()=>{try{l(!0);const s=await u.post("/api/two-factor/setup");console.log("刷新二维码响应:",s.data),console.log("新的二维码数据:",s.data.data),T(s.data.data),W(Date.now()),p("")}catch(s){console.error("刷新二维码失败:",s)}finally{l(!1)}},Z=async()=>{if(!b||!a)return;if(!/^\d{6}$/.test(a)){alert("验证码必须是6位数字");return}const i=Math.abs(new Date().getTime()-Date.now());i>3e4&&console.warn("系统时间可能不同步，时间偏移:",i,"ms");const d=localStorage.getItem("token"),j=localStorage.getItem("user");if(console.log("当前token:",d?"存在":"不存在"),console.log("当前用户:",j),console.log("Token内容:",d?d.substring(0,20)+"...":"无"),d)try{const o=JSON.parse(atob(d.split(".")[1]));console.log("Token payload:",o),console.log("Token过期时间:",new Date(o.exp*1e3)),console.log("当前时间:",new Date),console.log("Token是否过期:",new Date>new Date(o.exp*1e3))}catch(o){console.error("Token解析失败:",o)}if(!d){alert("请先登录");return}try{l(!0);const o=await u.post("/api/two-factor/verify",{secret:b.secret,code:a});J(o.data.data.backupCodes||[]),F(!0),f(!1),R()}catch(o){console.error("验证2FA失败:",o),console.error("错误详情:",{status:o.response?.status,statusText:o.response?.statusText,data:o.response?.data,message:o.message}),console.error("完整错误响应:",JSON.stringify(o.response?.data,null,2));const U=o.response?.data?.message||o.message;o.response?.status===401?(alert("登录已过期，请重新登录"),localStorage.removeItem("token"),localStorage.removeItem("user"),window.location.href="/login"):o.response?.status===403?alert("权限不足：只有管理员可以启用2FA"):alert(U==="验证码错误"?`验证码错误，请检查：
1. 确保使用正确的身份验证器应用
2. 确保系统时间正确
3. 验证码必须在30秒内使用
4. 重新扫描二维码获取新的密钥`:`验证失败: ${U}`)}finally{l(!1)}},ee=async()=>{if(confirm("确定要禁用2FA吗？这将降低账户安全性。"))try{l(!0),await u.post("/api/two-factor/disable"),R()}catch(s){console.error("禁用2FA失败:",s);const i=s.response?.data?.message||s.message;s.response?.status===403?alert("权限不足：只有管理员可以禁用2FA"):alert(`禁用2FA失败: ${i}`)}finally{l(!1)}},se=()=>{if(!C||!C.length)return;const s=C.join(`
`),i=new Blob([s],{type:"text/plain"}),d=URL.createObjectURL(i),j=document.createElement("a");j.href=d,j.download="zjump-2fa-backup-codes.txt",document.body.appendChild(j),j.click(),document.body.removeChild(j),URL.revokeObjectURL(d)};return y&&!x?e.jsx(r,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px",children:e.jsx(G,{})}):e.jsxs(r,{children:[e.jsx(c,{variant:"h5",gutterBottom:!0,children:t("settings.twoFactor.title")}),e.jsx(c,{variant:"body2",color:"textSecondary",paragraph:!0,children:t("settings.twoFactor.description")}),g&&A?.role==="admin"&&e.jsx(H,{sx:{mb:3},children:e.jsxs(M,{children:[e.jsxs(r,{display:"flex",alignItems:"center",mb:2,children:[e.jsx(O,{sx:{mr:1}}),e.jsx(c,{variant:"h6",children:t("settings.twoFactor.globalConfig")})]}),e.jsx(h,{severity:"info",sx:{mb:2},children:"全局2FA配置控制所有用户的2FA设置。禁用全局2FA将强制所有用户禁用2FA。"}),e.jsx(de,{})]})}),_.enabled&&!x?.enabled&&e.jsx(h,{severity:"warning",sx:{mb:3},children:e.jsxs(c,{variant:"body2",children:[e.jsx("strong",{children:"重要提示："}),"系统已启用全局2FA，您必须设置双因素认证才能正常使用系统。 请立即设置2FA以避免登录问题。"]})}),e.jsx(H,{children:e.jsxs(M,{children:[e.jsxs(r,{display:"flex",alignItems:"center",mb:2,children:[e.jsx(O,{sx:{mr:1}}),e.jsx(c,{variant:"h6",children:t("settings.twoFactor.userConfig")})]}),x?.enabled?e.jsxs(r,{children:[e.jsxs(h,{severity:"success",sx:{mb:2},children:[t("settings.twoFactor.enabled"),x.verifiedAt&&e.jsxs(c,{variant:"caption",display:"block",children:[t("settings.twoFactor.verifiedAt"),": ",new Date(x.verifiedAt).toLocaleString()]})]}),e.jsx(r,{display:"flex",gap:2,mb:2,children:A?.role==="admin"&&e.jsx(w,{variant:"outlined",color:"error",onClick:ee,disabled:y,children:t("settings.twoFactor.disable")})})]}):e.jsxs(r,{children:[e.jsx(h,{severity:"info",sx:{mb:2},children:t("settings.twoFactor.notEnabled")}),e.jsx(w,{variant:"contained",startIcon:e.jsx(O,{}),onClick:Y,disabled:y,children:t("settings.twoFactor.enable")})]})]})}),e.jsxs(P,{open:m,onClose:()=>f(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(z,{children:t("settings.twoFactor.setupTitle")}),e.jsx(V,{children:b&&e.jsxs(r,{children:[e.jsx(h,{severity:"info",sx:{mb:2},children:t("settings.twoFactor.setupInstructions")}),e.jsx(h,{severity:"warning",sx:{mb:2},children:e.jsxs(c,{variant:"body2",component:"div",children:[e.jsx("strong",{children:"如果二维码扫描失败，请按以下步骤手动设置："}),e.jsx("br",{}),"1. 复制上面的密钥",e.jsx("br",{}),"2. 在身份验证器应用中添加新账户",e.jsx("br",{}),'3. 选择"手动输入密钥"',e.jsx("br",{}),"4. 输入账户名：admin@zjump.local",e.jsx("br",{}),"5. 粘贴密钥，选择TOTP，SHA1，6位数字，30秒周期",e.jsx("br",{}),e.jsx("br",{}),e.jsx("strong",{children:"重要："}),"确保身份验证器应用的设置完全匹配：",e.jsx("br",{}),"• 算法：SHA1（不是SHA256）",e.jsx("br",{}),"• 位数：6位",e.jsx("br",{}),"• 周期：30秒"]})}),e.jsxs(r,{textAlign:"center",mb:2,children:[e.jsx("img",{src:b.qrCode,alt:"2FA QR Code",style:{maxWidth:"200px",height:"auto"}}),e.jsxs(r,{mt:1,children:[e.jsx(w,{variant:"outlined",size:"small",onClick:L,disabled:y,startIcon:e.jsx(ae,{}),children:"刷新二维码"}),E>0&&e.jsxs(c,{variant:"caption",color:"textSecondary",sx:{ml:1},children:[E,"秒后自动刷新"]})]})]}),e.jsx(B,{fullWidth:!0,label:t("settings.twoFactor.secretKey"),value:b.secret,InputProps:{readOnly:!0,endAdornment:e.jsx(w,{size:"small",onClick:()=>{navigator.clipboard.writeText(b.secret),alert("密钥已复制到剪贴板")},children:"复制"})},sx:{mb:2},helperText:"如果二维码扫描失败，请手动复制此密钥到身份验证器应用中"}),e.jsx(B,{fullWidth:!0,label:t("settings.twoFactor.verificationCode"),value:a,onChange:s=>{const i=s.target.value.replace(/\D/g,"").slice(0,6);p(i)},placeholder:"000000",inputProps:{maxLength:6},sx:{mb:2}})]})}),e.jsxs($,{children:[e.jsx(w,{onClick:()=>f(!1),children:t("common.cancel")}),e.jsx(w,{onClick:Z,variant:"contained",disabled:!a||a.length!==6,children:t("settings.twoFactor.verify")})]})]}),e.jsxs(P,{open:D,onClose:()=>F(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(z,{children:t("settings.twoFactor.backupCodesTitle")}),e.jsxs(V,{children:[e.jsx(h,{severity:"warning",sx:{mb:2},children:t("settings.twoFactor.backupCodesWarning")}),e.jsxs(r,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2,children:[e.jsx(c,{variant:"h6",children:t("settings.twoFactor.backupCodes")}),e.jsxs(r,{children:[e.jsx(Q,{title:t(I?"common.hide":"common.show"),children:e.jsx(q,{onClick:()=>K(!I),children:I?e.jsx(ne,{}):e.jsx(oe,{})})}),e.jsx(Q,{title:t("settings.twoFactor.download"),children:e.jsx(q,{onClick:se,children:e.jsx(re,{})})})]})]}),e.jsx(r,{display:"flex",flexWrap:"wrap",gap:1,children:C&&C.length>0?C.map((s,i)=>e.jsx(r,{sx:{minWidth:"120px",flex:"1 1 120px"},children:e.jsx(ie,{label:I?s:"••••••••",variant:"outlined",sx:{width:"100%"}})},i)):e.jsx(c,{variant:"body2",color:"textSecondary",children:"暂无备用码"})})]}),e.jsx($,{children:e.jsx(w,{onClick:()=>F(!1),variant:"contained",children:t("common.close")})})]})]})}export{ge as T};
