import{r,ax as B,b3 as D,j as a,B as i,T as j,w as R,x as E,a as F,A as N,C as U,b as H,I as M,be as O}from"./index-CJIrazW8.js";import{t as J}from"./ticketApi-CCnZQOPl.js";import{T as L,a as V,b as Y,c as b,d as t,e as q}from"./TableRow-JrGpygSA.js";import{C as G}from"./Chip-Bh8gAKTq.js";import{T as K}from"./TablePagination-BC9Ek9KZ.js";import"./LastPage-CClrOV-o.js";function ae(){const[c,y]=r.useState([]),[S,p]=r.useState(!1),[d,f]=r.useState(1),[u,C]=r.useState(10),[w,v]=r.useState(0),[o,g]=r.useState(!1),l=B(),x=r.useCallback(async()=>{try{const e=await D.getCurrentUser();g(e?.role==="admin"),e?.role!=="admin"&&l("/my-tickets")}catch(e){console.error("加载用户信息失败:",e);const s=localStorage.getItem("user");if(s){const n=JSON.parse(s);g(n?.role==="admin"),n?.role!=="admin"&&l("/my-tickets")}else l("/my-tickets")}},[l]),h=r.useCallback(async()=>{if(o)try{p(!0);const e={page:d,page_size:u,exclude_status:"draft"},s=await J.list(e);s.data.code===0&&(y(s.data.data||[]),v(s.data.total||0))}catch(e){console.error("加载工单失败:",e)}finally{p(!1)}},[o,d,u]);r.useEffect(()=>{x()},[x]),r.useEffect(()=>{o&&h()},[o,h]);const T=e=>{C(Number(e.target.value)),f(1)},m=e=>{if(e.status==="draft")return{label:"草稿",color:"default"};if(e.status==="cancelled"||e.status==="void")return{label:"已作废",color:"default"};if(e.approval_status)switch(e.approval_status){case"pending":return{label:"审批中",color:"info"};case"rejected":return{label:"审批失败",color:"error"};case"canceled":return{label:"已取消",color:"default"};case"expired":return{label:"已过期",color:"warning"}}if(e.status==="rejected")return{label:"已拒绝",color:"error"};if(e.status==="approved"||e.approval_status==="approved"){if(e.deployment_id)switch(e.deployment_status){case"pending":return{label:"待发布",color:"warning"};case"running":return{label:"发布中",color:"info"};case"success":return{label:"发布成功",color:"success"};case"failed":return{label:"发布失败",color:"error"};case"cancelled":return{label:"发布已取消",color:"default"};default:return{label:"待发布",color:"warning"}}return{label:"待发布",color:"warning"}}return e.status==="submitted"&&(e.approval_status==="pending"||!e.approval_status)?{label:"审批中",color:"info"}:{label:{draft:"草稿",submitted:"审批中",approved:"待发布",rejected:"已拒绝",cancelled:"已作废",void:"已作废"}[e.status]||e.status,color:"default"}},P=e=>{const s=new Date(e),n=s.getFullYear(),_=s.getMonth()+1,I=s.getDate(),$=String(s.getHours()).padStart(2,"0"),A=String(s.getMinutes()).padStart(2,"0"),z=String(s.getSeconds()).padStart(2,"0");return`${n}-${_}-${I} ${$}:${A}:${z}`};return o?a.jsxs(i,{sx:{p:3},children:[a.jsx(j,{variant:"h4",gutterBottom:!0,children:"全部工单"}),a.jsx(R,{sx:{mt:3},children:a.jsxs(E,{children:[a.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[a.jsx(j,{variant:"h6",children:"全部工单"}),a.jsx(F,{variant:"contained",startIcon:a.jsx(N,{}),onClick:()=>l("/create-ticket"),children:"新建工单"})]}),S?a.jsx(i,{sx:{display:"flex",justifyContent:"center",p:3},children:a.jsx(U,{})}):a.jsxs(a.Fragment,{children:[c.length===0&&a.jsx(H,{severity:"info",children:"暂无工单"}),c.length>0&&a.jsxs(a.Fragment,{children:[a.jsx(L,{children:a.jsxs(V,{children:[a.jsx(Y,{children:a.jsxs(b,{children:[a.jsx(t,{children:"工单编号"}),a.jsx(t,{children:"标题"}),a.jsx(t,{children:"申请人"}),a.jsx(t,{children:"状态"}),a.jsx(t,{children:"优先级"}),a.jsx(t,{children:"创建时间"}),a.jsx(t,{align:"right",children:"操作"})]})}),a.jsx(q,{children:c.map(e=>a.jsxs(b,{children:[a.jsx(t,{children:e.ticket_number}),a.jsx(t,{children:e.title}),a.jsx(t,{children:e.applicant_name||"-"}),a.jsx(t,{children:a.jsx(G,{label:m(e).label,color:m(e).color,size:"small"})}),a.jsx(t,{children:e.priority}),a.jsx(t,{children:P(e.created_at)}),a.jsx(t,{align:"right",children:a.jsx(M,{size:"small",onClick:()=>l(`/ticket/${e.id}`,{state:{from:"/all-tickets"}}),children:a.jsx(O,{fontSize:"small"})})})]},e.id))})]})}),a.jsx(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:2},children:a.jsx(K,{component:"div",count:w,page:d-1,onPageChange:(e,s)=>f(s+1),rowsPerPage:u,onRowsPerPageChange:T,rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:"每页显示:",labelDisplayedRows:({from:e,to:s,count:n})=>`${e}-${s} 共 ${n} 条`})})]})]})]})})]}):null}export{ae as default};
