import{u as M,r as o,j as e,B as C,w as $,x as q,T as L,a as d,v as K,A as O,P as H,d as b,I as P,g as G,h as J,i as Q,k as V,l as X,m as U,F as Y,n as Z,o as ee,M as r,p as ne,bf as u,a7 as k}from"./index-wVs8DYHr.js";import{a as p}from"./alertApi-Ch3_g7QM.js";import{S as w}from"./Stack-CNnEoVHt.js";import{T as ae,a as te,b as le,c as m,d as s,e as se}from"./TableRow-17IyVPm2.js";import{C as ie}from"./Chip-DzNpApxT.js";import{P as oe}from"./Pagination-BBTYTx7r.js";import"./LastPage-Bx6x4Acm.js";function xe(){const{t:n}=M(),[v,S]=o.useState([]),[T,I]=o.useState(!1),[E,R]=o.useState(!1),[x,g]=o.useState(null),[f,z]=o.useState(1),[y]=o.useState(10),[W,B]=o.useState(0),[t,c]=o.useState({channel_name:"",channel_type:"feishu",channel_sign:""}),h=o.useCallback(async()=>{try{I(!0);const a=await p.getChannels({page:f,page_size:y});(a.data.code===0||a.data.code===200)&&(S(a.data.data||[]),B(a.data.total||0))}catch(a){console.error("获取告警渠道失败:",a),S([])}finally{I(!1)}},[f,y]);o.useEffect(()=>{h()},[h]);const A=a=>{a?(g(a),c({channel_name:a.channel_name,channel_type:a.channel_type,channel_sign:a.channel_sign})):(g(null),c({channel_name:"",channel_type:"feishu",channel_sign:""})),R(!0)},j=()=>{R(!1),g(null)},D=(a,l)=>{if(!l||!l.trim())return n("Please fill in channel sign")||"请填写渠道签名";const i=l.trim();switch(a){case"webhook":{try{const _=new URL(i);if(!["http:","https:"].includes(_.protocol))return n("Invalid webhook URL")||"无效的Webhook URL，必须以http://或https://开头"}catch{return n("Invalid webhook URL format")||"无效的Webhook URL格式"}break}case"email":{if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(i))return n("Invalid email format")||"无效的邮箱格式";break}case"sms":{if(!/^1[3-9]\d{9}$/.test(i.replace(/[\s-]/g,"")))return n("Invalid phone number format")||"无效的手机号格式（支持中国大陆手机号）";break}case"feishu":case"dingtalk":case"wechat":if(i.length<10)return n("Channel sign too short")||"渠道签名过短，请检查是否正确";break;default:if(i.length<3)return n("Channel sign too short")||"渠道签名过短"}return null},F=async()=>{if(!t.channel_name||!t.channel_type||!t.channel_sign){u(n("Please fill in required fields")||"请填写必填字段");return}if(!["feishu","dingtalk","wechat","email","sms","webhook"].includes(t.channel_type)){u(n("Invalid channel type")||"无效的渠道类型");return}const l=D(t.channel_type,t.channel_sign||"");if(l){u(l);return}try{x?(await p.updateChannel(x.id,t),k(n("Update successful")||"更新成功")):(await p.createChannel(t),k(n("Create successful")||"创建成功")),j(),h()}catch(i){console.error("保存失败:",i),u(i?.response?.data?.message||n("Save failed")||"保存失败")}},N=async a=>{if(confirm(n("Are you sure you want to delete this channel?")||"确定要删除这个告警渠道吗？"))try{await p.deleteChannel(a),k(n("Delete successful")||"删除成功"),h()}catch(l){console.error("删除失败:",l)}};return e.jsxs(C,{sx:{p:3},children:[e.jsx($,{children:e.jsxs(q,{children:[e.jsxs(C,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(L,{variant:"h5",gutterBottom:!0,children:n("menu.monitorAlertChannel")||"告警渠道管理"}),e.jsxs(w,{direction:"row",spacing:2,children:[e.jsx(d,{variant:"outlined",startIcon:e.jsx(K,{}),onClick:h,disabled:T,children:n("common.refresh")}),e.jsx(d,{variant:"contained",startIcon:e.jsx(O,{}),onClick:()=>A(),children:n("Create Channel")})]})]}),e.jsx(ae,{component:H,children:e.jsxs(te,{children:[e.jsx(le,{children:e.jsxs(m,{children:[e.jsx(s,{children:n("Channel Name")}),e.jsx(s,{children:n("Channel Type")}),e.jsx(s,{children:n("Authentication Info")||"认证信息"}),e.jsx(s,{children:n("Created At")}),e.jsx(s,{align:"right",children:n("common.actions")})]})}),e.jsx(se,{children:T?e.jsx(m,{children:e.jsx(s,{colSpan:5,align:"center",children:n("common.loading")})}):v.length===0?e.jsx(m,{children:e.jsx(s,{colSpan:5,align:"center",children:n("common.noData")})}):v.map(a=>e.jsxs(m,{children:[e.jsx(s,{children:a.channel_name}),e.jsx(s,{children:e.jsx(ie,{label:a.channel_type==="feishu"?n("Feishu")||"飞书":a.channel_type==="dingtalk"?n("DingTalk")||"钉钉":a.channel_type==="wechat"?n("WeChat")||"企业微信":a.channel_type==="email"?n("Email")||"邮件":a.channel_type==="sms"?n("SMS")||"短信":a.channel_type==="webhook"?n("Webhook")||"Webhook":a.channel_type,size:"small"})}),e.jsx(s,{children:e.jsx(b,{title:a.channel_sign,children:e.jsx(L,{variant:"body2",sx:{maxWidth:300,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:a.channel_sign})})}),e.jsx(s,{children:(()=>{const l=("createdAt"in a&&typeof a.createdAt=="string"?a.createdAt:null)||("created_at"in a&&typeof a.created_at=="string"?a.created_at:null);if(!l)return"-";try{const i=new Date(l);return isNaN(i.getTime())?"-":i.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}catch{return"-"}})()}),e.jsx(s,{align:"right",children:e.jsxs(w,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(b,{title:n("common.edit"),children:e.jsx(P,{size:"small",onClick:()=>A(a),children:e.jsx(G,{fontSize:"small"})})}),e.jsx(b,{title:n("common.delete"),children:e.jsx(P,{size:"small",color:"error",onClick:()=>N(a.id),children:e.jsx(J,{fontSize:"small"})})})]})})]},a.id))})]})}),W>0&&e.jsx(C,{sx:{display:"flex",justifyContent:"center",mt:2},children:e.jsx(oe,{count:Math.ceil(W/y),page:f,onChange:(a,l)=>z(l),color:"primary"})})]})}),e.jsxs(Q,{open:E,onClose:j,maxWidth:"md",fullWidth:!0,children:[e.jsx(V,{children:x?n("Edit Channel")||"编辑告警渠道":n("Create Channel")||"新建告警渠道"}),e.jsx(X,{children:e.jsxs(w,{spacing:3,sx:{mt:1},children:[e.jsx(U,{label:`${n("Channel Name")} *`,value:t.channel_name,onChange:a=>c({...t,channel_name:a.target.value}),fullWidth:!0,required:!0}),e.jsxs(Y,{fullWidth:!0,children:[e.jsxs(Z,{children:[n("Channel Type")," *"]}),e.jsxs(ee,{value:t.channel_type,label:`${n("Channel Type")} *`,onChange:a=>c({...t,channel_type:a.target.value}),children:[e.jsx(r,{value:"feishu",children:n("Feishu")||"飞书"}),e.jsx(r,{value:"dingtalk",children:n("DingTalk")||"钉钉"}),e.jsx(r,{value:"wechat",children:n("WeChat")||"企业微信"}),e.jsx(r,{value:"email",children:n("Email")||"邮件"}),e.jsx(r,{value:"sms",children:n("SMS")||"短信"}),e.jsx(r,{value:"webhook",children:n("Webhook")||"Webhook"})]})]}),e.jsx(U,{label:t.channel_type==="webhook"?(n("Webhook URL")||"Webhook URL")+" *":t.channel_type==="email"?(n("Email Address")||"邮箱地址")+" *":t.channel_type==="sms"?(n("Phone Number")||"手机号")+" *":(n("Authentication Info")||"认证信息")+" *",value:t.channel_sign,onChange:a=>c({...t,channel_sign:a.target.value}),fullWidth:!0,required:!0,multiline:!0,rows:3,placeholder:t.channel_type==="webhook"?"https://hooks.example.com/webhook":t.channel_type==="email"?"admin@example.com":t.channel_type==="sms"?"13800138000":t.channel_type==="feishu"||t.channel_type==="dingtalk"||t.channel_type==="wechat"?"https://open.feishu.cn/open-apis/bot/v2/hook/... 或 API Key":"",helperText:t.channel_type==="webhook"?n("Webhook URL helper")||"请输入完整的Webhook URL，用于接收告警通知":t.channel_type==="email"?n("Email helper")||"请输入接收告警通知的邮箱地址":t.channel_type==="sms"?n("Phone number helper")||"请输入接收告警通知的手机号（支持中国大陆手机号）":t.channel_type==="feishu"||t.channel_type==="dingtalk"||t.channel_type==="wechat"?n("Webhook URL or API Key helper")||"请输入Webhook URL或API Key，用于发送告警通知":n("Channel sign/identifier (webhook URL, API key, etc.)")||"请输入认证信息（webhook URL、API key等）",error:t.channel_sign&&t.channel_type?D(t.channel_type,String(t.channel_sign))!==null:!1})]})}),e.jsxs(ne,{children:[e.jsx(d,{onClick:j,children:n("common.cancel")}),e.jsx(d,{onClick:F,variant:"contained",children:n("common.save")})]})]})]})}export{xe as default};
