import{H as D,u as ke,r,bf as f,j as e,B as l,bm as Le,T as i,a as j,v as ze,h as We,P as Me,a3 as Oe,a4 as X,bn as Fe,bo as Re,w as R,x as A,m as p,F as Y,n as Z,o as ee,M as m,C as te,b as ae,y as se,I as Ae,be as Be,i as ne,k as ie,l as re,p as le,a7 as Ee}from"./index-OJNN34VQ.js";import{S as V}from"./Stack-D4jLN6n0.js";import{T as oe,a as ce,b as de,c as B,d as s,e as me}from"./TableRow-Dz3vPXNr.js";import{C as he}from"./Chip-pSvhxX1X.js";import{T as ue}from"./TablePagination-CuKuo8TO.js";import{D as He}from"./DialogContentText-ClHrxm4c.js";import"./LastPage-COOW1SXp.js";const E={getOperationLogs:(a={})=>D.get("/api/v1/audit/operation-logs",{params:a}),getOperationLogDetail:a=>D.get(`/api/v1/audit/operation-logs/${a}`),deleteOperationLog:a=>D.delete(`/api/v1/audit/operation-logs/${a}`),batchDeleteOperationLogs:a=>D.delete("/api/v1/audit/operation-logs/batch",{data:{ids:a}}),getPodCommandLogs:(a={})=>D.get("/api/v1/audit/pod-commands",{params:a})};function xe(a){const{children:g,value:k,index:b,...L}=a;return e.jsx("div",{role:"tabpanel",hidden:k!==b,id:`audit-tabpanel-${b}`,"aria-labelledby":`audit-tab-${b}`,...L,children:k===b&&e.jsx(l,{sx:{pt:3},children:g})})}function Je(){const{t:a}=ke(),[g,k]=r.useState(0),[b,L]=r.useState(!1),[C,H]=r.useState([]),[pe,$]=r.useState(0),[T,w]=r.useState(0),[z,ge]=r.useState(20),[h,_]=r.useState([]),[je,W]=r.useState(!1),[fe,N]=r.useState(!1),[u,be]=r.useState(null),[q,G]=r.useState([]),[ve,U]=r.useState(0),[S,M]=r.useState(0),[O,ye]=r.useState(20),[K,J]=r.useState(!1),[c,Q]=r.useState({username:"",ip:"",path:"",method:"",status:0,start_time:"",end_time:""}),[o,v]=r.useState({cluster_id:"",namespace:"",pod_name:"",username:"",command:"",start_time:"",end_time:""}),I=r.useCallback(async()=>{try{L(!0);const t=x=>x?x.replace("T"," ")+":00":"",n={...c,start_time:c.start_time?t(c.start_time):void 0,end_time:c.end_time?t(c.end_time):void 0,page:T+1,page_size:z},P=(await E.getOperationLogs(n)).data;if(P.code===0){const x=P.data;H(x?.data||[]),$(x?.total||0)}else f(P.message||"加载失败"),H([]),$(0)}catch(t){const n=t?.response?.data?.message||"加载操作日志失败";f(n),H([]),$(0)}finally{L(!1)}},[c,T,z]),F=r.useCallback(async()=>{try{J(!0);const t=x=>x?x.replace("T"," ")+":00":"",n={...o,start_time:o.start_time?t(o.start_time):void 0,end_time:o.end_time?t(o.end_time):void 0,page:S+1,page_size:O},P=(await E.getPodCommandLogs(n)).data;if(P.code===0){const x=P.data;G(x?.data||[]),U(x?.total||0)}else f(P.message||"加载失败"),G([]),U(0)}catch(t){const n=t?.response?.data?.message||"加载 Pod 命令记录失败";f(n),G([]),U(0)}finally{J(!1)}},[o,S,O]);r.useEffect(()=>{g===0?I():F()},[T,z,S,O,g,I,F]);const y=(t,n)=>{Q({...c,[t]:n}),w(0)},Pe=()=>{T===0?I():w(0)},Ce=()=>{Q({username:"",ip:"",path:"",method:"",status:0,start_time:"",end_time:""}),w(0)},Te=t=>{_(t?C.map(n=>n.id):[])},we=(t,n)=>{_(n?[...h,t]:h.filter(d=>d!==t))},_e=async t=>{try{const d=(await E.getOperationLogDetail(t.id)).data;d.code===0?(be(d.data||null),N(!0)):f(d.message||"获取详情失败")}catch(n){const d=n?.response?.data?.message||"获取详情失败";f(d)}},Se=async()=>{if(h.length===0){f("请选择要删除的日志");return}try{await E.batchDeleteOperationLogs(h),Ee("删除成功"),W(!1),_([]),I()}catch(t){const n=t?.response?.data?.message||"删除失败";f(n)}},Ie=t=>t>=200&&t<300?"success":t>=400&&t<500?"warning":t>=500?"error":"default",De=t=>{switch(t){case"POST":return"success";case"PUT":return"info";case"DELETE":return"error";case"PATCH":return"warning";default:return"default"}};return e.jsxs(l,{sx:{width:"100%",p:3},children:[e.jsxs(l,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,flexWrap:"wrap",gap:2,children:[e.jsxs(l,{display:"flex",alignItems:"center",gap:2,children:[e.jsx(Le,{color:"primary",sx:{fontSize:32}}),e.jsxs(l,{children:[e.jsx(i,{variant:"h4",component:"h1",fontWeight:"700",children:a("cluster.audit.title","操作审计")}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:a("cluster.audit.subtitle","查看用户操作 K8s 集群的审计日志")})]})]}),e.jsxs(l,{display:"flex",gap:2,children:[e.jsx(j,{variant:"outlined",startIcon:e.jsx(ze,{}),onClick:()=>{g===0?I():F()},disabled:g===0?b:K,children:a("common.refresh","刷新")}),g===0&&h.length>0&&e.jsxs(j,{variant:"outlined",color:"error",startIcon:e.jsx(We,{}),onClick:()=>W(!0),children:[a("common.delete","删除")," (",h.length,")"]})]})]}),e.jsx(Me,{sx:{mb:3},children:e.jsxs(Oe,{value:g,onChange:(t,n)=>k(n),variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider"},children:[e.jsx(X,{icon:e.jsx(Fe,{}),label:a("cluster.audit.apiLogs","API操作日志"),iconPosition:"start"}),e.jsx(X,{icon:e.jsx(Re,{}),label:a("cluster.audit.podCommands","Pod命令记录"),iconPosition:"start"})]})}),e.jsxs(xe,{value:g,index:0,children:[e.jsx(R,{sx:{mb:3},children:e.jsxs(A,{children:[e.jsx(i,{variant:"h6",gutterBottom:!0,sx:{mb:2},children:a("common.filter","筛选条件")}),e.jsxs(V,{direction:"row",spacing:2,flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(p,{label:a("cluster.audit.username","用户名"),value:c.username,onChange:t=>y("username",t.target.value),size:"small",sx:{minWidth:150}}),e.jsx(p,{label:a("cluster.audit.ip","IP地址"),value:c.ip,onChange:t=>y("ip",t.target.value),size:"small",sx:{minWidth:150}}),e.jsx(p,{label:a("cluster.audit.path","API路径"),value:c.path,onChange:t=>y("path",t.target.value),size:"small",sx:{minWidth:200}}),e.jsxs(Y,{size:"small",sx:{minWidth:120},children:[e.jsx(Z,{children:a("cluster.audit.method","HTTP方法")}),e.jsxs(ee,{value:c.method||"",onChange:t=>y("method",t.target.value||""),label:a("cluster.audit.method","HTTP方法"),children:[e.jsx(m,{value:"",children:a("common.all","全部")}),e.jsx(m,{value:"GET",children:"GET"}),e.jsx(m,{value:"POST",children:"POST"}),e.jsx(m,{value:"PUT",children:"PUT"}),e.jsx(m,{value:"DELETE",children:"DELETE"}),e.jsx(m,{value:"PATCH",children:"PATCH"})]})]}),e.jsxs(Y,{size:"small",sx:{minWidth:120},children:[e.jsx(Z,{children:a("cluster.audit.status","状态码")}),e.jsxs(ee,{value:c.status||0,onChange:t=>y("status",t.target.value),label:a("cluster.audit.status","状态码"),children:[e.jsx(m,{value:0,children:a("common.all","全部")}),e.jsx(m,{value:200,children:"200"}),e.jsx(m,{value:400,children:"400"}),e.jsx(m,{value:401,children:"401"}),e.jsx(m,{value:403,children:"403"}),e.jsx(m,{value:404,children:"404"}),e.jsx(m,{value:500,children:"500"})]})]}),e.jsx(p,{label:a("cluster.audit.startTime","开始时间"),type:"datetime-local",value:c.start_time,onChange:t=>y("start_time",t.target.value),size:"small",InputLabelProps:{shrink:!0},sx:{minWidth:200}}),e.jsx(p,{label:a("cluster.audit.endTime","结束时间"),type:"datetime-local",value:c.end_time,onChange:t=>y("end_time",t.target.value),size:"small",InputLabelProps:{shrink:!0},sx:{minWidth:200}}),e.jsxs(l,{display:"flex",gap:1,alignItems:"center",children:[e.jsx(j,{variant:"contained",onClick:Pe,children:a("common.query","查询")}),e.jsx(j,{variant:"outlined",onClick:Ce,children:a("common.reset","重置")})]})]})]})}),e.jsx(R,{children:e.jsx(A,{children:b?e.jsx(l,{display:"flex",justifyContent:"center",p:3,children:e.jsx(te,{})}):C.length===0?e.jsx(ae,{severity:"info",children:a("common.noData","暂无数据")}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{children:e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(B,{children:[e.jsx(s,{padding:"checkbox",children:e.jsx(se,{checked:h.length===C.length&&C.length>0,indeterminate:h.length>0&&h.length<C.length,onChange:t=>Te(t.target.checked)})}),e.jsx(s,{children:a("cluster.audit.username","用户名")}),e.jsx(s,{children:a("cluster.audit.ip","IP地址")}),e.jsx(s,{children:a("cluster.audit.method","方法")}),e.jsx(s,{children:a("cluster.audit.path","路径")}),e.jsx(s,{children:a("cluster.audit.desc","描述")}),e.jsx(s,{children:a("cluster.audit.status","状态")}),e.jsx(s,{children:a("cluster.audit.timeCost","耗时(ms)")}),e.jsx(s,{children:a("cluster.audit.startTime","操作时间")}),e.jsx(s,{align:"right",children:a("common.actions","操作")})]})}),e.jsx(me,{children:C.map(t=>e.jsxs(B,{hover:!0,children:[e.jsx(s,{padding:"checkbox",children:e.jsx(se,{checked:h.includes(t.id),onChange:n=>we(t.id,n.target.checked)})}),e.jsx(s,{children:t.username}),e.jsx(s,{children:e.jsx(i,{variant:"body2",sx:{fontFamily:"monospace"},children:t.ip})}),e.jsx(s,{children:e.jsx(he,{label:t.method,size:"small",color:De(t.method)})}),e.jsx(s,{children:e.jsx(i,{variant:"body2",sx:{fontFamily:"monospace",maxWidth:300,overflow:"hidden",textOverflow:"ellipsis"},children:t.path})}),e.jsx(s,{children:t.desc||"-"}),e.jsx(s,{children:e.jsx(he,{label:t.status,size:"small",color:Ie(t.status)})}),e.jsx(s,{children:t.time_cost?`${t.time_cost}ms`:"-"}),e.jsx(s,{children:new Date(t.start_time).toLocaleString("zh-CN")}),e.jsx(s,{align:"right",children:e.jsx(Ae,{size:"small",onClick:()=>_e(t),title:a("common.view","查看"),children:e.jsx(Be,{fontSize:"small"})})})]},t.id))})]})}),e.jsx(ue,{component:"div",count:pe,page:T,onPageChange:(t,n)=>w(n),rowsPerPage:z,onRowsPerPageChange:t=>{ge(parseInt(t.target.value,10)),w(0)},rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:a("common.rowsPerPage","每页行数"),labelDisplayedRows:({from:t,to:n,count:d})=>`${t}-${n} ${a("common.of","共")} ${d}`,sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]})})})]}),e.jsxs(xe,{value:g,index:1,children:[e.jsx(R,{sx:{mb:3},children:e.jsxs(A,{children:[e.jsx(i,{variant:"h6",gutterBottom:!0,sx:{mb:2},children:a("common.filter","筛选条件")}),e.jsxs(V,{direction:"row",spacing:2,flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(p,{label:a("cluster.audit.username","用户名"),value:o.username,onChange:t=>v({...o,username:t.target.value}),size:"small",sx:{minWidth:150}}),e.jsx(p,{label:a("k8s.selectNamespace","命名空间"),value:o.namespace,onChange:t=>v({...o,namespace:t.target.value}),size:"small",sx:{minWidth:150}}),e.jsx(p,{label:a("k8s.pods.title","Pod名称"),value:o.pod_name,onChange:t=>v({...o,pod_name:t.target.value}),size:"small",sx:{minWidth:150}}),e.jsx(p,{label:a("cluster.audit.command","命令"),value:o.command,onChange:t=>v({...o,command:t.target.value}),size:"small",sx:{minWidth:200}}),e.jsx(p,{label:a("cluster.audit.startTime","开始时间"),type:"datetime-local",value:o.start_time,onChange:t=>v({...o,start_time:t.target.value}),size:"small",InputLabelProps:{shrink:!0},sx:{minWidth:200}}),e.jsx(p,{label:a("cluster.audit.endTime","结束时间"),type:"datetime-local",value:o.end_time,onChange:t=>v({...o,end_time:t.target.value}),size:"small",InputLabelProps:{shrink:!0},sx:{minWidth:200}}),e.jsxs(l,{display:"flex",gap:1,alignItems:"center",children:[e.jsx(j,{variant:"contained",onClick:()=>{S===0?F():M(0)},children:a("common.query","查询")}),e.jsx(j,{variant:"outlined",onClick:()=>{v({cluster_id:"",namespace:"",pod_name:"",username:"",command:"",start_time:"",end_time:""}),M(0)},children:a("common.reset","重置")})]})]})]})}),e.jsx(R,{children:e.jsx(A,{children:K?e.jsx(l,{display:"flex",justifyContent:"center",p:3,children:e.jsx(te,{})}):q.length===0?e.jsx(ae,{severity:"info",children:a("common.noData","暂无数据")}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{children:e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(B,{children:[e.jsx(s,{children:a("cluster.audit.operator","操作人")}),e.jsx(s,{children:a("k8s.cluster","集群")}),e.jsx(s,{children:a("k8s.selectNamespace","命名空间")}),e.jsx(s,{children:a("k8s.pods.title","Pod名称")}),e.jsx(s,{children:a("k8s.containers","容器")}),e.jsx(s,{children:a("cluster.audit.command","命令")}),e.jsx(s,{children:a("cluster.audit.startTime","执行时间")})]})}),e.jsx(me,{children:q.map(t=>e.jsxs(B,{hover:!0,children:[e.jsx(s,{children:t.username||"-"}),e.jsx(s,{children:t.clusterName||"-"}),e.jsx(s,{children:t.namespace||"-"}),e.jsx(s,{children:t.podName||"-"}),e.jsx(s,{children:t.container||"-"}),e.jsx(s,{children:e.jsx(i,{variant:"body2",sx:{fontFamily:"monospace",maxWidth:400,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},title:t.command,children:t.command})}),e.jsx(s,{children:t.executedAt?new Date(t.executedAt).toLocaleString("zh-CN"):"-"})]},t.id))})]})}),e.jsx(ue,{component:"div",count:ve,page:S,onPageChange:(t,n)=>M(n),rowsPerPage:O,onRowsPerPageChange:t=>{ye(parseInt(t.target.value,10)),M(0)},rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:a("common.rowsPerPage","每页行数"),labelDisplayedRows:({from:t,to:n,count:d})=>`${t}-${n} ${a("common.of","共")} ${d}`,sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]})})})]}),e.jsxs(ne,{open:je,onClose:()=>W(!1),children:[e.jsx(ie,{children:a("common.confirmDelete","确认删除")}),e.jsx(re,{children:e.jsx(He,{children:a("cluster.audit.confirmDeleteMessage","确定要删除选中的 {count} 条操作日志吗？",{count:h.length})})}),e.jsxs(le,{children:[e.jsx(j,{onClick:()=>W(!1),children:a("common.cancel","取消")}),e.jsx(j,{onClick:Se,color:"error",variant:"contained",children:a("common.delete","删除")})]})]}),e.jsxs(ne,{open:fe,onClose:()=>N(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ie,{children:a("cluster.audit.detail","操作日志详情")}),e.jsx(re,{children:u&&e.jsx(l,{sx:{mt:2},children:e.jsxs(V,{spacing:2,children:[e.jsxs(l,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:a("cluster.audit.username","用户名")}),e.jsx(i,{variant:"body1",children:u.username})]}),e.jsxs(l,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:a("cluster.audit.ip","IP地址")}),e.jsx(i,{variant:"body1",sx:{fontFamily:"monospace"},children:u.ip})]}),e.jsxs(l,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:a("cluster.audit.method","HTTP方法")}),e.jsx(i,{variant:"body1",children:u.method})]}),e.jsxs(l,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:a("cluster.audit.path","API路径")}),e.jsx(i,{variant:"body1",sx:{fontFamily:"monospace",wordBreak:"break-all"},children:u.path})]}),e.jsxs(l,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:a("cluster.audit.desc","操作描述")}),e.jsx(i,{variant:"body1",children:u.desc||"-"})]}),e.jsxs(l,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:a("cluster.audit.status","状态码")}),e.jsx(i,{variant:"body1",children:u.status})]}),e.jsxs(l,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:a("cluster.audit.timeCost","耗时")}),e.jsx(i,{variant:"body1",children:u.time_cost?`${u.time_cost}ms`:"-"})]}),e.jsxs(l,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:a("cluster.audit.startTime","操作时间")}),e.jsx(i,{variant:"body1",children:new Date(u.start_time).toLocaleString("zh-CN")})]}),e.jsxs(l,{children:[e.jsx(i,{variant:"caption",color:"text.secondary",children:a("cluster.audit.userAgent","User Agent")}),e.jsx(i,{variant:"body2",sx:{fontFamily:"monospace",wordBreak:"break-all"},children:u.user_agent||"-"})]})]})})}),e.jsx(le,{children:e.jsx(j,{onClick:()=>N(!1),children:a("common.close","关闭")})})]})]})}export{Je as default};
