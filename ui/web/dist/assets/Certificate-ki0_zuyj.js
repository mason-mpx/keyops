import{H as n,u as oe,r as o,j as t,B as u,T as p,m as b,s as O,I as S,v as K,a as _,A as le,w as de,i as me,k as fe,l as ue,b as pe,ab as V,cB as G,c as J,_ as he,F as xe,n as ge,o as je,M as Q,p as Ce,C as be,t as ye,bf as y,a7 as x,P as De,d as F,g as Se,h as _e}from"./index-STo1oTDL.js";import{a as we}from"./alertApi-ZkZdrWaX.js";import{S as D}from"./Stack-BJqE2zD7.js";import{P as ve}from"./Pagination-CJp52pDe.js";import{C as w}from"./Chip-v5QMYL72.js";import{S as Te}from"./Switch-Do7Epm1v.js";import{T as Ie,a as ke,b as We,c as v,d as c,e as ze}from"./TableRow-e9fRaRV7.js";import{L as $e}from"./LinearProgress-CY26lNIv.js";import"./LastPage-Bb7RE8XJ.js";const h={getDomainCertificates:e=>n.get("/api/alerts/certificates/domains",{params:e}),getDomainCertificate:e=>n.get(`/api/alerts/certificates/domains/${e}`),createDomainCertificate:e=>n.post("/api/alerts/certificates/domains",e),updateDomainCertificate:(e,f)=>n.put(`/api/alerts/certificates/domains/${e}`,f),deleteDomainCertificate:e=>n.delete(`/api/alerts/certificates/domains/${e}`),deleteDomainCertificates:e=>n.post("/api/alerts/certificates/domains/batch-delete",{ids:e}),refreshDomainCertificate:e=>n.post(`/api/alerts/certificates/domains/${e}/refresh`),getSslCertificates:e=>n.get("/api/alerts/certificates/ssl",{params:e}),getSslCertificate:e=>n.get(`/api/alerts/certificates/ssl/${e}`),createSslCertificate:e=>n.post("/api/alerts/certificates/ssl",e),updateSslCertificate:(e,f)=>n.put(`/api/alerts/certificates/ssl/${e}`,f),deleteSslCertificate:e=>n.delete(`/api/alerts/certificates/ssl/${e}`),deleteSslCertificates:e=>n.post("/api/alerts/certificates/ssl/batch-delete",{ids:e}),getHostedCertificates:e=>n.get("/api/alerts/certificates/hosted",{params:e}),getHostedCertificate:e=>n.get(`/api/alerts/certificates/hosted/${e}`),createHostedCertificate:e=>n.post("/api/alerts/certificates/hosted",e),updateHostedCertificate:(e,f)=>n.put(`/api/alerts/certificates/hosted/${e}`,f),deleteHostedCertificate:e=>n.delete(`/api/alerts/certificates/hosted/${e}`),deleteHostedCertificates:e=>n.post("/api/alerts/certificates/hosted/batch-delete",{ids:e}),getCertificateStatistics:()=>n.get("/api/alerts/certificates/statistics"),importDomainCertificates:e=>{const f=new FormData;return f.append("file",e),n.post("/api/alerts/certificates/domains/import",f,{headers:{"Content-Type":"multipart/form-data"}})}};function Ne(){const{t:e}=oe(),[f,P]=o.useState(!1),[T,U]=o.useState(1),[I]=o.useState(10),[A,X]=o.useState(0),[k,Y]=o.useState(""),[L,R]=o.useState([]),[Z,H]=o.useState(!1),[l,j]=o.useState(null),[i,d]=o.useState({}),[C,W]=o.useState(!1),[ee,B]=o.useState([]),[te,E]=o.useState(!1),g=o.useCallback(async()=>{try{P(!0);const a=await h.getDomainCertificates({page:T,page_size:I,keyword:k});if(a.data.code===0||a.data.code===200){const s=a.data.data||[];R(s),X(a.data.total||0)}}catch(a){console.error("Failed to fetch domain certificates:",a),R([])}finally{P(!1)}},[T,I,k]),M=o.useCallback(async()=>{try{E(!0);const a=await we.getTemplates({page:1,page_size:1e3});(a.data.code===0||a.data.code===200)&&B(a.data.data||[])}catch(a){console.error("Failed to fetch alert templates:",a),B([])}finally{E(!1)}},[]);o.useEffect(()=>{g(),M()},[g,M]);const N=a=>{a?(j(a),d({...a})):(j(null),d({domain:"",port:443,is_monitor:!0,alert_days:30,alert_template_id:void 0})),W(!1),H(!0)},ae=async()=>{if(!i.domain){y(e("menu.certificate.domainRequired")||"请输入域名");return}try{if(W(!0),l&&l.id){const a=await h.refreshDomainCertificate(l.id);if(a.data.code===0){const s=a.data.data;d({...s}),x(e("menu.certificate.refreshSuccess")||"证书信息刷新成功")}}else{const a={domain:i.domain,port:i.port||443,is_monitor:i.is_monitor??!0,comment:i.comment||"",alert_days:i.alert_days||30,alert_template_id:i.alert_template_id},s=await h.createDomainCertificate(a);if(s.data.code===0){const r=s.data.data;try{const m=await h.refreshDomainCertificate(r.id);if(m.data.code===0){const $=m.data.data;d({...$}),j({...$}),x(e("menu.certificate.detectSuccess")||"证书信息检测成功")}}catch{d({...r}),j({...r}),x(e("menu.certificate.detectSuccess")||"证书已添加，但检测证书信息失败，请稍后手动刷新")}}}}catch(a){y(a?.response?.data?.message||e("menu.certificate.detectFailed")||"检测证书信息失败")}finally{W(!1)}},z=()=>{H(!1),j(null),d({})},ie=async()=>{try{const a={...i};l&&l.id?(await h.updateDomainCertificate(l.id,a),x(e("common.updateSuccess"))):(await h.createDomainCertificate(a),x(e("common.createSuccess"))),z(),g()}catch(a){y(a?.response?.data?.message||e("common.operationFailed"))}},se=async a=>{const s=e("common.confirmDelete")||e("common.delete");if(window.confirm(s))try{await h.deleteDomainCertificate(a),x(e("common.deleteSuccess")),g()}catch(r){y(r?.response?.data?.message||e("common.operationFailed"))}},re=()=>{g()},ne=a=>{if(!a)return null;const s=new Date(a),r=new Date,m=s.getTime()-r.getTime();return Math.floor(m/(1e3*60*60*24))},q=(a,s)=>{const r=ne(a);if(r===null)return{label:e("menu.certificate.unknown"),color:"default"};const m=e("menu.certificate.remainingDaysFormat",{days:r})||`${e("menu.certificate.remainingDays")}${r}${e("common.day")}`;return r<0?{label:e("menu.certificate.expired"),color:"error"}:s!=null&&!isNaN(s)&&s>0?r<=s?r<=10?{label:m,color:"error"}:r<30?{label:m,color:"warning"}:{label:m,color:"success"}:{label:m,color:"success"}:r<=10?{label:m,color:"error"}:r<30?{label:m,color:"warning"}:{label:m,color:"success"}},ce=()=>t.jsx(Ie,{component:De,elevation:0,sx:{border:"1px solid #e2e8f0"},children:t.jsxs(ke,{children:[t.jsx(We,{children:t.jsxs(v,{children:[t.jsx(c,{sx:{fontWeight:700},children:e("menu.certificate.domain")}),t.jsx(c,{sx:{fontWeight:700},children:e("menu.certificate.port")}),t.jsx(c,{sx:{fontWeight:700},children:e("menu.certificate.startTime")}),t.jsx(c,{sx:{fontWeight:700},children:e("menu.certificate.expireTime")}),t.jsx(c,{sx:{fontWeight:700},children:e("menu.certificate.status")}),t.jsx(c,{sx:{fontWeight:700},children:e("menu.certificate.alertDays")||"告警天数"}),t.jsx(c,{sx:{fontWeight:700},children:e("menu.certificate.monitor")}),t.jsx(c,{sx:{fontWeight:700},align:"right",children:e("menu.certificate.actions")})]})}),t.jsx(ze,{children:f?t.jsx(v,{children:t.jsx(c,{colSpan:8,children:t.jsx($e,{})})}):L.length===0?t.jsx(v,{children:t.jsx(c,{colSpan:8,align:"center",sx:{py:4},children:t.jsx(p,{color:"text.secondary",children:e("common.noData")})})}):L.map(a=>{const s=q(a.expire_time,a.alert_days);return t.jsxs(v,{hover:!0,children:[t.jsx(c,{children:a.domain}),t.jsx(c,{children:a.port||443}),t.jsx(c,{children:a.start_time?new Date(a.start_time).toLocaleDateString():"-"}),t.jsx(c,{children:a.expire_time?new Date(a.expire_time).toLocaleDateString():"-"}),t.jsx(c,{children:a.expire_time?t.jsx(w,{label:s.label,color:s.color,size:"small",icon:s.color==="error"?t.jsx(V,{}):s.color==="warning"?t.jsx(G,{}):t.jsx(J,{})}):t.jsx(w,{label:e("menu.certificate.unknown"),color:"default",size:"small"})}),t.jsx(c,{children:a.alert_days?`${a.alert_days}${e("common.day")}`:"-"}),t.jsx(c,{children:t.jsx(w,{label:a.is_monitor?e("menu.certificate.enabled"):e("menu.certificate.disabled"),color:a.is_monitor?"success":"default",size:"small"})}),t.jsx(c,{align:"right",children:t.jsxs(D,{direction:"row",spacing:1,justifyContent:"flex-end",children:[t.jsx(F,{title:e("menu.certificate.refresh")||"刷新证书信息",children:t.jsx(S,{size:"small",onClick:async()=>{try{await h.refreshDomainCertificate(a.id),x(e("menu.certificate.refreshSuccess")||"刷新成功"),g()}catch(r){y(r?.response?.data?.message||e("common.operationFailed"))}},children:t.jsx(K,{fontSize:"small"})})}),t.jsx(F,{title:e("common.edit"),children:t.jsx(S,{size:"small",onClick:()=>N(a),children:t.jsx(Se,{fontSize:"small"})})}),t.jsx(F,{title:e("common.delete"),children:t.jsx(S,{size:"small",color:"error",onClick:()=>se(a.id),children:t.jsx(_e,{fontSize:"small"})})})]})})]},a.id)})})]})});return t.jsxs(u,{children:[t.jsxs(u,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[t.jsx(p,{variant:"h4",component:"h1",children:e("menu.monitorCertificate")}),t.jsxs(D,{direction:"row",spacing:2,children:[t.jsx(b,{size:"small",placeholder:e("common.search"),value:k,onChange:a=>Y(a.target.value),InputProps:{endAdornment:t.jsx(O,{position:"end",children:t.jsx(S,{size:"small",onClick:re,children:t.jsx(K,{})})})},sx:{minWidth:200}}),t.jsx(_,{variant:"contained",startIcon:t.jsx(le,{}),onClick:()=>N(),children:e("menu.certificate.addDomain")||"添加域名"})]})]}),t.jsxs(de,{elevation:0,sx:{border:"1px solid #e2e8f0"},children:[ce(),A>0&&t.jsx(u,{display:"flex",justifyContent:"center",mt:3,pb:3,children:t.jsx(ve,{count:Math.ceil(A/I),page:T,onChange:(a,s)=>U(s),color:"primary"})})]}),t.jsxs(me,{open:Z,onClose:z,maxWidth:"md",fullWidth:!0,children:[t.jsxs(fe,{children:[l?e("common.edit"):e("menu.certificate.addDomain")||"添加域名"," ",l?e("menu.certificate.domainCertificate"):""]}),t.jsx(ue,{children:t.jsxs(D,{spacing:3,sx:{mt:2},children:[t.jsx(pe,{severity:"info",children:e("menu.certificate.monitorTip")}),t.jsxs(u,{sx:{display:"flex",gap:2,alignItems:"flex-start"},children:[t.jsx(b,{label:e("menu.certificate.domain"),value:i.domain||"",onChange:a=>d({...i,domain:a.target.value}),required:!0,fullWidth:!0,disabled:!!l||C,placeholder:"example.com"}),t.jsx(b,{label:e("menu.certificate.port"),type:"number",value:i.port||443,onChange:a=>d({...i,port:parseInt(a.target.value)}),disabled:!!l||C,sx:{width:120}})]}),i.expire_time&&t.jsxs(u,{children:[t.jsx(p,{variant:"subtitle2",gutterBottom:!0,children:e("menu.certificate.certificateInfo")}),t.jsxs(D,{spacing:2,sx:{mt:1,p:2,bgcolor:"grey.50",borderRadius:1},children:[t.jsxs(u,{sx:{display:"flex",justifyContent:"space-between"},children:[t.jsxs(p,{variant:"body2",color:"text.secondary",children:[e("menu.certificate.startTime"),":"]}),t.jsx(p,{variant:"body2",children:i.start_time?new Date(i.start_time).toLocaleString():"-"})]}),t.jsxs(u,{sx:{display:"flex",justifyContent:"space-between"},children:[t.jsxs(p,{variant:"body2",color:"text.secondary",children:[e("menu.certificate.expireTime"),":"]}),t.jsx(p,{variant:"body2",fontWeight:"bold",children:i.expire_time?new Date(i.expire_time).toLocaleString():"-"})]}),i.expire_time&&t.jsx(u,{children:(()=>{const a=q(i.expire_time,i.alert_days);return t.jsx(w,{icon:a.color==="error"?t.jsx(V,{}):a.color==="warning"?t.jsx(G,{}):t.jsx(J,{}),label:a.label,color:a.color,size:"small"})})()})]})]}),t.jsx(he,{control:t.jsx(Te,{checked:i.is_monitor??!0,onChange:a=>d({...i,is_monitor:a.target.checked})}),label:e("menu.certificate.enableMonitor")}),t.jsxs(u,{sx:{p:2,bgcolor:"grey.50",borderRadius:1},children:[t.jsx(p,{variant:"subtitle2",gutterBottom:!0,children:e("menu.certificate.alertConfig")||"告警配置"}),t.jsxs(D,{spacing:2,sx:{mt:2},children:[t.jsx(b,{label:e("menu.certificate.alertDays")||"告警天数",type:"number",value:i.alert_days??30,onChange:a=>{const s=a.target.value;if(s==="")d({...i,alert_days:void 0});else{const r=parseInt(s,10);!isNaN(r)&&r>0&&d({...i,alert_days:r})}},fullWidth:!0,helperText:e("menu.certificate.alertDaysHelp")||"当证书剩余天数小于等于此值时，将发送告警通知",InputProps:{endAdornment:t.jsx(O,{position:"end",children:e("common.day")})},inputProps:{min:1,step:1}}),t.jsxs(xe,{fullWidth:!0,children:[t.jsx(ge,{children:e("menu.certificate.alertTemplate")||"告警模板"}),t.jsxs(je,{value:i.alert_template_id||"",onChange:a=>d({...i,alert_template_id:a.target.value||void 0}),label:e("menu.certificate.alertTemplate")||"告警模板",disabled:te,children:[t.jsx(Q,{value:"",children:t.jsx("em",{children:e("common.none")||"无"})}),ee.map(a=>t.jsx(Q,{value:a.id,children:a.template_name},a.id))]})]})]})]}),t.jsx(b,{label:e("menu.certificate.comment"),multiline:!0,rows:2,value:i.comment||"",onChange:a=>d({...i,comment:a.target.value}),fullWidth:!0,placeholder:e("menu.certificate.commentPlaceholder")})]})}),t.jsxs(Ce,{children:[t.jsx(_,{onClick:z,children:e("common.cancel")}),t.jsx(_,{variant:"outlined",onClick:ae,disabled:C||!i.domain||!!l&&!l.id,startIcon:C?t.jsx(be,{size:16}):t.jsx(ye,{}),children:e(C?"menu.certificate.detecting":l?"menu.certificate.refresh":"menu.certificate.detect")}),t.jsx(_,{variant:"contained",onClick:ie,disabled:!l&&!i.expire_time,children:e("common.save")})]})]})]})}export{Ne as default};
