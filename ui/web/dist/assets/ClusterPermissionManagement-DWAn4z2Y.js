import{u as Te,bg as Ie,ax as Ne,r as a,bf as F,b4 as Pe,H as ke,j as s,B as d,I as ae,aA as we,T as W,F as y,n as v,o as b,M as l,a as T,v as Ae,A as De,b as z,C as ne,P as Le,h as Re,i as Fe,k as We,l as ze,m as M,bh as Me,p as Ue}from"./index-DNdAKB9f.js";import{k as le,a as U}from"./k8sClusterApi-YbI-1DRG.js";import{g as $e}from"./namespaces-BF_k4IWA.js";import{T as Be,a as Ee,b as He,c as $,d as i,e as Oe}from"./TableRow-2FuGKbnY.js";import{C as ie}from"./Chip-B8lB6W_F.js";import{A as oe}from"./Autocomplete-DeIHe46-.js";import{S as qe}from"./Snackbar-BNPwnsz4.js";import"./utils-5I4TgzTo.js";function Ze(){const{t:r}=Te(),{clusterId:m}=Ie(),I=Ne(),[B,C]=a.useState(!1),[n,S]=a.useState(m||""),[E,ce]=a.useState([]),[ue,H]=a.useState(null),[O,q]=a.useState([]),[h,de]=a.useState([]),[x,me]=a.useState([]),[pe,G]=a.useState([]),[he,_]=a.useState(!1),[J,K]=a.useState(!1),[p,Q]=a.useState("user"),[N,P]=a.useState(""),[k,w]=a.useState(""),[A,V]=a.useState(""),[u,X]=a.useState("namespace"),[Y,D]=a.useState(""),[Z,ee]=a.useState("read"),[g,c]=a.useState({open:!1,message:"",severity:"success"}),se=a.useCallback(async()=>{try{const e=await le.listClusters();ce(e),m&&e.find(t=>t.id===m)?S(m):e.length>0&&!n?S(e[0].id):e.length===0&&S("")}catch(e){const t=e?.response?.data?.message||r("cluster.permission.loadClustersFailed","加载集群列表失败");F(t)}},[m,n,r]),re=a.useCallback(async()=>{if(n)try{const t=(await $e({clusterId:n})).map(o=>o.name);G(t)}catch(e){console.error("加载命名空间列表失败:",e),G(["default","kube-system","kube-public"])}},[n]),te=a.useCallback(async()=>{if(n)try{const e=await le.getCluster(n);H(e),await re()}catch(e){const t=e?.response?.data?.message||r("cluster.permission.loadClusterFailed","加载集群信息失败");F(t)}},[n,re,r]),j=a.useCallback(async()=>{if(n)try{C(!0);const e=await U.getClusterPermissions(n);q(e||[])}catch(e){const t=e?.response?.data?.message||r("cluster.permission.loadPermissionsFailed","加载权限列表失败");F(t)}finally{C(!1)}},[n,r]);a.useEffect(()=>{se(),xe(),ge()},[se]),a.useEffect(()=>{n?(te(),j()):(H(null),q([]))},[n,te,j]);const xe=async()=>{try{const e=await Pe.getUsersWithRoles({page:1,pageSize:1e3});de(e.users||[])}catch(e){console.error("加载用户列表失败:",e)}},ge=async()=>{try{const e=await ke.get("/api/roles"),t=e.data?.data||e.data||[];me(Array.isArray(t)?t.map(o=>({id:o.id,name:o.name})):[])}catch(e){console.error("加载角色列表失败:",e)}},je=()=>{Q("user"),P(""),w(""),V(""),X("namespace"),D(""),ee("read"),_(!0)},L=()=>{_(!1)},fe=async()=>{if(!n){c({open:!0,message:r("cluster.permission.selectCluster","请先选择集群"),severity:"error"});return}if(p==="user"&&!N){c({open:!0,message:r("cluster.permission.selectUser","请选择用户"),severity:"error"});return}if(p==="role"&&!k){c({open:!0,message:r("cluster.permission.selectRole","请选择角色"),severity:"error"});return}if(!A){c({open:!0,message:r("cluster.permission.selectNamespace","请选择命名空间"),severity:"error"});return}try{K(!0),await U.addPermission({userId:p==="user"?N:void 0,roleId:p==="role"?k:void 0,clusterId:n,namespace:A,resourceType:u==="namespace"?"":u,resourceName:Y||void 0,action:Z}),c({open:!0,message:r("cluster.permission.addSuccess","权限添加成功"),severity:"success"}),L(),j()}catch(e){const t=e?.response?.data?.message||r("cluster.permission.addFailed","权限添加失败");c({open:!0,message:t,severity:"error"})}finally{K(!1)}},ye=async e=>{if(n&&window.confirm(r("cluster.permission.deleteConfirm","确定要删除该权限吗？")))try{C(!0);const t=h.length>0&&h.some(R=>R.id===e.sub),o=x.length>0&&x.some(R=>R.id===e.sub),f=t?e.sub:o?void 0:e.sub,Se=o?e.sub:void 0;await U.removePermission({userId:f,roleId:Se,clusterId:n,namespace:e.namespace,resourceType:e.resourceType||void 0,resourceName:e.resourceName||void 0,action:e.action}),c({open:!0,message:r("cluster.permission.deleteSuccess","权限删除成功"),severity:"success"}),j()}catch(t){const o=t?.response?.data?.message||r("cluster.permission.deleteFailed","权限删除失败");c({open:!0,message:o,severity:"error"})}finally{C(!1)}},ve=e=>r(`cluster.permission.action.${e}`,e),be=e=>!e||e==="namespace"?r("cluster.permission.resourceType.namespace","Namespace"):r(`cluster.permission.resourceType.${e}`,e),Ce=e=>{const t=h.find(f=>f.id===e);if(t)return`${t.fullName} (${t.username})`;const o=x.find(f=>f.id===e);return o?`${o.name} (角色)`:e};return s.jsxs(d,{sx:{width:"100%",p:3},children:[s.jsxs(d,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[s.jsxs(d,{display:"flex",alignItems:"center",gap:2,children:[m&&s.jsx(ae,{onClick:()=>I("/clusters"),size:"small",children:s.jsx(we,{})}),s.jsxs(d,{children:[s.jsx(W,{variant:"h4",component:"h1",fontWeight:"700",children:r("cluster.permission.title","k8S权限管理")}),s.jsx(W,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:ue?.name||(n?r("cluster.permission.selectCluster","请先选择集群"):"")})]})]}),s.jsxs(d,{display:"flex",gap:2,children:[s.jsxs(y,{sx:{minWidth:200},children:[s.jsx(v,{children:r("cluster.permission.selectCluster","选择集群")}),s.jsx(b,{value:n,onChange:e=>{S(e.target.value),e.target.value?I(`/clusters/${e.target.value}/permissions`,{replace:!0}):I("/cluster-permissions",{replace:!0})},label:r("cluster.permission.selectCluster","选择集群"),displayEmpty:!0,children:E.length===0?s.jsx(l,{value:"",disabled:!0,children:r("cluster.permission.noClusters","暂无集群")}):E.map(e=>s.jsx(l,{value:e.id,children:e.name},e.id))})]}),n&&s.jsxs(s.Fragment,{children:[s.jsx(T,{variant:"outlined",startIcon:s.jsx(Ae,{}),onClick:j,disabled:B,children:r("common.refresh","刷新")}),s.jsx(T,{variant:"contained",startIcon:s.jsx(De,{}),onClick:je,children:r("cluster.permission.addPermission","添加权限")})]})]})]}),n?B?s.jsx(d,{display:"flex",justifyContent:"center",p:3,children:s.jsx(ne,{})}):s.jsx(Be,{component:Le,children:s.jsxs(Ee,{children:[s.jsx(He,{children:s.jsxs($,{children:[s.jsx(i,{children:r("cluster.permission.subject","授权对象")}),s.jsx(i,{children:r("cluster.permission.namespace","命名空间")}),s.jsx(i,{children:r("cluster.permission.resourceTypeLabel","资源类型")}),s.jsx(i,{children:r("cluster.permission.resourceName","资源名称")}),s.jsx(i,{children:r("cluster.permission.actionLabel","操作权限")}),s.jsx(i,{align:"right",children:r("common.actions","操作")})]})}),s.jsx(Oe,{children:O.length===0?s.jsx($,{children:s.jsx(i,{colSpan:6,align:"center",children:s.jsx(W,{color:"text.secondary",sx:{py:3},children:r("cluster.permission.noData","暂无权限记录")})})}):O.map((e,t)=>s.jsxs($,{children:[s.jsx(i,{children:Ce(e.sub)}),s.jsx(i,{children:s.jsx(ie,{label:e.namespace,size:"small"})}),s.jsx(i,{children:be(e.resourceType)}),s.jsx(i,{children:e.resourceName||"-"}),s.jsx(i,{children:s.jsx(ie,{label:ve(e.action),size:"small",color:e.action==="admin"?"error":e.action==="write"||e.action==="delete"?"warning":"default"})}),s.jsx(i,{align:"right",children:s.jsx(ae,{size:"small",onClick:()=>ye(e),color:"error",title:r("common.delete","删除"),children:s.jsx(Re,{fontSize:"small"})})})]},t))})]})}):s.jsx(z,{severity:"info",sx:{mt:2},children:r("cluster.permission.selectClusterFirst","请先选择一个集群查看权限")}),s.jsxs(Fe,{open:he,onClose:L,maxWidth:"sm",fullWidth:!0,children:[s.jsx(We,{children:r("cluster.permission.addPermission","添加权限")}),s.jsxs(ze,{children:[s.jsx(z,{severity:"info",sx:{mb:2,fontSize:"0.875rem"},children:r("cluster.permission.apiPermissionHint","提示：添加资源权限时会自动创建对应的API权限（如查看日志、进入终端等）")}),s.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:2,pt:2},children:[s.jsxs(y,{fullWidth:!0,children:[s.jsx(v,{children:r("cluster.permission.grantType","授权类型")}),s.jsxs(b,{value:p,onChange:e=>{const t=e.target.value;Q(t),P(""),w("")},label:r("cluster.permission.grantType","授权类型"),children:[s.jsx(l,{value:"user",children:r("cluster.permission.user","用户")}),s.jsx(l,{value:"role",children:r("cluster.permission.role","角色")})]})]}),p==="user"?s.jsx(oe,{options:h,getOptionLabel:e=>`${e.fullName} (${e.username})`,value:h.find(e=>e.id===N)||null,onChange:(e,t)=>P(t?.id||""),renderInput:e=>s.jsx(M,{...e,label:r("cluster.permission.selectUser","选择用户"),required:!0})}):s.jsx(oe,{options:x,getOptionLabel:e=>e.name,value:x.find(e=>e.id===k)||null,onChange:(e,t)=>w(t?.id||""),renderInput:e=>s.jsx(M,{...e,label:r("cluster.permission.selectRole","选择角色"),required:!0})}),s.jsxs(y,{fullWidth:!0,required:!0,children:[s.jsx(v,{children:r("cluster.permission.namespace","命名空间")}),s.jsx(b,{value:A,onChange:e=>V(e.target.value),label:r("cluster.permission.namespace","命名空间"),children:pe.map(e=>s.jsx(l,{value:e,children:e},e))})]}),s.jsxs(y,{fullWidth:!0,required:!0,children:[s.jsx(v,{children:r("cluster.permission.resourceTypeLabel","资源类型")}),s.jsxs(b,{value:u,onChange:e=>{X(e.target.value),D("")},label:r("cluster.permission.resourceTypeLabel","资源类型"),children:[s.jsx(l,{value:"namespace",children:r("cluster.permission.resourceType.namespaced","NameSpace")}),s.jsx(l,{value:"deployment",children:r("cluster.permission.resourceType.deployment","Deployment")}),s.jsx(l,{value:"statefulset",children:r("cluster.permission.resourceType.statefulset","StatefulSet")}),s.jsx(l,{value:"service",children:r("cluster.permission.resourceType.service","Service")}),s.jsx(l,{value:"pod",children:r("cluster.permission.resourceType.pod","Pod")}),s.jsx(l,{value:"ingress",children:r("cluster.permission.resourceType.ingress","Ingress")})]}),u==="namespace"&&s.jsx(Me,{children:r("cluster.permission.resourceType.namespaceHint","Grants permissions for all resource types in this namespace (Deployment, Pod, Service, Ingress, etc.)")})]}),u!=="namespace"&&s.jsx(M,{label:r("cluster.permission.resourceName","资源名称"),value:Y,onChange:e=>D(e.target.value),fullWidth:!0,placeholder:r("cluster.permission.resourceNamePlaceholder","留空表示该类型的所有资源")}),s.jsxs(y,{fullWidth:!0,children:[s.jsx(v,{children:r("cluster.permission.actionLabel","操作权限")}),s.jsxs(b,{value:Z,onChange:e=>ee(e.target.value),label:r("cluster.permission.actionLabel","操作权限"),children:[s.jsxs(l,{value:"read",children:[r("cluster.permission.action.read","只读"),u==="pod"&&" (可查看日志)"]}),s.jsxs(l,{value:"write",children:[r("cluster.permission.action.write","读写"),u==="pod"&&" (可查看日志、进入终端)"]}),s.jsxs(l,{value:"delete",children:[r("cluster.permission.action.delete","删除"),u==="pod"&&" (可删除Pod)"]}),s.jsxs(l,{value:"admin",children:[r("cluster.permission.action.admin","管理员"),u==="pod"&&" (所有操作)"]})]})]})]})]}),s.jsxs(Ue,{children:[s.jsx(T,{onClick:L,children:r("common.cancel","取消")}),s.jsx(T,{onClick:fe,variant:"contained",disabled:J,children:J?s.jsx(ne,{size:20}):r("common.confirm","确认")})]})]}),s.jsx(qe,{open:g.open,autoHideDuration:3e3,onClose:()=>c({...g,open:!1}),anchorOrigin:{vertical:"top",horizontal:"center"},children:s.jsx(z,{severity:g.severity,onClose:()=>c({...g,open:!1}),children:g.message})})]})}export{Ze as default};
