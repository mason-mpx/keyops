import{u as ae,ax as ie,b2 as ce,r as c,j as e,B as a,dv as le,T as d,m as I,C as K,F as N,n as E,o as z,M as u,a as L,A as de,b as H,dh as U,d1 as pe,a5 as me,bq as ue,bf as f,a7 as G,I as xe,h as fe,b9 as ge}from"./index-STo1oTDL.js";import{a as he,b as J,D as ke,c as be,S as ve,v as je,d as ye,s as we,K as _e,P as Se,u as Te,C as Ie}from"./sortable.esm-laec1nmf.js";import{t as V}from"./ticketApi-yt1BEbWs.js";import{t as Q}from"./ticketDraftApi-3XTbLXu7.js";import{A as Ce}from"./Autocomplete-B1ZKY7co.js";import{A as Ae,a as De,b as We}from"./AccordionSummary-BVu9efIL.js";import"./Chip-v5QMYL72.js";function Pe({step:r,index:C,onDelete:h}){const{attributes:j,listeners:k,setNodeRef:p,transform:_,transition:S,isDragging:i}=Te({id:r.id}),b={transform:Ie.Transform.toString(_),transition:S,opacity:i?.5:1};return e.jsxs(Ae,{ref:p,style:b,sx:{mb:1.5,border:i?"2px dashed":"1px solid",borderColor:i?"primary.main":"divider",borderRadius:2,boxShadow:i?3:1,transition:"all 0.2s","&:before":{display:"none"},"& .MuiAccordionSummary-root":{backgroundColor:i?"rgba(25, 118, 210, 0.04)":"#edf2fc",minHeight:56,transition:"background-color 0.2s","&:hover":{backgroundColor:i?"rgba(25, 118, 210, 0.06)":"#e1e8f0"}}},children:[e.jsxs(De,{expandIcon:e.jsx(ge,{}),sx:{pl:1.5,"& .MuiAccordionSummary-content":{alignItems:"center",gap:1}},children:[e.jsx(a,{...j,...k,sx:{cursor:i?"grabbing":"grab",display:"flex",alignItems:"center",mr:1.5,p:1,borderRadius:1,bgcolor:i?"rgba(25, 118, 210, 0.08)":"transparent",transition:"background-color 0.2s","&:hover":{bgcolor:"rgba(25, 118, 210, 0.04)"},"&:active":{cursor:"grabbing",bgcolor:"rgba(25, 118, 210, 0.12)"}},onClick:x=>{x.stopPropagation()},title:"拖拽调整顺序",children:e.jsx(U,{sx:{fontSize:24,color:i?"primary.main":"action.active",opacity:i?1:.7,transition:"all 0.2s"}})}),e.jsxs(d,{variant:"subtitle1",sx:{flex:1,fontWeight:500,cursor:i?"grabbing":"grab",opacity:i?.6:1,userSelect:"none",transition:"opacity 0.2s"},...j,...k,onClick:x=>{x.stopPropagation()},children:[C+1,". ",r.step_name]}),e.jsx(xe,{size:"small",color:"error",onClick:x=>{x.stopPropagation(),h()},sx:{mr:1},children:e.jsx(fe,{fontSize:"small"})})]}),e.jsx(We,{children:e.jsxs(a,{sx:{p:2},children:[e.jsxs(a,{sx:{mb:1.5},children:[e.jsx(d,{variant:"body2",color:"text.secondary",component:"span",sx:{fontWeight:600},children:"步骤类型:"}),e.jsx(d,{variant:"body2",color:"text.primary",component:"span",sx:{ml:1},children:r.step_type})]}),r.step_comment&&e.jsxs(a,{sx:{mb:1.5},children:[e.jsx(d,{variant:"body2",color:"text.secondary",component:"span",sx:{fontWeight:600},children:"备注:"}),e.jsx(d,{variant:"body2",color:"text.primary",component:"span",sx:{ml:1},children:r.step_comment})]}),Object.keys(r.func_kwargs_json||{}).length>0&&e.jsxs(a,{children:[e.jsx(d,{variant:"body2",color:"text.secondary",component:"span",sx:{fontWeight:600},children:"配置:"}),e.jsx(a,{component:"pre",sx:{mt:1,p:1.5,bgcolor:"#f5f5f5",borderRadius:1,fontSize:"0.875rem",overflow:"auto",maxHeight:200},children:JSON.stringify(r.func_kwargs_json,null,2)})]})]})})]})}const q=r=>[{id:"dev",name:r("workorder.createTicket.environments.dev"),code:"dev"},{id:"test",name:r("workorder.createTicket.environments.test"),code:"test"},{id:"qa",name:r("workorder.createTicket.environments.qa"),code:"qa"},{id:"staging",name:r("workorder.createTicket.environments.staging"),code:"staging"},{id:"prod",name:r("workorder.createTicket.environments.prod"),code:"prod"}];function Me(){const{t:r}=ae(),C=ie(),h=ce(),[j,k]=c.useState(!1),[p,_]=c.useState(""),[S,i]=c.useState(""),[b,x]=c.useState("normal"),[l,T]=c.useState([]),[A,R]=c.useState(""),[n,v]=c.useState({}),[X,Y]=c.useState([]),[M,O]=c.useState(!1),[D,y]=c.useState(""),[$,Z]=c.useState(null),[m,W]=c.useState(null),ee=he(J(Se),J(_e,{coordinateGetter:we})),B=async(t="")=>{O(!0);try{const o={};t.trim()&&(o.name=t.trim());const s=await ue.getApplications(o);let w=(Array.isArray(s)?s:[]).slice(0,10);m&&!w.find(P=>P.id===m.id)&&(w=[m,...w].slice(0,10)),Y(w)}catch(o){const s=o;console.error("加载服务列表失败:",o),f(s?.response?.data?.message||r("workorder.createTicket.loadServicesFailed"))}finally{O(!1)}};c.useEffect(()=>{B("")},[]),c.useEffect(()=>{$&&clearTimeout($);const t=setTimeout(()=>{B(D)},300);return Z(t),()=>{t&&clearTimeout(t)}},[D,m]),c.useEffect(()=>{if(h.state?.draftData){const t=h.state.draftData;_(t.title||""),i(t.form_data?.comment||""),x(t.priority||"normal"),t.form_data?.steps&&T(t.form_data.steps.map((o,s)=>({...o,id:o.id||`step-${s}`})))}},[h.state]);const te=t=>{const{active:o,over:s}=t;s&&o.id!==s.id&&T(g=>{const w=g.findIndex(F=>F.id===o.id),P=g.findIndex(F=>F.id===s.id);return ye(g,w,P)})},re=()=>{if(!A){f(r("workorder.createTicket.selectStepType"));return}let t=`${r("workorder.createTicket.stepList")} ${l.length+1}`;n.serviceName&&(t=`${n.serviceName}`,n.envName&&(t+=` - ${n.envName}`));const o=q(r),s={id:`step-${Date.now()}`,step_type:A,step_name:t,step_comment:(typeof n.comment=="string"?n.comment:"")||"",func_kwargs_json:{...typeof n.func_kwargs_json=="object"&&n.func_kwargs_json!==null?n.func_kwargs_json:{},application_id:n.serviceId||"",application_name:n.serviceName||"",env_id:n.envId||"",env_name:n.envName||"",env_code:o.find(g=>g.id===n.envId)?.code||"",version:n.version||""}};T([...l,s]),R(""),v({}),W(null),y("")},ne=t=>{T(l.filter((o,s)=>s!==t))},se=async()=>{if(!p.trim()){f(r("workorder.createTicket.enterTitle"));return}if(l.length===0){f(r("workorder.createTicket.addAtLeastOneStep"));return}try{k(!0);const t={comment:S,steps:l},o=h.state?.draftData?.id;let s;o?s=await V.update(o,{title:p,form_data:t,status:"submitted",priority:b}):s=await V.create({type:"deployment",title:p,form_data:t,status:"submitted",priority:b}),s.data.code===0?(G(r("workorder.createTicket.publishSuccess")),C("/my-tickets")):f(r("workorder.createTicket.publishFailed"))}catch(t){f(t?.response?.data?.message||r("workorder.createTicket.publishFailed"))}finally{k(!1)}},oe=async()=>{if(!p.trim()){f(r("workorder.createTicket.enterTitle"));return}try{k(!0);const t={comment:S,steps:l},o=h.state?.draftData?.id;(o?await Q.update(o,{title:p,form_data:t,priority:b}):await Q.save({type:"deployment",title:p,form_data:t,status:"draft",priority:b})).data.code===0?(G(r("workorder.createTicket.saveDraftSuccess")),o?C("/draft-box"):(_(""),i(""),x("normal"),T([]))):f(r("workorder.createTicket.saveDraftFailed"))}catch(t){f(t?.response?.data?.message||r("workorder.createTicket.saveDraftFailed"))}finally{k(!1)}};return e.jsxs(a,{sx:{backgroundColor:"#fff",minHeight:"100vh",p:0},children:[e.jsxs(a,{sx:{display:"flex",gap:2,p:2,flexWrap:{xs:"wrap",md:"nowrap"},maxWidth:"100%"},children:[e.jsx(a,{sx:{flex:{xs:"1 1 100%",md:"1 1 50%"},minWidth:0},children:e.jsxs(a,{sx:{p:3,borderRadius:2,border:"1px solid #e5e7eb",height:"100%",bgcolor:"#fff"},children:[e.jsx(a,{component:"ul",sx:{listStyle:"none",p:0,m:0,mb:2},children:e.jsxs(a,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(a,{sx:{width:40,height:40,borderRadius:1.5,background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",display:"flex",alignItems:"center",justifyContent:"center",mr:1.5,boxShadow:"0 4px 12px rgba(102, 126, 234, 0.3)"},children:e.jsx(le,{sx:{fontSize:22,color:"#fff"}})}),e.jsxs(d,{component:"li",variant:"subtitle1",fontWeight:600,children:[r("workorder.createTicket.customSteps"),":"]})]})}),e.jsx(Ce,{fullWidth:!0,options:X,getOptionLabel:t=>t.name||"",isOptionEqualToValue:(t,o)=>t.id===o.id,value:m,onChange:(t,o)=>{const s=o;W(s),v({...n,serviceId:s?.id||"",serviceName:s?.name||"",func_kwargs_json:{...typeof n.func_kwargs_json=="object"&&n.func_kwargs_json!==null?n.func_kwargs_json:{},application_id:s?.id||"",application_name:s?.name||""}}),y(s?.name||"")},inputValue:D,onInputChange:(t,o,s)=>{s==="input"?(m&&o!==m.name&&(W(null),v({...n,serviceId:"",serviceName:"",func_kwargs_json:{...typeof n.func_kwargs_json=="object"&&n.func_kwargs_json!==null?n.func_kwargs_json:{},application_id:"",application_name:""}})),y(o)):s==="clear"?(W(null),y(""),v({...n,serviceId:"",serviceName:"",func_kwargs_json:{...typeof n.func_kwargs_json=="object"&&n.func_kwargs_json!==null?n.func_kwargs_json:{},application_id:"",application_name:""}})):s==="reset"&&y(m&&m.name||"")},loading:M,noOptionsText:D&&!m?r("workorder.createTicket.noServicesFound","未找到匹配的服务"):r("workorder.createTicket.enterServiceSearch","请输入关键字搜索服务"),filterOptions:t=>t,renderInput:t=>e.jsx(I,{...t,label:r("workorder.createTicket.service"),placeholder:r("workorder.createTicket.searchServicePlaceholder","搜索服务..."),InputProps:{...t.InputProps,endAdornment:e.jsxs(e.Fragment,{children:[M?e.jsx(K,{color:"inherit",size:20}):null,t.InputProps.endAdornment]})}}),sx:{mb:2}}),e.jsxs(N,{fullWidth:!0,sx:{mb:2},children:[e.jsx(E,{children:r("workorder.createTicket.environment")}),e.jsxs(z,{value:n.envId||"",onChange:t=>{const s=q(r).find(g=>g.id===t.target.value);v({...n,envId:t.target.value,envName:s?.name||"",func_kwargs_json:{...typeof n.func_kwargs_json=="object"&&n.func_kwargs_json!==null?n.func_kwargs_json:{},env_id:s?.id||"",env_name:s?.name||"",env_code:s?.code||""}})},label:r("workorder.createTicket.environment"),children:[e.jsx(u,{value:"",children:e.jsx("em",{children:r("workorder.createTicket.selectEnvironment")})}),q(r).map(t=>e.jsx(u,{value:t.id,children:t.name},t.id))]})]}),e.jsx(I,{fullWidth:!0,label:"版本",value:n.version||"",onChange:t=>{v({...n,version:t.target.value,func_kwargs_json:{...typeof n.func_kwargs_json=="object"&&n.func_kwargs_json!==null?n.func_kwargs_json:{},version:t.target.value}})},sx:{mb:2},placeholder:"请输入版本号，如：v1.0.0"}),e.jsxs(N,{fullWidth:!0,sx:{mb:2},children:[e.jsx(E,{children:r("workorder.createTicket.stepType")}),e.jsxs(z,{value:A,onChange:t=>R(t.target.value),label:r("workorder.createTicket.stepType"),children:[e.jsx(u,{value:"deploy_k8s",children:r("workorder.createTicket.stepTypes.deploy_k8s")}),e.jsx(u,{value:"project",children:r("workorder.createTicket.stepTypes.project")}),e.jsx(u,{value:"sql",children:r("workorder.createTicket.stepTypes.sql")}),e.jsx(u,{value:"other",children:r("workorder.createTicket.stepTypes.other")})]})]}),e.jsx(I,{fullWidth:!0,label:r("workorder.createTicket.stepComment"),multiline:!0,rows:3,value:n.comment||"",onChange:t=>v({...n,comment:t.target.value}),sx:{mb:2},placeholder:r("workorder.createTicket.stepCommentPlaceholder")}),e.jsx(L,{fullWidth:!0,variant:"contained",size:"large",startIcon:e.jsx(de,{}),onClick:re,disabled:!A,sx:{mt:2,background:"linear-gradient(135deg, #667eea 0%, #764ba2 100%)",boxShadow:"0 4px 12px rgba(102, 126, 234, 0.4)","&:hover":{background:"linear-gradient(135deg, #5568d3 0%, #6a3d91 100%)",boxShadow:"0 6px 16px rgba(102, 126, 234, 0.5)"},"&:disabled":{background:"#cbd5e0"}},children:r("workorder.createTicket.addStep")})]})}),e.jsx(a,{sx:{flex:{xs:"1 1 100%",md:"1 1 50%"},minWidth:0,display:"flex",flexDirection:"column",gap:2},children:e.jsxs(a,{sx:{p:3,borderRadius:2,border:"1px solid #e5e7eb",height:"100%",bgcolor:"#fff"},children:[e.jsx(a,{component:"ul",sx:{listStyle:"none",p:0,m:0,mb:2},children:e.jsxs(d,{component:"li",variant:"subtitle1",fontWeight:600,sx:{mb:2,position:"relative"},children:[e.jsx(a,{component:"span",sx:{position:"absolute",left:-16,color:"#f56c6c"},children:"*"}),r("workorder.createTicket.ticketTitle"),":"]})}),e.jsx(I,{fullWidth:!0,placeholder:r("workorder.createTicket.ticketTitlePlaceholder"),value:p,onChange:t=>_(t.target.value),required:!0,sx:{mb:3},size:"medium"}),e.jsx(a,{component:"ul",sx:{listStyle:"none",p:0,m:0,mb:2},children:e.jsxs(d,{component:"li",variant:"subtitle1",fontWeight:600,sx:{mb:2},children:[r("workorder.createTicket.ticketDescription"),":"]})}),e.jsx(I,{fullWidth:!0,placeholder:r("workorder.createTicket.ticketDescriptionPlaceholder"),multiline:!0,rows:4,value:S,onChange:t=>i(t.target.value),sx:{mb:3}}),e.jsx(a,{component:"ul",sx:{listStyle:"none",p:0,m:0,mb:2},children:e.jsx(d,{component:"li",variant:"subtitle1",fontWeight:600,sx:{mb:2},children:"优先级:"})}),e.jsxs(N,{fullWidth:!0,sx:{mb:3},children:[e.jsx(E,{children:"优先级"}),e.jsxs(z,{value:b,label:"优先级",onChange:t=>x(t.target.value),children:[e.jsx(u,{value:"low",children:"低"}),e.jsx(u,{value:"normal",children:"普通"}),e.jsx(u,{value:"high",children:"高"}),e.jsx(u,{value:"urgent",children:"紧急"})]})]}),e.jsx(a,{component:"ul",sx:{listStyle:"none",p:0,m:0,mb:2,mt:3},children:e.jsxs(d,{component:"li",variant:"subtitle1",fontWeight:600,sx:{mb:2},children:[r("workorder.createTicket.stepList")," (",l.length,")"]})}),l.length===0?e.jsx(H,{severity:"info",sx:{mt:2},children:r("workorder.createTicket.noSteps")}):e.jsx(H,{severity:"info",icon:e.jsx(U,{}),sx:{mt:2,mb:2,"& .MuiAlert-message":{display:"flex",alignItems:"center",gap:1}},children:e.jsx(d,{variant:"body2",component:"span",children:"提示：点击并拖动左侧图标或步骤名称可以调整步骤顺序"})}),l.length>0&&e.jsx(ke,{sensors:ee,collisionDetection:be,onDragEnd:te,children:e.jsx(ve,{items:l.map(t=>t.id),strategy:je,children:l.map((t,o)=>e.jsx(Pe,{step:t,index:o,onDelete:()=>ne(o)},t.id))})}),e.jsxs(a,{sx:{mt:3,display:"flex",gap:2},children:[e.jsx(L,{variant:"contained",color:"primary",size:"large",startIcon:e.jsx(pe,{}),onClick:se,disabled:j||!p.trim()||l.length===0,children:r("workorder.createTicket.publishTicket")}),e.jsx(L,{variant:"outlined",size:"large",startIcon:e.jsx(me,{}),onClick:oe,disabled:j||!p.trim(),children:r("workorder.createTicket.saveDraft")})]})]})})]}),j&&e.jsx(a,{sx:{position:"fixed",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"rgba(0,0,0,0.5)",zIndex:9999},children:e.jsx(K,{})})]})}export{Me as default};
