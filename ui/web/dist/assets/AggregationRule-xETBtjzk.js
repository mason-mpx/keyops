import{u as ne,r,j as e,B as d,b as F,T as a,bb as H,I as u,cy as ie,b9 as te,ci as ae,w as M,x as $,a as p,v as le,A as J,P as V,d as I,g as oe,h as re,i as de,k as ce,l as me,m as x,cz as he,_ as k,y as z,cA as xe,F as ge,n as je,o as ue,M as q,p as pe,a7 as f}from"./index-wVs8DYHr.js";import{a as b}from"./alertApi-Ch3_g7QM.js";import{S as m}from"./Stack-CNnEoVHt.js";import{T as fe,a as be,b as ye,c as y,d as o,e as ve}from"./TableRow-17IyVPm2.js";import{C as h}from"./Chip-DzNpApxT.js";import{P as _e}from"./Pagination-BBTYTx7r.js";import"./LastPage-Bx6x4Acm.js";function ke(){const{t:n}=ne(),[E,R]=r.useState([]),[W,L]=r.useState(!1),[U,P]=r.useState(!1),[v,_]=r.useState(null),[C,G]=r.useState(1),[T]=r.useState(10),[B,K]=r.useState(0),[A,Q]=r.useState(!1),[N,X]=r.useState(!1),[i,l]=r.useState({aggregation_name:"",aggregation_desc:"",level_dimension:!1,tags_dimension:[],title_dimension:!1,windows:300,storm:10,status:"enabled"}),g=r.useCallback(async()=>{try{L(!0);const s={page:C,page_size:T},t=await b.getAggregations(s);(t.data.code===0||t.data.code===200)&&(R(t.data.data||[]),K(t.data.total||0))}catch(s){console.error("获取告警聚合失败:",s),R([])}finally{L(!1)}},[C,T]);r.useEffect(()=>{g()},[g]);const O=s=>{if(s){_(s);let t=[];if(s.tags_dimension)if(typeof s.tags_dimension=="string")try{t=JSON.parse(s.tags_dimension)}catch{t=[]}else Array.isArray(s.tags_dimension)&&(t=s.tags_dimension);l({aggregation_name:s.aggregation_name,aggregation_desc:s.aggregation_desc,level_dimension:s.level_dimension,tags_dimension:t,title_dimension:s.title_dimension,windows:s.windows,storm:s.storm,status:s.status})}else _(null),l({aggregation_name:"",aggregation_desc:"",level_dimension:!1,tags_dimension:[],title_dimension:!1,windows:300,storm:10,status:"enabled"});P(!0)},w=()=>{P(!1),_(null)},Y=async()=>{if(!i.aggregation_name){f(n("Please fill in aggregation name")||"请填写聚合名称");return}try{v?(await b.updateAggregation(v.id,i),f(n("Update successful")||"更新成功")):(await b.createAggregation(i),f(n("Create successful")||"创建成功")),w(),g()}catch(s){console.error("保存失败:",s)}},Z=async s=>{if(confirm(n("Are you sure you want to delete this aggregation?")||"确定要删除这个告警聚合吗？"))try{await b.deleteAggregation(s),f(n("Delete successful")||"删除成功"),g()}catch(t){console.error("删除失败:",t)}},ee=s=>{switch(s){case"enabled":return"success";case"disabled":return"default";case"deleted":return"error";default:return"default"}},se=s=>{switch(s){case"enabled":return n("common.enabled");case"disabled":return n("common.disabled");case"deleted":return n("common.deleted")||"已删除";default:return s}};return e.jsxs(d,{sx:{p:3},children:[e.jsxs(F,{severity:"info",icon:e.jsx(ae,{}),sx:{mb:2},action:e.jsx(u,{size:"small",onClick:()=>Q(!A),children:A?e.jsx(ie,{}):e.jsx(te,{})}),children:[e.jsxs(a,{variant:"body2",component:"span",children:[e.jsx("strong",{children:"重要提示："}),"告警聚合功能需要 Redis 支持才能正常工作"]}),e.jsx(H,{in:A,timeout:"auto",unmountOnExit:!0,children:e.jsxs(d,{sx:{mt:2},children:[e.jsx(a,{variant:"body2",paragraph:!0,children:e.jsx("strong",{children:"为什么需要 Redis？"})}),e.jsx(a,{variant:"body2",component:"div",sx:{pl:2},children:e.jsxs("ul",{style:{margin:0,paddingLeft:20},children:[e.jsx("li",{children:"聚合窗口需要临时存储，Redis 提供高性能的键值存储"}),e.jsx("li",{children:"聚合计数需要原子性操作，Redis 的 INCR 命令保证并发安全"}),e.jsx("li",{children:"窗口过期需要自动清理，Redis 的 TTL 机制自动处理"})]})}),e.jsx(a,{variant:"body2",paragraph:!0,sx:{mt:1},children:e.jsx("strong",{children:"如何启用 Redis？"})}),e.jsxs(a,{variant:"body2",component:"div",sx:{pl:2,fontFamily:"monospace",bgcolor:"grey.100",p:1,borderRadius:1},children:[e.jsx("div",{children:"1. 安装并启动 Redis 服务"}),e.jsxs("div",{children:["2. 在配置文件 ",e.jsx("code",{children:"config.yaml"})," 中设置："]}),e.jsxs("div",{style:{marginLeft:20},children:[e.jsx("div",{children:"redis:"}),e.jsxs("div",{style:{marginLeft:20},children:[e.jsx("div",{children:"enabled: true"}),e.jsx("div",{children:"host: localhost"}),e.jsx("div",{children:"port: 6379"})]})]}),e.jsx("div",{children:"3. 重启后端服务"})]}),e.jsx(a,{variant:"body2",color:"warning.main",sx:{mt:1,fontWeight:"bold"},children:"⚠️ 如果没有启用 Redis，告警聚合功能将无法正常工作，所有告警将直接发送通知（不进行聚合）"})]})})]}),e.jsx(M,{children:e.jsxs($,{children:[e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(a,{variant:"h5",gutterBottom:!0,children:n("menu.monitorAggregationRule")||"告警聚合管理"}),e.jsxs(m,{direction:"row",spacing:2,children:[e.jsx(p,{variant:"outlined",startIcon:e.jsx(le,{}),onClick:g,disabled:W,children:n("common.refresh")}),e.jsx(p,{variant:"contained",startIcon:e.jsx(J,{}),onClick:()=>O(),children:n("Create Aggregation")})]})]}),e.jsx(fe,{component:V,children:e.jsxs(be,{children:[e.jsx(ye,{children:e.jsxs(y,{children:[e.jsx(o,{children:n("Aggregation Name")}),e.jsx(o,{children:n("Dimensions")}),e.jsx(o,{children:n("Windows")}),e.jsx(o,{children:n("Storm Threshold")}),e.jsx(o,{children:n("common.status")}),e.jsx(o,{align:"right",children:n("common.actions")})]})}),e.jsx(ve,{children:W?e.jsx(y,{children:e.jsx(o,{colSpan:6,align:"center",children:n("common.loading")})}):E.length===0?e.jsx(y,{children:e.jsx(o,{colSpan:6,align:"center",children:n("common.noData")})}):E.map(s=>e.jsxs(y,{children:[e.jsx(o,{children:s.aggregation_name}),e.jsx(o,{children:e.jsxs(m,{direction:"row",spacing:1,children:[s.level_dimension&&e.jsx(h,{label:n("Level"),size:"small"}),(()=>{let t=!1;if(s.tags_dimension)if(typeof s.tags_dimension=="string")try{const c=JSON.parse(s.tags_dimension);t=Array.isArray(c)&&c.length>0}catch{t=!1}else Array.isArray(s.tags_dimension)&&(t=s.tags_dimension.length>0);return t&&e.jsx(h,{label:n("Tags"),size:"small"})})(),s.title_dimension&&e.jsx(h,{label:n("Title"),size:"small"}),!s.level_dimension&&!(s.tags_dimension&&(typeof s.tags_dimension=="string"&&s.tags_dimension!=="[]"&&s.tags_dimension!==""||Array.isArray(s.tags_dimension)&&s.tags_dimension.length>0))&&!s.title_dimension&&e.jsx(a,{variant:"body2",color:"text.secondary",children:"-"})]})}),e.jsxs(o,{children:[s.windows,"s"]}),e.jsx(o,{children:s.storm}),e.jsx(o,{children:e.jsx(h,{label:se(s.status),color:ee(s.status),size:"small"})}),e.jsx(o,{align:"right",children:e.jsxs(m,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(I,{title:n("common.edit"),children:e.jsx(u,{size:"small",onClick:()=>O(s),children:e.jsx(oe,{fontSize:"small"})})}),e.jsx(I,{title:n("common.delete"),children:e.jsx(u,{size:"small",color:"error",onClick:()=>Z(s.id),children:e.jsx(re,{fontSize:"small"})})})]})})]},s.id))})]})}),B>0&&e.jsx(d,{sx:{display:"flex",justifyContent:"center",mt:2},children:e.jsx(_e,{count:Math.ceil(B/T),page:C,onChange:(s,t)=>G(t),color:"primary"})})]})}),e.jsxs(de,{open:U,onClose:w,maxWidth:"md",fullWidth:!0,children:[e.jsx(ce,{children:v?n("Edit Aggregation")||"编辑告警聚合":n("Create Aggregation")||"新建告警聚合"}),e.jsx(me,{children:e.jsxs(m,{spacing:3,sx:{mt:1},children:[e.jsx(x,{label:`${n("Aggregation Name")} *`,value:i.aggregation_name,onChange:s=>l({...i,aggregation_name:s.target.value}),fullWidth:!0,required:!0}),e.jsx(x,{label:n("Description"),value:i.aggregation_desc||"",onChange:s=>l({...i,aggregation_desc:s.target.value}),fullWidth:!0,multiline:!0,rows:2}),e.jsxs(d,{children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,mb:1},children:[e.jsx(a,{variant:"subtitle2",children:n("Dimensions")||"匹配维度"}),e.jsx(I,{title:n("Dimensions Help")||"维度说明",children:e.jsx(u,{size:"small",onClick:()=>X(!N),sx:{color:"primary.main"},children:e.jsx(he,{fontSize:"small"})})})]}),e.jsx(H,{in:N,timeout:"auto",unmountOnExit:!0,children:e.jsx(M,{sx:{mb:2,bgcolor:"grey.50"},children:e.jsxs($,{children:[e.jsx(a,{variant:"subtitle2",gutterBottom:!0,sx:{fontWeight:"bold",mb:1},children:n("Dimensions Explanation")||"匹配维度说明"}),e.jsx(a,{variant:"body2",paragraph:!0,children:n("Dimensions Description")||"匹配维度用于定义哪些告警应该被聚合在一起。可以同时选择多个维度，只有同时满足所有选中维度的告警才会被聚合。"}),e.jsxs(m,{spacing:1,children:[e.jsxs(d,{children:[e.jsx(h,{label:n("Level")||"等级",size:"small",sx:{mr:1,fontWeight:"bold"}}),e.jsx(a,{variant:"body2",component:"span",children:n("Level Dimension Description")||"按告警等级匹配。如果选中，只有相同等级的告警才会被聚合。"})]}),e.jsxs(d,{children:[e.jsx(h,{label:n("Tags")||"标签",size:"small",sx:{mr:1,fontWeight:"bold"}}),e.jsx(a,{variant:"body2",component:"span",children:n("Tags Dimension Description")||"按告警标签匹配。如果选中，需要配置具体的标签规则（标签名和标签值），只有标签匹配的告警才会被聚合。"})]}),e.jsxs(d,{children:[e.jsx(h,{label:n("Title")||"标题",size:"small",sx:{mr:1,fontWeight:"bold"}}),e.jsx(a,{variant:"body2",component:"span",children:n("Title Dimension Description")||"按告警标题匹配。如果选中，只有相同标题的告警才会被聚合。"})]})]}),e.jsx(F,{severity:"info",sx:{mt:2},children:e.jsxs(a,{variant:"body2",children:[e.jsx("strong",{children:n("Example")||"示例："}),n("Dimensions Example")||'如果同时选中"等级"和"标题"，则只有等级相同且标题相同的告警才会被聚合。如果只选中"标签"，则需要配置标签规则，只有标签匹配的告警才会被聚合。']})})]})})}),e.jsxs(m,{spacing:2,children:[e.jsxs(m,{direction:"row",spacing:2,children:[e.jsx(k,{control:e.jsx(z,{checked:i.level_dimension??!1,onChange:s=>l({...i,level_dimension:s.target.checked})}),label:n("Level")||"等级"}),e.jsx(k,{control:e.jsx(z,{checked:Array.isArray(i.tags_dimension)&&i.tags_dimension.length>0||!1,onChange:s=>{s.target.checked&&(!Array.isArray(i.tags_dimension)||i.tags_dimension.length===0)?l({...i,tags_dimension:[{tag:"",values:[]}]}):s.target.checked||l({...i,tags_dimension:[]})}}),label:n("Tags")||"标签"}),e.jsx(k,{control:e.jsx(z,{checked:i.title_dimension??!1,onChange:s=>l({...i,title_dimension:s.target.checked})}),label:n("Title")||"标题"})]}),Array.isArray(i.tags_dimension)&&i.tags_dimension.length>0&&e.jsxs(d,{sx:{pl:2,borderLeft:2,borderColor:"primary.main",mt:2},children:[e.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[e.jsx(a,{variant:"body2",color:"text.secondary",children:n("Tag Rules")||"标签规则"}),e.jsx(p,{size:"small",startIcon:e.jsx(J,{}),onClick:()=>{const s=[...i.tags_dimension,{tag:"",values:[]}];l({...i,tags_dimension:s})},children:n("Add Tag Rule")||"添加标签规则"})]}),e.jsx(m,{spacing:2,children:i.tags_dimension.map((s,t)=>e.jsx(V,{sx:{p:2,bgcolor:"grey.50"},children:e.jsxs(m,{spacing:2,children:[e.jsxs(d,{sx:{display:"flex",gap:2,alignItems:"center"},children:[e.jsx(x,{label:n("Tag Name")||"标签名",size:"small",value:s.tag||"",onChange:c=>{const j=[...i.tags_dimension];j[t]={...j[t],tag:c.target.value},l({...i,tags_dimension:j})},placeholder:n("Tag Name Placeholder")||"例如: environment",sx:{flex:1}}),e.jsx(u,{color:"error",size:"small",onClick:()=>{const c=[...i.tags_dimension];c.splice(t,1),l({...i,tags_dimension:c})},children:e.jsx(xe,{})})]}),e.jsx(x,{label:n("Tag Values (comma separated)")||"标签值（逗号分隔）",size:"small",value:Array.isArray(s.values)?s.values.join(", "):"",onChange:c=>{const j=c.target.value.split(",").map(S=>S.trim()).filter(S=>S),D=[...i.tags_dimension];D[t]={...D[t],values:j},l({...i,tags_dimension:D})},placeholder:n("Tag Values Placeholder")||"例如: production, staging",fullWidth:!0,helperText:n("Tag values to match, separated by commas")||"要匹配的标签值，用逗号分隔"})]})},t))})]})]})]}),e.jsx(x,{label:`${n("Windows")} (${n("seconds")})`,type:"number",value:i.windows,onChange:s=>l({...i,windows:parseInt(s.target.value)||0}),fullWidth:!0,helperText:n("Aggregation window in seconds")||"聚合窗口时间（秒）"}),e.jsx(x,{label:n("Storm Threshold"),type:"number",value:i.storm,onChange:s=>l({...i,storm:parseInt(s.target.value)||0}),fullWidth:!0,helperText:n("Alert storm threshold")||"告警风暴预警阈值"}),e.jsxs(ge,{fullWidth:!0,children:[e.jsx(je,{children:n("common.status")}),e.jsxs(ue,{value:i.status,label:n("common.status"),onChange:s=>l({...i,status:s.target.value}),children:[e.jsx(q,{value:"enabled",children:n("common.enabled")}),e.jsx(q,{value:"disabled",children:n("common.disabled")})]})]})]})}),e.jsxs(pe,{children:[e.jsx(p,{onClick:w,children:n("common.cancel")}),e.jsx(p,{onClick:Y,variant:"contained",children:n("common.save")})]})]})]})}export{ke as default};
