import{u as S,r as l,b3 as K,j as e,B as n,C as A,T as r,w as j,x as y,cM as I,a as h,c as T,m as E,d as O,I as G,ck as _,D as B,co as $,v as N,h as V,b as w,i as q,k as J,l as Q,p as X,b4 as C,cL as Y,ac as k,O as Z,aa as ee}from"./index-wVs8DYHr.js";import{T as te}from"./TwoFactorSettings-UU7EE1VK.js";import{S as f}from"./Stack-CNnEoVHt.js";import{C as U}from"./Chip-DzNpApxT.js";import"./Switch-DnfqMs2v.js";function re(){const{t}=S(),[m,o]=l.useState(!1),[a,g]=l.useState(!1),[c,d]=l.useState(null),[u,b]=l.useState(!1),[x,p]=l.useState({open:!1,type:"regenerate",title:"",message:""}),[i,F]=l.useState(null);l.useEffect(()=>{M()},[]);const M=async()=>{try{o(!0);const s=await K.getCurrentUser();F(s),s.sshKeyFingerprint&&d({fingerprint:s.sshKeyFingerprint,publicKey:s.sshPublicKey||"",generatedAt:s.sshKeyGeneratedAt||"",authMethod:s.authMethod||"password"})}catch(s){console.error("加载用户信息失败:",s)}finally{o(!1)}},D=async()=>{if(i?.id)try{g(!0);const s=await C.generateSSHKey(i.id);d({fingerprint:s.fingerprint,publicKey:s.publicKey,generatedAt:s.generatedAt,authMethod:i.authMethod||"password"}),p({open:!0,type:"regenerate",title:t("profile.confirmDownload"),message:t("profile.confirmDownload")})}catch(s){console.error("生成SSH密钥失败:",s),alert(t("profile.downloadFailed"))}finally{g(!1)}},P=async()=>{if(i?.id)try{const s=await C.downloadSSHPrivateKey(i.id),L=window.URL.createObjectURL(s),v=document.createElement("a");v.href=L,v.download=`zjump_${i.username}_private_key`,document.body.appendChild(v),v.click(),window.URL.revokeObjectURL(L),document.body.removeChild(v),p({open:!1,type:"regenerate",title:"",message:""}),alert(t("profile.downloadSuccess"))}catch(s){console.error("下载私钥失败:",s),alert(t("profile.downloadFailed"))}},R=()=>{p({open:!0,type:"regenerate",title:t("profile.confirmRegenerate"),message:t("profile.confirmRegenerate")})},H=()=>{p({open:!0,type:"delete",title:t("profile.confirmDelete"),message:t("profile.confirmDelete")})},z=async()=>{if(i?.id)try{x.type==="regenerate"?await D():x.type==="delete"&&(await C.deleteSSHKey(i.id),d(null),alert(t("profile.keyDeleted")))}catch(s){console.error("操作失败:",s),alert(t("profile.downloadFailed"))}finally{p({open:!1,type:"regenerate",title:"",message:""})}},W=async()=>{if(c?.publicKey)try{await navigator.clipboard.writeText(c.publicKey),b(!0),setTimeout(()=>b(!1),2e3)}catch(s){console.error("复制失败:",s)}};return m?e.jsx(n,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px",children:e.jsx(A,{})}):e.jsxs(n,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:t("profile.sshKeyManagement")}),c?e.jsxs(f,{spacing:3,children:[e.jsx(j,{children:e.jsxs(y,{children:[e.jsxs(n,{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2,children:[e.jsxs(n,{display:"flex",alignItems:"center",children:[e.jsx(T,{color:"success",sx:{mr:1}}),e.jsx(r,{variant:"h6",children:t("profile.configured")})]}),e.jsx(U,{label:t(`profile.${c.authMethod}Auth`),color:"primary",size:"small"})]}),e.jsxs(f,{spacing:2,children:[e.jsxs(n,{children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:t("profile.fingerprint")}),e.jsx(r,{variant:"body2",fontFamily:"monospace",children:c.fingerprint})]}),e.jsxs(n,{children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:t("profile.generatedTime")}),e.jsx(r,{variant:"body2",children:new Date(c.generatedAt).toLocaleString()})]}),e.jsxs(n,{children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:t("profile.publicKey")}),e.jsxs(n,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(E,{value:c.publicKey,multiline:!0,rows:3,variant:"outlined",size:"small",fullWidth:!0,InputProps:{readOnly:!0},sx:{fontFamily:"monospace",fontSize:"0.875rem"}}),e.jsx(O,{title:t(u?"profile.publicKeyCopied":"profile.copyPublicKey"),children:e.jsx(G,{onClick:W,color:"primary",children:u?e.jsx(T,{}):e.jsx(_,{})})})]})]})]}),e.jsx(B,{sx:{my:2}}),e.jsxs(f,{direction:"row",spacing:2,children:[e.jsx(h,{variant:"outlined",startIcon:e.jsx($,{}),onClick:P,children:t("profile.downloadPrivateKey")}),e.jsx(h,{variant:"outlined",startIcon:e.jsx(N,{}),onClick:R,children:t("profile.regenerate")}),e.jsx(h,{variant:"outlined",color:"error",startIcon:e.jsx(V,{}),onClick:H,children:t("profile.deleteKey")})]})]})}),e.jsx(j,{children:e.jsxs(y,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:t("profile.howToUse")}),e.jsxs(f,{spacing:1,children:[e.jsx(r,{variant:"body2",children:t("profile.step1")}),e.jsx(r,{variant:"body2",children:t("profile.step2")}),e.jsx(r,{variant:"body2",children:t("profile.step3")}),e.jsx(r,{variant:"body2",children:t("profile.step4")}),e.jsx(r,{variant:"body2",children:t("profile.step5")})]})]})}),e.jsxs(w,{severity:"info",children:[e.jsx(r,{variant:"subtitle2",gutterBottom:!0,children:t("profile.importantTips")}),e.jsxs(f,{spacing:.5,children:[e.jsx(r,{variant:"body2",children:t("profile.tip1")}),e.jsx(r,{variant:"body2",children:t("profile.tip2")}),e.jsx(r,{variant:"body2",children:t("profile.tip3")})]})]})]}):e.jsx(j,{children:e.jsx(y,{children:e.jsxs(n,{textAlign:"center",py:4,children:[e.jsx(I,{sx:{fontSize:64,color:"text.secondary",mb:2}}),e.jsx(r,{variant:"h6",gutterBottom:!0,children:t("profile.noKeyMessage")}),e.jsx(h,{variant:"contained",startIcon:e.jsx(I,{}),onClick:D,disabled:a,size:"large",children:t(a?"profile.generating":"profile.generateKey")})]})})}),e.jsxs(q,{open:x.open,onClose:()=>p({open:!1,type:"regenerate",title:"",message:""}),children:[e.jsx(J,{children:x.title}),e.jsx(Q,{children:e.jsx(r,{children:x.message})}),e.jsxs(X,{children:[e.jsx(h,{onClick:()=>p({open:!1,type:"regenerate",title:"",message:""}),children:t("common.cancel")}),e.jsx(h,{onClick:z,color:"primary",variant:"contained",children:t("common.confirm")})]})]})]})}function ne(){const{t}=S(),[m,o]=l.useState(!1),[a,g]=l.useState(null),[c,d]=l.useState(null),u=l.useCallback(async()=>{try{o(!0);const i=await K.getCurrentUser();g(i)}catch(i){console.error("加载用户信息失败:",i),d(t("profile.loadUserInfoFailed"))}finally{o(!1)}},[t]);l.useEffect(()=>{u()},[u]);const b=i=>{switch(i){case"active":return"success";case"inactive":return"error";default:return"default"}},x=i=>t(i==="admin"?"profile.admin":"profile.user"),p=i=>{switch(i){case"password":return t("profile.passwordAuth");case"publickey":return t("profile.publickeyAuth");case"both":return t("profile.bothAuth");default:return i}};return m?e.jsx(n,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"200px",children:e.jsx(A,{})}):a?e.jsxs(n,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:t("profile.personalInfo")}),c&&e.jsx(w,{severity:"error",sx:{mb:2},children:c}),e.jsxs(f,{spacing:3,children:[e.jsx(j,{children:e.jsxs(y,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:t("profile.accountInfo")}),e.jsxs(f,{spacing:2,children:[e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",children:t("profile.role")}),e.jsx(r,{variant:"body2",children:x(a.role)})]}),e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",children:t("profile.status")}),e.jsx(U,{label:a.status==="active"?t("common.active"):t("common.inactive"),color:b(a.status),size:"small"})]}),e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",children:t("profile.authMethod")}),e.jsx(r,{variant:"body2",children:p(a.authMethod)})]}),a.lastLoginTime&&e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",children:t("profile.lastLogin")}),e.jsx(r,{variant:"body2",children:new Date(a.lastLoginTime).toLocaleString()})]}),a.lastLoginIp&&e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",children:t("profile.lastLoginIp")}),e.jsx(r,{variant:"body2",fontFamily:"monospace",children:a.lastLoginIp})]})]})]})}),e.jsx(j,{children:e.jsxs(y,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:t("profile.accountDetails")}),e.jsxs(f,{spacing:2,children:[e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",children:t("profile.createdAt")}),e.jsx(r,{variant:"body2",children:new Date(a.createdAt).toLocaleString()})]}),e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",children:t("profile.updatedAt")}),e.jsx(r,{variant:"body2",children:new Date(a.updatedAt).toLocaleString()})]})]})]})})]})]}):e.jsx(w,{severity:"error",children:t("profile.loadUserInfoFailed")})}function ce(){const{t}=S(),[m]=Y(),[o,a]=l.useState(null),[g,c]=l.useState(!0),[d,u]=l.useState(0);l.useEffect(()=>{b(),m.get("setup2fa")==="true"&&u(1)},[m]);const b=async()=>{try{c(!0);const x=await K.getCurrentUser();a(x)}catch(x){console.error("加载用户信息失败:",x)}finally{c(!1)}};return g?e.jsx(n,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px",children:e.jsx(A,{})}):e.jsxs(n,{children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(k,{sx:{fontSize:40,mr:2,color:"primary.main"}}),e.jsxs(n,{children:[e.jsx(r,{variant:"h4",component:"h1",fontWeight:"700",children:t("menu.profile")}),e.jsx(r,{variant:"body2",color:"text.secondary",children:t("profile.description")})]})]}),m.get("setup2fa")==="true"&&e.jsx(w,{severity:"warning",sx:{mb:3},children:e.jsxs(r,{variant:"body2",children:[e.jsx("strong",{children:t("profile.importantTips")}),t("profile.global2FAWarning")]})}),e.jsxs(n,{sx:{display:"flex",gap:3},children:[e.jsx(j,{sx:{minWidth:300,height:"fit-content"},children:e.jsxs(y,{children:[e.jsxs(n,{sx:{display:"flex",alignItems:"center",mb:3},children:[e.jsx(Z,{sx:{width:80,height:80,mr:2,bgcolor:"primary.main"},children:o?.username?.charAt(0).toUpperCase()}),e.jsxs(n,{children:[e.jsx(r,{variant:"h6",fontWeight:"600",children:o?.fullName||o?.username}),e.jsxs(r,{variant:"body2",color:"text.secondary",children:["@",o?.username]}),e.jsx(r,{variant:"caption",color:"text.secondary",children:o?.email})]})]}),e.jsx(B,{sx:{my:2}}),e.jsxs(n,{sx:{mb:2},children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:t("profile.role")}),e.jsx(r,{variant:"body2",children:o?.role==="admin"?t("profile.admin"):t("profile.user")})]}),e.jsxs(n,{sx:{mb:2},children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:t("profile.status")}),e.jsx(r,{variant:"body2",color:o?.status==="active"?"success.main":"error.main",children:o?.status==="active"?t("common.active"):t("common.inactive")})]}),o?.lastLoginTime&&e.jsxs(n,{sx:{mb:2},children:[e.jsx(r,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:t("profile.lastLogin")}),e.jsx(r,{variant:"body2",children:new Date(o.lastLoginTime).toLocaleString()})]}),e.jsxs(n,{sx:{mt:3},children:[e.jsx(h,{fullWidth:!0,variant:d===0?"contained":"outlined",startIcon:e.jsx(k,{}),onClick:()=>u(0),sx:{mb:1},children:t("profile.personalInfo")}),e.jsx(h,{fullWidth:!0,variant:d===1?"contained":"outlined",startIcon:e.jsx(ee,{}),onClick:()=>u(1),sx:{mb:1},children:t("profile.security")}),e.jsx(h,{fullWidth:!0,variant:d===2?"contained":"outlined",startIcon:e.jsx(I,{}),onClick:()=>u(2),children:t("profile.sshKeys")})]})]})}),e.jsxs(n,{sx:{flex:1},children:[d===0&&e.jsx(ne,{}),d===1&&e.jsx(j,{children:e.jsxs(y,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,children:t("profile.security")}),e.jsx(te,{})]})}),d===2&&e.jsx(j,{children:e.jsx(y,{children:e.jsx(re,{})})})]})]})]})}export{ce as default};
