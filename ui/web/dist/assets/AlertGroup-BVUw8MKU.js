import{u as ee,r as i,b4 as G,j as r,B as P,w as se,x as re,T as z,a as S,v as te,A as ae,P as ne,d as L,I as R,g as oe,h as ie,i as le,k as ce,l as de,m as I,C as me,p as fe,bf as u,a7 as v}from"./index-STo1oTDL.js";import{a as C}from"./alertApi-ZkZdrWaX.js";import{S as w}from"./Stack-BJqE2zD7.js";import{T as pe,a as ue,b as he,c as A,d as c,e as ge}from"./TableRow-e9fRaRV7.js";import{C as H}from"./Chip-v5QMYL72.js";import{P as xe}from"./Pagination-CJp52pDe.js";import{A as je}from"./Autocomplete-B1ZKY7co.js";import"./LastPage-Bb7RE8XJ.js";function Me(){const{t:a}=ee(),[h,k]=i.useState([]),[N,O]=i.useState(!1),[J,W]=i.useState(!1),[D,T]=i.useState(null),[M,K]=i.useState(1),[_]=i.useState(10),[B,Q]=i.useState(0),[U,g]=i.useState([]),[x,j]=i.useState(!1),[l,b]=i.useState(new Map),[d,f]=i.useState({group_name:"",description:"",department_id:void 0,members:[]}),p=i.useCallback(async()=>{try{O(!0);const e={page:M,page_size:_},s=await C.getAlertGroups(e);(s.data.code===0||s.data.code===200)&&(k(s.data.data||[]),Q(s.data.total||0))}catch(e){console.error("获取告警组失败:",e),k([])}finally{O(!1)}},[M,_]);i.useEffect(()=>{p()},[p]),i.useEffect(()=>{if(h.length>0){const e=new Set;h.forEach(s=>{s.members&&Array.isArray(s.members)&&s.members.forEach(t=>{t&&typeof t=="string"&&t.trim()!==""&&!l.has(t)&&e.add(t)})}),e.size>0&&F(Array.from(e))}},[h]);const E=i.useCallback(async()=>{j(!0);try{const s=(await G.getUsersWithPagination({page:1,pageSize:10})).users||[];g(s);const t=new Map(l);s.forEach(o=>{t.set(String(o.id),o)}),b(t)}catch(e){console.error("加载用户列表失败:",e),g([])}finally{j(!1)}},[l]),$=i.useCallback(async e=>{if(!e||e.trim().length===0){await E();return}j(!0);try{const t=(await G.getUsersWithPagination({page:1,pageSize:10,keyword:e.trim()})).users||[];g(t);const o=new Map(l);t.forEach(n=>{o.set(String(n.id),n)}),b(o)}catch(s){console.error("搜索用户失败:",s),g([])}finally{j(!1)}},[E,l]),q=e=>{e?(T(e),f({group_name:e.group_name,description:e.description,department_id:e.department_id,members:e.members||[]}),e.members&&e.members.length>0&&F(e.members)):(T(null),f({group_name:"",description:"",department_id:void 0,members:[]})),W(!0)},y=()=>{W(!1),T(null),f({group_name:"",description:"",department_id:void 0,members:[]}),g([])},F=async e=>{if(e.length===0)return;const s=new Map(l),t=e.filter(o=>!s.has(o));if(t.length!==0)try{const o=await G.getUsersWithPagination({page:1,pageSize:1e3});o&&o.users&&((Array.isArray(o.users)?o.users:[]).forEach(m=>{t.includes(m.id)&&s.set(m.id,m)}),b(s))}catch(o){console.error("批量加载用户失败:",o)}},V=async()=>{if(!d.group_name){u(a("Please fill in required fields")||"请填写必填字段");return}try{if(D){const e=await C.updateAlertGroup(D.id,d);e.data.code===0||e.data.code===200?(v(a("Update successful")||"更新成功"),y(),p()):u(a("Update failed")||"更新失败")}else{const e=await C.createAlertGroup(d);e.data.code===0||e.data.code===200?(v(a("Create successful")||"创建成功"),y(),p()):u(a("Create failed")||"创建失败")}}catch(e){console.error("保存失败:",e);const s=e?.response?.data?.message||e?.message||a("Operation failed")||"操作失败";u(s)}},X=async e=>{if(confirm(a("Are you sure you want to delete this alert group?")||"确定要删除这个告警组吗？"))try{const t=(await C.deleteAlertGroup(e)).data;t.code===0||t.code===200?(v(a("Delete successful")||"删除成功"),p()):u(a("Delete failed")||"删除失败")}catch(s){console.error("删除失败:",s),u(s?.response?.data?.message||s?.message||a("Delete failed")||"删除失败")}},Y=e=>{if(!e||e.trim()==="")return"未知用户";const s=l.get(e);return s&&(s.fullName||s.username)||e};return r.jsxs(P,{sx:{p:3},children:[r.jsx(se,{children:r.jsxs(re,{children:[r.jsxs(P,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[r.jsx(z,{variant:"h5",gutterBottom:!0,children:a("menu.monitorAlertGroup")||a("Alert Group")||"告警组"}),r.jsxs(w,{direction:"row",spacing:2,children:[r.jsx(S,{variant:"outlined",startIcon:r.jsx(te,{}),onClick:p,disabled:N,children:a("common.refresh")}),r.jsx(S,{variant:"contained",startIcon:r.jsx(ae,{}),onClick:()=>q(),children:a("Create Alert Group")||"新建告警组"})]})]}),r.jsx(pe,{component:ne,children:r.jsxs(ue,{children:[r.jsx(he,{children:r.jsxs(A,{children:[r.jsx(c,{children:a("Group Name")||"告警组名称"}),r.jsx(c,{children:a("Description")||"描述"}),r.jsx(c,{children:a("Members")||"成员"}),r.jsx(c,{align:"right",children:a("common.actions")})]})}),r.jsx(ge,{children:N?r.jsx(A,{children:r.jsx(c,{colSpan:4,align:"center",children:a("common.loading")})}):h.length===0?r.jsx(A,{children:r.jsx(c,{colSpan:4,align:"center",children:a("common.noData")})}):h.map(e=>r.jsxs(A,{children:[r.jsx(c,{children:e.group_name}),r.jsx(c,{children:r.jsx(z,{variant:"body2",sx:{maxWidth:300,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.description||"-"})}),r.jsx(c,{children:r.jsx(w,{direction:"row",spacing:.5,flexWrap:"wrap",gap:.5,children:e.members&&e.members.length>0?e.members.map(s=>r.jsx(H,{label:Y(s),size:"small",onDelete:void 0},s)):r.jsx(z,{variant:"body2",color:"text.secondary",children:a("No members")||"无成员"})})}),r.jsx(c,{align:"right",children:r.jsxs(w,{direction:"row",spacing:1,justifyContent:"flex-end",children:[r.jsx(L,{title:a("common.edit"),children:r.jsx(R,{size:"small",onClick:()=>q(e),children:r.jsx(oe,{fontSize:"small"})})}),r.jsx(L,{title:a("common.delete"),children:r.jsx(R,{size:"small",color:"error",onClick:()=>X(e.id),children:r.jsx(ie,{fontSize:"small"})})})]})})]},e.id))})]})}),B>0&&r.jsx(P,{sx:{display:"flex",justifyContent:"center",mt:2},children:r.jsx(xe,{count:Math.ceil(B/_),page:M,onChange:(e,s)=>K(s),color:"primary"})})]})}),r.jsxs(le,{open:J,onClose:y,maxWidth:"md",fullWidth:!0,children:[r.jsx(ce,{children:D?a("Edit Alert Group")||"编辑告警组":a("Create Alert Group")||"新建告警组"}),r.jsx(de,{children:r.jsxs(w,{spacing:3,sx:{mt:1},children:[r.jsx(I,{label:`${a("Group Name")||"告警组名称"} *`,value:d.group_name,onChange:e=>f({...d,group_name:e.target.value}),fullWidth:!0,required:!0}),r.jsx(I,{label:a("Description")||"描述",value:d.description||"",onChange:e=>f({...d,description:e.target.value}),fullWidth:!0,multiline:!0,rows:3}),r.jsx(je,{multiple:!0,options:U,getOptionLabel:e=>e?typeof e=="object"?e.username||e.fullName||String(e.id):String(e):"",isOptionEqualToValue:(e,s)=>!e||!s?!1:typeof e=="object"&&typeof s=="object"?e.id===s.id:typeof e=="object"&&typeof s=="string"?e.id===s:typeof e=="string"&&typeof s=="object"?e===s.id:typeof e=="string"&&typeof s=="string"?e===s:!1,value:(Array.isArray(d.members)?d.members:[]).filter(s=>s&&s.trim()!=="").map(s=>{let t=l.get(s);return t||(t=U.find(o=>o.id===s)),t||{id:s,username:`用户${s}`,fullName:`用户${s}`}}).filter(s=>s),onChange:(e,s)=>{console.log("onChange triggered, newValue:",s);const t=new Map(l);s.forEach(n=>{typeof n=="object"&&n&&n.id&&t.set(n.id,n)}),b(t);const o=s.filter(n=>typeof n=="object"&&n&&n.id).map(n=>n.id).filter(n=>n&&n.trim()!=="");console.log("Selected members:",o,"from newValue:",s),f(n=>({...n,members:o}))},onInputChange:(e,s,t)=>{t==="input"?$(s):t==="clear"&&$("")},onOpen:()=>{!x&&U.length===0&&E()},loading:x,noOptionsText:x?a("common.loading")||"加载中...":a("No users found")||"未找到用户",filterOptions:e=>e,renderInput:e=>r.jsx(I,{...e,label:a("Members")||"成员",placeholder:a("Search and select members")||"搜索并选择成员",InputProps:{...e.InputProps,endAdornment:r.jsxs(r.Fragment,{children:[x?r.jsx(me,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderTags:(e,s)=>e.map((t,o)=>{const n=typeof t=="object"?t:l.get(String(t));let m;n?m=n.username||n.fullName||String(n.id):typeof t=="number"&&isNaN(t)?m="未知用户":m=String(t);const Z=typeof t=="object"?t.id||`user-${o}`:String(t);return i.createElement(H,{...s({index:o}),key:Z,label:m,size:"small"})})})]})}),r.jsxs(fe,{children:[r.jsx(S,{onClick:y,children:a("common.cancel")}),r.jsx(S,{onClick:V,variant:"contained",children:a("common.save")})]})]})]})}export{Me as default};
