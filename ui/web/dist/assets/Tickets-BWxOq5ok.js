import{r as n,j as e,i as le,k as ne,B as u,T as o,l as oe,P as A,D as ie,b as Y,p as ce,a as F,c as B,V as R,dt as $,u as de,ax as pe,b3 as ue,w as xe,x as he,C as ge,I as V,cz as fe,be as je}from"./index-z51Q_M-r.js";import{t as q}from"./ticketApi-CK6UtaTp.js";import{T as me}from"./ThirdPartyApprovalDialog-ysDOD5VS.js";import{C as P}from"./Chip-BoE43uAD.js";import{S as J}from"./Stack-07-bXrzl.js";import{T as M,a as L,b as O,c as m,d as s,e as N}from"./TableRow-CKQKXB8v.js";import{T as ve}from"./TablePagination-DV0GrBI0.js";import"./LastPage-BCKcUFpS.js";function ye({open:h,ticket:x,onClose:v,onRefresh:I}){const[y,g]=n.useState(!1),[D,c]=n.useState(null);n.useEffect(()=>{h&&x&&b()},[h,x]);const b=async()=>{if(x)try{g(!0);const l=await q.get(x.id);l.data.code===0&&c(l.data.data)}catch(l){console.error("加载工单详情失败:",l)}finally{g(!1)}},S=async()=>{await b()},_=()=>{I?.(),v()};if(!x)return null;const r=D||x,C=r.approval_status==="approved"?{label:"审批已通过",color:"success",icon:e.jsx(B,{})}:r.approval_status==="rejected"?{label:"审批已拒绝",color:"error",icon:e.jsx(R,{})}:r.approval_status==="pending"?{label:"审批中",color:"warning",icon:e.jsx($,{})}:{label:"未知状态",color:"default",icon:null};return e.jsxs(le,{open:h,onClose:_,maxWidth:"md",fullWidth:!0,children:[e.jsx(ne,{children:e.jsxs(u,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(o,{variant:"h6",children:"审批进度"}),e.jsx(P,{icon:C.icon||void 0,label:C.label,color:C.color,size:"small"})]})}),e.jsx(oe,{children:y?e.jsx(u,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(o,{children:"加载中..."})}):e.jsxs(J,{spacing:3,sx:{mt:1},children:[e.jsxs(u,{children:[e.jsx(o,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"工单信息"}),e.jsx(A,{variant:"outlined",sx:{p:2},children:e.jsxs(J,{spacing:1,children:[e.jsxs(u,{display:"flex",justifyContent:"space-between",children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"工单编号："}),e.jsx(o,{variant:"body2",fontWeight:500,children:r.ticket_number})]}),e.jsxs(u,{display:"flex",justifyContent:"space-between",children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"工单标题："}),e.jsx(o,{variant:"body2",fontWeight:500,children:r.title})]}),r.approval_platform&&e.jsxs(u,{display:"flex",justifyContent:"space-between",children:[e.jsx(o,{variant:"body2",color:"text.secondary",children:"审批平台："}),e.jsx(o,{variant:"body2",fontWeight:500,children:r.approval_platform==="feishu"?"飞书":r.approval_platform==="dingtalk"?"钉钉":r.approval_platform==="wechat"?"企业微信":r.approval_platform})]})]})})]}),e.jsx(ie,{}),e.jsxs(u,{children:[e.jsx(o,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"审批进度"}),r.approval_steps&&Array.isArray(r.approval_steps)&&r.approval_steps.length>0?e.jsx(M,{component:A,variant:"outlined",children:e.jsxs(L,{size:"small",children:[e.jsx(O,{children:e.jsxs(m,{children:[e.jsx(s,{align:"center",sx:{fontWeight:600},children:"审批人"}),e.jsx(s,{align:"center",sx:{fontWeight:600},children:"状态"}),e.jsx(s,{align:"center",sx:{fontWeight:600},children:"备注"})]})}),e.jsx(N,{children:r.approval_steps.map((l,w)=>{const T=l.approver||l.approver_name||"-",f=l.status||"pending";let d="待审批",p="default",i=null;return f==="approved"?(d="已批准",p="success",i=e.jsx(B,{fontSize:"small"})):f==="rejected"?(d="已拒绝",p="error",i=e.jsx(R,{fontSize:"small"})):(d="待审批",p="default",i=e.jsx($,{fontSize:"small"})),e.jsxs(m,{sx:{"&:hover":{bgcolor:"action.hover"}},children:[e.jsx(s,{align:"center",children:T}),e.jsx(s,{align:"center",children:e.jsx(P,{icon:i,label:d,color:p,size:"small"})}),e.jsx(s,{align:"center",children:l.comment||l.remark||"-"})]},w)})})]})}):r.approvers&&Array.isArray(r.approvers)&&r.approvers.length>0?e.jsx(M,{component:A,variant:"outlined",children:e.jsxs(L,{size:"small",children:[e.jsx(O,{children:e.jsxs(m,{children:[e.jsx(s,{align:"center",sx:{fontWeight:600},children:"审批人"}),e.jsx(s,{align:"center",sx:{fontWeight:600},children:"状态"})]})}),e.jsx(N,{children:r.approvers.map((l,w)=>{const f=r.approval_steps?.find(z=>z.approver===l||z.approver_name===l)?.status||"pending";let d="待审批",p="default",i=null;return f==="approved"?(d="已批准",p="success",i=e.jsx(B,{fontSize:"small"})):f==="rejected"?(d="已拒绝",p="error",i=e.jsx(R,{fontSize:"small"})):(d="待审批",p="default",i=e.jsx($,{fontSize:"small"})),e.jsxs(m,{sx:{"&:hover":{bgcolor:"action.hover"}},children:[e.jsx(s,{align:"center",children:l}),e.jsx(s,{align:"center",children:e.jsx(P,{icon:i,label:d,color:p,size:"small"})})]},w)})})]})}):e.jsx(Y,{severity:"info",children:"暂无审批信息"})]}),r.approval_comment&&e.jsxs(u,{children:[e.jsx(o,{variant:"subtitle2",color:"text.secondary",gutterBottom:!0,children:"审批意见"}),e.jsx(A,{variant:"outlined",sx:{p:2},children:e.jsx(o,{variant:"body2",children:r.approval_comment})})]})]})}),e.jsxs(ce,{children:[e.jsx(F,{onClick:S,disabled:y,children:"刷新"}),e.jsx(F,{onClick:_,variant:"contained",children:"关闭"})]})]})}function ze(){const{t:h}=de(),[x,v]=n.useState([]),[I,y]=n.useState(!1),[g,D]=n.useState(null),[c,b]=n.useState(!1),[S,_]=n.useState(1),[r,E]=n.useState(10),[C,l]=n.useState(0),[w,T]=n.useState(!1),[f,d]=n.useState(!1),[p,i]=n.useState(null),z=pe();n.useEffect(()=>{G()},[]);const G=async()=>{try{const a=await ue.getCurrentUser();D(a),b(a?.role==="admin")}catch(a){console.error("加载用户信息失败:",a);const t=localStorage.getItem("user");if(t){const j=JSON.parse(t);D(j),b(j?.role==="admin")}}},W=n.useCallback(async()=>{if(!(!c&&!g?.id))try{y(!0);const a={page:S,page_size:r};!c&&g?.id&&(a.applicant_id=g.id),a.exclude_status="draft";const t=await q.list(a);t.data.code===0?(v(t.data.data||[]),l(t.data.total||0)):(console.error("加载工单失败:",t.data),v([]),l(0))}catch(a){console.error("加载工单失败:",a),v([]),l(0)}finally{y(!1)}},[c,g,S,r]);n.useEffect(()=>{(c||g)&&W()},[c,g,W]);const K=a=>{E(Number(a.target.value)),_(1)},H=a=>{if(a.status==="draft")return{label:"草稿",color:"default"};if(a.status==="cancelled"||a.status==="void")return{label:"已作废",color:"default"};if(a.approval_status)switch(a.approval_status){case"pending":return{label:"审批中",color:"info"};case"rejected":return{label:"审批失败",color:"error"};case"canceled":return{label:"已取消",color:"default"};case"expired":return{label:"已过期",color:"warning"}}if(a.status==="rejected")return{label:"已拒绝",color:"error"};if(a.status==="approved"||a.approval_status==="approved"){if(a.deployment_id)switch(a.deployment_status){case"pending":return{label:"待发布",color:"warning"};case"running":return{label:"发布中",color:"info"};case"success":return{label:"发布成功",color:"success"};case"failed":return{label:"发布失败",color:"error"};case"cancelled":return{label:"发布已取消",color:"default"};default:return{label:"待发布",color:"warning"}}return{label:"待发布",color:"warning"}}return a.status==="submitted"&&(a.approval_status==="pending"||!a.approval_status)?{label:"审批中",color:"info"}:{label:{draft:"草稿",submitted:"审批中",approved:"待发布",rejected:"已拒绝",cancelled:"已作废",void:"已作废"}[a.status]||a.status,color:"default"}},Q=a=>{if(!a)return"-";try{const t=new Date(a);if(isNaN(t.getTime()))return a;const j=t.getFullYear(),ee=String(t.getMonth()+1).padStart(2,"0"),ae=String(t.getDate()).padStart(2,"0"),se=String(t.getHours()).padStart(2,"0"),re=String(t.getMinutes()).padStart(2,"0"),te=String(t.getSeconds()).padStart(2,"0");return`${j}-${ee}-${ae} ${se}:${re}:${te}`}catch(t){return console.error("日期格式化失败:",t),a}},X=a=>{i(a),a.approval_instance_id||a.approval_status?d(!0):T(!0)},Z=()=>{T(!1),i(null)},k=()=>{d(!1),i(null)},U=()=>{W()};return e.jsxs(u,{sx:{p:3},children:[e.jsx(o,{variant:"h4",gutterBottom:!0,children:c?"工单列表":"我的工单"}),e.jsx(xe,{sx:{mt:3},children:e.jsxs(he,{children:[e.jsx(u,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:e.jsx(o,{variant:"h6",children:c?"全部工单":"我的工单"})}),I?e.jsx(u,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(ge,{})}):e.jsxs(e.Fragment,{children:[x.length===0&&e.jsx(Y,{severity:"info",children:c?"暂无工单":"暂无我的工单"}),x.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(M,{children:e.jsxs(L,{children:[e.jsx(O,{children:e.jsxs(m,{children:[e.jsx(s,{children:"工单编号"}),e.jsx(s,{children:"工单类型"}),e.jsx(s,{children:"标题"}),c&&e.jsx(s,{children:"申请人"}),e.jsx(s,{children:"状态"}),e.jsx(s,{children:"优先级"}),e.jsx(s,{children:"创建时间"}),e.jsx(s,{align:"center",children:"审批详情"}),e.jsx(s,{align:"right",children:"工单详情"})]})}),e.jsx(N,{children:x.map(a=>e.jsxs(m,{children:[e.jsx(s,{children:a.ticket_number}),e.jsx(s,{children:e.jsx(P,{label:a.type==="deployment"?"发布工单":"运维工单",color:a.type==="deployment"?"primary":"default",size:"small",variant:"outlined"})}),e.jsx(s,{children:a.title||"-"}),c&&e.jsx(s,{children:a.applicant_username||a.applicant_name||a.applicant_id||"-"}),e.jsx(s,{children:e.jsx(P,{label:H(a).label,color:H(a).color,size:"small"})}),e.jsx(s,{children:a.priority==="low"?h("workorder.priority.low","低"):a.priority==="normal"?h("workorder.priority.normal","普通"):a.priority==="high"?h("workorder.priority.high","高"):a.priority==="urgent"?h("workorder.priority.urgent","紧急"):a.priority||h("workorder.priority.normal","普通")}),e.jsx(s,{children:Q(a.created_at)}),e.jsx(s,{align:"center",children:e.jsx(V,{size:"small",color:a.approval_instance_id||a.approval_status?"primary":"default",onClick:()=>X(a),disabled:a.status==="draft"||a.status==="cancelled",title:a.approval_instance_id||a.approval_status?"查看审批进度":"创建三方审批",children:e.jsx(fe,{fontSize:"small"})})}),e.jsx(s,{align:"right",children:e.jsx(V,{size:"small",onClick:()=>z(`/ticket/${a.id}`,{state:{from:"/tickets"}}),children:e.jsx(je,{fontSize:"small"})})})]},a.id))})]})}),e.jsx(ve,{component:"div",count:C,page:S-1,onPageChange:(a,t)=>_(t+1),rowsPerPage:r,onRowsPerPageChange:K,rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:"每页显示:",labelDisplayedRows:({from:a,to:t,count:j})=>`${a}-${t} 共 ${j} 条`,sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]})]})]})}),e.jsx(me,{open:w,ticket:p,onClose:Z,onSuccess:U}),e.jsx(ye,{open:f,ticket:p,onClose:k,onRefresh:U})]})}export{ze as default};
