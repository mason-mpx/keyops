import{u as Ye,r as i,dr as h,b3 as Qe,j as e,B as n,T as t,a as v,A as be,w as P,x as L,a3 as Ze,a4 as M,ds as Ce,P as ea,d as Se,I as ke,be as aa,h as X,i as J,k as q,l as F,b as C,F as Y,n as Q,o as Z,M as D,m as u,C as ra,p as K,D as V,W as sa,X as oa,O as la,Y as ta,V as Ae,c as Ie,f as De,a7 as w,bf as ee,ci as we,dt as We,aB as na,du as ia}from"./index-z51Q_M-r.js";import{d as ca}from"./deploymentApi-9InEBY1D.js";import{T as pa,a as da,b as ua,c as ae,d as x,e as ha}from"./TableRow-CKQKXB8v.js";import{C as m}from"./Chip-BoE43uAD.js";import{S as W}from"./Stack-07-bXrzl.js";import{A as xa}from"./Autocomplete-DXh7XcwX.js";import{L as va}from"./ListItemAvatar-DjehuR-a.js";function Ca(){const{t:s}=Ye(),[f,Te]=i.useState(0),[re,Pe]=i.useState([]),[,se]=i.useState(!1),[Le,B]=i.useState(!1),[Be,S]=i.useState(!1),[l,$]=i.useState(null),[oe,le]=i.useState([]),[g,Re]=i.useState(null),[y,te]=i.useState([]),[R,ne]=i.useState(""),[r,d]=i.useState({title:"",description:"",type:"host_access",resource_type:"host",resource_ids:[],resource_names:[],duration:24,reason:"",deploy_config:{deploy_type:"jenkins",jenkins_server_id:0,jenkins_job:"",project_id:"",env_id:"",cluster_id:"",package_version:"",env_label:"",sub_env_id:"",build_parameters:{}}}),[k,E]=i.useState(""),[Ee,T]=i.useState([]),[He,ie]=i.useState([]),[ce,pe]=i.useState(!1),[p,Ne]=i.useState(null),[_,de]=i.useState(!1),[ze,H]=i.useState(!1),[Oe,N]=i.useState(!1),[ue,he]=i.useState(""),[U,xe]=i.useState(""),[z,ve]=i.useState(""),[fe,je]=i.useState(!1),me=i.useCallback(async()=>{try{const o=((await h.getApprovalConfig()).configs||[]).filter(c=>c.enabled).map(c=>({id:c.id,type:c.type,name:c.name}));te(o),o.length===1&&ne(o[0].id)}catch(a){console.error("获取工单平台配置失败:",a),te([])}},[]),G=i.useCallback(async()=>{try{const a=await Qe.getCurrentUser();console.log("当前用户信息:",a),Ne(a),await Je(a.id)}catch(a){console.error("获取当前用户失败:",a)}},[]),b=i.useCallback(async()=>{if(p)try{se(!0);let a="my";_?f===1?a="approve":f===2&&(a="all"):f===1&&(a="all");const o=await h.getApprovals({user_id:p.id,role:a});Pe(o.approvals||[])}catch(a){console.error("加载审批列表失败:",a)}finally{se(!1)}},[p,f,_]),A=i.useCallback(async()=>{if(p)try{const a=await h.getApprovalStats(p.id);Re(a)}catch(a){console.error("加载统计失败:",a)}},[p]);i.useEffect(()=>{G(),me()},[G,me]),i.useEffect(()=>{p&&(b(),A())},[f,p,b,A]);const Je=async a=>{try{const o=await h.getApprovals({user_id:a,role:"approve"});de(o.approvals&&o.approvals.length>0)}catch(o){console.error("检查审批权限失败:",o),de(!1)}},qe=async a=>{if(!a||a.trim().length===0){T([]);return}try{pe(!0);const o=await h.searchHosts(a.trim());T(o.hosts||[])}catch(o){console.error("搜索主机失败:",o),T([])}finally{pe(!1)}};i.useEffect(()=>{const a=setTimeout(()=>{k&&k.trim().length>0?qe(k):T([])},400);return()=>clearTimeout(a)},[k]);const Fe=async()=>{if(y.length===0){alert(s("approvals.form.noPlatformConfigured"));return}if(!R){alert(s("approvals.form.selectPlatformRequired"));return}if(!r.title){alert(s("approvals.form.titleRequired"));return}if(!r.resource_ids.length){alert(s("approvals.form.resourceRequired"));return}if(!r.reason){alert(s("approvals.form.reasonRequired"));return}if(!p||!p.id){alert(s("approvals.form.userInfoNotLoaded")),await G();return}const a=y.find(j=>j.id===R);if(!a){alert(s("approvals.form.platformNotFound"));return}const{deploy_config:o,...c}=r,I={...c,platform:a.type,applicant_id:p.id,applicant_name:p.username||p.fullName||"",applicant_email:p.email};if(r.type==="deployment"){const j={...r.deploy_config.build_parameters};r.deploy_config.deploy_type==="jenkins"&&r.deploy_config.env_label?j.ENV_LABEL=r.deploy_config.env_label:r.deploy_config.deploy_type==="k8s"&&r.deploy_config.sub_env_id&&(j.SUB_ENV_ID=r.deploy_config.sub_env_id),I.deploy_config=JSON.stringify({deploy_type:r.deploy_config.deploy_type,jenkins_server_id:r.deploy_config.jenkins_server_id,jenkins_job:r.deploy_config.jenkins_job,build_parameters:j,project_id:r.deploy_config.project_id,env_id:r.deploy_config.env_id,cluster_id:r.deploy_config.cluster_id,package_version:r.deploy_config.package_version,env_label:r.deploy_config.env_label,sub_env_id:r.deploy_config.sub_env_id})}try{await h.createApproval(I),w(s("approvals.messages.createSuccess")),B(!1),O(),b(),A()}catch(j){console.error("创建审批失败:",j)}},Ke=async a=>{$(a);try{const o=await h.getApproval(a.id);$(o.approval),le(o.comments||[]),S(!0)}catch(o){console.error("加载详情失败:",o)}},Ve=async()=>{if(!(!l||!p))try{await h.approveApproval(l.id,{approver_id:p.id,approver_name:p.username||p.fullName,comment:ue}),w(s("approvals.messages.approveSuccess")),H(!1),S(!1),he(""),b(),A()}catch(a){console.error("批准失败:",a)}},$e=async()=>{if(!l||!U||!p){alert(s("approvals.form.rejectReasonRequired"));return}try{await h.rejectApproval(l.id,{approver_id:p.id,approver_name:p.username||p.fullName,reason:U}),w(s("approvals.messages.rejectSuccess")),N(!1),S(!1),xe(""),b(),A()}catch(a){console.error("拒绝失败:",a)}},Ue=async a=>{if(!(!p||!confirm(s("approvals.messages.cancelConfirm"))))try{await h.cancelApproval(a.id,{user_id:p.id}),w(s("approvals.messages.cancelSuccess")),b(),A()}catch(o){console.error("取消失败:",o)}},_e=async()=>{if(!(!l||!z.trim()||!p))try{await h.addComment(l.id,{user_id:p.id,user_name:p.username||p.fullName,comment:z}),w(s("approvals.messages.commentSuccess")),ve("");const a=await h.getApproval(l.id);le(a.comments||[])}catch(a){console.error("添加评论失败:",a)}},Ge=async()=>{if(!l||!l.deploy_config){ee("发布配置不存在");return}if(window.confirm("确认要执行发布吗？"))try{je(!0);let a;try{a=JSON.parse(l.deploy_config)}catch{ee("发布配置格式错误");return}a.deploy_type==="jenkins"&&(a.build_parameters||(a.build_parameters={}),a.env_label&&(a.build_parameters.ENV_LABEL=a.env_label),a.package_version&&(a.build_parameters.PACKAGE_VERSION=a.package_version),a.env_id&&(a.build_parameters.ENV_ID=a.env_id),a.cluster_id&&(a.build_parameters.CLUSTER_ID=a.cluster_id),a.project_id&&(a.build_parameters.PROJECT_ID=a.project_id));const o=await ca.createDeployment({project_name:l.title,deploy_type:a.deploy_type||"jenkins",deploy_config:a,description:`来自审批工单: ${l.title}`});await h.updateApproval(l.id,{deployment_id:o.id,deployed:!0}),w("发布任务已创建，正在执行中...");const c=await h.getApproval(l.id);$(c.approval),S(!1),b()}catch(a){const o=a;console.error("发布失败:",a),ee(o?.response?.data?.message||"发布失败，请稍后重试")}finally{je(!1)}},O=()=>{d({title:"",description:"",type:"host_access",resource_type:"host",resource_ids:[],resource_names:[],duration:24,reason:"",deploy_config:{deploy_type:"jenkins",jenkins_server_id:0,jenkins_job:"",project_id:"",env_id:"",cluster_id:"",package_version:"",env_label:"",sub_env_id:"",build_parameters:{}}}),E(""),T([]),ie([])},Me=a=>a?s(`approvals.platforms.${a}`):"-",ge=a=>({pending:"warning",approved:"success",rejected:"error",canceled:"default",expired:"default"})[a],ye=a=>({pending:e.jsx(We,{}),approved:e.jsx(ia,{}),rejected:e.jsx(na,{}),canceled:e.jsx(X,{}),expired:e.jsx(We,{})})[a],Xe=a=>({submit:e.jsx(be,{fontSize:"small"}),approve:e.jsx(Ie,{fontSize:"small"}),reject:e.jsx(Ae,{fontSize:"small"}),cancel:e.jsx(X,{fontSize:"small"}),comment:e.jsx(we,{fontSize:"small"})})[a]||e.jsx(we,{fontSize:"small"});return e.jsxs(n,{children:[e.jsxs(n,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(n,{children:[e.jsx(t,{variant:"h4",component:"h1",children:s("approvals.title")}),e.jsx(t,{variant:"body2",color:"textSecondary",children:s("approvals.subtitle")})]}),e.jsx(v,{variant:"contained",color:"primary",startIcon:e.jsx(be,{}),onClick:()=>{O(),B(!0)},disabled:y.length===0,children:s("approvals.createApproval")}),y.length===0&&e.jsx(t,{variant:"caption",color:"error",sx:{ml:2},children:s("approvals.form.noPlatformConfiguredShort")})]}),g&&e.jsxs(n,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap"},children:[e.jsx(P,{sx:{flex:_?"1 1 calc(25% - 12px)":"1 1 calc(33.33% - 12px)",minWidth:"200px"},children:e.jsxs(L,{children:[e.jsx(t,{color:"textSecondary",gutterBottom:!0,children:s("approvals.stats.total")}),e.jsx(t,{variant:"h4",children:g.my_approvals?.total||0})]})}),e.jsx(P,{sx:{flex:_?"1 1 calc(25% - 12px)":"1 1 calc(33.33% - 12px)",minWidth:"200px"},children:e.jsxs(L,{children:[e.jsx(t,{color:"textSecondary",gutterBottom:!0,children:s("approvals.stats.pending")}),e.jsx(t,{variant:"h4",color:"warning.main",children:g.my_approvals?.pending||0})]})}),e.jsx(P,{sx:{flex:_?"1 1 calc(25% - 12px)":"1 1 calc(33.33% - 12px)",minWidth:"200px"},children:e.jsxs(L,{children:[e.jsx(t,{color:"textSecondary",gutterBottom:!0,children:s("approvals.stats.approved")}),e.jsx(t,{variant:"h4",color:"success.main",children:g.my_approvals?.approved||0})]})}),_&&e.jsx(P,{sx:{flex:"1 1 calc(25% - 12px)",minWidth:"200px"},children:e.jsxs(L,{children:[e.jsx(t,{color:"textSecondary",gutterBottom:!0,children:s("approvals.pendingApprovals")}),e.jsx(t,{variant:"h4",color:"info.main",children:g.pending_approvals||0})]})})]}),e.jsxs(P,{children:[e.jsxs(Ze,{value:f,onChange:(a,o)=>Te(o),children:[e.jsx(M,{label:e.jsx(Ce,{badgeContent:g?.my_approvals?.pending||0,color:"warning",children:s("approvals.myApprovals")})}),_&&e.jsx(M,{label:e.jsx(Ce,{badgeContent:g?.pending_approvals||0,color:"error",children:s("approvals.pendingApprovals")})}),e.jsx(M,{label:s("approvals.allApprovals")})]}),e.jsx(L,{children:e.jsx(pa,{component:ea,elevation:0,children:e.jsxs(da,{children:[e.jsx(ua,{children:e.jsxs(ae,{children:[e.jsx(x,{children:s("approvals.table.title")}),e.jsx(x,{children:s("approvals.table.type")}),e.jsx(x,{children:s("approvals.table.status")}),f!==0&&e.jsx(x,{children:s("approvals.table.applicant")}),e.jsx(x,{children:s("approvals.table.createdAt")}),e.jsx(x,{align:"center",children:s("common.actions")})]})}),e.jsx(ha,{children:re.length===0?e.jsx(ae,{children:e.jsx(x,{colSpan:6,align:"center",sx:{py:8},children:e.jsx(t,{color:"textSecondary",children:s(_&&f===1?"approvals.messages.noPendingApprovals":"approvals.messages.noApprovals")})})}):re.map(a=>e.jsxs(ae,{hover:!0,children:[e.jsx(x,{children:e.jsx(t,{variant:"body2",fontWeight:"bold",children:a.title})}),e.jsx(x,{children:e.jsx(m,{label:s("approvals.types."+a.type),size:"small",variant:"outlined"})}),e.jsx(x,{children:e.jsx(m,{icon:ye(a.status),label:s("approvals.status."+a.status),color:ge(a.status),size:"small"})}),f!==0&&e.jsx(x,{children:a.applicant?.username||a.applicant_name}),e.jsx(x,{children:new Date(a.created_at).toLocaleString()}),e.jsx(x,{align:"center",children:e.jsxs(W,{direction:"row",spacing:1,justifyContent:"center",children:[e.jsx(Se,{title:s("approvals.approvalDetails"),children:e.jsx(ke,{size:"small",onClick:()=>Ke(a),children:e.jsx(aa,{})})}),f===0&&a.status==="pending"&&e.jsx(Se,{title:s("approvals.cancel"),children:e.jsx(ke,{size:"small",color:"error",onClick:()=>Ue(a),children:e.jsx(X,{})})})]})})]},a.id))})]})})})]}),e.jsxs(J,{open:Le,onClose:()=>{B(!1),O()},maxWidth:"md",fullWidth:!0,children:[e.jsx(q,{children:s("approvals.createApproval")}),e.jsx(F,{children:e.jsxs(W,{spacing:2.5,sx:{mt:1},children:[y.length===0?e.jsx(C,{severity:"warning",sx:{mb:1},children:s("approvals.form.noPlatformConfigured")}):e.jsxs(Y,{fullWidth:!0,required:!0,children:[e.jsx(Q,{children:s("approvals.form.platform")}),e.jsx(Z,{value:R,label:s("approvals.form.platform"),onChange:a=>ne(a.target.value),children:y.map(a=>e.jsxs(D,{value:a.id,children:[Me(a.type)," - ",a.name]},a.id))})]}),e.jsx(u,{fullWidth:!0,label:s("approvals.form.title"),value:r.title,onChange:a=>d({...r,title:a.target.value}),placeholder:s("approvals.form.titlePlaceholder"),required:!0}),e.jsx(u,{fullWidth:!0,label:s("approvals.form.description"),value:r.description,onChange:a=>d({...r,description:a.target.value}),placeholder:s("approvals.form.descriptionPlaceholder"),multiline:!0,rows:2}),e.jsxs(Y,{fullWidth:!0,children:[e.jsx(Q,{children:s("approvals.form.type")}),e.jsxs(Z,{value:r.type,label:s("approvals.form.type"),onChange:a=>d({...r,type:a.target.value}),children:[e.jsx(D,{value:"host_access",children:s("approvals.types.hostAccess")}),e.jsx(D,{value:"host_group_access",children:s("approvals.types.hostGroupAccess")}),e.jsx(D,{value:"deployment",children:s("approvals.types.deployment")})]})]}),e.jsx(xa,{multiple:!0,freeSolo:!1,options:Ee,getOptionLabel:a=>`${a.name} (${a.ip})`,isOptionEqualToValue:(a,o)=>a.id===o.id,value:He,onChange:(a,o)=>{ie(o);const c=o.map(j=>j.id),I=o.map(j=>j.name);d({...r,resource_ids:c,resource_names:I}),E("")},inputValue:k,onInputChange:(a,o,c)=>{c==="input"?E(o):c==="clear"&&E("")},loading:ce,noOptionsText:s(k?"approvals.form.noHostsFound":"approvals.form.enterHostSearch"),filterOptions:a=>a,renderInput:a=>e.jsx(u,{...a,label:s("approvals.form.selectResource"),placeholder:s("approvals.form.searchPlaceholder"),required:r.resource_ids.length===0,helperText:s("approvals.form.searchHelperText"),InputProps:{...a.InputProps,endAdornment:e.jsxs(e.Fragment,{children:[ce?e.jsx(ra,{color:"inherit",size:20}):null,a.InputProps.endAdornment]})}}),renderTags:(a,o)=>a.map((c,I)=>e.jsx(m,{label:`${c.name} (${c.ip})`,...o({index:I}),size:"small"}))}),e.jsx(u,{fullWidth:!0,type:"number",label:s("approvals.form.durationLabel"),value:r.duration,onChange:a=>d({...r,duration:parseInt(a.target.value)}),helperText:s("approvals.form.durationHelper"),InputProps:{endAdornment:s("approvals.form.durationHours")}}),e.jsx(u,{fullWidth:!0,label:s("approvals.form.reasonLabel"),value:r.reason,onChange:a=>d({...r,reason:a.target.value}),placeholder:s("approvals.form.reasonPlaceholder"),multiline:!0,rows:4,required:!0,helperText:s("approvals.form.reasonHelper")}),r.type==="deployment"&&e.jsxs(n,{sx:{mt:2,p:2,bgcolor:"background.default",borderRadius:1},children:[e.jsx(t,{variant:"h6",gutterBottom:!0,children:"发布配置"}),e.jsxs(W,{spacing:2,children:[e.jsxs(Y,{fullWidth:!0,children:[e.jsx(Q,{children:"发布类型"}),e.jsxs(Z,{value:r.deploy_config.deploy_type,label:"发布类型",onChange:a=>d({...r,deploy_config:{...r.deploy_config,deploy_type:a.target.value}}),children:[e.jsx(D,{value:"jenkins",children:"Jenkins发布"}),e.jsx(D,{value:"k8s",children:"K8s发布"})]})]}),r.deploy_config.deploy_type==="jenkins"&&e.jsxs(e.Fragment,{children:[e.jsx(u,{fullWidth:!0,label:"Jenkins服务器ID",type:"number",value:r.deploy_config.jenkins_server_id||"",onChange:a=>d({...r,deploy_config:{...r.deploy_config,jenkins_server_id:parseInt(a.target.value)||0}}),placeholder:"请输入Jenkins服务器ID"}),e.jsx(u,{fullWidth:!0,label:"Jenkins Job名称",value:r.deploy_config.jenkins_job,onChange:a=>d({...r,deploy_config:{...r.deploy_config,jenkins_job:a.target.value}}),placeholder:"请输入Jenkins Job名称"}),e.jsx(u,{fullWidth:!0,label:"项目ID",value:r.deploy_config.project_id,onChange:a=>d({...r,deploy_config:{...r.deploy_config,project_id:a.target.value}}),placeholder:"请输入项目ID"}),e.jsx(u,{fullWidth:!0,label:"环境ID",value:r.deploy_config.env_id,onChange:a=>{const o=a.target.value;let c=r.deploy_config.env_label;r.deploy_config.cluster_id==="3"&&o==="2"?c="staging_marcopolo":r.deploy_config.cluster_id==="3"&&o==="3"?c="prod_marcopolo":r.deploy_config.cluster_id!=="3"&&(c=""),d({...r,deploy_config:{...r.deploy_config,env_id:o,env_label:c}})},placeholder:"请输入环境ID（1=test, 2=staging, 3=prod）"}),e.jsx(u,{fullWidth:!0,label:"集群ID",value:r.deploy_config.cluster_id,onChange:a=>{const o=a.target.value;let c=r.deploy_config.env_label;o==="3"&&r.deploy_config.env_id==="2"?c="staging_marcopolo":o==="3"&&r.deploy_config.env_id==="3"?c="prod_marcopolo":o!=="3"&&(c=""),d({...r,deploy_config:{...r.deploy_config,cluster_id:o,env_label:c}})},placeholder:"请输入集群ID"}),e.jsx(u,{fullWidth:!0,label:"版本号",value:r.deploy_config.package_version,onChange:a=>d({...r,deploy_config:{...r.deploy_config,package_version:a.target.value}}),placeholder:"请输入版本号"}),e.jsx(u,{fullWidth:!0,label:"小环境标签（可选）",value:r.deploy_config.cluster_id==="3"&&r.deploy_config.env_id==="2"?"staging_marcopolo":r.deploy_config.cluster_id==="3"&&r.deploy_config.env_id==="3"?"prod_marcopolo":r.deploy_config.env_label,onChange:a=>{d({...r,deploy_config:{...r.deploy_config,env_label:a.target.value}})},placeholder:r.deploy_config.cluster_id==="3"&&r.deploy_config.env_id==="2"?"staging_marcopolo（自动设置）":r.deploy_config.cluster_id==="3"&&r.deploy_config.env_id==="3"?"prod_marcopolo（自动设置）":"默认无，或输入小环境标签",disabled:r.deploy_config.cluster_id==="3"&&r.deploy_config.env_id==="2"||r.deploy_config.cluster_id==="3"&&r.deploy_config.env_id==="3",helperText:r.deploy_config.cluster_id==="3"&&r.deploy_config.env_id==="2"?"集群3的staging环境自动使用staging_marcopolo标签":r.deploy_config.cluster_id==="3"&&r.deploy_config.env_id==="3"?"集群3的prod环境自动使用prod_marcopolo标签":"小环境标签用于多涌道发布，留空表示不使用小环境"})]}),r.deploy_config.deploy_type==="k8s"&&e.jsxs(e.Fragment,{children:[e.jsx(u,{fullWidth:!0,label:"项目ID",value:r.deploy_config.project_id,onChange:a=>d({...r,deploy_config:{...r.deploy_config,project_id:a.target.value}}),placeholder:"请输入项目ID"}),e.jsx(u,{fullWidth:!0,label:"环境ID",value:r.deploy_config.env_id,onChange:a=>d({...r,deploy_config:{...r.deploy_config,env_id:a.target.value}}),placeholder:"请输入环境ID"}),e.jsx(u,{fullWidth:!0,label:"集群ID",value:r.deploy_config.cluster_id,onChange:a=>d({...r,deploy_config:{...r.deploy_config,cluster_id:a.target.value}}),placeholder:"请输入集群ID"}),e.jsx(u,{fullWidth:!0,label:"版本号",value:r.deploy_config.package_version,onChange:a=>d({...r,deploy_config:{...r.deploy_config,package_version:a.target.value}}),placeholder:"请输入版本号"}),e.jsx(u,{fullWidth:!0,label:"小环境ID（可选）",value:r.deploy_config.sub_env_id,onChange:a=>d({...r,deploy_config:{...r.deploy_config,sub_env_id:a.target.value}}),placeholder:"没有小环境不用填",helperText:"小环境ID用于K8s多涌道发布，留空表示不使用小环境"})]})]})]})]})}),e.jsxs(K,{children:[e.jsx(v,{onClick:()=>{B(!1),O()},children:s("common.cancel")}),e.jsx(v,{onClick:Fe,variant:"contained",color:"primary",disabled:y.length===0||!R,children:s("approvals.actions.submit")})]})]}),e.jsxs(J,{open:Be,onClose:()=>S(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(q,{children:e.jsxs(n,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsx(t,{variant:"h6",children:s("approvals.approvalDetails")}),l&&e.jsx(m,{icon:ye(l.status),label:s("approvals.status."+l.status),color:ge(l.status)})]})}),e.jsx(F,{dividers:!0,children:l&&e.jsxs(n,{display:"flex",flexDirection:"column",gap:3,children:[e.jsxs(n,{children:[e.jsx(t,{variant:"h6",gutterBottom:!0,children:l.title}),l.description&&e.jsx(t,{variant:"body2",color:"textSecondary",paragraph:!0,children:l.description})]}),e.jsxs(n,{display:"flex",flexDirection:"column",gap:2,children:[e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsxs(n,{children:[e.jsx(t,{variant:"caption",color:"textSecondary",children:s("approvals.approvalType")}),e.jsx(t,{children:s("approvals.types."+l.type)})]}),e.jsxs(n,{children:[e.jsx(t,{variant:"caption",color:"textSecondary",children:s("approvals.applicant")}),e.jsx(t,{children:l.applicant?.username||l.applicant_name})]})]}),l.resource_names&&l.resource_names.length>0&&e.jsxs(n,{children:[e.jsx(t,{variant:"caption",color:"textSecondary",display:"block",gutterBottom:!0,children:s("approvals.resources")}),e.jsx(n,{display:"flex",flexWrap:"wrap",gap:.5,children:l.resource_names.map((a,o)=>e.jsx(m,{label:a,size:"small",variant:"outlined"},o))})]}),e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[l.duration&&e.jsxs(n,{children:[e.jsx(t,{variant:"caption",color:"textSecondary",children:s("approvals.duration")}),e.jsxs(t,{children:[l.duration," ",s("approvals.form.durationHours")]})]}),l.expires_at&&e.jsxs(n,{children:[e.jsx(t,{variant:"caption",color:"textSecondary",children:s("approvals.expirationTime")}),e.jsx(t,{children:new Date(l.expires_at).toLocaleString()})]})]})]}),e.jsx(V,{}),e.jsxs(n,{children:[e.jsx(t,{variant:"caption",color:"textSecondary",display:"block",gutterBottom:!0,children:s("approvals.reason")}),e.jsx(C,{severity:"info",sx:{mt:1},children:l.reason})]}),l.approval_note&&e.jsxs(n,{children:[e.jsx(t,{variant:"caption",color:"textSecondary",display:"block",gutterBottom:!0,children:s("approvals.approvalNote")}),e.jsx(C,{severity:"success",sx:{mt:1},children:l.approval_note})]}),l.reject_reason&&e.jsxs(n,{children:[e.jsx(t,{variant:"caption",color:"textSecondary",display:"block",gutterBottom:!0,children:s("approvals.rejectReason")}),e.jsx(C,{severity:"error",sx:{mt:1},children:l.reject_reason})]}),l.type==="deployment"&&l.deploy_config&&e.jsxs(n,{children:[e.jsx(V,{sx:{my:2}}),e.jsx(t,{variant:"h6",gutterBottom:!0,children:"发布配置"}),(()=>{try{const a=JSON.parse(l.deploy_config);return e.jsx(n,{sx:{mt:2},children:e.jsxs(W,{spacing:1,children:[e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(t,{variant:"caption",color:"textSecondary",children:"发布类型："}),e.jsx(t,{children:a.deploy_type==="jenkins"?"Jenkins发布":a.deploy_type==="k8s"?"K8s发布":a.deploy_type})]}),a.jenkins_job&&e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(t,{variant:"caption",color:"textSecondary",children:"Jenkins Job："}),e.jsx(t,{children:a.jenkins_job})]}),a.env_label&&e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(t,{variant:"caption",color:"textSecondary",children:"小环境标签："}),e.jsx(m,{label:a.env_label,size:"small",color:"primary"})]}),a.sub_env_id&&e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(t,{variant:"caption",color:"textSecondary",children:"小环境ID："}),e.jsx(m,{label:a.sub_env_id,size:"small",color:"primary"})]}),a.package_version&&e.jsxs(n,{display:"flex",justifyContent:"space-between",children:[e.jsx(t,{variant:"caption",color:"textSecondary",children:"版本号："}),e.jsx(t,{children:a.package_version})]}),a.build_parameters&&Object.keys(a.build_parameters).length>0&&e.jsxs(n,{children:[e.jsx(t,{variant:"caption",color:"textSecondary",display:"block",gutterBottom:!0,children:"构建参数："}),e.jsx(n,{display:"flex",flexWrap:"wrap",gap:.5,children:Object.entries(a.build_parameters).map(([o,c])=>e.jsx(m,{label:`${o}=${c}`,size:"small",variant:"outlined"},o))})]})]})})}catch{return e.jsx(C,{severity:"warning",sx:{mt:1},children:"发布配置格式错误"})}})()]}),e.jsxs(n,{children:[e.jsx(V,{}),e.jsx(t,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:s("approvals.history")}),e.jsxs(sa,{sx:{mt:2},children:[oe.map(a=>e.jsxs(oa,{alignItems:"flex-start",sx:{borderLeft:3,borderColor:a.action==="approve"?"success.main":a.action==="reject"?"error.main":"primary.main",pl:2,mb:2,bgcolor:"background.paper"},children:[e.jsx(va,{children:e.jsx(la,{sx:{bgcolor:a.action==="approve"?"success.main":a.action==="reject"?"error.main":"primary.main"},children:Xe(a.action)})}),e.jsx(ta,{primary:e.jsxs(n,{children:[e.jsx(t,{variant:"body2",fontWeight:"bold",component:"span",children:a.user_name||a.user_id}),e.jsx(m,{label:s("approvals.actions."+a.action),size:"small",sx:{ml:1},color:a.action==="approve"?"success":a.action==="reject"?"error":"primary"})]}),secondary:e.jsxs(n,{sx:{mt:.5},children:[a.comment&&e.jsx(t,{variant:"body2",color:"textSecondary",paragraph:!0,sx:{mb:.5},children:a.comment}),e.jsx(t,{variant:"caption",color:"textSecondary",children:new Date(a.created_at).toLocaleString()})]})})]},a.id)),oe.length===0&&e.jsx(t,{variant:"body2",color:"textSecondary",align:"center",sx:{py:4},children:s("approvals.messages.noApprovals")})]})]}),e.jsxs(n,{children:[e.jsx(V,{sx:{mb:2}}),e.jsx(u,{fullWidth:!0,label:s("approvals.addComment"),value:z,onChange:a=>ve(a.target.value),placeholder:s("approvals.form.commentPlaceholder"),multiline:!0,rows:2,onKeyPress:a=>{a.key==="Enter"&&!a.shiftKey&&(a.preventDefault(),_e())},InputProps:{endAdornment:e.jsx(v,{onClick:_e,disabled:!z.trim(),children:s("approvals.comment")})}})]})]})}),e.jsxs(K,{children:[e.jsx(v,{onClick:()=>S(!1),children:s("common.close")}),l&&l.status==="pending"&&_&&f===1&&e.jsxs(e.Fragment,{children:[e.jsx(v,{onClick:()=>N(!0),color:"error",startIcon:e.jsx(Ae,{}),children:s("approvals.reject")}),e.jsx(v,{onClick:()=>H(!0),variant:"contained",color:"success",startIcon:e.jsx(Ie,{}),children:s("approvals.approve")})]}),l&&l.status==="approved"&&l.type==="deployment"&&!l.deployed&&e.jsx(v,{onClick:Ge,variant:"contained",color:"primary",startIcon:e.jsx(De,{}),disabled:fe,children:fe?"发布中...":"发布"}),l&&l.status==="approved"&&l.type==="deployment"&&l.deployed&&e.jsx(m,{label:l.deployment_id?"已发布":"发布中",color:"success",icon:e.jsx(De,{})})]})]}),e.jsxs(J,{open:ze,onClose:()=>H(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(q,{children:s("approvals.approve")}),e.jsx(F,{children:e.jsxs(W,{spacing:2,sx:{mt:1},children:[e.jsx(C,{severity:"info",children:s("approvals.messages.approveConfirm")}),e.jsx(u,{fullWidth:!0,label:s("approvals.form.noteLabel"),value:ue,onChange:a=>he(a.target.value),placeholder:s("approvals.form.notePlaceholder"),multiline:!0,rows:4})]})}),e.jsxs(K,{children:[e.jsx(v,{onClick:()=>H(!1),children:s("common.cancel")}),e.jsx(v,{onClick:Ve,variant:"contained",color:"success",children:s("approvals.approve")})]})]}),e.jsxs(J,{open:Oe,onClose:()=>N(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(q,{children:s("approvals.reject")}),e.jsx(F,{children:e.jsxs(W,{spacing:2,sx:{mt:1},children:[e.jsx(C,{severity:"warning",children:s("approvals.messages.rejectConfirm")}),e.jsx(u,{fullWidth:!0,label:s("approvals.form.rejectReasonLabel"),value:U,onChange:a=>xe(a.target.value),placeholder:s("approvals.form.rejectReasonPlaceholder"),multiline:!0,rows:4,required:!0})]})}),e.jsxs(K,{children:[e.jsx(v,{onClick:()=>N(!1),children:s("common.cancel")}),e.jsx(v,{onClick:$e,variant:"contained",color:"error",children:s("approvals.reject")})]})]})]})}export{Ca as default};
