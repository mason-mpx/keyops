import{u as re,r as i,bf as C,j as e,i as he,k as ue,B as r,T as y,I as O,aB as fe,l as me,C as F,b as _,a3 as ye,a4 as V,g as ge,cC as pe,f as L,a as H,p as je,d as M,v as be,cl as ve,a5 as ke,a7 as G,bo as Ce,cD as De}from"./index-z51Q_M-r.js";import{F as ae,w as Se}from"./index-B39DLDJr.js";import{a as ie}from"./k8sClusterApi-D8d3s8iX.js";import{P as we,a as Le}from"./PodLogsDialog-BSHqOKTh.js";function Q(d){const{children:f,value:g,index:l,...c}=d;return g!==l?null:e.jsx("div",{role:"tabpanel",id:`yaml-editor-tabpanel-${l}`,"aria-labelledby":`yaml-editor-tab-${l}`,...c,children:e.jsx(r,{sx:{p:0},children:f})})}function Oe({open:d,onClose:f,title:g,clusterId:l,namespace:c,resourceType:o,resourceName:x,onLoadYaml:R,onSaveYaml:D,onDryRun:v}){const{t}=re(),[m,z]=i.useState(!1),[B,U]=i.useState(!1),[P,X]=i.useState(!1),[T,$]=i.useState(""),[u,J]=i.useState(""),[Z,p]=i.useState(null),[N,q]=i.useState(""),[ee,E]=i.useState(null),[k,K]=i.useState(0),[S,I]=i.useState(!1),[A,w]=i.useState(null),[le,W]=i.useState(!1),se=i.useCallback(async()=>{if(!!["pv","storageclass","sc"].includes(o.toLowerCase())){w(!0);return}if(!l||!c||!o||!x){w(!1);return}try{if(await ie.checkPermission({cluster_id:l,namespace:c,resource_type:o,resource_name:x,action:"write"})){w(!0);return}const h=await ie.checkPermission({cluster_id:l,namespace:c,resource_type:o,resource_name:x,action:"admin"});w(h)}catch(n){console.error("检查权限失败:",n),w(!1)}},[l,c,o,x]),Y=i.useCallback(async(a=!0)=>{const n=!["pv","storageclass","sc"].includes(o.toLowerCase());if(!(!d||!l||!o||!x)){if(n&&!c){p("该资源类型需要 namespace 参数");return}await se();try{z(!0),p(null);const h=await R(l,c||"",o,x);$(h),J(h),I(!1),a&&(q(""),E(null))}catch(h){const j=h;let b=t("k8s.yaml.loadFailed");if(j?.response?.data)if(typeof j.response.data=="string")try{const ne=JSON.parse(j.response.data);b=ne.message||ne.msg||b}catch{b=j.response.data}else b=j.response.data.message||j.response.data.msg||b;else j?.message&&(b=j.message);p(b),C(b)}finally{z(!1)}}},[d,l,c,o,x,R,t,se]);i.useEffect(()=>{const s=!["pv","storageclass","sc"].includes(o.toLowerCase());d&&l&&o&&x&&(!s||c)?Y(!1):($(""),J(""),p(null),I(!1),q(""),E(null),K(0),w(null),W(!1))},[d,l,c,o,x,Y]);const oe=a=>{if(A===!1)return;const s=a||"";J(s),I(s!==T)},ce=async()=>{if(!D){C("保存功能未实现");return}try{U(!0),p(null),await D(l,c||"",o,x,u),$(u),I(!1),G(t("k8s.yaml.saveSuccess","保存成功"))}catch(a){const s=a;let n=t("k8s.yaml.saveFailed","保存失败");if(s?.response?.data)if(typeof s.response.data=="string")try{const h=JSON.parse(s.response.data);n=h.message||h.msg||n}catch{n=s.response.data}else n=s.response.data.message||s.response.data.msg||n;else s?.message&&(n=s.message);p(n),C(n)}finally{U(!1)}},te=async()=>{if(!v){C("Dry-run 功能未实现");return}if(!u||!u.trim()){C("YAML 内容不能为空");return}try{X(!0),p(null),E(null);const a=await v(l,c||"",o,x,u);if(!a||!a.trim())throw new Error("Dry-run 返回结果为空，请检查 YAML 格式是否正确或查看控制台错误信息");q(a),E(null),K(2),G(t("k8s.yaml.dryRunSuccess","Dry-run 验证成功！已切换到 Dry-run 标签页查看结果"))}catch(a){const s=a;let n=t("k8s.yaml.dryRunFailed","Dry-run 失败");if("response"in s&&s.response?.data)if(typeof s.response.data=="string")try{const h=JSON.parse(s.response.data);n=h.message||h.msg||n}catch{n=s.response.data}else n=s.response.data.message||s.response.data.msg||n;else s?.message&&(n=s.message);E(n),p(n),C(n)}finally{X(!1)}},de=()=>{const a=k===1?T:u;navigator.clipboard.writeText(a).then(()=>{G(t("k8s.yaml.copied"))}).catch(()=>{C(t("k8s.yaml.copyFailed"))})},xe=i.useCallback(()=>{Y(!0)},[Y]);return i.useEffect(()=>{if(!d){W(!1);return}if(k===1){const a=setTimeout(()=>{W(!0)},50);return()=>clearTimeout(a)}else{const a=setTimeout(()=>{W(!1)},150);return()=>clearTimeout(a)}},[k,d]),e.jsxs(he,{open:d,onClose:f,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{height:"90vh",maxHeight:"1200px",maxWidth:"1000px",display:"flex",flexDirection:"column"}},children:[e.jsx(ue,{sx:{flexShrink:0,pb:1.5},children:e.jsxs(r,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[e.jsxs(r,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(y,{variant:"h6",sx:{fontWeight:600},children:g}),S&&e.jsxs(y,{variant:"caption",color:"warning.main",sx:{ml:1},children:["(",t("k8s.yaml.modified","已修改"),")"]})]}),e.jsx(O,{onClick:f,size:"small",sx:{ml:2},children:e.jsx(fe,{})})]})}),e.jsx(me,{dividers:!0,sx:{flex:1,overflow:"hidden",display:"flex",flexDirection:"column",minHeight:0,p:0},children:m?e.jsx(r,{display:"flex",justifyContent:"center",alignItems:"center",sx:{flex:1,minHeight:300},children:e.jsx(F,{})}):Z&&!u?e.jsx(_,{severity:"error",sx:{m:2},children:Z}):e.jsxs(r,{sx:{display:"flex",flexDirection:"column",height:"100%"},children:[e.jsx(r,{sx:{borderBottom:1,borderColor:"divider",px:2},children:e.jsxs(ye,{value:k,onChange:(a,s)=>K(s),children:[e.jsx(V,{icon:e.jsx(ge,{}),iconPosition:"start",label:t("k8s.yaml.edit","编辑")}),e.jsx(V,{icon:e.jsx(pe,{}),iconPosition:"start",label:t("k8s.yaml.diff","对比"),disabled:!S||m}),v&&e.jsx(V,{icon:e.jsx(L,{}),iconPosition:"start",label:t("k8s.yaml.dryRun","Dry-run"),disabled:m||P||!S})]})}),e.jsxs(r,{sx:{flex:1,overflow:"hidden",position:"relative"},children:[e.jsx(Q,{value:k,index:0,children:e.jsxs(r,{sx:{height:"100%",position:"absolute",width:"100%",top:0,left:0},children:[A===!1&&e.jsx(_,{severity:"warning",sx:{m:2,position:"absolute",top:0,left:0,right:0,zIndex:1},children:t("k8s.yaml.noPermission","没有编辑权限，需要 write 或 admin 权限才能编辑和保存 YAML")}),e.jsx(ae,{height:"100%",language:"yaml",value:u,onChange:oe,theme:"vs-dark",options:{readOnly:A===!1,minimap:{enabled:!0},scrollBeyondLastLine:!1,fontSize:13,wordWrap:"on",automaticLayout:!0,tabSize:2,insertSpaces:!0,formatOnPaste:!0,formatOnType:!0}})]})}),e.jsx(Q,{value:k,index:1,children:e.jsx(r,{sx:{height:"100%",position:"absolute",width:"100%",top:0,left:0},children:le?e.jsx(Se,{height:"100%",language:"yaml",original:T,modified:u,theme:"vs-dark",loading:e.jsx(r,{display:"flex",justifyContent:"center",alignItems:"center",sx:{height:"100%"},children:e.jsx(F,{})}),options:{minimap:{enabled:!0},scrollBeyondLastLine:!1,fontSize:13,readOnly:!0,automaticLayout:!0,renderSideBySide:!0}},`diff-${T.length}-${u.length}`):e.jsx(r,{display:"flex",justifyContent:"center",alignItems:"center",sx:{height:"100%"},children:e.jsx(F,{})})})}),v&&e.jsx(Q,{value:k,index:2,children:e.jsx(r,{sx:{height:"100%",position:"absolute",width:"100%",top:0,left:0,display:"flex",flexDirection:"column"},children:P?e.jsxs(r,{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",sx:{height:"100%"},children:[e.jsx(F,{sx:{mb:2}}),e.jsx(y,{variant:"body2",color:"text.secondary",children:t("k8s.yaml.dryRunning","正在验证 YAML 配置...")})]}):ee?e.jsxs(e.Fragment,{children:[e.jsxs(_,{severity:"error",sx:{m:2,mb:1},icon:e.jsx(L,{}),children:[e.jsx(y,{variant:"body2",sx:{fontWeight:500,mb:.5},children:"Dry-run 验证失败"}),e.jsx(y,{variant:"body2",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word"},children:ee})]}),e.jsx(r,{display:"flex",justifyContent:"center",sx:{px:2,pb:2},children:e.jsx(H,{onClick:te,disabled:m||P||!S,variant:"contained",color:"info",startIcon:e.jsx(L,{}),children:t("k8s.yaml.dryRun","重新执行 Dry-run")})})]}):N?e.jsxs(e.Fragment,{children:[e.jsxs(_,{severity:"success",sx:{m:2,mb:1},icon:e.jsx(L,{}),children:[e.jsx(y,{variant:"body2",sx:{fontWeight:500,mb:.5},children:"Dry-run 验证成功"}),e.jsx(y,{variant:"caption",color:"text.secondary",children:"这是 Kubernetes 处理后的最终 YAML，包含默认值和自动生成的字段。此操作不会实际修改资源。"})]}),e.jsx(r,{sx:{flex:1,overflow:"hidden",position:"relative"},children:e.jsx(ae,{height:"100%",language:"yaml",value:N,theme:"vs-dark",options:{minimap:{enabled:!0},scrollBeyondLastLine:!1,fontSize:13,readOnly:!0,automaticLayout:!0}})})]}):e.jsxs(r,{display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",sx:{height:"100%",px:3},children:[e.jsx(L,{sx:{fontSize:48,color:"text.secondary",mb:2,opacity:.5}}),e.jsx(y,{variant:"h6",color:"text.secondary",sx:{mb:1,textAlign:"center"},children:"Dry-run 预览"}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",maxWidth:500,mb:3},children:t("k8s.yaml.dryRunHint","点击下面的按钮可以验证 YAML 配置是否正确，并预览 Kubernetes 处理后的最终资源定义（包含默认值和自动生成的字段）。此操作不会实际修改资源。")}),e.jsx(H,{onClick:te,disabled:m||P||!S,variant:"contained",color:"info",startIcon:e.jsx(L,{}),size:"large",children:P?t("k8s.yaml.dryRunning","Dry-running..."):t("k8s.yaml.dryRun","执行 Dry-run")})]})})})]})]})}),e.jsxs(je,{sx:{flexShrink:0,px:2,py:1.5},children:[e.jsxs(r,{sx:{display:"flex",gap:1,flex:1},children:[e.jsx(M,{title:t("k8s.yaml.reload","重新加载"),children:e.jsx(O,{onClick:xe,disabled:m,children:e.jsx(be,{})})}),e.jsx(M,{title:t("k8s.yaml.copy","复制"),children:e.jsx(O,{onClick:de,disabled:!u||m,children:e.jsx(ve,{})})})]}),e.jsxs(r,{sx:{display:"flex",gap:1},children:[D&&e.jsx(M,{title:A===!1?t("k8s.yaml.noPermission","没有编辑权限，需要 write 或 admin 权限"):"",children:e.jsx("span",{children:e.jsx(H,{onClick:ce,disabled:!S||m||B||A===!1,startIcon:e.jsx(ke,{}),variant:"contained",color:"primary",children:B?t("k8s.yaml.saving","保存中..."):t("k8s.yaml.save","保存")})})}),e.jsx(H,{onClick:f,variant:"outlined",children:t("common.close")})]})]})]})}function Me({pod:d,clusterId:f,namespace:g}){const{t:l}=re(),[c,o]=i.useState(!1),[x,R]=i.useState(!1),[D,v]=i.useState(""),t=()=>{o(!0)},m=()=>{o(!1),v("")},z=()=>{R(!0)},B=()=>{R(!1),v("")};return e.jsxs(e.Fragment,{children:[e.jsxs(r,{sx:{display:"flex",gap:.5},children:[e.jsx(M,{title:l("k8s.pods.terminal","终端"),children:e.jsx(O,{size:"small",onClick:t,disabled:d.status!=="Running",children:e.jsx(Ce,{fontSize:"small"})})}),e.jsx(M,{title:l("k8s.pods.logs","日志"),children:e.jsx(O,{size:"small",onClick:z,children:e.jsx(De,{fontSize:"small"})})})]}),f&&g&&e.jsx(we,{open:c,onClose:m,clusterId:f,namespace:g,podName:d.name,container:D}),f&&g&&e.jsx(Le,{open:x,onClose:B,clusterId:f,namespace:g,podName:d.name,container:D})]})}export{Me as P,Oe as Y};
