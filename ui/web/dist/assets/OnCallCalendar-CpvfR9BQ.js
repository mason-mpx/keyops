import{u as L,r as c,b4 as Y,j as t,B as x,T as f,cJ as O,F as A,n as R,o as q,M as J,P as K,I as _,cK as G,ba as Q,C as V,w as X,x as Z}from"./index-wVs8DYHr.js";import{o as $}from"./oncallApi-CZP4BEFT.js";import{C as ee}from"./Chip-DzNpApxT.js";function ae(){const{t:g}=L(),[j,k]=c.useState([]),[p,C]=c.useState(""),[b,w]=c.useState([]),[B,M]=c.useState(!1),[o,v]=c.useState(new Date),[y,E]=c.useState(new Map);c.useEffect(()=>{(async()=>{try{const s=(await $.getSchedules({page:1,pageSize:1e3})).data;if(s.code===0||s.code===200){const a=s.data||[];k(a),a.length>0&&!p&&C(a[0].id)}}catch(n){console.error("Failed to load schedules:",n)}})()},[p]);const T=c.useCallback(async e=>{if(e.length===0)return;const n=new Map(y),s=e.filter(a=>!n.has(a));if(s.length!==0)try{((await Y.getUsersWithPagination({page:1,pageSize:1e3})).users||[]).forEach(r=>{s.includes(r.id)&&n.set(r.id,r)}),E(n)}catch(a){console.error("Failed to load users:",a)}},[y]),I=c.useCallback(async e=>{M(!0);try{const s=(await $.getShiftsBySchedule(e)).data;if(s.code===0||s.code===200){const a=s.data||[],d=o.getFullYear(),r=o.getMonth(),l=new Date(d,r,1),h=new Date(d,r+1,0,23,59,59),m=a.filter(i=>{const S=new Date(i.start_time),D=new Date(i.end_time);return S<=h&&D>=l&&i.status==="active"});w(m);const u=m.filter(i=>!i.username);if(u.length>0){const i=Array.from(new Set(u.map(S=>S.user_id).filter(Boolean)));await T(i)}}}catch(n){console.error("Failed to load shifts:",n),w([])}finally{M(!1)}},[o,T]);c.useEffect(()=>{p?I(p):w([])},[p,I]);const U=c.useMemo(()=>{const e=o.getFullYear(),n=o.getMonth(),s=new Date(e,n+1,0),a=[],d=new Date;d.setHours(0,0,0,0);for(let r=1;r<=s.getDate();r++){const l=new Date(e,n,r);l.setHours(0,0,0,0);const h=b.filter(m=>{const u=new Date(m.start_time),i=new Date(m.end_time);return u.setHours(0,0,0,0),i.setHours(23,59,59,999),l>=u&&l<=i});a.push({date:l,shifts:h,isCurrentMonth:!0,isToday:l.getTime()===d.getTime()})}return a},[o,b]),W=()=>{v(new Date(o.getFullYear(),o.getMonth()-1,1))},z=()=>{v(new Date(o.getFullYear(),o.getMonth()+1,1))},H=()=>{const e=o.getFullYear(),n=o.getMonth()+1;return`${e}年${n}月`};return t.jsxs(x,{sx:{p:3},children:[t.jsxs(x,{sx:{mb:3,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[t.jsxs(f,{variant:"h5",sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(O,{}),g("On-Call Calendar")]}),t.jsx(x,{sx:{display:"flex",alignItems:"center",gap:2},children:j.length===0?t.jsx(f,{variant:"body2",color:"text.secondary",children:"暂无排班"}):t.jsxs(A,{sx:{minWidth:200},children:[t.jsx(R,{id:"schedule-select-label",shrink:!!p,children:g("Select Schedule")}),t.jsx(q,{labelId:"schedule-select-label",value:p||"",label:g("Select Schedule"),onChange:e=>{const n=e.target.value;C(typeof n=="number"?n:"")},children:j.map(e=>t.jsx(J,{value:e.id,children:e.schedule_name},e.id))})]})})]}),t.jsxs(K,{sx:{p:2},children:[t.jsxs(x,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",mb:2},children:[t.jsx(_,{onClick:W,children:t.jsx(G,{})}),t.jsx(f,{variant:"h6",children:H()}),t.jsx(_,{onClick:z,children:t.jsx(Q,{})})]}),B?t.jsx(x,{sx:{display:"flex",justifyContent:"center",p:4},children:t.jsx(V,{})}):t.jsx(t.Fragment,{children:t.jsx(x,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:U.map((e,n)=>t.jsx(X,{sx:{width:140,minHeight:120,display:"flex",flexDirection:"column",backgroundColor:e.isCurrentMonth?"background.paper":"action.hover",border:e.isToday?2:1,borderColor:e.isToday?"primary.main":"divider",opacity:e.isCurrentMonth?1:.6},children:t.jsxs(Z,{sx:{p:1,"&:last-child":{pb:1},flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[t.jsx(f,{variant:"body2",sx:{fontWeight:e.isToday?"bold":"normal",color:e.isToday?"primary.main":"text.primary",mb:.5,flexShrink:0},children:e.date.getDate()}),t.jsx(x,{sx:{display:"flex",flexDirection:"column",gap:.75,flex:1,overflow:"auto",width:"100%"},children:e.shifts.length===0?t.jsx(f,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.7rem",width:"fit-content"},children:g("No shifts scheduled")}):e.shifts.map((s,a)=>{const d=y.get(s.user_id)?.fullName||s.username||y.get(s.user_id)?.username||s.user_id,r=new Date(s.start_time),l=new Date(s.end_time),h=F=>{const N=String(F.getHours()).padStart(2,"0"),P=String(F.getMinutes()).padStart(2,"0");return`${N}:${P}`},m=e.date.toDateString(),u=l.toDateString(),i=r.toDateString(),D=u!==m&&u!==i?`${h(r)}-次日${h(l)}`:`${h(r)}-${h(l)}`;return t.jsxs(x,{sx:{display:"flex",flexDirection:"row",alignItems:"center",gap:.5,pb:a<e.shifts.length-1?.5:0,borderBottom:a<e.shifts.length-1?"1px solid":"none",borderColor:"divider",flexWrap:"wrap"},children:[t.jsx(ee,{label:d,size:"small",color:"primary",sx:{fontSize:"0.7rem",height:20,width:"fit-content",maxWidth:"100%"}}),t.jsx(f,{variant:"caption",color:"text.secondary",sx:{fontSize:"0.65rem",whiteSpace:"nowrap"},children:D})]},s.id)})})]})},`${e.date.getTime()}-${n}`))})})]})]})}export{ae as default};
