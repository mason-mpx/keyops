import{r,ax as F,b3 as N,j as a,B as u,T as j,w as W,x as q,a as J,A as V,C as Y,b as G,I as y,dq as K,be as Q}from"./index-OJNN34VQ.js";import{t as X}from"./ticketApi-CWQtxyXM.js";import{T as Z}from"./ThirdPartyApprovalDialog-DDeJ16GH.js";import{T as k,a as ee,b as ae,c as S,d as s,e as te}from"./TableRow-Dz3vPXNr.js";import{C as T}from"./Chip-pSvhxX1X.js";import{T as se}from"./TablePagination-CuKuo8TO.js";import"./Stack-D4jLN6n0.js";import"./LastPage-COOW1SXp.js";function pe(){const[o,v]=r.useState([]),[w,p]=r.useState(!1),[l,g]=r.useState(null),[i,f]=r.useState(1),[c,C]=r.useState(10),[P,I]=r.useState(0),[z,x]=r.useState(!1),[_,h]=r.useState(null),m=F();r.useEffect(()=>{A()},[]);const A=async()=>{try{const e=await N.getCurrentUser();g(e)}catch(e){console.error("加载用户信息失败:",e);const t=localStorage.getItem("user");if(t){const n=JSON.parse(t);g(n)}}},d=r.useCallback(async()=>{try{p(!0);const e={page:i,page_size:c};if(l?.id)e.applicant_id=l.id;else{console.warn("无法获取当前用户ID，无法查询我的工单");return}e.exclude_status="draft";const t=await X.list(e);t.data.code===0&&(v(t.data.data||[]),I(t.data.total||0))}catch(e){console.error("加载工单失败:",e)}finally{p(!1)}},[l,i,c]);r.useEffect(()=>{l&&d()},[l,d]);const D=e=>{C(Number(e.target.value)),f(1)},b=e=>{if(e.status==="draft")return{label:"草稿",color:"default"};if(e.status==="cancelled"||e.status==="void")return{label:"已作废",color:"default"};if(e.approval_status)switch(e.approval_status){case"pending":return{label:"审批中",color:"info"};case"rejected":return{label:"审批失败",color:"error"};case"canceled":return{label:"已取消",color:"default"};case"expired":return{label:"已过期",color:"warning"}}if(e.status==="rejected")return{label:"已拒绝",color:"error"};if(e.status==="approved"||e.approval_status==="approved"){if(e.deployment_id)switch(e.deployment_status){case"pending":return{label:"待发布",color:"warning"};case"running":return{label:"发布中",color:"info"};case"success":return{label:"发布成功",color:"success"};case"failed":return{label:"发布失败",color:"error"};case"cancelled":return{label:"发布已取消",color:"default"};default:return{label:"待发布",color:"warning"}}return{label:"待发布",color:"warning"}}return e.status==="submitted"&&(e.approval_status==="pending"||!e.approval_status)?{label:"审批中",color:"info"}:{label:{draft:"草稿",submitted:"审批中",approved:"待发布",rejected:"已拒绝",cancelled:"已作废",void:"已作废"}[e.status]||e.status,color:"default"}},$=e=>{const t=new Date(e),n=t.getFullYear(),H=t.getMonth()+1,O=t.getDate(),U=String(t.getHours()).padStart(2,"0"),E=String(t.getMinutes()).padStart(2,"0"),L=String(t.getSeconds()).padStart(2,"0");return`${n}-${H}-${O} ${U}:${E}:${L}`},B=e=>{h(e),x(!0)},M=()=>{x(!1),h(null)},R=()=>{d()};return a.jsxs(u,{sx:{p:3},children:[a.jsx(j,{variant:"h4",gutterBottom:!0,children:"我的工单"}),a.jsx(W,{sx:{mt:3},children:a.jsxs(q,{children:[a.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[a.jsx(j,{variant:"h6",children:"我的工单"}),a.jsx(J,{variant:"contained",startIcon:a.jsx(V,{}),onClick:()=>m("/create-ticket"),children:"新建工单"})]}),w?a.jsx(u,{sx:{display:"flex",justifyContent:"center",p:3},children:a.jsx(Y,{})}):a.jsxs(a.Fragment,{children:[o.length===0&&a.jsx(G,{severity:"info",children:"暂无我的工单"}),o.length>0&&a.jsxs(a.Fragment,{children:[a.jsx(k,{children:a.jsxs(ee,{children:[a.jsx(ae,{children:a.jsxs(S,{children:[a.jsx(s,{children:"工单编号"}),a.jsx(s,{children:"工单类型"}),a.jsx(s,{children:"标题"}),a.jsx(s,{children:"状态"}),a.jsx(s,{children:"优先级"}),a.jsx(s,{children:"创建时间"}),a.jsx(s,{align:"center",children:"三方审批"}),a.jsx(s,{align:"right",children:"操作"})]})}),a.jsx(te,{children:o.map(e=>a.jsxs(S,{children:[a.jsx(s,{children:e.ticket_number}),a.jsx(s,{children:a.jsx(T,{label:e.type==="deployment"?"发布工单":"日常工单",color:e.type==="deployment"?"primary":"default",size:"small",variant:"outlined"})}),a.jsx(s,{children:e.title}),a.jsx(s,{children:a.jsx(T,{label:b(e).label,color:b(e).color,size:"small"})}),a.jsx(s,{children:e.priority}),a.jsx(s,{children:$(e.created_at)}),a.jsx(s,{align:"center",children:a.jsx(y,{size:"small",color:"primary",onClick:()=>B(e),disabled:e.status!=="submitted"&&e.status!=="approved",children:a.jsx(K,{fontSize:"small"})})}),a.jsx(s,{align:"right",children:a.jsx(y,{size:"small",onClick:()=>m(`/ticket/${e.id}`,{state:{from:"/my-tickets"}}),children:a.jsx(Q,{fontSize:"small"})})})]},e.id))})]})}),a.jsx(se,{component:"div",count:P,page:i-1,onPageChange:(e,t)=>f(t+1),rowsPerPage:c,onRowsPerPageChange:D,rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:"每页显示:",labelDisplayedRows:({from:e,to:t,count:n})=>`${e}-${t} 共 ${n} 条`,sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]})]})]})}),a.jsx(Z,{open:z,ticket:_,onClose:M,onSuccess:R})]})}export{pe as default};
