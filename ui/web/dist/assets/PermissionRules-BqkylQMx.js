import{u as Z,r as p,H as u,j as s,B as i,w as R,x as I,T as c,aa as B,P as ee,a as G,A as se,c as ae,V as re,I as L,g as le,h as te,i as ie,k as oe,l as ne,m as g,F as S,n as w,o as T,M as C,y as O,Y as E,aD as P,_ as de,p as ce,b as me}from"./index-CJIrazW8.js";import{T as pe,a as ue,b as xe,c as V,d as o,e as he}from"./TableRow-JrGpygSA.js";import{C as n}from"./Chip-Bh8gAKTq.js";import{S as je}from"./Switch-CqW6_ohp.js";import{S as ye}from"./Snackbar-Cu58JEDO.js";const Ie=()=>{const{t:a}=Z(),[y,F]=p.useState([]),[,D]=p.useState(!1),[$,h]=p.useState(!1),[v,U]=p.useState(null),[q,k]=p.useState([]),[W,z]=p.useState([]),[A,N]=p.useState([]),[j,d]=p.useState({open:!1,message:"",severity:"success"}),[l,m]=p.useState({name:"",userGroupId:"",systemUserIds:[],hostGroupIds:[],validFrom:"",validTo:"",enabled:!0,priority:0,description:""});p.useEffect(()=>{f(),M(),Y(),_()},[]);const f=async()=>{D(!0);try{const e=await u.get("/api/permission-rules"),r=e.data?.data||e.data;F(Array.isArray(r)?r:[])}catch(e){d({open:!0,message:e.message||a("permissionRules.loadPermissionRulesFailed"),severity:"error"}),F([])}finally{D(!1)}},M=async()=>{try{const e=await u.get("/api/roles"),r=e.data?.data||e.data;k(Array.isArray(r)?r:[])}catch(e){console.error("Failed to fetch user groups:",e),k([])}},Y=async()=>{try{const e=await u.get("/api/system-users"),r=e.data?.data||e.data;z(Array.isArray(r)?r:[])}catch(e){console.error("Failed to fetch system users:",e),z([])}},_=async()=>{try{const e=await u.get("/api/host-groups?stats=true"),r=e.data?.data||e.data,t=r?.groups||r||[];N(Array.isArray(t)?t:[])}catch(e){console.error("Failed to fetch host groups:",e),N([])}},J=()=>{U(null),m({name:"",userGroupId:"",systemUserIds:[],hostGroupIds:[],validFrom:"",validTo:"",enabled:!0,priority:0,description:""}),h(!0)},K=e=>{U(e);const r=e.systemUserIds||(e.systemUserId?[e.systemUserId]:[]),t=e.hostGroupIds||(e.hostGroupId?[e.hostGroupId]:[]);m({name:e.name,userGroupId:e.userGroupId,systemUserIds:r,hostGroupIds:t,validFrom:e.validFrom?new Date(e.validFrom).toISOString().slice(0,16):"",validTo:e.validTo?new Date(e.validTo).toISOString().slice(0,16):"",enabled:e.enabled,priority:0,description:e.description||""}),h(!0)},Q=async e=>{if(window.confirm(a("permissionRules.deleteConfirm")))try{await u.delete(`/api/permission-rules/${e}`),d({open:!0,message:a("permissionRules.deleteSuccess"),severity:"success"}),f()}catch(r){d({open:!0,message:r.message||a("permissionRules.deleteFailed"),severity:"error"})}},X=async()=>{try{const e={...l};if(!e.userGroupId||e.userGroupId.trim()===""){d({open:!0,message:"请选择一个用户组",severity:"warning"});return}if(!e.systemUserIds||e.systemUserIds.length===0){d({open:!0,message:"请至少选择一个系统用户",severity:"warning"});return}if(!e.hostGroupIds||e.hostGroupIds.length===0){d({open:!0,message:"请至少选择一个主机组",severity:"warning"});return}e.validFrom?e.validFrom=new Date(e.validFrom).toISOString():delete e.validFrom,e.validTo?e.validTo=new Date(e.validTo).toISOString():delete e.validTo,v?(await u.put(`/api/permission-rules/${v.id}`,e),d({open:!0,message:a("permissionRules.updateSuccess"),severity:"success"})):(await u.post("/api/permission-rules",e),d({open:!0,message:a("permissionRules.createSuccess"),severity:"success"})),h(!1),f()}catch(e){d({open:!0,message:e.message||a("common.error"),severity:"error"})}},H=e=>{const r=new Date,t=e.validFrom?new Date(e.validFrom):null,x=e.validTo?new Date(e.validTo):null;return(!t||t<=r)&&(!x||x>=r)},b={total:y.length,enabled:y.filter(e=>e.enabled).length,valid:y.filter(e=>H(e)).length};return s.jsxs(i,{sx:{p:3},children:[s.jsxs(i,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap"},children:[s.jsx(R,{sx:{flex:"1 1 0",minWidth:200},children:s.jsxs(I,{children:[s.jsx(c,{color:"textSecondary",gutterBottom:!0,children:a("permissionRules.total")}),s.jsxs(c,{variant:"h4",children:[s.jsx(B,{sx:{mr:1,verticalAlign:"middle"}}),b.total]})]})}),s.jsx(R,{sx:{flex:"1 1 0",minWidth:200},children:s.jsxs(I,{children:[s.jsx(c,{color:"textSecondary",gutterBottom:!0,children:a("permissionRules.enabledCount")}),s.jsx(c,{variant:"h4",color:"success.main",children:b.enabled})]})}),s.jsx(R,{sx:{flex:"1 1 0",minWidth:200},children:s.jsxs(I,{children:[s.jsx(c,{color:"textSecondary",gutterBottom:!0,children:a("permissionRules.validCount")}),s.jsx(c,{variant:"h4",color:"primary.main",children:b.valid})]})})]}),s.jsxs(ee,{sx:{p:2},children:[s.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[s.jsx(c,{variant:"h6",children:a("permissionRules.title")}),s.jsx(G,{variant:"contained",startIcon:s.jsx(se,{}),onClick:J,children:a("permissionRules.addRule")})]}),s.jsx(pe,{children:s.jsxs(ue,{children:[s.jsx(xe,{children:s.jsxs(V,{children:[s.jsx(o,{children:a("permissionRules.name")}),s.jsx(o,{children:a("permissionRules.userGroup")}),s.jsx(o,{children:a("permissionRules.systemUser")}),s.jsx(o,{children:a("permissionRules.hostGroup")}),s.jsx(o,{children:a("permissionRules.validFrom")}),s.jsx(o,{children:a("permissionRules.enabled")}),s.jsx(o,{children:a("common.actions")})]})}),s.jsx(he,{children:y.map(e=>s.jsxs(V,{children:[s.jsx(o,{children:s.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[s.jsx(B,{}),e.name]})}),s.jsx(o,{children:s.jsx(n,{label:e.roleName||e.roleId,size:"small",color:"secondary"})}),s.jsx(o,{children:s.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.systemUserNames&&e.systemUserNames.length>0?e.systemUserNames.map((r,t)=>s.jsx(n,{label:r,size:"small",color:"success"},t)):e.systemUserName&&s.jsx(n,{label:e.systemUserName,size:"small",color:"success"})})}),s.jsx(o,{children:s.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.hostGroupNames&&e.hostGroupNames.length>0?e.hostGroupNames.map((r,t)=>s.jsx(n,{label:r,size:"small",color:"info"},t)):e.hostGroupName?s.jsx(n,{label:e.hostGroupName,size:"small",color:"info"}):s.jsx(n,{label:a("permissionRules.allHosts"),size:"small"})})}),s.jsx(o,{children:s.jsx(i,{children:!e.validFrom&&!e.validTo?s.jsx(n,{label:a("permissionRules.permanent"),size:"small",color:"success"}):s.jsxs(s.Fragment,{children:[H(e)?s.jsxs(s.Fragment,{children:[s.jsx(n,{label:a("permissionRules.valid"),size:"small",color:"success"}),e.validTo&&new Date(e.validTo).getTime()-new Date().getTime()<4320*60*1e3&&s.jsx(n,{label:a("permissionRules.expired"),size:"small",color:"warning",sx:{ml:1}})]}):s.jsx(n,{label:a("permissionRules.expired"),size:"small",color:"error"}),s.jsx(c,{variant:"caption",display:"block",sx:{mt:.5},children:e.validFrom&&`${new Date(e.validFrom).toLocaleString()}`}),s.jsx(c,{variant:"caption",display:"block",children:e.validTo&&`${new Date(e.validTo).toLocaleString()}`})]})})}),s.jsx(o,{children:e.enabled?s.jsx(n,{icon:s.jsx(ae,{}),label:a("permissionRules.enabled"),size:"small",color:"success"}):s.jsx(n,{icon:s.jsx(re,{}),label:a("permissionRules.disabled"),size:"small",color:"default"})}),s.jsxs(o,{children:[s.jsx(L,{size:"small",color:"primary",onClick:()=>K(e),children:s.jsx(le,{})}),s.jsx(L,{size:"small",color:"error",onClick:()=>Q(e.id),children:s.jsx(te,{})})]})]},e.id))})]})})]}),s.jsxs(ie,{open:$,onClose:()=>h(!1),maxWidth:"md",fullWidth:!0,children:[s.jsx(oe,{children:a(v?"permissionRules.editRule":"permissionRules.addRule")}),s.jsx(ne,{children:s.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2.5,pt:2},children:[s.jsx(g,{fullWidth:!0,label:a("permissionRules.name"),value:l.name,onChange:e=>m({...l,name:e.target.value}),required:!0}),s.jsxs(i,{sx:{display:"flex",gap:2},children:[s.jsxs(S,{fullWidth:!0,required:!0,children:[s.jsx(w,{children:a("permissionRules.userGroup")}),s.jsx(T,{value:l.userGroupId,onChange:e=>m({...l,userGroupId:e.target.value}),label:a("permissionRules.userGroup"),children:q.map(e=>s.jsx(C,{value:e.id,children:e.name},e.id))})]}),s.jsxs(S,{fullWidth:!0,required:!0,children:[s.jsx(w,{children:a("permissionRules.systemUser")}),s.jsx(T,{multiple:!0,value:l.systemUserIds,onChange:e=>m({...l,systemUserIds:typeof e.target.value=="string"?e.target.value.split(","):e.target.value}),input:s.jsx(P,{label:a("permissionRules.systemUser")}),renderValue:e=>s.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.map(r=>{const t=W.find(x=>x.id===r);return s.jsx(n,{label:t?.name||r,size:"small"},r)})}),children:W.map(e=>s.jsxs(C,{value:e.id,children:[s.jsx(O,{checked:l.systemUserIds.indexOf(e.id)>-1}),s.jsx(E,{primary:e.name,secondary:e.username})]},e.id))})]})]}),s.jsxs(i,{children:[s.jsxs(S,{fullWidth:!0,children:[s.jsx(w,{children:a("permissionRules.hostGroup")}),s.jsx(T,{multiple:!0,value:l.hostGroupIds,onChange:e=>m({...l,hostGroupIds:typeof e.target.value=="string"?e.target.value.split(","):e.target.value}),input:s.jsx(P,{label:a("permissionRules.hostGroup")}),renderValue:e=>s.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.length===0?s.jsx("em",{children:a("permissionRules.allHosts")}):e.map(r=>{const t=A.find(x=>x.id===r);return s.jsx(n,{label:t?.name||r,size:"small"},r)})}),children:A.map(e=>s.jsxs(C,{value:e.id,children:[s.jsx(O,{checked:l.hostGroupIds.indexOf(e.id)>-1}),s.jsx(E,{primary:e.name,secondary:`${e.hostCount||0} hosts`})]},e.id))})]}),s.jsx(c,{variant:"caption",color:"textSecondary",sx:{ml:1.5,mt:.5,display:"block"},children:a("permissionRules.hostGroupHelper")})]}),s.jsxs(i,{children:[s.jsxs(i,{sx:{display:"flex",gap:2},children:[s.jsx(g,{fullWidth:!0,label:a("permissionRules.validFrom"),type:"datetime-local",value:l.validFrom,onChange:e=>m({...l,validFrom:e.target.value}),InputLabelProps:{shrink:!0}}),s.jsx(g,{fullWidth:!0,label:a("permissionRules.validTo"),type:"datetime-local",value:l.validTo,onChange:e=>m({...l,validTo:e.target.value}),InputLabelProps:{shrink:!0}})]}),s.jsx(c,{variant:"caption",color:"textSecondary",sx:{ml:1.5,mt:.5,display:"block"},children:a("permissionRules.validityHelper")})]}),s.jsx(i,{children:s.jsx(de,{control:s.jsx(je,{checked:l.enabled,onChange:e=>m({...l,enabled:e.target.checked})}),label:a("permissionRules.enabled")})}),s.jsx(g,{fullWidth:!0,multiline:!0,rows:3,label:a("permissionRules.description"),value:l.description,onChange:e=>m({...l,description:e.target.value})})]})}),s.jsxs(ce,{children:[s.jsx(G,{onClick:()=>h(!1),children:a("common.cancel")}),s.jsx(G,{variant:"contained",onClick:X,children:a("common.confirm")})]})]}),s.jsx(ye,{open:j.open,autoHideDuration:3e3,onClose:()=>d({...j,open:!1}),children:s.jsx(me,{severity:j.severity,onClose:()=>d({...j,open:!1}),children:j.message})})]})};export{Ie as default};
