import{u as G,r as o,j as e,B as u,T as E,a as C,A as H,F,n as I,o as W,M as p,P as J,I as L,g as K,h as Q,i as V,k as X,l as Y,m as y,_ as Z,p as ee,c3 as te}from"./index-z51Q_M-r.js";import{o as x}from"./oncallApi-CRGC64w3.js";import{T as ae,a as ne,b as ie,c as j,d as i,e as oe}from"./TableRow-CKQKXB8v.js";import{C as le}from"./Chip-BoE43uAD.js";import{P as se}from"./Pagination-B8N1aUB7.js";import{S as re}from"./Switch-CFen4WHb.js";import"./LastPage-BCKcUFpS.js";function je(){const{t:a}=G(),[v,w]=o.useState([]),[N,D]=o.useState(!1),[z,r]=o.useState(!1),[d,f]=o.useState(null),[n,s]=o.useState({schedule_name:"",description:"",department_id:void 0,enabled:!0,notification_webhook:""}),[b,P]=o.useState(1),[g]=o.useState(10),[B,k]=o.useState(0),[S,O]=o.useState(""),[_,T]=o.useState([]),c=o.useCallback(async()=>{D(!0);try{const t=await x.getSchedules({page:b,pageSize:g,department_id:S||void 0});w(t.data.data||[]),k(t.data.total||0)}catch(t){console.error("Failed to load schedules:",t),w([]),k(0)}finally{D(!1)}},[b,g,S]);o.useEffect(()=>{c()},[c]),o.useEffect(()=>{(async()=>{try{const l=await te.getOrganizationTree(),A=q=>{let m=[];return q.forEach(h=>{h.unitType==="Department"&&m.push(h),h.children&&h.children.length>0&&(m=m.concat(A(h.children)))}),m};T(A(Array.isArray(l)?l:[]))}catch(l){console.error("Failed to load departments:",l),T([])}})()},[]);const R=async()=>{try{(await x.createSchedule(n)).data.data&&(r(!1),s({schedule_name:"",description:"",department_id:void 0,enabled:!0,notification_webhook:""}),c())}catch(t){console.error("Failed to create schedule:",t)}},U=async()=>{if(d)try{const t={schedule_name:n.schedule_name,description:n.description,department_id:n.department_id,enabled:n.enabled,notification_webhook:n.notification_webhook||void 0};(await x.updateSchedule(d.id,t)).data.data&&(r(!1),f(null),c())}catch(t){console.error("Failed to update schedule:",t)}},M=async t=>{if(window.confirm(a("Are you sure you want to delete this schedule?")))try{await x.deleteSchedule(t),c()}catch(l){console.error("Failed to delete schedule:",l)}},$=t=>{f(t),s({schedule_name:t.schedule_name,description:t.description,department_id:t.department_id,enabled:t.enabled,notification_webhook:t.notification_webhook||""}),r(!0)};return e.jsxs(u,{sx:{p:3},children:[e.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",mb:3},children:[e.jsx(E,{variant:"h5",component:"h1",children:a("menu.monitorOnCallSchedule")||"值班排班管理"}),e.jsx(C,{variant:"contained",startIcon:e.jsx(H,{}),onClick:()=>{f(null),s({schedule_name:"",description:"",department_id:void 0,enabled:!0}),r(!0)},children:a("Create Schedule")})]}),e.jsx(u,{sx:{mb:2,display:"flex",gap:2},children:e.jsxs(F,{sx:{minWidth:200},children:[e.jsx(I,{children:a("Department")||"部门"}),e.jsxs(W,{value:S,label:a("Department")||"部门",onChange:t=>O(t.target.value),children:[e.jsx(p,{value:"",children:a("common.all")}),_.map(t=>e.jsx(p,{value:t.id,children:t.unitName},t.id))]})]})}),e.jsx(ae,{component:J,children:e.jsxs(ne,{children:[e.jsx(ie,{children:e.jsxs(j,{children:[e.jsx(i,{children:a("Schedule Name")}),e.jsx(i,{children:a("common.description")}),e.jsx(i,{children:a("Department")||"部门"}),e.jsx(i,{children:a("common.status")}),e.jsx(i,{children:a("Created At")}),e.jsx(i,{children:a("common.actions")})]})}),e.jsx(oe,{children:N?e.jsx(j,{children:e.jsx(i,{colSpan:6,align:"center",children:a("common.loading")})}):v.length===0?e.jsx(j,{children:e.jsx(i,{colSpan:6,align:"center",children:a("common.noData")})}):v.map(t=>e.jsxs(j,{children:[e.jsx(i,{children:t.schedule_name}),e.jsx(i,{children:t.description||"-"}),e.jsx(i,{children:t.department_id?_.find(l=>l.id===t.department_id)?.unitName||`${a("Department")} ${t.department_id}`:a("Global Schedule")||"全局排班"}),e.jsx(i,{children:e.jsx(le,{label:t.enabled?a("common.enabled"):a("common.disabled"),color:t.enabled?"success":"default",size:"small"})}),e.jsx(i,{children:t.created_at||t.createdAt?new Date(t.created_at||t.createdAt||"").toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-"}),e.jsxs(i,{children:[e.jsx(L,{size:"small",onClick:()=>$(t),children:e.jsx(K,{})}),e.jsx(L,{size:"small",onClick:()=>M(t.id),children:e.jsx(Q,{})})]})]},t.id))})]})}),e.jsx(u,{sx:{display:"flex",justifyContent:"center",mt:2},children:e.jsx(se,{count:Math.ceil(B/g),page:b,onChange:(t,l)=>P(l)})}),e.jsxs(V,{open:z,onClose:()=>r(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(X,{children:a(d?"Edit Schedule":"Create Schedule")}),e.jsxs(Y,{children:[e.jsx(y,{fullWidth:!0,label:a("Schedule Name"),value:n.schedule_name,onChange:t=>s({...n,schedule_name:t.target.value}),margin:"normal",required:!0}),e.jsx(y,{fullWidth:!0,label:a("common.description"),value:n.description,onChange:t=>s({...n,description:t.target.value}),margin:"normal",multiline:!0,rows:3}),e.jsxs(F,{fullWidth:!0,margin:"normal",children:[e.jsx(I,{children:a("Department")}),e.jsxs(W,{value:n.department_id||"",label:a("Department"),onChange:t=>s({...n,department_id:t.target.value||void 0}),children:[e.jsx(p,{value:"",children:e.jsx("em",{children:a("Leave empty for global schedule")})}),_.map(t=>e.jsx(p,{value:t.id,children:t.unitName},t.id))]}),e.jsx(E,{variant:"caption",color:"text.secondary",sx:{mt:.5,ml:1.75},children:a("Leave empty for global schedule")})]}),e.jsx(y,{fullWidth:!0,label:a("Notification Webhook"),value:n.notification_webhook||"",onChange:t=>s({...n,notification_webhook:t.target.value}),margin:"normal",placeholder:a("Enter webhook URL for shift start notifications"),helperText:a("Supports WeChat, Feishu, DingTalk webhook URLs")}),e.jsx(Z,{control:e.jsx(re,{checked:n.enabled??!0,onChange:t=>s({...n,enabled:t.target.checked})}),label:a("common.enabled"),sx:{mt:2}})]}),e.jsxs(ee,{children:[e.jsx(C,{onClick:()=>r(!1),children:a("common.cancel")}),e.jsx(C,{onClick:d?U:R,variant:"contained",children:a(d?"Update":"common.create")})]})]})]})}export{je as default};
