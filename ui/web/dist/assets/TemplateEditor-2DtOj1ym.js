import{ax as H,bg as J,r as c,j as o,B as v,ay as q,az as K,I as N,aA as M,T as j,a as Q,a5 as U,P as X,m as S,aB as Y}from"./index-z51Q_M-r.js";import{f as x,a as w}from"./ticketApi-CK6UtaTp.js";import Z,{normalizeFormGridConfig as T}from"./index-DfXPxCbg.js";import{S as ee}from"./Stack-07-bXrzl.js";import{A as ae}from"./Autocomplete-DXh7XcwX.js";import"./index-BpbExZjt.js";import"./typeof-QjJsDpFa.js";import"./sortable.esm-BNg4s74o.js";import"./Chip-BoE43uAD.js";function fe(){const k=H(),{id:u}=J(),[D,C]=c.useState(!1),[E,m]=c.useState(!1),[f,F]=c.useState([]),[b,y]=c.useState(""),[l,d]=c.useState({name:"",category:"",description:""}),[A,I]=c.useState({}),n=c.useRef(!0);c.useEffect(()=>(g(),u&&V(Number(u)),()=>{n.current=!1}),[u]);const g=c.useCallback(async()=>{try{n.current&&m(!0);const e=(await x.list({page:1,page_size:100})).data,r=[Array.isArray(e)?e:void 0,!Array.isArray(e)&&e?.data&&Array.isArray(e.data)?e.data:void 0,!Array.isArray(e)&&e?.data&&typeof e.data=="object"&&!Array.isArray(e.data)?e.data.data:void 0,!Array.isArray(e)&&e?.data&&typeof e.data=="object"&&!Array.isArray(e.data)?e.data.list:void 0,!Array.isArray(e)&&e?.data&&typeof e.data=="object"&&!Array.isArray(e.data)?e.data.items:void 0,Array.isArray(e)?void 0:e?.list,Array.isArray(e)?void 0:e?.items].find(s=>Array.isArray(s))||[];n.current&&F(r)}catch(t){console.error("加载分类列表失败:",t)}finally{n.current&&m(!1)}},[]),[z,O]=c.useState(null),[B,P]=c.useState("1.0.0"),V=async t=>{try{n.current&&C(!0);const e=await w.get(t);if(e.data.code===0){const a=e.data.data;if(n.current){const r=a.category||"";d({name:a.name,category:r,description:a.description||""}),y(r);const s=a.schema&&typeof a.schema=="object"?a.schema:{},i=T(s);I(i),O(JSON.stringify(i)),P(a.version||"1.0.0")}}}catch(e){console.error("加载模板失败:",e)}finally{n.current&&C(!1)}},W=t=>{const e=t.split(".");if(e.length!==3)return"1.0.0";const a=parseInt(e[0])||1,r=parseInt(e[1])||0,s=parseInt(e[2])||0;return`${a}.${r}.${s+1}`},$=async()=>{if(!l.name.trim()){alert("请输入工单名称");return}try{n.current&&C(!0);let t=l.category;if(b.trim()&&!l.category){const p=b.trim();if(f.find(h=>h.name===p))t=p;else try{const h=await x.create({name:p});h.data.code===0&&h.data.data&&(await g(),t=p)}catch(h){console.error("创建分类失败:",h),alert("创建分类失败，请重试");return}}const e=JSON.stringify(A||{}),a=z!==null&&e!==z;let r;u?r=a?W(B):B:r="1.0.0";const s=T(A||{}),i={...l,category:t,schema:s,status:"active",version:r};u?await w.update(Number(u),i):await w.create(i),k("/form-templates")}catch(t){console.error("保存模板失败:",t),alert("保存失败，请重试")}finally{n.current&&C(!1)}},L=c.useCallback(t=>{n.current&&I(t)},[]),R=c.useCallback(async(t,e)=>{const a=e?.trim()||"";if(!a){d(s=>({...s,category:""})),y("");return}if(f.find(s=>s.name===a))d(s=>({...s,category:a})),y(a);else try{n.current&&m(!0);const s=await x.create({name:a});s.data.code===0&&s.data.data&&(await g(),n.current&&(d(i=>({...i,category:a})),y(a)))}catch(s){console.error("创建分类失败:",s),alert("创建分类失败，请重试")}finally{n.current&&m(!1)}},[f,g]),_=c.useCallback(async(t,e,a)=>{if(y(e),a==="blur"&&e.trim()){const r=e.trim();if(f.find(i=>i.name===r))d(i=>({...i,category:r}));else try{n.current&&m(!0);const i=await x.create({name:r});i.data.code===0&&i.data.data&&(await g(),n.current&&(d(p=>({...p,category:r})),y(r)))}catch(i){console.error("创建分类失败:",i),alert("创建分类失败，请重试")}finally{n.current&&m(!1)}}else a==="clear"&&(d(r=>({...r,category:""})),y(""))},[f,g]),G=c.useCallback(async(t,e)=>{if(t.stopPropagation(),!!window.confirm(`确定要删除分类"${e.name}"吗？删除后该分类下的模板将变为未分类。`))try{n.current&&m(!0),await x.remove(e.id),await g(),n.current&&d(a=>a.category===e.name?{...a,category:""}:a)}catch(a){console.error("删除分类失败:",a),alert("删除分类失败，请重试")}finally{n.current&&m(!1)}},[g]);return o.jsxs(v,{sx:{height:"100vh",width:"100vw",display:"flex",flexDirection:"column",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1300,bgcolor:"background.default",overflow:"hidden"},children:[o.jsx(q,{position:"static",color:"default",elevation:1,sx:{flexShrink:0,borderBottom:"1px solid",borderColor:"divider"},children:o.jsxs(K,{sx:{minHeight:"64px !important",px:{xs:2,sm:3}},children:[o.jsx(N,{edge:"start",onClick:()=>k("/form-templates"),sx:{mr:2},size:"large",children:o.jsx(M,{})}),o.jsx(j,{variant:"h6",sx:{flexGrow:1,fontWeight:600},children:u?"编辑工单模板":"新建工单模板"}),o.jsx(Q,{startIcon:o.jsx(U,{}),variant:"contained",onClick:$,disabled:D||!l.name.trim(),sx:{minWidth:100},children:"保存"})]})}),o.jsx(X,{sx:{p:2.5,borderBottom:"1px solid",borderColor:"divider",flexShrink:0,bgcolor:"background.paper"},children:o.jsxs(ee,{direction:"row",spacing:2.5,alignItems:"flex-start",children:[o.jsx(S,{label:"模板名称",value:l.name,onChange:t=>d({...l,name:t.target.value}),required:!0,sx:{minWidth:240},size:"small"}),o.jsx(ae,{freeSolo:!0,options:f.map(t=>t.name),value:l.category,inputValue:b,onChange:R,onInputChange:_,renderInput:t=>o.jsx(S,{...t,label:"分类",size:"small",sx:{minWidth:200},disabled:E&&f.length===0,placeholder:"选择或输入分类名称"}),renderOption:(t,e)=>{const a=f.find(r=>r.name===e);return a?c.createElement(v,{component:"li",...t,key:a.id,sx:{display:"flex",justifyContent:"space-between",alignItems:"center",px:1.5,py:.5,"&:hover .delete-icon":{opacity:1}}},o.jsx(j,{sx:{flex:1},children:e}),o.jsx(N,{size:"small",className:"delete-icon",onClick:r=>G(r,a),sx:{opacity:0,transition:"opacity 0.2s",color:"error.main",ml:1,"&:hover":{bgcolor:"error.light",color:"error.dark"}},children:o.jsx(Y,{fontSize:"small"})})):null}}),o.jsx(S,{label:"描述",value:l.description,onChange:t=>d({...l,description:t.target.value}),sx:{flex:1,maxWidth:600},size:"small",placeholder:"请输入模板描述（可选）"})]})}),o.jsx(v,{sx:{flex:1,overflow:"hidden",minHeight:0,position:"relative",bgcolor:"background.default"},children:(()=>{try{return o.jsx(Z,{value:A,onChange:L,height:"100%"})}catch(t){return o.jsx(v,{sx:{p:3,color:"error.main",display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:o.jsxs(j,{variant:"body1",children:["表单设计器加载失败: ",t instanceof Error?t.message:String(t)]})})}})()})]})}export{fe as default};
