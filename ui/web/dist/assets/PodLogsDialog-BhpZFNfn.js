import{u as _,r as n,bC as O,j as e,i as H,k as J,B as C,F as M,n as V,o as q,M as G,I as $,aB as K,l as Q,C as X,b as Y,p as Z,a as N,_ as re,m as se,cm as oe,v as le}from"./index-DNdAKB9f.js";import{x as ie,a as ce}from"./xterm-BqYE0GQX.js";import{k as ee}from"./index-CR_954yY.js";import{S as ae}from"./Switch-psoPU8CH.js";function he({open:i,onClose:L,clusterId:u,namespace:f,podName:l,container:R}){const{t:c}=_(),w=n.useRef(null),t=n.useRef(null),z=n.useRef(null),a=n.useRef(null),x=n.useRef(null),[y,E]=n.useState(!1),[B,k]=n.useState(!1),[I,p]=n.useState(null),[D,b]=n.useState([]),[j,v]=n.useState(R||"");n.useEffect(()=>{i&&u&&f&&l&&(async()=>{try{const h={clusterId:u,namespace:f},S=await ee.getContainersList(h,l);b(S),!j&&S.length>0&&v(S[0].name)}catch(h){console.error("Failed to load containers:",h)}})()},[i,u,f,l]),n.useEffect(()=>{if(!i){E(!1),t.current&&(t.current.dispose(),t.current=null);return}const s=setTimeout(()=>{w.current&&!t.current&&(F(),E(!0))},50);return()=>{clearTimeout(s)}},[i]),n.useEffect(()=>(i&&y&&t.current&&j?T():i||W(),()=>{i||W()}),[i,u,f,l,j,y]);const F=()=>{if(!w.current||t.current)return;const s=new ie.Terminal({cursorBlink:!0,fontSize:14,fontFamily:'Consolas, "Courier New", monospace',theme:{background:"#1e1e1e",foreground:"#d4d4d4"}}),h=new ce.FitAddon;s.loadAddon(h),s.open(w.current),h.fit(),t.current=s,z.current=h;const S=()=>{z.current&&t.current&&(z.current.fit(),a.current?.readyState===WebSocket.OPEN&&a.current.send(JSON.stringify({type:"resize",cols:t.current.cols,rows:t.current.rows})))};return window.addEventListener("resize",S),()=>{window.removeEventListener("resize",S)}},T=()=>{if(a.current&&W(),!u||!f||!l){console.error("[PodTerminalDialog] 缺少必要参数"),p("缺少必要参数");return}try{k(!0),p(null);let s,h;O.apiUrl&&O.apiUrl.trim()!==""||(h=window.location.host,s=window.location.protocol==="https:"?"wss:":"ws:");const S=`${s}//${h}`,r=new URLSearchParams({cluster_id:u,namespace:f,pod_name:l});j&&r.append("container",j);const m=localStorage.getItem("token");if(m)r.append("token",m);else{console.error("未找到 token"),p("未找到认证 token"),k(!1);return}const d=`${S}/api/v1/kube/pod/ws/terminal?${r.toString()}`,o=new WebSocket(d);a.current=o,o.onopen=()=>{if(k(!1),p(null),t.current){t.current.writeln(`Connected to pod terminal...\r
`);const g=JSON.stringify({type:"resize",cols:t.current.cols,rows:t.current.rows});o.send(g),t.current.onData(U=>{o.readyState===WebSocket.OPEN&&o.send(U)})}x.current=setInterval(()=>{if(o.readyState===WebSocket.OPEN)try{o.send(JSON.stringify({type:"ping"}))}catch(g){console.error("[PodTerminalDialog] Failed to send keep-alive:",g)}},6e4)},o.onmessage=g=>{t.current&&t.current.write(g.data)},o.onerror=g=>{console.error("WebSocket error:",g),p("WebSocket 连接错误"),k(!1),x.current&&(clearInterval(x.current),x.current=null),t.current&&t.current.writeln(`\r
\x1B[31mWebSocket connection error\x1B[0m\r
`)},o.onclose=g=>{k(!1),x.current&&(clearInterval(x.current),x.current=null),t.current&&t.current.writeln(`\r
\x1B[33mConnection closed (code: ${g.code})\x1B[0m\r
`),a.current===o&&(a.current=null)}}catch(s){console.error("Failed to connect WebSocket:",s),p(s.message||"连接失败"),k(!1)}},W=()=>{x.current&&(clearInterval(x.current),x.current=null),a.current&&(a.current.close(),a.current=null)};return e.jsxs(H,{open:i,onClose:L,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{height:"85vh",maxHeight:"85vh",maxWidth:"900px"}},children:[e.jsx(J,{sx:{pb:1},children:e.jsxs(C,{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:1,children:[e.jsxs(C,{children:[c("k8s.pods.terminal")," - ",l]}),e.jsxs(C,{display:"flex",gap:1,alignItems:"center",children:[D.length>0&&e.jsxs(M,{size:"small",sx:{minWidth:150},children:[e.jsx(V,{children:c("k8s.containers")}),e.jsx(q,{value:j,label:c("k8s.containers"),onChange:s=>{v(s.target.value),W(),p(null)},disabled:D.length===1,children:D.map(s=>e.jsx(G,{value:s.name,children:s.name},s.name))})]}),e.jsx($,{onClick:L,size:"small",children:e.jsx(K,{})})]})]})}),e.jsxs(Q,{sx:{p:0,display:"flex",flexDirection:"column",overflow:"hidden",backgroundColor:"#1e1e1e"},children:[B&&e.jsx(C,{display:"flex",justifyContent:"center",p:2,sx:{backgroundColor:"#1e1e1e"},children:e.jsx(X,{})}),I&&e.jsx(Y,{severity:"error",sx:{mb:2,mx:2,mt:2},children:I}),e.jsx(C,{ref:w,sx:{width:"100%",flex:1,minHeight:0,backgroundColor:"#1e1e1e",padding:1}})]}),e.jsx(Z,{sx:{pt:1,pb:2},children:e.jsx(N,{onClick:L,children:c("common.close")})})]})}function me({open:i,onClose:L,clusterId:u,namespace:f,podName:l,container:R}){const{t:c}=_(),[w,t]=n.useState(""),[z,a]=n.useState(!1),[x,y]=n.useState(null),[E,B]=n.useState(!0),[k,I]=n.useState(100),[p,D]=n.useState([]),[b,j]=n.useState(R||""),v=n.useRef(null),F=n.useRef(null);n.useEffect(()=>{i&&u&&f&&l&&(async()=>{try{const m={clusterId:u,namespace:f},d=await ee.getContainersList(m,l);D(d),!b&&d.length>0?j(d[0].name):R&&d.some(o=>o.name===R)&&j(R)}catch(m){console.error("Failed to load containers:",m)}})()},[i,u,f,l,R]),n.useEffect(()=>(i&&b?T():(W(),t(""),y(null)),()=>{W()}),[i,u,f,l,b,E,k]),n.useEffect(()=>{F.current&&F.current.scrollIntoView({behavior:"smooth"})},[w]);const T=()=>{if(!u||!f||!l){y("缺少必要参数");return}try{a(!0),y(null);const r=window.location.protocol==="https:"?"wss:":"ws:",m=window.location.host,d=`${r}//${m}`,o=new URLSearchParams({cluster_id:u,namespace:f,pod_name:l,follow:E.toString(),tail_lines:k.toString()});b&&o.append("container",b);const g=localStorage.getItem("token");g&&o.append("token",g);const U=`${d}/api/v1/kube/pod/ws/logs?${o.toString()}`,P=new WebSocket(U);v.current=P,P.onopen=()=>{a(!1),y(null)},P.onmessage=A=>{const te=A.data;t(ne=>ne+te)},P.onerror=A=>{console.error("WebSocket error:",A),y("WebSocket 连接错误"),a(!1)},P.onclose=()=>{a(!1),v.current===P&&(v.current=null)}}catch(r){console.error("Failed to connect WebSocket:",r),y(r.message||"连接失败"),a(!1)}},W=()=>{v.current&&(v.current.close(),v.current=null)},s=()=>{W(),t(""),T()},h=()=>{if(!w)return;const r=new Blob([w],{type:"text/plain"}),m=URL.createObjectURL(r),d=document.createElement("a");d.href=m,d.download=`${l}${b?`-${b}`:""}-logs-${new Date().toISOString()}.txt`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(m)},S=r=>{j(r),W(),t("")};return e.jsxs(H,{open:i,onClose:L,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{height:"85vh",maxHeight:"85vh",maxWidth:"900px"}},children:[e.jsx(J,{sx:{pb:1},children:e.jsxs(C,{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:1,children:[e.jsxs(C,{children:[c("k8s.pods.logs")," - ",l]}),e.jsxs(C,{display:"flex",gap:1,alignItems:"center",flexWrap:"wrap",children:[p.length>0&&e.jsxs(M,{size:"small",sx:{minWidth:150},children:[e.jsx(V,{children:c("k8s.containers")}),e.jsx(q,{value:b,label:c("k8s.containers"),onChange:r=>S(r.target.value),disabled:p.length===1,children:p.map(r=>e.jsx(G,{value:r.name,children:r.name},r.name))})]}),e.jsx(re,{control:e.jsx(ae,{checked:E,onChange:r=>B(r.target.checked),size:"small"}),label:c("k8s.pods.followLogs")}),e.jsx(se,{type:"number",label:c("k8s.pods.tailLines"),value:k,onChange:r=>I(parseInt(r.target.value)||100),size:"small",sx:{width:100}}),e.jsx($,{onClick:h,size:"small",title:c("common.download"),disabled:!w,children:e.jsx(oe,{})}),e.jsx($,{onClick:s,size:"small",title:c("common.refresh"),children:e.jsx(le,{})}),e.jsx($,{onClick:L,size:"small",children:e.jsx(K,{})})]})]})}),e.jsxs(Q,{sx:{p:2,display:"flex",flexDirection:"column",overflow:"hidden"},children:[z&&e.jsx(C,{display:"flex",justifyContent:"center",p:2,children:e.jsx(X,{})}),x&&e.jsx(Y,{severity:"error",sx:{mb:2},children:x}),e.jsxs(C,{sx:{fontFamily:"monospace",fontSize:"12px",whiteSpace:"pre-wrap",wordBreak:"break-all",backgroundColor:"#1e1e1e",color:"#d4d4d4",padding:2,borderRadius:1,flex:1,minHeight:0,overflow:"auto"},children:[w||c(z?"k8s.pods.loadingLogs":"k8s.pods.noLogs"),e.jsx("div",{ref:F})]})]}),e.jsx(Z,{sx:{pt:1,pb:2},children:e.jsx(N,{onClick:L,children:c("common.close")})})]})}export{he as P,me as a};
