import{u as A,r as s,ax as M,b3 as D,j as a,B as g,T as j,w as H,x as E,a as L,A as F,C as N,b as U,I as W,be as O}from"./index-DNdAKB9f.js";import{t as J}from"./ticketApi-DZP3lA1o.js";import{T as V,a as Y,b as q,c as y,d as t,e as G}from"./TableRow-2FuGKbnY.js";import{C as K}from"./Chip-B8lB6W_F.js";import{T as Q}from"./TablePagination-CykxsR0-.js";import"./LastPage-v7sA_Lnn.js";function te(){const{t:o}=A(),[c,w]=s.useState([]),[T,p]=s.useState(!1),[d,m]=s.useState(1),[u,S]=s.useState(10),[C,P]=s.useState(0),[i,f]=s.useState(!1),n=M(),h=s.useCallback(async()=>{try{const e=await D.getCurrentUser();f(e?.role==="admin"),e?.role!=="admin"&&n("/my-tickets")}catch(e){console.error("加载用户信息失败:",e);const r=localStorage.getItem("user");if(r){const l=JSON.parse(r);f(l?.role==="admin"),l?.role!=="admin"&&n("/my-tickets")}else n("/my-tickets")}},[n]),x=s.useCallback(async()=>{if(i)try{p(!0);const e={page:d,page_size:u,exclude_status:"draft"},r=await J.list(e);r.data.code===0&&(w(r.data.data||[]),P(r.data.total||0))}catch(e){console.error("加载工单失败:",e)}finally{p(!1)}},[i,d,u]);s.useEffect(()=>{h()},[h]),s.useEffect(()=>{i&&x()},[i,x]);const v=e=>{S(Number(e.target.value)),m(1)},b=e=>{if(e.status==="draft")return{label:"草稿",color:"default"};if(e.status==="cancelled"||e.status==="void")return{label:"已作废",color:"default"};if(e.approval_status)switch(e.approval_status){case"pending":return{label:"审批中",color:"info"};case"rejected":return{label:"审批失败",color:"error"};case"canceled":return{label:"已取消",color:"default"};case"expired":return{label:"已过期",color:"warning"}}if(e.status==="rejected")return{label:"已拒绝",color:"error"};if(e.status==="approved"||e.approval_status==="approved"){if(e.deployment_id)switch(e.deployment_status){case"pending":return{label:"待发布",color:"warning"};case"running":return{label:"发布中",color:"info"};case"success":return{label:"发布成功",color:"success"};case"failed":return{label:"发布失败",color:"error"};case"cancelled":return{label:"发布已取消",color:"default"};default:return{label:"待发布",color:"warning"}}return{label:"待发布",color:"warning"}}return e.status==="submitted"&&(e.approval_status==="pending"||!e.approval_status)?{label:"审批中",color:"info"}:{label:{draft:"草稿",submitted:"审批中",approved:"待发布",rejected:"已拒绝",cancelled:"已作废",void:"已作废"}[e.status]||e.status,color:"default"}},I=e=>{const r=new Date(e),l=r.getFullYear(),_=r.getMonth()+1,z=r.getDate(),$=String(r.getHours()).padStart(2,"0"),B=String(r.getMinutes()).padStart(2,"0"),R=String(r.getSeconds()).padStart(2,"0");return`${l}-${_}-${z} ${$}:${B}:${R}`};return i?a.jsxs(g,{sx:{p:3},children:[a.jsx(j,{variant:"h4",gutterBottom:!0,children:"全部工单"}),a.jsx(H,{sx:{mt:3},children:a.jsxs(E,{children:[a.jsxs(g,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[a.jsx(j,{variant:"h6",children:"全部工单"}),a.jsx(L,{variant:"contained",startIcon:a.jsx(F,{}),onClick:()=>n("/create-ticket"),children:"新建工单"})]}),T?a.jsx(g,{sx:{display:"flex",justifyContent:"center",p:3},children:a.jsx(N,{})}):a.jsxs(a.Fragment,{children:[c.length===0&&a.jsx(U,{severity:"info",children:"暂无工单"}),c.length>0&&a.jsxs(a.Fragment,{children:[a.jsx(V,{children:a.jsxs(Y,{children:[a.jsx(q,{children:a.jsxs(y,{children:[a.jsx(t,{children:"工单编号"}),a.jsx(t,{children:"标题"}),a.jsx(t,{children:"申请人"}),a.jsx(t,{children:"状态"}),a.jsx(t,{children:"优先级"}),a.jsx(t,{children:"创建时间"}),a.jsx(t,{align:"right",children:"操作"})]})}),a.jsx(G,{children:c.map(e=>a.jsxs(y,{children:[a.jsx(t,{children:e.ticket_number}),a.jsx(t,{children:e.title}),a.jsx(t,{children:e.applicant_username||e.applicant_name||"-"}),a.jsx(t,{children:a.jsx(K,{label:b(e).label,color:b(e).color,size:"small"})}),a.jsx(t,{children:e.priority==="low"?o("workorder.priority.low","低"):e.priority==="normal"?o("workorder.priority.normal","普通"):e.priority==="high"?o("workorder.priority.high","高"):e.priority==="urgent"?o("workorder.priority.urgent","紧急"):e.priority||o("workorder.priority.normal","普通")}),a.jsx(t,{children:I(e.created_at)}),a.jsx(t,{align:"right",children:a.jsx(W,{size:"small",onClick:()=>n(`/ticket/${e.id}`,{state:{from:"/all-tickets"}}),children:a.jsx(O,{fontSize:"small"})})})]},e.id))})]})}),a.jsx(Q,{component:"div",count:C,page:d-1,onPageChange:(e,r)=>m(r+1),rowsPerPage:u,onRowsPerPageChange:v,rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:"每页显示:",labelDisplayedRows:({from:e,to:r,count:l})=>`${e}-${r} 共 ${l} 条`,sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]})]})]})})]}):null}export{te as default};
