import{u as G,r as n,j as e,B as u,w as Q,x as X,T as x,a as p,v as Y,A as J,P as M,d as W,I as w,g as Z,h as ee,i as te,k as se,l as ae,m as j,a3 as ie,a4 as H,b as le,cz as ne,cO as re,p as oe,bf as D,a7 as F}from"./index-DNdAKB9f.js";import{a as f}from"./alertApi-DA6IzLde.js";import{S as g}from"./Stack-6rKlDBQM.js";import{T as ce,a as de,b as ue,c as y,d as r,e as he}from"./TableRow-2FuGKbnY.js";import{P as xe}from"./Pagination-LCTmwsmm.js";import"./LastPage-v7sA_Lnn.js";function ve(){const{t}=G(),[I,k]=n.useState([]),[A,z]=n.useState(!1),[$,N]=n.useState(!1),[v,C]=n.useState(null),[b,K]=n.useState(1),[S]=n.useState(10),[O,L]=n.useState(0),[E,P]=n.useState("visual"),[o,c]=n.useState({restrain_type:"",fields:{},cumulative_time:300}),[h,d]=n.useState([]),T=s=>{d(s);const a={};s.forEach(({key:i,value:l})=>{i&&l&&(a[i]=l)}),c(i=>({...i,fields:a}))},m=n.useCallback(async()=>{try{z(!0);const s={page:b,page_size:S},a=await f.getRestrains(s);(a.data.code===0||a.data.code===200)&&(k(a.data.data||[]),L(a.data.total||0))}catch(s){console.error("获取告警抑制失败:",s),k([])}finally{z(!1)}},[b,S]);n.useEffect(()=>{m()},[m]);const B=s=>{if(s){C(s),c({restrain_type:s.restrain_type,fields:s.fields||{},cumulative_time:s.cumulative_time});const a=s.fields||{};if(typeof a=="object"&&a!==null){const i=Object.entries(a).map(([l,R])=>({key:l,value:String(R)}));d(i)}else d([])}else C(null),c({restrain_type:"",fields:{},cumulative_time:300}),d([]);P("visual"),N(!0)},_=()=>{N(!1),C(null)},V=async()=>{if(!o.restrain_type){D(t("Please fill in restrain type"));return}try{v?(await f.updateRestrain(v.id,o),F(t("Update successful"))):(await f.createRestrain(o),F(t("Create successful"))),_(),m()}catch(s){console.error("保存失败:",s),D(t("common.error")||"操作失败")}},q=async s=>{if(confirm(t("Are you sure you want to delete this restrain?")))try{await f.deleteRestrain(s),F(t("Delete successful")),m()}catch(a){console.error("删除失败:",a),D(t("common.error")||"删除失败")}};return e.jsxs(u,{sx:{p:3},children:[e.jsx(Q,{children:e.jsxs(X,{children:[e.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsx(x,{variant:"h5",gutterBottom:!0,children:t("menu.monitorRestrainRule")}),e.jsxs(g,{direction:"row",spacing:2,children:[e.jsx(p,{variant:"outlined",startIcon:e.jsx(Y,{}),onClick:m,disabled:A,children:t("common.refresh")}),e.jsx(p,{variant:"contained",startIcon:e.jsx(J,{}),onClick:()=>B(),children:t("Create Restrain")})]})]}),e.jsx(ce,{component:M,children:e.jsxs(de,{children:[e.jsx(ue,{children:e.jsxs(y,{children:[e.jsx(r,{children:t("Restrain Type")}),e.jsx(r,{children:t("Cumulative Time")}),e.jsx(r,{children:t("Fields")}),e.jsx(r,{children:t("Created At")}),e.jsx(r,{align:"right",children:t("common.actions")})]})}),e.jsx(he,{children:A?e.jsx(y,{children:e.jsx(r,{colSpan:5,align:"center",children:t("common.loading")})}):I.length===0?e.jsx(y,{children:e.jsx(r,{colSpan:5,align:"center",children:t("common.noData")})}):I.map(s=>e.jsxs(y,{children:[e.jsx(r,{children:s.restrain_type}),e.jsxs(r,{children:[s.cumulative_time,"s"]}),e.jsx(r,{children:e.jsx(x,{variant:"body2",sx:{maxWidth:200,overflow:"hidden",textOverflow:"ellipsis"},children:JSON.stringify(s.fields||{})})}),e.jsx(r,{children:(()=>{const a=s.createdAt||s.created_at;if(!a)return"-";try{const i=new Date(a);return isNaN(i.getTime())?"-":i.toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"})}catch{return"-"}})()}),e.jsx(r,{align:"right",children:e.jsxs(g,{direction:"row",spacing:1,justifyContent:"flex-end",children:[e.jsx(W,{title:t("common.edit"),children:e.jsx(w,{size:"small",onClick:()=>B(s),children:e.jsx(Z,{fontSize:"small"})})}),e.jsx(W,{title:t("common.delete"),children:e.jsx(w,{size:"small",color:"error",onClick:()=>q(s.id),children:e.jsx(ee,{fontSize:"small"})})})]})})]},s.id))})]})}),O>0&&e.jsx(u,{sx:{display:"flex",justifyContent:"center",mt:2},children:e.jsx(xe,{count:Math.ceil(O/S),page:b,onChange:(s,a)=>K(a),color:"primary"})})]})}),e.jsxs(te,{open:$,onClose:_,maxWidth:"md",fullWidth:!0,children:[e.jsx(se,{children:t(v?"Edit Restrain":"Create Restrain")}),e.jsx(ae,{children:e.jsxs(g,{spacing:3,sx:{mt:1},children:[e.jsx(j,{label:`${t("Restrain Type")} *`,value:o.restrain_type,onChange:s=>c({...o,restrain_type:s.target.value}),fullWidth:!0,required:!0,helperText:t("Restrain type description")}),e.jsx(j,{label:`${t("Cumulative Time")} (${t("seconds")})`,type:"number",value:o.cumulative_time,onChange:s=>c({...o,cumulative_time:parseInt(s.target.value)||0}),fullWidth:!0,helperText:t("Cumulative time for restrain")}),e.jsxs(u,{children:[e.jsxs(u,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[e.jsx(x,{variant:"subtitle2",children:t("Match Fields")}),e.jsxs(ie,{value:E,onChange:(s,a)=>{if(P(a),a==="visual"){const i=o.fields||{};if(typeof i=="object"&&i!==null){const l=Object.entries(i).map(([R,U])=>({key:R,value:String(U)}));d(l)}else d([])}},sx:{minHeight:"auto"},children:[e.jsx(H,{label:t("Visual"),value:"visual",sx:{minHeight:"auto",py:.5,px:1}}),e.jsx(H,{label:"JSON",value:"json",sx:{minHeight:"auto",py:.5,px:1}})]})]}),E==="visual"?e.jsxs(u,{children:[e.jsxs(le,{severity:"info",icon:e.jsx(ne,{}),sx:{mb:2},children:[e.jsx(x,{variant:"body2",children:t("Restrain Fields Description")}),e.jsxs(x,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:t("Special Keys")}),e.jsx("code",{children:"alertname"})," ",t("common.or")," ",e.jsx("code",{children:"__alertname__"})," ",t("restrain.alertnameDescription"),", ",t("restrain.otherKeysDescription"),"."]})]}),e.jsxs(g,{spacing:2,children:[h.map((s,a)=>e.jsx(M,{sx:{p:2,bgcolor:"grey.50"},children:e.jsxs(u,{sx:{display:"flex",gap:2,alignItems:"center"},children:[e.jsx(j,{label:t("Field Name"),size:"small",value:s.key,onChange:i=>{const l=[...h];l[a]={...l[a],key:i.target.value},T(l)},placeholder:t("restrain.fieldNamePlaceholder"),sx:{flex:1},helperText:s.key==="alertname"||s.key==="__alertname__"?t("Matches alert title"):t("Matches alert tag")}),e.jsx(j,{label:t("Field Value"),size:"small",value:s.value,onChange:i=>{const l=[...h];l[a]={...l[a],value:i.target.value},T(l)},placeholder:t("restrain.fieldValuePlaceholder"),sx:{flex:1},helperText:t("Field value description")}),e.jsx(w,{color:"error",size:"small",onClick:()=>{const i=[...h];i.splice(a,1),T(i)},children:e.jsx(re,{})})]})},a)),e.jsx(p,{size:"small",startIcon:e.jsx(J,{}),onClick:()=>{const s=[...h,{key:"",value:""}];d(s);const a={};s.forEach(({key:i,value:l})=>{i&&l&&(a[i]=l)}),c(i=>({...i,fields:a}))},variant:"outlined",children:t("Add Field")}),h.length===0&&e.jsx(x,{variant:"body2",color:"text.secondary",sx:{textAlign:"center",py:2},children:t('No fields configured. Click "Add Field" to add matching fields.')})]})]}):e.jsx(j,{label:t("Fields (JSON)"),value:JSON.stringify(o.fields||{},null,2),onChange:s=>{try{const a=JSON.parse(s.target.value);c({...o,fields:a})}catch{}},fullWidth:!0,multiline:!0,rows:6,helperText:t("Fields configuration in JSON format")})]})]})}),e.jsxs(oe,{children:[e.jsx(p,{onClick:_,children:t("common.cancel")}),e.jsx(p,{onClick:V,variant:"contained",children:t("common.save")})]})]})]})}export{ve as default};
