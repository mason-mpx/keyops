import{r as n,df as H,bf as S,j as e,i as ee,k as te,l as ae,B as P,C as L,b as $,F as se,n as re,o as le,M as ne,m as oe,T as z,p as ie,a as Y,a7 as ce,ax as de,b3 as pe,w as ue,x as fe,A as ge,I as G,de as he,be as me}from"./index-wVs8DYHr.js";import{t as ye}from"./ticketApi-COBMGD8s.js";import{S as xe}from"./Stack-CNnEoVHt.js";import{T as ve,a as je,b as be,c as Q,d,e as Ce}from"./TableRow-17IyVPm2.js";import{C as X}from"./Chip-DzNpApxT.js";import{T as _e}from"./TablePagination-l3CyI5hc.js";import"./LastPage-Bx6x4Acm.js";function Se({open:j,ticket:p,onClose:D,onSuccess:M}){const[m,b]=n.useState(!1),[h,N]=n.useState([]),[y,U]=n.useState(""),[u,T]=n.useState(""),[o,I]=n.useState(null),[C,x]=n.useState([]),[O,B]=n.useState(!1);n.useEffect(()=>{j&&J()},[j]),n.useEffect(()=>{if(y&&h.length>0){const a=h.find(l=>l.id===y);if(I(a||null),a){let l="";if(p?.template?.approval_config)try{l=(typeof p.template.approval_config=="string"?JSON.parse(p.template.approval_config):p.template.approval_config).approval_code||""}catch(t){console.error("解析工单模板审批配置失败:",t)}l||(l=a.approval_code||a.process_code||a.template_id||""),T(l),x([])}}else I(null),T(""),x([])},[y,h,p]);const w=n.useCallback(async()=>{if(!(!o||!u.trim()))try{B(!0);const a=await H.getApprovalFormDetail({approval_config_id:o.id,approval_code:u,platform:o.type});x(a.form_fields||[])}catch(a){console.error("获取表单详情失败:",a),x([])}finally{B(!1)}},[o,u]);n.useEffect(()=>{o&&u.trim()&&o.type==="feishu"?w():x([])},[u,o,w]);const J=async()=>{try{b(!0);const l=((await H.getApprovalConfig()).configs||[]).filter(t=>t.enabled);N(l)}catch(a){console.error("加载审批配置失败:",a),S("加载审批配置失败")}finally{b(!1)}},E=async()=>{if(!p){S("工单信息不存在");return}if(!o){S("请选择审批配置");return}if(!u.trim()){S("请输入审批代码");return}try{b(!0);let a=null;if(p.template?.approval_config)try{a=typeof p.template.approval_config=="string"?JSON.parse(p.template.approval_config):p.template.approval_config}catch(r){console.error("解析工单模板审批配置失败:",r)}let l=[];if(C.length>0)a?.field_mappings&&a.field_mappings.length>0?l=C.map(r=>{const c=r.name||"",i=a?.field_mappings?.find(_=>_.fieldName===c);return i?{...r,keyword:i.keyword}:null}).filter(r=>r!=null&&r.keyword!==void 0):l=C.map(r=>({...r,keyword:r.name||""}));else try{l=JSON.parse(o.form_fields||"[]")}catch(r){console.error("表单字段映射配置格式错误:",r),S("表单字段映射配置格式错误");return}if(l.length===0){S("没有可用的表单字段映射，请先在工单模板中配置字段映射");return}const t=K(p.form_data||{},l,p);await H.createThirdPartyApproval({ticket_id:p.id,approval_config_id:o.id,approval_code:u,platform:o.type,form_data:t})&&(ce("三方审批提交成功"),D(),M?.())}catch(a){console.error("提交三方审批失败:",a);const l=a?.response?.data?.message||"提交三方审批失败";S(l)}finally{b(!1)}},K=(a,l,t)=>{const s=[];for(const r of l){const c=r.name||"",i=r.type||"",_=r.id||"",V=r.keyword||"";if(!_||!i)continue;const f=V||c;let g="";if(f)if(f.includes("工单编号")||f.includes("ticket_number"))g=t.ticket_number||"";else if(f.includes("工单标题")||f.includes("title")||f.includes("标题"))g=t.title||"";else if(f.includes("工单链接")||f.includes("ticket_url")||f.includes("链接"))g=`${window.location.origin}/ticket/${t.id}`;else{const v=R(a,f);v!=null?g=v:r.default_value!==void 0&&(g=r.default_value)}if(r.option&&Array.isArray(r.option)&&typeof g=="string"){const v=r.option.find(F=>F.text===g||F.label===g);v&&(g=v.value)}if(i==="ARRAY"&&r.children){const v=Array.isArray(g)?g:[],F=[];for(const Z of v){const q=[];for(const A of r.children){const k=A.keyword||"",W=R(Z,k);A.id&&A.type&&q.push({id:A.id,type:A.type,value:W??(A.default_value||"")})}F.push(q)}s.push({id:_,type:i,value:F})}else s.push({id:_,type:i,value:g||""})}return s},R=(a,l)=>{if(!a||!l)return;if(a[l]!==void 0)return a[l];const t=l.split(".");let s=a;for(const r of t){if(s==null)return;if(/^\d+$/.test(r))if(Array.isArray(s)){const c=s[parseInt(r)],i=c&&typeof c=="object"?c:void 0;if(!i)return;s=i}else if(s&&typeof s=="object"){const c=s[r],i=c&&typeof c=="object"?c:void 0;if(!i)return;s=i}else return;else if(s&&typeof s=="object"&&!Array.isArray(s)){const c=s[r],i=c&&typeof c=="object"?c:void 0;if(!i)return;s=i}else return}return s};return e.jsxs(ee,{open:j,onClose:D,maxWidth:"md",fullWidth:!0,children:[e.jsx(te,{children:"提交三方审批"}),e.jsx(ae,{children:e.jsx(xe,{spacing:3,sx:{mt:1},children:m&&h.length===0?e.jsx(P,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(L,{})}):h.length===0?e.jsx($,{severity:"warning",children:"暂无启用的审批配置，请先在工单配置中添加审批配置"}):e.jsxs(e.Fragment,{children:[e.jsxs(se,{fullWidth:!0,children:[e.jsx(re,{children:"选择审批配置"}),e.jsx(le,{value:y,label:"选择审批配置",onChange:a=>U(a.target.value),children:h.map(a=>e.jsxs(ne,{value:a.id,children:[a.name," (",a.type==="feishu"?"飞书":a.type==="dingtalk"?"钉钉":"企业微信",")"]},a.id))})]}),o&&e.jsxs(e.Fragment,{children:[e.jsx(oe,{fullWidth:!0,label:o.type==="feishu"?"审批代码 (Approval Code)":o.type==="dingtalk"?"流程代码 (Process Code)":"模板ID (Template ID)",value:u,onChange:a=>T(a.target.value),required:!0,helperText:o.type==="feishu"?"飞书审批定义的唯一标识（输入后会自动获取表单字段）":o.type==="dingtalk"?"钉钉审批流程的唯一标识":"企业微信审批模板的唯一标识",InputProps:{endAdornment:O?e.jsx(L,{size:20}):null}}),C.length>0?e.jsx($,{severity:"success",children:e.jsxs(z,{variant:"body2",children:["已自动获取到 ",C.length," 个表单字段。系统将通过字段名称自动匹配工单数据，无需手动配置 widget ID。"]})}):o.type==="feishu"&&u.trim()?e.jsx($,{severity:"warning",children:e.jsx(z,{variant:"body2",children:"正在获取表单字段详情...（如果获取失败，将使用审批配置中的表单字段映射）"})}):e.jsx($,{severity:"info",children:e.jsx(z,{variant:"body2",children:o.type==="feishu"?"输入审批代码后，系统会自动获取表单字段详情，通过字段名称匹配工单数据。":"表单字段将通过审批配置中的关键字自动匹配工单数据。请确保审批配置中的表单字段映射已正确配置关键字。"})})]})]})})}),e.jsxs(ie,{children:[e.jsx(Y,{onClick:D,children:"取消"}),e.jsx(Y,{variant:"contained",onClick:E,disabled:m||!o||!u.trim(),children:m?e.jsx(L,{size:20}):"提交"})]})]})}function $e(){const[j,p]=n.useState([]),[D,M]=n.useState(!1),[m,b]=n.useState(null),[h,N]=n.useState(1),[y,U]=n.useState(10),[u,T]=n.useState(0),[o,I]=n.useState(!1),[C,x]=n.useState(null),O=de();n.useEffect(()=>{B()},[]);const B=async()=>{try{const t=await pe.getCurrentUser();b(t)}catch(t){console.error("加载用户信息失败:",t);const s=localStorage.getItem("user");if(s){const r=JSON.parse(s);b(r)}}},w=n.useCallback(async()=>{try{M(!0);const t={page:h,page_size:y};if(m?.id)t.applicant_id=m.id;else{console.warn("无法获取当前用户ID，无法查询我的工单");return}t.exclude_status="draft";const s=await ye.list(t);s.data.code===0&&(p(s.data.data||[]),T(s.data.total||0))}catch(t){console.error("加载工单失败:",t)}finally{M(!1)}},[m,h,y]);n.useEffect(()=>{m&&w()},[m,w]);const J=t=>{U(Number(t.target.value)),N(1)},E=t=>{if(t.status==="draft")return{label:"草稿",color:"default"};if(t.status==="cancelled"||t.status==="void")return{label:"已作废",color:"default"};if(t.approval_status)switch(t.approval_status){case"pending":return{label:"审批中",color:"info"};case"rejected":return{label:"审批失败",color:"error"};case"canceled":return{label:"已取消",color:"default"};case"expired":return{label:"已过期",color:"warning"}}if(t.status==="rejected")return{label:"已拒绝",color:"error"};if(t.status==="approved"||t.approval_status==="approved"){if(t.deployment_id)switch(t.deployment_status){case"pending":return{label:"待发布",color:"warning"};case"running":return{label:"发布中",color:"info"};case"success":return{label:"发布成功",color:"success"};case"failed":return{label:"发布失败",color:"error"};case"cancelled":return{label:"发布已取消",color:"default"};default:return{label:"待发布",color:"warning"}}return{label:"待发布",color:"warning"}}return t.status==="submitted"&&(t.approval_status==="pending"||!t.approval_status)?{label:"审批中",color:"info"}:{label:{draft:"草稿",submitted:"审批中",approved:"待发布",rejected:"已拒绝",cancelled:"已作废",void:"已作废"}[t.status]||t.status,color:"default"}},K=t=>{const s=new Date(t),r=s.getFullYear(),c=s.getMonth()+1,i=s.getDate(),_=String(s.getHours()).padStart(2,"0"),V=String(s.getMinutes()).padStart(2,"0"),f=String(s.getSeconds()).padStart(2,"0");return`${r}-${c}-${i} ${_}:${V}:${f}`},R=t=>{x(t),I(!0)},a=()=>{I(!1),x(null)},l=()=>{w()};return e.jsxs(P,{sx:{p:3},children:[e.jsx(z,{variant:"h4",gutterBottom:!0,children:"我的工单"}),e.jsx(ue,{sx:{mt:3},children:e.jsxs(fe,{children:[e.jsxs(P,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(z,{variant:"h6",children:"我的工单"}),e.jsx(Y,{variant:"contained",startIcon:e.jsx(ge,{}),onClick:()=>O("/create-ticket"),children:"新建工单"})]}),D?e.jsx(P,{sx:{display:"flex",justifyContent:"center",p:3},children:e.jsx(L,{})}):e.jsxs(e.Fragment,{children:[j.length===0&&e.jsx($,{severity:"info",children:"暂无我的工单"}),j.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(ve,{children:e.jsxs(je,{children:[e.jsx(be,{children:e.jsxs(Q,{children:[e.jsx(d,{children:"工单编号"}),e.jsx(d,{children:"工单类型"}),e.jsx(d,{children:"标题"}),e.jsx(d,{children:"状态"}),e.jsx(d,{children:"优先级"}),e.jsx(d,{children:"创建时间"}),e.jsx(d,{align:"center",children:"三方审批"}),e.jsx(d,{align:"right",children:"操作"})]})}),e.jsx(Ce,{children:j.map(t=>e.jsxs(Q,{children:[e.jsx(d,{children:t.ticket_number}),e.jsx(d,{children:e.jsx(X,{label:t.type==="deployment"?"发布工单":"日常工单",color:t.type==="deployment"?"primary":"default",size:"small",variant:"outlined"})}),e.jsx(d,{children:t.title}),e.jsx(d,{children:e.jsx(X,{label:E(t).label,color:E(t).color,size:"small"})}),e.jsx(d,{children:t.priority}),e.jsx(d,{children:K(t.created_at)}),e.jsx(d,{align:"center",children:e.jsx(G,{size:"small",color:"primary",onClick:()=>R(t),disabled:t.status!=="submitted"&&t.status!=="approved",children:e.jsx(he,{fontSize:"small"})})}),e.jsx(d,{align:"right",children:e.jsx(G,{size:"small",onClick:()=>O(`/ticket/${t.id}`,{state:{from:"/my-tickets"}}),children:e.jsx(me,{fontSize:"small"})})})]},t.id))})]})}),e.jsx(P,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:2},children:e.jsx(_e,{component:"div",count:u,page:h-1,onPageChange:(t,s)=>N(s+1),rowsPerPage:y,onRowsPerPageChange:J,rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:"每页显示:",labelDisplayedRows:({from:t,to:s,count:r})=>`${t}-${s} 共 ${r} 条`})})]})]})]})}),e.jsx(Se,{open:o,ticket:C,onClose:a,onSuccess:l})]})}export{$e as default};
