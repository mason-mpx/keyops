import{ax as ne,r as i,c3 as le,b4 as ae,br as w,bf as A,j as s,B as h,P as ie,T as oe,d as P,I as E,v as ce,a as C,A as de,m as d,s as ue,t as he,M as o,b as pe,C as S,be as xe,h as ge,i as fe,k as me,l as je,_ as ve,p as Ce,a7 as k}from"./index-wVs8DYHr.js";import{T as ye,a as be,b as Oe,c as D,d as c,e as we}from"./TableRow-17IyVPm2.js";import{C as N}from"./Chip-DzNpApxT.js";import{T as Ae}from"./TablePagination-l3CyI5hc.js";import{A as j}from"./Autocomplete-B1PHB6qe.js";import{S as Se}from"./Switch-DnfqMs2v.js";import"./LastPage-Bx6x4Acm.js";function De(){const H=ne(),[B,V]=i.useState([]),[$,J]=i.useState([]),[M,U]=i.useState(!1),[T,y]=i.useState(!1),[_,Q]=i.useState("create"),[X,Y]=i.useState({}),[L,I]=i.useState(""),[z,b]=i.useState(0),[W,Z]=i.useState(10),[a,O]=i.useState({name:"",org:"",department:"",status:"",srvType:"",virtualTech:"",site:"",isCritical:void 0}),[r,u]=i.useState({org:"",lineOfBiz:"",name:"",isCritical:!1,srvType:"WEB",virtualTech:"",status:"Initializing",site:"",department:"",description:"",onlineAt:"",offlineAt:"",gitUrl:"",opsOwners:[],testOwners:[],devOwners:[]}),[x,F]=i.useState([]),[g,R]=i.useState(!1),q=i.useCallback(async()=>{try{const e=await le.getOrganizationTree();J(Array.isArray(e)?e:[])}catch(e){console.error("加载组织列表失败:",e)}},[]),G=e=>{let t=[];return e.forEach(n=>{t.push(n),n.children&&n.children.length>0&&(t=t.concat(G(n.children)))}),t},p=i.useCallback(async(e="")=>{try{R(!0);const t=await ae.getUsersWithRoles({page:1,pageSize:10,keyword:e||void 0});F(t.users||[])}catch(t){console.error("加载用户列表失败:",t),F([])}finally{R(!1)}},[]),f=i.useCallback(async()=>{U(!0),I("");try{const e={};a.name&&(e.name=a.name),a.org&&(e.org=a.org),a.department&&(e.department=a.department),a.status&&(e.status=a.status),a.srvType&&(e.srvType=a.srvType),a.virtualTech&&(e.virtualTech=a.virtualTech),a.site&&(e.site=a.site),a.isCritical!==void 0&&(e.isCritical=a.isCritical);const t=await w.getApplications(e);V(Array.isArray(t)?t:[])}catch(e){const t=e,n=t?.response?.data?.message||t?.message||"加载应用列表失败";I(n),A(n)}finally{U(!1)}},[a]);i.useEffect(()=>{q()},[q]),i.useEffect(()=>{f()},[f]),i.useEffect(()=>{T&&p()},[T,p]);const ee=()=>{Q("create"),Y({}),u({org:"",lineOfBiz:"",name:"",isCritical:!1,srvType:"WEB",virtualTech:"",status:"Initializing",site:"",department:"",description:"",onlineAt:"",offlineAt:"",gitUrl:"",opsOwners:[],testOwners:[],devOwners:[]}),y(!0)},se=async e=>{if(window.confirm("确定要删除该应用吗？删除后无法恢复。"))try{await w.deleteApplication(e),k("删除成功"),f()}catch(t){const n=t,l=n?.response?.data?.message||n?.message||"删除失败";A(l)}},te=async()=>{if(!r.name.trim()){A("请输入应用名称");return}try{const e=n=>{if(!(!n||n.trim()===""))try{const l=new Date(n);return isNaN(l.getTime())?void 0:l.toISOString()}catch{return}},t={org:r.org||void 0,lineOfBiz:r.lineOfBiz||void 0,name:r.name,isCritical:r.isCritical,srvType:r.srvType,virtualTech:r.virtualTech||void 0,status:r.status,site:r.site||void 0,department:r.department||void 0,description:r.description||void 0,onlineAt:e(r.onlineAt),offlineAt:e(r.offlineAt),gitUrl:r.gitUrl||void 0,opsOwners:r.opsOwners.length>0?r.opsOwners:void 0,testOwners:r.testOwners.length>0?r.testOwners:void 0,devOwners:r.devOwners.length>0?r.devOwners:void 0};_==="create"?(await w.createApplication(t),k("创建成功")):(await w.updateApplication(X.id,t),k("更新成功")),y(!1),f()}catch(e){const t=e,n=t?.response?.data?.message||t?.message||"保存失败";A(n)}},re=e=>{switch(e){case"Running":return"success";case"Stopped":return"error";case"Initializing":return"warning";default:return"info"}},m=G($),K=B.slice(z*W,(z+1)*W);return s.jsx(h,{children:s.jsxs(ie,{sx:{p:3},children:[s.jsxs(h,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[s.jsx(oe,{variant:"h5",children:"服务管理"}),s.jsxs(h,{children:[s.jsx(P,{title:"刷新",children:s.jsx(E,{onClick:f,disabled:M,children:s.jsx(ce,{})})}),s.jsx(C,{variant:"contained",startIcon:s.jsx(de,{}),onClick:ee,sx:{ml:1},children:"新建应用"})]})]}),s.jsxs(h,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap"},children:[s.jsx(d,{size:"small",placeholder:"搜索应用名称",value:a.name,onChange:e=>O({...a,name:e.target.value}),InputProps:{startAdornment:s.jsx(ue,{position:"start",children:s.jsx(he,{})})},sx:{minWidth:200}}),s.jsxs(d,{size:"small",select:!0,label:"状态",value:a.status,onChange:e=>O({...a,status:e.target.value}),sx:{minWidth:120},children:[s.jsx(o,{value:"",children:"全部"}),s.jsx(o,{value:"Running",children:"运行中"}),s.jsx(o,{value:"Stopped",children:"已停止"}),s.jsx(o,{value:"Initializing",children:"初始化中"})]}),s.jsxs(d,{size:"small",select:!0,label:"应用类型",value:a.srvType,onChange:e=>O({...a,srvType:e.target.value}),sx:{minWidth:120},children:[s.jsx(o,{value:"",children:"全部"}),s.jsx(o,{value:"Server",children:"Server"}),s.jsx(o,{value:"WEB",children:"WEB"}),s.jsx(o,{value:"Middleware",children:"Middleware"}),s.jsx(o,{value:"DataWare",children:"DataWare"})]}),s.jsx(C,{variant:"outlined",onClick:()=>{b(0),f()},children:"搜索"}),s.jsx(C,{variant:"outlined",onClick:()=>{O({name:"",org:"",department:"",status:"",srvType:"",virtualTech:"",site:"",isCritical:void 0}),b(0)},children:"重置"})]}),L&&s.jsx(pe,{severity:"error",sx:{mb:2},onClose:()=>I(""),children:L}),M?s.jsx(h,{sx:{display:"flex",justifyContent:"center",p:4},children:s.jsx(S,{})}):s.jsxs(s.Fragment,{children:[s.jsx(ye,{children:s.jsxs(be,{children:[s.jsx(Oe,{children:s.jsxs(D,{children:[s.jsx(c,{children:"应用名称"}),s.jsx(c,{children:"事业部"}),s.jsx(c,{children:"部门"}),s.jsx(c,{children:"站点"}),s.jsx(c,{children:"应用类型"}),s.jsx(c,{children:"虚拟化技术"}),s.jsx(c,{children:"状态"}),s.jsx(c,{children:"是否核心"}),s.jsx(c,{children:"上线时间"}),s.jsx(c,{children:"操作"})]})}),s.jsx(we,{children:K.length===0?s.jsx(D,{children:s.jsx(c,{colSpan:10,align:"center",children:"暂无数据"})}):K.map(e=>s.jsxs(D,{children:[s.jsx(c,{children:e.name}),s.jsx(c,{children:e.org||"-"}),s.jsx(c,{children:e.department||"-"}),s.jsx(c,{children:e.site||"-"}),s.jsx(c,{children:e.srvType}),s.jsx(c,{children:e.virtualTech||"-"}),s.jsx(c,{children:s.jsx(N,{label:e.status,color:re(e.status),size:"small"})}),s.jsx(c,{children:e.isCritical?s.jsx(N,{label:"是",color:"error",size:"small"}):s.jsx(N,{label:"否",size:"small"})}),s.jsx(c,{children:e.onlineAt?new Date(e.onlineAt).toLocaleString("zh-CN"):"-"}),s.jsx(c,{children:s.jsxs(h,{sx:{display:"flex",gap:.5},children:[s.jsx(P,{title:"详情",children:s.jsx(E,{size:"small",onClick:()=>H(`/services/${e.id}`),color:"primary",children:s.jsx(xe,{fontSize:"small"})})}),s.jsx(P,{title:"删除",children:s.jsx(E,{size:"small",color:"error",onClick:()=>se(e.id),children:s.jsx(ge,{fontSize:"small"})})})]})})]},e.id))})]})}),s.jsx(Ae,{component:"div",count:B.length,page:z,onPageChange:(e,t)=>b(t),rowsPerPage:W,onRowsPerPageChange:e=>{Z(parseInt(e.target.value,10)),b(0)},rowsPerPageOptions:[10,25,50,100]})]}),s.jsxs(fe,{open:T,onClose:()=>y(!1),maxWidth:"md",fullWidth:!0,children:[s.jsx(me,{children:_==="create"?"新建应用":"编辑应用"}),s.jsx(je,{children:s.jsxs(h,{sx:{pt:2,display:"flex",flexDirection:"column",gap:2},children:[s.jsxs(h,{sx:{display:"flex",gap:2},children:[s.jsx(d,{fullWidth:!0,label:"应用名称",value:r.name,onChange:e=>u({...r,name:e.target.value}),required:!0}),s.jsxs(d,{fullWidth:!0,label:"应用状态",select:!0,value:r.status,onChange:e=>u({...r,status:e.target.value}),required:!0,children:[s.jsx(o,{value:"Initializing",children:"初始化中"}),s.jsx(o,{value:"Running",children:"运行中"}),s.jsx(o,{value:"Stopped",children:"已停止"})]})]}),s.jsxs(h,{sx:{display:"flex",gap:2},children:[s.jsx(j,{fullWidth:!0,options:m,getOptionLabel:e=>e.unitName,value:m.find(e=>e.unitCode===r.org)||null,onChange:(e,t)=>u({...r,org:t?.unitCode||""}),renderInput:e=>s.jsx(d,{...e,label:"事业部"})}),s.jsx(j,{fullWidth:!0,options:m,getOptionLabel:e=>e.unitName,value:m.find(e=>e.unitCode===r.lineOfBiz)||null,onChange:(e,t)=>u({...r,lineOfBiz:t?.unitCode||""}),renderInput:e=>s.jsx(d,{...e,label:"业务线"})})]}),s.jsxs(h,{sx:{display:"flex",gap:2},children:[s.jsx(j,{fullWidth:!0,options:m,getOptionLabel:e=>e.unitName,value:m.find(e=>e.unitCode===r.department)||null,onChange:(e,t)=>u({...r,department:t?.unitCode||""}),renderInput:e=>s.jsx(d,{...e,label:"部门"})}),s.jsx(d,{fullWidth:!0,label:"应用站点",value:r.site,onChange:e=>u({...r,site:e.target.value}),placeholder:"例如：大陆、香港、北美、欧洲等"})]}),s.jsxs(h,{sx:{display:"flex",gap:2},children:[s.jsxs(d,{fullWidth:!0,label:"应用类型",value:r.srvType,onChange:e=>u({...r,srvType:e.target.value}),select:!0,required:!0,children:[s.jsx(o,{value:"Server",children:"Server"}),s.jsx(o,{value:"WEB",children:"WEB"}),s.jsx(o,{value:"Middleware",children:"Middleware"}),s.jsx(o,{value:"DataWare",children:"DataWare"})]}),s.jsxs(d,{fullWidth:!0,label:"虚拟化技术",value:r.virtualTech,onChange:e=>u({...r,virtualTech:e.target.value}),select:!0,children:[s.jsx(o,{value:"",children:"无"}),s.jsx(o,{value:"K8S",children:"K8S"}),s.jsx(o,{value:"EC2",children:"EC2"}),s.jsx(o,{value:"ECS",children:"ECS"}),s.jsx(o,{value:"GCE",children:"GCE"})]})]}),s.jsx(d,{fullWidth:!0,label:"应用功能用途描述和备注信息",value:r.description,onChange:e=>u({...r,description:e.target.value}),multiline:!0,rows:3}),s.jsxs(h,{sx:{display:"flex",gap:2},children:[s.jsx(d,{fullWidth:!0,label:"上线时间",type:"datetime-local",value:r.onlineAt,onChange:e=>u({...r,onlineAt:e.target.value}),InputLabelProps:{shrink:!0}}),s.jsx(d,{fullWidth:!0,label:"下线时间",type:"datetime-local",value:r.offlineAt,onChange:e=>u({...r,offlineAt:e.target.value}),InputLabelProps:{shrink:!0}})]}),s.jsxs(h,{sx:{display:"flex",gap:2},children:[s.jsx(d,{fullWidth:!0,label:"Git地址",value:r.gitUrl||"",onChange:e=>u({...r,gitUrl:e.target.value})}),s.jsx(j,{fullWidth:!0,multiple:!0,options:x,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(r.opsOwners||[]).map(e=>x.find(n=>n.username===e||n.fullName===e)||e),onChange:(e,t)=>{const n=t.map(l=>typeof l=="string"?l:l.username||l.fullName||"");u({...r,opsOwners:n})},onInputChange:(e,t)=>{t?p(t):p()},loading:g,filterOptions:e=>e,renderInput:e=>s.jsx(d,{...e,label:"运维负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[g?s.jsx(S,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,t)=>{const n=typeof t=="string"?null:t,l=n?n.fullName||n.username||"":typeof t=="string"?t:"",v=n?n.id:typeof t=="string"?t:String(t);return i.createElement("li",{...e,key:v},l)}})]}),s.jsxs(h,{sx:{display:"flex",gap:2},children:[s.jsx(j,{fullWidth:!0,multiple:!0,options:x,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(r.testOwners||[]).map(e=>x.find(n=>n.username===e||n.fullName===e)||e),onChange:(e,t)=>{const n=t.map(l=>typeof l=="string"?l:l.username||l.fullName||"");u({...r,testOwners:n})},onInputChange:(e,t)=>{t?p(t):p()},loading:g,filterOptions:e=>e.slice(0,10),renderInput:e=>s.jsx(d,{...e,label:"测试负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[g?s.jsx(S,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,t)=>{const n=typeof t=="string"?null:t,l=n?n.username||n.fullName||"":typeof t=="string"?t:"",v=n?n.id:typeof t=="string"?t:String(t);return i.createElement("li",{...e,key:v},l)}}),s.jsx(j,{fullWidth:!0,multiple:!0,options:x,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(r.devOwners||[]).map(e=>x.find(n=>n.username===e||n.fullName===e)||e),onChange:(e,t)=>{const n=t.map(l=>typeof l=="string"?l:l.username||l.fullName||"");u({...r,devOwners:n})},onInputChange:(e,t)=>{t?p(t):p()},loading:g,filterOptions:e=>e.slice(0,10),renderInput:e=>s.jsx(d,{...e,label:"研发负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[g?s.jsx(S,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,t)=>{const n=typeof t=="string"?null:t,l=n?n.username||n.fullName||"":typeof t=="string"?t:"",v=n?n.id:typeof t=="string"?t:String(t);return i.createElement("li",{...e,key:v},l)}})]}),s.jsx(ve,{control:s.jsx(Se,{checked:r.isCritical,onChange:e=>u({...r,isCritical:e.target.checked})}),label:"是否核心应用"})]})}),s.jsxs(Ce,{children:[s.jsx(C,{onClick:()=>y(!1),children:"取消"}),s.jsx(C,{onClick:te,variant:"contained",children:"保存"})]})]})]})})}export{De as default};
