import{r as o,j as e,i as F,k as L,B as c,du as z,T as g,l as B,b as k,m as S,D as M,a as u,dv as E,I,dw as N,p as W,bf as C,a7 as O,ax as R,w as q,x as P,C as H,dx as J}from"./index-wVs8DYHr.js";import{a as D}from"./ticketApi-COBMGD8s.js";import{S as A}from"./Stack-CNnEoVHt.js";import{T as $,a as G,b as K,c as _,d as n,e as Q}from"./TableRow-17IyVPm2.js";import{C as U}from"./Chip-DzNpApxT.js";function V({open:d,template:l,onClose:m,onSave:y}){const[x,p]=o.useState(""),[i,t]=o.useState([]),[f,h]=o.useState(!1);o.useEffect(()=>{if(d&&l)try{const a=l.approval_config?typeof l.approval_config=="string"?JSON.parse(l.approval_config):l.approval_config:null;a?(p(a.approval_code||""),t(a.field_mappings||[])):(p(""),t([]))}catch(a){console.error("解析审批配置失败:",a),p(""),t([])}},[d,l]);const b=()=>{t([...i,{fieldName:"",keyword:""}])},T=a=>{t(i.filter((r,s)=>s!==a))},v=(a,r,s)=>{const j=[...i];j[a]={...j[a],[r]:s},t(j)},w=async()=>{if(!x.trim()){C("请输入审批代码");return}for(const a of i){if(!a.fieldName.trim()){C("请填写所有字段名称");return}if(!a.keyword.trim()){C("请填写所有关键字");return}}try{h(!0);const a={approval_code:x.trim(),field_mappings:i.filter(r=>r.fieldName.trim()&&r.keyword.trim())};await D.update(l.id,{...l,approval_config:a}),O("保存成功"),y()}catch(a){console.error("保存审批配置失败:",a),C(a?.response?.data?.message||"保存失败")}finally{h(!1)}};return e.jsxs(F,{open:d,onClose:m,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{maxWidth:"900px"}},children:[e.jsx(L,{children:e.jsxs(c,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(z,{color:"primary"}),e.jsxs(g,{variant:"h6",component:"span",children:["配置三方审批 - ",l.name]})]})}),e.jsx(B,{children:e.jsxs(A,{spacing:3,sx:{mt:1},children:[e.jsx(k,{severity:"info",children:e.jsx(g,{variant:"body2",children:"配置审批代码和字段映射。字段名称是审批表单中的字段名称，关键字用于匹配工单数据。"})}),e.jsx(S,{fullWidth:!0,label:"审批代码 (Approval Code)",value:x,onChange:a=>p(a.target.value),required:!0,helperText:"飞书审批定义的唯一标识"}),e.jsx(M,{}),e.jsxs(c,{children:[e.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(g,{variant:"subtitle1",fontWeight:"bold",children:"字段映射配置"}),e.jsx(u,{size:"small",startIcon:e.jsx(E,{}),onClick:b,variant:"outlined",children:"添加字段"})]}),i.length===0?e.jsx(k,{severity:"info",children:'暂无字段映射，点击"添加字段"按钮添加'}):e.jsx(A,{spacing:2,children:i.map((a,r)=>e.jsxs(c,{sx:{display:"flex",gap:2,alignItems:"center",p:2,border:"1px solid #e0e0e0",borderRadius:1},children:[e.jsx(S,{label:"字段名称",value:a.fieldName,onChange:s=>v(r,"fieldName",s.target.value),placeholder:"例如：工单标题",required:!0,sx:{flex:1}}),e.jsx(S,{label:"关键字",value:a.keyword,onChange:s=>v(r,"keyword",s.target.value),placeholder:"例如：title 或 details.0.project_name",required:!0,sx:{flex:1},helperText:"用于匹配工单数据"}),e.jsx(I,{color:"error",onClick:()=>T(r),sx:{flexShrink:0},children:e.jsx(N,{})})]},r))})]})]})}),e.jsxs(W,{children:[e.jsx(u,{onClick:m,children:"取消"}),e.jsx(u,{variant:"contained",onClick:w,disabled:f,children:f?"保存中...":"保存"})]})]})}function ae(){const d=R(),[l,m]=o.useState([]),[y,x]=o.useState(!1),[p,i]=o.useState(!1),[t,f]=o.useState(null);o.useEffect(()=>{h()},[]);const h=async()=>{try{x(!0);const s=await D.list();s.data.code===0&&m(s.data.data||[])}catch(s){console.error("加载模板失败:",s)}finally{x(!1)}},b=()=>{d("/template-editor")},T=s=>{d(`/template-editor/${s.id}`)},v=async s=>{if(window.confirm("确定要删除这个工单模板吗？"))try{await D.delete(s),await h()}catch(j){console.error("删除模板失败:",j)}},w=s=>{f(s),i(!0)},a=()=>{i(!1),f(null)},r=async()=>{await h(),a()};return e.jsxs(c,{sx:{p:3},children:[e.jsx(g,{variant:"h4",sx:{mb:5},children:"设计工单"}),e.jsx(q,{children:e.jsxs(P,{sx:{p:2,"&:last-child":{pb:2}},children:[e.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1.5},children:[e.jsx(g,{variant:"h6",children:"工单模板"}),e.jsx(u,{variant:"contained",startIcon:e.jsx(E,{}),onClick:b,children:"新建工单"})]}),y?e.jsx(c,{sx:{display:"flex",justifyContent:"left",p:2},children:e.jsx(H,{})}):l.length===0?e.jsx(k,{severity:"info",children:'暂无工单模板，点击"新建工单"创建第一个工单模板'}):e.jsx($,{children:e.jsxs(G,{children:[e.jsx(K,{children:e.jsxs(_,{children:[e.jsx(n,{children:"工单名称"}),e.jsx(n,{children:"分类"}),e.jsx(n,{children:"状态"}),e.jsx(n,{children:"版本"}),e.jsx(n,{children:"创建时间"}),e.jsx(n,{children:"三方审批"}),e.jsx(n,{sx:{paddingLeft:"16px"},children:"操作"})]})}),e.jsx(Q,{children:l.map(s=>e.jsxs(_,{children:[e.jsx(n,{children:s.name}),e.jsx(n,{children:s.category||"-"}),e.jsx(n,{children:e.jsx(U,{label:s.status==="active"?"启用":"禁用",color:s.status==="active"?"success":"default",size:"small"})}),e.jsx(n,{children:s.version}),e.jsx(n,{children:new Date(s.created_at).toLocaleDateString()}),e.jsx(n,{children:e.jsx(u,{size:"small",variant:"outlined",onClick:()=>w(s),startIcon:e.jsx(z,{}),children:"配置"})}),e.jsx(n,{sx:{paddingLeft:"16px"},children:e.jsxs(A,{direction:"row",spacing:0,alignItems:"center",children:[e.jsx(I,{size:"small",onClick:()=>T(s),sx:{marginLeft:"-8px"},children:e.jsx(J,{fontSize:"small"})}),e.jsx(I,{size:"small",onClick:()=>v(s.id),children:e.jsx(N,{fontSize:"small"})})]})})]},s.id))})]})})]})}),t&&e.jsx(V,{open:p,template:t,onClose:a,onSave:r})]})}export{ae as default};
