import{u as fe,ax as ve,r as u,c3 as ge,bf as S,bq as R,b4 as xe,j as s,B as x,P as me,T as je,d as V,I as q,v as ye,a as B,A as Ce,m as h,s as Te,t as Ae,M as a,b as Ee,C as W,be as Oe,h as be,i as Se,k as Be,l as Ie,_ as ze,p as we,a7 as K}from"./index-STo1oTDL.js";import{T as De,a as Re,b as We,c as $,d as o,e as Le}from"./TableRow-e9fRaRV7.js";import{C as Q}from"./Chip-v5QMYL72.js";import{T as Pe}from"./TablePagination-u_lqWu4q.js";import{A as E}from"./Autocomplete-B1ZKY7co.js";import{S as Ne}from"./Switch-Do7Epm1v.js";import"./LastPage-Bb7RE8XJ.js";function Ve(){const{t}=fe(),ie=ve(),[Y,ne]=u.useState([]),[m,le]=u.useState([]),[J,X]=u.useState(!1),[L,I]=u.useState(!1),[j,ae]=u.useState({}),[Z,P]=u.useState(""),[N,z]=u.useState(0),[M,ce]=u.useState(10),[C,ee]=u.useState([]),[T,se]=u.useState(!1),[c,w]=u.useState({name:"",org:"",department:"",status:"",srvType:"",virtualTech:"",site:"",isCritical:void 0}),[n,f]=u.useState({org:"",lineOfBiz:"",name:"",isCritical:!1,srvType:"WEB",virtualTech:"",status:"Initializing",site:"",department:"",description:"",onlineAt:"",offlineAt:"",gitUrl:"",opsOwners:[],testOwners:[],devOwners:[]}),O=u.useCallback(e=>{let r=[];return e.forEach(i=>{r.push(i),i.children&&i.children.length>0&&(r=r.concat(O(i.children)))}),r},[]),re=u.useCallback(async()=>{try{const e=await ge.getOrganizationTree();le(Array.isArray(e)?e:[]);const r=O(Array.isArray(e)?e:[]),i=r.find(l=>l.unitCode==="backend-dept");i?console.log("✅ 找到 backend-dept:",i):(console.warn("❌ 未找到 backend-dept"),console.log("所有部门的 unitCode:",r.filter(l=>l.unitType==="Department").map(l=>({unitCode:l.unitCode,unitName:l.unitName}))))}catch(e){console.error("加载组织列表失败:",e),S("加载组织列表失败，请刷新页面重试")}},[O]),D=(e,r)=>O(e).filter(l=>l.unitType===r),k=(e,r)=>{if(!e)return"-";const l=O(r).find(d=>d.unitCode===e);return l?l.unitName:e},U=(e,r)=>{if(!e)return[];const i=(d,v)=>{for(const p of v){if(p.unitCode===d)return p;if(p.children){const g=i(d,p.children);if(g)return g}}return null},l=i(e,r);return!l||!l.children?[]:l.children.filter(d=>d.unitType==="LineOfBiz")},H=(e,r)=>{if(!e)return n.org?oe(n.org,r):D(r,"Department");const i=(v,p)=>{for(const g of p){if(g.unitCode===v)return g;if(g.children){const b=i(v,g.children);if(b)return b}}return null},l=i(e,r);if(!l)return[];const d=v=>{let p=[];return v.unitType==="Department"&&p.push(v),v.children&&v.children.forEach(g=>{p=p.concat(d(g))}),p};return d(l)},oe=(e,r)=>{if(!e)return D(r,"Department");const i=(v,p)=>{for(const g of p){if(g.unitCode===v)return g;if(g.children){const b=i(v,g.children);if(b)return b}}return null},l=i(e,r);if(!l)return[];const d=v=>{let p=[];return v.unitType==="Department"&&p.push(v),v.children&&v.children.forEach(g=>{p=p.concat(d(g))}),p};return d(l)},A=u.useCallback(async()=>{X(!0),P("");try{const e={};c.name&&(e.name=c.name),c.org&&(e.org=c.org),c.department&&(e.department=c.department),c.status&&(e.status=c.status),c.srvType&&(e.srvType=c.srvType),c.virtualTech&&(e.virtualTech=c.virtualTech),c.site&&(e.site=c.site),c.isCritical!==void 0&&(e.isCritical=c.isCritical);const r=await R.getApplications(e);ne(Array.isArray(r)?r:[])}catch(e){const r=e,i=r?.response?.data?.message||r?.message||t("services.loadFailed");P(i),S(i)}finally{X(!1)}},[c,t]),y=u.useCallback(async(e="")=>{try{se(!0);const r=await xe.getUsersWithRoles({page:1,pageSize:10,keyword:e||void 0});ee(r.users||[])}catch(r){console.error("加载用户列表失败:",r),ee([])}finally{se(!1)}},[]);u.useEffect(()=>{re()},[re]),u.useEffect(()=>{A()},[A]),u.useEffect(()=>{L&&y()},[L,y]);const ue=()=>{ae({}),f({org:"",lineOfBiz:"",name:"",isCritical:!1,srvType:"WEB",virtualTech:"",status:"Initializing",site:"",department:"",description:"",onlineAt:"",offlineAt:"",gitUrl:"",opsOwners:[],testOwners:[],devOwners:[]}),I(!0)},de=async e=>{if(window.confirm(t("services.deleteConfirm")))try{await R.deleteApplication(e),K(t("services.deleteSuccess")),A()}catch(r){const i=r,l=i?.response?.data?.message||i?.message||t("services.deleteFailed");S(l)}},pe=async()=>{if(!n.name.trim()){S(t("services.nameRequired"));return}try{const e=i=>{if(!(!i||i.trim()===""))try{const l=new Date(i);return isNaN(l.getTime())?void 0:l.toISOString()}catch{return}},r={org:n.org||void 0,lineOfBiz:n.lineOfBiz||void 0,name:n.name,isCritical:n.isCritical,srvType:n.srvType,virtualTech:n.virtualTech||void 0,status:n.status,site:n.site||void 0,department:n.department||void 0,description:n.description||void 0,onlineAt:e(n.onlineAt),offlineAt:e(n.offlineAt),gitUrl:n.gitUrl||void 0,opsOwners:n.opsOwners&&n.opsOwners.length>0?n.opsOwners:void 0,testOwners:n.testOwners&&n.testOwners.length>0?n.testOwners:void 0,devOwners:n.devOwners&&n.devOwners.length>0?n.devOwners:void 0};j.id?(await R.updateApplication(j.id,r),K(t("services.updateSuccess"))):(await R.createApplication(r),K(t("services.createSuccess"))),I(!1),A()}catch(e){const r=e,i=r?.response?.data?.message||r?.message||t("services.saveFailed");S(i)}},he=e=>{switch(e){case"Running":return"success";case"Stopped":return"error";case"Initializing":return"warning";default:return"default"}},_=(e,r)=>{for(const i of r){if(i.unitCode===e)return i;if(i.children){const l=_(e,i.children);if(l)return l}}return null};let G=U(n.org,m);if(j.id&&j.lineOfBiz){const e=j.lineOfBiz;if(!G.some(i=>i.unitCode===e)){const i=_(e,m);i&&i.unitType==="LineOfBiz"&&(G=[i,...G])}}let F=H(n.lineOfBiz,m);if(j.id&&j.department){const e=j.department;if(!F.some(i=>i.unitCode===e)){const i=_(e,m);i&&i.unitType==="Department"&&(F=[i,...F])}}const te=Y.slice(N*M,(N+1)*M);return s.jsx(x,{children:s.jsxs(me,{sx:{p:3},children:[s.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[s.jsx(je,{variant:"h5",children:t("services.title")}),s.jsxs(x,{children:[s.jsx(V,{title:t("services.refresh"),children:s.jsx(q,{onClick:A,disabled:J,children:s.jsx(ye,{})})}),s.jsx(B,{variant:"contained",startIcon:s.jsx(Ce,{}),onClick:ue,sx:{ml:1},children:t("services.createApplication")})]})]}),s.jsxs(x,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap"},children:[s.jsx(h,{size:"small",placeholder:t("services.searchPlaceholder"),value:c.name,onChange:e=>w({...c,name:e.target.value}),InputProps:{startAdornment:s.jsx(Te,{position:"start",children:s.jsx(Ae,{})})},sx:{minWidth:200}}),s.jsxs(h,{size:"small",select:!0,label:t("services.status"),value:c.status,onChange:e=>w({...c,status:e.target.value}),sx:{minWidth:120},children:[s.jsx(a,{value:"",children:t("services.all")}),s.jsx(a,{value:"Running",children:t("services.running")}),s.jsx(a,{value:"Stopped",children:t("services.stopped")}),s.jsx(a,{value:"Initializing",children:t("services.initializing")})]}),s.jsxs(h,{size:"small",select:!0,label:t("services.applicationType"),value:c.srvType,onChange:e=>w({...c,srvType:e.target.value}),sx:{minWidth:120},children:[s.jsx(a,{value:"",children:t("services.all")}),s.jsx(a,{value:"SERVER",children:t("services.srvType.SERVER")}),s.jsx(a,{value:"WEB",children:t("services.srvType.WEB")}),s.jsx(a,{value:"MIDDLEWARE",children:t("services.srvType.MIDDLEWARE")}),s.jsx(a,{value:"DATAWARE",children:t("services.srvType.DATAWARE")}),s.jsx(a,{value:"MOBILE",children:t("services.srvType.MOBILE")}),s.jsx(a,{value:"DATABASE",children:t("services.srvType.DATABASE")}),s.jsx(a,{value:"MICROSERVICE",children:t("services.srvType.MICROSERVICE")}),s.jsx(a,{value:"BATCH",children:t("services.srvType.BATCH")}),s.jsx(a,{value:"SCHEDULER",children:t("services.srvType.SCHEDULER")}),s.jsx(a,{value:"GATEWAY",children:t("services.srvType.GATEWAY")}),s.jsx(a,{value:"CACHE",children:t("services.srvType.CACHE")}),s.jsx(a,{value:"MESSAGE_QUEUE",children:t("services.srvType.MESSAGE_QUEUE")}),s.jsx(a,{value:"BACKEND",children:t("services.srvType.BACKEND")})]}),s.jsx(B,{variant:"outlined",onClick:()=>{z(0),A()},children:t("services.search")}),s.jsx(B,{variant:"outlined",onClick:()=>{w({name:"",org:"",department:"",status:"",srvType:"",virtualTech:"",site:"",isCritical:void 0}),z(0)},children:t("services.reset")})]}),Z&&s.jsx(Ee,{severity:"error",sx:{mb:2},onClose:()=>P(""),children:Z}),J?s.jsx(x,{sx:{display:"flex",justifyContent:"center",p:4},children:s.jsx(W,{})}):s.jsxs(s.Fragment,{children:[s.jsx(De,{children:s.jsxs(Re,{children:[s.jsx(We,{children:s.jsxs($,{children:[s.jsx(o,{children:t("services.applicationName")}),s.jsx(o,{children:t("services.org")}),s.jsx(o,{children:t("services.lineOfBiz")}),s.jsx(o,{children:t("services.department")}),s.jsx(o,{children:t("services.site")}),s.jsx(o,{children:t("services.applicationType")}),s.jsx(o,{children:t("services.virtualTech")}),s.jsx(o,{children:t("services.status")}),s.jsx(o,{children:t("services.isCritical")}),s.jsx(o,{children:t("services.onlineAt")}),s.jsx(o,{align:"center",children:t("services.actions")})]})}),s.jsx(Le,{children:te.length===0?s.jsx($,{children:s.jsx(o,{colSpan:11,align:"center",children:t("services.noData")})}):te.map(e=>s.jsxs($,{children:[s.jsx(o,{children:e.name}),s.jsx(o,{children:k(e.org,m)}),s.jsx(o,{children:k(e.lineOfBiz,m)}),s.jsx(o,{children:k(e.department,m)}),s.jsx(o,{children:e.site||"-"}),s.jsx(o,{children:t(`services.srvType.${e.srvType}`,e.srvType)}),s.jsx(o,{children:e.virtualTech||"-"}),s.jsx(o,{children:s.jsx(Q,{label:e.status,color:he(e.status),size:"small"})}),s.jsx(o,{children:e.isCritical?s.jsx(Q,{label:t("services.yes"),color:"error",size:"small"}):s.jsx(Q,{label:t("services.no"),size:"small"})}),s.jsx(o,{children:e.onlineAt?new Date(e.onlineAt).toLocaleString("zh-CN"):"-"}),s.jsx(o,{align:"center",children:s.jsxs(x,{sx:{display:"flex",gap:.5,justifyContent:"center"},children:[s.jsx(V,{title:t("services.detail")||"详情",children:s.jsx(q,{size:"small",onClick:()=>ie(`/services/${e.id}`),color:"primary",children:s.jsx(Oe,{fontSize:"small"})})}),s.jsx(V,{title:t("common.delete"),children:s.jsx(q,{size:"small",color:"error",onClick:()=>de(e.id),children:s.jsx(be,{fontSize:"small"})})})]})})]},e.id))})]})}),s.jsx(Pe,{component:"div",count:Y.length,page:N,onPageChange:(e,r)=>z(r),rowsPerPage:M,onRowsPerPageChange:e=>{ce(parseInt(e.target.value,10)),z(0)},rowsPerPageOptions:[10,25,50,100],labelRowsPerPage:t("common.rowsPerPage")||"每页显示:",labelDisplayedRows:({from:e,to:r,count:i})=>t("common.displayedRows",{from:e,to:r,count:i})||`${e}-${r} 共 ${i} 条`,sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]}),s.jsxs(Se,{open:L,onClose:()=>I(!1),maxWidth:"md",fullWidth:!0,children:[s.jsx(Be,{children:t("services.createApplication")}),s.jsx(Ie,{children:s.jsxs(x,{sx:{pt:2,display:"flex",flexDirection:"column",gap:2},children:[s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(h,{fullWidth:!0,label:t("services.applicationName"),value:n.name,onChange:e=>f({...n,name:e.target.value}),required:!0}),s.jsxs(h,{fullWidth:!0,label:t("services.status"),select:!0,value:n.status,onChange:e=>f({...n,status:e.target.value}),required:!0,children:[s.jsx(a,{value:"Initializing",children:t("services.initializing")}),s.jsx(a,{value:"Running",children:t("services.running")}),s.jsx(a,{value:"Stopped",children:t("services.stopped")})]})]}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(E,{fullWidth:!0,options:D(m,"BizGroup"),getOptionLabel:e=>e.unitName,value:D(m,"BizGroup").find(e=>e.unitCode===n.org)||null,onChange:(e,r)=>{f({...n,org:r?.unitCode||"",lineOfBiz:"",department:""})},renderInput:e=>s.jsx(h,{...e,label:t("services.org")||"事业部",required:!0})}),s.jsx(E,{fullWidth:!0,disabled:!n.org,options:U(n.org,m),getOptionLabel:e=>e.unitName,value:U(n.org,m).find(e=>e.unitCode===n.lineOfBiz)||null,onChange:(e,r)=>{f({...n,lineOfBiz:r?.unitCode||"",department:""})},renderInput:e=>s.jsx(h,{...e,label:t("services.lineOfBiz")||"业务线",placeholder:n.org?"请选择业务线":"请先选择事业部"})})]}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(E,{fullWidth:!0,disabled:!n.lineOfBiz,options:H(n.lineOfBiz,m),getOptionLabel:e=>e.unitName,value:H(n.lineOfBiz,m).find(e=>e.unitCode===n.department)||null,onChange:(e,r)=>{f({...n,department:r?.unitCode||""})},renderInput:e=>s.jsx(h,{...e,label:t("services.department")||"部门",placeholder:n.lineOfBiz?"请选择部门":"请先选择业务线"})}),s.jsx(h,{fullWidth:!0,label:t("services.site"),value:n.site,onChange:e=>f({...n,site:e.target.value})})]}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsxs(h,{fullWidth:!0,label:t("services.applicationType"),select:!0,value:n.srvType,onChange:e=>f({...n,srvType:e.target.value}),required:!0,children:[s.jsx(a,{value:"SERVER",children:t("services.srvType.SERVER")}),s.jsx(a,{value:"WEB",children:t("services.srvType.WEB")}),s.jsx(a,{value:"MIDDLEWARE",children:t("services.srvType.MIDDLEWARE")}),s.jsx(a,{value:"DATAWARE",children:t("services.srvType.DATAWARE")}),s.jsx(a,{value:"MOBILE",children:t("services.srvType.MOBILE")}),s.jsx(a,{value:"DATABASE",children:t("services.srvType.DATABASE")}),s.jsx(a,{value:"MICROSERVICE",children:t("services.srvType.MICROSERVICE")}),s.jsx(a,{value:"BATCH",children:t("services.srvType.BATCH")}),s.jsx(a,{value:"SCHEDULER",children:t("services.srvType.SCHEDULER")}),s.jsx(a,{value:"GATEWAY",children:t("services.srvType.GATEWAY")}),s.jsx(a,{value:"CACHE",children:t("services.srvType.CACHE")}),s.jsx(a,{value:"MESSAGE_QUEUE",children:t("services.srvType.MESSAGE_QUEUE")}),s.jsx(a,{value:"BACKEND",children:t("services.srvType.BACKEND")})]}),s.jsxs(h,{fullWidth:!0,label:t("services.virtualTech"),select:!0,value:n.virtualTech,onChange:e=>f({...n,virtualTech:e.target.value}),children:[s.jsx(a,{value:"",children:t("common.none")}),s.jsx(a,{value:"K8S",children:"K8S"}),s.jsx(a,{value:"EC2",children:"EC2"}),s.jsx(a,{value:"ECS",children:"ECS"}),s.jsx(a,{value:"GCE",children:"GCE"})]})]}),s.jsx(h,{fullWidth:!0,label:t("services.description"),value:n.description,onChange:e=>f({...n,description:e.target.value}),multiline:!0,rows:3}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(h,{fullWidth:!0,label:t("services.onlineAt"),type:"datetime-local",value:n.onlineAt,onChange:e=>f({...n,onlineAt:e.target.value}),InputLabelProps:{shrink:!0}}),s.jsx(h,{fullWidth:!0,label:t("services.offlineAt"),type:"datetime-local",value:n.offlineAt,onChange:e=>f({...n,offlineAt:e.target.value}),InputLabelProps:{shrink:!0}})]}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(h,{fullWidth:!0,label:t("services.gitUrl")||"Git地址",value:n.gitUrl,onChange:e=>f({...n,gitUrl:e.target.value})}),s.jsx(E,{fullWidth:!0,multiple:!0,options:C,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(n.opsOwners||[]).map(e=>C.find(i=>i.username===e||i.fullName===e)||e),onChange:(e,r)=>{const i=r.map(l=>typeof l=="string"?l:l.username||l.fullName||"");f({...n,opsOwners:i})},onInputChange:(e,r)=>{r?y(r):y()},loading:T,filterOptions:e=>e,renderInput:e=>s.jsx(h,{...e,label:t("services.opsOwners")||"运维负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[T?s.jsx(W,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,r)=>{const i=typeof r=="string"?null:r,l=i?i.fullName||i.username||"":typeof r=="string"?r:"",d=i?i.id:typeof r=="string"?r:String(r);return u.createElement("li",{...e,key:d},l)}})]}),s.jsxs(x,{sx:{display:"flex",gap:2},children:[s.jsx(E,{fullWidth:!0,multiple:!0,options:C,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(n.testOwners||[]).map(e=>C.find(i=>i.username===e||i.fullName===e)||e),onChange:(e,r)=>{const i=r.map(l=>typeof l=="string"?l:l.username||l.fullName||"");f({...n,testOwners:i})},onInputChange:(e,r)=>{r?y(r):y()},loading:T,filterOptions:e=>e.slice(0,10),renderInput:e=>s.jsx(h,{...e,label:t("services.testOwners")||"测试负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[T?s.jsx(W,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,r)=>{const i=typeof r=="string"?null:r,l=i?i.username||i.fullName||"":typeof r=="string"?r:"",d=i?i.id:typeof r=="string"?r:String(r);return u.createElement("li",{...e,key:d},l)}}),s.jsx(E,{fullWidth:!0,multiple:!0,options:C,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(n.devOwners||[]).map(e=>C.find(i=>i.username===e||i.fullName===e)||e),onChange:(e,r)=>{const i=r.map(l=>typeof l=="string"?l:l.username||l.fullName||"");f({...n,devOwners:i})},onInputChange:(e,r)=>{r?y(r):y()},loading:T,filterOptions:e=>e.slice(0,10),renderInput:e=>s.jsx(h,{...e,label:t("services.devOwners")||"研发负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[T?s.jsx(W,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,r)=>{const i=typeof r=="string"?null:r,l=i?i.username||i.fullName||"":typeof r=="string"?r:"",d=i?i.id:typeof r=="string"?r:String(r);return u.createElement("li",{...e,key:d},l)}})]}),s.jsx(ze,{control:s.jsx(Ne,{checked:n.isCritical,onChange:e=>f({...n,isCritical:e.target.checked})}),label:t("services.isCriticalApp")})]})}),s.jsxs(we,{children:[s.jsx(B,{onClick:()=>I(!1),children:t("services.cancel")}),s.jsx(B,{onClick:pe,variant:"contained",children:t("services.save")})]})]})]})})}export{Ve as default};
