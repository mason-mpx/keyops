import{u as De,bg as Ce,ax as we,r as d,j as e,B as a,C as v,b as f,a as p,aA as Z,I as q,T as l,d as Ie,v as Ae,cb as Se,bm as J,cA as Re,w as h,x as m,a3 as We,a4 as D,a2 as Te,Z as Be,bl as $e,cG as Me,cH as Q,i as ee,k as se,l as te,m as Pe,p as ne,bf as C,a7 as ae}from"./index-z51Q_M-r.js";import{k as P,d as Ye,e as Le,f as Ee,h as He,s as Oe}from"./index-BJBlvgn8.js";import{P as ze,Y as _e}from"./PodActions-BGYv9JfR.js";import{G as Y}from"./GridLegacy-DEcBHpwE.js";import{C as w}from"./Chip-BoE43uAD.js";import{R as le,C as ie,X as re,Y as oe,T as ce,L as de}from"./CartesianChart-UrYVXqzA.js";import{L as xe}from"./LineChart-B6pv7Iji.js";import{L as pe}from"./Line-W7duD_LQ.js";import"./utils-BrE-8RSA.js";import"./yaml-DVsj5t0_.js";import"./index-B39DLDJr.js";import"./k8sClusterApi-D8d3s8iX.js";import"./PodLogsDialog-BSHqOKTh.js";import"./xterm-BqYE0GQX.js";import"./Switch-CFen4WHb.js";import"./value-DaH6Zdgz.js";function I(t){const{children:o,value:r,index:i,...A}=t;return e.jsx("div",{role:"tabpanel",hidden:r!==i,id:`deployment-tabpanel-${i}`,"aria-labelledby":`deployment-tab-${i}`,...A,children:r===i&&e.jsx(a,{sx:{p:3},children:o})})}function ls(){const{t}=De(),{clusterId:o,namespace:r,name:i}=Ce(),A=we(),[he,L]=d.useState(!0),[c,me]=d.useState(null),[E,H]=d.useState(null),[j,je]=d.useState(0),[ye,S]=d.useState(!1),[T,B]=d.useState(0),[O,z]=d.useState(!1),[fe,_]=d.useState(!1),[ge,R]=d.useState(!1),[g,ue]=d.useState([]),[K,X]=d.useState(!1),[F,G]=d.useState(!1),[u,U]=d.useState(null),[be,V]=d.useState(!1),y=async()=>{if(!(!o||!r||!i))try{L(!0),H(null);const n=await Ye({clusterId:o,namespace:r},i);me(n),n?.replicas&&typeof n.replicas=="number"&&B(n.replicas),ke(),$()}catch(s){const n=(s&&typeof s=="object"&&"response"in s&&s.response&&typeof s.response=="object"&&"data"in s.response&&s.response.data&&typeof s.response.data=="object"&&"message"in s.response.data&&typeof s.response.data.message=="string"?s.response.data.message:null)||t("k8s.deployments.loadDetailFailed");H(n||""),C(n||"")}finally{L(!1)}},ke=async()=>{if(!(!o||!r||!i))try{V(!0);const n=await Le({clusterId:o,namespace:r},i,3600,300);U(n)}catch(s){console.error("加载监控数据失败:",s),U(null)}finally{V(!1)}},$=async()=>{if(!(!o||!r||!i))try{X(!0);const n=await Ee({clusterId:o,namespace:r},i);ue(n.revisions)}catch(s){const n=(s&&typeof s=="object"&&"response"in s&&s.response&&typeof s.response=="object"&&"data"in s.response&&s.response.data&&typeof s.response.data=="object"&&"message"in s.response.data&&typeof s.response.data.message=="string"?s.response.data.message:null)||"加载历史版本失败";C(n)}finally{X(!1)}},N=async s=>{if(!(!o||!r||!i))try{G(!0),await He({clusterId:o,namespace:r},i,s),ae(`已成功回滚到版本 ${s}`),R(!1),y(),$()}catch(n){const x=(n&&typeof n=="object"&&"response"in n&&n.response&&typeof n.response=="object"&&"data"in n.response&&n.response.data&&typeof n.response.data=="object"&&"message"in n.response.data&&typeof n.response.data.message=="string"?n.response.data.message:null)||"回滚失败";C(x)}finally{G(!1)}};d.useEffect(()=>{console.log("[DeploymentDetail] Route params:",{clusterId:o,namespace:r,name:i}),o&&r&&i?y():console.warn("[DeploymentDetail] Missing route params:",{clusterId:o,namespace:r,name:i})},[o,r,i]),d.useEffect(()=>{if(!o||!r||!i)return;const s=setInterval(()=>{y()},3e4);return()=>clearInterval(s)},[o,r,i]);const ve=async()=>{if(!(!o||!r||!i)){if(T<0){C("副本数不能小于0");return}try{z(!0),await Oe({clusterId:o,namespace:r,deployment_name:i},T),ae(t("k8s.deployments.scaleSuccess","扩缩容成功")),S(!1),y()}catch(s){const n=(s&&typeof s=="object"&&"response"in s&&s.response&&typeof s.response=="object"&&"data"in s.response&&s.response.data&&typeof s.response.data=="object"&&"message"in s.response.data&&typeof s.response.data.message=="string"?s.response.data.message:null)||t("k8s.deployments.scaleFailed","扩缩容失败");C(n||"")}finally{z(!1)}}},W=(s,n)=>n==null||n===""?null:e.jsxs(a,{sx:{mb:2},children:[e.jsx(l,{variant:"caption",color:"text.secondary",display:"block",children:s}),e.jsx(l,{variant:"body1",fontWeight:500,children:String(n)})]});return he&&!c?e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh"},children:e.jsx(v,{})}):E&&!c?e.jsxs(a,{sx:{p:3},children:[e.jsx(f,{severity:"error",children:E}),e.jsx(p,{startIcon:e.jsx(Z,{}),onClick:()=>A("/k8s/deployments"),sx:{mt:2},children:t("common.back")})]}):e.jsxs(a,{sx:{width:"100%",p:3},children:[e.jsxs(a,{sx:{mb:3,display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:2},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(q,{onClick:()=>A("/k8s/deployments"),children:e.jsx(Z,{})}),e.jsxs(a,{children:[e.jsx(l,{variant:"h4",component:"h1",fontWeight:"700",children:i}),e.jsxs(l,{variant:"body2",color:"text.secondary",children:[r," / ",o]})]})]}),e.jsxs(a,{sx:{display:"flex",gap:1},children:[e.jsx(Ie,{title:t("common.refresh"),children:e.jsx(q,{onClick:y,children:e.jsx(Ae,{})})}),e.jsx(p,{variant:"outlined",startIcon:e.jsx(Se,{}),onClick:()=>{B(c?.replicas||0),S(!0)},children:t("k8s.deployments.scale","扩缩容")}),e.jsx(p,{variant:"outlined",startIcon:e.jsx(J,{}),onClick:()=>{R(!0),$()},children:t("k8s.deployments.rollback","回滚")}),e.jsx(p,{variant:"outlined",startIcon:e.jsx(Re,{}),onClick:()=>_(!0),children:t("k8s.viewYaml")})]})]}),e.jsxs(a,{sx:{display:"flex",gap:2,mb:3,width:"100%",flexWrap:{xs:"wrap",sm:"nowrap"}},children:[e.jsx(h,{sx:{flex:1,minWidth:{xs:"100%",sm:0},display:"flex",flexDirection:"column"},children:e.jsxs(m,{sx:{flex:1,display:"flex",flexDirection:"column",justifyContent:"center",minHeight:120},children:[e.jsx(l,{variant:"caption",color:"text.secondary",sx:{mb:1},children:t("k8s.replicas")}),e.jsx(l,{variant:"h4",fontWeight:"600",children:c?.replicas||0})]})}),e.jsx(h,{sx:{flex:1,minWidth:{xs:"100%",sm:0},display:"flex",flexDirection:"column"},children:e.jsxs(m,{sx:{flex:1,display:"flex",flexDirection:"column",justifyContent:"center",minHeight:120},children:[e.jsx(l,{variant:"caption",color:"text.secondary",sx:{mb:1},children:t("k8s.deployments.ready","就绪")}),e.jsx(l,{variant:"h4",fontWeight:"600",color:"success.main",children:c?.ready||0})]})}),e.jsx(h,{sx:{flex:1,minWidth:{xs:"100%",sm:0},display:"flex",flexDirection:"column"},children:e.jsxs(m,{sx:{flex:1,display:"flex",flexDirection:"column",justifyContent:"center",minHeight:120},children:[e.jsx(l,{variant:"caption",color:"text.secondary",sx:{mb:1},children:t("k8s.deployments.available","可用")}),e.jsx(l,{variant:"h4",fontWeight:"600",color:"info.main",children:c?.available||0})]})}),e.jsx(h,{sx:{flex:1,minWidth:{xs:"100%",sm:0},display:"flex",flexDirection:"column"},children:e.jsxs(m,{sx:{flex:1,display:"flex",flexDirection:"column",justifyContent:"center",minHeight:120},children:[e.jsx(l,{variant:"caption",color:"text.secondary",sx:{mb:1},children:t("k8s.deployments.upToDate","最新")}),e.jsx(l,{variant:"h4",fontWeight:"600",color:"warning.main",children:c?.upToDate||0})]})})]}),e.jsxs(h,{children:[e.jsx(a,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(We,{value:j,onChange:(s,n)=>je(n),children:[e.jsx(D,{icon:e.jsx(Te,{}),iconPosition:"start",label:t("k8s.basicInfo")}),e.jsx(D,{icon:e.jsx(Be,{}),iconPosition:"start",label:`${t("k8s.pods.title")} (${c?.pods?.length||0})`}),e.jsx(D,{icon:e.jsx($e,{}),iconPosition:"start",label:`${t("k8s.events.title")} (${c?.events?.length||0})`}),e.jsx(D,{icon:e.jsx(Me,{}),iconPosition:"start",label:t("k8s.monitoring","监控")}),e.jsx(D,{icon:e.jsx(J,{}),iconPosition:"start",label:`${t("k8s.deployments.history","历史版本")} (${g.length})`})]})}),e.jsx(I,{value:j,index:0,children:e.jsxs(Y,{container:!0,spacing:3,children:[e.jsxs(Y,{item:!0,xs:12,md:6,children:[e.jsx(l,{variant:"h6",sx:{mb:2},children:t("k8s.basicInfo")}),W(t("k8s.name"),c?.name),W(t("k8s.namespace"),c?.namespace),W(t("k8s.strategy"),c?.strategy),W(t("k8s.age"),c?.age)]}),e.jsxs(Y,{item:!0,xs:12,md:6,children:[e.jsx(l,{variant:"h6",sx:{mb:2},children:t("k8s.labels")}),c?.labels&&Object.keys(c.labels).length>0?e.jsx(a,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:Object.entries(c.labels).map(([s,n])=>e.jsx(w,{label:`${s}=${n}`,size:"small"},s))}):e.jsx(l,{variant:"body2",color:"text.secondary",children:t("common.noData")})]})]})}),e.jsx(I,{value:j,index:1,children:c?.pods&&c.pods.length>0?e.jsxs(a,{children:[e.jsx(l,{variant:"h6",sx:{mb:2},children:t("k8s.pods.title")}),e.jsx(a,{sx:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{borderBottom:"1px solid #e0e0e0"},children:[e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.name")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.status")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.node")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.restarts")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.age")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("common.actions")})]})}),e.jsx("tbody",{children:c.pods.map((s,n)=>e.jsxs("tr",{style:{borderBottom:"1px solid #f0f0f0"},children:[e.jsx("td",{style:{padding:"12px"},children:s.name}),e.jsx("td",{style:{padding:"12px"},children:e.jsx(w,{label:s.status,color:s.status==="Running"?"success":"default",size:"small"})}),e.jsx("td",{style:{padding:"12px"},children:s.node||"-"}),e.jsx("td",{style:{padding:"12px"},children:s.restarts||0}),e.jsx("td",{style:{padding:"12px"},children:s.age||"-"}),e.jsx("td",{style:{padding:"12px"},children:e.jsx(ze,{pod:s,clusterId:o||"",namespace:r||""})})]},n))})]})})]}):e.jsx(f,{severity:"info",children:t("common.noData")})}),e.jsx(I,{value:j,index:2,children:c?.events&&c.events.length>0?e.jsxs(a,{children:[e.jsx(l,{variant:"h6",sx:{mb:2},children:t("k8s.events.title")}),e.jsx(a,{sx:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{borderBottom:"1px solid #e0e0e0"},children:[e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.type")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.reason")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.message")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.count")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.lastSeen")})]})}),e.jsx("tbody",{children:c.events.map((s,n)=>e.jsxs("tr",{style:{borderBottom:"1px solid #f0f0f0"},children:[e.jsx("td",{style:{padding:"12px"},children:e.jsx(w,{label:s.type,color:s.type==="Warning"?"warning":"info",size:"small"})}),e.jsx("td",{style:{padding:"12px"},children:s.reason}),e.jsx("td",{style:{padding:"12px"},children:s.message}),e.jsx("td",{style:{padding:"12px"},children:s.count}),e.jsx("td",{style:{padding:"12px"},children:s.lastSeen})]},n))})]})})]}):e.jsx(f,{severity:"info",children:t("common.noData")})}),e.jsxs(I,{value:j,index:3,children:[e.jsx(l,{variant:"h6",sx:{mb:3},children:t("k8s.monitoring","监控")}),be?e.jsx(a,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(v,{})}):u&&u.metrics&&u.metrics.length>0?e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:3,width:"100%"},children:[e.jsx(h,{sx:{width:"100%"},children:e.jsxs(m,{children:[e.jsx(l,{variant:"subtitle1",sx:{mb:2},children:"CPU 使用率 (m)"}),e.jsx(le,{width:"100%",height:300,children:e.jsxs(xe,{data:u.metrics,children:[e.jsx(ie,{strokeDasharray:"3 3"}),e.jsx(re,{dataKey:"time"}),e.jsx(oe,{}),e.jsx(ce,{}),e.jsx(de,{}),e.jsx(pe,{type:"monotone",dataKey:"cpu",stroke:"#8884d8",name:"CPU (m)"})]})})]})}),e.jsx(h,{sx:{width:"100%"},children:e.jsxs(m,{children:[e.jsx(l,{variant:"subtitle1",sx:{mb:2},children:"内存使用率 (MB)"}),e.jsx(le,{width:"100%",height:300,children:e.jsxs(xe,{data:u.metrics,children:[e.jsx(ie,{strokeDasharray:"3 3"}),e.jsx(re,{dataKey:"time"}),e.jsx(oe,{}),e.jsx(ce,{}),e.jsx(de,{}),e.jsx(pe,{type:"monotone",dataKey:"memory",stroke:"#82ca9d",name:"Memory (MB)"})]})})]})})]}):e.jsx(f,{severity:"info",children:t("k8s.monitoring.noData","暂无监控数据")})]}),e.jsxs(I,{value:j,index:4,children:[e.jsx(l,{variant:"h6",sx:{mb:2},children:t("k8s.deployments.history","历史版本")}),K?e.jsx(a,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(v,{})}):g.length>0?e.jsx(a,{sx:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{borderBottom:"1px solid #e0e0e0"},children:[e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:"版本"}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:"状态"}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:"创建时间"}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:"变更原因"}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:"镜像"}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:"副本"}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:"操作"})]})}),e.jsx("tbody",{children:g.map(s=>e.jsxs("tr",{style:{borderBottom:"1px solid #f0f0f0"},children:[e.jsx("td",{style:{padding:"12px"},children:e.jsx(l,{variant:"body2",fontWeight:s.status==="current"?600:400,children:s.revision})}),e.jsx("td",{style:{padding:"12px"},children:e.jsx(w,{label:s.status==="current"?t("k8s.deployments.current","当前"):t("k8s.deployments.historical","历史"),color:s.status==="current"?"success":"default",size:"small"})}),e.jsx("td",{style:{padding:"12px"},children:s.creation_time}),e.jsx("td",{style:{padding:"12px"},children:s.change_reason||"-"}),e.jsx("td",{style:{padding:"12px"},children:e.jsx(a,{sx:{display:"flex",flexDirection:"column",gap:.5},children:s.images.map((n,x)=>e.jsx(l,{variant:"caption",sx:{fontFamily:"monospace"},children:n},x))})}),e.jsxs("td",{style:{padding:"12px"},children:[s.replicas," / ",s.ready," / ",s.available]}),e.jsx("td",{style:{padding:"12px"},children:s.status==="historical"&&e.jsx(p,{size:"small",variant:"outlined",startIcon:e.jsx(Q,{}),onClick:()=>N(s.revision),disabled:F,children:t("k8s.deployments.rollback","回滚")})})]},s.revision))})]})}):e.jsx(f,{severity:"info",children:t("common.noData")})]})]}),e.jsxs(ee,{open:ye,onClose:()=>S(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(se,{children:t("k8s.deployments.scale","扩缩容")}),e.jsx(te,{children:e.jsx(Pe,{fullWidth:!0,type:"number",label:t("k8s.replicas"),value:T,onChange:s=>B(parseInt(s.target.value)||0),inputProps:{min:0},sx:{mt:2}})}),e.jsxs(ne,{children:[e.jsx(p,{onClick:()=>S(!1),children:t("common.cancel")}),e.jsx(p,{onClick:ve,variant:"contained",disabled:O,children:O?e.jsx(v,{size:20}):t("common.confirm")})]})]}),e.jsxs(ee,{open:ge,onClose:()=>R(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(se,{children:t("k8s.deployments.rollback","回滚 Deployment")}),e.jsx(te,{children:K?e.jsx(a,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(v,{})}):g.length>0?e.jsxs(a,{sx:{mt:2},children:[e.jsx(l,{variant:"body2",color:"text.secondary",sx:{mb:2},children:t("k8s.deployments.selectRevision","选择要回滚到的版本")}),e.jsx(a,{sx:{maxHeight:400,overflowY:"auto"},children:g.filter(s=>s.status==="historical").map(s=>e.jsx(h,{sx:{mb:1},children:e.jsx(m,{children:e.jsxs(a,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(a,{children:[e.jsxs(l,{variant:"subtitle1",children:[t("k8s.deployments.revision","版本")," ",s.revision]}),e.jsxs(l,{variant:"caption",color:"text.secondary",children:[s.creation_time," - ",s.change_reason||"-"]}),e.jsx(a,{sx:{mt:1},children:s.images.map((n,x)=>e.jsx(w,{label:n,size:"small",sx:{mr:.5,mb:.5}},x))})]}),e.jsx(p,{variant:"outlined",startIcon:e.jsx(Q,{}),onClick:()=>N(s.revision),disabled:F,children:t("k8s.deployments.rollback","回滚")})]})})},s.revision))})]}):e.jsx(f,{severity:"info",children:t("common.noData")})}),e.jsx(ne,{children:e.jsx(p,{onClick:()=>R(!1),children:t("common.cancel")})})]}),o&&r&&i&&e.jsx(_e,{open:fe,onClose:()=>_(!1),title:`${t("k8s.deployments.title")} - ${i}`,clusterId:o,namespace:r,resourceType:"deployment",resourceName:i,onLoadYaml:async(s,n,x,b)=>{const k={clusterId:s,namespace:n};return await P.getResourceYaml(k,x,b)},onSaveYaml:async(s,n,x,b,k)=>{const M={clusterId:s,namespace:n};await P.updateResourceYaml(M,x,b,k),y()},onDryRun:async(s,n,x,b,k)=>{const M={clusterId:s,namespace:n};return await P.dryRunResourceYaml(M,x,b,k)}})]})}export{ls as default};
