import{u as Pe,r as l,H as Te,c3 as ke,bf as Oe,b4 as h,j as e,B as u,T as w,a as j,A as Re,b as re,P as Me,m as p,s as Fe,t as Ee,d as D,I as C,v as Le,g as Ue,dp as Ne,aa as He,h as Be,i as H,k as B,l as q,F as ne,n as ie,o as le,M as m,Y as J,aD as oe,y as qe,p as K,a7 as y}from"./index-STo1oTDL.js";import{T as Je,a as Ke,b as Ve,c as P,d as i,e as Xe}from"./TableRow-e9fRaRV7.js";import{C as v}from"./Chip-v5QMYL72.js";import{T as Ye}from"./TablePagination-u_lqWu4q.js";import"./LastPage-Bb7RE8XJ.js";function es(){const{t:a}=Pe(),[V,de]=l.useState([]),[ce,ue]=l.useState(0),[T,k]=l.useState(0),[O,he]=l.useState(10),[R,xe]=l.useState(""),[me,X]=l.useState(!1),[pe,M]=l.useState(!1),[ge,Y]=l.useState(!1),[je,A]=l.useState(!1),[S,_]=l.useState("create"),[x,F]=l.useState({}),[fe,$]=l.useState(""),[E,L]=l.useState(""),[G,d]=l.useState(""),[I,Q]=l.useState([]),[W,Z]=l.useState([]),[r,c]=l.useState({username:"",password:"",email:"",fullName:"",role:"user",roleIds:[],authMethod:"password",expiresAt:"",autoDisableOnExpiry:!0,organizationId:""}),f=JSON.parse(localStorage.getItem("user")||"{}");console.log("当前登录用户:",f),console.log("当前用户角色:",f.role),console.log("用户对象的所有属性:",Object.keys(f)),console.log("localStorage中的用户数据:",localStorage.getItem("user"));const ee=l.useCallback(async()=>{try{const s=await Te.get("/api/roles"),t=s.data?.data||s.data||[],n=Array.isArray(t)?t:[];Q(n.map(o=>({id:o.id,name:o.name}))),console.log("加载的角色列表:",n)}catch(s){console.error("加载角色列表失败:",s),Q([])}},[]),b=l.useCallback(s=>{let t=[];return s.forEach(n=>{n.unitType==="Department"&&t.push(n),n.children&&n.children.length>0&&(t=t.concat(b(n.children)))}),t},[]),se=l.useCallback(async()=>{try{const s=await ke.getOrganizationTree(),t=Array.isArray(s)?s:[];Z(t);const n=b(t);console.log("✅ 部门列表加载成功，共",n.length,"个部门"),n.length===0&&console.warn("⚠️ 未找到任何部门，请先在部门管理中创建部门")}catch(s){const t=s,n=t?.response?.data?.message||t?.message||"加载部门列表失败";console.error("❌ 加载部门列表失败:",s),Z([]),Oe(n)}},[b]),be=s=>{if(!s)return"-";const t=(o,ze)=>{for(const z of ze){if(z.id===o)return z;if(z.children){const te=t(o,z.children);if(te)return te}}return null},n=t(s,W);return n?n.unitName:"-"},g=l.useCallback(async()=>{X(!0),d("");try{const s=await h.getUsersWithRoles({page:T+1,pageSize:O,keyword:R||void 0});de(s.users||[]),ue(s.total||0)}catch(s){const t=s;console.error("加载用户列表失败:",s),d(t.response?.data?.message||a("users.loadUsersFailed"))}finally{X(!1)}},[T,O,R,a]);l.useEffect(()=>{ee(),se(),g()},[ee,se,g]);const ae=()=>{k(0),g()},we=()=>{_("create"),c({username:"",password:"",email:"",fullName:"",role:"user",roleIds:[],authMethod:"password",expiresAt:"",autoDisableOnExpiry:!0,organizationId:void 0}),M(!0)},ye=async s=>{_("edit"),F(s);const t=s.authMethod==="both"?"password":s.authMethod||"password",n=s.roles?.map(o=>o.id)||[];c({username:s.username,password:"",email:s.email||"",fullName:s.fullName||"",role:s.role,roleIds:n,authMethod:t,expiresAt:s.expiresAt?s.expiresAt.substring(0,16):"",autoDisableOnExpiry:s.autoDisableOnExpiry!==void 0?s.autoDisableOnExpiry:!0,organizationId:s.organizationId||void 0}),M(!0)},U=()=>{M(!1),F({}),c({username:"",password:"",email:"",fullName:"",role:"user",roleIds:[],authMethod:"password",expiresAt:"",autoDisableOnExpiry:!0,organizationId:void 0}),d("")},ve=async()=>{try{if(S==="create"){const s={...r,expiresAt:r.expiresAt?new Date(r.expiresAt).toISOString():void 0,organizationId:r.organizationId&&r.organizationId.trim()!==""?r.organizationId:void 0},{roleIds:t,...n}=s,o=await h.createUser(n);r.roleIds.length>0&&o.id&&await h.assignRoles(o.id,r.roleIds),y(a("users.createSuccess"))}else{const s={fullName:r.fullName,email:r.email,expiresAt:r.expiresAt?new Date(r.expiresAt).toISOString():"",autoDisableOnExpiry:r.autoDisableOnExpiry,organizationId:r.organizationId&&r.organizationId.trim()!==""?r.organizationId:void 0};await h.updateUser(x.id,s),r.role!==x.role&&await h.updateUserRole(x.id,r.role);const t=x.roles?.map(o=>o.id)||[];JSON.stringify([...r.roleIds].sort())!==JSON.stringify([...t].sort())&&await h.assignRoles(x.id,r.roleIds),r.authMethod!==x.authMethod&&await h.updateUserAuthMethod(x.id,r.authMethod),y(a("users.updateSuccess"))}U(),g()}catch(s){const t=s;console.error("操作失败:",s),d(t.response?.data?.message||a("users.operationFailed"))}},Se=async s=>{if(s.id===f.id){d(a("users.cannotDeleteSelf"));return}if(window.confirm(a("users.deleteConfirm",{username:s.username})))try{await h.deleteUser(s.id),y(a("users.deleteSuccess")),g()}catch(t){const n=t;console.error("删除失败:",t),d(n.response?.data?.message||a("users.deleteFailed"))}},Ie=s=>{F(s),A(!0)},De=async()=>{if(x.id)try{await h.resetUser2FA(x.id),y(a("users.reset2FASuccess")),A(!1),g()}catch(s){const t=s;console.error("重置2FA失败:",s),d(t.response?.data?.message||a("users.reset2FAFailed"))}},Ce=async s=>{if(s.id===f.id){d(a("users.cannotDisableSelf"));return}const t=s.status==="active"?"inactive":"active";try{await h.updateUserStatus(s.id,t),y(a(t==="active"?"users.enabledSuccess":"users.disabledSuccess")),g()}catch(n){const o=n;console.error("状态切换失败:",n),d(o.response?.data?.message||"状态切换失败")}},Ae=s=>{$(s),L(""),Y(!0)},N=()=>{Y(!1),$(""),L("")},We=async()=>{if(E.length<6){d(a("users.passwordMinLength"));return}try{await h.resetPassword(fe,E),y(a("users.resetPasswordSuccess")),N()}catch(s){const t=s;console.error("重置密码失败:",s),d(t.response?.data?.message||a("users.resetPasswordFailed"))}};return e.jsxs(u,{children:[e.jsxs(u,{sx:{mb:3,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(w,{variant:"h4",sx:{fontWeight:600},children:a("users.title")}),e.jsx(j,{variant:"contained",startIcon:e.jsx(Re,{}),onClick:we,sx:{borderRadius:2},children:a("users.createUser")})]}),G&&e.jsx(re,{severity:"error",sx:{mb:2},onClose:()=>d(""),children:G}),e.jsxs(Me,{sx:{p:3,borderRadius:2},children:[e.jsxs(u,{sx:{mb:3,display:"flex",gap:2},children:[e.jsx(p,{size:"small",placeholder:a("users.searchPlaceholder"),value:R,onChange:s=>xe(s.target.value),onKeyPress:s=>s.key==="Enter"&&ae(),sx:{flex:1},InputProps:{startAdornment:e.jsx(Fe,{position:"start",children:e.jsx(Ee,{})})}}),e.jsx(j,{variant:"outlined",onClick:ae,children:a("common.search")}),e.jsx(D,{title:a("common.refresh"),children:e.jsx(C,{onClick:g,children:e.jsx(Le,{})})})]}),e.jsx(Je,{sx:{maxHeight:"calc(100vh - 300px)",overflowX:"auto"},children:e.jsxs(Ke,{stickyHeader:!0,children:[e.jsx(Ve,{children:e.jsxs(P,{children:[e.jsx(i,{sx:{minWidth:150},children:a("users.username")}),e.jsx(i,{sx:{minWidth:150},children:a("users.name")}),e.jsx(i,{sx:{minWidth:200},children:a("users.email")}),e.jsx(i,{sx:{minWidth:150},children:a("users.department","部门")}),e.jsx(i,{sx:{minWidth:250},children:a("users.roles","角色")}),e.jsx(i,{sx:{minWidth:120},children:a("common.status")}),e.jsx(i,{sx:{minWidth:200},children:a("users.expirationTime")}),e.jsx(i,{sx:{minWidth:200},children:a("users.lastLoginTime")}),e.jsx(i,{sx:{minWidth:150},children:a("users.lastLoginIP")}),e.jsx(i,{sx:{minWidth:200},children:a("common.createdAt")}),e.jsx(i,{align:"right",sx:{minWidth:150,position:"sticky",right:0,backgroundColor:"background.paper",zIndex:10,boxShadow:"-2px 0 4px rgba(0,0,0,0.1)"},children:a("common.actions")})]})}),e.jsx(Xe,{children:me?e.jsx(P,{children:e.jsx(i,{colSpan:12,align:"center",children:a("common.loading")})}):V.length===0?e.jsx(P,{children:e.jsx(i,{colSpan:12,align:"center",children:a("common.noData")})}):V.map(s=>e.jsxs(P,{hover:!0,children:[e.jsx(i,{sx:{minWidth:150},children:s.username}),e.jsx(i,{sx:{minWidth:150},children:s.fullName||"-"}),e.jsx(i,{sx:{minWidth:200},children:s.email||"-"}),e.jsx(i,{sx:{minWidth:150},children:be(s.organizationId)}),e.jsx(i,{sx:{minWidth:250},children:e.jsx(u,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.roles&&s.roles.length>0?s.roles.map(t=>e.jsx(v,{label:t.name,size:"small",color:"secondary"},t.id)):e.jsx(w,{variant:"caption",color:"text.secondary",children:a("users.noRoles")})})}),e.jsx(i,{sx:{minWidth:120},children:e.jsx(v,{label:s.status==="active"?a("common.enabled"):a("common.disabled"),color:s.status==="active"?"success":"default",size:"small",onClick:()=>Ce(s),sx:{cursor:"pointer"}})}),e.jsx(i,{sx:{minWidth:200},children:s.expiresAt?e.jsxs(u,{children:[e.jsx(w,{variant:"body2",children:new Date(s.expiresAt).toLocaleString()}),new Date(s.expiresAt)<new Date&&e.jsx(v,{label:a("users.expired"),color:"error",size:"small",sx:{mt:.5}}),new Date(s.expiresAt)>new Date&&new Date(s.expiresAt).getTime()-new Date().getTime()<10080*60*1e3&&e.jsx(v,{label:a("users.expiringSoon"),color:"warning",size:"small",sx:{mt:.5}})]}):e.jsx(v,{label:a("users.neverExpires"),color:"default",size:"small"})}),e.jsx(i,{sx:{minWidth:200},children:s.lastLoginTime?new Date(s.lastLoginTime).toLocaleString():"-"}),e.jsx(i,{sx:{minWidth:150},children:s.lastLoginIp||"-"}),e.jsx(i,{sx:{minWidth:200},children:new Date(s.createdAt).toLocaleString()}),e.jsx(i,{align:"right",sx:{minWidth:150,position:"sticky",right:0,backgroundColor:"background.paper",zIndex:9,boxShadow:"-2px 0 4px rgba(0,0,0,0.1)"},children:e.jsxs(u,{sx:{display:"flex",flexDirection:"column",gap:.5,alignItems:"flex-end"},children:[e.jsxs(u,{sx:{display:"flex",gap:.5},children:[e.jsx(D,{title:a("common.edit"),children:e.jsx(C,{size:"small",onClick:()=>ye(s),children:e.jsx(Ue,{fontSize:"small"})})}),e.jsx(D,{title:a("users.resetPassword"),children:e.jsx(C,{size:"small",onClick:()=>Ae(s.id),children:e.jsx(Ne,{fontSize:"small"})})})]}),e.jsxs(u,{sx:{display:"flex",gap:.5},children:[e.jsx(D,{title:a("users.reset2FA"),children:e.jsx(C,{size:"small",onClick:()=>Ie(s),color:"warning",children:e.jsx(He,{fontSize:"small"})})}),e.jsx(D,{title:a("common.delete"),children:e.jsx("span",{children:e.jsx(C,{size:"small",onClick:()=>Se(s),disabled:s.id===f.id,children:e.jsx(Be,{fontSize:"small"})})})})]})]})})]},s.id))})]})}),e.jsx(Ye,{component:"div",count:ce,page:T,onPageChange:(s,t)=>k(t),rowsPerPage:O,onRowsPerPageChange:s=>{he(parseInt(s.target.value,10)),k(0)},rowsPerPageOptions:[10,25,50,100],labelRowsPerPage:`${a("common.rowsPerPage")}:`,labelDisplayedRows:({from:s,to:t,count:n})=>n!==-1?a("common.displayedRows",{from:s,to:t,count:n}):a("common.displayedRowsMore",{from:s,to:t}),sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]}),e.jsxs(H,{open:pe,onClose:U,maxWidth:"sm",fullWidth:!0,children:[e.jsx(B,{children:a(S==="create"?"users.addUser":"users.editUser")}),e.jsx(q,{children:e.jsxs(u,{sx:{pt:2,display:"flex",flexDirection:"column",gap:2},children:[e.jsx(p,{label:a("users.username"),value:r.username,onChange:s=>c({...r,username:s.target.value}),required:!0,fullWidth:!0,disabled:S==="edit"}),S==="create"&&e.jsx(p,{label:a("users.password"),type:"password",value:r.password,onChange:s=>c({...r,password:s.target.value}),required:!0,fullWidth:!0,helperText:a("users.passwordMinLength")}),e.jsx(p,{label:a("users.name"),value:r.fullName,onChange:s=>c({...r,fullName:s.target.value}),fullWidth:!0}),e.jsx(p,{label:a("users.email"),type:"email",value:r.email,onChange:s=>c({...r,email:s.target.value}),required:!0,fullWidth:!0}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(ie,{children:a("users.department","部门")}),e.jsxs(le,{value:r.organizationId||"",onChange:s=>c({...r,organizationId:s.target.value||void 0}),input:e.jsx(oe,{label:a("users.department","部门")}),children:[e.jsx(m,{value:"",children:e.jsx("em",{children:a("users.noDepartment","未选择部门")})}),b(W).length===0?e.jsx(m,{disabled:!0,children:e.jsx(J,{primary:a("users.noDepartmentsAvailable","暂无可用部门，请先在部门管理中创建部门")})}):b(W).map(s=>e.jsx(m,{value:s.id,children:s.unitName},s.id))]}),b(W).length===0&&e.jsx(w,{variant:"caption",color:"warning.main",sx:{mt:.5},children:a("users.noDepartmentsHint","提示：请先在「部门管理」页面创建部门")})]}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(ie,{children:a("users.roles","角色")}),e.jsx(le,{multiple:!0,value:r.roleIds,onChange:s=>{const t=typeof s.target.value=="string"?s.target.value.split(","):s.target.value;console.log("选择角色变化:",t,"当前角色列表:",I),c({...r,roleIds:t})},input:e.jsx(oe,{label:a("users.roles","角色")}),renderValue:s=>s.length===0?e.jsx(w,{variant:"body2",color:"text.secondary",children:a("users.noRolesSelected","未选择")}):e.jsx(u,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.map(t=>{const n=I.find(o=>o.id===t);return e.jsx(v,{label:n?.name||t,size:"small"},t)})}),children:I.length===0?e.jsx(m,{disabled:!0,children:e.jsx(J,{primary:a("users.noRolesAvailable","暂无可用角色，请先在角色管理中创建角色")})}):I.map(s=>e.jsxs(m,{value:s.id,children:[e.jsx(qe,{checked:r.roleIds.indexOf(s.id)>-1}),e.jsx(J,{primary:s.name})]},s.id))}),I.length===0&&e.jsx(w,{variant:"caption",color:"error",sx:{mt:.5},children:a("users.noRolesHint","提示：请先在「角色管理」页面创建角色")})]}),e.jsxs(p,{label:a("users.authMethod"),select:!0,value:r.authMethod,onChange:s=>c({...r,authMethod:s.target.value}),fullWidth:!0,helperText:a("users.authMethodHelper"),children:[e.jsx(m,{value:"password",children:a("users.authPassword")}),e.jsx(m,{value:"publickey",children:a("users.authPublickey")}),e.jsx(m,{value:"both",children:a("users.bothAuth")})]}),e.jsx(p,{label:a("users.expiresAt"),type:"datetime-local",value:r.expiresAt,onChange:s=>c({...r,expiresAt:s.target.value}),fullWidth:!0,InputLabelProps:{shrink:!0},helperText:a("users.expiresAtHelper")}),e.jsxs(p,{label:a("users.autoDisableOnExpiry"),select:!0,value:r.autoDisableOnExpiry?"true":"false",onChange:s=>c({...r,autoDisableOnExpiry:s.target.value==="true"}),fullWidth:!0,helperText:a("users.autoDisableOnExpiryHelper"),children:[e.jsx(m,{value:"true",children:a("users.yes")}),e.jsx(m,{value:"false",children:a("users.no")})]})]})}),e.jsxs(K,{children:[e.jsx(j,{onClick:U,children:a("common.cancel")}),e.jsx(j,{onClick:ve,variant:"contained",children:a(S==="create"?"common.create":"common.save")})]})]}),e.jsxs(H,{open:ge,onClose:N,maxWidth:"sm",fullWidth:!0,children:[e.jsx(B,{children:a("users.resetPassword")}),e.jsx(q,{children:e.jsx(u,{sx:{pt:2},children:e.jsx(p,{label:a("users.newPassword"),type:"password",value:E,onChange:s=>L(s.target.value),required:!0,fullWidth:!0,helperText:a("users.passwordMinLength")})})}),e.jsxs(K,{children:[e.jsx(j,{onClick:N,children:a("common.cancel")}),e.jsx(j,{onClick:We,variant:"contained",children:a("users.resetPassword")})]})]}),e.jsxs(H,{open:je,onClose:()=>A(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(B,{children:"重置用户2FA"}),e.jsx(q,{children:e.jsx(u,{sx:{pt:2},children:e.jsxs(re,{severity:"warning",sx:{mb:2},children:["确定要重置用户 ",e.jsx("strong",{children:x.username})," 的2FA设置吗？",e.jsx("br",{}),"此操作将清除用户的2FA密钥和备用码，用户需要重新设置2FA。"]})})}),e.jsxs(K,{children:[e.jsx(j,{onClick:()=>A(!1),children:"取消"}),e.jsx(j,{onClick:De,color:"error",variant:"contained",children:"确认重置"})]})]})]})}export{es as default};
