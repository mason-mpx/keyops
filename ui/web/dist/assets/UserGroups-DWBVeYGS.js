import{u as ee,r as a,H as c,j as e,B as m,w as S,x as w,T as i,J as U,ac as F,P as se,a as p,A as te,O as re,I as k,dc as ae,g as le,h as oe,i as B,k as z,l as E,m as A,F as ne,n as ie,o as ce,M as L,p as $,W as de,b6 as me,b7 as xe,y as ue,Y as he,D as je,b as pe}from"./index-CJIrazW8.js";import{T as ge,a as fe,b as be,c as H,d as o,e as ye}from"./TableRow-JrGpygSA.js";import{C as V}from"./Chip-Bh8gAKTq.js";import{S as ve}from"./Snackbar-Cu58JEDO.js";const Ae=()=>{const{t}=ee(),[g,I]=a.useState([]),[,R]=a.useState(!1),[P,x]=a.useState(!1),[G,f]=a.useState(!1),[y,M]=a.useState(null),[b,q]=a.useState(null),[J,D]=a.useState([]),[v,T]=a.useState([]),[u,l]=a.useState({open:!1,message:"",severity:"success"}),[n,d]=a.useState({name:"",description:"",color:"#1890ff",priority:0,status:"active"}),h=a.useCallback(async()=>{R(!0);try{const s=await c.get("/api/roles?withMembers=true"),r=s.data?.data||s.data;I(Array.isArray(r)?r:[])}catch(s){l({open:!0,message:s.message||t("roles.loadRolesFailed"),severity:"error"}),I([])}finally{R(!1)}},[t]),W=a.useCallback(async()=>{try{const s=await c.get("/api/users"),r=s.data?.data?.users||s.data?.data||s.data;D(Array.isArray(r)?r:[])}catch(s){l({open:!0,message:s.message||t("roles.loadUsersFailed"),severity:"error"}),D([])}},[t]);a.useEffect(()=>{h(),W()},[h,W]);const N=()=>{M(null),d({name:"",description:"",color:"#1890ff",priority:0,status:"active"}),x(!0)},O=s=>{M(s),d({name:s.name,description:s.description||"",color:s.color||"#1890ff",priority:s.priority,status:s.status}),x(!0)},Y=async s=>{if(window.confirm(t("roles.deleteConfirm")))try{await c.delete(`/api/roles/${s}`),l({open:!0,message:t("roles.deleteSuccess"),severity:"success"}),h()}catch(r){l({open:!0,message:r.message||t("roles.deleteFailed"),severity:"error"})}},K=async()=>{try{y?(await c.put(`/api/roles/${y.id}`,n),l({open:!0,message:t("roles.updateSuccess"),severity:"success"})):(await c.post("/api/roles",n),l({open:!0,message:t("roles.createSuccess"),severity:"success"})),x(!1),h()}catch(s){l({open:!0,message:s.message||t("common.error"),severity:"error"})}},Q=async s=>{q(s);try{const j=(await c.get(`/api/roles/${s.id}?withMembers=true`)).data;T(j.members?.map(_=>_.id)||[]),f(!0)}catch(r){l({open:!0,message:r.message||t("roles.memberUpdateFailed"),severity:"error"})}},X=s=>{T(r=>r.includes(s)?r.filter(j=>j!==s):[...r,s])},Z=async()=>{if(b)try{await c.post(`/api/roles/${b.id}/members/batch`,{userIds:v}),l({open:!0,message:t("roles.memberUpdateSuccess"),severity:"success"}),f(!1),h()}catch(s){l({open:!0,message:s.message||t("roles.memberUpdateFailed"),severity:"error"})}},C={total:g.length,active:g.filter(s=>s.status==="active").length,totalMembers:g.reduce((s,r)=>s+(r.memberCount||0),0)};return e.jsxs(m,{sx:{p:3},children:[e.jsxs(m,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap"},children:[e.jsx(S,{sx:{flex:"1 1 0",minWidth:200},children:e.jsxs(w,{children:[e.jsx(i,{color:"textSecondary",gutterBottom:!0,children:t("roles.total")}),e.jsxs(i,{variant:"h4",children:[e.jsx(U,{sx:{mr:1,verticalAlign:"middle"}}),C.total]})]})}),e.jsx(S,{sx:{flex:"1 1 0",minWidth:200},children:e.jsxs(w,{children:[e.jsx(i,{color:"textSecondary",gutterBottom:!0,children:t("roles.activeCount")}),e.jsx(i,{variant:"h4",color:"success.main",children:C.active})]})}),e.jsx(S,{sx:{flex:"1 1 0",minWidth:200},children:e.jsxs(w,{children:[e.jsx(i,{color:"textSecondary",gutterBottom:!0,children:t("roles.totalMembers")}),e.jsxs(i,{variant:"h4",children:[e.jsx(F,{sx:{mr:1,verticalAlign:"middle"}}),C.totalMembers]})]})})]}),e.jsxs(se,{sx:{p:2},children:[e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[e.jsx(i,{variant:"h6",children:t("roles.title")}),e.jsx(p,{variant:"contained",startIcon:e.jsx(te,{}),onClick:N,children:t("roles.addRole")})]}),e.jsx(ge,{children:e.jsxs(fe,{children:[e.jsx(be,{children:e.jsxs(H,{children:[e.jsx(o,{children:t("roles.name")}),e.jsx(o,{children:t("roles.memberCount")}),e.jsx(o,{children:t("roles.description")}),e.jsx(o,{children:t("roles.status")}),e.jsx(o,{children:t("common.createdAt")}),e.jsx(o,{children:t("common.actions")})]})}),e.jsx(ye,{children:g.map(s=>e.jsxs(H,{children:[e.jsx(o,{children:e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(re,{sx:{bgcolor:s.color||"#1890ff",width:32,height:32},children:e.jsx(U,{fontSize:"small"})}),s.name]})}),e.jsx(o,{children:e.jsx(V,{icon:e.jsx(F,{}),label:`${s.memberCount||0} ${t("roles.membersUnit")}`,size:"small",color:"info"})}),e.jsx(o,{children:s.description}),e.jsx(o,{children:e.jsx(V,{label:s.status==="active"?t("roles.active"):t("roles.inactive"),size:"small",color:s.status==="active"?"success":"default"})}),e.jsx(o,{children:new Date(s.createdAt).toLocaleString()}),e.jsxs(o,{children:[e.jsx(k,{size:"small",color:"info",onClick:()=>Q(s),children:e.jsx(ae,{})}),e.jsx(k,{size:"small",color:"primary",onClick:()=>O(s),children:e.jsx(le,{})}),e.jsx(k,{size:"small",color:"error",onClick:()=>Y(s.id),children:e.jsx(oe,{})})]})]},s.id))})]})})]}),e.jsxs(B,{open:P,onClose:()=>x(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(z,{children:t(y?"roles.editRole":"roles.addRole")}),e.jsx(E,{children:e.jsxs(m,{sx:{display:"flex",flexDirection:"column",gap:2.5,pt:2},children:[e.jsx(A,{fullWidth:!0,label:t("roles.name"),value:n.name,onChange:s=>d({...n,name:s.target.value}),required:!0}),e.jsx(A,{fullWidth:!0,multiline:!0,rows:3,label:t("roles.description"),value:n.description,onChange:s=>d({...n,description:s.target.value})}),e.jsx(A,{fullWidth:!0,type:"color",label:t("roles.color"),value:n.color,onChange:s=>d({...n,color:s.target.value})}),e.jsxs(ne,{fullWidth:!0,children:[e.jsx(ie,{children:t("roles.status")}),e.jsxs(ce,{value:n.status,onChange:s=>d({...n,status:s.target.value}),label:t("roles.status"),children:[e.jsx(L,{value:"active",children:t("roles.active")}),e.jsx(L,{value:"inactive",children:t("roles.inactive")})]})]})]})}),e.jsxs($,{children:[e.jsx(p,{onClick:()=>x(!1),children:t("common.cancel")}),e.jsx(p,{variant:"contained",onClick:K,children:t("common.confirm")})]})]}),e.jsxs(B,{open:G,onClose:()=>f(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(z,{children:[t("roles.manageMembers")," - ",b?.name]}),e.jsxs(E,{children:[e.jsx(i,{variant:"body2",color:"textSecondary",sx:{mb:2},children:t("roles.selectUsers")}),e.jsx(de,{sx:{bgcolor:"background.paper",maxHeight:400,overflow:"auto"},children:J.map(s=>e.jsxs(me.Fragment,{children:[e.jsxs(xe,{onClick:()=>X(s.id),dense:!0,children:[e.jsx(ue,{edge:"start",checked:v.includes(s.id),tabIndex:-1,disableRipple:!0}),e.jsx(he,{primary:s.username,secondary:s.fullName||s.email||""})]}),e.jsx(je,{})]},s.id))}),b&&e.jsx(m,{sx:{mt:2,p:2,bgcolor:"grey.100",borderRadius:1},children:e.jsx(i,{variant:"caption",color:"textSecondary",children:t("roles.selectedCount",{count:v.length})})})]}),e.jsxs($,{children:[e.jsx(p,{onClick:()=>f(!1),children:t("common.cancel")}),e.jsx(p,{variant:"contained",onClick:Z,children:t("common.confirm")})]})]}),e.jsx(ve,{open:u.open,autoHideDuration:3e3,onClose:()=>l({...u,open:!1}),children:e.jsx(pe,{severity:u.severity,onClose:()=>l({...u,open:!1}),children:u.message})})]})};export{Ae as default};
