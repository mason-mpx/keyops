import{u as he,b1 as pe,r as d,aR as xe,j as a,B as A,C as we,b as be,a as Se,P as ue,d as Ee,I as me,aY as ve,aZ as Ce,ax as ke,b2 as Re,ay as Fe,az as Te,aA as _e,T as ae,aq as Ne,a3 as We,a4 as Oe,aB as Ie,z as je}from"./index-wVs8DYHr.js";import{x as Le,a as Pe}from"./xterm-BqYE0GQX.js";import{c as ze,a as De}from"./websocket-D_jojiQE.js";import{G as oe}from"./guacamole-common-DCnKliOq.js";import{H as He}from"./HostTree-MkF_tKhX.js";import"./Chip-DzNpApxT.js";var fe={exports:{}},ye;function Be(){return ye||(ye=1,(function(V,Y){(function(R,m){V.exports=m()})(self,(()=>(()=>{var R={6:(W,H)=>{Object.defineProperty(H,"__esModule",{value:!0}),H.LinkComputer=H.WebLinkProvider=void 0,H.WebLinkProvider=class{constructor(U,f,E,h={}){this._terminal=U,this._regex=f,this._handler=E,this._options=h}provideLinks(U,f){const E=T.computeLink(U,this._regex,this._terminal,this._handler);f(this._addCallbacks(E))}_addCallbacks(U){return U.map((f=>(f.leave=this._options.leave,f.hover=(E,h)=>{if(this._options.hover){const{range:L}=f;this._options.hover(E,h,L)}},f)))}};class T{static computeLink(f,E,h,L){const p=new RegExp(E.source,(E.flags||"")+"g"),[y,C]=T._getWindowedLineStrings(f-1,h),F=y.join("");let v;const O=[];for(;v=p.exec(F);){const B=v[0];try{const Q=new URL(B),K=decodeURI(Q.toString());if(B!==K&&B+"/"!==K)continue}catch{continue}const[D,G]=T._mapStrIdx(h,C,0,v.index),[M,J]=T._mapStrIdx(h,D,G,B.length);if(D===-1||G===-1||M===-1||J===-1)continue;const $={start:{x:G+1,y:D+1},end:{x:J,y:M+1}};O.push({range:$,text:B,activate:L})}return O}static _getWindowedLineStrings(f,E){let h,L=f,p=f,y=0,C="";const F=[];if(h=E.buffer.active.getLine(f)){const v=h.translateToString(!0);if(h.isWrapped&&v[0]!==" "){for(y=0;(h=E.buffer.active.getLine(--L))&&y<2048&&(C=h.translateToString(!0),y+=C.length,F.push(C),h.isWrapped&&C.indexOf(" ")===-1););F.reverse()}for(F.push(v),y=0;(h=E.buffer.active.getLine(++p))&&h.isWrapped&&y<2048&&(C=h.translateToString(!0),y+=C.length,F.push(C),C.indexOf(" ")===-1););}return[F,L]}static _mapStrIdx(f,E,h,L){const p=f.buffer.active,y=p.getNullCell();let C=h;for(;L;){const F=p.getLine(E);if(!F)return[-1,-1];for(let v=C;v<F.length;++v){F.getCell(v,y);const O=y.getChars();if(y.getWidth()&&(L-=O.length||1,v===F.length-1&&O==="")){const B=p.getLine(E+1);B&&B.isWrapped&&(B.getCell(0,y),y.getWidth()===2&&(L+=1))}if(L<0)return[E,v]}E++,C=0}return[E,C]}}H.LinkComputer=T}},m={};function j(W){var H=m[W];if(H!==void 0)return H.exports;var T=m[W]={exports:{}};return R[W](T,T.exports,j),T.exports}var z={};return(()=>{var W=z;Object.defineProperty(W,"__esModule",{value:!0}),W.WebLinksAddon=void 0;const H=j(6),T=/https?:[/]{2}[^\s"'!*(){}|\\\^<>`]*[^\s"':,.!?{}|\\\^~\[\]`()<>]/;function U(f,E){const h=window.open();if(h){try{h.opener=null}catch{}h.location.href=E}else console.warn("Opening link blocked as opener could not be cleared")}W.WebLinksAddon=class{constructor(f=U,E={}){this._handler=f,this._options=E}activate(f){this._terminal=f;const E=this._options,h=E.urlRegex||T;this._linkProvider=this._terminal.registerLinkProvider(new H.WebLinkProvider(this._terminal,h,this._handler,E))}dispose(){var f;(f=this._linkProvider)===null||f===void 0||f.dispose()}}})(),z})()))})(fe)),fe.exports}var Ae=Be();function Me({hostId:V,host:Y,sessionId:R,systemUserId:m,onClose:j}){const{t:z}=he(),{getWebSocket:W,setWebSocket:H,updateLastActive:T}=pe(),U=d.useRef(null),f=d.useRef(null),E=d.useRef(null),h=d.useRef(null),[L,p]=d.useState(!0),[y,C]=d.useState(null),[F,v]=d.useState(Y||null),[O,B]=d.useState(!1),D=d.useRef(null),G=d.useRef(null),M=d.useRef(!1),J=d.useRef(!1),$=d.useRef(null),Q=d.useRef(null),K=d.useRef(null),P=d.useRef(null);d.useEffect(()=>{Y?v(Y):F||xe(async()=>{const{mockHosts:e}=await import("./mockData-C1akHryx.js");return{mockHosts:e}},[]).then(({mockHosts:e})=>{const n=e.find(u=>u.id===V);n&&v(n)})},[V,Y]);const ee=d.useRef(new WeakSet),q=d.useCallback((e,n,u)=>{ee.current.has(e)||(ee.current.add(e),P.current&&(clearTimeout(P.current),P.current=null),P.current=setTimeout(()=>{if(!J.current&&e.readyState===WebSocket.OPEN){const r="连接超时：35秒内未收到任何数据，请检查主机配置和认证信息";console.error("[Terminal] Connection timeout:",r),$.current=r,C(r),p(!1),n.writeln(`\r
\r
\x1B[31m❌ 连接超时\x1B[0m`),n.writeln(`\x1B[31m${r}\x1B[0m`),n.writeln("\x1B[36m提示: 可以关闭此标签页或尝试重新连接\x1B[0m"),e.close()}},35e3),e.onopen=()=>{M.current=!0,p(!1),$.current=null,C(null),n.writeln(`\r
✓ WebSocket 连接已建立，正在建立会话...`),n.refresh(0,n.rows-1),e.send(JSON.stringify({type:"init",cols:n.cols,rows:n.rows})),K.current=setInterval(()=>{e.readyState===WebSocket.OPEN&&e.send(JSON.stringify({type:"ping"}))},3e4)},e.onmessage=r=>{P.current&&(clearTimeout(P.current),P.current=null);try{const o=JSON.parse(r.data);o.type==="output"?(J.current=!0,n.write(o.data)):o.type==="error"?(console.error("[Terminal] Received error message:",o.message),n.writeln(`\r
${z("common.error")}: ${o.message}`),$.current=o.message,C(o.message)):o.type==="info"?n.writeln(o.message):o.type==="data"&&(J.current=!0,n.write(o.data))}catch{J.current=!0,n.write(r.data)}},e.onerror=r=>{console.error("[Terminal] WebSocket error:",r),P.current&&(clearTimeout(P.current),P.current=null);const o="WebSocket连接错误，请检查网络连接或联系管理员";console.error("[Terminal] WebSocket connection error:",o),$.current=o,C(o),p(!1),f.current&&(f.current.writeln(`\r
\r
\x1B[31m❌ WebSocket连接错误\x1B[0m`),f.current.writeln(`\x1B[31m${o}\x1B[0m`))},e.onclose=r=>{if(p(!1),P.current&&(clearTimeout(P.current),P.current=null),K.current&&(clearInterval(K.current),K.current=null),e.__userClosed===!0)n.writeln(`\r
\r
连接已关闭`),j&&setTimeout(j,500);else{if(console.error("[Terminal] Connection closed unexpectedly:",{code:r.code,reason:r.reason||"Unknown reason",wasClean:r.wasClean}),n.writeln(`\r
\r
\x1B[31m❌ 连接已断开\x1B[0m`),$.current)n.writeln(`\x1B[31m${$.current}\x1B[0m`);else{let x="连接失败",w="";r.code===1006?(x="连接异常关闭",w="可能原因：网络问题、服务器拒绝连接或认证失败"):r.code===1e3?x="连接正常关闭":r.code===1001?(x="连接已断开（端点不可达）",w="服务器可能已关闭或网络不可达"):r.code===1002?(x="协议错误",w="WebSocket协议错误，请检查服务器配置"):r.code===1003?x="不支持的数据类型":r.code===1008?(x="策略违规",w="服务器拒绝了连接请求"):r.code===1011?(x="服务器错误",w="服务器内部错误，请稍后重试"):(x=`连接关闭 (代码: ${r.code})`,r.reason&&(w=`原因: ${r.reason}`));const I=w?`${x}
${w}`:x;$.current=I,C(I),n.writeln(`\x1B[31m${x}\x1B[0m`),w&&n.writeln(`\x1B[33m${w}\x1B[0m`)}n.writeln(`\r
\x1B[36m提示: 可以关闭此标签页或尝试重新连接\x1B[0m`)}},n.onData(r=>{T(R),e.readyState===WebSocket.OPEN&&e.send(JSON.stringify({type:"input",data:r}))}))},[j,R,T]),le=d.useCallback(async(e,n)=>{try{const u=W(R);if(u&&u.readyState===WebSocket.OPEN){h.current=u,q(u,e,n),p(!1),M.current=!0,e.writeln("连接已恢复"),e.writeln("");return}const r=await ze(n.id,m),o=new WebSocket(r);h.current=o,H(R,o),q(o,e,n)}catch(u){console.error("[Terminal] Failed to create WebSocket connection:",u);const o=`连接失败: ${u.message||"未知错误"}`;console.error("[Terminal] Connection error details:",o),$.current=o,C(o),p(!1),f.current&&(f.current.writeln(`\r
\r
\x1B[31m❌ 连接失败\x1B[0m`),f.current.writeln(`\x1B[31m${o}\x1B[0m`),f.current.writeln("\x1B[33m请检查网络连接和服务器状态\x1B[0m"))}},[R,m,W,H,q]);d.useEffect(()=>{const e=F;if(!U.current||!e)return;const n=W(R),u=!n||n.readyState===WebSocket.CLOSED,r=f.current!==null&&U.current!==null;if(Q.current===R&&!u&&r)return;if(Q.current&&(Q.current!==R||u||!r)&&(f.current&&(f.current.dispose(),f.current=null),M.current=!1,J.current=!1,$.current=null),Q.current=R,!G.current&&D.current){const i=D.current,t=window.getComputedStyle(i).height;t&&t!=="auto"&&t!=="0px"&&(G.current=t)}const o=new Le.Terminal({cursorBlink:!0,fontSize:16,fontFamily:'Menlo, Monaco, "Courier New", monospace',theme:{background:"#1e1e1e",foreground:"#d4d4d4",cursor:"#ffffff",black:"#000000",red:"#cd3131",green:"#0dbc79",yellow:"#ffd700",blue:"#2472c8",magenta:"#bc3fbc",cyan:"#11a8cd",white:"#e5e5e5",brightBlack:"#666666",brightRed:"#f14c4c",brightGreen:"#23d18b",brightYellow:"#ffff00",brightBlue:"#3b8eea",brightMagenta:"#d670d6",brightCyan:"#29b8db",brightWhite:"#ffffff"},rows:30,cols:120,allowProposedApi:!0}),x=new Pe.FitAddon,w=new Ae.WebLinksAddon;o.loadAddon(x),o.loadAddon(w),o.open(U.current),x.fit(),f.current=o,E.current=x;const I=e.protocol?De(e.protocol):"SSH";o.writeln(`正在连接到 ${e.name} (${e.ip}:${e.port})...`),o.writeln(`使用协议: ${I}`),o.writeln(""),o.refresh(0,o.rows-1),le(o,e);const S=()=>{x.fit(),h.current?.readyState===WebSocket.OPEN&&h.current.send(JSON.stringify({type:"resize",cols:o.cols,rows:o.rows}))};window.addEventListener("resize",S);const k=()=>{const i=document,s=!!(document.fullscreenElement||i.webkitFullscreenElement||i.mozFullScreenElement||i.msFullscreenElement);B(s),setTimeout(()=>{if(E.current&&f.current&&(E.current.fit(),h.current?.readyState===WebSocket.OPEN&&h.current.send(JSON.stringify({type:"resize",cols:f.current.cols,rows:f.current.rows}))),!s&&D.current){const t=D.current;t.style.width="",t.style.height="",t.style.minHeight="",t.style.maxHeight=""}},100)};return document.addEventListener("fullscreenchange",k),document.addEventListener("webkitfullscreenchange",k),document.addEventListener("mozfullscreenchange",k),document.addEventListener("MSFullscreenChange",k),()=>{window.removeEventListener("resize",S),document.removeEventListener("fullscreenchange",k),document.removeEventListener("webkitfullscreenchange",k),document.removeEventListener("mozfullscreenchange",k),document.removeEventListener("MSFullscreenChange",k),P.current&&(clearTimeout(P.current),P.current=null),K.current&&(clearInterval(K.current),K.current=null)}},[V,R]),d.useEffect(()=>{if(!O&&D.current){const e=D.current,n=setTimeout(()=>{e.style.removeProperty("width"),e.style.removeProperty("height"),e.style.removeProperty("min-height"),e.style.removeProperty("max-height"),e.style.removeProperty("top"),e.style.removeProperty("left"),e.style.removeProperty("right"),e.style.removeProperty("bottom"),G.current&&(e.style.height=G.current),E.current&&(E.current.fit(),setTimeout(()=>{E.current&&E.current.fit()},50))},150);return()=>clearTimeout(n)}},[O]),d.useEffect(()=>{if(D.current&&!G.current){const e=D.current,n=setTimeout(()=>{const r=window.getComputedStyle(e).height;r&&r!=="auto"&&r!=="0px"&&(G.current=r)},100);return()=>clearTimeout(n)}},[L,y]);const de=()=>{h.current&&(h.current.__userClosed=!0,h.current.readyState===WebSocket.OPEN&&h.current.close()),j&&j()},c=async()=>{const e=D.current;if(e)try{const n=e,u=document;if(O)document.exitFullscreen?await document.exitFullscreen():u.webkitExitFullscreen?await u.webkitExitFullscreen():u.mozCancelFullScreen?await u.mozCancelFullScreen():u.msExitFullscreen&&await u.msExitFullscreen();else{const o=window.getComputedStyle(e).height;o&&o!=="auto"&&o!=="0px"&&(G.current=o),e.requestFullscreen?await e.requestFullscreen():n.webkitRequestFullscreen?await n.webkitRequestFullscreen():n.mozRequestFullScreen?await n.mozRequestFullScreen():n.msRequestFullscreen&&await n.msRequestFullscreen()}}catch(n){console.error("Error toggling fullscreen:",n)}};return d.useEffect(()=>{if(!L){const e=setTimeout(()=>{E.current&&f.current&&(E.current.fit(),h.current?.readyState===WebSocket.OPEN&&h.current.send(JSON.stringify({type:"resize",cols:f.current.cols,rows:f.current.rows})))},50);return()=>clearTimeout(e)}},[L]),a.jsxs(A,{sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",minHeight:0},children:[L&&a.jsx(A,{display:"flex",justifyContent:"center",alignItems:"center",p:3,children:a.jsx(we,{})}),y&&a.jsx(be,{severity:"error",sx:{mb:2},action:j&&a.jsx(Se,{color:"inherit",size:"small",onClick:de,children:z("common.close")}),children:a.jsxs(A,{children:[a.jsx("strong",{children:z("terminal.connectionFailed")}),a.jsx(A,{mt:1,children:y}),a.jsx(A,{mt:1,sx:{fontSize:"0.875rem",opacity:.8},children:z("terminal.checkHostConfig")})]})}),a.jsxs(ue,{ref:D,elevation:3,sx:{p:2,backgroundColor:"#1e1e1e",display:L||y?"none":"flex",flexDirection:"column",position:"relative",flex:1,minHeight:0,overflow:"hidden",...O?{position:"fixed",top:0,left:0,right:0,bottom:0,width:"100vw",height:"100vh",zIndex:9999,borderRadius:0,p:0}:{}},children:[a.jsx(A,{sx:{position:"absolute",top:8,right:8,zIndex:100,display:"flex",gap:1},children:a.jsx(Ee,{title:O?z("common.exitFullscreen")||"退出全屏":z("common.fullscreen")||"全屏",children:a.jsx(me,{size:"small",onClick:c,color:"primary",children:O?a.jsx(ve,{}):a.jsx(Ce,{})})})}),a.jsx("div",{ref:U,style:{height:"100%",width:"100%"}})]})]})}function $e({hostId:V,host:Y}){const{t:R}=he(),m=d.useRef(null),j=d.useRef(null),z=d.useRef(null),W=d.useRef(null),[H,T]=d.useState(!0),[U,f]=d.useState(R("terminal.connecting")),[E,h]=d.useState(null),[L,p]=d.useState(Y||null),[y,C]=d.useState(!1),[F,v]=d.useState(!1),O=d.useRef(!1),B=d.useRef(!1),D=d.useRef(null),G=d.useRef(null),M=d.useRef(null),J=d.useRef(!1),$=d.useRef(null),Q=()=>{D.current=null,G.current=null},K=(c,e)=>{let n,u;const r=j.current;if(c&&c.width>0&&c.height>0)n=c.width,u=c.height;else if(r){const s=r.getBoundingClientRect();n=s.width,u=s.height}else n=window.innerWidth,u=window.innerHeight;const o=4096,x=1940,w=960,I=1024,S=720;let k,i;if(e){const s=n/u,t=2560,l=1440;let g=Math.floor(n),b=Math.floor(u);(g<t||b<l)&&(s>t/l?(g=t,b=Math.floor(t/s)):(b=l,g=Math.floor(l*s))),k=Math.min(g,o),i=Math.min(b,o),k=Math.max(I,k),i=Math.max(S,i)}else n<x||u<w?(k=x,i=w):(k=Math.max(I,Math.floor(Math.min(n,o))),i=Math.max(S,Math.floor(Math.min(u,o))));return{width:k,height:i,actualWidth:n,actualHeight:u}},P=()=>{const c=M.current?.getElement?.();if(!c)return;const e=document,n=!!(document.fullscreenElement||e.webkitFullscreenElement||e.mozFullScreenElement||e.msFullscreenElement);c.style.position="absolute",c.style.left="0",c.style.top="0",c.style.transformOrigin="top left",c.style.backgroundColor="#000",c.style.outline="none",c.style.border="none",c.style.margin="0",c.style.padding="0",c.style.zIndex="1",c.style.visibility="visible",c.style.opacity="1",c.style.display="block",c.style.overflow="hidden",n&&(c.style.width="100%",c.style.height="100%",c.style.transform=""),c.querySelectorAll("canvas").forEach(r=>{r.style.display="block",r.style.visibility="visible",r.style.opacity="1"})},ee=d.useCallback((c,e)=>{const n=M.current;if(!n?.getWidth||!n?.getHeight||!n?.scale)return;const u=n.getWidth(),r=n.getHeight();if(u<=0||r<=0)return;const o=document,x=!!(document.fullscreenElement||o.webkitFullscreenElement||o.mozFullScreenElement||o.msFullscreenElement);P();let w=u,I=r;if(D.current){const s=D.current.w,t=D.current.h;if(x)(u<s*.5||r<t*.5)&&(w=s,I=t);else{if(u<s*.3||r<t*.3)return;w=u,I=r}}const S=Math.max(c/w,e/I);let k=1;(w!==u||I!==r)&&(k=Math.max(w/u,I/r)),n.scale(S);const i=n.getElement?.();if(i){if(k!==1){const s=i.style.transform||"";if(s.includes("scale")){const t=s.match(/scale\(([^)]+)\)/);if(t){const l=parseFloat(t[1]);i.style.transform=`scale(${l*k})`}else i.style.transform=`${s} scale(${k})`}else i.style.transform=`scale(${k})`;i.style.transformOrigin="top left"}else i.style.transform="";i.style.left="0",i.style.top="0",i.style.right="auto",i.style.bottom="auto",i.style.marginLeft="0",i.style.marginTop="0",i.style.textAlign="left",i.style.visibility="visible",i.style.opacity="1",i.style.display="block"}},[]),q=d.useCallback((c,e)=>{if(!z.current||J.current)return;const n=document,u=e??!!(document.fullscreenElement||n.webkitFullscreenElement||n.mozFullScreenElement||n.msFullscreenElement);let r=c;if(u?r={width:window.innerWidth,height:window.innerHeight,x:0,y:0,top:0,left:0,right:window.innerWidth,bottom:window.innerHeight,toJSON:()=>({})}:(!c||c.width<=0||c.height<=0)&&(r=j.current?.getBoundingClientRect()||null),!r||r.width<=0||r.height<=0)return;const{width:o,height:x}=K(r,u),w=D.current;if(!w||w.w!==o||w.h!==x)try{z.current.sendSize(o,x),D.current={w:o,h:x}}catch{}ee(r.width,r.height)},[ee]),le=d.useCallback(()=>{const e=j.current?.getBoundingClientRect();e&&q(e,!!document.fullscreenElement)},[q]);d.useEffect(()=>{Y?p(Y):L||xe(async()=>{const{mockHosts:c}=await import("./mockData-C1akHryx.js");return{mockHosts:c}},[]).then(({mockHosts:c})=>{const e=c.find(n=>n.id===V);e&&p(e)})},[V,Y,L]),d.useCallback(c=>{try{if(!oe){h("Guacamole library not available"),T(!1);return}class e{static CLOSED=0;static OPEN=1;static CONNECTING=2;ws;clientRef;state=e.CLOSED;uuid=null;receiveTimeout=0;unstableThreshold=0;_onstatechange=null;_oninstruction=null;_onerror=null;_onuuid=null;parser=new oe.Parser;syncCount=0;recentSent=[];recentReceived=[];lastInputStreamId=null;constructor(s,t){this.ws=s,this.clientRef=t,this.state=s.readyState===WebSocket.OPEN?e.OPEN:e.CONNECTING,this.ws.onopen=()=>this.onOpen(),this.ws.onmessage=l=>this.onMessage(l),this.ws.onerror=l=>this.onError(l),this.ws.onclose=l=>this.onClose(l),this.parser.oninstruction=(l,g)=>{const b=`${l}:${g.map(_=>String(_)).join("|")}`;if(this.recentReceived.push(b),this.recentReceived.length>20&&this.recentReceived.shift(),l==="disconnect"){const _=g.map(N=>String(N));this.handleInstruction(l,_),this._oninstruction&&this._oninstruction(l,g)}else{this._oninstruction&&this._oninstruction(l,g);const _=g.map(N=>String(N));this.handleInstruction(l,_)}}}onOpen(){this.state=e.OPEN,this._onstatechange&&this._onstatechange(this.state),requestAnimationFrame(()=>{requestAnimationFrame(()=>{if(this.clientRef.current&&this.clientRef.current.connect&&this.clientRef.current.state!==2)try{this.clientRef.current.connect()}catch{}})})}validateMessageFormat(s){if(!s||s.length===0||!s.endsWith(";"))return!1;const t=s.slice(0,-1);if(t.length===0)return!1;const l=t.split(";");for(const g of l){if(g.length===0)continue;const b=g.split(",");for(const _ of b){const N=_.trim();if(N.length===0)continue;const Z=N.indexOf(".");if(Z<=0)return!1;const te=N.substring(0,Z);if(te.length===0||!/^\d+$/.test(te))return!1;const re=parseInt(te,10);if(isNaN(re)||re<0||re>1e6||N.substring(Z+1).length!==re)return!1}}return!0}onMessage(s){try{const t=s.data;if(typeof t=="string"){if(t.startsWith("{")&&t.endsWith("}"))try{JSON.parse(t);return}catch{}if(t.includes("Error")||t.includes("error")){let l=t,g="";if(t.includes(",")){const b=t.split(",");if(b.length>=2){const _=b[0].trim(),N=b.slice(1).join(",").trim(),Z=_.match(/\d+/);if(Z)g=Z[0],l=N;else{l=N;const te=N.match(/\d+/);te&&(g=te[0])}}}else if(t.includes("(")&&t.includes(")")){const b=t.match(/\((\d+)\)/);b&&b.length>=2&&(g=b[1],l=t.replace(/\s*\(\d+\)\s*$/,"").trim())}g==="776"&&(l="服务器连接超时：请检查网络连接并尝试重新连接。"),this._onerror&&this._onerror({code:g&&parseInt(g,10)||500,message:l});return}try{if(!this.validateMessageFormat(t))return;this.parser.receive(t)}catch{this._onerror&&this._onerror({code:0,message:"协议解析错误，消息格式可能不正确。这可能是由于网络问题或服务器错误。"})}}}catch{}}onError(s){this.state=e.CLOSED,this._onstatechange&&this._onstatechange(this.state)}onClose(s){this.state=e.CLOSED,this._onstatechange&&this._onstatechange(this.state)}handleInstruction(s,t){if(s==="ready")this.state=e.OPEN,this._onstatechange&&this._onstatechange(this.state),this.clientRef.current&&this.clientRef.current.connect&&this.clientRef.current.state!==2&&this.clientRef.current.connect(),setTimeout(()=>{try{const l=M.current,g=l?.getElement?.();g&&(g.style.visibility="visible",g.style.opacity="1",g.style.display="block"),m.current&&(m.current.style.display="block",m.current.style.visibility="visible",m.current.style.opacity="1"),l&&P(),le()}catch{}},80);else if(s==="disconnect"){if(this.clientRef.current){const l=this.clientRef.current.state;l==null}this.state=e.CLOSED,this._onstatechange&&this._onstatechange(this.state),this._onerror&&this._onerror({code:0,message:"服务器发送了断开连接指令。这可能是由于临时错误或服务器问题。请尝试重新连接。"})}else if(s==="error"){let l="",g="";t.length>=1&&(l=t[0]),t.length>=2&&(g=t[1]),g==="776"?l="服务器连接超时：请检查网络连接并尝试重新连接。":!l&&g?l=`连接错误 (${g})`:l||(l="连接错误"),this._onerror&&this._onerror({code:g&&parseInt(g,10)||500,message:l})}else(s==="blob"||s==="end")&&t.length>0&&(this.lastInputStreamId=String(t[0])),!s.startsWith("img")&&!s.startsWith("rect")&&!s.startsWith("path")&&s==="sync"&&this.syncCount++}sendMessage(...s){try{if(this.ws.readyState!==WebSocket.OPEN)return;let t="";if(s.length>1)t=s.map(g=>{const b=String(g);return`${b.length}.${b}`}).join(",")+";";else{if(t=s.length===1?String(s[0]).trim():"",!t.includes(".")&&!t.includes(",")&&t==="ack"){const g=this.lastInputStreamId||"0",b="OK",_="0",N=Z=>`${Z.length}.${Z}`;t=`${N("ack")},${N(g)},${N(b)},${N(_)};`}else if(!t.includes(".")&&!t.includes(",")){const g=t;t=`${g.length}.${g};`}else t.endsWith(";")||(t=t+";");if((t.endsWith("sync;")||t.endsWith(".sync;"))&&!t.includes(",")){const g=Date.now().toString(),b=g.length;t=`${t.substring(0,t.length-1)},${b}.${g};`}}!t.startsWith("key,")&&!t.startsWith("mouse,")&&(t.startsWith("sync,")||t.startsWith("4.sync")?this.syncCount++:t.includes("disconnect")||t.includes("ack")),this.recentSent.push(t.substring(0,120)),this.recentSent.length>20&&this.recentSent.shift(),this.ws.send(t)}catch{}}disconnect(){(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING)&&this.ws.close(),this.state=e.CLOSED,this._onstatechange&&this._onstatechange(this.state)}connect(){this.ws.readyState===WebSocket.OPEN?(this.state=e.OPEN,this._onstatechange&&this._onstatechange(this.state)):(this.state=e.CONNECTING,this._onstatechange&&this._onstatechange(this.state))}isConnected(){return this.state===e.OPEN&&this.ws.readyState===WebSocket.OPEN}set onstatechange(s){this._onstatechange=s}set oninstruction(s){this._oninstruction=s}set onuuid(s){this._onuuid=s,s&&this.uuid&&s(this.uuid)}set onerror(s){this._onerror=s}}const n={current:null},u=new e(c,n),r=new oe.Client(u);z.current=r,n.current=r;const o=r.getDisplay();M.current=o;const x=o.getElement();if(Q(),P(),x.style.cursor="default",o.onresize=()=>{const i=M.current;if(!i)return;const s=i.getWidth(),t=i.getHeight();if(s<=0||t<=0)return;const l=i.getElement?.();l&&(!l.parentElement&&m.current&&m.current.appendChild(l),l.style.visibility="visible",l.style.opacity="1",l.style.display="block",l.querySelectorAll("canvas").forEach(N=>{N.style.display="block",N.style.visibility="visible",N.style.opacity="1"})),m.current&&(m.current.style.display="block",m.current.style.visibility="visible",m.current.style.opacity="1");const b=j.current?.getBoundingClientRect();b&&b.width>0&&b.height>0&&q(b,!!document.fullscreenElement)},m.current){const i=m.current.querySelector('[class*="guac"]');i&&i!==x&&i.remove(),m.current.contains(x)||(m.current.innerHTML="",m.current.appendChild(x)),m.current.style.display="block",m.current.style.visibility="visible",m.current.style.opacity="1"}P(),x&&(x.style.visibility="visible",x.style.opacity="1",x.style.display="block",!x.parentElement&&m.current&&m.current.appendChild(x)),W.current&&(W.current.disconnect(),W.current=null),setTimeout(()=>{const i=j.current,s=M.current;if(!i||!s)return;const t=s.getElement?.();t&&!t.parentElement&&m.current&&(m.current.appendChild(t),P());const l=i.getBoundingClientRect();if(l.width>0&&l.height>0&&s.getWidth&&s.getHeight){const b=s.getWidth(),_=s.getHeight();b>0&&_>0&&q(l,!!document.fullscreenElement)}const g=i.getBoundingClientRect();g.width>0&&g.height>0&&q(g,!!document.fullscreenElement)},300);const w=new oe.Keyboard(x);w.onkeydown=i=>{r.sendKeyEvent(1,i)},w.onkeyup=i=>{r.sendKeyEvent(0,i)};const I=new oe.Mouse(x);I.onmousedown=i=>{r.sendMouseState(i)},I.onmouseup=i=>{r.sendMouseState(i)},I.onmousemove=i=>{r.sendMouseState(i)};let S=null,k=null;r.onstatechange=i=>{k=i;const s=0,t=2,l=1,g=3,b=4;if(i==null||i<0||i>4)if(S&&(clearTimeout(S),S=null),z.current){const _=z.current.state;_!=null?(i=_,k=i):(i=b,k=i)}else i=b,k=i;if(i===t){h(null),O.current=!0,v(!0),B.current=!0;const _=()=>{const ce=j.current,X=M.current,se=X?.getElement?.();m.current&&(m.current.style.display="block",m.current.style.visibility="visible",m.current.style.opacity="1"),se&&(P(),se.querySelectorAll("canvas").forEach(ie=>{ie.style.display="block",ie.style.visibility="visible",ie.style.opacity="1"}));const ne=ce?.getBoundingClientRect();if(ne&&ne.width>0&&ne.height>0&&X?.getWidth&&X?.getHeight){const ge=X.getWidth(),ie=X.getHeight();ge>0&&ie>0&&q(ne,y)}se&&!se.parentElement&&m.current&&m.current.appendChild(se)};_(),setTimeout(_,200),setTimeout(_,500),setTimeout(_,1e3);let N=null;const Z=Date.now(),te=1e4,re=()=>{if(Date.now()-Z>te){N!==null&&cancelAnimationFrame(N);return}const X=M.current?.getElement?.();X&&(X.style.visibility="visible",X.style.opacity="1",X.style.display="block",X.querySelectorAll("canvas").forEach(ne=>{ne.style.display="block",ne.style.visibility="visible",ne.style.opacity="1"})),N=requestAnimationFrame(re)};N=requestAnimationFrame(re),S&&clearTimeout(S),f(R("terminal.establishingConnection")),S=setTimeout(()=>{if(!z.current){h(R("terminal.clientLost")),T(!1),O.current=!1,S=null;return}if(k==null){B.current||h(R("terminal.clientStateError")),T(!1),O.current=!1,S=null;return}if(k===4||k===3){B.current||h(R("rdp.disconnected")||"Disconnected"),T(!1),O.current=!1,S=null;return}if(k!==2){f("连接中..."),S=null;return}f(R("terminal.connectionSuccess")),h(null),v(!0),setTimeout(()=>{T(!1)},500),S=null},1e3)}else i===b?(O.current=!1,v(!1),B.current||h(R("terminal.connectionFailed")),T(!1),S&&(clearTimeout(S),S=null)):i===s?f(R("terminal.connecting")):i===l?f(R("terminal.waitingConnection")):i===g&&v(!1)},r.onerror=i=>{let s="Unknown error",t="",l="";if(i){const b=i;if("code"in b&&b.code!==void 0)switch(t=b.code.toString(),l=b.message||b.reason||"",b.code){case 519:s="服务器拒绝连接：安全类型不匹配。请检查服务器是否支持当前安全模式，或联系管理员。";break;case 512:s="连接被服务器拒绝：用户名或密码错误。";break;case 513:s="连接被服务器拒绝：权限不足。";break;case 514:s="连接超时：无法连接到服务器。";break;default:s=`错误 ${t}${l?": "+l:""}`}else{const _=i;_.message?s=_.message:s=_.toString()}}const g=R("rdp.clientError")||"Client error: "+s;h(g),T(!1)},c.readyState===WebSocket.OPEN&&(u.state=e.OPEN,u._onstatechange&&u._onstatechange(u.state),requestAnimationFrame(()=>{requestAnimationFrame(()=>{try{r.state!==2&&r.connect()}catch{}})}))}catch(e){h((R("rdp.setupFailed")||"Setup failed")+": "+e.message),T(!1)}},[h,T,v,f,R,m,z,q,Q,y,le]);const de=async()=>{const c=j.current;if(c)try{const e=c,n=document;y?document.exitFullscreen?await document.exitFullscreen():n.webkitExitFullscreen?await n.webkitExitFullscreen():n.mozCancelFullScreen?await n.mozCancelFullScreen():n.msExitFullscreen&&await n.msExitFullscreen():c.requestFullscreen?await c.requestFullscreen():e.webkitRequestFullscreen?await e.webkitRequestFullscreen():e.mozRequestFullScreen?await e.mozRequestFullScreen():e.msRequestFullscreen&&await e.msRequestFullscreen()}catch{}};return d.useEffect(()=>{const c=()=>{const n=document,u=!!(document.fullscreenElement||n.webkitFullscreenElement||n.mozFullScreenElement||n.msFullscreenElement);C(u),J.current=!0;const r=()=>{if(z.current)if(u){const o={width:window.innerWidth,height:window.innerHeight,x:0,y:0,top:0,left:0,right:window.innerWidth,bottom:window.innerHeight,toJSON:()=>({})};$.current&&clearTimeout($.current),q(o,u),setTimeout(()=>{J.current=!1},500)}else{const o=G.current;if(o&&z.current){try{z.current.sendSize(o.w,o.h),D.current={w:o.w,h:o.h}}catch{}const x=j.current;if(x){const w=x.getBoundingClientRect();w&&w.width>0&&w.height>0&&setTimeout(()=>{const I=M.current;if(I?.getWidth?.()&&I?.getHeight?.()){ee(w.width,w.height);const S=I?.getElement?.();S&&(S.style.left="0",S.style.top="0",S.style.right="auto",S.style.bottom="auto",S.style.marginLeft="0",S.style.marginTop="0",S.style.transformOrigin="top left",S.style.transform="")}},500)}}else{const x=j.current;if(!x)return;const w=x.getBoundingClientRect();if(w&&w.width>0&&w.height>0){q(w,u);const S=M.current?.getElement?.();S&&(S.style.left="0",S.style.top="0",S.style.right="auto",S.style.bottom="auto",S.style.marginLeft="0",S.style.marginTop="0",S.style.transformOrigin="top left")}}}};setTimeout(()=>{r(),setTimeout(()=>{requestAnimationFrame(r)},100)},100)};document.addEventListener("fullscreenchange",c),document.addEventListener("webkitfullscreenchange",c),document.addEventListener("mozfullscreenchange",c),document.addEventListener("MSFullscreenChange",c);const e=n=>{n.key==="Escape"&&y&&setTimeout(()=>{c()},100)};return window.addEventListener("keydown",e),()=>{document.removeEventListener("fullscreenchange",c),document.removeEventListener("webkitfullscreenchange",c),document.removeEventListener("mozfullscreenchange",c),document.removeEventListener("MSFullscreenChange",c),window.removeEventListener("keydown",e)}},[y,q,ee]),d.useEffect(()=>{const c=j.current;if(!c)return;let e=null;const n=new ResizeObserver(r=>{if(J.current)return;const o=r[0];if(!o||!o.target)return;const x=o.target.getBoundingClientRect();e&&cancelAnimationFrame(e),e=requestAnimationFrame(()=>{const w=document,I=!!(document.fullscreenElement||w.webkitFullscreenElement||w.mozFullScreenElement||w.msFullscreenElement);$.current&&clearTimeout($.current),$.current=window.setTimeout(()=>{q(x,I)},100)})});n.observe(c);const u=c.getBoundingClientRect();return q(u,!!document.fullscreenElement),()=>{e&&cancelAnimationFrame(e),n.disconnect(),W.current&&(W.current.disconnect(),W.current=null)}},[ee,q]),a.jsxs(A,{sx:{width:"100%",height:"100%",display:"flex",flexDirection:"column",position:"relative",overflow:"hidden"},children:[H&&a.jsxs(A,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",backgroundColor:"rgba(0, 0, 0, 0.7)",zIndex:1e3,gap:2},children:[a.jsx(we,{size:60,sx:{color:"primary.main"}}),a.jsx(A,{sx:{color:"white",fontSize:"16px",fontWeight:500,textAlign:"center"},children:U})]}),!F&&E&&a.jsx(be,{severity:"error",sx:{mb:2},children:E}),a.jsxs(ue,{ref:j,sx:{width:"100%",height:"100%",maxWidth:"100%",maxHeight:"100%",display:"flex",flexDirection:"column",position:"relative",overflow:"hidden",flex:1,minHeight:0,"&:fullscreen, &:-webkit-full-screen, &:-moz-full-screen, &:-ms-fullscreen":{width:"100vw !important",height:"100vh !important",maxWidth:"100vw !important",maxHeight:"100vh !important",margin:0,padding:0}},children:[a.jsx(A,{sx:{position:"absolute",top:8,right:8,zIndex:100,display:"flex",gap:1},children:a.jsx(Ee,{title:y?R("common.exitFullscreen")||"Exit Fullscreen":R("common.fullscreen")||"Fullscreen",children:a.jsx(me,{size:"small",onClick:de,color:"primary",children:y?a.jsx(ve,{}):a.jsx(Ce,{})})})}),a.jsx(A,{ref:m,sx:{flex:1,width:"100%",height:"100%",minHeight:0,backgroundColor:"#000",overflow:"hidden",position:"relative",...y&&{width:"100vw",height:"100vh",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:9999},...y&&{"& > div":{width:"100% !important",height:"100% !important",transform:"none !important","& > div":{width:"100% !important",height:"100% !important",transform:"none !important"}}}}})]})]})}function Ke(){const{t:V}=he(),Y=ke(),R=Re(),{sessions:m,removeSession:j,addSession:z}=pe(),[W,H]=d.useState(0),[T,U]=d.useState(""),[f,E]=d.useState("/");d.useEffect(()=>{const p=sessionStorage.getItem("terminal_previous_path")||"/";E(p)},[]),d.useEffect(()=>{(async()=>{try{const C=await(await fetch("/api/system-users",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}})).json(),F=C.data||C||[];F.length>0&&!T&&U(F[0].id)}catch(y){console.error("加载系统用户失败:",y)}})()},[T]),d.useEffect(()=>{W>=m.length&&m.length>0&&H(m.length-1)},[m.length,W]);const h=(p,y)=>{const F=m.find(v=>v.id===p)?.wsConnection;F&&F.readyState===WebSocket.OPEN&&(console.log(`[TerminalPage] User manually closing WebSocket for session ${p}`),F.__userClosed=!0,F.close()),j(p),W===y&&y>0&&H(y-1)},L=async p=>{try{const y=m.find(v=>v.host.id===p.id);if(y){const v=m.findIndex(O=>O.id===y.id);H(v);return}const C=await je.getHost(p.id);let F=T;if(!F)try{const O=await(await fetch(`/api/system-users/available?hostId=${p.id}`,{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}})).json(),B=Array.isArray(O.data)?O.data:O.data?.data||[];if(B.length===0){alert("没有可用的系统用户，请联系管理员配置权限");return}else B.length,F=B[0].id}catch(v){console.error("获取系统用户失败:",v)}z(C,F||void 0),setTimeout(()=>{const v=m.length;H(v)},100)}catch(y){console.error("连接主机失败:",y),alert("连接主机失败: "+y.message)}};return a.jsxs(A,{sx:{height:"100vh",width:"100vw",display:"flex",flexDirection:"column",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1300,bgcolor:"background.default",overflow:"hidden"},children:[a.jsx(Fe,{position:"static",color:"default",elevation:1,sx:{flexShrink:0},children:a.jsxs(Te,{children:[a.jsx(me,{edge:"start",onClick:()=>Y(f),sx:{mr:2},children:a.jsx(_e,{})}),a.jsx(ae,{variant:"h6",sx:{flexGrow:1},children:V("terminal.title")}),m.length>0&&a.jsx(ae,{variant:"body2",color:"text.secondary",sx:{mr:2},children:V("terminal.activeSessions",{count:m.length})}),a.jsx(Se,{variant:"outlined",startIcon:a.jsx(Ne,{}),onClick:()=>{sessionStorage.setItem("file_management_previous_path",R.pathname),window.open("/file-management","_blank")},sx:{textTransform:"none",mr:1},children:"文件管理"})]})}),a.jsxs(A,{sx:{flex:1,minHeight:0,width:"100%",display:"flex",gap:2,p:2,overflow:"hidden"},children:[a.jsx(A,{sx:{width:"300px",flexShrink:0,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:a.jsx(He,{onHostClick:L})}),a.jsx(A,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:m.length===0?a.jsxs(ue,{sx:{p:4,textAlign:"center",flex:1,display:"flex",flexDirection:"column",justifyContent:"center"},children:[a.jsx(ae,{variant:"h6",gutterBottom:!0,color:"text.secondary",children:V("terminal.noOpenSessions")}),a.jsx(ae,{variant:"body2",color:"text.secondary",children:"从左侧主机树选择主机进行连接"})]}):a.jsxs(a.Fragment,{children:[a.jsx(ue,{sx:{mb:2,flexShrink:0},children:a.jsx(We,{value:W,onChange:(p,y)=>H(y),variant:"scrollable",scrollButtons:"auto",children:m.map((p,y)=>a.jsx(Oe,{label:a.jsxs(A,{display:"flex",alignItems:"center",gap:1,children:[a.jsx("span",{children:p.host.name.toLowerCase()}),a.jsxs("span",{style:{fontSize:"0.8em",opacity:.7},children:["(",p.host.ip,")"]}),a.jsx(A,{component:"span",onClick:C=>{C.stopPropagation(),h(p.id,y)},sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:20,height:20,borderRadius:"50%",cursor:"pointer",ml:.5,"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.08)"}},children:a.jsx(Ie,{sx:{fontSize:16}})})]}),sx:{textTransform:"none"}},p.id))})}),a.jsx(A,{sx:{flex:1,minHeight:0,width:"100%",display:"flex",flexDirection:"column",overflow:"hidden"},children:m.map((p,y)=>a.jsx(A,{sx:{display:W===y?"flex":"none",flex:1,width:"100%",minHeight:0,flexDirection:"column",overflow:"hidden"},children:p.host.deviceType==="windows"?a.jsx($e,{hostId:p.host.id,host:p.host,sessionId:p.id,systemUserId:p.systemUserId,onClose:()=>h(p.id,y)}):a.jsx(Me,{hostId:p.host.id,host:p.host,sessionId:p.id,systemUserId:p.systemUserId,onClose:()=>h(p.id,y)})},p.id))})]})})]})]})}export{Ke as default};
