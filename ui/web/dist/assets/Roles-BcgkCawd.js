import{u as ee,r as l,H as c,j as e,B as m,w as A,x as I,T as n,J as U,ac as F,P as se,a as h,A as te,O as ae,I as R,dc as re,g as le,h as oe,i as B,k as z,l as E,m as M,F as ie,n as ne,o as ce,M as L,p as $,W as de,b6 as me,b7 as ue,y as xe,Y as he,D as pe,b as je}from"./index-Cih9_E47.js";import{T as ge,a as fe,b as be,c as H,d as o,e as ye}from"./TableRow-Bl_73t-R.js";import{C as D}from"./Chip-D6-9bdkU.js";import{S as ve}from"./Snackbar-Dmj-hhun.js";const Ae=()=>{const{t}=ee(),[p,b]=l.useState([]),[,y]=l.useState(!1),[V,u]=l.useState(!1),[P,j]=l.useState(!1),[v,T]=l.useState(null),[g,G]=l.useState(null),[q,C]=l.useState([]),[S,W]=l.useState([]),[x,a]=l.useState({open:!1,message:"",severity:"success"}),[i,d]=l.useState({name:"",description:"",color:"#1890ff",priority:0,status:"active"});l.useEffect(()=>{f(),J()},[]);const f=l.useCallback(async()=>{y(!0);try{const s=await c.get("/api/roles?withMembers=true"),r=s.data?.data||s.data;b(Array.isArray(r)?r:[])}catch(s){a({open:!0,message:s.message||t("roles.loadRolesFailed"),severity:"error"}),b([])}finally{y(!1)}},[y,b,a,t]),J=l.useCallback(async()=>{try{const s=await c.get("/api/users"),r=s.data?.data?.users||s.data?.data||s.data;C(Array.isArray(r)?r:[])}catch(s){a({open:!0,message:s.message||t("roles.loadUsersFailed"),severity:"error"}),C([])}},[C,a,t]),N=()=>{T(null),d({name:"",description:"",color:"#1890ff",priority:0,status:"active"}),u(!0)},O=s=>{if(s.id==="role:admin"||s.id==="role:user"){a({open:!0,message:"系统角色不允许编辑",severity:"error"});return}T(s),d({name:s.name,description:s.description||"",color:s.color||"#1890ff",priority:s.priority,status:s.status}),u(!0)},Y=async s=>{if(s==="role:admin"||s==="role:user"){a({open:!0,message:"系统角色不允许删除",severity:"error"});return}if(window.confirm(t("roles.deleteConfirm")))try{await c.delete(`/api/roles/${s}`),a({open:!0,message:t("roles.deleteSuccess"),severity:"success"}),f()}catch(r){a({open:!0,message:r.message||t("roles.deleteFailed"),severity:"error"})}},K=async()=>{try{v?(await c.put(`/api/roles/${v.id}`,i),a({open:!0,message:t("roles.updateSuccess"),severity:"success"})):(await c.post("/api/roles",i),a({open:!0,message:t("roles.createSuccess"),severity:"success"})),u(!1),f()}catch(s){a({open:!0,message:s.message||t("common.error"),severity:"error"})}},Q=async s=>{G(s);try{const k=(await c.get(`/api/roles/${s.id}?withMembers=true`)).data;W(k.members?.map(_=>_.id)||[]),j(!0)}catch(r){a({open:!0,message:r.message||t("roles.memberUpdateFailed"),severity:"error"})}},X=s=>{W(r=>r.includes(s)?r.filter(k=>k!==s):[...r,s])},Z=async()=>{if(g)try{await c.post(`/api/roles/${g.id}/members/batch`,{userIds:S}),a({open:!0,message:t("roles.memberUpdateSuccess"),severity:"success"}),j(!1),f()}catch(s){a({open:!0,message:s.message||t("roles.memberUpdateFailed"),severity:"error"})}},w={total:p.length,active:p.filter(s=>s.status==="active").length,totalMembers:p.reduce((s,r)=>s+(r.memberCount||0),0)};return e.jsxs(m,{sx:{p:3},children:[e.jsxs(m,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap"},children:[e.jsx(A,{sx:{flex:"1 1 0",minWidth:200},children:e.jsxs(I,{children:[e.jsx(n,{color:"textSecondary",gutterBottom:!0,children:t("roles.total")}),e.jsxs(n,{variant:"h4",children:[e.jsx(U,{sx:{mr:1,verticalAlign:"middle"}}),w.total]})]})}),e.jsx(A,{sx:{flex:"1 1 0",minWidth:200},children:e.jsxs(I,{children:[e.jsx(n,{color:"textSecondary",gutterBottom:!0,children:t("roles.activeCount")}),e.jsx(n,{variant:"h4",color:"success.main",children:w.active})]})}),e.jsx(A,{sx:{flex:"1 1 0",minWidth:200},children:e.jsxs(I,{children:[e.jsx(n,{color:"textSecondary",gutterBottom:!0,children:t("roles.totalMembers")}),e.jsxs(n,{variant:"h4",children:[e.jsx(F,{sx:{mr:1,verticalAlign:"middle"}}),w.totalMembers]})]})})]}),e.jsxs(se,{sx:{p:2},children:[e.jsxs(m,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[e.jsx(n,{variant:"h6",children:t("roles.title")}),e.jsx(h,{variant:"contained",startIcon:e.jsx(te,{}),onClick:N,children:t("roles.addRole")})]}),e.jsx(ge,{children:e.jsxs(fe,{children:[e.jsx(be,{children:e.jsxs(H,{children:[e.jsx(o,{children:t("roles.name")}),e.jsx(o,{children:t("roles.memberCount")}),e.jsx(o,{children:t("roles.description")}),e.jsx(o,{children:t("roles.status")}),e.jsx(o,{children:t("common.createdAt")}),e.jsx(o,{children:t("common.actions")})]})}),e.jsx(ye,{children:p.map(s=>e.jsxs(H,{children:[e.jsx(o,{children:e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ae,{sx:{bgcolor:s.color||"#1890ff",width:32,height:32},children:e.jsx(U,{fontSize:"small"})}),s.name]})}),e.jsx(o,{children:e.jsx(D,{icon:e.jsx(F,{}),label:`${s.memberCount||0} ${t("roles.membersUnit")}`,size:"small",color:"info"})}),e.jsx(o,{children:s.description}),e.jsx(o,{children:e.jsx(D,{label:s.status==="active"?t("roles.active"):t("roles.inactive"),size:"small",color:s.status==="active"?"success":"default"})}),e.jsx(o,{children:s.createdAt?new Date(s.createdAt).toLocaleString():"-"}),e.jsxs(o,{children:[e.jsx(R,{size:"small",color:"info",onClick:()=>Q(s),children:e.jsx(re,{})}),s.id!=="role:admin"&&s.id!=="role:user"&&e.jsxs(e.Fragment,{children:[e.jsx(R,{size:"small",color:"primary",onClick:()=>O(s),children:e.jsx(le,{})}),e.jsx(R,{size:"small",color:"error",onClick:()=>Y(s.id),children:e.jsx(oe,{})})]}),(s.id==="role:admin"||s.id==="role:user")&&e.jsx(D,{label:"系统角色",size:"small",color:"primary",variant:"outlined",sx:{ml:1}})]})]},s.id))})]})})]}),e.jsxs(B,{open:V,onClose:()=>u(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(z,{children:t(v?"roles.editRole":"roles.addRole")}),e.jsx(E,{children:e.jsxs(m,{sx:{display:"flex",flexDirection:"column",gap:2.5,pt:2},children:[e.jsx(M,{fullWidth:!0,label:t("roles.name"),value:i.name,onChange:s=>d({...i,name:s.target.value}),required:!0}),e.jsx(M,{fullWidth:!0,multiline:!0,rows:3,label:t("roles.description"),value:i.description,onChange:s=>d({...i,description:s.target.value})}),e.jsx(M,{fullWidth:!0,type:"color",label:t("roles.color"),value:i.color,onChange:s=>d({...i,color:s.target.value})}),e.jsxs(ie,{fullWidth:!0,children:[e.jsx(ne,{children:t("roles.status")}),e.jsxs(ce,{value:i.status,onChange:s=>d({...i,status:s.target.value}),label:t("roles.status"),children:[e.jsx(L,{value:"active",children:t("roles.active")}),e.jsx(L,{value:"inactive",children:t("roles.inactive")})]})]})]})}),e.jsxs($,{children:[e.jsx(h,{onClick:()=>u(!1),children:t("common.cancel")}),e.jsx(h,{variant:"contained",onClick:K,children:t("common.confirm")})]})]}),e.jsxs(B,{open:P,onClose:()=>j(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(z,{children:[t("roles.manageMembers")," - ",g?.name]}),e.jsxs(E,{children:[e.jsx(n,{variant:"body2",color:"textSecondary",sx:{mb:2},children:t("roles.selectUsers")}),e.jsx(de,{sx:{bgcolor:"background.paper",maxHeight:400,overflow:"auto"},children:q.map(s=>e.jsxs(me.Fragment,{children:[e.jsxs(ue,{onClick:()=>X(s.id),dense:!0,children:[e.jsx(xe,{edge:"start",checked:S.includes(s.id),tabIndex:-1,disableRipple:!0}),e.jsx(he,{primary:s.username,secondary:s.fullName||s.email||""})]}),e.jsx(pe,{})]},s.id))}),g&&e.jsx(m,{sx:{mt:2,p:2,bgcolor:"grey.100",borderRadius:1},children:e.jsx(n,{variant:"caption",color:"textSecondary",children:t("roles.selectedCount",{count:S.length})})})]}),e.jsxs($,{children:[e.jsx(h,{onClick:()=>j(!1),children:t("common.cancel")}),e.jsx(h,{variant:"contained",onClick:Z,children:t("common.confirm")})]})]}),e.jsx(ve,{open:x.open,autoHideDuration:3e3,onClose:()=>a({...x,open:!1}),children:e.jsx(je,{severity:x.severity,onClose:()=>a({...x,open:!1}),children:x.message})})]})};export{Ae as default};
