import{u as Z,r as p,H as u,j as e,B as i,w as I,x as R,T as c,aa as B,P as ss,a as G,A as es,c as as,V as rs,I as L,g as ls,h as ts,i as is,k as os,l as ns,m as g,F as S,n as w,o as T,M as C,y as O,Y as E,aD as P,_ as ds,p as cs,b as ms}from"./index-wVs8DYHr.js";import{T as ps,a as us,b as xs,c as V,d as o,e as hs}from"./TableRow-17IyVPm2.js";import{C as n}from"./Chip-DzNpApxT.js";import{S as js}from"./Switch-DnfqMs2v.js";import{S as ys}from"./Snackbar-BdF2qid6.js";const Rs=()=>{const{t:a}=Z(),[y,F]=p.useState([]),[,D]=p.useState(!1),[$,h]=p.useState(!1),[v,U]=p.useState(null),[q,k]=p.useState([]),[W,z]=p.useState([]),[A,N]=p.useState([]),[j,d]=p.useState({open:!1,message:"",severity:"success"}),[l,m]=p.useState({name:"",userGroupId:"",systemUserIds:[],hostGroupIds:[],validFrom:"",validTo:"",enabled:!0,priority:0,description:""});p.useEffect(()=>{f(),M(),Y(),_()},[]);const f=async()=>{D(!0);try{const s=await u.get("/api/permission-rules"),r=s.data?.data||s.data,t=Array.isArray(r)?r:[];F(t)}catch(s){d({open:!0,message:s.message||a("permissionRules.loadPermissionRulesFailed"),severity:"error"}),F([])}finally{D(!1)}},M=async()=>{try{const s=await u.get("/api/roles"),r=s.data?.data||s.data;k(Array.isArray(r)?r:[])}catch(s){console.error("Failed to fetch user groups:",s),k([])}},Y=async()=>{try{const s=await u.get("/api/system-users"),r=s.data?.data||s.data;z(Array.isArray(r)?r:[])}catch(s){console.error("Failed to fetch system users:",s),z([])}},_=async()=>{try{const s=await u.get("/api/host-groups?stats=true"),r=s.data?.data||s.data,t=r?.groups||r||[];N(Array.isArray(t)?t:[])}catch(s){console.error("Failed to fetch host groups:",s),N([])}},J=()=>{U(null),m({name:"",userGroupId:"",systemUserIds:[],hostGroupIds:[],validFrom:"",validTo:"",enabled:!0,priority:0,description:""}),h(!0)},K=s=>{U(s);const r=s.systemUserIds||(s.systemUserId?[s.systemUserId]:[]),t=s.hostGroupIds||(s.hostGroupId?[s.hostGroupId]:[]);m({name:s.name,userGroupId:s.roleId||s.userGroupId||"",systemUserIds:r,hostGroupIds:t,validFrom:s.validFrom?new Date(s.validFrom).toISOString().slice(0,16):"",validTo:s.validTo?new Date(s.validTo).toISOString().slice(0,16):"",enabled:s.enabled,priority:0,description:s.description||""}),h(!0)},Q=async s=>{if(window.confirm(a("permissionRules.deleteConfirm")))try{await u.delete(`/api/permission-rules/${s}`),d({open:!0,message:a("permissionRules.deleteSuccess"),severity:"success"}),f()}catch(r){d({open:!0,message:r.message||a("permissionRules.deleteFailed"),severity:"error"})}},X=async()=>{try{const s={...l};if(!s.userGroupId||s.userGroupId.trim()===""){d({open:!0,message:"请选择一个用户组",severity:"warning"});return}if(!s.systemUserIds||s.systemUserIds.length===0){d({open:!0,message:"请至少选择一个系统用户",severity:"warning"});return}if(!s.hostGroupIds||s.hostGroupIds.length===0){d({open:!0,message:"请至少选择一个主机组",severity:"warning"});return}s.validFrom?s.validFrom=new Date(s.validFrom).toISOString():delete s.validFrom,s.validTo?s.validTo=new Date(s.validTo).toISOString():delete s.validTo,v?(await u.put(`/api/permission-rules/${v.id}`,s),d({open:!0,message:a("permissionRules.updateSuccess"),severity:"success"})):(await u.post("/api/permission-rules",s),d({open:!0,message:a("permissionRules.createSuccess"),severity:"success"})),h(!1),f()}catch(s){d({open:!0,message:s.message||a("common.error"),severity:"error"})}},H=s=>{const r=new Date,t=s.validFrom?new Date(s.validFrom):null,x=s.validTo?new Date(s.validTo):null;return(!t||t<=r)&&(!x||x>=r)},b={total:y.length,enabled:y.filter(s=>s.enabled).length,valid:y.filter(s=>H(s)).length};return e.jsxs(i,{sx:{p:3},children:[e.jsxs(i,{sx:{display:"flex",gap:2,mb:3,flexWrap:"wrap"},children:[e.jsx(I,{sx:{flex:"1 1 0",minWidth:200},children:e.jsxs(R,{children:[e.jsx(c,{color:"textSecondary",gutterBottom:!0,children:a("permissionRules.total")}),e.jsxs(c,{variant:"h4",children:[e.jsx(B,{sx:{mr:1,verticalAlign:"middle"}}),b.total]})]})}),e.jsx(I,{sx:{flex:"1 1 0",minWidth:200},children:e.jsxs(R,{children:[e.jsx(c,{color:"textSecondary",gutterBottom:!0,children:a("permissionRules.enabledCount")}),e.jsx(c,{variant:"h4",color:"success.main",children:b.enabled})]})}),e.jsx(I,{sx:{flex:"1 1 0",minWidth:200},children:e.jsxs(R,{children:[e.jsx(c,{color:"textSecondary",gutterBottom:!0,children:a("permissionRules.validCount")}),e.jsx(c,{variant:"h4",color:"primary.main",children:b.valid})]})})]}),e.jsxs(ss,{sx:{p:2},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[e.jsx(c,{variant:"h6",children:a("permissionRules.title")}),e.jsx(G,{variant:"contained",startIcon:e.jsx(es,{}),onClick:J,children:a("permissionRules.addRule")})]}),e.jsx(ps,{children:e.jsxs(us,{children:[e.jsx(xs,{children:e.jsxs(V,{children:[e.jsx(o,{children:a("permissionRules.name")}),e.jsx(o,{children:a("permissionRules.userGroup")}),e.jsx(o,{children:a("permissionRules.systemUser")}),e.jsx(o,{children:a("permissionRules.hostGroup")}),e.jsx(o,{children:a("permissionRules.validFrom")}),e.jsx(o,{children:a("permissionRules.enabled")}),e.jsx(o,{children:a("common.actions")})]})}),e.jsx(hs,{children:y.map(s=>e.jsxs(V,{children:[e.jsx(o,{children:e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(B,{}),s.name]})}),e.jsx(o,{children:e.jsx(n,{label:s.roleName||s.roleId||"未知角色",size:"small",color:"secondary"})}),e.jsx(o,{children:e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.systemUserNames&&s.systemUserNames.length>0?s.systemUserNames.map((r,t)=>e.jsx(n,{label:r,size:"small",color:"success"},t)):s.systemUserName&&e.jsx(n,{label:s.systemUserName,size:"small",color:"success"})})}),e.jsx(o,{children:e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.hostGroupNames&&s.hostGroupNames.length>0?s.hostGroupNames.map((r,t)=>e.jsx(n,{label:r,size:"small",color:"info"},t)):s.hostGroupName?e.jsx(n,{label:s.hostGroupName,size:"small",color:"info"}):e.jsx(n,{label:a("permissionRules.allHosts"),size:"small"})})}),e.jsx(o,{children:e.jsx(i,{children:!s.validFrom&&!s.validTo?e.jsx(n,{label:a("permissionRules.permanent"),size:"small",color:"success"}):e.jsxs(e.Fragment,{children:[H(s)?e.jsxs(e.Fragment,{children:[e.jsx(n,{label:a("permissionRules.valid"),size:"small",color:"success"}),s.validTo&&new Date(s.validTo).getTime()-new Date().getTime()<4320*60*1e3&&e.jsx(n,{label:a("permissionRules.expired"),size:"small",color:"warning",sx:{ml:1}})]}):e.jsx(n,{label:a("permissionRules.expired"),size:"small",color:"error"}),e.jsx(c,{variant:"caption",display:"block",sx:{mt:.5},children:s.validFrom&&`${new Date(s.validFrom).toLocaleString()}`}),e.jsx(c,{variant:"caption",display:"block",children:s.validTo&&`${new Date(s.validTo).toLocaleString()}`})]})})}),e.jsx(o,{children:s.enabled?e.jsx(n,{icon:e.jsx(as,{}),label:a("permissionRules.enabled"),size:"small",color:"success"}):e.jsx(n,{icon:e.jsx(rs,{}),label:a("permissionRules.disabled"),size:"small",color:"default"})}),e.jsxs(o,{children:[e.jsx(L,{size:"small",color:"primary",onClick:()=>K(s),children:e.jsx(ls,{})}),e.jsx(L,{size:"small",color:"error",onClick:()=>Q(s.id),children:e.jsx(ts,{})})]})]},s.id))})]})})]}),e.jsxs(is,{open:$,onClose:()=>h(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(os,{children:a(v?"permissionRules.editRule":"permissionRules.addRule")}),e.jsx(ns,{children:e.jsxs(i,{sx:{display:"flex",flexDirection:"column",gap:2.5,pt:2},children:[e.jsx(g,{fullWidth:!0,label:a("permissionRules.name"),value:l.name,onChange:s=>m({...l,name:s.target.value}),required:!0}),e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsxs(S,{fullWidth:!0,required:!0,children:[e.jsx(w,{children:a("permissionRules.userGroup")}),e.jsx(T,{value:l.userGroupId,onChange:s=>m({...l,userGroupId:s.target.value}),label:a("permissionRules.userGroup"),children:q.map(s=>e.jsx(C,{value:s.id,children:s.name},s.id))})]}),e.jsxs(S,{fullWidth:!0,required:!0,children:[e.jsx(w,{children:a("permissionRules.systemUser")}),e.jsx(T,{multiple:!0,value:l.systemUserIds,onChange:s=>m({...l,systemUserIds:typeof s.target.value=="string"?s.target.value.split(","):s.target.value}),input:e.jsx(P,{label:a("permissionRules.systemUser")}),renderValue:s=>e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.map(r=>{const t=W.find(x=>x.id===r);return e.jsx(n,{label:t?.name||r,size:"small"},r)})}),children:W.map(s=>e.jsxs(C,{value:s.id,children:[e.jsx(O,{checked:l.systemUserIds.indexOf(s.id)>-1}),e.jsx(E,{primary:s.name,secondary:s.username})]},s.id))})]})]}),e.jsxs(i,{children:[e.jsxs(S,{fullWidth:!0,children:[e.jsx(w,{children:a("permissionRules.hostGroup")}),e.jsx(T,{multiple:!0,value:l.hostGroupIds,onChange:s=>m({...l,hostGroupIds:typeof s.target.value=="string"?s.target.value.split(","):s.target.value}),input:e.jsx(P,{label:a("permissionRules.hostGroup")}),renderValue:s=>e.jsx(i,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:s.length===0?e.jsx("em",{children:a("permissionRules.allHosts")}):s.map(r=>{const t=A.find(x=>x.id===r);return e.jsx(n,{label:t?.name||r,size:"small"},r)})}),children:A.map(s=>e.jsxs(C,{value:s.id,children:[e.jsx(O,{checked:l.hostGroupIds.indexOf(s.id)>-1}),e.jsx(E,{primary:s.name,secondary:`${s.hostCount||0} hosts`})]},s.id))})]}),e.jsx(c,{variant:"caption",color:"textSecondary",sx:{ml:1.5,mt:.5,display:"block"},children:a("permissionRules.hostGroupHelper")})]}),e.jsxs(i,{children:[e.jsxs(i,{sx:{display:"flex",gap:2},children:[e.jsx(g,{fullWidth:!0,label:a("permissionRules.validFrom"),type:"datetime-local",value:l.validFrom,onChange:s=>m({...l,validFrom:s.target.value}),InputLabelProps:{shrink:!0}}),e.jsx(g,{fullWidth:!0,label:a("permissionRules.validTo"),type:"datetime-local",value:l.validTo,onChange:s=>m({...l,validTo:s.target.value}),InputLabelProps:{shrink:!0}})]}),e.jsx(c,{variant:"caption",color:"textSecondary",sx:{ml:1.5,mt:.5,display:"block"},children:a("permissionRules.validityHelper")})]}),e.jsx(i,{children:e.jsx(ds,{control:e.jsx(js,{checked:l.enabled,onChange:s=>m({...l,enabled:s.target.checked})}),label:a("permissionRules.enabled")})}),e.jsx(g,{fullWidth:!0,multiline:!0,rows:3,label:a("permissionRules.description"),value:l.description,onChange:s=>m({...l,description:s.target.value})})]})}),e.jsxs(cs,{children:[e.jsx(G,{onClick:()=>h(!1),children:a("common.cancel")}),e.jsx(G,{variant:"contained",onClick:X,children:a("common.confirm")})]})]}),e.jsx(ys,{open:j.open,autoHideDuration:3e3,onClose:()=>d({...j,open:!1}),children:e.jsx(ms,{severity:j.severity,onClose:()=>d({...j,open:!1}),children:j.message})})]})};export{Rs as default};
