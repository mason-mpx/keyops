import{u as _,ax as ee,r as i,j as e,B as g,T as j,a as m,v as ne,A as te,C as ae,P as re,be as se,I as D,aa as le,g as ie,h as oe,i as F,k as H,l as O,b as B,m as o,M as f,p as L,bf as p,a7 as w}from"./index-z51Q_M-r.js";import{k as C}from"./k8sClusterApi-D8d3s8iX.js";import{T as ce,a as ue,b as me,c as I,d as r,e as de}from"./TableRow-CKQKXB8v.js";import{C as P}from"./Chip-BoE43uAD.js";function xe(){const{t}=_(),W=ee(),[N,z]=i.useState(!1),[E,$]=i.useState([]),[K,b]=i.useState(!1),[c,k]=i.useState(null),[V,q]=i.useState(!1),[y,R]=i.useState(null),[x,A]=i.useState(!1),[M,u]=i.useState(""),s=i.useRef(null),[a,l]=i.useState({name:"",description:"",apiServer:"",token:"",kubeconfig:"",authType:"token",version:"",region:"",environment:"dev",defaultNamespace:""}),v=async()=>{try{z(!0);const n=await C.listClusters();$(n)}catch(n){const h=n?.response?.data?.message||t("cluster.management.loadFailed","获取集群列表失败");p(h)}finally{z(!1)}};i.useEffect(()=>{v()},[]);const G=()=>{k(null),l({name:"",description:"",apiServer:"",token:"",kubeconfig:"",authType:"token",version:"",region:"",environment:"dev",defaultNamespace:""}),b(!0)},J=n=>{k(n),l({name:n.name,description:n.description||"",apiServer:n.apiServer,token:"",kubeconfig:"",authType:n.authType,version:n.version||"",region:n.region||"",environment:n.environment||"dev",defaultNamespace:n.defaultNamespace||""}),b(!0)},S=()=>{s.current&&(clearInterval(s.current),s.current=null),b(!1),k(null),u("")},Q=async()=>{if(!x){if(!a.name){p(t("cluster.management.nameRequired"));return}if(a.authType==="token"&&!a.apiServer){p(t("cluster.management.form.apiServerRequired")+" 是必需的");return}try{if(A(!0),c){const n={description:a.description,apiServer:a.apiServer,authType:a.authType,version:a.version,region:a.region,environment:a.environment,defaultNamespace:a.defaultNamespace};a.token&&(n.token=a.token),a.kubeconfig&&(n.kubeconfig=a.kubeconfig),await C.updateCluster(c.id,n),w(t("cluster.management.updateSuccess"))}else{u(t("cluster.management.connecting","正在连接集群..."));let n=5;s.current=setInterval(()=>{n--,n>0?u(t("cluster.management.connectingWithTime",`正在连接集群... (${n}秒)`)):s.current&&(clearInterval(s.current),s.current=null)},1e3);try{await C.createCluster(a),s.current&&(clearInterval(s.current),s.current=null),u(""),w(t("cluster.management.createSuccess"))}catch(d){throw s.current&&(clearInterval(s.current),s.current=null),u(""),d}}S(),v()}catch(n){const h=n?.response?.data?.message||t("cluster.management.operationFailed");p(h),u("")}finally{s.current&&(clearInterval(s.current),s.current=null),A(!1),u("")}}},U=n=>{R(n),q(!0)},T=()=>{q(!1),R(null)},X=async()=>{if(y)try{await C.deleteCluster(y.id),w(t("cluster.management.deleteSuccess")),T(),v()}catch(n){const h=n?.response?.data?.message||t("cluster.management.operationFailed");p(h)}},Y=n=>{switch(n){case"active":return"success";case"inactive":return"default";case"error":return"error";default:return"default"}},Z=n=>n?t(`cluster.management.environment.${n}`,n):"-";return e.jsxs(g,{sx:{width:"100%",p:3},children:[e.jsxs(g,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,children:[e.jsxs(g,{children:[e.jsx(j,{variant:"h4",component:"h1",fontWeight:"700",children:t("cluster.management.title")}),e.jsx(j,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:t("cluster.management.subtitle")})]}),e.jsxs(g,{display:"flex",gap:2,children:[e.jsx(m,{variant:"outlined",startIcon:e.jsx(ne,{}),onClick:v,disabled:N,children:t("cluster.management.refresh")}),e.jsx(m,{variant:"contained",startIcon:e.jsx(te,{}),onClick:G,children:t("cluster.management.addCluster")})]})]}),N?e.jsx(g,{display:"flex",justifyContent:"center",p:3,children:e.jsx(ae,{})}):e.jsx(ce,{component:re,children:e.jsxs(ue,{children:[e.jsx(me,{children:e.jsxs(I,{children:[e.jsx(r,{children:t("cluster.management.clusterName")}),e.jsx(r,{children:t("cluster.management.apiServer")}),e.jsx(r,{children:t("cluster.management.version")}),e.jsx(r,{children:t("cluster.management.environmentLabel")}),e.jsx(r,{children:t("cluster.management.region")}),e.jsx(r,{children:t("cluster.management.statusLabel")}),e.jsx(r,{children:t("cluster.management.summary")}),e.jsx(r,{children:t("common.createdAt")}),e.jsx(r,{align:"right",children:t("common.actions")})]})}),e.jsx(de,{children:E.length===0?e.jsx(I,{children:e.jsx(r,{colSpan:9,align:"center",children:e.jsx(j,{color:"text.secondary",sx:{py:3},children:t("cluster.management.noData")})})}):E.map(n=>e.jsxs(I,{children:[e.jsx(r,{children:n.name}),e.jsx(r,{children:e.jsx(j,{variant:"body2",sx:{fontFamily:"monospace",fontSize:"0.875rem"},children:n.apiServer})}),e.jsx(r,{children:n.version||"-"}),e.jsx(r,{children:e.jsx(P,{label:Z(n.environment),size:"small",color:n.environment==="prod"?"error":n.environment==="test"?"warning":"info"})}),e.jsx(r,{children:n.region||"-"}),e.jsx(r,{children:e.jsx(P,{label:t(`cluster.management.status.${n.status}`,n.status),size:"small",color:Y(n.status)})}),e.jsx(r,{children:e.jsx(m,{size:"small",variant:"outlined",startIcon:e.jsx(se,{}),onClick:()=>W(`/clusters/${n.id}/status`),children:t("cluster.management.viewStatus")})}),e.jsx(r,{children:new Date(n.createdAt).toLocaleString()}),e.jsxs(r,{align:"right",children:[e.jsx(D,{size:"small",onClick:()=>W(`/clusters/${n.id}/permissions`),color:"primary",title:t("cluster.management.permissions","权限分配"),children:e.jsx(le,{fontSize:"small"})}),e.jsx(D,{size:"small",onClick:()=>J(n),color:"primary",title:t("common.edit"),children:e.jsx(ie,{fontSize:"small"})}),e.jsx(D,{size:"small",onClick:()=>U(n),color:"error",title:t("common.delete"),children:e.jsx(oe,{fontSize:"small"})})]})]},n.id))})]})}),e.jsxs(F,{open:K,onClose:S,maxWidth:"md",fullWidth:!0,children:[e.jsx(H,{children:t(c?"cluster.management.editCluster":"cluster.management.addCluster")}),e.jsxs(O,{children:[M&&e.jsx(B,{severity:"info",sx:{mb:2},children:M}),e.jsxs(g,{sx:{display:"flex",flexDirection:"column",gap:2,pt:2},children:[e.jsx(o,{label:t("cluster.management.form.nameRequired"),value:a.name,onChange:n=>l({...a,name:n.target.value}),disabled:!!c,fullWidth:!0,required:!0}),e.jsx(o,{label:t("cluster.management.form.description"),value:a.description,onChange:n=>l({...a,description:n.target.value}),multiline:!0,rows:3,fullWidth:!0}),e.jsxs(o,{label:t("cluster.management.form.authType"),value:a.authType,onChange:n=>{const d=n.target.value;l(d==="token"?{...a,authType:"token",kubeconfig:"",apiServer:""}:{...a,authType:"kubeconfig",token:"",apiServer:""})},select:!0,fullWidth:!0,required:!0,children:[e.jsx(f,{value:"token",children:"Token"}),e.jsx(f,{value:"kubeconfig",children:"Kubeconfig"})]}),a.authType==="token"&&e.jsx(o,{label:t("cluster.management.form.apiServerRequired"),value:a.apiServer,onChange:n=>l({...a,apiServer:n.target.value}),fullWidth:!0,required:!0,placeholder:t("cluster.management.form.apiServerPlaceholder")}),a.authType==="token"&&e.jsx(o,{label:t("cluster.management.form.token"),value:a.token,onChange:n=>l({...a,token:n.target.value}),type:"password",fullWidth:!0,required:!0,helperText:t(c?"cluster.management.form.tokenHelperEdit":"cluster.management.form.tokenHelper")}),a.authType==="kubeconfig"&&e.jsx(o,{label:t("cluster.management.form.kubeconfig"),value:a.kubeconfig,onChange:n=>l({...a,kubeconfig:n.target.value}),multiline:!0,rows:5,fullWidth:!0,required:!0,helperText:t(c?"cluster.management.form.kubeconfigHelperEdit":"cluster.management.form.kubeconfigHelper")}),c&&e.jsx(o,{label:t("cluster.management.form.version"),value:a.version,fullWidth:!0,disabled:!0,helperText:t("cluster.management.form.versionHelper","版本信息由集群自动获取")}),e.jsxs(o,{label:t("cluster.management.form.environment"),value:a.environment,onChange:n=>l({...a,environment:n.target.value}),select:!0,fullWidth:!0,children:[e.jsx(f,{value:"dev",children:t("cluster.management.environment.dev")}),e.jsx(f,{value:"test",children:t("cluster.management.environment.test")}),e.jsx(f,{value:"prod",children:t("cluster.management.environment.prod")})]}),e.jsx(o,{label:t("cluster.management.form.region"),value:a.region,onChange:n=>l({...a,region:n.target.value}),fullWidth:!0}),e.jsx(o,{label:t("cluster.management.form.defaultNamespace"),value:a.defaultNamespace,onChange:n=>l({...a,defaultNamespace:n.target.value}),fullWidth:!0,placeholder:t("cluster.management.form.defaultNamespacePlaceholder")})]})]}),e.jsxs(L,{children:[e.jsx(m,{onClick:S,disabled:x,children:t("common.cancel")}),e.jsx(m,{onClick:Q,variant:"contained",disabled:x,children:x?t("common.saving","保存中..."):t("common.save")})]})]}),e.jsxs(F,{open:V,onClose:T,children:[e.jsx(H,{children:t("cluster.management.deleteConfirm")}),e.jsx(O,{children:e.jsxs(B,{severity:"warning",sx:{mb:2},children:[t("cluster.management.deleteConfirmMessage")," ",e.jsx("strong",{children:y?.name})," ",t("cluster.management.deleteWarning")]})}),e.jsxs(L,{children:[e.jsx(m,{onClick:T,children:t("common.cancel")}),e.jsx(m,{onClick:X,variant:"contained",color:"error",children:t("cluster.management.deleteConfirm")})]})]})]})}export{xe as default};
