import{u as X,r,c3 as C,bf as j,j as t,B as d,P as Z,T as I,d as w,I as T,v as ee,a as S,A as te,b as R,C as ne,W as q,i as ie,k as se,l as re,m as c,M as h,_ as ae,p as le,a7 as z,b6 as oe,b7 as de,b8 as ce,b9 as ue,ba as he,Y as pe,g as xe,h as me,bb as fe}from"./index-OJNN34VQ.js";import{S as je}from"./Switch-BGuUO65b.js";function Ce(){const{t:A}=X(),[g,G]=r.useState([]),[D,k]=r.useState(!1),[H,p]=r.useState(!1),[x,E]=r.useState("create"),[y,N]=r.useState({}),[U,W]=r.useState(new Set),[B,O]=r.useState(""),u=e=>A(`menu.organizations.unitTypes.${e}`,e),[n,a]=r.useState({unitCode:"",unitName:"",unitType:"Department",unitOwner:"",isActive:!0,parentId:"",sortOrder:0,description:""}),b=r.useCallback(e=>{let s=[];return e.forEach(i=>{s.push(i.id),i.children&&i.children.length>0&&(s=s.concat(b(i.children)))}),s},[]),m=r.useCallback(async()=>{k(!0),O("");try{const e=await C.getOrganizationTree();G(Array.isArray(e)?e:[]);const s=b(Array.isArray(e)?e:[]);W(new Set(s))}catch(e){const s=e,i=s?.response?.data?.message||s?.message||"加载组织列表失败";O(i),j(i)}finally{k(!1)}},[b]),L=e=>{let s=[];return e.forEach(i=>{s.push(i),i.children&&i.children.length>0&&(s=s.concat(L(i.children)))}),s},M=(e,s)=>{let i=[];const o=(f,V)=>{for(const v of V){if(v.id===f)return v;if(v.children){const F=o(f,v.children);if(F)return F}}return null},l=o(e,s);return l&&l.children&&l.children.forEach(f=>{i.push(f.id),i=i.concat(M(f.id,s))}),i};r.useEffect(()=>{m()},[m]);const Y=()=>{E("create"),N({}),a({unitCode:"",unitName:"",unitType:"Department",unitOwner:"",isActive:!0,parentId:"",sortOrder:0,description:""}),p(!0)},_=e=>{E("edit"),N(e),a({unitCode:e.unitCode,unitName:e.unitName,unitType:e.unitType,unitOwner:e.unitOwner||"",isActive:e.isActive,parentId:e.parentId||"",sortOrder:e.sortOrder,description:e.description||""}),p(!0)},$=async e=>{if(window.confirm("确定要删除该组织吗？删除后无法恢复。"))try{await C.deleteOrganization(e),z("删除成功"),m()}catch(s){const i=s,o=i?.response?.data?.message||i?.message||"删除失败";j(o)}},J=async()=>{if(!n.unitName.trim()){j("请输入组织名称");return}if(x==="create"&&!n.unitCode.trim()){j("请输入组织标识符");return}try{x==="create"?(await C.createOrganization({unitCode:n.unitCode,unitName:n.unitName,unitType:n.unitType,unitOwner:n.unitOwner||void 0,isActive:n.isActive,parentId:n.parentId||void 0,sortOrder:n.sortOrder,description:n.description||void 0}),z("创建成功")):(await C.updateOrganization(y.id,{unitName:n.unitName,unitType:n.unitType,unitOwner:n.unitOwner||void 0,isActive:n.isActive,parentId:n.parentId||void 0,sortOrder:n.sortOrder,description:n.description||void 0}),z("更新成功")),p(!1),m()}catch(e){const s=e,i=s?.response?.data?.message||s?.message||"保存失败";j(i)}},K=e=>{W(s=>{const i=new Set(s);return i.has(e)?i.delete(e):i.add(e),i})},P=(e,s=0)=>{const i=e.children&&e.children.length>0,o=U.has(e.id);return t.jsxs(oe.Fragment,{children:[t.jsxs(de,{onClick:()=>{i&&K(e.id)},sx:{pl:s*2+2,py:.75,minHeight:48,borderRadius:1,mb:.25,"&:hover":{backgroundColor:"action.hover"}},children:[t.jsx(ce,{sx:{minWidth:28},children:i?o?t.jsx(ue,{sx:{fontSize:18}}):t.jsx(he,{sx:{fontSize:18}}):t.jsx(d,{sx:{width:18}})}),t.jsx(pe,{primary:t.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,width:"100%"},children:[t.jsx(I,{variant:"body2",sx:{flex:1},children:e.unitName}),t.jsxs(I,{variant:"caption",color:"text.secondary",sx:{mr:1},children:["(",u(e.unitType),")"]}),t.jsx(w,{title:"编辑",children:t.jsx(T,{size:"small",onClick:l=>{l.stopPropagation(),_(e)},children:t.jsx(xe,{fontSize:"small"})})}),t.jsx(w,{title:"删除",children:t.jsx(T,{size:"small",color:"error",onClick:l=>{l.stopPropagation(),$(e.id)},children:t.jsx(me,{fontSize:"small"})})})]})})]}),i&&t.jsx(fe,{in:o,timeout:"auto",unmountOnExit:!0,children:t.jsx(q,{component:"div",disablePadding:!0,children:e.children.map(l=>P(l,s+1))})})]},e.id)},Q=L(g);return t.jsx(d,{children:t.jsxs(Z,{sx:{p:3},children:[t.jsxs(d,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[t.jsx(I,{variant:"h5",children:A("menu.departments")}),t.jsxs(d,{children:[t.jsx(w,{title:"刷新",children:t.jsx(T,{onClick:m,disabled:D,children:t.jsx(ee,{})})}),t.jsx(S,{variant:"contained",startIcon:t.jsx(te,{}),onClick:Y,sx:{ml:1},children:"新建组织"})]})]}),B&&t.jsx(R,{severity:"error",sx:{mb:2},onClose:()=>O(""),children:B}),D?t.jsx(d,{sx:{display:"flex",justifyContent:"center",p:4},children:t.jsx(ne,{})}):g.length===0?t.jsx(R,{severity:"info",children:"暂无组织数据"}):t.jsx(q,{sx:{width:"100%",bgcolor:"background.paper"},children:g.map(e=>P(e,0))}),t.jsxs(ie,{open:H,onClose:()=>p(!1),maxWidth:"sm",fullWidth:!0,children:[t.jsx(se,{children:x==="create"?"新建组织":"编辑组织"}),t.jsx(re,{children:t.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:2,pt:1},children:[x==="create"&&t.jsx(c,{label:"组织标识符",value:n.unitCode,onChange:e=>a({...n,unitCode:e.target.value}),required:!0,fullWidth:!0,helperText:"唯一标识符，创建后不可修改"}),t.jsx(c,{label:"组织名称",value:n.unitName,onChange:e=>a({...n,unitName:e.target.value}),required:!0,fullWidth:!0}),t.jsxs(c,{label:"组织类型",value:n.unitType,onChange:e=>a({...n,unitType:e.target.value}),select:!0,required:!0,fullWidth:!0,children:[t.jsx(h,{value:"BizGroup",children:u("BizGroup")}),t.jsx(h,{value:"LineOfBiz",children:u("LineOfBiz")}),t.jsx(h,{value:"Site",children:u("Site")}),t.jsx(h,{value:"Department",children:u("Department")})]}),t.jsx(c,{label:"组织负责人",value:n.unitOwner,onChange:e=>a({...n,unitOwner:e.target.value}),fullWidth:!0}),t.jsxs(c,{label:"父级组织",value:n.parentId,onChange:e=>a({...n,parentId:e.target.value}),select:!0,fullWidth:!0,children:[t.jsx(h,{value:"",children:"无（顶级组织）"}),Q.filter(e=>x==="create"?!0:e.id===y.id?!1:!M(y.id,g).includes(e.id)).map(e=>t.jsxs(h,{value:e.id,children:[e.unitName," (",u(e.unitType),")"]},e.id))]}),t.jsx(c,{label:"排序顺序",type:"number",value:n.sortOrder,onChange:e=>a({...n,sortOrder:parseInt(e.target.value)||0}),fullWidth:!0}),t.jsx(c,{label:"描述",value:n.description,onChange:e=>a({...n,description:e.target.value}),multiline:!0,rows:3,fullWidth:!0}),t.jsx(ae,{control:t.jsx(je,{checked:n.isActive,onChange:e=>a({...n,isActive:e.target.checked})}),label:"启用"})]})}),t.jsxs(le,{children:[t.jsx(S,{onClick:()=>p(!1),children:"取消"}),t.jsx(S,{onClick:J,variant:"contained",children:"保存"})]})]})]})})}export{Ce as default};
