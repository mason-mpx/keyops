import{u as ee,r as o,j as e,B as x,C as se,T as u,S as _,a as b,A as te,D as ne,b as v,P as le,c as ae,E as ie,d as C,I as T,e as re,f as ce,g as oe,h as de,i as ue,k as xe,l as ye,m as r,F as A,n as B,o as M,M as f,U as he,p as pe,q as p}from"./index-DNdAKB9f.js";import{S as D}from"./Stack-6rKlDBQM.js";import{T as ge,a as me,b as je,c as O,d as a,e as Se}from"./TableRow-2FuGKbnY.js";import{C as g}from"./Chip-B8lB6W_F.js";function Te(){const{t}=ee(),[R,I]=o.useState(!1),[U,z]=o.useState(!1),[E,J]=o.useState([]),[L,P]=o.useState(!1),[h,w]=o.useState(null),[n,d]=o.useState({name:"",type:"prometheus",enabled:!0,url:"",auth_type:"none",username:"",password:"",token:"",sync_interval:0,config:""}),[q,m]=o.useState("up"),[c,j]=o.useState(null),[i,y]=o.useState({name:"A",ip:"B",port:"C",deviceType:"D",tags:"E",description:"F"}),S=async()=>{I(!0);try{const s=await p.getConfigs();J(s.configs||[])}catch(s){console.error("Failed to load configs:",s)}finally{I(!1)}};o.useEffect(()=>{S()},[]);const H=s=>{if(s){if(w(s),d({name:s.name,type:s.type,enabled:s.enabled,url:s.url,auth_type:s.auth_type,username:s.username,password:s.password,token:s.token,sync_interval:0,config:s.config}),s.type==="prometheus"&&s.config)try{const l=JSON.parse(s.config);m(l.query||"up")}catch{m("up")}else if(s.type==="excel"&&s.config)try{const l=JSON.parse(s.config);l.columnMapping&&y(l.columnMapping)}catch{}else m("up");j(null)}else w(null),d({name:"",type:"prometheus",enabled:!0,url:"",auth_type:"none",username:"",password:"",token:"",sync_interval:0,config:""}),m("up"),j(null);P(!0)},F=()=>{P(!1),w(null),j(null)},Q=s=>{const l=s.target.files?.[0];l&&(l.type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"||l.type==="application/vnd.ms-excel"||l.name.endsWith(".xlsx")||l.name.endsWith(".xls")?j(l):alert(t("settings.assetSync.excel.invalidFileType")))},G=async()=>{try{const s={...n,sync_interval:0};if(n.type==="prometheus")s.config=JSON.stringify({query:q}),s.url=n.url||"";else if(n.type==="excel"){if(!c&&!h){alert(t("settings.assetSync.excel.fileRequired"));return}let l="";if(c){const W=new FileReader;await new Promise((Z,N)=>{W.onload=$=>{const k=$.target?.result;typeof k=="string"?(l=k.split(",")[1]||k,Z()):N(new Error("Failed to read file"))},W.onerror=N,W.readAsDataURL(c)})}s.config=JSON.stringify({columnMapping:i,fileName:c?.name||"",fileData:l}),s.url=c?c.name:n.url||""}h?(await p.updateConfig(h.id,s),alert(t("settings.assetSync.messages.updateSuccess"))):(await p.createConfig(s),alert(t("settings.assetSync.messages.createSuccess"))),F(),S()}catch(s){console.error("Failed to save config:",s),alert(t("settings.assetSync.messages.saveFailed")+": "+s.message)}},K=async s=>{if(confirm(t("settings.assetSync.deleteConfirm")))try{await p.deleteConfig(s),alert(t("settings.assetSync.messages.deleteSuccess")),S()}catch(l){console.error("Failed to delete config:",l),alert(t("settings.assetSync.messages.saveFailed"))}},V=async s=>{try{await p.toggleConfig(s),S()}catch(l){console.error("Failed to toggle config:",l),alert(t("settings.assetSync.messages.saveFailed"))}},X=async s=>{z(!0);try{const l=await p.syncNow(s);alert(l.message||t("settings.assetSync.messages.syncStarted")),setTimeout(()=>S(),3e3)}catch(l){console.error("Failed to sync:",l),alert(t("settings.assetSync.messages.syncFailed"))}finally{z(!1)}},Y=s=>s?new Date(s).toLocaleString():"-";return R?e.jsx(x,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(se,{})}):e.jsx(x,{sx:{p:3},children:e.jsxs(D,{spacing:4,children:[e.jsxs(x,{children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[e.jsxs(x,{children:[e.jsxs(u,{variant:"h5",fontWeight:600,sx:{display:"flex",alignItems:"center"},children:[e.jsx(_,{sx:{mr:1}})," ",t("settings.assetSync.title")]}),e.jsx(u,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:t("settings.assetSync.subtitle")})]}),e.jsx(b,{variant:"contained",startIcon:e.jsx(te,{}),onClick:()=>H(),children:t("settings.assetSync.addConfig")})]}),e.jsx(ne,{})]}),E.length===0?e.jsx(v,{severity:"info",children:t("settings.assetSync.noConfigs")}):e.jsx(ge,{component:le,variant:"outlined",children:e.jsxs(me,{children:[e.jsx(je,{children:e.jsxs(O,{children:[e.jsx(a,{children:t("settings.assetSync.table.name")}),e.jsx(a,{children:t("settings.assetSync.table.type")}),e.jsx(a,{children:t("settings.assetSync.table.url")}),e.jsx(a,{children:t("settings.assetSync.table.lastSync")}),e.jsx(a,{align:"center",children:t("settings.assetSync.table.status")}),e.jsx(a,{align:"center",children:t("settings.assetSync.table.syncedCount")}),e.jsx(a,{align:"right",children:t("settings.assetSync.table.actions")})]})}),e.jsx(Se,{children:E.map(s=>e.jsxs(O,{children:[e.jsx(a,{children:e.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[s.name,s.enabled?e.jsx(g,{label:t("common.enabled"),size:"small",color:"success"}):e.jsx(g,{label:t("common.disabled"),size:"small",color:"default"})]})}),e.jsx(a,{children:e.jsx(g,{label:s.type==="prometheus"?"Prometheus":s.type==="excel"?"Excel":s.type,size:"small",variant:"outlined"})}),e.jsx(a,{children:e.jsx(u,{variant:"body2",sx:{maxWidth:300,overflow:"hidden",textOverflow:"ellipsis"},children:s.url})}),e.jsx(a,{children:e.jsx(u,{variant:"body2",color:"text.secondary",children:Y(s.last_sync_time)})}),e.jsx(a,{align:"center",children:s.last_sync_status==="success"?e.jsx(g,{icon:e.jsx(ae,{}),label:t("settings.assetSync.status.success"),size:"small",color:"success"}):s.last_sync_status==="failed"?e.jsx(g,{icon:e.jsx(ie,{}),label:t("settings.assetSync.status.failed"),size:"small",color:"error"}):e.jsx(g,{label:t("settings.assetSync.status.notSynced"),size:"small",variant:"outlined"})}),e.jsx(a,{align:"center",children:s.synced_count?e.jsxs(u,{variant:"body2",children:[s.synced_count," ",t("common.total")]}):e.jsxs(u,{variant:"body2",color:"text.disabled",children:["0 ",t("common.total")]})}),e.jsx(a,{align:"right",children:e.jsxs(x,{sx:{display:"flex",gap:.5,justifyContent:"flex-end"},children:[e.jsx(C,{title:s.enabled?t("settings.assetSync.actions.disable"):t("settings.assetSync.actions.enable"),children:e.jsx(T,{size:"small",color:s.enabled?"warning":"success",onClick:()=>V(s.id),children:s.enabled?e.jsx(re,{}):e.jsx(ce,{})})}),e.jsx(C,{title:t("settings.assetSync.actions.syncNow"),children:e.jsx(T,{size:"small",color:"primary",onClick:()=>X(s.id),disabled:!s.enabled||U,children:e.jsx(_,{})})}),e.jsx(C,{title:t("settings.assetSync.actions.edit"),children:e.jsx(T,{size:"small",color:"info",onClick:()=>H(s),children:e.jsx(oe,{})})}),e.jsx(C,{title:t("settings.assetSync.actions.delete"),children:e.jsx(T,{size:"small",color:"error",onClick:()=>K(s.id),children:e.jsx(de,{})})})]})})]},s.id))})]})}),e.jsxs(v,{severity:"info",icon:e.jsx(_,{}),children:[e.jsx(u,{variant:"body2",fontWeight:"bold",gutterBottom:!0,children:t("settings.assetSync.tips.title")}),e.jsxs(u,{variant:"body2",component:"div",children:["• ",e.jsx("strong",{children:"Prometheus"}),": ",t("settings.assetSync.tips.prometheus"),e.jsx("br",{}),"• ",e.jsx("strong",{children:"Excel"}),": ",t("settings.assetSync.tips.excel")]})]}),e.jsxs(ue,{open:L,onClose:F,maxWidth:"sm",fullWidth:!0,children:[e.jsx(xe,{children:t(h?"settings.assetSync.editConfig":"settings.assetSync.addConfig")}),e.jsx(ye,{children:e.jsxs(D,{spacing:2.5,sx:{mt:1},children:[e.jsx(r,{fullWidth:!0,label:t("settings.assetSync.configName"),value:n.name,onChange:s=>d({...n,name:s.target.value}),required:!0}),e.jsxs(A,{fullWidth:!0,children:[e.jsx(B,{children:t("settings.assetSync.syncType")}),e.jsxs(M,{value:n.type,label:t("settings.assetSync.syncType"),onChange:s=>{const l=s.target.value;d({...n,type:l}),l==="excel"&&j(null)},children:[e.jsx(f,{value:"prometheus",children:"Prometheus"}),e.jsx(f,{value:"excel",children:"Excel"})]})]}),n.type==="prometheus"&&e.jsxs(e.Fragment,{children:[e.jsx(r,{fullWidth:!0,label:t("settings.assetSync.apiUrl"),value:n.url,onChange:s=>d({...n,url:s.target.value}),placeholder:t("settings.assetSync.apiUrlPlaceholder"),required:!0}),e.jsx(r,{fullWidth:!0,label:t("settings.assetSync.promqlQuery"),value:q,onChange:s=>m(s.target.value),placeholder:t("settings.assetSync.promqlPlaceholder"),helperText:t("settings.assetSync.promqlHelper"),multiline:!0,rows:2})]}),n.type==="excel"&&e.jsxs(e.Fragment,{children:[e.jsxs(x,{children:[e.jsx("input",{accept:".xlsx,.xls",style:{display:"none"},id:"excel-file-upload",type:"file",onChange:Q}),e.jsx("label",{htmlFor:"excel-file-upload",children:e.jsx(b,{variant:"outlined",component:"span",startIcon:e.jsx(he,{}),fullWidth:!0,sx:{mb:2},children:c?c.name:t("settings.assetSync.excel.selectFile")})}),c&&e.jsxs(v,{severity:"success",sx:{mb:2},children:[t("settings.assetSync.excel.fileSelected"),": ",c.name]})]}),e.jsx(u,{variant:"subtitle2",sx:{mb:1,fontWeight:600},children:t("settings.assetSync.excel.columnMapping")}),e.jsxs(D,{spacing:2,children:[e.jsx(r,{fullWidth:!0,size:"small",label:t("settings.assetSync.excel.nameColumn"),value:i.name,onChange:s=>y({...i,name:s.target.value}),helperText:t("settings.assetSync.excel.columnHelper")}),e.jsx(r,{fullWidth:!0,size:"small",label:t("settings.assetSync.excel.ipColumn"),value:i.ip,onChange:s=>y({...i,ip:s.target.value}),helperText:t("settings.assetSync.excel.columnHelper")}),e.jsx(r,{fullWidth:!0,size:"small",label:t("settings.assetSync.excel.portColumn"),value:i.port,onChange:s=>y({...i,port:s.target.value}),helperText:t("settings.assetSync.excel.columnHelper")}),e.jsx(r,{fullWidth:!0,size:"small",label:t("settings.assetSync.excel.deviceTypeColumn"),value:i.deviceType,onChange:s=>y({...i,deviceType:s.target.value}),helperText:t("settings.assetSync.excel.columnHelper")}),e.jsx(r,{fullWidth:!0,size:"small",label:t("settings.assetSync.excel.tagsColumn"),value:i.tags,onChange:s=>y({...i,tags:s.target.value}),helperText:t("settings.assetSync.excel.columnHelper")}),e.jsx(r,{fullWidth:!0,size:"small",label:t("settings.assetSync.excel.descriptionColumn"),value:i.description,onChange:s=>y({...i,description:s.target.value}),helperText:t("settings.assetSync.excel.columnHelper")})]}),e.jsx(v,{severity:"info",sx:{mt:2},children:t("settings.assetSync.excel.formatHelper")})]}),n.type==="prometheus"&&e.jsxs(e.Fragment,{children:[e.jsxs(A,{fullWidth:!0,children:[e.jsx(B,{children:t("settings.assetSync.authType")}),e.jsxs(M,{value:n.auth_type,label:t("settings.assetSync.authType"),onChange:s=>d({...n,auth_type:s.target.value}),children:[e.jsx(f,{value:"none",children:t("settings.assetSync.authNone")}),e.jsx(f,{value:"basic",children:t("settings.assetSync.authBasic")}),e.jsx(f,{value:"token",children:t("settings.assetSync.authToken")})]})]}),n.auth_type==="basic"&&e.jsxs(e.Fragment,{children:[e.jsx(r,{fullWidth:!0,label:t("settings.assetSync.username"),value:n.username,onChange:s=>d({...n,username:s.target.value})}),e.jsx(r,{fullWidth:!0,label:t("settings.assetSync.password"),type:"password",value:n.password,onChange:s=>d({...n,password:s.target.value})})]}),n.auth_type==="token"&&e.jsx(r,{fullWidth:!0,label:t("settings.assetSync.token"),value:n.token,onChange:s=>d({...n,token:s.target.value}),multiline:!0,rows:2})]})]})}),e.jsxs(pe,{children:[e.jsx(b,{onClick:F,children:t("common.cancel")}),e.jsx(b,{variant:"contained",onClick:G,disabled:!n.name||n.type==="prometheus"&&!n.url||n.type==="excel"&&!c&&!h,children:t(h?"common.save":"common.create")})]})]})]})})}export{Te as default};
