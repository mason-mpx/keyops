import{u as ce,bg as xe,ax as pe,r as c,j as e,B as a,C as A,b as h,a as m,aA as F,I as N,T as i,d as he,v as me,bm as U,cA as je,w as j,x as v,a3 as ye,a4 as C,a2 as fe,Z as ge,bl as ue,cG as be,i as ke,k as ve,l as Ce,p as Se,bf as T,a7 as we}from"./index-DNdAKB9f.js";import{k as W,l as De,m as Ae,n as Ie,o as Re}from"./index-CR_954yY.js";import{P as Be,Y as Te}from"./PodActions-0Tf8DQqY.js";import{G as $}from"./GridLegacy-Bg8nSEpP.js";import{C as y}from"./Chip-B8lB6W_F.js";import{R as V,C as Z,X as _,Y as q,T as J,L as Q}from"./CartesianChart-Z4MMshd-.js";import{L as ee}from"./LineChart-Dr39Uq0_.js";import{L as se}from"./Line-CPjPyFDu.js";import"./utils-5I4TgzTo.js";import"./yaml-xSLLCrpq.js";import"./index-CNgOdE3q.js";import"./k8sClusterApi-YbI-1DRG.js";import"./PodLogsDialog-BhpZFNfn.js";import"./xterm-BqYE0GQX.js";import"./Switch-psoPU8CH.js";import"./value-DEjY8fVb.js";function S(t){const{children:o,value:r,index:l,...w}=t;return e.jsx("div",{role:"tabpanel",hidden:r!==l,id:`statefulset-tabpanel-${l}`,"aria-labelledby":`statefulset-tab-${l}`,...w,children:r===l&&e.jsx(a,{sx:{p:3},children:o})})}function Ve(){const{t}=ce(),{clusterId:o,namespace:r,name:l}=xe(),w=pe(),[te,P]=c.useState(!0),[d,ne]=c.useState(null),[L,M]=c.useState(null),[p,ae]=c.useState(0),[ie,Y]=c.useState(!1),[f,z]=c.useState(null),[le,E]=c.useState(!1),[re,D]=c.useState(!1),[g,oe]=c.useState([]),[O,K]=c.useState(!1),[X,G]=c.useState(!1),u=async()=>{if(!(!o||!r||!l))try{P(!0),M(null);const n=await De({clusterId:o,namespace:r},l);ne(n),de(),I()}catch(s){const n=(s&&typeof s=="object"&&"response"in s&&s.response&&typeof s.response=="object"&&"data"in s.response&&s.response.data&&typeof s.response.data=="object"&&"message"in s.response.data&&typeof s.response.data.message=="string"?s.response.data.message:null)||t("k8s.statefulSets.loadDetailFailed","获取StatefulSet详情失败");M(n||""),T(n||"")}finally{P(!1)}},de=async()=>{if(!(!o||!r||!l))try{E(!0);const n=await Ae({clusterId:o,namespace:r},l,3600,300);z(n)}catch(s){console.error("加载监控数据失败:",s),z(null)}finally{E(!1)}},I=async()=>{if(!(!o||!r||!l))try{K(!0);const n=await Ie({clusterId:o,namespace:r},l);oe(n.revisions)}catch(s){const n=(s&&typeof s=="object"&&"response"in s&&s.response&&typeof s.response=="object"&&"data"in s.response&&s.response.data&&typeof s.response.data=="object"&&"message"in s.response.data&&typeof s.response.data.message=="string"?s.response.data.message:null)||"加载历史版本失败";T(n)}finally{K(!1)}},H=async s=>{if(!(!o||!r||!l))try{G(!0),await Re({clusterId:o,namespace:r},l,s),we(`已成功回滚到版本 ${s}`),D(!1),u(),I()}catch(n){const x=(n&&typeof n=="object"&&"response"in n&&n.response&&typeof n.response=="object"&&"data"in n.response&&n.response.data&&typeof n.response.data=="object"&&"message"in n.response.data&&typeof n.response.data.message=="string"?n.response.data.message:null)||"回滚失败";T(x)}finally{G(!1)}};c.useEffect(()=>{o&&r&&l&&u()},[o,r,l]),c.useEffect(()=>{if(!o||!r||!l)return;const s=setInterval(()=>{u()},3e4);return()=>clearInterval(s)},[o,r,l]);const R=(s,n)=>n==null||n===""?null:e.jsxs(a,{sx:{mb:2},children:[e.jsx(i,{variant:"caption",color:"text.secondary",display:"block",children:s}),e.jsx(i,{variant:"body1",fontWeight:500,children:String(n)})]});return te&&!d?e.jsx(a,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"60vh"},children:e.jsx(A,{})}):L&&!d?e.jsxs(a,{sx:{p:3},children:[e.jsx(h,{severity:"error",children:L}),e.jsx(m,{startIcon:e.jsx(F,{}),onClick:()=>w("/k8s/statefulsets"),sx:{mt:2},children:t("common.back")})]}):e.jsxs(a,{sx:{width:"100%",p:3},children:[e.jsxs(a,{sx:{mb:3,display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap",gap:2},children:[e.jsxs(a,{sx:{display:"flex",alignItems:"center",gap:2},children:[e.jsx(N,{onClick:()=>w("/k8s/statefulsets"),children:e.jsx(F,{})}),e.jsxs(a,{children:[e.jsx(i,{variant:"h4",component:"h1",fontWeight:"700",children:l}),e.jsxs(i,{variant:"body2",color:"text.secondary",children:[r," / ",o]})]})]}),e.jsxs(a,{sx:{display:"flex",gap:1},children:[e.jsx(he,{title:t("common.refresh"),children:e.jsx(N,{onClick:u,children:e.jsx(me,{})})}),e.jsx(m,{variant:"outlined",startIcon:e.jsx(U,{}),onClick:()=>{D(!0),I()},children:t("k8s.deployments.rollback","回滚")}),e.jsx(m,{variant:"outlined",startIcon:e.jsx(je,{}),onClick:()=>Y(!0),children:t("k8s.viewYaml")})]})]}),e.jsxs(a,{sx:{display:"flex",gap:2,mb:3,width:"100%",flexWrap:{xs:"wrap",sm:"nowrap"}},children:[e.jsx(j,{sx:{flex:1,minWidth:{xs:"100%",sm:0},display:"flex",flexDirection:"column"},children:e.jsxs(v,{sx:{flex:1,display:"flex",flexDirection:"column",justifyContent:"center",minHeight:120},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{mb:1},children:t("k8s.replicas")}),e.jsx(i,{variant:"h4",fontWeight:"600",children:d?.replicas||0})]})}),e.jsx(j,{sx:{flex:1,minWidth:{xs:"100%",sm:0},display:"flex",flexDirection:"column"},children:e.jsxs(v,{sx:{flex:1,display:"flex",flexDirection:"column",justifyContent:"center",minHeight:120},children:[e.jsx(i,{variant:"caption",color:"text.secondary",sx:{mb:1},children:t("k8s.statefulSets.ready","就绪")}),e.jsx(i,{variant:"h4",fontWeight:"600",color:"success.main",children:d?.ready||0})]})})]}),e.jsxs(j,{children:[e.jsx(a,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(ye,{value:p,onChange:(s,n)=>ae(n),children:[e.jsx(C,{icon:e.jsx(fe,{}),iconPosition:"start",label:t("k8s.basicInfo")}),e.jsx(C,{icon:e.jsx(ge,{}),iconPosition:"start",label:`${t("k8s.pods.title")} (${d?.pods?.length||0})`}),e.jsx(C,{icon:e.jsx(ue,{}),iconPosition:"start",label:`${t("k8s.events.title")} (${d?.events?.length||0})`}),e.jsx(C,{icon:e.jsx(be,{}),iconPosition:"start",label:t("k8s.monitoring","监控")}),e.jsx(C,{icon:e.jsx(U,{}),iconPosition:"start",label:`${t("k8s.deployments.history","历史版本")} (${g.length})`})]})}),e.jsx(S,{value:p,index:0,children:e.jsxs($,{container:!0,spacing:3,children:[e.jsxs($,{item:!0,xs:12,md:6,children:[e.jsx(i,{variant:"h6",sx:{mb:2},children:t("k8s.basicInfo")}),R(t("k8s.name"),d?.name),R(t("k8s.namespace"),d?.namespace),R(t("k8s.age"),d?.age)]}),e.jsxs($,{item:!0,xs:12,md:6,children:[e.jsx(i,{variant:"h6",sx:{mb:2},children:t("k8s.labels")}),d?.labels&&Object.keys(d.labels).length>0?e.jsx(a,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:Object.entries(d.labels).map(([s,n])=>e.jsx(y,{label:`${s}=${n}`,size:"small"},s))}):e.jsx(i,{variant:"body2",color:"text.secondary",children:t("common.noData")})]})]})}),e.jsx(S,{value:p,index:1,children:d?.pods&&d.pods.length>0?e.jsxs(a,{children:[e.jsx(i,{variant:"h6",sx:{mb:2},children:t("k8s.pods.title")}),e.jsx(a,{sx:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{borderBottom:"1px solid #e0e0e0"},children:[e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.name")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.status")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.node")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.restarts")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.age")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("common.actions")})]})}),e.jsx("tbody",{children:d.pods.map((s,n)=>e.jsxs("tr",{style:{borderBottom:"1px solid #f0f0f0"},children:[e.jsx("td",{style:{padding:"12px"},children:s.name}),e.jsx("td",{style:{padding:"12px"},children:e.jsx(y,{label:s.status,color:s.status==="Running"?"success":"default",size:"small"})}),e.jsx("td",{style:{padding:"12px"},children:s.node||"-"}),e.jsx("td",{style:{padding:"12px"},children:s.restarts||0}),e.jsx("td",{style:{padding:"12px"},children:s.age||"-"}),e.jsx("td",{style:{padding:"12px"},children:e.jsx(Be,{pod:s,clusterId:o||"",namespace:r||""})})]},n))})]})})]}):e.jsx(h,{severity:"info",children:t("common.noData")})}),e.jsx(S,{value:p,index:2,children:d?.events&&d.events.length>0?e.jsxs(a,{children:[e.jsx(i,{variant:"h6",sx:{mb:2},children:t("k8s.events.title")}),e.jsx(a,{sx:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{borderBottom:"1px solid #e0e0e0"},children:[e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.type")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.reason")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.message")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.count")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.lastSeen")})]})}),e.jsx("tbody",{children:d.events.map((s,n)=>e.jsxs("tr",{style:{borderBottom:"1px solid #f0f0f0"},children:[e.jsx("td",{style:{padding:"12px"},children:e.jsx(y,{label:s.type,color:s.type==="Warning"?"warning":"info",size:"small"})}),e.jsx("td",{style:{padding:"12px"},children:s.reason}),e.jsx("td",{style:{padding:"12px"},children:s.message}),e.jsx("td",{style:{padding:"12px"},children:s.count}),e.jsx("td",{style:{padding:"12px"},children:s.lastSeen})]},n))})]})})]}):e.jsx(h,{severity:"info",children:t("common.noData")})}),e.jsxs(S,{value:p,index:3,children:[e.jsx(i,{variant:"h6",sx:{mb:3},children:t("k8s.monitoring","监控")}),le?e.jsx(a,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(A,{})}):f&&f.metrics&&f.metrics.length>0?e.jsxs(a,{sx:{display:"flex",flexDirection:"column",gap:3,width:"100%"},children:[e.jsx(j,{sx:{width:"100%"},children:e.jsxs(v,{children:[e.jsx(i,{variant:"subtitle1",sx:{mb:2},children:"CPU 使用率 (m)"}),e.jsx(V,{width:"100%",height:300,children:e.jsxs(ee,{data:f.metrics,children:[e.jsx(Z,{strokeDasharray:"3 3"}),e.jsx(_,{dataKey:"time"}),e.jsx(q,{}),e.jsx(J,{}),e.jsx(Q,{}),e.jsx(se,{type:"monotone",dataKey:"cpu",stroke:"#8884d8",name:"CPU (m)"})]})})]})}),e.jsx(j,{sx:{width:"100%"},children:e.jsxs(v,{children:[e.jsx(i,{variant:"subtitle1",sx:{mb:2},children:"内存使用率 (MB)"}),e.jsx(V,{width:"100%",height:300,children:e.jsxs(ee,{data:f.metrics,children:[e.jsx(Z,{strokeDasharray:"3 3"}),e.jsx(_,{dataKey:"time"}),e.jsx(q,{}),e.jsx(J,{}),e.jsx(Q,{}),e.jsx(se,{type:"monotone",dataKey:"memory",stroke:"#82ca9d",name:"Memory (MB)"})]})})]})})]}):e.jsx(h,{severity:"info",children:t("k8s.monitoring.noData","暂无监控数据")})]}),e.jsxs(S,{value:p,index:4,children:[e.jsx(i,{variant:"h6",sx:{mb:2},children:t("k8s.deployments.history","历史版本")}),O?e.jsx(a,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(A,{})}):g.length>0?e.jsx(a,{sx:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{borderBottom:"2px solid #e0e0e0"},children:[e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.deployments.revision","版本")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.age","创建时间")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.deployments.changeReason","变更原因")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.images","镜像")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("k8s.status","状态")}),e.jsx("th",{style:{padding:"12px",textAlign:"left"},children:t("common.actions")})]})}),e.jsx("tbody",{children:g.map(s=>e.jsxs("tr",{style:{borderBottom:"1px solid #f0f0f0"},children:[e.jsx("td",{style:{padding:"12px"},children:e.jsxs(i,{variant:"body2",fontWeight:s.status==="current"?600:400,children:[s.revision,s.status==="current"&&e.jsx(y,{label:t("k8s.deployments.current","当前"),size:"small",color:"primary",sx:{ml:1}})]})}),e.jsx("td",{style:{padding:"12px"},children:e.jsx(i,{variant:"body2",children:s.creationTime})}),e.jsx("td",{style:{padding:"12px"},children:e.jsx(i,{variant:"body2",color:"text.secondary",children:s.changeReason||"-"})}),e.jsx("td",{style:{padding:"12px"},children:e.jsx(a,{sx:{display:"flex",flexDirection:"column",gap:.5},children:s.images.map((n,x)=>e.jsx(i,{variant:"body2",sx:{fontFamily:"monospace",fontSize:"0.875rem"},children:n},x))})}),e.jsx("td",{style:{padding:"12px"},children:e.jsx(y,{label:s.status==="current"?t("k8s.deployments.current","当前"):t("k8s.deployments.historical","历史"),size:"small",color:s.status==="current"?"primary":"default"})}),e.jsx("td",{style:{padding:"12px"},children:s.status==="historical"&&e.jsx(m,{size:"small",variant:"outlined",onClick:()=>H(s.revision),disabled:X,children:t("k8s.deployments.rollback","回滚")})})]},s.revision))})]})}):e.jsx(h,{severity:"info",children:t("common.noData")})]})]}),e.jsxs(ke,{open:re,onClose:()=>D(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ve,{children:t("k8s.deployments.rollback","回滚 StatefulSet")}),e.jsx(Ce,{children:O?e.jsx(a,{sx:{display:"flex",justifyContent:"center",py:4},children:e.jsx(A,{})}):g.length>0?e.jsxs(a,{sx:{mt:2},children:[e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mb:2},children:t("k8s.deployments.selectRevision","选择要回滚到的版本")}),g.filter(s=>s.status==="historical").map(s=>e.jsx(j,{sx:{mb:1},children:e.jsx(v,{children:e.jsxs(a,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(a,{children:[e.jsxs(i,{variant:"subtitle1",fontWeight:600,children:[t("k8s.deployments.revision","版本")," ",s.revision]}),e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:s.creationTime}),s.changeReason&&e.jsx(i,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:s.changeReason}),e.jsx(a,{sx:{mt:1},children:s.images.map((n,x)=>e.jsx(y,{label:n,size:"small",sx:{mr:.5,mb:.5}},x))})]}),e.jsx(m,{variant:"contained",onClick:()=>H(s.revision),disabled:X,children:t("k8s.deployments.rollback","回滚")})]})})},s.revision))]}):e.jsx(h,{severity:"info",sx:{mt:2},children:t("k8s.deployments.loadRevisionsFailed","没有可回滚的历史版本")})}),e.jsx(Se,{children:e.jsx(m,{onClick:()=>D(!1),children:t("common.cancel")})})]}),o&&r&&l&&e.jsx(Te,{open:ie,onClose:()=>Y(!1),title:`${t("k8s.statefulSets.title")} - ${l}`,clusterId:o,namespace:r,resourceType:"statefulset",resourceName:l,onLoadYaml:async(s,n,x,b)=>{const k={clusterId:s,namespace:n};return await W.getResourceYaml(k,x,b)},onSaveYaml:async(s,n,x,b,k)=>{const B={clusterId:s,namespace:n};await W.updateResourceYaml(B,x,b,k),u()},onDryRun:async(s,n,x,b,k)=>{const B={clusterId:s,namespace:n};return await W.dryRunResourceYaml(B,x,b,k)}})]})}export{Ve as default};
