import{ae as _,j as e,af as A,ag as G,ah as K,ai as $,aj as q,ak as O,r as i,al as V,am as J,an as Q,ao as X,T as C,ap as R,P as z,B as f,m as Y,s as Z,t as ee,d as L,I as E,v as se,a as te,aq as re,ar as ae,as as oe,at as ne,b as le,C as ie,au as ce,av as de,aw as xe,i as he,k as pe,l as ue,ax as me,ay as fe,az as ge,aA as je,a3 as ye,a4 as we,aB as be,H as N,z as Ce}from"./index-CJIrazW8.js";import{T as ve,a as Se,b as Ie,c as F,d as b,e as Be}from"./TableRow-JrGpygSA.js";import{L as ke}from"./LinearProgress-BlyF6pus.js";import{H as Te}from"./HostTree-B7aPg1F9.js";import"./websocket-DPSoD_7Z.js";import"./Chip-Bh8gAKTq.js";const Pe=_(e.jsx("path",{d:"M6 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm12 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm-6 0c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"})),De=A(G,{name:"MuiBreadcrumbCollapsed"})(K(({theme:t})=>({display:"flex",marginLeft:`calc(${t.spacing(1)} * 0.5)`,marginRight:`calc(${t.spacing(1)} * 0.5)`,...t.palette.mode==="light"?{backgroundColor:t.palette.grey[100],color:t.palette.grey[700]}:{backgroundColor:t.palette.grey[700],color:t.palette.grey[100]},borderRadius:2,"&:hover, &:focus":{...t.palette.mode==="light"?{backgroundColor:t.palette.grey[200]}:{backgroundColor:t.palette.grey[600]}},"&:active":{boxShadow:t.shadows[0],...t.palette.mode==="light"?{backgroundColor:$(t.palette.grey[200],.12)}:{backgroundColor:$(t.palette.grey[600],.12)}}}))),ze=A(Pe)({width:24,height:16});function Ae(t){const{slots:n={},slotProps:j={},...d}=t,a=t;return e.jsx("li",{children:e.jsx(De,{focusRipple:!0,...d,ownerState:a,children:e.jsx(ze,{as:n.CollapsedIcon,ownerState:a,...j.collapsedIcon})})})}function Me(t){return O("MuiBreadcrumbs",t)}const Ue=q("MuiBreadcrumbs",["root","ol","li","separator"]),He=t=>{const{classes:n}=t;return X({root:["root"],li:["li"],ol:["ol"],separator:["separator"]},Me,n)},Re=A(C,{name:"MuiBreadcrumbs",slot:"Root",overridesResolver:(t,n)=>[{[`& .${Ue.li}`]:n.li},n.root]})({}),Fe=A("ol",{name:"MuiBreadcrumbs",slot:"Ol"})({display:"flex",flexWrap:"wrap",alignItems:"center",padding:0,margin:0,listStyle:"none"}),Ee=A("li",{name:"MuiBreadcrumbs",slot:"Separator"})({display:"flex",userSelect:"none",marginLeft:8,marginRight:8});function $e(t,n,j,d){return t.reduce((a,h,y)=>(y<t.length-1?a=a.concat(h,e.jsx(Ee,{"aria-hidden":!0,className:n,ownerState:d,children:j},`separator-${y}`)):a.push(h),a),[])}const Le=i.forwardRef(function(n,j){const d=V({props:n,name:"MuiBreadcrumbs"}),{children:a,className:h,component:y="nav",slots:I={},slotProps:k={},expandText:w="Show path",itemsAfterCollapse:v=1,itemsBeforeCollapse:l=1,maxItems:o=8,separator:p="/",...u}=d,[g,x]=i.useState(!1),c={...d,component:y,expanded:g,expandText:w,itemsAfterCollapse:v,itemsBeforeCollapse:l,maxItems:o,separator:p},T=He(c),U=J({elementType:I.CollapsedIcon,externalSlotProps:k.collapsedIcon,ownerState:c}),M=i.useRef(null),H=m=>{const D=()=>{x(!0);const s=M.current.querySelector("a[href],button,[tabindex]");s&&s.focus()};return l+v>=m.length?m:[...m.slice(0,l),e.jsx(Ae,{"aria-label":w,slots:{CollapsedIcon:I.CollapsedIcon},slotProps:{collapsedIcon:U},onClick:D},"ellipsis"),...m.slice(m.length-v,m.length)]},P=i.Children.toArray(a).filter(m=>i.isValidElement(m)).map((m,D)=>e.jsx("li",{className:T.li,children:m},`child-${D}`));return e.jsx(Re,{ref:j,component:y,color:"textSecondary",className:Q(T.root,h),ownerState:c,...u,children:e.jsx(Fe,{className:T.ol,ref:M,ownerState:c,children:$e(g||o&&P.length<=o?P:H(P),T.separator,p,c)})})});function Ne({host:t,systemUserId:n}){const[j,d]=i.useState([]),[a,h]=i.useState("/"),[y,I]=i.useState(!1),[k,w]=i.useState(null),[v,l]=i.useState(""),[o,p]=i.useState(!1),[u,g]=i.useState(0),x=i.useRef(null),c=i.useCallback(async s=>{if(!t){w("请先选择主机");return}I(!0),w(null);try{try{const r=await R.listFiles(t.id,s,n);d(r.files||[])}catch(r){console.warn("文件列表API未实现，使用模拟数据:",r),await new Promise(W=>setTimeout(W,500));const S=s.endsWith("/")&&s!=="/"?s.slice(0,-1):s,B=S==="/"?"/":S+"/";d([{name:"..",path:S==="/"?"/":S.split("/").slice(0,-1).join("/")||"/",size:0,isDir:!0,mode:"drwxr-xr-x",modTime:""},{name:"home",path:B+"home",size:4096,isDir:!0,mode:"drwxr-xr-x",modTime:"2024-01-01 10:00:00"},{name:"tmp",path:B+"tmp",size:4096,isDir:!0,mode:"drwxrwxrwt",modTime:"2024-01-01 10:00:00"},{name:"test.txt",path:B+"test.txt",size:1024,isDir:!1,mode:"-rw-r--r--",modTime:"2024-01-01 10:00:00"},{name:"readme.md",path:B+"readme.md",size:2048,isDir:!1,mode:"-rw-r--r--",modTime:"2024-01-01 10:00:00"}])}}catch(r){w(r instanceof Error?r.message:"加载文件列表失败"),console.error("Failed to load files:",r)}finally{I(!1)}},[t,n]);i.useEffect(()=>{t&&c(a)},[t,a,c]);const T=s=>{if(s.isDir)if(s.name===".."){const r=a.split("/").filter(S=>S);r.length>0?(r.pop(),h("/"+r.join("/"))):h("/")}else{const r=a==="/"?`/${s.name}`:`${a}/${s.name}`;h(r)}},U=async s=>{if(t){p(!0),g(0);try{await R.uploadFile(t.id,a,s,r=>{g(r)}),c(a)}catch(r){w(r instanceof Error?r.message:"上传文件失败"),console.error("Upload failed:",r)}finally{p(!1),g(0)}}},M=async s=>{if(!(!t||s.isDir))try{const r=s.path.startsWith("/")?s.path:a==="/"?`/${s.path}`:`${a}/${s.path}`;await R.downloadFile(t.id,r,n)}catch(r){w(r instanceof Error?r.message:"下载文件失败"),console.error("Download failed:",r)}},H=s=>{if(s===0)return"0 B";const r=1024,S=["B","KB","MB","GB","TB"],B=Math.floor(Math.log(s)/Math.log(r));return Math.round(s/Math.pow(r,B)*100)/100+" "+S[B]},P=j.filter(s=>v?s.name.toLowerCase().includes(v.toLowerCase()):!0),m=a.split("/").filter(s=>s),D=[{name:"根目录",path:"/"},...m.map((s,r)=>({name:s,path:"/"+m.slice(0,r+1).join("/")}))];return t?e.jsxs(f,{sx:{flex:1,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:[e.jsxs(z,{sx:{p:2,mb:2,flexShrink:0},children:[e.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:2,flexWrap:"wrap"},children:[e.jsxs(C,{variant:"h6",sx:{flexGrow:1},children:[t.name," (",t.ip,")"]}),e.jsx(Y,{size:"small",placeholder:"搜索文件...",value:v,onChange:s=>l(s.target.value),InputProps:{startAdornment:e.jsx(Z,{position:"start",children:e.jsx(ee,{})})},sx:{width:200}}),e.jsx(L,{title:"刷新",children:e.jsx(E,{onClick:()=>c(a),disabled:y,children:e.jsx(se,{})})}),e.jsx(te,{variant:"contained",startIcon:e.jsx(re,{}),onClick:()=>x.current?.click(),disabled:y,children:"上传文件"}),e.jsx("input",{ref:x,type:"file",style:{display:"none"},onChange:s=>{const r=s.target.files?.[0];r&&U(r),s.target.value=""}})]}),e.jsx(Le,{separator:e.jsx(ne,{fontSize:"small"}),sx:{mt:2},children:D.map((s,r)=>e.jsxs(ae,{component:"button",variant:"body1",onClick:()=>{s.path===a?(h(""),setTimeout(()=>h(s.path),0)):h(s.path)},sx:{cursor:"pointer",textDecoration:"none","&:hover":{textDecoration:"underline"}},children:[r===0?e.jsx(oe,{sx:{fontSize:16,verticalAlign:"middle",mr:.5}}):null,s.name]},r))})]}),k&&e.jsx(le,{severity:"error",sx:{mb:2},onClose:()=>w(null),children:k}),e.jsx(ve,{component:z,sx:{flex:1,minHeight:0,overflow:"auto"},children:y?e.jsx(f,{sx:{display:"flex",justifyContent:"center",alignItems:"center",p:4},children:e.jsx(ie,{})}):e.jsxs(Se,{stickyHeader:!0,children:[e.jsx(Ie,{children:e.jsxs(F,{children:[e.jsx(b,{children:"名称"}),e.jsx(b,{children:"大小"}),e.jsx(b,{children:"权限"}),e.jsx(b,{children:"修改时间"}),e.jsx(b,{align:"right",children:"操作"})]})}),e.jsx(Be,{children:P.length===0?e.jsx(F,{children:e.jsx(b,{colSpan:5,align:"center",children:e.jsx(C,{color:"text.secondary",sx:{py:4},children:v?"未找到匹配的文件":"目录为空"})})}):P.map((s,r)=>e.jsxs(F,{hover:!0,sx:{cursor:s.isDir?"pointer":"default","&:hover":{backgroundColor:"action.hover"}},onClick:()=>T(s),children:[e.jsx(b,{children:e.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:1},children:[s.isDir?e.jsx(ce,{color:"primary"}):e.jsx(de,{}),e.jsx(C,{children:s.name})]})}),e.jsx(b,{children:s.isDir?"-":H(s.size)}),e.jsx(b,{children:e.jsx(C,{variant:"body2",fontFamily:"monospace",children:s.mode})}),e.jsx(b,{children:s.modTime||"-"}),e.jsx(b,{align:"right",children:!s.isDir&&e.jsx(L,{title:"下载",children:e.jsx(E,{size:"small",onClick:S=>{S.stopPropagation(),M(s)},children:e.jsx(xe,{})})})})]},r))})]})}),e.jsxs(he,{open:o,maxWidth:"sm",fullWidth:!0,children:[e.jsx(pe,{children:"上传文件"}),e.jsx(ue,{children:e.jsxs(f,{sx:{mt:2},children:[e.jsx(ke,{variant:"determinate",value:u}),e.jsxs(C,{variant:"body2",color:"text.secondary",sx:{mt:1},children:[u,"%"]})]})})]})]}):e.jsx(z,{sx:{p:4,textAlign:"center",flex:1,display:"flex",flexDirection:"column",justifyContent:"center"},children:e.jsx(C,{variant:"h6",gutterBottom:!0,color:"text.secondary",children:"请从左侧主机树选择主机"})})}function Ve(){const t=me(),[n,j]=i.useState([]),[d,a]=i.useState(0),[h,y]=i.useState(""),[I,k]=i.useState("/");i.useEffect(()=>{const l=sessionStorage.getItem("file_management_previous_path")||(document.referrer?new URL(document.referrer).pathname:"/");k(l)},[]),i.useEffect(()=>{(async()=>{try{const o=await N.get("/api/system-users"),p=o.data?.data||o.data||[];p.length>0&&!h&&y(p[0].id)}catch(o){console.error("加载系统用户失败:",o)}})()},[h]),i.useEffect(()=>{d>=n.length&&n.length>0&&a(n.length-1)},[n.length,d]);const w=(l,o)=>{j(p=>{const u=p.filter(g=>g.id!==l);if(o===d)if(u.length>0){const g=o<u.length?o:u.length-1;a(g)}else a(0);else o<d&&a(d-1);return u})},v=async l=>{try{const o=n.find(x=>x.host.id===l.id);if(o){const x=n.findIndex(c=>c.id===o.id);a(x);return}const p=await Ce.getHost(l.id);let u=h;if(!u)try{const x=await N.get(`/api/system-users/available?hostId=${l.id}`),c=Array.isArray(x.data?.data)?x.data.data:x.data?.data?.data||x.data||[];if(c.length===0){alert("没有可用的系统用户，请联系管理员配置权限");return}else c.length,u=c[0].id}catch(x){console.error("获取系统用户失败:",x)}const g={id:`file-${Date.now()}-${Math.random()}`,host:p,systemUserId:u||void 0};j(x=>{const c=[...x,g];return setTimeout(()=>{a(c.length-1)},100),c})}catch(o){console.error("连接主机失败:",o),alert("连接主机失败: "+o.message)}};return e.jsxs(f,{sx:{height:"100vh",width:"100vw",display:"flex",flexDirection:"column",position:"fixed",top:0,left:0,right:0,bottom:0,zIndex:1300,bgcolor:"background.default",overflow:"hidden"},children:[e.jsx(fe,{position:"static",color:"default",elevation:1,sx:{flexShrink:0},children:e.jsxs(ge,{children:[e.jsx(E,{edge:"start",onClick:()=>{window.opener?window.close():t(I)},sx:{mr:2},children:e.jsx(je,{})}),e.jsx(C,{variant:"h6",sx:{flexGrow:1},children:"文件管理"}),n.length>0&&e.jsxs(C,{variant:"body2",color:"text.secondary",sx:{mr:2},children:["已打开 ",n.length," 个主机"]})]})}),e.jsxs(f,{sx:{flex:1,minHeight:0,width:"100%",display:"flex",gap:2,p:2,overflow:"hidden"},children:[e.jsx(f,{sx:{width:"300px",flexShrink:0,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:e.jsx(Te,{onHostClick:v})}),e.jsx(f,{sx:{flex:1,minWidth:0,display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:n.length===0?e.jsxs(z,{sx:{p:4,textAlign:"center",flex:1,display:"flex",flexDirection:"column",justifyContent:"center"},children:[e.jsx(C,{variant:"h6",gutterBottom:!0,color:"text.secondary",children:"未打开任何主机"}),e.jsx(C,{variant:"body2",color:"text.secondary",children:"从左侧主机树选择主机进行文件管理"})]}):e.jsxs(e.Fragment,{children:[e.jsx(z,{sx:{mb:2,flexShrink:0},children:e.jsx(ye,{value:d,onChange:(l,o)=>a(o),variant:"scrollable",scrollButtons:"auto",children:n.map((l,o)=>e.jsx(we,{label:e.jsxs(f,{display:"flex",alignItems:"center",gap:1,children:[e.jsx("span",{children:l.host.name}),e.jsxs("span",{style:{fontSize:"0.8em",opacity:.7},children:["(",l.host.ip,")"]}),e.jsx(f,{component:"span",onClick:p=>{p.stopPropagation(),w(l.id,o)},sx:{display:"inline-flex",alignItems:"center",justifyContent:"center",width:20,height:20,borderRadius:"50%",cursor:"pointer",ml:.5,"&:hover":{backgroundColor:"rgba(0, 0, 0, 0.08)"}},children:e.jsx(be,{sx:{fontSize:16}})})]})},l.id))})}),e.jsx(f,{sx:{flex:1,minHeight:0,width:"100%",display:"flex",flexDirection:"column",overflow:"hidden"},children:n.map((l,o)=>e.jsx(f,{sx:{display:d===o?"flex":"none",flex:1,width:"100%",minHeight:0,flexDirection:"column",overflow:"hidden"},children:e.jsx(Ne,{host:l.host,systemUserId:l.systemUserId})},l.id))})]})})]})]})}export{Ve as default};
