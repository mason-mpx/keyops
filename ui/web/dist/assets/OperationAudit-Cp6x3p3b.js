import{ak as Ie,aj as Le,r as i,al as ze,j as e,af as We,an as Fe,ao as Oe,T as r,bm as Ae,H as z,u as Ee,bf as C,B as l,bn as $e,a as v,v as Re,h as Me,P as Be,a3 as He,a4 as Y,bo as Ne,bp as Ue,w as R,x as M,m as g,F as Z,n as ee,o as te,M as u,C as se,b as ae,y as ne,I as Ge,be as Ve,i as re,k as ie,l as le,p as oe,a7 as qe}from"./index-wVs8DYHr.js";import{S as q}from"./Stack-CNnEoVHt.js";import{T as ce,a as de,b as me,c as B,d as a,e as ue}from"./TableRow-17IyVPm2.js";import{C as he}from"./Chip-DzNpApxT.js";import{T as xe}from"./TablePagination-l3CyI5hc.js";import"./LastPage-Bx6x4Acm.js";function Ke(s){return Ie("MuiDialogContentText",s)}Le("MuiDialogContentText",["root"]);const Je=s=>{const{classes:c}=s,h=Oe({root:["root"]},Ke,c);return{...c,...h}},Qe=We(r,{shouldForwardProp:s=>Ae(s)||s==="classes",name:"MuiDialogContentText",slot:"Root"})({}),Xe=i.forwardRef(function(c,b){const h=ze({props:c,name:"MuiDialogContentText"}),{children:_,className:f,...w}=h,W=Je(w);return e.jsx(Qe,{component:"p",variant:"body1",color:"textSecondary",ref:b,ownerState:w,className:Fe(W.root,f),...h,classes:W})}),H={getOperationLogs:(s={})=>z.get("/api/v1/audit/operation-logs",{params:s}),getOperationLogDetail:s=>z.get(`/api/v1/audit/operation-logs/${s}`),deleteOperationLog:s=>z.delete(`/api/v1/audit/operation-logs/${s}`),batchDeleteOperationLogs:s=>z.delete("/api/v1/audit/operation-logs/batch",{data:{ids:s}}),getPodCommandLogs:(s={})=>z.get("/api/v1/audit/pod-commands",{params:s})};function pe(s){const{children:c,value:b,index:h,..._}=s;return e.jsx("div",{role:"tabpanel",hidden:b!==h,id:`audit-tabpanel-${h}`,"aria-labelledby":`audit-tab-${h}`,..._,children:b===h&&e.jsx(l,{sx:{pt:3},children:c})})}function nt(){const{t:s}=Ee(),[c,b]=i.useState(0),[h,_]=i.useState(!1),[f,w]=i.useState([]),[W,N]=i.useState(0),[D,S]=i.useState(0),[F,je]=i.useState(20),[x,k]=i.useState([]),[ge,O]=i.useState(!1),[ve,U]=i.useState(!1),[p,fe]=i.useState(null),[K,G]=i.useState([]),[Ce,V]=i.useState(0),[I,A]=i.useState(0),[E,be]=i.useState(20),[J,Q]=i.useState(!1),[d,X]=i.useState({username:"",ip:"",path:"",method:"",status:0,start_time:"",end_time:""}),[o,y]=i.useState({cluster_id:"",namespace:"",pod_name:"",username:"",command:"",start_time:"",end_time:""}),L=i.useCallback(async()=>{try{_(!0);const t=j=>j?j.replace("T"," ")+":00":"",n={...d,start_time:d.start_time?t(d.start_time):void 0,end_time:d.end_time?t(d.end_time):void 0,page:D+1,page_size:F},T=(await H.getOperationLogs(n)).data;if(T.code===0){const j=T.data;w(j?.data||[]),N(j?.total||0)}else C(T.message||"加载失败"),w([]),N(0)}catch(t){const n=t?.response?.data?.message||"加载操作日志失败";C(n),w([]),N(0)}finally{_(!1)}},[d,D,F]),$=i.useCallback(async()=>{try{Q(!0);const t=j=>j?j.replace("T"," ")+":00":"",n={...o,start_time:o.start_time?t(o.start_time):void 0,end_time:o.end_time?t(o.end_time):void 0,page:I+1,page_size:E},T=(await H.getPodCommandLogs(n)).data;if(T.code===0){const j=T.data;G(j?.data||[]),V(j?.total||0)}else C(T.message||"加载失败"),G([]),V(0)}catch(t){const n=t?.response?.data?.message||"加载 Pod 命令记录失败";C(n),G([]),V(0)}finally{Q(!1)}},[o,I,E]);i.useEffect(()=>{c===0?L():$()},[D,F,I,E,c,L,$]);const P=(t,n)=>{X({...d,[t]:n}),S(0)},ye=()=>{D===0?L():S(0)},Pe=()=>{X({username:"",ip:"",path:"",method:"",status:0,start_time:"",end_time:""}),S(0)},Te=t=>{k(t?f.map(n=>n.id):[])},we=(t,n)=>{k(n?[...x,t]:x.filter(m=>m!==t))},_e=async t=>{try{const m=(await H.getOperationLogDetail(t.id)).data;m.code===0?(fe(m.data||null),U(!0)):C(m.message||"获取详情失败")}catch(n){const m=n?.response?.data?.message||"获取详情失败";C(m)}},De=async()=>{if(x.length===0){C("请选择要删除的日志");return}try{await H.batchDeleteOperationLogs(x),qe("删除成功"),O(!1),k([]),L()}catch(t){const n=t?.response?.data?.message||"删除失败";C(n)}},Se=t=>t>=200&&t<300?"success":t>=400&&t<500?"warning":t>=500?"error":"default",ke=t=>{switch(t){case"POST":return"success";case"PUT":return"info";case"DELETE":return"error";case"PATCH":return"warning";default:return"default"}};return e.jsxs(l,{sx:{width:"100%",p:3},children:[e.jsxs(l,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3,flexWrap:"wrap",gap:2,children:[e.jsxs(l,{display:"flex",alignItems:"center",gap:2,children:[e.jsx($e,{color:"primary",sx:{fontSize:32}}),e.jsxs(l,{children:[e.jsx(r,{variant:"h4",component:"h1",fontWeight:"700",children:s("cluster.audit.title","操作审计")}),e.jsx(r,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:s("cluster.audit.subtitle","查看用户操作 K8s 集群的审计日志")})]})]}),e.jsxs(l,{display:"flex",gap:2,children:[e.jsx(v,{variant:"outlined",startIcon:e.jsx(Re,{}),onClick:()=>{c===0?L():$()},disabled:c===0?h:J,children:s("common.refresh","刷新")}),c===0&&x.length>0&&e.jsxs(v,{variant:"outlined",color:"error",startIcon:e.jsx(Me,{}),onClick:()=>O(!0),children:[s("common.delete","删除")," (",x.length,")"]})]})]}),e.jsx(Be,{sx:{mb:3},children:e.jsxs(He,{value:c,onChange:(t,n)=>b(n),variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider"},children:[e.jsx(Y,{icon:e.jsx(Ne,{}),label:s("cluster.audit.apiLogs","API操作日志"),iconPosition:"start"}),e.jsx(Y,{icon:e.jsx(Ue,{}),label:s("cluster.audit.podCommands","Pod命令记录"),iconPosition:"start"})]})}),e.jsxs(pe,{value:c,index:0,children:[e.jsx(R,{sx:{mb:3},children:e.jsxs(M,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{mb:2},children:s("common.filter","筛选条件")}),e.jsxs(q,{direction:"row",spacing:2,flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(g,{label:s("cluster.audit.username","用户名"),value:d.username,onChange:t=>P("username",t.target.value),size:"small",sx:{minWidth:150}}),e.jsx(g,{label:s("cluster.audit.ip","IP地址"),value:d.ip,onChange:t=>P("ip",t.target.value),size:"small",sx:{minWidth:150}}),e.jsx(g,{label:s("cluster.audit.path","API路径"),value:d.path,onChange:t=>P("path",t.target.value),size:"small",sx:{minWidth:200}}),e.jsxs(Z,{size:"small",sx:{minWidth:120},children:[e.jsx(ee,{children:s("cluster.audit.method","HTTP方法")}),e.jsxs(te,{value:d.method||"",onChange:t=>P("method",t.target.value||""),label:s("cluster.audit.method","HTTP方法"),children:[e.jsx(u,{value:"",children:s("common.all","全部")}),e.jsx(u,{value:"GET",children:"GET"}),e.jsx(u,{value:"POST",children:"POST"}),e.jsx(u,{value:"PUT",children:"PUT"}),e.jsx(u,{value:"DELETE",children:"DELETE"}),e.jsx(u,{value:"PATCH",children:"PATCH"})]})]}),e.jsxs(Z,{size:"small",sx:{minWidth:120},children:[e.jsx(ee,{children:s("cluster.audit.status","状态码")}),e.jsxs(te,{value:d.status||0,onChange:t=>P("status",t.target.value),label:s("cluster.audit.status","状态码"),children:[e.jsx(u,{value:0,children:s("common.all","全部")}),e.jsx(u,{value:200,children:"200"}),e.jsx(u,{value:400,children:"400"}),e.jsx(u,{value:401,children:"401"}),e.jsx(u,{value:403,children:"403"}),e.jsx(u,{value:404,children:"404"}),e.jsx(u,{value:500,children:"500"})]})]}),e.jsx(g,{label:s("cluster.audit.startTime","开始时间"),type:"datetime-local",value:d.start_time,onChange:t=>P("start_time",t.target.value),size:"small",InputLabelProps:{shrink:!0},sx:{minWidth:200}}),e.jsx(g,{label:s("cluster.audit.endTime","结束时间"),type:"datetime-local",value:d.end_time,onChange:t=>P("end_time",t.target.value),size:"small",InputLabelProps:{shrink:!0},sx:{minWidth:200}}),e.jsxs(l,{display:"flex",gap:1,alignItems:"center",children:[e.jsx(v,{variant:"contained",onClick:ye,children:s("common.query","查询")}),e.jsx(v,{variant:"outlined",onClick:Pe,children:s("common.reset","重置")})]})]})]})}),e.jsx(R,{children:e.jsx(M,{children:h?e.jsx(l,{display:"flex",justifyContent:"center",p:3,children:e.jsx(se,{})}):f.length===0?e.jsx(ae,{severity:"info",children:s("common.noData","暂无数据")}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{children:e.jsxs(de,{children:[e.jsx(me,{children:e.jsxs(B,{children:[e.jsx(a,{padding:"checkbox",children:e.jsx(ne,{checked:x.length===f.length&&f.length>0,indeterminate:x.length>0&&x.length<f.length,onChange:t=>Te(t.target.checked)})}),e.jsx(a,{children:s("cluster.audit.username","用户名")}),e.jsx(a,{children:s("cluster.audit.ip","IP地址")}),e.jsx(a,{children:s("cluster.audit.method","方法")}),e.jsx(a,{children:s("cluster.audit.path","路径")}),e.jsx(a,{children:s("cluster.audit.desc","描述")}),e.jsx(a,{children:s("cluster.audit.status","状态")}),e.jsx(a,{children:s("cluster.audit.timeCost","耗时(ms)")}),e.jsx(a,{children:s("cluster.audit.startTime","操作时间")}),e.jsx(a,{align:"right",children:s("common.actions","操作")})]})}),e.jsx(ue,{children:f.map(t=>e.jsxs(B,{hover:!0,children:[e.jsx(a,{padding:"checkbox",children:e.jsx(ne,{checked:x.includes(t.id),onChange:n=>we(t.id,n.target.checked)})}),e.jsx(a,{children:t.username}),e.jsx(a,{children:e.jsx(r,{variant:"body2",sx:{fontFamily:"monospace"},children:t.ip})}),e.jsx(a,{children:e.jsx(he,{label:t.method,size:"small",color:ke(t.method)})}),e.jsx(a,{children:e.jsx(r,{variant:"body2",sx:{fontFamily:"monospace",maxWidth:300,overflow:"hidden",textOverflow:"ellipsis"},children:t.path})}),e.jsx(a,{children:t.desc||"-"}),e.jsx(a,{children:e.jsx(he,{label:t.status,size:"small",color:Se(t.status)})}),e.jsx(a,{children:t.time_cost?`${t.time_cost}ms`:"-"}),e.jsx(a,{children:new Date(t.start_time).toLocaleString("zh-CN")}),e.jsx(a,{align:"right",children:e.jsx(Ge,{size:"small",onClick:()=>_e(t),title:s("common.view","查看"),children:e.jsx(Ve,{fontSize:"small"})})})]},t.id))})]})}),e.jsx(xe,{component:"div",count:W,page:D,onPageChange:(t,n)=>S(n),rowsPerPage:F,onRowsPerPageChange:t=>{je(parseInt(t.target.value,10)),S(0)},rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:s("common.rowsPerPage","每页行数"),labelDisplayedRows:({from:t,to:n,count:m})=>`${t}-${n} ${s("common.of","共")} ${m}`})]})})})]}),e.jsxs(pe,{value:c,index:1,children:[e.jsx(R,{sx:{mb:3},children:e.jsxs(M,{children:[e.jsx(r,{variant:"h6",gutterBottom:!0,sx:{mb:2},children:s("common.filter","筛选条件")}),e.jsxs(q,{direction:"row",spacing:2,flexWrap:"wrap",useFlexGap:!0,children:[e.jsx(g,{label:s("cluster.audit.username","用户名"),value:o.username,onChange:t=>y({...o,username:t.target.value}),size:"small",sx:{minWidth:150}}),e.jsx(g,{label:s("k8s.selectNamespace","命名空间"),value:o.namespace,onChange:t=>y({...o,namespace:t.target.value}),size:"small",sx:{minWidth:150}}),e.jsx(g,{label:s("k8s.pods.title","Pod名称"),value:o.pod_name,onChange:t=>y({...o,pod_name:t.target.value}),size:"small",sx:{minWidth:150}}),e.jsx(g,{label:s("cluster.audit.command","命令"),value:o.command,onChange:t=>y({...o,command:t.target.value}),size:"small",sx:{minWidth:200}}),e.jsx(g,{label:s("cluster.audit.startTime","开始时间"),type:"datetime-local",value:o.start_time,onChange:t=>y({...o,start_time:t.target.value}),size:"small",InputLabelProps:{shrink:!0},sx:{minWidth:200}}),e.jsx(g,{label:s("cluster.audit.endTime","结束时间"),type:"datetime-local",value:o.end_time,onChange:t=>y({...o,end_time:t.target.value}),size:"small",InputLabelProps:{shrink:!0},sx:{minWidth:200}}),e.jsxs(l,{display:"flex",gap:1,alignItems:"center",children:[e.jsx(v,{variant:"contained",onClick:()=>{I===0?$():A(0)},children:s("common.query","查询")}),e.jsx(v,{variant:"outlined",onClick:()=>{y({cluster_id:"",namespace:"",pod_name:"",username:"",command:"",start_time:"",end_time:""}),A(0)},children:s("common.reset","重置")})]})]})]})}),e.jsx(R,{children:e.jsx(M,{children:J?e.jsx(l,{display:"flex",justifyContent:"center",p:3,children:e.jsx(se,{})}):K.length===0?e.jsx(ae,{severity:"info",children:s("common.noData","暂无数据")}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{children:e.jsxs(de,{children:[e.jsx(me,{children:e.jsxs(B,{children:[e.jsx(a,{children:s("cluster.audit.operator","操作人")}),e.jsx(a,{children:s("k8s.cluster","集群")}),e.jsx(a,{children:s("k8s.selectNamespace","命名空间")}),e.jsx(a,{children:s("k8s.pods.title","Pod名称")}),e.jsx(a,{children:s("k8s.containers","容器")}),e.jsx(a,{children:s("cluster.audit.command","命令")}),e.jsx(a,{children:s("cluster.audit.startTime","执行时间")})]})}),e.jsx(ue,{children:K.map(t=>e.jsxs(B,{hover:!0,children:[e.jsx(a,{children:t.username||"-"}),e.jsx(a,{children:t.clusterName||"-"}),e.jsx(a,{children:t.namespace||"-"}),e.jsx(a,{children:t.podName||"-"}),e.jsx(a,{children:t.container||"-"}),e.jsx(a,{children:e.jsx(r,{variant:"body2",sx:{fontFamily:"monospace",maxWidth:400,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},title:t.command,children:t.command})}),e.jsx(a,{children:t.executedAt?new Date(t.executedAt).toLocaleString("zh-CN"):"-"})]},t.id))})]})}),e.jsx(xe,{component:"div",count:Ce,page:I,onPageChange:(t,n)=>A(n),rowsPerPage:E,onRowsPerPageChange:t=>{be(parseInt(t.target.value,10)),A(0)},rowsPerPageOptions:[10,20,50,100],labelRowsPerPage:s("common.rowsPerPage","每页行数"),labelDisplayedRows:({from:t,to:n,count:m})=>`${t}-${n} ${s("common.of","共")} ${m}`})]})})})]}),e.jsxs(re,{open:ge,onClose:()=>O(!1),children:[e.jsx(ie,{children:s("common.confirmDelete","确认删除")}),e.jsx(le,{children:e.jsx(Xe,{children:s("cluster.audit.confirmDeleteMessage","确定要删除选中的 {count} 条操作日志吗？",{count:x.length})})}),e.jsxs(oe,{children:[e.jsx(v,{onClick:()=>O(!1),children:s("common.cancel","取消")}),e.jsx(v,{onClick:De,color:"error",variant:"contained",children:s("common.delete","删除")})]})]}),e.jsxs(re,{open:ve,onClose:()=>U(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(ie,{children:s("cluster.audit.detail","操作日志详情")}),e.jsx(le,{children:p&&e.jsx(l,{sx:{mt:2},children:e.jsxs(q,{spacing:2,children:[e.jsxs(l,{children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:s("cluster.audit.username","用户名")}),e.jsx(r,{variant:"body1",children:p.username})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:s("cluster.audit.ip","IP地址")}),e.jsx(r,{variant:"body1",sx:{fontFamily:"monospace"},children:p.ip})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:s("cluster.audit.method","HTTP方法")}),e.jsx(r,{variant:"body1",children:p.method})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:s("cluster.audit.path","API路径")}),e.jsx(r,{variant:"body1",sx:{fontFamily:"monospace",wordBreak:"break-all"},children:p.path})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:s("cluster.audit.desc","操作描述")}),e.jsx(r,{variant:"body1",children:p.desc||"-"})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:s("cluster.audit.status","状态码")}),e.jsx(r,{variant:"body1",children:p.status})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:s("cluster.audit.timeCost","耗时")}),e.jsx(r,{variant:"body1",children:p.time_cost?`${p.time_cost}ms`:"-"})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:s("cluster.audit.startTime","操作时间")}),e.jsx(r,{variant:"body1",children:new Date(p.start_time).toLocaleString("zh-CN")})]}),e.jsxs(l,{children:[e.jsx(r,{variant:"caption",color:"text.secondary",children:s("cluster.audit.userAgent","User Agent")}),e.jsx(r,{variant:"body2",sx:{fontFamily:"monospace",wordBreak:"break-all"},children:p.user_agent||"-"})]})]})})}),e.jsx(oe,{children:e.jsx(v,{onClick:()=>U(!1),children:s("common.close","关闭")})})]})]})}export{nt as default};
