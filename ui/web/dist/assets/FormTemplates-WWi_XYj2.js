import{r as i,b4 as le,bf as _,j as e,i as ne,k as oe,B as x,dC as X,T as I,l as de,C as Y,b as O,F as ce,n as pe,o as ue,M,m as w,D as G,p as he,a as U,a7 as fe,ax as ge,w as xe,x as me,dD as je,I as V,dE as ve,dF as Ie}from"./index-OJNN34VQ.js";import{a as q}from"./ticketApi-CWQtxyXM.js";import{S as N}from"./Stack-D4jLN6n0.js";import{A as ye}from"./Autocomplete-cIcVOBXR.js";import{C as Z}from"./Chip-pSvhxX1X.js";import{T as be,a as Ce,b as Ae,c as Q,d as c,e as Te}from"./TableRow-Dz3vPXNr.js";const Se=p=>{const u=[];if(!p||!p.properties)return u;const m=(k,s="")=>{Object.keys(k).forEach(f=>{const o=k[f],d=s?`${s}.${f}`:f,g=o["x-component"];if(g==="FormGrid"||g==="FormLayout"||g==="Form"){o.properties&&m(o.properties,d);return}const h=o.title||d;if(u.push({name:d,title:typeof h=="string"?h:String(h||d)}),o.type==="array"&&o.items&&typeof o.items=="object"&&"properties"in o.items){const j=o.items;j.properties&&m(j.properties,`${d}.0`)}})};return m(p.properties),u};function we({open:p,template:u,onClose:m,onSave:k}){const[s,f]=i.useState("feishu"),[o,d]=i.useState(""),[g,h]=i.useState(""),[j,y]=i.useState(""),[F,b]=i.useState(""),[D,C]=i.useState(""),[r,A]=i.useState([]),[B,W]=i.useState([]),[$,z]=i.useState(!1),[ee,K]=i.useState(!1),[te,R]=i.useState(!1),[ae,H]=i.useState([]),[P,J]=i.useState(null),E=i.useCallback(async t=>{K(!0);try{const n=(await le.getUsersWithPagination({page:1,pageSize:100,keyword:t||void 0})).users||[];return H(n),n}catch(a){return console.error("加载用户列表失败:",a),H([]),[]}finally{K(!1)}},[]);i.useEffect(()=>{p&&E().then(t=>{if(P?.approval_config)try{const a=typeof P.approval_config=="string"?JSON.parse(P.approval_config):P.approval_config;if(a?.approver_user_ids&&Array.isArray(a.approver_user_ids)){const n=a.approver_user_ids.map(l=>t.find(T=>T.id===l)).filter(l=>l!==void 0);W(n)}}catch(a){console.error("解析审批配置失败:",a)}})},[p,P,E]),i.useEffect(()=>{p&&u?.id?(R(!0),q.get(u.id).then(t=>{if(t.data.code===0&&t.data.data){const a=t.data.data;J(a);const n=Se(a.schema);try{const l=a.approval_config?typeof a.approval_config=="string"?JSON.parse(a.approval_config):a.approval_config:null;if(l){f(l.platform||"feishu"),d(l.approval_code||""),h(l.app_id||""),y(l.app_secret||""),b(l.api_base_url||""),C(l.callback_url||"");const T=l.field_mappings||[],v=new Map;T.forEach(S=>{const L=S.fieldName||S.widgetId||"";L&&v.set(L,{widgetId:S.widgetId||""})});const ie=n.map(S=>{const L=v.get(S.name);return{fieldName:S.name,fieldTitle:S.title,widgetId:L?.widgetId||""}});A(ie)}else{f("feishu"),d(""),h(""),y(""),b(""),C("");const T=n.map(v=>({fieldName:v.name,fieldTitle:v.title,widgetId:""}));A(T),W([])}}catch(l){console.error("解析审批配置失败:",l),f("feishu"),d(""),h(""),y(""),b(""),C("");const T=n.map(v=>({fieldName:v.name,fieldTitle:v.title,widgetId:""}));A(T),W([])}}}).catch(t=>{console.error("加载模板详情失败:",t),_("加载模板详情失败")}).finally(()=>{R(!1)})):p&&(J(null),f("feishu"),d(""),h(""),y(""),b(""),C(""),A([]),W([]))},[p,u?.id]);const se=(t,a,n)=>{const l=[...r];l[t]={...l[t],[a]:n},A(l)},re=async()=>{if(!o.trim()){_("请输入审批代码");return}if(!g.trim()){_("请输入应用ID (App ID / App Key)");return}if(!j.trim()){_("请输入应用密钥 (App Secret)");return}for(const t of r)if(!t.widgetId.trim()){_(`请填写字段"${t.fieldTitle}"的 Widget ID`);return}try{z(!0);const t={platform:s,approval_code:o.trim(),app_id:g.trim(),app_secret:j.trim(),api_base_url:F.trim(),callback_url:D.trim(),field_mappings:r.map(a=>({fieldName:a.fieldName,widgetId:a.widgetId.trim()})),approver_user_ids:B.map(a=>a.id)};await q.update(u.id,{...u,approval_config:t}),fe("保存成功"),k()}catch(t){console.error("保存审批配置失败:",t),_(t?.response?.data?.message||"保存失败")}finally{z(!1)}};return e.jsxs(ne,{open:p,onClose:m,maxWidth:"lg",fullWidth:!0,PaperProps:{sx:{maxWidth:"900px"}},children:[e.jsx(oe,{children:e.jsxs(x,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(X,{color:"primary"}),e.jsxs(I,{variant:"h6",component:"span",children:["配置三方审批 - ",u.name]})]})}),e.jsx(de,{children:te?e.jsx(x,{sx:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:200},children:e.jsx(Y,{})}):e.jsxs(N,{spacing:3,sx:{mt:1},children:[e.jsx(O,{severity:"info",children:e.jsx(I,{variant:"body2",children:"配置审批代码、字段映射和审批人。为每个表单字段填写对应的 Widget ID，系统会自动使用字段名称匹配工单数据。"})}),e.jsxs(ce,{fullWidth:!0,required:!0,children:[e.jsx(pe,{children:"审批平台"}),e.jsxs(ue,{value:s,label:"审批平台",onChange:t=>f(t.target.value),children:[e.jsx(M,{value:"feishu",children:"飞书 (Feishu)"}),e.jsx(M,{value:"dingtalk",children:"钉钉 (DingTalk)"}),e.jsx(M,{value:"wechat",children:"企业微信 (WeChat)"})]})]}),e.jsx(w,{fullWidth:!0,label:s==="feishu"?"审批代码 (Approval Code)":s==="dingtalk"?"流程代码 (Process Code)":"模板ID (Template ID)",value:o,onChange:t=>d(t.target.value),required:!0,helperText:s==="feishu"?"飞书审批定义的唯一标识":s==="dingtalk"?"钉钉审批流程的唯一标识":"企业微信审批模板的唯一标识"}),e.jsx(w,{fullWidth:!0,label:s==="feishu"?"应用ID (App ID)":s==="dingtalk"?"应用Key (AppKey)":"应用ID (AgentId) / 企业ID (CorpId)",value:g,onChange:t=>h(t.target.value),required:!0,helperText:s==="feishu"?"飞书应用ID (App ID)，必填项。用于调用飞书审批平台的API接口":s==="dingtalk"?"钉钉应用Key (AppKey)，必填项。用于调用钉钉审批平台的API接口":"企业微信应用ID (AgentId) 或企业ID (CorpId)，必填项。用于调用企业微信审批平台的API接口"}),e.jsx(w,{fullWidth:!0,label:s==="feishu"?"应用密钥 (App Secret)":s==="dingtalk"?"应用密钥 (AppSecret)":"应用密钥 (Secret)",type:"password",value:j,onChange:t=>y(t.target.value),required:!0,helperText:s==="feishu"?"飞书应用密钥 (App Secret)，必填项。与App ID配合使用，用于API认证":s==="dingtalk"?"钉钉应用密钥 (AppSecret)，必填项。与AppKey配合使用，用于API认证":"企业微信应用密钥 (Secret)，必填项。用于API认证"}),e.jsx(w,{fullWidth:!0,label:"API 基础地址 (API Base URL)",value:F,onChange:t=>b(t.target.value),placeholder:s==="feishu"?"https://open.larksuite.com/open-apis":s==="dingtalk"?"https://oapi.dingtalk.com":"https://qyapi.weixin.qq.com",helperText:s==="feishu"?"飞书 API 基础地址，默认：https://open.larksuite.com/open-apis":s==="dingtalk"?"钉钉 API 基础地址，默认：https://oapi.dingtalk.com":"企业微信 API 基础地址，默认：https://qyapi.weixin.qq.com"}),e.jsx(w,{fullWidth:!0,label:"回调地址 (Callback URL)",value:D,onChange:t=>C(t.target.value),placeholder:`https://your-domain.com/api/approvals/callback/${s}`,helperText:`三方审批用户点击审批后回调到本地的URL地址。路径格式：/api/approvals/callback/{platform}，当前平台为 ${s==="feishu"?"feishu（飞书）":s==="dingtalk"?"dingtalk（钉钉）":"wechat（企微）"}。示例：https://your-domain.com/api/approvals/callback/${s}`}),e.jsx(G,{}),e.jsxs(x,{children:[e.jsx(I,{variant:"subtitle1",fontWeight:"bold",sx:{mb:2},children:"审批人配置"}),e.jsx(ye,{multiple:!0,options:ae,getOptionLabel:t=>typeof t=="string"?t:t.username||"",value:B,onChange:(t,a)=>{W(a)},onInputChange:(t,a)=>{a?E(a):E()},loading:ee,filterOptions:t=>t,isOptionEqualToValue:(t,a)=>t.id===a.id,renderInput:t=>e.jsx(w,{...t,label:"审批人",placeholder:"选择审批人（可多选）",helperText:"选择需要审批此工单的用户，审批人信息会同步到三方审批平台"}),renderOption:(t,a)=>{const n=typeof a=="string"?null:a,l=n?.username||(typeof a=="string"?a:"");return i.createElement("li",{...t,key:n?.id||(typeof a=="string"?a:"")},l)},renderTags:(t,a)=>t.map((n,l)=>i.createElement(Z,{...a({index:l}),key:n.id,label:n.username}))})]}),e.jsx(G,{}),e.jsxs(x,{children:[e.jsx(I,{variant:"subtitle1",fontWeight:"bold",sx:{mb:2},children:"字段映射配置"}),r.length===0?e.jsx(O,{severity:"info",children:"该工单模板暂无表单字段"}):e.jsx(N,{spacing:2,children:r.map((t,a)=>e.jsx(x,{sx:{p:2,border:"1px solid #e0e0e0",borderRadius:1},children:e.jsxs(N,{spacing:1.5,children:[e.jsxs(x,{children:[e.jsx(I,{variant:"body2",fontWeight:"bold",sx:{mb:.5},children:t.fieldTitle}),e.jsxs(I,{variant:"caption",color:"text.secondary",sx:{wordBreak:"break-word"},children:["字段名: ",t.fieldName]})]}),e.jsx(w,{label:"Widget ID",value:t.widgetId,onChange:n=>se(a,"widgetId",n.target.value),placeholder:"例如：widget17424405077590001",required:!0,fullWidth:!0,helperText:"填写三方审批表单中对应字段的 Widget ID（必填）"})]})},t.fieldName))})]})]})}),e.jsxs(he,{children:[e.jsx(U,{onClick:m,children:"取消"}),e.jsx(U,{variant:"contained",onClick:re,disabled:$,children:$?"保存中...":"保存"})]})]})}function Ee(){const p=ge(),[u,m]=i.useState([]),[k,s]=i.useState(!1),[f,o]=i.useState(!1),[d,g]=i.useState(null);i.useEffect(()=>{h()},[]);const h=async()=>{try{s(!0);const r=await q.list();r.data.code===0&&m(r.data.data||[])}catch(r){console.error("加载模板失败:",r)}finally{s(!1)}},j=()=>{p("/template-editor")},y=r=>{p(`/template-editor/${r.id}`)},F=async r=>{if(window.confirm("确定要删除这个工单模板吗？"))try{await q.delete(r),await h()}catch(A){console.error("删除模板失败:",A)}},b=r=>{g(r),o(!0)},D=()=>{o(!1),g(null)},C=async()=>{await h(),D()};return e.jsxs(x,{sx:{p:3},children:[e.jsx(I,{variant:"h4",sx:{mb:5},children:"设计工单"}),e.jsx(xe,{children:e.jsxs(me,{sx:{p:2,"&:last-child":{pb:2}},children:[e.jsxs(x,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1.5},children:[e.jsx(I,{variant:"h6",children:"工单模板"}),e.jsx(U,{variant:"contained",startIcon:e.jsx(je,{}),onClick:j,children:"新建工单"})]}),k?e.jsx(x,{sx:{display:"flex",justifyContent:"left",p:2},children:e.jsx(Y,{})}):u.length===0?e.jsx(O,{severity:"info",children:'暂无工单模板，点击"新建工单"创建第一个工单模板'}):e.jsx(be,{children:e.jsxs(Ce,{children:[e.jsx(Ae,{children:e.jsxs(Q,{children:[e.jsx(c,{children:"工单名称"}),e.jsx(c,{children:"分类"}),e.jsx(c,{children:"状态"}),e.jsx(c,{children:"版本"}),e.jsx(c,{children:"创建时间"}),e.jsx(c,{children:"三方审批"}),e.jsx(c,{sx:{paddingLeft:"16px"},children:"操作"})]})}),e.jsx(Te,{children:u.map(r=>e.jsxs(Q,{children:[e.jsx(c,{children:r.name}),e.jsx(c,{children:r.category||"-"}),e.jsx(c,{children:e.jsx(Z,{label:r.status==="active"?"启用":"禁用",color:r.status==="active"?"success":"default",size:"small"})}),e.jsx(c,{children:r.version}),e.jsx(c,{children:new Date(r.created_at).toLocaleDateString()}),e.jsx(c,{children:e.jsx(U,{size:"small",variant:"outlined",onClick:()=>b(r),startIcon:e.jsx(X,{}),children:"配置"})}),e.jsx(c,{sx:{paddingLeft:"16px"},children:e.jsxs(N,{direction:"row",spacing:0,alignItems:"center",children:[e.jsx(V,{size:"small",onClick:()=>y(r),sx:{marginLeft:"-8px"},children:e.jsx(ve,{fontSize:"small"})}),e.jsx(V,{size:"small",onClick:()=>F(r.id),children:e.jsx(Ie,{fontSize:"small"})})]})})]},r.id))})]})})]})}),d&&e.jsx(we,{open:f,template:d,onClose:D,onSave:C})]})}export{Ee as default};
