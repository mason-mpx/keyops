import{r as p,dr as T,bf as y,j as r,i as H,k as Q,l as U,B as X,C as P,b,F as Z,n as ee,o as te,M as re,m as oe,T as E,p as ie,a as O,a7 as ae}from"./index-DNdAKB9f.js";import{S as se}from"./Stack-6rKlDBQM.js";function de({open:w,ticket:l,onClose:F,onSuccess:W}){const[D,C]=p.useState(!1),[g,k]=p.useState([]),[A,J]=p.useState(""),[f,S]=p.useState(""),[a,M]=p.useState(null),[v,x]=p.useState([]),[R,N]=p.useState(!1);p.useEffect(()=>{w&&V()},[w]),p.useEffect(()=>{if(A&&g.length>0){const e=g.find(o=>o.id===A);if(M(e||null),e){let o="";if(l?.template?.approval_config)try{o=(typeof l.template.approval_config=="string"?JSON.parse(l.template.approval_config):l.template.approval_config).approval_code||""}catch(d){console.error("解析工单模板审批配置失败:",d)}o||(o=e.approval_code||e.process_code||e.template_id||""),S(o),x([])}}else M(null),S(""),x([])},[A,g,l]);const B=p.useCallback(async()=>{if(!(!a||!f.trim()))try{N(!0);const e=await T.getApprovalFormDetail({approval_config_id:a.id,approval_code:f,platform:a.type});x(e.form_fields||[])}catch(e){console.error("获取表单详情失败:",e),x([])}finally{N(!1)}},[a,f]);p.useEffect(()=>{a&&f.trim()&&a.type==="feishu"?B():x([])},[f,a,B]);const V=async()=>{try{C(!0);const o=((await T.getApprovalConfig()).configs||[]).filter(d=>d.enabled);k(o)}catch(e){console.error("加载审批配置失败:",e),y("加载审批配置失败")}finally{C(!1)}},$=async()=>{if(!l){y("工单信息不存在");return}if(!a){y("请选择审批配置");return}if(!f.trim()){y("请输入审批代码");return}try{C(!0);let e=null;if(l.template?.approval_config)try{e=typeof l.template.approval_config=="string"?JSON.parse(l.template.approval_config):l.template.approval_config}catch(t){console.error("解析工单模板审批配置失败:",t)}let o=[];if(v.length>0)e?.field_mappings&&e.field_mappings.length>0?o=v.map(t=>{const n=t.name||"",s=e?.field_mappings?.find(j=>j.fieldName===n);return s?{...t,keyword:s.keyword}:null}).filter(t=>t!=null&&t.keyword!==void 0):o=v.map(t=>({...t,keyword:t.name||""}));else try{o=JSON.parse(a.form_fields||"[]")}catch(t){console.error("表单字段映射配置格式错误:",t),y("表单字段映射配置格式错误");return}if(o.length===0){y("没有可用的表单字段映射，请先在工单模板中配置字段映射");return}const d=z(l.form_data||{},o,l);await T.createThirdPartyApproval({ticket_id:l.id,approval_config_id:a.id,approval_code:f,platform:a.type,form_data:d})&&(ae("三方审批提交成功"),F(),W?.())}catch(e){console.error("提交三方审批失败:",e);const o=e?.response?.data?.message||"提交三方审批失败";y(o)}finally{C(!1)}},z=(e,o,d)=>{const i=[];for(const t of o){const n=t.name||"",s=t.type||"",j=t.id||"",q=t.keyword||"";if(!j||!s)continue;const u=q||n;let c="";if(u)if(u.includes("工单编号")||u.includes("ticket_number"))c=d.ticket_number||"";else if(u.includes("工单标题")||u.includes("title")||u.includes("标题"))c=d.title||"";else if(u.includes("工单链接")||u.includes("ticket_url")||u.includes("链接"))c=`${window.location.origin}/ticket/${d.id}`;else{const m=K(e,u);m!=null?c=m:t.default_value!==void 0&&(c=t.default_value)}if(t.option&&Array.isArray(t.option)&&typeof c=="string"){const m=t.option.find(_=>_.text===c||_.label===c);m&&(c=m.value)}if(s==="ARRAY"&&t.children){const m=Array.isArray(c)?c:[],_=[];for(const Y of m){const L=[];for(const h of t.children){const G=h.keyword||"",I=K(Y,G);h.id&&h.type&&L.push({id:h.id,type:h.type,value:I??(h.default_value||"")})}_.push(L)}i.push({id:j,type:s,value:_})}else i.push({id:j,type:s,value:c||""})}return i},K=(e,o)=>{if(!e||!o)return;if(e[o]!==void 0)return e[o];const d=o.split(".");let i=e;for(const t of d){if(i==null)return;if(/^\d+$/.test(t))if(Array.isArray(i)){const n=i[parseInt(t)],s=n&&typeof n=="object"?n:void 0;if(!s)return;i=s}else if(i&&typeof i=="object"){const n=i[t],s=n&&typeof n=="object"?n:void 0;if(!s)return;i=s}else return;else if(i&&typeof i=="object"&&!Array.isArray(i)){const n=i[t],s=n&&typeof n=="object"?n:void 0;if(!s)return;i=s}else return}return i};return r.jsxs(H,{open:w,onClose:F,maxWidth:"md",fullWidth:!0,children:[r.jsx(Q,{children:"提交三方审批"}),r.jsx(U,{children:r.jsx(se,{spacing:3,sx:{mt:1},children:D&&g.length===0?r.jsx(X,{sx:{display:"flex",justifyContent:"center",p:3},children:r.jsx(P,{})}):g.length===0?r.jsx(b,{severity:"warning",children:"暂无启用的审批配置，请先在工单配置中添加审批配置"}):r.jsxs(r.Fragment,{children:[r.jsxs(Z,{fullWidth:!0,children:[r.jsx(ee,{children:"选择审批配置"}),r.jsx(te,{value:A,label:"选择审批配置",onChange:e=>J(e.target.value),children:g.map(e=>r.jsxs(re,{value:e.id,children:[e.name," (",e.type==="feishu"?"飞书":e.type==="dingtalk"?"钉钉":"企业微信",")"]},e.id))})]}),a&&r.jsxs(r.Fragment,{children:[r.jsx(oe,{fullWidth:!0,label:a.type==="feishu"?"审批代码 (Approval Code)":a.type==="dingtalk"?"流程代码 (Process Code)":"模板ID (Template ID)",value:f,onChange:e=>S(e.target.value),required:!0,helperText:a.type==="feishu"?"飞书审批定义的唯一标识（输入后会自动获取表单字段）":a.type==="dingtalk"?"钉钉审批流程的唯一标识":"企业微信审批模板的唯一标识",InputProps:{endAdornment:R?r.jsx(P,{size:20}):null}}),v.length>0?r.jsx(b,{severity:"success",children:r.jsxs(E,{variant:"body2",children:["已自动获取到 ",v.length," 个表单字段。系统将通过字段名称自动匹配工单数据，无需手动配置 widget ID。"]})}):a.type==="feishu"&&f.trim()?r.jsx(b,{severity:"warning",children:r.jsx(E,{variant:"body2",children:"正在获取表单字段详情...（如果获取失败，将使用审批配置中的表单字段映射）"})}):r.jsx(b,{severity:"info",children:r.jsx(E,{variant:"body2",children:a.type==="feishu"?"输入审批代码后，系统会自动获取表单字段详情，通过字段名称匹配工单数据。":"表单字段将通过审批配置中的关键字自动匹配工单数据。请确保审批配置中的表单字段映射已正确配置关键字。"})})]})]})})}),r.jsxs(ie,{children:[r.jsx(O,{onClick:F,children:"取消"}),r.jsx(O,{variant:"contained",onClick:$,disabled:D||!a||!f.trim(),children:D?r.jsx(P,{size:20}):"提交"})]})]})}export{de as T};
