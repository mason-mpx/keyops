import{b1 as J,r as a,j as t,P as b,C as K,T as x,B as f,m as Y,s as Z,t as q,W as T,b3 as Q,b4 as V,G as A,z as X,b5 as _,b6 as ee,b7 as se,b8 as P,b9 as te,ba as re,Y as oe,bb as ne,Z as ie,bc as ae,au as le,K as ce,bd as de}from"./index-Cih9_E47.js";import{b as ue}from"./websocket-Bdab7s0d.js";import{C as D}from"./Chip-D6-9bdkU.js";function xe({onHostClick:L}){const{sessions:M}=J(),[g,W]=a.useState(""),[y,w]=a.useState(!0),[I,C]=a.useState([]),[p,U]=a.useState([]),[H,N]=a.useState(new Map),[m,v]=a.useState([]),[c,j]=a.useState({}),[S,z]=a.useState(null),[d,E]=a.useState(!1);a.useEffect(()=>{(async()=>{try{const s=await Q.getCurrentUser();z(s),E(s?.role==="admin")}catch(s){console.error("获取当前用户失败:",s);const r=localStorage.getItem("user");if(r){const i=JSON.parse(r);z(i),E(i?.role==="admin")}}})()},[]),a.useEffect(()=>{(async()=>{if(S?.id)try{if(d)j({groupIds:[],hostIds:[]});else{const s=await V.getUserPermissions(S.id);j({groupIds:s.groupIds||[],hostIds:s.hostIds||[]})}}catch(s){console.error("获取用户权限失败:",s),d&&j({groupIds:[],hostIds:[]})}})()},[S?.id,d]),a.useEffect(()=>{(async()=>{try{const s=await A.listGroups({stats:!0});U(s.groups||[])}catch(s){console.error("加载主机分组失败:",s)}})()},[]),a.useEffect(()=>{const e=async()=>{w(!0);try{const s=d||c.groupIds?.length===0?p:p.filter(o=>c.groupIds?.includes(o.id)),r=new Map,i=new Set;for(const o of s)try{const h=((await A.getGroupHosts(o.id)).hosts||[]).map(n=>({...n,tags:typeof n.tags=="string"?JSON.parse(n.tags||"[]"):n.tags||[]}));r.set(o.id,h),h.forEach(n=>i.add(n.id))}catch(l){console.error(`加载分组 ${o.id} 的主机失败:`,l)}if(!d&&c.hostIds&&c.hostIds.length>0)try{const h=(await X.getHosts({pageSize:1e4})).hosts.map(n=>({...n,tags:typeof n.tags=="string"?JSON.parse(n.tags||"[]"):n.tags||[]})).filter(n=>c.hostIds?.includes(n.id)&&!i.has(n.id));v(h)}catch(o){console.error("加载直接授权主机失败:",o)}else v([]);N(r)}catch(s){console.error("加载主机列表失败:",s)}finally{w(!1)}};(c.groupIds!==void 0||d)&&p.length>0&&e()},[c,d,p]);const u=a.useMemo(()=>{if(y||!p.length)return null;const e=d||c.groupIds?.length===0?p:p.filter(r=>c.groupIds?.includes(r.id)),s={id:"root",name:"服务树根",type:"root",children:[]};return e.forEach(r=>{const i=H.get(r.id)||[];(i.length>0||d)&&s.children.push({id:`group-${r.id}`,name:r.name,type:"group",group:r,count:i.length,children:i.map(o=>({id:`host-${o.id}`,name:o.name,type:"host",host:o}))})}),m.length>0&&s.children.push({id:"group-direct",name:"直接授权",type:"group",count:m.length,children:m.map(r=>({id:`host-${r.id}`,name:r.name,type:"host",host:r}))}),s},[p,H,m,c,d,y]),k=a.useMemo(()=>{if(!u||!g.trim())return u;const e=s=>{const r=g.toLowerCase();if(s.type==="host"){const i=s.host;return i.name.toLowerCase().includes(r)||i.ip?.toLowerCase().includes(r)?s:null}if(s.type==="group"){const i=s.name.toLowerCase().includes(r),o=s.children?.map(l=>e(l)).filter(l=>l!==null)||[];return i||o.length>0?{...s,children:o}:null}if(s.type==="root"){const i=s.children?.map(o=>e(o)).filter(o=>o!==null)||[];return{...s,children:i}}return s};return e(u)},[u,g]),O=e=>{C(s=>s.includes(e)?s.filter(r=>r!==e):[...s,e])},B=e=>{const s=ue(e);return de(s)},F=e=>{switch(e){case"online":return"success.main";case"offline":return"error.main";default:return"text.disabled"}},G=(e,s=0)=>{if(!e)return null;const r=I.includes(e.id),i=e.children&&e.children.length>0,o=e.type==="host"&&e.host?M.some(n=>n.host.id===e.host.id):!1;let l,h;if(e.type==="root")l=t.jsx(ie,{sx:{fontSize:18}}),h=t.jsx(x,{variant:"body2",fontWeight:600,children:e.name});else if(e.type==="group")l=r?t.jsx(ae,{sx:{fontSize:18}}):t.jsx(le,{sx:{fontSize:18}}),h=t.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:1,flex:1},children:[t.jsx(x,{variant:"body2",children:e.name}),e.count!==void 0&&t.jsx(D,{label:e.count,size:"small",sx:{height:20,fontSize:"0.7rem",minWidth:24}})]});else{const n=e.host,R=B(n.deviceType),$=F(n.status);l=R||t.jsx(ce,{sx:{fontSize:18}}),h=t.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:1,flex:1,minWidth:0},children:[n.ip?t.jsxs(f,{sx:{display:"flex",alignItems:"center",gap:.5,flex:1,minWidth:0},children:[t.jsx(_,{sx:{fontSize:8,color:$,filter:n.status==="online"?"drop-shadow(0 0 2px currentColor)":"none",flexShrink:0}}),t.jsx(x,{variant:"body2",sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontWeight:o?600:400,fontFamily:"monospace"},children:n.ip})]}):t.jsx(x,{variant:"body2",sx:{flex:1,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontWeight:o?600:400},children:e.name}),o&&t.jsx(D,{label:"已连接",size:"small",color:"success",sx:{height:18,fontSize:"0.65rem",flexShrink:0}})]})}return t.jsxs(ee.Fragment,{children:[t.jsxs(se,{onClick:()=>{i?O(e.id):e.type==="host"&&e.host&&L(e.host)},sx:{pl:s*2+2,py:.75,minHeight:40,borderRadius:1,mb:.25,"&:hover":{backgroundColor:"action.hover"},...e.type==="host"&&o&&{backgroundColor:"action.selected","&:hover":{backgroundColor:"action.selected"}}},children:[t.jsx(P,{sx:{minWidth:28},children:i?r?t.jsx(te,{sx:{fontSize:18}}):t.jsx(re,{sx:{fontSize:18}}):t.jsx(f,{sx:{width:18}})}),t.jsx(P,{sx:{minWidth:36},children:l}),t.jsx(oe,{primary:h,sx:{"& .MuiListItemText-primary":{display:"flex",alignItems:"center",margin:0}}})]}),i&&t.jsx(ne,{in:r,timeout:"auto",unmountOnExit:!0,children:t.jsx(T,{component:"div",disablePadding:!0,children:e.children?.map(n=>G(n,s+1))})})]},e.id)};return a.useEffect(()=>{if(u&&I.length===0){const e=u.children?.map(s=>s.id)||[];C(["root",...e])}},[u,I.length]),y?t.jsx(b,{sx:{p:3,height:"100%",display:"flex",alignItems:"center",justifyContent:"center"},children:t.jsx(K,{size:24})}):!u||!u.children||u.children.length===0?t.jsx(b,{sx:{p:3,height:"100%"},children:t.jsx(x,{variant:"body2",color:"text.secondary",textAlign:"center",children:"暂无可用主机"})}):t.jsxs(b,{sx:{height:"100%",display:"flex",flexDirection:"column"},children:[t.jsx(f,{sx:{p:2,borderBottom:1,borderColor:"divider"},children:t.jsx(Y,{fullWidth:!0,size:"small",placeholder:"搜索主机...",value:g,onChange:e=>W(e.target.value),InputProps:{startAdornment:t.jsx(Z,{position:"start",children:t.jsx(q,{fontSize:"small"})})}})}),t.jsx(f,{sx:{flex:1,overflow:"auto"},children:t.jsx(T,{component:"nav",disablePadding:!0,children:k?.children?.map(e=>G(e,0))})})]})}export{xe as H};
