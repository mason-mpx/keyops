import{u as ae,ax as le,r as i,c3 as ie,b4 as oe,bq as T,bf as O,j as t,B as h,P as ce,T as de,d as W,I as E,v as ue,a as y,A as he,m as d,s as ge,t as pe,M as o,b as xe,C as S,be as fe,h as me,i as je,k as ve,l as ye,_ as Ce,p as be,a7 as D}from"./index-z51Q_M-r.js";import{T as we,a as Te,b as Oe,c as k,d as c,e as Se}from"./TableRow-CKQKXB8v.js";import{C as B}from"./Chip-BoE43uAD.js";import{T as Ae}from"./TablePagination-DV0GrBI0.js";import{A as j}from"./Autocomplete-DXh7XcwX.js";import{S as Ie}from"./Switch-CFen4WHb.js";import"./LastPage-BCKcUFpS.js";function Ne(){const{t:N}=ae(),K=le(),[M,V]=i.useState([]),[J,Q]=i.useState([]),[R,L]=i.useState(!1),[A,C]=i.useState(!1),[U,X]=i.useState("create"),[Y,Z]=i.useState({}),[_,I]=i.useState(""),[z,b]=i.useState(0),[P,ee]=i.useState(10),[l,w]=i.useState({name:"",org:"",department:"",status:"",srvType:"",virtualTech:"",site:"",isCritical:void 0}),[n,u]=i.useState({org:"",lineOfBiz:"",name:"",isCritical:!1,srvType:"WEB",virtualTech:"",status:"Initializing",site:"",department:"",description:"",onlineAt:"",offlineAt:"",gitUrl:"",opsOwners:[],testOwners:[],devOwners:[]}),[p,F]=i.useState([]),[x,q]=i.useState(!1),H=i.useCallback(async()=>{try{const e=await ie.getOrganizationTree();Q(Array.isArray(e)?e:[])}catch(e){console.error("加载组织列表失败:",e)}},[]),$=e=>{let s=[];return e.forEach(r=>{s.push(r),r.children&&r.children.length>0&&(s=s.concat($(r.children)))}),s},g=i.useCallback(async(e="")=>{try{q(!0);const s=await oe.getUsersWithRoles({page:1,pageSize:10,keyword:e||void 0});F(s.users||[])}catch(s){console.error("加载用户列表失败:",s),F([])}finally{q(!1)}},[]),f=i.useCallback(async()=>{L(!0),I("");try{const e={};l.name&&(e.name=l.name),l.org&&(e.org=l.org),l.department&&(e.department=l.department),l.status&&(e.status=l.status),l.srvType&&(e.srvType=l.srvType),l.virtualTech&&(e.virtualTech=l.virtualTech),l.site&&(e.site=l.site),l.isCritical!==void 0&&(e.isCritical=l.isCritical);const s=await T.getApplications(e);V(Array.isArray(s)?s:[])}catch(e){const s=e,r=s?.response?.data?.message||s?.message||"加载应用列表失败";I(r),O(r)}finally{L(!1)}},[l]);i.useEffect(()=>{H()},[H]),i.useEffect(()=>{f()},[f]),i.useEffect(()=>{A&&g()},[A,g]);const te=()=>{X("create"),Z({}),u({org:"",lineOfBiz:"",name:"",isCritical:!1,srvType:"WEB",virtualTech:"",status:"Initializing",site:"",department:"",description:"",onlineAt:"",offlineAt:"",gitUrl:"",opsOwners:[],testOwners:[],devOwners:[]}),C(!0)},se=async e=>{if(window.confirm("确定要删除该应用吗？删除后无法恢复。"))try{await T.deleteApplication(e),D("删除成功"),f()}catch(s){const r=s,a=r?.response?.data?.message||r?.message||"删除失败";O(a)}},ne=async()=>{if(!n.name.trim()){O("请输入应用名称");return}try{const e=r=>{if(!(!r||r.trim()===""))try{const a=new Date(r);return isNaN(a.getTime())?void 0:a.toISOString()}catch{return}},s={org:n.org||void 0,lineOfBiz:n.lineOfBiz||void 0,name:n.name,isCritical:n.isCritical,srvType:n.srvType,virtualTech:n.virtualTech||void 0,status:n.status,site:n.site||void 0,department:n.department||void 0,description:n.description||void 0,onlineAt:e(n.onlineAt),offlineAt:e(n.offlineAt),gitUrl:n.gitUrl||void 0,opsOwners:n.opsOwners.length>0?n.opsOwners:void 0,testOwners:n.testOwners.length>0?n.testOwners:void 0,devOwners:n.devOwners.length>0?n.devOwners:void 0};U==="create"?(await T.createApplication(s),D("创建成功")):(await T.updateApplication(Y.id,s),D("更新成功")),C(!1),f()}catch(e){const s=e,r=s?.response?.data?.message||s?.message||"保存失败";O(r)}},re=e=>{switch(e){case"Running":return"success";case"Stopped":return"error";case"Initializing":return"warning";default:return"info"}},m=$(J),G=M.slice(z*P,(z+1)*P);return t.jsx(h,{children:t.jsxs(ce,{sx:{p:3},children:[t.jsxs(h,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:3},children:[t.jsx(de,{variant:"h5",children:"服务管理"}),t.jsxs(h,{children:[t.jsx(W,{title:"刷新",children:t.jsx(E,{onClick:f,disabled:R,children:t.jsx(ue,{})})}),t.jsx(y,{variant:"contained",startIcon:t.jsx(he,{}),onClick:te,sx:{ml:1},children:"新建应用"})]})]}),t.jsxs(h,{sx:{display:"flex",gap:2,mb:2,flexWrap:"wrap"},children:[t.jsx(d,{size:"small",placeholder:"搜索应用名称",value:l.name,onChange:e=>w({...l,name:e.target.value}),InputProps:{startAdornment:t.jsx(ge,{position:"start",children:t.jsx(pe,{})})},sx:{minWidth:200}}),t.jsxs(d,{size:"small",select:!0,label:"状态",value:l.status,onChange:e=>w({...l,status:e.target.value}),sx:{minWidth:120},children:[t.jsx(o,{value:"",children:"全部"}),t.jsx(o,{value:"Running",children:"运行中"}),t.jsx(o,{value:"Stopped",children:"已停止"}),t.jsx(o,{value:"Initializing",children:"初始化中"})]}),t.jsxs(d,{size:"small",select:!0,label:"应用类型",value:l.srvType,onChange:e=>w({...l,srvType:e.target.value}),sx:{minWidth:120},children:[t.jsx(o,{value:"",children:"全部"}),t.jsx(o,{value:"Server",children:"Server"}),t.jsx(o,{value:"WEB",children:"WEB"}),t.jsx(o,{value:"Middleware",children:"Middleware"}),t.jsx(o,{value:"DataWare",children:"DataWare"})]}),t.jsx(y,{variant:"outlined",onClick:()=>{b(0),f()},children:"搜索"}),t.jsx(y,{variant:"outlined",onClick:()=>{w({name:"",org:"",department:"",status:"",srvType:"",virtualTech:"",site:"",isCritical:void 0}),b(0)},children:"重置"})]}),_&&t.jsx(xe,{severity:"error",sx:{mb:2},onClose:()=>I(""),children:_}),R?t.jsx(h,{sx:{display:"flex",justifyContent:"center",p:4},children:t.jsx(S,{})}):t.jsxs(t.Fragment,{children:[t.jsx(we,{children:t.jsxs(Te,{children:[t.jsx(Oe,{children:t.jsxs(k,{children:[t.jsx(c,{children:"应用名称"}),t.jsx(c,{children:"事业部"}),t.jsx(c,{children:"部门"}),t.jsx(c,{children:"站点"}),t.jsx(c,{children:"应用类型"}),t.jsx(c,{children:"虚拟化技术"}),t.jsx(c,{children:"状态"}),t.jsx(c,{children:"是否核心"}),t.jsx(c,{children:"上线时间"}),t.jsx(c,{children:"操作"})]})}),t.jsx(Se,{children:G.length===0?t.jsx(k,{children:t.jsx(c,{colSpan:10,align:"center",children:"暂无数据"})}):G.map(e=>t.jsxs(k,{children:[t.jsx(c,{children:e.name}),t.jsx(c,{children:e.org||"-"}),t.jsx(c,{children:e.department||"-"}),t.jsx(c,{children:e.site||"-"}),t.jsx(c,{children:e.srvType}),t.jsx(c,{children:e.virtualTech||"-"}),t.jsx(c,{children:t.jsx(B,{label:e.status,color:re(e.status),size:"small"})}),t.jsx(c,{children:e.isCritical?t.jsx(B,{label:"是",color:"error",size:"small"}):t.jsx(B,{label:"否",size:"small"})}),t.jsx(c,{children:e.onlineAt?new Date(e.onlineAt).toLocaleString("zh-CN"):"-"}),t.jsx(c,{children:t.jsxs(h,{sx:{display:"flex",gap:.5},children:[t.jsx(W,{title:"详情",children:t.jsx(E,{size:"small",onClick:()=>K(`/services/${e.id}`),color:"primary",children:t.jsx(fe,{fontSize:"small"})})}),t.jsx(W,{title:"删除",children:t.jsx(E,{size:"small",color:"error",onClick:()=>se(e.id),children:t.jsx(me,{fontSize:"small"})})})]})})]},e.id))})]})}),t.jsx(Ae,{component:"div",count:M.length,page:z,onPageChange:(e,s)=>b(s),rowsPerPage:P,onRowsPerPageChange:e=>{ee(parseInt(e.target.value,10)),b(0)},rowsPerPageOptions:[10,25,50,100],labelRowsPerPage:N("common.rowsPerPage")||"每页显示:",labelDisplayedRows:({from:e,to:s,count:r})=>N("common.displayedRows",{from:e,to:s,count:r})||`${e}-${s} 共 ${r} 条`,sx:{borderTop:"1px solid #e2e8f0",mt:0,width:"100%",".MuiTablePagination-toolbar":{paddingLeft:2,paddingRight:2,minHeight:"52px",display:"flex",alignItems:"center",justifyContent:"space-between",flexWrap:"wrap"},".MuiTablePagination-spacer":{flex:"1 1 auto"},".MuiTablePagination-selectLabel":{marginRight:1,marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-displayedRows":{marginBottom:0,fontWeight:500,fontSize:"0.875rem",color:"text.secondary",display:"flex",alignItems:"center",lineHeight:1.5},".MuiTablePagination-select":{fontSize:"0.875rem",marginRight:2,marginTop:0,marginBottom:0},".MuiTablePagination-actions":{marginLeft:1,display:"flex",alignItems:"center"}}})]}),t.jsxs(je,{open:A,onClose:()=>C(!1),maxWidth:"md",fullWidth:!0,children:[t.jsx(ve,{children:U==="create"?"新建应用":"编辑应用"}),t.jsx(ye,{children:t.jsxs(h,{sx:{pt:2,display:"flex",flexDirection:"column",gap:2},children:[t.jsxs(h,{sx:{display:"flex",gap:2},children:[t.jsx(d,{fullWidth:!0,label:"应用名称",value:n.name,onChange:e=>u({...n,name:e.target.value}),required:!0}),t.jsxs(d,{fullWidth:!0,label:"应用状态",select:!0,value:n.status,onChange:e=>u({...n,status:e.target.value}),required:!0,children:[t.jsx(o,{value:"Initializing",children:"初始化中"}),t.jsx(o,{value:"Running",children:"运行中"}),t.jsx(o,{value:"Stopped",children:"已停止"})]})]}),t.jsxs(h,{sx:{display:"flex",gap:2},children:[t.jsx(j,{fullWidth:!0,options:m,getOptionLabel:e=>e.unitName,value:m.find(e=>e.unitCode===n.org)||null,onChange:(e,s)=>u({...n,org:s?.unitCode||""}),renderInput:e=>t.jsx(d,{...e,label:"事业部"})}),t.jsx(j,{fullWidth:!0,options:m,getOptionLabel:e=>e.unitName,value:m.find(e=>e.unitCode===n.lineOfBiz)||null,onChange:(e,s)=>u({...n,lineOfBiz:s?.unitCode||""}),renderInput:e=>t.jsx(d,{...e,label:"业务线"})})]}),t.jsxs(h,{sx:{display:"flex",gap:2},children:[t.jsx(j,{fullWidth:!0,options:m,getOptionLabel:e=>e.unitName,value:m.find(e=>e.unitCode===n.department)||null,onChange:(e,s)=>u({...n,department:s?.unitCode||""}),renderInput:e=>t.jsx(d,{...e,label:"部门"})}),t.jsx(d,{fullWidth:!0,label:"应用站点",value:n.site,onChange:e=>u({...n,site:e.target.value}),placeholder:"例如：大陆、香港、北美、欧洲等"})]}),t.jsxs(h,{sx:{display:"flex",gap:2},children:[t.jsxs(d,{fullWidth:!0,label:"应用类型",value:n.srvType,onChange:e=>u({...n,srvType:e.target.value}),select:!0,required:!0,children:[t.jsx(o,{value:"Server",children:"Server"}),t.jsx(o,{value:"WEB",children:"WEB"}),t.jsx(o,{value:"Middleware",children:"Middleware"}),t.jsx(o,{value:"DataWare",children:"DataWare"})]}),t.jsxs(d,{fullWidth:!0,label:"虚拟化技术",value:n.virtualTech,onChange:e=>u({...n,virtualTech:e.target.value}),select:!0,children:[t.jsx(o,{value:"",children:"无"}),t.jsx(o,{value:"K8S",children:"K8S"}),t.jsx(o,{value:"EC2",children:"EC2"}),t.jsx(o,{value:"ECS",children:"ECS"}),t.jsx(o,{value:"GCE",children:"GCE"})]})]}),t.jsx(d,{fullWidth:!0,label:"应用功能用途描述和备注信息",value:n.description,onChange:e=>u({...n,description:e.target.value}),multiline:!0,rows:3}),t.jsxs(h,{sx:{display:"flex",gap:2},children:[t.jsx(d,{fullWidth:!0,label:"上线时间",type:"datetime-local",value:n.onlineAt,onChange:e=>u({...n,onlineAt:e.target.value}),InputLabelProps:{shrink:!0}}),t.jsx(d,{fullWidth:!0,label:"下线时间",type:"datetime-local",value:n.offlineAt,onChange:e=>u({...n,offlineAt:e.target.value}),InputLabelProps:{shrink:!0}})]}),t.jsxs(h,{sx:{display:"flex",gap:2},children:[t.jsx(d,{fullWidth:!0,label:"Git地址",value:n.gitUrl||"",onChange:e=>u({...n,gitUrl:e.target.value})}),t.jsx(j,{fullWidth:!0,multiple:!0,options:p,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(n.opsOwners||[]).map(e=>p.find(r=>r.username===e||r.fullName===e)||e),onChange:(e,s)=>{const r=s.map(a=>typeof a=="string"?a:a.username||a.fullName||"");u({...n,opsOwners:r})},onInputChange:(e,s)=>{s?g(s):g()},loading:x,filterOptions:e=>e,renderInput:e=>t.jsx(d,{...e,label:"运维负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:t.jsxs(t.Fragment,{children:[x?t.jsx(S,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,s)=>{const r=typeof s=="string"?null:s,a=r?r.fullName||r.username||"":typeof s=="string"?s:"",v=r?r.id:typeof s=="string"?s:String(s);return i.createElement("li",{...e,key:v},a)}})]}),t.jsxs(h,{sx:{display:"flex",gap:2},children:[t.jsx(j,{fullWidth:!0,multiple:!0,options:p,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(n.testOwners||[]).map(e=>p.find(r=>r.username===e||r.fullName===e)||e),onChange:(e,s)=>{const r=s.map(a=>typeof a=="string"?a:a.username||a.fullName||"");u({...n,testOwners:r})},onInputChange:(e,s)=>{s?g(s):g()},loading:x,filterOptions:e=>e.slice(0,10),renderInput:e=>t.jsx(d,{...e,label:"测试负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:t.jsxs(t.Fragment,{children:[x?t.jsx(S,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,s)=>{const r=typeof s=="string"?null:s,a=r?r.username||r.fullName||"":typeof s=="string"?s:"",v=r?r.id:typeof s=="string"?s:String(s);return i.createElement("li",{...e,key:v},a)}}),t.jsx(j,{fullWidth:!0,multiple:!0,options:p,getOptionLabel:e=>typeof e=="string"?e:e.username||e.fullName||"",value:(n.devOwners||[]).map(e=>p.find(r=>r.username===e||r.fullName===e)||e),onChange:(e,s)=>{const r=s.map(a=>typeof a=="string"?a:a.username||a.fullName||"");u({...n,devOwners:r})},onInputChange:(e,s)=>{s?g(s):g()},loading:x,filterOptions:e=>e.slice(0,10),renderInput:e=>t.jsx(d,{...e,label:"研发负责人",placeholder:"搜索用户...",InputProps:{...e.InputProps,endAdornment:t.jsxs(t.Fragment,{children:[x?t.jsx(S,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),renderOption:(e,s)=>{const r=typeof s=="string"?null:s,a=r?r.username||r.fullName||"":typeof s=="string"?s:"",v=r?r.id:typeof s=="string"?s:String(s);return i.createElement("li",{...e,key:v},a)}})]}),t.jsx(Ce,{control:t.jsx(Ie,{checked:n.isCritical,onChange:e=>u({...n,isCritical:e.target.checked})}),label:"是否核心应用"})]})}),t.jsxs(be,{children:[t.jsx(y,{onClick:()=>C(!1),children:"取消"}),t.jsx(y,{onClick:ne,variant:"contained",children:"保存"})]})]})]})})}export{Ne as default};
